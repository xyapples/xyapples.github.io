{
    "version": "https://jsonfeed.org/version/1",
    "title": "LinuxSre云原生",
    "description": "专注于 Linux 运维、云计算、云原⽣等技术",
    "home_page_url": "http://ixuyong.cn",
    "items": [
        {
            "id": "http://ixuyong.cn/posts/269104229.html",
            "url": "http://ixuyong.cn/posts/269104229.html",
            "title": "Samba服务实践",
            "date_published": "2025-06-20T14:12:07.000Z",
            "content_html": "<h3 id=\"samba服务实践\"><a class=\"anchor\" href=\"#samba服务实践\">#</a> Samba 服务实践</h3>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2889248111.html",
            "url": "http://ixuyong.cn/posts/2889248111.html",
            "title": "Vsftp服务实践",
            "date_published": "2025-06-20T14:12:00.000Z",
            "content_html": "<h3 id=\"vsftp服务实践\"><a class=\"anchor\" href=\"#vsftp服务实践\">#</a> Vsftp 服务实践</h3>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/581151773.html",
            "url": "http://ixuyong.cn/posts/581151773.html",
            "title": "100个运维相关技术官网汇总",
            "date_published": "2025-06-19T13:16:37.000Z",
            "content_html": "<h3 id=\"100个运维相关技术官网大汇总\"><a class=\"anchor\" href=\"#100个运维相关技术官网大汇总\">#</a> 100 个运维相关技术官网大汇总</h3>\n<h4 id=\"1-操作系统官网\"><a class=\"anchor\" href=\"#1-操作系统官网\">#</a> <strong>1. 操作系统官网</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Ubuntu</td>\n<td style=\"text-align:left\"><a href=\"https://ubuntu.com\">https://ubuntu.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Debian</td>\n<td style=\"text-align:left\"><a href=\"https://www.debian.org\">https://www.debian.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RHEL</td>\n<td style=\"text-align:left\"><a href=\"https://www.redhat.com\">https://www.redhat.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Rocky Linux</td>\n<td style=\"text-align:left\"><a href=\"https://rockylinux.org\">https://rockylinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">AlmaLinux</td>\n<td style=\"text-align:left\"><a href=\"https://almalinux.org\">https://almalinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Arch Wiki</td>\n<td style=\"text-align:left\"><a href=\"https://wiki.archlinux.org\">https://wiki.archlinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">麒麟系统</td>\n<td style=\"text-align:left\"><a href=\"https://www.kylinos.cn/\">https://www.kylinos.cn/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">统信系统</td>\n<td style=\"text-align:left\"><a href=\"https://uniontech.com/\">https://uniontech.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">openEuler</td>\n<td style=\"text-align:left\"><a href=\"https://www.openeuler.org/zh/\">https://www.openeuler.org/zh/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">正版操作系统</td>\n<td style=\"text-align:left\"><a href=\"https://msdn.itellyou.cn/\">https://msdn.itellyou.cn/</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"2-开源镜像站\"><a class=\"anchor\" href=\"#2-开源镜像站\">#</a> <strong>2. 开源镜像站</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">镜像源名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">清华大学镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.tuna.tsinghua.edu.cn\">https://mirrors.tuna.tsinghua.edu.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">中科大镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.ustc.edu.cn\">https://mirrors.ustc.edu.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">阿里云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://developer.aliyun.com/mirror\">https://developer.aliyun.com/mirror</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">华为云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.huaweicloud.com\">https://mirrors.huaweicloud.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">中国科技网镜像</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.cstcloud.cn\">https://mirrors.cstcloud.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">网易开源镜像站</td>\n<td style=\"text-align:left\"><a href=\"http://mirrors.163.com\">http://mirrors.163.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">腾讯云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.cloud.tencent.com\">https://mirrors.cloud.tencent.com</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"3-容器与-kubernetes\"><a class=\"anchor\" href=\"#3-容器与-kubernetes\">#</a> <strong>3. 容器与 Kubernetes</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Docker</td>\n<td style=\"text-align:left\"><a href=\"https://www.docker.com\">https://www.docker.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kubernetes</td>\n<td style=\"text-align:left\"><a href=\"https://kubernetes.io\">https://kubernetes.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Helm</td>\n<td style=\"text-align:left\"><a href=\"https://helm.sh\">https://helm.sh</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Podman</td>\n<td style=\"text-align:left\"><a href=\"https://podman.io\">https://podman.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">containerd</td>\n<td style=\"text-align:left\"><a href=\"https://containerd.io\">https://containerd.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">K3s</td>\n<td style=\"text-align:left\"><a href=\"https://k3s.io\">https://k3s.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Rancher</td>\n<td style=\"text-align:left\"><a href=\"https://www.rancher.com/\">https://www.rancher.com/</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"4-云平台\"><a class=\"anchor\" href=\"#4-云平台\">#</a> <strong>4. 云平台</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">AWS</td>\n<td style=\"text-align:left\"><a href=\"https://aws.amazon.com\">https://aws.amazon.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Azure</td>\n<td style=\"text-align:left\"><a href=\"https://azure.microsoft.com\">https://azure.microsoft.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">阿里云</td>\n<td style=\"text-align:left\"><a href=\"https://www.aliyun.com\">https://www.aliyun.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">腾讯云</td>\n<td style=\"text-align:left\"><a href=\"https://cloud.tencent.com\">https://cloud.tencent.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">华为云</td>\n<td style=\"text-align:left\"><a href=\"https://www.huaweicloud.com\">https://www.huaweicloud.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">天翼云</td>\n<td style=\"text-align:left\"><a href=\"https://www.ctyun.cn/\">https://www.ctyun.cn/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OpenStack</td>\n<td style=\"text-align:left\"><a href=\"https://www.openstack.org\">https://www.openstack.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CNCF Landscape</td>\n<td style=\"text-align:left\"><a href=\"https://landscape.cncf.io\">https://landscape.cncf.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5-数据库\"><a class=\"anchor\" href=\"#5-数据库\">#</a> <strong>5. 数据库</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">MySQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.mysql.com\">https://www.mysql.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Oracle</td>\n<td style=\"text-align:left\"><a href=\"https://www.oracle.com/\">https://www.oracle.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PostgreSQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.postgresql.org\">https://www.postgresql.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MariaDB</td>\n<td style=\"text-align:left\"><a href=\"https://mariadb.org\">https://mariadb.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MongoDB</td>\n<td style=\"text-align:left\"><a href=\"https://www.mongodb.com\">https://www.mongodb.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Redis</td>\n<td style=\"text-align:left\"><a href=\"https://redis.io\">https://redis.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Memcached</td>\n<td style=\"text-align:left\"><a href=\"https://memcached.org\">https://memcached.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">达梦数据库</td>\n<td style=\"text-align:left\"><a href=\"https://www.dameng.com/\">https://www.dameng.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OceanBase</td>\n<td style=\"text-align:left\"><a href=\"https://www.oceanbase.com/\">https://www.oceanbase.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Elasticsearch</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/elasticsearch/\">https://www.elastic.co/elasticsearch/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ClickHouse</td>\n<td style=\"text-align:left\"><a href=\"https://clickhouse.com\">https://clickhouse.com</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"6-基础服务\"><a class=\"anchor\" href=\"#6-基础服务\">#</a> <strong>6. 基础服务</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Nginx</td>\n<td style=\"text-align:left\"><a href=\"https://nginx.org\">https://nginx.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Apache HTTPD</td>\n<td style=\"text-align:left\"><a href=\"https://httpd.apache.org\">https://httpd.apache.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Tomcat</td>\n<td style=\"text-align:left\"><a href=\"https://tomcat.apache.org/\">https://tomcat.apache.org/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HAProxy</td>\n<td style=\"text-align:left\"><a href=\"https://www.haproxy.org\">https://www.haproxy.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Dnsmasq</td>\n<td style=\"text-align:left\"><a href=\"https://thekelleys.org.uk/dnsmasq/doc.html\">https://thekelleys.org.uk/dnsmasq/doc.html</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CoreDNS</td>\n<td style=\"text-align:left\"><a href=\"https://coredns.io\">https://coredns.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RabbitMQ</td>\n<td style=\"text-align:left\"><a href=\"https://www.rabbitmq.com\">https://www.rabbitmq.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kafka</td>\n<td style=\"text-align:left\"><a href=\"https://kafka.apache.org\">https://kafka.apache.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Etcd</td>\n<td style=\"text-align:left\"><a href=\"https://etcd.io\">https://etcd.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Consul</td>\n<td style=\"text-align:left\"><a href=\"https://www.consul.io\">https://www.consul.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"7-cicd-与服务网格\"><a class=\"anchor\" href=\"#7-cicd-与服务网格\">#</a> <strong>7. CI/CD 与服务网格</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Jenkins</td>\n<td style=\"text-align:left\"><a href=\"https://www.jenkins.io\">https://www.jenkins.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">GitLab CI/CD</td>\n<td style=\"text-align:left\"><a href=\"https://about.gitlab.com\">https://about.gitlab.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">GitHub Actions</td>\n<td style=\"text-align:left\"><a href=\"https://github.com/features/actions\">https://github.com/features/actions</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ArgoCD</td>\n<td style=\"text-align:left\"><a href=\"https://argo-cd.readthedocs.io/\">https://argo-cd.readthedocs.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Spinnaker</td>\n<td style=\"text-align:left\"><a href=\"https://spinnaker.io\">https://spinnaker.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Istio</td>\n<td style=\"text-align:left\"><a href=\"https://istio.io/\">https://istio.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Envoy Proxy</td>\n<td style=\"text-align:left\"><a href=\"https://www.envoyproxy.io\">https://www.envoyproxy.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"8-监控与日志系统\"><a class=\"anchor\" href=\"#8-监控与日志系统\">#</a> <strong>8. 监控与日志系统</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Prometheus</td>\n<td style=\"text-align:left\"><a href=\"https://prometheus.io\">https://prometheus.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Grafana</td>\n<td style=\"text-align:left\"><a href=\"https://grafana.com\">https://grafana.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Loki</td>\n<td style=\"text-align:left\"><a href=\"https://grafana.com/oss/loki/\">https://grafana.com/oss/loki/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELK Stack</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/what-is/elk-stack\">https://www.elastic.co/what-is/elk-stack</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kibana</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/kibana/\">https://www.elastic.co/kibana/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Fluentd</td>\n<td style=\"text-align:left\"><a href=\"https://www.fluentd.org\">https://www.fluentd.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Zabbix</td>\n<td style=\"text-align:left\"><a href=\"https://www.zabbix.com\">https://www.zabbix.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Netdata</td>\n<td style=\"text-align:left\"><a href=\"https://www.netdata.cloud\">https://www.netdata.cloud</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"9-自动化运维工具\"><a class=\"anchor\" href=\"#9-自动化运维工具\">#</a> <strong>9. 自动化运维工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Ansible</td>\n<td style=\"text-align:left\"><a href=\"https://docs.ansible.com/\">https://docs.ansible.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Terraform</td>\n<td style=\"text-align:left\"><a href=\"https://developer.hashicorp.com/terraform/docs\">https://developer.hashicorp.com/terraform/docs</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SaltStack</td>\n<td style=\"text-align:left\"><a href=\"https://docs.saltproject.io/\">https://docs.saltproject.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Puppet</td>\n<td style=\"text-align:left\"><a href=\"https://puppet.com/docs/\">https://puppet.com/docs/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Chef</td>\n<td style=\"text-align:left\"><a href=\"https://docs.chef.io/\">https://docs.chef.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Packer</td>\n<td style=\"text-align:left\"><a href=\"https://developer.hashicorp.com/packer/docs\">https://developer.hashicorp.com/packer/docs</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"10-运维常用工具\"><a class=\"anchor\" href=\"#10-运维常用工具\">#</a> <strong>10. 运维常用工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">工具名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Xshell</td>\n<td style=\"text-align:left\"><a href=\"https://www.netsarang.com/zh/xshell/\">https://www.netsarang.com/zh/xshell/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Xftp</td>\n<td style=\"text-align:left\"><a href=\"https://www.netsarang.com/en/xftp/\">https://www.netsarang.com/en/xftp/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MobaXterm</td>\n<td style=\"text-align:left\"><a href=\"https://mobaxterm.mobatek.net\">https://mobaxterm.mobatek.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PuTTY</td>\n<td style=\"text-align:left\"><a href=\"https://www.putty.org\">https://www.putty.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SecureCRT</td>\n<td style=\"text-align:left\"><a href=\"https://www.vandyke.com/products/securecrt/\">https://www.vandyke.com/products/securecrt/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">WinSCP</td>\n<td style=\"text-align:left\"><a href=\"https://winscp.net\">https://winscp.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FileZilla</td>\n<td style=\"text-align:left\"><a href=\"https://filezilla-project.org\">https://filezilla-project.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FastCopy</td>\n<td style=\"text-align:left\"><a href=\"https://fastcopy.jp/en/\">https://fastcopy.jp/en/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Everything</td>\n<td style=\"text-align:left\"><a href=\"https://www.voidtools.com\">https://www.voidtools.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Wireshark</td>\n<td style=\"text-align:left\"><a href=\"https://www.wireshark.org\">https://www.wireshark.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VirtualBox</td>\n<td style=\"text-align:left\"><a href=\"https://www.virtualbox.org/\">https://www.virtualbox.org/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VMware Workstation</td>\n<td style=\"text-align:left\"><a href=\"https://www.vmware.com/products/workstation-pro.html\">https://www.vmware.com/products/workstation-pro.html</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"11-数据库可视化连接工具\"><a class=\"anchor\" href=\"#11-数据库可视化连接工具\">#</a> <strong>11. 数据库可视化连接工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">工具名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">DBeaver</td>\n<td style=\"text-align:left\"><a href=\"https://dbeaver.io\">https://dbeaver.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Navicat</td>\n<td style=\"text-align:left\"><a href=\"https://www.navicat.com\">https://www.navicat.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HeidiSQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.heidisql.com\">https://www.heidisql.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SSMS</td>\n<td style=\"text-align:left\"><a href=\"https://learn.microsoft.com/sql/ssms/\">https://learn.microsoft.com/sql/ssms/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Toad for Oracle</td>\n<td style=\"text-align:left\"><a href=\"https://www.toadworld.com/products/toad-for-oracle\">https://www.toadworld.com/products/toad-for-oracle</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SQL Developer</td>\n<td style=\"text-align:left\"><a href=\"https://www.oracle.com/database/sqldeveloper/\">https://www.oracle.com/database/sqldeveloper/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">DbVisualizer</td>\n<td style=\"text-align:left\"><a href=\"https://www.dbvis.com\">https://www.dbvis.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SQL Workbench</td>\n<td style=\"text-align:left\"><a href=\"https://www.sql-workbench.eu\">https://www.sql-workbench.eu</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">phpMyAdmin</td>\n<td style=\"text-align:left\"><a href=\"https://www.phpmyadmin.net\">https://www.phpmyadmin.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">pgAdmin</td>\n<td style=\"text-align:left\"><a href=\"https://www.pgadmin.org\">https://www.pgadmin.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MongoDB Compass</td>\n<td style=\"text-align:left\"><a href=\"https://www.mongodb.com/products/compass\">https://www.mongodb.com/products/compass</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RedisInsight</td>\n<td style=\"text-align:left\"><a href=\"https://redis.com/redis-enterprise/redis-insight/\">https://redis.com/redis-enterprise/redis-insight/</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"12-实用工具\"><a class=\"anchor\" href=\"#12-实用工具\">#</a> 12. 实用工具</h4>\n<table>\n<thead>\n<tr>\n<th>工具名称</th>\n<th>官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>图床工具</td>\n<td><a href=\"https://wp-cdn.4ce.cn/\">https://wp-cdn.4ce.cn/</a></td>\n</tr>\n<tr>\n<td>科学上网</td>\n<td><a href=\"https://ikuuu.one/auth/register\">https://ikuuu.one/auth/register</a></td>\n</tr>\n<tr>\n<td>截图工具</td>\n<td><a href=\"https://pixpin.cn/\">https://pixpin.cn/</a></td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/0.html",
            "url": "http://ixuyong.cn/posts/0.html",
            "title": "",
            "date_published": "2025-06-19T13:14:57.755Z",
            "content_html": "<h3 id=\"100个运维相关技术官网大汇总\"><a class=\"anchor\" href=\"#100个运维相关技术官网大汇总\">#</a> 100 个运维相关技术官网大汇总</h3>\n<h4 id=\"1-操作系统官网\"><a class=\"anchor\" href=\"#1-操作系统官网\">#</a> <strong>1. 操作系统官网</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Ubuntu</td>\n<td style=\"text-align:left\"><a href=\"https://ubuntu.com\">https://ubuntu.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Debian</td>\n<td style=\"text-align:left\"><a href=\"https://www.debian.org\">https://www.debian.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RHEL</td>\n<td style=\"text-align:left\"><a href=\"https://www.redhat.com\">https://www.redhat.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Rocky Linux</td>\n<td style=\"text-align:left\"><a href=\"https://rockylinux.org\">https://rockylinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">AlmaLinux</td>\n<td style=\"text-align:left\"><a href=\"https://almalinux.org\">https://almalinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Arch Wiki</td>\n<td style=\"text-align:left\"><a href=\"https://wiki.archlinux.org\">https://wiki.archlinux.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">麒麟系统</td>\n<td style=\"text-align:left\"><a href=\"https://www.kylinos.cn/\">https://www.kylinos.cn/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">统信系统</td>\n<td style=\"text-align:left\"><a href=\"https://uniontech.com/\">https://uniontech.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">openEuler</td>\n<td style=\"text-align:left\"><a href=\"https://www.openeuler.org/zh/\">https://www.openeuler.org/zh/</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"2-开源镜像站\"><a class=\"anchor\" href=\"#2-开源镜像站\">#</a> <strong>2. 开源镜像站</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">镜像源名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">清华大学镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.tuna.tsinghua.edu.cn\">https://mirrors.tuna.tsinghua.edu.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">中科大镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.ustc.edu.cn\">https://mirrors.ustc.edu.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">阿里云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://developer.aliyun.com/mirror\">https://developer.aliyun.com/mirror</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">华为云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.huaweicloud.com\">https://mirrors.huaweicloud.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">中国科技网镜像</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.cstcloud.cn\">https://mirrors.cstcloud.cn</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">网易开源镜像站</td>\n<td style=\"text-align:left\"><a href=\"http://mirrors.163.com\">http://mirrors.163.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">腾讯云镜像站</td>\n<td style=\"text-align:left\"><a href=\"https://mirrors.cloud.tencent.com\">https://mirrors.cloud.tencent.com</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"3-容器与-kubernetes\"><a class=\"anchor\" href=\"#3-容器与-kubernetes\">#</a> <strong>3. 容器与 Kubernetes</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Docker</td>\n<td style=\"text-align:left\"><a href=\"https://www.docker.com\">https://www.docker.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kubernetes</td>\n<td style=\"text-align:left\"><a href=\"https://kubernetes.io\">https://kubernetes.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Helm</td>\n<td style=\"text-align:left\"><a href=\"https://helm.sh\">https://helm.sh</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Podman</td>\n<td style=\"text-align:left\"><a href=\"https://podman.io\">https://podman.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">containerd</td>\n<td style=\"text-align:left\"><a href=\"https://containerd.io\">https://containerd.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">K3s</td>\n<td style=\"text-align:left\"><a href=\"https://k3s.io\">https://k3s.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Rancher</td>\n<td style=\"text-align:left\"><a href=\"https://www.rancher.com/\">https://www.rancher.com/</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"4-云平台\"><a class=\"anchor\" href=\"#4-云平台\">#</a> <strong>4. 云平台</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">AWS</td>\n<td style=\"text-align:left\"><a href=\"https://aws.amazon.com\">https://aws.amazon.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Azure</td>\n<td style=\"text-align:left\"><a href=\"https://azure.microsoft.com\">https://azure.microsoft.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">阿里云</td>\n<td style=\"text-align:left\"><a href=\"https://www.aliyun.com\">https://www.aliyun.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">腾讯云</td>\n<td style=\"text-align:left\"><a href=\"https://cloud.tencent.com\">https://cloud.tencent.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">华为云</td>\n<td style=\"text-align:left\"><a href=\"https://www.huaweicloud.com\">https://www.huaweicloud.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">天翼云</td>\n<td style=\"text-align:left\"><a href=\"https://www.ctyun.cn/\">https://www.ctyun.cn/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OpenStack</td>\n<td style=\"text-align:left\"><a href=\"https://www.openstack.org\">https://www.openstack.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CNCF Landscape</td>\n<td style=\"text-align:left\"><a href=\"https://landscape.cncf.io\">https://landscape.cncf.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5-数据库\"><a class=\"anchor\" href=\"#5-数据库\">#</a> <strong>5. 数据库</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">MySQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.mysql.com\">https://www.mysql.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Oracle</td>\n<td style=\"text-align:left\"><a href=\"https://www.oracle.com/\">https://www.oracle.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PostgreSQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.postgresql.org\">https://www.postgresql.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MariaDB</td>\n<td style=\"text-align:left\"><a href=\"https://mariadb.org\">https://mariadb.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MongoDB</td>\n<td style=\"text-align:left\"><a href=\"https://www.mongodb.com\">https://www.mongodb.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Redis</td>\n<td style=\"text-align:left\"><a href=\"https://redis.io\">https://redis.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Memcached</td>\n<td style=\"text-align:left\"><a href=\"https://memcached.org\">https://memcached.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">达梦数据库</td>\n<td style=\"text-align:left\"><a href=\"https://www.dameng.com/\">https://www.dameng.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OceanBase</td>\n<td style=\"text-align:left\"><a href=\"https://www.oceanbase.com/\">https://www.oceanbase.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Elasticsearch</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/elasticsearch/\">https://www.elastic.co/elasticsearch/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ClickHouse</td>\n<td style=\"text-align:left\"><a href=\"https://clickhouse.com\">https://clickhouse.com</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"6-基础服务\"><a class=\"anchor\" href=\"#6-基础服务\">#</a> <strong>6. 基础服务</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Nginx</td>\n<td style=\"text-align:left\"><a href=\"https://nginx.org\">https://nginx.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Apache HTTPD</td>\n<td style=\"text-align:left\"><a href=\"https://httpd.apache.org\">https://httpd.apache.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Tomcat</td>\n<td style=\"text-align:left\"><a href=\"https://tomcat.apache.org/\">https://tomcat.apache.org/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HAProxy</td>\n<td style=\"text-align:left\"><a href=\"https://www.haproxy.org\">https://www.haproxy.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Dnsmasq</td>\n<td style=\"text-align:left\"><a href=\"https://thekelleys.org.uk/dnsmasq/doc.html\">https://thekelleys.org.uk/dnsmasq/doc.html</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CoreDNS</td>\n<td style=\"text-align:left\"><a href=\"https://coredns.io\">https://coredns.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RabbitMQ</td>\n<td style=\"text-align:left\"><a href=\"https://www.rabbitmq.com\">https://www.rabbitmq.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kafka</td>\n<td style=\"text-align:left\"><a href=\"https://kafka.apache.org\">https://kafka.apache.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Etcd</td>\n<td style=\"text-align:left\"><a href=\"https://etcd.io\">https://etcd.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Consul</td>\n<td style=\"text-align:left\"><a href=\"https://www.consul.io\">https://www.consul.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"7-cicd-与服务网格\"><a class=\"anchor\" href=\"#7-cicd-与服务网格\">#</a> <strong>7. CI/CD 与服务网格</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Jenkins</td>\n<td style=\"text-align:left\"><a href=\"https://www.jenkins.io\">https://www.jenkins.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">GitLab CI/CD</td>\n<td style=\"text-align:left\"><a href=\"https://about.gitlab.com\">https://about.gitlab.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">GitHub Actions</td>\n<td style=\"text-align:left\"><a href=\"https://github.com/features/actions\">https://github.com/features/actions</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ArgoCD</td>\n<td style=\"text-align:left\"><a href=\"https://argo-cd.readthedocs.io/\">https://argo-cd.readthedocs.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Spinnaker</td>\n<td style=\"text-align:left\"><a href=\"https://spinnaker.io\">https://spinnaker.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Istio</td>\n<td style=\"text-align:left\"><a href=\"https://istio.io/\">https://istio.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Envoy Proxy</td>\n<td style=\"text-align:left\"><a href=\"https://www.envoyproxy.io\">https://www.envoyproxy.io</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"8-监控与日志系统\"><a class=\"anchor\" href=\"#8-监控与日志系统\">#</a> <strong>8. 监控与日志系统</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Prometheus</td>\n<td style=\"text-align:left\"><a href=\"https://prometheus.io\">https://prometheus.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Grafana</td>\n<td style=\"text-align:left\"><a href=\"https://grafana.com\">https://grafana.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Loki</td>\n<td style=\"text-align:left\"><a href=\"https://grafana.com/oss/loki/\">https://grafana.com/oss/loki/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ELK Stack</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/what-is/elk-stack\">https://www.elastic.co/what-is/elk-stack</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Kibana</td>\n<td style=\"text-align:left\"><a href=\"https://www.elastic.co/kibana/\">https://www.elastic.co/kibana/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Fluentd</td>\n<td style=\"text-align:left\"><a href=\"https://www.fluentd.org\">https://www.fluentd.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Zabbix</td>\n<td style=\"text-align:left\"><a href=\"https://www.zabbix.com\">https://www.zabbix.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Netdata</td>\n<td style=\"text-align:left\"><a href=\"https://www.netdata.cloud\">https://www.netdata.cloud</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"9-自动化运维工具\"><a class=\"anchor\" href=\"#9-自动化运维工具\">#</a> <strong>9. 自动化运维工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Ansible</td>\n<td style=\"text-align:left\"><a href=\"https://docs.ansible.com/\">https://docs.ansible.com/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Terraform</td>\n<td style=\"text-align:left\"><a href=\"https://developer.hashicorp.com/terraform/docs\">https://developer.hashicorp.com/terraform/docs</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SaltStack</td>\n<td style=\"text-align:left\"><a href=\"https://docs.saltproject.io/\">https://docs.saltproject.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Puppet</td>\n<td style=\"text-align:left\"><a href=\"https://puppet.com/docs/\">https://puppet.com/docs/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Chef</td>\n<td style=\"text-align:left\"><a href=\"https://docs.chef.io/\">https://docs.chef.io/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Packer</td>\n<td style=\"text-align:left\"><a href=\"https://developer.hashicorp.com/packer/docs\">https://developer.hashicorp.com/packer/docs</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"10-运维常用工具\"><a class=\"anchor\" href=\"#10-运维常用工具\">#</a> <strong>10. 运维常用工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">工具名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Xshell</td>\n<td style=\"text-align:left\"><a href=\"https://www.netsarang.com/zh/xshell/\">https://www.netsarang.com/zh/xshell/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Xftp</td>\n<td style=\"text-align:left\"><a href=\"https://www.netsarang.com/en/xftp/\">https://www.netsarang.com/en/xftp/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MobaXterm</td>\n<td style=\"text-align:left\"><a href=\"https://mobaxterm.mobatek.net\">https://mobaxterm.mobatek.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PuTTY</td>\n<td style=\"text-align:left\"><a href=\"https://www.putty.org\">https://www.putty.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SecureCRT</td>\n<td style=\"text-align:left\"><a href=\"https://www.vandyke.com/products/securecrt/\">https://www.vandyke.com/products/securecrt/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">WinSCP</td>\n<td style=\"text-align:left\"><a href=\"https://winscp.net\">https://winscp.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FileZilla</td>\n<td style=\"text-align:left\"><a href=\"https://filezilla-project.org\">https://filezilla-project.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FastCopy</td>\n<td style=\"text-align:left\"><a href=\"https://fastcopy.jp/en/\">https://fastcopy.jp/en/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Everything</td>\n<td style=\"text-align:left\"><a href=\"https://www.voidtools.com\">https://www.voidtools.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Wireshark</td>\n<td style=\"text-align:left\"><a href=\"https://www.wireshark.org\">https://www.wireshark.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VirtualBox</td>\n<td style=\"text-align:left\"><a href=\"https://www.virtualbox.org/\">https://www.virtualbox.org/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VMware Workstation</td>\n<td style=\"text-align:left\"><a href=\"https://www.vmware.com/products/workstation-pro.html\">https://www.vmware.com/products/workstation-pro.html</a></td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"11-数据库可视化连接工具\"><a class=\"anchor\" href=\"#11-数据库可视化连接工具\">#</a> <strong>11. 数据库可视化连接工具</strong></h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">工具名称</th>\n<th style=\"text-align:left\">官网链接</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">DBeaver</td>\n<td style=\"text-align:left\"><a href=\"https://dbeaver.io\">https://dbeaver.io</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Navicat</td>\n<td style=\"text-align:left\"><a href=\"https://www.navicat.com\">https://www.navicat.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HeidiSQL</td>\n<td style=\"text-align:left\"><a href=\"https://www.heidisql.com\">https://www.heidisql.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SSMS</td>\n<td style=\"text-align:left\"><a href=\"https://learn.microsoft.com/sql/ssms/\">https://learn.microsoft.com/sql/ssms/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Toad for Oracle</td>\n<td style=\"text-align:left\"><a href=\"https://www.toadworld.com/products/toad-for-oracle\">https://www.toadworld.com/products/toad-for-oracle</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SQL Developer</td>\n<td style=\"text-align:left\"><a href=\"https://www.oracle.com/database/sqldeveloper/\">https://www.oracle.com/database/sqldeveloper/</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">DbVisualizer</td>\n<td style=\"text-align:left\"><a href=\"https://www.dbvis.com\">https://www.dbvis.com</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SQL Workbench</td>\n<td style=\"text-align:left\"><a href=\"https://www.sql-workbench.eu\">https://www.sql-workbench.eu</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">phpMyAdmin</td>\n<td style=\"text-align:left\"><a href=\"https://www.phpmyadmin.net\">https://www.phpmyadmin.net</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">pgAdmin</td>\n<td style=\"text-align:left\"><a href=\"https://www.pgadmin.org\">https://www.pgadmin.org</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MongoDB Compass</td>\n<td style=\"text-align:left\"><a href=\"https://www.mongodb.com/products/compass\">https://www.mongodb.com/products/compass</a></td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RedisInsight</td>\n<td style=\"text-align:left\"><a href=\"https://redis.com/redis-enterprise/redis-insight/\">https://redis.com/redis-enterprise/redis-insight/</a></td>\n</tr>\n</tbody>\n</table>\n",
            "tags": []
        },
        {
            "id": "http://ixuyong.cn/posts/2330853882.html",
            "url": "http://ixuyong.cn/posts/2330853882.html",
            "title": "K8S基于Jenkins实现微服务应用CICD实践（四）",
            "date_published": "2025-06-19T12:54:54.000Z",
            "content_html": "<h3 id=\"k8s基于jenkins实现微服务应用cicd实践四\"><a class=\"anchor\" href=\"#k8s基于jenkins实现微服务应用cicd实践四\">#</a> K8S 基于 Jenkins 实现微服务应用 CICD 实践（四）</h3>\n<p>CI 阶段：开发人员 -&gt; 提交代码 -&gt;gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 -&gt; 构建镜像 -&gt; 推送 Harbor-&gt; 部署应用至 K8S 测试环境；<br />\nCD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 测试环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"一-环境准备\"><a class=\"anchor\" href=\"#一-环境准备\">#</a> 一、环境准备</h4>\n<p>准备好 Java 代码、Dockerfile、deploy.yaml 资源清单文件  提交到 Gitlab 服务器；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.name <span class=\"token string\">\"oldxu\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.email </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ <span class=\"token function\">git</span> init</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ <span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ <span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> <span class=\"token string\">\"first commit\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>$ <span class=\"token function\">git</span> remote remove origin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>$ <span class=\"token function\">git</span> remote <span class=\"token function\">add</span> origin http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ <span class=\"token function\">git</span> remote <span class=\"token parameter variable\">-v</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>origin  http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.gi <span class=\"token punctuation\">(</span>fetch<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>origin  http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.gi <span class=\"token punctuation\">(</span>push<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>$ <span class=\"token function\">git</span> push <span class=\"token parameter variable\">-u</span> origin <span class=\"token string\">\"master\"</span></pre></td></tr></table></figure><h4 id=\"二-ci阶段\"><a class=\"anchor\" href=\"#二-ci阶段\">#</a> 二、CI 阶段</h4>\n<p>CI 阶段分为以下 6 步：<br />\n1、获取代码<br />\n 2、漏洞扫描<br />\n 3、检测漏洞扫描结果，如果正常则继续、否则就终止<br />\n 4、使用 maven 进行编译，打包<br />\n 5、制作 Docker 镜像、推送到 Harbor 仓库  (Dockerfile 文件)<br />\n 6、交付应用到 K8S</p>\n<h5 id=\"21-编写pipeline框架\"><a class=\"anchor\" href=\"#21-编写pipeline框架\">#</a> 2.1 编写 Pipeline 框架</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"获取代码\"'</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A7fPIQd.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-获取代码\"><a class=\"anchor\" href=\"#22-获取代码\">#</a> 2.2 获取代码</h5>\n<p><strong>1、Jenkins 上配置 Gitlab 认证信息</strong></p>\n<p>系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Dhao75j.png\" alt=\"2.png\" /></p>\n<p><strong>2、SlavePod 访问 gitlab</strong></p>\n<p>通过 Coredns 配置自定义域名解析，如果 sgitlab 解析至公网，无需配置此步骤；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm coredns -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping gitlab.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING gitlab.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.381</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.203</span> ms</pre></td></tr></table></figure><p><strong>3、生成流水线脚本获取代码</strong></p>\n<p>通过流水线语法 -&gt; 片段生成器 -&gt; 生成流水线脚本，生成 Pipeline 流水线</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/O2hXRRW.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8txbe6d.png\" alt=\"2.png\" /></p>\n<p><strong>4、测试获取代码 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/RcapPaO.png\" alt=\"1.png\" /></p>\n<h5 id=\"23-sonarqube漏洞扫描\"><a class=\"anchor\" href=\"#23-sonarqube漏洞扫描\">#</a> 2.3 Sonarqube 漏洞扫描</h5>\n<p><strong>1、配置 dns 解析（如果 sonarqube 解析至公网，无需配置此步骤）</strong><br />\nslavePod 需要访问 sonarqube 服务端，sonarqube 服务端需要回调 jenkins，获取扫描结果 。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping sonar.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING sonar.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.187</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping jenkins.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PING jenkins.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.189</span> ms</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr></table></figure><p><strong>2、Jenkins 集成 Sonarqube</strong></p>\n<p>生成 sonarqube 令牌：用户 -&gt; 我的账号 -&gt; 安全</p>\n<p><em>保存令牌信息：squ_6e57e496a22ebdf0723c3683bd489df57f967f49</em></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WIPhwiL.png\" alt=\"1.png\" /></p>\n<p>配置 sonarqube 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6hyCvFt.png\" alt=\"1.png\" /></p>\n<p>Jenkins 集成 Sonarqube：系统管理 -&gt; 系统配置 -&gt;SonarQube servers-&gt;Add SonarQube</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TDCKExZ.png\" alt=\"2.png\" /></p>\n<p><strong>3、获取 sonar-scanner 扫描命令（此步骤不用执行）</strong></p>\n<p>项目 -&gt; 手工 -&gt; 显示名</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6xdkGGq.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WV443AU.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/kgfxuOS.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bahZPtg.png\" alt=\"6.png\" /></p>\n<p><em>#获取 sonar-scanner 扫描命令，需要在项目目录下进行扫描</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sonar-scanner <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.projectKey</span><span class=\"token operator\">=</span>springboot <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.sources</span><span class=\"token operator\">=</span>. <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.host.url</span><span class=\"token operator\">=</span>http://sonar.hmallleasing.com <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.login</span><span class=\"token operator\">=</span>squ_6e57e496a22ebdf0723c3683bd489df57f967f49</pre></td></tr></table></figure><p><strong>4、测试代码扫描 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"187\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HCty5jj.png\" alt=\"2.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JORa5YX.png\" alt=\"3.png\" /></p>\n<p><strong>5、此处遇到问题总结</strong></p>\n<p>由于上传数据太大，在 ingress 中 client_max_body_size 默认值为 1m , 该参数的作用是设置最大允许客户端请求体的大小，如果超过了此值，客户端会收到 413 状态码，意思是请求的实体太大。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sdu1z3U.png\" alt=\"3.png\" /></p>\n<p>处理方法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 针对单个 ingress</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">cat</span> 03-sonarqube-ingress.yaml </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: sonarqube-ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    nginx.ingress.kubernetes.io/proxy-body-size: <span class=\"token string\">\"200m\"</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - host: <span class=\"token string\">\"sonar.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            name: sonarqube-svc</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              name: web</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#2. 针对所有 ingress</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>$ kubectl edit configmap <span class=\"token parameter variable\">-n</span> ingress-nginx ingress-nginx-controller</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  proxy-body-size: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"24-检查扫描结果\"><a class=\"anchor\" href=\"#24-检查扫描结果\">#</a> 2.4 检查扫描结果</h5>\n<p>1、配置 sonarquber, 让其将检查结果通知 jenkins，如果正常则继续、否则就终止执行</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aU33pHW.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/oufVrcE.png\" alt=\"5.png\" /></p>\n<p>URL：<a href=\"http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook\">http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook</a><br />\nJenkins 访问地址：<a href=\"http://jenkins.hamlllleasing.com\">jenkins.hamlllleasing.com</a><br />\nJenkins 用户名：admin<br />\nJenkins 密码：talent</p>\n<p><strong>2、检查扫描结果 pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"195\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iYNMwZa.png\" alt=\"4.png\" /></p>\n<h5 id=\"25-代码编译\"><a class=\"anchor\" href=\"#25-代码编译\">#</a> 2.5 代码编译</h5>\n<p><strong>1、导入 mvn 依赖</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins repository<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/root/.m2/repository</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins repository<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp ./* root@192.168.1.75:/data/nfs/maven/repository/</span></pre></td></tr></table></figure><p><strong>2、代码编译 pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">cd</span> nf-flms <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************开始编译代码*********************\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>            mvn  clean package <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-order/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-gateway/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-statistics/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-system/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-openapi/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-admin/target/*.jar <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"202\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************代码编译成功*********************\"</span>\t\t\t</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>          <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"221\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/99NnfAi.png\" alt=\"1.png\" /></p>\n<h5 id=\"26-制作docker镜像\"><a class=\"anchor\" href=\"#26-制作docker镜像\">#</a> 2.6 制作 Docker 镜像</h5>\n<p>制作 Docker 镜像、推送到 Harbor 仓库，根据 Dockerfile 文件生成 Docker 镜像</p>\n<p><strong>1、配置 dns 解析（如果 harbor 解析至公网，无需配置此步骤）</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.68 s.hmallleasing.com             <span class=\"token comment\">#harbor</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING s.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.68<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.257</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.198</span> ms</pre></td></tr></table></figure><p><strong>2、配置 harbor 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/eW8zQLR.png\" alt=\"2.png\" /></p>\n<p><strong>3、制作 docker 镜像 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">cd</span> nf-flms <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************开始编译代码*********************\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>            mvn  clean package <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-order/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-gateway/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-statistics/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-system/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-openapi/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-admin/target/*.jar <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************代码编译成功*********************\"</span>\t\t\t</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>          <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"222\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"226\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"249\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"270\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Order镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"291\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"312\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Openapi镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"333\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Statistics镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"354\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end</pre></td></tr><tr><td data-num=\"360\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/yL744sz.png\" alt=\"2.png\" /></p>\n<p><strong>5、编译报错总结</strong></p>\n<p>编译过程出现报错，由于多个服务同时进行编译，CPU 负载过高，解决方案让部分服务 sleep 60；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t            <span class=\"token function\">sleep</span> <span class=\"token number\">60</span>  <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"27-交付应用到k8s\"><a class=\"anchor\" href=\"#27-交付应用到k8s\">#</a> 2.7 交付应用到 K8S</h5>\n<p>1、将 K8S 的 kubeconfig 文件下载至本地，配置 Jenkins，将 config 文件制作为一个 Scretfile；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /root/.kube/config</span></pre></td></tr></table></figure><p>配置 k8s 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9AysMkZ.png\" alt=\"1.png\" /></p>\n<p><strong>2、编写 pipeline 流水线</strong></p>\n<p>在 Stage 中引用这个 config 文件，就可以操作对应的集群，部署前需做以下操作；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create ns prod</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create secret docker-registry harbor-admin --docker-server<span class=\"token operator\">=</span>s.hmallleasing.com --docker-username<span class=\"token operator\">=</span>admin --docker-password<span class=\"token operator\">=</span>Talent*passwd <span class=\"token parameter variable\">-n</span> prod</pre></td></tr></table></figure><ul>\n<li><em>部署的名称空间需要提前创建</em></li>\n<li><em>需要创建对应 namespace 的 Harbor 认证 Secrets -&gt;harbor-admin</em></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">cd</span> nf-flms <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************开始编译代码*********************\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>            mvn  clean package <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-order/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-gateway/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-statistics/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-system/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-openapi/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-admin/target/*.jar <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************代码编译成功*********************\"</span>\t\t\t</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>          <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"222\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"226\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"249\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"270\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Order镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"291\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"312\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Openapi镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"333\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Statistics镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"354\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end</pre></td></tr><tr><td data-num=\"360\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署微服务至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Gateway'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"374\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"378\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"380\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"381\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Order'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"397\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"400\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"401\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"403\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"404\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre></pre></td></tr><tr><td data-num=\"409\"></td><td><pre></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付System'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"424\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"427\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"428\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Monitor'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"445\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"448\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"449\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"450\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"452\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"453\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Statistics'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"469\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"472\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"474\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"476\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"477\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"482\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Openapi'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"493\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"496\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"497\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"498\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"500\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"501\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"505\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>     //parallel end</pre></td></tr><tr><td data-num=\"506\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>      //stage\t\t\t\t</pre></td></tr><tr><td data-num=\"507\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wCakB7r.png\" alt=\"1.png\" /></p>\n<h5 id=\"28-选择制定微服组件部署\"><a class=\"anchor\" href=\"#28-选择制定微服组件部署\">#</a> 2.8 选择制定微服组件部署</h5>\n<p><strong>1、安装插件：</strong></p>\n<p>系统管理 -&gt; 插件管理 -&gt;Active Choices</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SF60v3O.png\" alt=\"2.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5xnQZ96.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aw1g13I.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/IHtPKZi.png\" alt=\"6.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nRulz12.png\" alt=\"1.png\" /></p>\n<p><strong>2、选择指定微服务进行部署（Deploy_UI == &quot;true&quot; 或者 Deploy_All == &quot;true&quot;）</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Gateway <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Order <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_System <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Monitor <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Statistics <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Openapi <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"175\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"183\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"199\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">cd</span> nf-flms <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************开始编译代码*********************\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>            mvn  clean package <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-order/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-gateway/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-statistics/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-system/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-openapi/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-admin/target/*.jar <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"213\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************代码编译成功*********************\"</span>\t\t\t</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>          <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"218\"></td><td><pre></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"228\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"232\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"237\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Gateway <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"249\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"253\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"256\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_System <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"271\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"273\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"275\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"277\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"278\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Order镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Order <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"293\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"299\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"300\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Monitor <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"317\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"319\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"321\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"322\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Openapi镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Openapi <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"329\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"337\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"339\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"341\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"343\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"344\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Statistics镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Statistics <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"363\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"365\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"366\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"371\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end</pre></td></tr><tr><td data-num=\"372\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"373\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署微服务至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"375\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Gateway'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Gateway <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"387\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"390\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"391\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"393\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"394\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Order'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Order <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"411\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"414\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"415\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"417\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"418\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre></pre></td></tr><tr><td data-num=\"423\"></td><td><pre></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付System'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_System <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"436\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"439\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"440\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"442\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"443\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Monitor'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"449\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Monitor <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"461\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"464\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"465\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"466\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"468\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"469\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"473\"></td><td><pre></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Statistics'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Statistics <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"476\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"486\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"489\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"490\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"491\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"493\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"494\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"499\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Openapi'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_Openapi <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>  </pre></td></tr><tr><td data-num=\"501\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"511\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#prod#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"514\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"515\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"516\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"519\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"520\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"521\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"522\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>     //parallel end</pre></td></tr><tr><td data-num=\"524\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>      //stage\t\t\t\t</pre></td></tr><tr><td data-num=\"525\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"526\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WuyjmCy.png\" alt=\"2.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8bRIdyw.png\" alt=\"1.png\" /></p>\n<h5 id=\"29-配置自动触发构建\"><a class=\"anchor\" href=\"#29-配置自动触发构建\">#</a> 2.9 配置自动触发构建</h5>\n<p>Jenkins 配置：</p>\n<p>#Gitee 配置参考连接 https://blog.csdn.net/hali90s/article/details/126991514</p>\n<p>#Gitlab 配置参考连接 https://blog.csdn.net/weixin_58423196/article/details/146407508</p>\n<p>1、安装插件：<a href=\"https://so.csdn.net/so/search?q=GitLab&amp;spm=1001.2101.3001.7020\">GitLab</a> Plugin</p>\n<p>2、配置 -&gt;Triggers</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1Chji1c.png\" alt=\"1.png\" /></p>\n<p>点击右下角的 &quot;Advanced&quot;，进入触发器的高级配置，在 &quot;Allowed branched&quot; 部分按需选择 webhook 作用于哪些分支，然后点击 &quot;Generate&quot; 生成唯一的 secret token。187ad167e619cf50a063093898b6befb</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/YbtVvMh.png\" alt=\"2.png\" /></p>\n<p><strong>Gitlab 配置：</strong></p>\n<p>1、设置 -&gt; 网络 -&gt; 外部请求 -&gt; 允许 Webhook 和服务对本地网络的请求</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/jlcu5UF.png\" alt=\"4.png\" /></p>\n<p>1、Gitlab 点击对应项目 -&gt; 设置 -&gt;Webhooks</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/odZ46yy.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/UEqybx9.png\" alt=\"6.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KBeFU1v.png\" alt=\"1.png\" /></p>\n<h4 id=\"三-cd阶段\"><a class=\"anchor\" href=\"#三-cd阶段\">#</a> 三、CD 阶段</h4>\n<p>CD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 生产环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"31-获取完整的镜像名称\"><a class=\"anchor\" href=\"#31-获取完整的镜像名称\">#</a> 3.1 获取完整的镜像名称</h5>\n<p><strong>1、获取 Harbor 镜像 Tag</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -s -uadmin:passwd -H'Content-Type: application/json' -X GET https://s.hmallleasing.com/v2/nf-flms/nf-flms-statistics/tags/list | sed -r 's#(\\&#123;.*\\[)(.*)(\\]\\&#125;)#\\2#g' | xargs -d \",\" -n1 | xargs -n1 | sort -t \"_\" -k2 -k3 -nr | head -5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ab41fb8_20250619_110313</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ab41fb8_20250619_104857</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ab41fb8_20250618_143612</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ab41fb8_20250618_140623</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ab41fb8_20250618_124756</pre></td></tr></table></figure><p><strong>2、安装插件</strong></p>\n<p>系统管理 -&gt; 插件管理 -&gt;Active Choices、 Image Tag</p>\n<p><strong>3、创建流水线</strong></p>\n<p>创建一个新的 Job，名字为 nf-flms-order-cd，类型 Pipeline</p>\n<p><strong>变量：Harbor_Url</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;Active Choices Parameter<br />\n 语法：return [&quot;<a href=\"http://s.hmallleasing.com\">s.hmallleasing.com</a>&quot;,&quot;<a href=\"http://harbor.hmallleasing.com\">harbor.hmallleasing.com</a>&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pTJQ8re.png\" alt=\"2.png\" /></p>\n<p><strong>级联变量：Image_Tag</strong></p>\n<p>项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Image Tag Parameter</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZkHKfrN.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/mn7rII7.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Z2gbFbf.png\" alt=\"3.png\" /></p>\n<p><strong>4、编写 pipeline 输出完整的镜像名称</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5sYIpfJ.png\" alt=\"1.png\" /></p>\n<h5 id=\"32-生产环境中部署服务至k8s\"><a class=\"anchor\" href=\"#32-生产环境中部署服务至k8s\">#</a> 3.2 生产环境中部署服务至 K8S</h5>\n<p>1、编写 yaml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/nf-flms-order nf-flms-order=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2、部署应用</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=s.hmallleasing.com --docker-username=admin --docker-password=PASSWD -n prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f deploy-prod.yaml</span></pre></td></tr></table></figure><h5 id=\"33-cd流水线部署指定tag版本到k8s生产环境\"><a class=\"anchor\" href=\"#33-cd流水线部署指定tag版本到k8s生产环境\">#</a> 3.3 CD 流水线部署指定 Tag 版本到 K8S 生产环境</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/nf-flms-order nf-flms-order=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zVgilqE.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xbkocx4.png\" alt=\"2.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe deploy nf-flms-order -n prod |grep -i image</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    Image:      s.hmallleasing.com/nf-flms/nf-flms-order:b526b40_20250618_094603</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      /data from data-image <span class=\"token punctuation\">(</span>rw<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    Image:      registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   data-image:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ClaimName:  data-image</pre></td></tr></table></figure><h5 id=\"34-询问是否需要回退\"><a class=\"anchor\" href=\"#34-询问是否需要回退\">#</a> 3.4 询问是否需要回退</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t  Image_Name <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/$&#123;Image_Name&#125; $&#123;Image_Name&#125;=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'快速回滚'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                timeout<span class=\"token punctuation\">(</span>time:1 , unit: <span class=\"token string\">'HOURS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                  def UserInput <span class=\"token operator\">=</span> input message: <span class=\"token string\">'是否回退至上一个版本'</span>, parameters: <span class=\"token punctuation\">[</span>choice<span class=\"token punctuation\">(</span>choices: <span class=\"token punctuation\">[</span><span class=\"token string\">'No'</span>, <span class=\"token string\">'Yes'</span><span class=\"token punctuation\">]</span>, name: <span class=\"token string\">'rollback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>UserInput <span class=\"token operator\">==</span> <span class=\"token string\">\"Yes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl rollout undo deployment $&#123;Image_Name&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span>else <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"没有选择回退\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2yUPPaU.png\" alt=\"1.png\" /></p>\n<p>#如果选择 “Yes” 继续，则回退至上一个版本，等待时间为 1 小时</p>\n<p>#如果选择 “No” 继续，则不回退至上一个版本</p>\n<p>#如果没有选择，则不回退至上一个版本</p>\n",
            "tags": [
                "DevOps"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/889219339.html",
            "url": "http://ixuyong.cn/posts/889219339.html",
            "title": "K8S基于Jenkins实现SpringCloud微服务CI与CD实践（三）",
            "date_published": "2025-06-18T02:28:16.000Z",
            "content_html": "<h3 id=\"k8s基于jenkins实现springcloud微服务ci与cd实践三\"><a class=\"anchor\" href=\"#k8s基于jenkins实现springcloud微服务ci与cd实践三\">#</a> K8S 基于 Jenkins 实现 SpringCloud 微服务 CI 与 CD 实践（三）</h3>\n<p>CI 阶段：开发人员 -&gt; 提交代码 -&gt;gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 -&gt; 构建镜像 -&gt; 推送 Harbor-&gt; 部署应用至 K8S 测试环境；<br />\nCD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 测试环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"一-环境准备\"><a class=\"anchor\" href=\"#一-环境准备\">#</a> 一、环境准备</h4>\n<p>准备好 Java 代码、Dockerfile、deploy.yaml 资源清单文件  提交到 Gitlab 服务器；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.name <span class=\"token string\">\"oldxu\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.email </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ <span class=\"token function\">git</span> init</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ <span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ <span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> <span class=\"token string\">\"first commit\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>$ <span class=\"token function\">git</span> remote remove origin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>$ <span class=\"token function\">git</span> remote <span class=\"token function\">add</span> origin http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ <span class=\"token function\">git</span> remote <span class=\"token parameter variable\">-v</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>origin  http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.gi <span class=\"token punctuation\">(</span>fetch<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>origin  http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.gi <span class=\"token punctuation\">(</span>push<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>$ <span class=\"token function\">git</span> push <span class=\"token parameter variable\">-u</span> origin <span class=\"token string\">\"master\"</span></pre></td></tr></table></figure><h4 id=\"二-ci阶段\"><a class=\"anchor\" href=\"#二-ci阶段\">#</a> 二、CI 阶段</h4>\n<p>CI 阶段分为以下 6 步：<br />\n1、获取代码<br />\n 2、漏洞扫描<br />\n 3、检测漏洞扫描结果，如果正常则继续、否则就终止<br />\n 4、使用 maven 进行编译，打包<br />\n 5、制作 Docker 镜像、推送到 Harbor 仓库  (Dockerfile 文件)<br />\n 6、交付应用到 K8S</p>\n<h5 id=\"21-编写pipeline框架\"><a class=\"anchor\" href=\"#21-编写pipeline框架\">#</a> 2.1 编写 Pipeline 框架</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"获取代码\"'</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A7fPIQd.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-获取代码\"><a class=\"anchor\" href=\"#22-获取代码\">#</a> 2.2 获取代码</h5>\n<p><strong>1、Jenkins 上配置 Gitlab 认证信息</strong></p>\n<p>系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Dhao75j.png\" alt=\"2.png\" /></p>\n<p><strong>2、SlavePod 访问 Gitlab</strong></p>\n<p>通过 Coredns 配置自定义域名解析，如果 sgitlab 解析至公网，无需配置此步骤；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm coredns -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping gitlab.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING gitlab.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.381</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.203</span> ms</pre></td></tr></table></figure><p><strong>3、生成流水线脚本获取代码</strong></p>\n<p>通过流水线语法 -&gt; 片段生成器 -&gt; 生成流水线脚本，生成 Pipeline 流水线</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/O2hXRRW.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8txbe6d.png\" alt=\"2.png\" /></p>\n<p><strong>4、测试获取代码 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/jrXystg.png\" alt=\"1.png\" /></p>\n<h5 id=\"23-sonarqube漏洞扫描\"><a class=\"anchor\" href=\"#23-sonarqube漏洞扫描\">#</a> 2.3 Sonarqube 漏洞扫描</h5>\n<p><strong>1、配置 dns 解析（如果 sonarqube 解析至公网，无需配置此步骤）</strong><br />\nslavePod 需要访问 sonarqube 服务端，sonarqube 服务端需要回调 jenkins，获取扫描结果 。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping sonar.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING sonar.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.187</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping jenkins.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PING jenkins.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.189</span> ms</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr></table></figure><p><strong>2、Jenkins 集成 Sonarqube</strong></p>\n<p>生成 sonarqube 令牌：用户 -&gt; 我的账号 -&gt; 安全</p>\n<p><em>保存令牌信息：squ_6e57e496a22ebdf0723c3683bd489df57f967f49</em></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WIPhwiL.png\" alt=\"1.png\" /></p>\n<p>配置 sonarqube 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6hyCvFt.png\" alt=\"1.png\" /></p>\n<p>Jenkins 集成 Sonarqube：系统管理 -&gt; 系统配置 -&gt;SonarQube servers-&gt;Add SonarQube</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TDCKExZ.png\" alt=\"2.png\" /></p>\n<p><strong>3、获取 sonar-scanner 扫描命令（此步骤不用执行）</strong></p>\n<p>项目 -&gt; 手工 -&gt; 显示名</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6xdkGGq.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WV443AU.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/kgfxuOS.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bahZPtg.png\" alt=\"6.png\" /></p>\n<p><em>#获取 sonar-scanner 扫描命令，需要在项目目录下进行扫描</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sonar-scanner <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.projectKey</span><span class=\"token operator\">=</span>springboot <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.sources</span><span class=\"token operator\">=</span>. <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.host.url</span><span class=\"token operator\">=</span>http://sonar.hmallleasing.com <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.login</span><span class=\"token operator\">=</span>squ_6e57e496a22ebdf0723c3683bd489df57f967f49</pre></td></tr></table></figure><p><strong>4、测试代码扫描 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"164\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"171\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8qbQm29.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5LOcmBp.png\" alt=\"2.png\" /></p>\n<p><strong>5、此处遇到问题总结</strong></p>\n<p>由于上传数据太大，在 ingress 中 client_max_body_size 默认值为 1m , 该参数的作用是设置最大允许客户端请求体的大小，如果超过了此值，客户端会收到 413 状态码，意思是请求的实体太大。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sdu1z3U.png\" alt=\"3.png\" /></p>\n<p>处理方法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 针对单个 ingress</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">cat</span> 03-sonarqube-ingress.yaml </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: sonarqube-ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    nginx.ingress.kubernetes.io/proxy-body-size: <span class=\"token string\">\"200m\"</span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - host: <span class=\"token string\">\"sonar.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            name: sonarqube-svc</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              name: web</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#2. 针对所有 ingress</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>$ kubectl edit configmap <span class=\"token parameter variable\">-n</span> ingress-nginx ingress-nginx-controller</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  proxy-body-size: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"24-检查扫描结果\"><a class=\"anchor\" href=\"#24-检查扫描结果\">#</a> 2.4 检查扫描结果</h5>\n<p>1、配置 sonarquber, 让其将检查结果通知 jiekins，如果正常则继续、否则就终止执行</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aU33pHW.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/oufVrcE.png\" alt=\"5.png\" /></p>\n<p>URL：<a href=\"http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook\">http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook</a><br />\nJenkins 访问地址：<a href=\"http://jenkins.hamlllleasing.com\">jenkins.hamlllleasing.com</a><br />\nJenkins 用户名：admin<br />\nJenkins 密码：talent</p>\n<p><strong>2、检查扫描结果 pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"179\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8zy6sqY.png\" alt=\"4.png\" /></p>\n<h5 id=\"25-代码编译\"><a class=\"anchor\" href=\"#25-代码编译\">#</a> 2.5 代码编译</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"171\"></td><td><pre></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"218\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--registry</span><span class=\"token operator\">=</span>https://registry.npmmirror.com <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                <span class=\"token function\">npm</span> run build:prod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> ./dist/*</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>     //代码编译stage end\t\t</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"257\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"271\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TYN2ox5.png\" alt=\"5.png\" /></p>\n<h5 id=\"26-制作docker镜像\"><a class=\"anchor\" href=\"#26-制作docker镜像\">#</a> 2.6 制作 Docker 镜像</h5>\n<p>制作 Docker 镜像、推送到 Harbor 仓库，根据 Dockerfile 文件生成 Docker 镜像</p>\n<p><strong>1、配置 dns 解析（如果 harbor 解析至公网，无需配置此步骤）</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.68 s.hmallleasing.com             <span class=\"token comment\">#harbor</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING s.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.68<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.257</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.198</span> ms</pre></td></tr></table></figure><p><strong>2、配置 harbor 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/eW8zQLR.png\" alt=\"2.png\" /></p>\n<p><strong>3、制作 docker 镜像 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/nf-flms.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/release'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"75\"></td><td><pre></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Order'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp; \\</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Statistics'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Openapi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; pwd &amp;&amp; ls &amp;&amp;  \\</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"168\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t\t</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">cd</span> nf-flms <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************开始编译代码*********************\"</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>            mvn  clean package <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-order/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-gateway/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-statistics/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-system/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-openapi/target/*.jar <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> nf-flms-admin/target/*.jar <span class=\"token operator\">&amp;&amp;</span> </pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"*********************代码编译成功*********************\"</span>\t\t\t</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>          <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"212\"></td><td><pre></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"222\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"226\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"249\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"270\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Order镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"291\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-admin\"</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"312\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Openapi镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"333\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Statistics镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"354\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end</pre></td></tr><tr><td data-num=\"360\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/rMkUFzX.png\" alt=\"1.png\" /></p>\n<p><strong>5、编译报错总结</strong></p>\n<p>编译过程出现报错，由于多个服务同时进行编译，CPU 负载过高，解决方案让部分服务 sleep 60；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t            <span class=\"token function\">sleep</span> <span class=\"token number\">60</span>  <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"27-交付应用到k8s\"><a class=\"anchor\" href=\"#27-交付应用到k8s\">#</a> 2.7 交付应用到 K8S</h5>\n<p>1、将 K8S 的 kubeconfig 文件下载至本地，配置 Jenkins，将 config 文件制作为一个 Scretfile；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /root/.kube/config</span></pre></td></tr></table></figure><p>配置 k8s 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9AysMkZ.png\" alt=\"1.png\" /></p>\n<p><strong>2、编写 pipeline 流水线</strong></p>\n<p>在 Stage 中引用这个 config 文件，就可以操作对应的集群，部署前需做以下操作；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create ns <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create secret docker-registry harbor-admin --docker-server<span class=\"token operator\">=</span>s.hmallleasing.com --docker-username<span class=\"token operator\">=</span>admin --docker-password<span class=\"token operator\">=</span>Talent*19871988 <span class=\"token parameter variable\">-n</span> <span class=\"token builtin class-name\">test</span></pre></td></tr></table></figure><ul>\n<li><em>部署的名称空间需要提前创建</em></li>\n<li><em>需要创建对应 namespace 的 Harbor 认证 Secrets -&gt;harbor-admin</em></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.125</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/ops/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/ops/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/ops/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/ops/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://gitee.com/chinagei/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          checkout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$class</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'GitSCM'</span>, branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"196\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"213\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"214\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"218\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"247\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>                <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>                <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--registry</span><span class=\"token operator\">=</span>https://registry.npmmirror.com <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>                <span class=\"token function\">npm</span> run build:prod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> ./dist/*</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>     //代码编译stage end\t</pre></td></tr><tr><td data-num=\"261\"></td><td><pre> </pre></td></tr><tr><td data-num=\"262\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"265\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"271\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"273\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"275\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"293\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"298\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"312\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"314\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"316\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"318\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"319\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Auth镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"331\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"333\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"335\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"337\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"339\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"340\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"354\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"356\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"358\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"360\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"361\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建UI镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"375\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"379\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"381\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"382\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"387\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end\t</pre></td></tr><tr><td data-num=\"388\"></td><td><pre></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署微服务至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Gateway'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"397\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"402\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"405\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"406\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"408\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"409\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Auth'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"421\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"422\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"428\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"429\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"431\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"432\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre></pre></td></tr><tr><td data-num=\"437\"></td><td><pre></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付System'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre></pre></td></tr><tr><td data-num=\"448\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"449\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"452\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"453\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"455\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"456\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Monitor'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"476\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"477\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"478\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"480\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"481\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付UI'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre></pre></td></tr><tr><td data-num=\"497\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"498\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"499\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"500\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"501\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"502\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"503\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"505\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"506\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>     //parallel end</pre></td></tr><tr><td data-num=\"511\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>      //stage\t</pre></td></tr><tr><td data-num=\"512\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"513\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>   //stages end</pre></td></tr><tr><td data-num=\"514\"></td><td><pre><span class=\"token punctuation\">&#125;</span>   //pipeline end</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/UdGhuXh.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Xn9xtXw.png\" alt=\"2.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Txnv0rV.png\" alt=\"3.png\" /></p>\n<h5 id=\"28-选择制定微服组件部署\"><a class=\"anchor\" href=\"#28-选择制定微服组件部署\">#</a> 2.8 选择制定微服组件部署</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1ykGODn.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/him0Lh5.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/05mUGAZ.png\" alt=\"7.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/R5qx6jh.png\" alt=\"6.png\" /></p>\n<p><em>选择指定微服务进行部署（Deploy_UI == &quot;true&quot; 或者 Deploy_All == &quot;true&quot;）</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.125</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/ops/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/ops/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/ops/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/ops/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"https://gitee.com/chinagei/ruoyi-cloud-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          checkout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$class</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'GitSCM'</span>, branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_UI <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end\t</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"178\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"179\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"180\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"194\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"195\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"211\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"212\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"220\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"221\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"237\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span>/target/*</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"250\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_UI <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>                <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"262\"></td><td><pre>                <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--registry</span><span class=\"token operator\">=</span>https://registry.npmmirror.com <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>                <span class=\"token function\">npm</span> run build:prod <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>\t\t\t\t<span class=\"token builtin class-name\">pwd</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">ls</span> <span class=\"token parameter variable\">-l</span> ./dist/*</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"266\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"270\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>     //代码编译stage end\t</pre></td></tr><tr><td data-num=\"271\"></td><td><pre> </pre></td></tr><tr><td data-num=\"272\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"277\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"280\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"281\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"283\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"285\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"292\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"295\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"302\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"304\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"306\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"309\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"310\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"311\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"315\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"316\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"317\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"324\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"327\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"329\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"331\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Auth镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"346\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"348\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"349\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"350\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"351\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"353\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"356\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"370\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"371\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"372\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"373\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"374\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"375\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"377\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"378\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建UI镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_UI <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"390\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"392\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"393\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"394\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"395\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"396\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"397\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"399\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"400\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"402\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end\t</pre></td></tr><tr><td data-num=\"403\"></td><td><pre></pre></td></tr><tr><td data-num=\"404\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署微服务至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Gateway'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"415\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre></pre></td></tr><tr><td data-num=\"417\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"418\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"419\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"422\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"424\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Auth'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"437\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"439\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre></pre></td></tr><tr><td data-num=\"441\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"442\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"443\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"444\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"445\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"446\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"448\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"449\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"450\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"452\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"453\"></td><td><pre></pre></td></tr><tr><td data-num=\"454\"></td><td><pre></pre></td></tr><tr><td data-num=\"455\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付System'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>\t\t  when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"467\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"470\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"471\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"474\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"476\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Monitor'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"481\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"492\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"495\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"496\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"497\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"498\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"499\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"500\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付UI'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>Deploy_UI <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"507\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"515\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"516\"></td><td><pre></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"519\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"520\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#test#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"521\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"522\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>\t\t\t\t\t<span class=\"token function\">cat</span> deploy.yaml <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"524\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"525\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"526\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"527\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"528\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"529\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"530\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>     //parallel end</pre></td></tr><tr><td data-num=\"531\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>      //stage\t\t</pre></td></tr><tr><td data-num=\"532\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"533\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span>   //stages end</pre></td></tr><tr><td data-num=\"534\"></td><td><pre><span class=\"token punctuation\">&#125;</span>   //pipeline end</pre></td></tr></table></figure><h5 id=\"29-配置自动触发构建\"><a class=\"anchor\" href=\"#29-配置自动触发构建\">#</a> 2.9 配置自动触发构建</h5>\n<p>Jenkins 配置：</p>\n<p><em>#Gitee 配置参考连接 https://blog.csdn.net/hali90s/article/details/126991514</em></p>\n<p><em>#Gitlab 配置参考连接 https://blog.csdn.net/LlZzSss/article/details/123595996</em></p>\n<p>1、安装插件：Gitee</p>\n<p>2、配置 -&gt; 构建触发器 -&gt;Gitee webhook 触发构建</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/5xNDyZl.png\" alt=\"1.png\" /></p>\n<p>Gitee 配置：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Ha9N0Eh.png\" alt=\"2.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>//交付微服务的CI流水线</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              server: <span class=\"token number\">10.0</span>.0.206</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              path: /data/maven</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            image: harbor.oldxu.net/ops/maven:3.8.6</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            image: harbor.oldxu.net/ops/nodejs:14.20</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            image: harbor.oldxu.net/ops/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            image: harbor.oldxu.net/ops/docker:20.10</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            image: harbor.oldxu.net/ops/kubectl:1.22.3</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  //参数化构建  Deploy_All</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  parameters <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    choice choices: <span class=\"token punctuation\">[</span><span class=\"token string\">'false'</span>, <span class=\"token string\">'true'</span><span class=\"token punctuation\">]</span>, description: <span class=\"token string\">'是否部署所有的微服务'</span>, name: <span class=\"token string\">'Deploy_All'</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    Gitlab_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    Gitlab_Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.oldxu.net/root/ruo-yi-cloud.git\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    //Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor.oldxu.net\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"base\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    //对外暴露的域名</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    Ingress_Host <span class=\"token operator\">=</span> <span class=\"token string\">\"spring-dev.oldxu.net\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          checkout<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token variable\">$class</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">'GitSCM'</span>, branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/k8s'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Gitlab_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Gitlab_Pro&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查变动的模块名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'<span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>                <span class=\"token comment\"># 定义微服务模块名称</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>                <span class=\"token assign-left variable\">Init_Module</span><span class=\"token operator\">=</span><span class=\"token punctuation\">(</span>ruoyi-gateway ruoyi-auth ruoyi-system ruoyi-monitor ruoyi-ui<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>                <span class=\"token comment\"># 变动的模块</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>                <span class=\"token assign-left variable\">Change_Module</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">git</span> <span class=\"token function\">diff</span> --name-only <span class=\"token punctuation\">$(</span>git log <span class=\"token parameter variable\">-n2</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">\"%h\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span><span class=\"token function\">cut</span> <span class=\"token parameter variable\">-d</span> / -f1,2<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>                <span class=\"token comment\"># 外循环 &#123;提取变动的模块名称&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>                <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">Change</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;Change_Module&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>                  <span class=\"token comment\"># echo \"改变的微服务模块是: $Change\"</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>                  <span class=\"token comment\"># 内循环</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>                  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">init</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;Init_Module<span class=\"token punctuation\">[</span>@<span class=\"token punctuation\">]</span>&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>                  <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>                    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Change&#125;</span>\"</span> <span class=\"token operator\">=~</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;init&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>                      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;init&#125;</span>=ok\"</span> <span class=\"token operator\">>></span> var.txt</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>                    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>                  <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>                <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        //制作自定义变量</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          env.GATEWAY <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"grep 'ruoyi-gateway' var.txt | awk -F '=' '&#123;print \\<span class=\"token variable\">$2</span>&#125;'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          env.AUTH <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"grep 'ruoyi-auth' var.txt | awk -F '=' '&#123;print \\<span class=\"token variable\">$2</span>&#125;'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>          env.SYSTEM <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"grep 'ruoyi-system' var.txt | awk -F '=' '&#123;print \\<span class=\"token variable\">$2</span>&#125;'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          env.MONITOR <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"grep 'ruoyi-monitor' var.txt | awk -F '=' '&#123;print \\<span class=\"token variable\">$2</span>&#125;'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          env.UI <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"grep 'ruoyi-ui' var.txt | awk -F '=' '&#123;print \\<span class=\"token variable\">$2</span>&#125;'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出更新的模块状态'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"gateway: $&#123;GATEWAY&#125;\"'</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"auth: $&#123;AUTH&#125;\"'</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"system: $&#123;SYSTEM&#125;\"'</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"monitor: $&#123;MONITOR&#125;\"'</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"ui: $&#123;UI&#125;\"'</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>                    sonar-scanner \\</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>                      -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>                      -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>                      -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"156\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"167\"></td><td><pre></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"169\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"170\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"171\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"172\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"173\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"174\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"176\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"177\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"181\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"182\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"184\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"185\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"186\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"187\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"188\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"190\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"191\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"192\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"193\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"197\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"198\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"200\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"201\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"202\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"203\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>UI <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"204\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"205\"></td><td><pre>            <span class=\"token assign-left variable\">AppName</span><span class=\"token operator\">=</span><span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"206\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"207\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"208\"></td><td><pre>            withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"209\"></td><td><pre>              container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"210\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; \\</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>                      sonar-scanner \\</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>                        -Dsonar.projectKey=$&#123;AppName&#125; \\</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>                        -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>                        -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"215\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"216\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"217\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"219\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>       //parallel end</pre></td></tr><tr><td data-num=\"220\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>        //stage end</pre></td></tr><tr><td data-num=\"221\"></td><td><pre></pre></td></tr><tr><td data-num=\"222\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查漏洞扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"223\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"224\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"226\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"227\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"228\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"229\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube 代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"230\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"231\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"232\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"233\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"234\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"236\"></td><td><pre></pre></td></tr><tr><td data-num=\"237\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"238\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"239\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Gateway'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"240\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"241\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"242\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"243\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"244\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"245\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"246\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"248\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span></pre></td></tr><tr><td data-num=\"249\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"251\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"252\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"253\"></td><td><pre></pre></td></tr><tr><td data-num=\"254\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Auth'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"255\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"256\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"257\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"258\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"259\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"260\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"261\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"262\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"263\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span></pre></td></tr><tr><td data-num=\"264\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"266\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"267\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"268\"></td><td><pre></pre></td></tr><tr><td data-num=\"269\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译System'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"270\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"271\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"272\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"273\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"274\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"275\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"276\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"277\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"278\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span></pre></td></tr><tr><td data-num=\"279\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"280\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"281\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"282\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"283\"></td><td><pre></pre></td></tr><tr><td data-num=\"284\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译Monitor'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"285\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"286\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"287\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"288\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"289\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"290\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"291\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"292\"></td><td><pre>                <span class=\"token assign-left variable\">Build_Path</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"293\"></td><td><pre>                mvn package <span class=\"token parameter variable\">-Dmaven.test.skip</span><span class=\"token operator\">=</span>true <span class=\"token parameter variable\">-pl</span> <span class=\"token variable\">$&#123;Build_Path&#125;</span> <span class=\"token parameter variable\">-am</span></pre></td></tr><tr><td data-num=\"294\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"296\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"297\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"298\"></td><td><pre></pre></td></tr><tr><td data-num=\"299\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译UI'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"300\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>UI <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"301\"></td><td><pre>          environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"302\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"303\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"304\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"305\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"306\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>                <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"308\"></td><td><pre>                <span class=\"token function\">npm</span> <span class=\"token function\">install</span> <span class=\"token parameter variable\">--registry</span><span class=\"token operator\">=</span>https://registry.npmmirror.com <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"309\"></td><td><pre>                <span class=\"token function\">npm</span> run build:prod</pre></td></tr><tr><td data-num=\"310\"></td><td><pre>              <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"312\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"313\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"314\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>     //代码编译stage end</pre></td></tr><tr><td data-num=\"316\"></td><td><pre></pre></td></tr><tr><td data-num=\"317\"></td><td><pre></pre></td></tr><tr><td data-num=\"318\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"319\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"320\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"321\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"322\"></td><td><pre>            //本次git提交的commid     <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"323\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"324\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"325\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"326\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"327\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"328\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"329\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"330\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"331\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"332\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"333\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"334\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"335\"></td><td><pre></pre></td></tr><tr><td data-num=\"336\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"337\"></td><td><pre></pre></td></tr><tr><td data-num=\"338\"></td><td><pre>      parallel<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"339\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Gateway镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"340\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"341\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"342\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"343\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"344\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"345\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"346\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"347\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"348\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"350\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"352\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"354\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"355\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"356\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"357\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"358\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"359\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre></pre></td></tr><tr><td data-num=\"361\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建System镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"362\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"363\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"364\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"365\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"366\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"368\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"369\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"370\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"371\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"372\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"373\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"374\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"375\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"376\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"378\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"379\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"380\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"381\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"382\"></td><td><pre></pre></td></tr><tr><td data-num=\"383\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Auth镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"384\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"386\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"387\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"388\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"389\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"390\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"391\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"392\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"393\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"395\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"396\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"397\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"398\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"399\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"400\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"401\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"402\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"403\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"404\"></td><td><pre></pre></td></tr><tr><td data-num=\"405\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建Monitor镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"408\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"409\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"410\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"411\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"412\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"413\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"414\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"415\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"416\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"417\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"418\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"419\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"420\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"422\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"423\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"424\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"425\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"426\"></td><td><pre></pre></td></tr><tr><td data-num=\"427\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'构建UI镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"428\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>UI <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"429\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"430\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"431\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"432\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"433\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"434\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"435\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"436\"></td><td><pre>                  //登陆harbor</pre></td></tr><tr><td data-num=\"437\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"438\"></td><td><pre>                  //构建镜像</pre></td></tr><tr><td data-num=\"439\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'cd $(find ./ -type d -name \"$&#123;AppName&#125;\") &amp;&amp; docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"440\"></td><td><pre>                  //推送镜像</pre></td></tr><tr><td data-num=\"441\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"442\"></td><td><pre>                  //删除镜像</pre></td></tr><tr><td data-num=\"443\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"444\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"445\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"446\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"447\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"448\"></td><td><pre></pre></td></tr><tr><td data-num=\"449\"></td><td><pre></pre></td></tr><tr><td data-num=\"450\"></td><td><pre></pre></td></tr><tr><td data-num=\"451\"></td><td><pre></pre></td></tr><tr><td data-num=\"452\"></td><td><pre></pre></td></tr><tr><td data-num=\"453\"></td><td><pre></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>   //parallel end</pre></td></tr><tr><td data-num=\"455\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>   // stage end</pre></td></tr><tr><td data-num=\"456\"></td><td><pre></pre></td></tr><tr><td data-num=\"457\"></td><td><pre></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付微服务至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>      parallel <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"460\"></td><td><pre></pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Gateway'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>GATEWAY <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"463\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"464\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-gateway\"</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"466\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"467\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"469\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"470\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; cp $&#123;KUBECONFIG&#125; ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"471\"></td><td><pre></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"474\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#dev#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"475\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"476\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"477\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"478\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"481\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"482\"></td><td><pre></pre></td></tr><tr><td data-num=\"483\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Auth'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"484\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>AUTH <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"485\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-auth\"</span></pre></td></tr><tr><td data-num=\"487\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"488\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"489\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"490\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"491\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; cp $&#123;KUBECONFIG&#125; ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"495\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"496\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#dev#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"497\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"498\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"499\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"500\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre></pre></td></tr><tr><td data-num=\"505\"></td><td><pre></pre></td></tr><tr><td data-num=\"506\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付System'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>SYSTEM <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"508\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-system\"</span></pre></td></tr><tr><td data-num=\"510\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"511\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"512\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"513\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"514\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"515\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; cp $&#123;KUBECONFIG&#125; ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"516\"></td><td><pre></pre></td></tr><tr><td data-num=\"517\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"519\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#dev#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"520\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"521\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"522\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"524\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"525\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"526\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"527\"></td><td><pre></pre></td></tr><tr><td data-num=\"528\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付Monitor'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"529\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>MONITOR <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"530\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"531\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-monitor\"</span></pre></td></tr><tr><td data-num=\"532\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"533\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"monitor-dev.oldxu.net\"</span></pre></td></tr><tr><td data-num=\"534\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"535\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"536\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"537\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"538\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; cp $&#123;KUBECONFIG&#125; ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"539\"></td><td><pre></pre></td></tr><tr><td data-num=\"540\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"541\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"542\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#dev#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"543\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"544\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"545\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"546\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"547\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"548\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"549\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"550\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"551\"></td><td><pre></pre></td></tr><tr><td data-num=\"552\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付UI'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"553\"></td><td><pre>          when <span class=\"token punctuation\">&#123;</span> expression <span class=\"token punctuation\">&#123;</span>UI <span class=\"token operator\">==</span> <span class=\"token string\">\"ok\"</span> <span class=\"token operator\">||</span> Deploy_All <span class=\"token operator\">==</span> <span class=\"token string\">\"true\"</span> <span class=\"token punctuation\">&#125;</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"554\"></td><td><pre>          environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"555\"></td><td><pre>            AppName <span class=\"token operator\">=</span> <span class=\"token string\">\"ruoyi-ui\"</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>            ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>            IngressHost <span class=\"token operator\">=</span> <span class=\"token string\">\"ui-dev.oldxu.net\"</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>          steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"560\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"561\"></td><td><pre>              withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"562\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; cp $&#123;KUBECONFIG&#125; ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"563\"></td><td><pre></pre></td></tr><tr><td data-num=\"564\"></td><td><pre>                  <span class=\"token function\">sh</span> <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"565\"></td><td><pre>                    <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">find</span> ./ <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;AppName&#125;</span>\"</span><span class=\"token variable\">)</span></span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"566\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;namespace&#125;#dev#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"567\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;image&#125;#<span class=\"token variable\">$&#123;ImageName&#125;</span>:<span class=\"token variable\">$&#123;ImageTag&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"568\"></td><td><pre>                    <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#&#123;host&#125;#<span class=\"token variable\">$&#123;IngressHost&#125;</span>#g\"</span> deploy.yaml</pre></td></tr><tr><td data-num=\"569\"></td><td><pre>                    kubectl apply <span class=\"token parameter variable\">-f</span> deploy.yaml</pre></td></tr><tr><td data-num=\"570\"></td><td><pre>                  <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"571\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"572\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"573\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"574\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"575\"></td><td><pre></pre></td></tr><tr><td data-num=\"576\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span>     //parallel end</pre></td></tr><tr><td data-num=\"577\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"578\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>       //stages end</pre></td></tr><tr><td data-num=\"579\"></td><td><pre><span class=\"token punctuation\">&#125;</span>       //pipeline end</pre></td></tr></table></figure><h4 id=\"三-cd阶段\"><a class=\"anchor\" href=\"#三-cd阶段\">#</a> 三、CD 阶段</h4>\n<p>CD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 生产环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"31-获取完整的镜像名称\"><a class=\"anchor\" href=\"#31-获取完整的镜像名称\">#</a> 3.1 获取完整的镜像名称</h5>\n<p><strong>1、获取 Harbor 镜像 Tag</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -s -uadmin:passwd -H'Content-Type: application/json' -X GET https://s.hmallleasing.com/v2/base/springboot/tags/list | sed -r 's#(\\&#123;.*\\[)(.*)(\\]\\&#125;)#\\2#g' | xargs -d \",\" -n1 | xargs -n1 | sort -t \"_\" -k2 -k3 -nr | head -5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>3e24684_20230326_153018</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>5041fbd_20230326_144343</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>5da8d15_20230326_143533</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>5da8d15_20230326_005207</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>5da8d15_20230326_004940</pre></td></tr></table></figure><p><strong>2、安装插件</strong></p>\n<p>系统管理 -&gt; 插件管理 -&gt;Active Choices</p>\n<p><strong>3、级联变量的方式来提取对应的 tag</strong><br />\n<strong> 变量：Harbor_Url</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;Active Choices Parameter<br />\n 语法：return [&quot;<a href=\"http://s.hmallleasing.com\">s.hmallleasing.com</a>&quot;,&quot;<a href=\"http://harbor.hmallleasing.com\">harbor.hmallleasing.com</a>&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/v6GcFOR.png\" alt=\"3.png\" /></p>\n<p><strong>变量：Harbor_Pro</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Parameter</strong><br />\n 语法：return [&quot;base&quot;,&quot;nf-flms&quot;,&quot;ops&quot;,&quot;xx&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/69Tn5km.png\" alt=\"4.png\" /></p>\n<p><strong>变量：Image_Name</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Parameter</strong><br />\n 语法：return [&quot;springboot&quot;,&quot;nf-flms-statistics&quot;,&quot;nf-flms-order&quot;,&quot;xx&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SUPMpYt.png\" alt=\"5.png\" /></p>\n<p><strong>级联变量：Image_Tag</strong></p>\n<p>项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Reactive Parameter</strong><br />\n 语法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>def get_tag <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"bash\"</span>, <span class=\"token string\">\"-c\"</span>, <span class=\"token string\">\"curl -s -uadmin:passwd -H 'Content-Type: application/json' -X GET https://<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/v2/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>/tags/list | sed -r 's#(<span class=\"token entity\" title=\"\\\\\">\\\\</span>&#123;.*<span class=\"token entity\" title=\"\\\\\">\\\\</span>[)(.*)(<span class=\"token entity\" title=\"\\\\\">\\\\</span>]<span class=\"token entity\" title=\"\\\\\">\\\\</span>&#125;)#<span class=\"token entity\" title=\"\\\\\">\\\\</span>2#g' | xargs -d ',' -n1 | xargs -n1 | sort -t '_' -k2 -k3 -nr | head -5\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">return</span> get_tag.execute<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.text.tokenize<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/DaQaZIj.png\" alt=\"6.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/LLZVKMU.png\" alt=\"7.png\" /></p>\n<p><em>#级联变量：Harbor_Url+Harbor_Pro+Image_Name</em></p>\n<p><strong>4、编写 pipeline 输出完整的镜像名称</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/EMv60kM.png\" alt=\"8.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2fQ2N58.png\" alt=\"9.png\" /></p>\n<h5 id=\"32-生产环境中部署对应至k8s\"><a class=\"anchor\" href=\"#32-生产环境中部署对应至k8s\">#</a> 3.2 生产环境中部署对应至 K8S</h5>\n<p>1、编写 yaml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-prod.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: springboot</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod\t\t\t<span class=\"token comment\">#修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: spring</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: spring</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: springboot</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: s.hmallleasing.com/base/springboot:5da8d15_20230326_004659\t\t\t<span class=\"token comment\"># 修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        env:            <span class=\"token comment\"># 传递初始堆内存和最大堆内存占用</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: XMS_OPTS</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              resource: requests.memory</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: XMX_OPTS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              resource: limits.memory</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            memory: 150Mi</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            memory: 300Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针；如果端口不存活，则从负载均衡中移除</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            port: http          <span class=\"token comment\"># http 是一个名字；它会获取这个名字对应的端口；</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针；获取 url，状态码不对那么则触发重启操作</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            path: /</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port: http</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  name: spring-svc</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    app: spring</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  name: springboot-ingress</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  - host: <span class=\"token string\">\"spring-prod.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            name: spring-svc</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr></table></figure><p>2、部署应用</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=s.hmallleasing.com --docker-username=admin --docker-password=Talent*19871988 -n prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f deploy-prod.yaml</span></pre></td></tr></table></figure><h5 id=\"33-cd流水线部署指定tag版本到k8s生产环境\"><a class=\"anchor\" href=\"#33-cd流水线部署指定tag版本到k8s生产环境\">#</a> 3.3 CD 流水线部署指定 Tag 版本到 K8S 生产环境</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/$&#123;Image_Name&#125; $&#123;Image_Name&#125;=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/QOVlKDx.png\" alt=\"11.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3nX25m2.png\" alt=\"12.png\" /></p>\n<h5 id=\"34-询问是否需要回退\"><a class=\"anchor\" href=\"#34-询问是否需要回退\">#</a> 3.4 询问是否需要回退</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/$&#123;Image_Name&#125; $&#123;Image_Name&#125;=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'快速回滚'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                timeout<span class=\"token punctuation\">(</span>time:1 , unit: <span class=\"token string\">'HOURS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                  def UserInput <span class=\"token operator\">=</span> input message: <span class=\"token string\">'是否回退至上一个版本'</span>, parameters: <span class=\"token punctuation\">[</span>choice<span class=\"token punctuation\">(</span>choices: <span class=\"token punctuation\">[</span><span class=\"token string\">'No'</span>, <span class=\"token string\">'Yes'</span><span class=\"token punctuation\">]</span>, name: <span class=\"token string\">'rollback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>UserInput <span class=\"token operator\">==</span> <span class=\"token string\">\"Yes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl rollout undo deployment $&#123;Image_Name&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span>else <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"没有选择回退\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bRrABoC.png\" alt=\"13.png\" /></p>\n<p>#如果选择 “Yes” 继续，则回退至上一个版本，等待时间为 1 小时</p>\n<p>#如果选择 “No” 继续，则不回退至上一个版本</p>\n<p>#如果没有选择，则不回退至上一个版本</p>\n",
            "tags": [
                "DevOps"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1366748664.html",
            "url": "http://ixuyong.cn/posts/1366748664.html",
            "title": "K8S基于Jenkins实现Java项目CI与CD实践（二）",
            "date_published": "2025-06-17T13:57:00.000Z",
            "content_html": "<h3 id=\"k8s基于jenkins实现java项目ci与cd实践二\"><a class=\"anchor\" href=\"#k8s基于jenkins实现java项目ci与cd实践二\">#</a> K8S 基于 Jenkins 实现 Java 项目 CI 与 CD 实践（二）</h3>\n<p>CI 阶段：开发人员 -&gt; 提交代码 -&gt;Gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 -&gt; 构建镜像 -&gt; 推送 Harbor-&gt; 部署应用至 K8S 测试环境；<br />\nCD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 生产环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"一-提交代码\"><a class=\"anchor\" href=\"#一-提交代码\">#</a> 一、提交代码</h4>\n<p>准备好 Java 代码、Dockerfile、deploy.yaml 资源清单文件  提交到 Gitlab 服务器；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.name <span class=\"token string\">\"xuyong\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ <span class=\"token function\">git</span> config <span class=\"token parameter variable\">--global</span> user.email <span class=\"token string\">\"373370405@qq.com\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ <span class=\"token function\">git</span> init</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ <span class=\"token function\">git</span> <span class=\"token function\">add</span> <span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ <span class=\"token function\">git</span> commit <span class=\"token parameter variable\">-m</span> <span class=\"token string\">\"first commit\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>$ <span class=\"token function\">git</span> remote remove origin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>$ <span class=\"token function\">git</span> remote <span class=\"token function\">add</span> origin http://gitlab.hmallleasing.com/root/springboot-cicd.git</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ <span class=\"token function\">git</span> push <span class=\"token parameter variable\">-u</span> origin <span class=\"token string\">\"master\"</span></pre></td></tr></table></figure><h4 id=\"二-ci阶段\"><a class=\"anchor\" href=\"#二-ci阶段\">#</a> 二、CI 阶段</h4>\n<p>CI 阶段分为以下 6 步：<br />\n1、获取代码<br />\n 2、漏洞扫描<br />\n 3、检测漏洞扫描结果，如果正常则继续、否则就终止<br />\n 4、使用 maven 进行编译，打包<br />\n 5、制作 Docker 镜像、推送到 Harbor 仓库  (Dockerfile 文件)<br />\n 6、交付应用到 K8S</p>\n<h5 id=\"21-编写pipeline框架\"><a class=\"anchor\" href=\"#21-编写pipeline框架\">#</a> 2.1 编写 Pipeline 框架</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"获取代码\"'</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A7fPIQd.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-获取代码\"><a class=\"anchor\" href=\"#22-获取代码\">#</a> 2.2 获取代码</h5>\n<p><strong>1、Jenkins 上配置 Gitlab 认证信息</strong></p>\n<p>系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Dhao75j.png\" alt=\"2.png\" /></p>\n<p><strong>2、SlavePod 访问 gitlab</strong></p>\n<p>通过 Coredns 配置自定义域名解析，如果 gitlab 解析至公网，无需配置此步骤；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm coredns -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping gitlab.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING gitlab.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.381</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.203</span> ms</pre></td></tr></table></figure><p><strong>3、生成流水线脚本获取代码</strong></p>\n<p>通过流水线语法 -&gt; 片段生成器 -&gt; 生成流水线脚本，生成 Pipeline 流水线</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/O2hXRRW.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8txbe6d.png\" alt=\"2.png\" /></p>\n<p><strong>3、测试获取代码 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码扫描\"'</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/psokxwc.png\" alt=\"3.png\" /></p>\n<h5 id=\"23-sonarqube漏洞扫描\"><a class=\"anchor\" href=\"#23-sonarqube漏洞扫描\">#</a> 2.3 Sonarqube 漏洞扫描</h5>\n<p><strong>1、配置 dns 解析（如果 sonarqube 解析至公网，无需配置此步骤）</strong><br />\nslavePod 需要访问 sonarqube 服务端，sonarqube 服务端需要回调 jenkins，获取扫描结果 。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping sonar.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING sonar.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.187</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping jenkins.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>PING jenkins.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.74<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.189</span> ms</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.74: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.202</span> ms</pre></td></tr></table></figure><p><strong>2、Jenkins 集成 Sonarqube</strong></p>\n<p>生成 sonarqube 令牌：用户 -&gt; 我的账号 -&gt; 安全</p>\n<p><em>保存令牌信息：squ_6e57e496a22ebdf0723c3683bd489df57f967f49</em></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WIPhwiL.png\" alt=\"1.png\" /></p>\n<p>配置 sonarqube 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6hyCvFt.png\" alt=\"1.png\" /></p>\n<p>Jenkins 集成 Sonarqube：系统管理 -&gt; 系统配置 -&gt;SonarQube servers-&gt;Add SonarQube</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TDCKExZ.png\" alt=\"2.png\" /></p>\n<p><strong>3、获取 sonar-scanner 扫描命令（此步骤不用执行）</strong></p>\n<p>项目 -&gt; 手工 -&gt; 显示名</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6xdkGGq.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WV443AU.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/kgfxuOS.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bahZPtg.png\" alt=\"6.png\" /></p>\n<p><em>#获取 sonar-scanner 扫描命令，需要在项目目录下进行扫描</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>sonar-scanner <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.projectKey</span><span class=\"token operator\">=</span>springboot <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.sources</span><span class=\"token operator\">=</span>. <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.host.url</span><span class=\"token operator\">=</span>http://sonar.hmallleasing.com <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token parameter variable\">-Dsonar.login</span><span class=\"token operator\">=</span>squ_6e57e496a22ebdf0723c3683bd489df57f967f49</pre></td></tr></table></figure><p><strong>4、测试代码扫描 Pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>   //jenkins集成sonarqube名称sonar-k8s</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'sonar-scanner \\</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                  -Dsonar.projectKey=springboot-cicd \\</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                  -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                  -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Code Result Check\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t    </pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2jIMhwU.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gEwDNX4.png\" alt=\"2.png\" /></p>\n<h5 id=\"24-检查扫描结果\"><a class=\"anchor\" href=\"#24-检查扫描结果\">#</a> 2.4 检查扫描结果</h5>\n<p>1、配置 sonarquber, 让其将检查结果通知 jiekins，如果正常则继续、否则就终止执行</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aU33pHW.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/oufVrcE.png\" alt=\"5.png\" /></p>\n<p>URL：<a href=\"http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook\">http://admin:talent@jenkins.hmallleasing.com/sonarqube-webhook</a><br />\nJenkins 访问地址：<a href=\"http://jenkins.hamlllleasing.com\">jenkins.hamlllleasing.com</a><br />\nJenkins 用户名：admin<br />\nJenkins 密码：talent</p>\n<p><strong>2、检查扫描结果 pipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>   //jenkins集成sonarqube名称sonar-k8s</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'sonar-scanner \\</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                  -Dsonar.projectKey=springboot-cicd \\</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                  -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                  -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码编译'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"代码编译\"'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t    </pre></td></tr><tr><td data-num=\"104\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hbERBmv.png\" alt=\"6.png\" /></p>\n<h5 id=\"25-代码编译\"><a class=\"anchor\" href=\"#25-代码编译\">#</a> 2.5 代码编译</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>   //jenkins集成sonarqube名称sonar-k8s</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'sonar-scanner \\</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                  -Dsonar.projectKey=springboot-cicd \\</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                  -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>                  -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t </pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译代码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l target/*'</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"制作Docker镜像\"'</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iv0lmND.png\" alt=\"1.png\" /></p>\n<h5 id=\"26-制作docker镜像\"><a class=\"anchor\" href=\"#26-制作docker镜像\">#</a> 2.6 制作 Docker 镜像</h5>\n<p>制作 Docker 镜像、推送到 Harbor 仓库，根据 Dockerfile 文件生成 Docker 镜像</p>\n<p><strong>1、配置 dns 解析（如果 harbor 解析至公网，无需配置此步骤）</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit cm -n kube-system coredns</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        ready</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        hosts <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 gitlab.hmallleasing.com        <span class=\"token comment\">#gitalb</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 sonar.hmallleasing.com         <span class=\"token comment\">#sonar</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.74 jenkins.hmallleasing.com       <span class=\"token comment\">#jenkins</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>           <span class=\"token number\">192.168</span>.1.68 s.hmallleasing.com             <span class=\"token comment\">#harbor</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>           fallthrough</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        kubernetes cluster.local in-addr.arpa ip6.arpa <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>测试解析是否生效；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it gitlab-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@gitlab-0:/<span class=\"token comment\"># ping s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING s.hmallleasing.com <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.68<span class=\"token punctuation\">)</span>: <span class=\"token number\">56</span> data bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">0</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.257</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.68: <span class=\"token assign-left variable\">seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">63</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.198</span> ms</pre></td></tr></table></figure><p><strong>2、配置 harbor 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</strong></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/eW8zQLR.png\" alt=\"2.png\" /></p>\n<p>3、代码扫描 Pipeline</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t//Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"base\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/springboot\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>   //jenkins集成sonarqube名称sonar-k8s</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'sonar-scanner \\</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>                  -Dsonar.projectKey=springboot-cicd \\</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>                  -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>                  -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t </pre></td></tr><tr><td data-num=\"103\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译代码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l target/*'</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            //本次git提交的commid  <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>              //登陆harbor</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>              //构建镜像</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre>              //推送镜像</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>              //删除镜像</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"142\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"144\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"145\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"交付应用至K8S\"'</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Zu1zCdk.png\" alt=\"3.png\" /></p>\n<h5 id=\"27-交付应用到k8s\"><a class=\"anchor\" href=\"#27-交付应用到k8s\">#</a> 2.7 交付应用到 K8S</h5>\n<p><strong>1、将 K8S 的 kubeconfig 文件下载至本地，配置 Jenkins，将 config 文件制作为一个 Scretfile；</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /root/.kube/config</span></pre></td></tr></table></figure><p>配置 k8s 认证信息：系统管理 -&gt;manage credentials-&gt; 全局 -&gt;Add Credential</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9AysMkZ.png\" alt=\"1.png\" /></p>\n<p><strong>2、编写 pipeline 流水线</strong></p>\n<p>在 Stage 中引用这个 config 文件，就可以操作对应的集群，部署前需做以下操作；</p>\n<ul>\n<li><em>部署的名称空间需要提前创建</em></li>\n<li><em>需要创建对应 namespace 的 Harbor 认证 Secrets -&gt;harbor-admin</em></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns dev</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=s.hmallleasing.com --docker-username=admin --docker-password=passwd -n dev</span></pre></td></tr></table></figure><p><strong>3、编写 yaml 文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: springboot</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: <span class=\"token punctuation\">&#123;</span>NameSpace<span class=\"token punctuation\">&#125;</span>\t\t\t<span class=\"token comment\">#修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      app: spring</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        app: spring</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: springboot</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        image: <span class=\"token punctuation\">&#123;</span>Image<span class=\"token punctuation\">&#125;</span>\t\t\t<span class=\"token comment\"># 修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        env:            <span class=\"token comment\"># 传递初始堆内存和最大堆内存占用</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - name: XMS_OPTS</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              resource: requests.memory</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        - name: XMX_OPTS</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              resource: limits.memory</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            memory: 150Mi</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            memory: 300Mi</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针；如果端口不存活，则从负载均衡中移除</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            port: http          <span class=\"token comment\"># http 是一个名字；它会获取这个名字对应的端口；</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针；获取 url，状态码不对那么则触发重启操作</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            path: /</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            port: http</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  name: spring-svc</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  namespace: <span class=\"token punctuation\">&#123;</span>namespace<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    app: spring</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  name: springboot-ingress</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  namespace: <span class=\"token punctuation\">&#123;</span>namespace<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  - host: <span class=\"token string\">\"&#123;host&#125;\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            name: spring-svc</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr></table></figure><p><strong>4、编写交付 K8spipeline</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  environment<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>    //定义git变量</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    Git_Id <span class=\"token operator\">=</span> <span class=\"token string\">\"gitlab-root-token\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    Git_Url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://gitlab.hmallleasing.com/root/springboot-cicd.git\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t//Harbor相关的全局变量</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    Url <span class=\"token operator\">=</span> <span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    Pro <span class=\"token operator\">=</span> <span class=\"token string\">\"base\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    ImageName <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Url&#125;</span>/<span class=\"token variable\">$&#123;Pro&#125;</span>/springboot\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    HARBOR_ID <span class=\"token operator\">=</span> <span class=\"token string\">\"harbor-auth\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t//对外暴露的域名</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    Ingress_Host <span class=\"token operator\">=</span> <span class=\"token string\">\"spring-dev.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'获取代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t  checkout scmGit<span class=\"token punctuation\">(</span>branches: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>name: <span class=\"token string\">'*/master'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span>, extensions: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>, userRemoteConfigs: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Id&#125;</span>\"</span>, url: <span class=\"token string\">\"<span class=\"token variable\">$&#123;Git_Url&#125;</span>\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls'</span> \t\t  </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'代码扫描'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        withSonarQubeEnv<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar-k8s'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span>   //jenkins集成sonarqube名称sonar-k8s</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            <span class=\"token function\">sh</span> <span class=\"token string\">'sonar-scanner \\</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>                  -Dsonar.projectKey=springboot-cicd \\</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>                  -Dsonar.java.binaries=src \\</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>                  -Dsonar.sources=.'</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检查扫描结果'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'sonar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            timeout<span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              def qg <span class=\"token operator\">=</span> waitForQualityGate<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>qg.status <span class=\"token operator\">!=</span> <span class=\"token string\">'OK'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>                error <span class=\"token string\">\"Sonarqube代码检查失败, error的原因 <span class=\"token variable\">$&#123;qg.status&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t </pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译代码'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l'</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'mvn package -Dmaven.test.skip=true'</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'pwd &amp;&amp; ls -l target/*'</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'生成镜像Tag'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"117\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>          script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"119\"></td><td><pre>            //本次git提交的commid  <span class=\"token punctuation\">(</span>git log <span class=\"token parameter variable\">-n1</span> <span class=\"token parameter variable\">--pretty</span><span class=\"token operator\">=</span>format:<span class=\"token string\">'%h'</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>            env.COMMITID <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"git log -n1 --pretty=format:'%h'\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"121\"></td><td><pre>            //构建的时间   <span class=\"token punctuation\">(</span>date +%Y%m%d_%H%M%S<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            env.BuildTime <span class=\"token operator\">=</span> sh<span class=\"token punctuation\">(</span>returnStdout: true, script: <span class=\"token string\">\"date +%Y%m%d_%H%M%S\"</span><span class=\"token punctuation\">)</span>.trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>            </pre></td></tr><tr><td data-num=\"124\"></td><td><pre>            //完整的镜像Tag   <span class=\"token punctuation\">(</span>c106654_20221115_133911<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>            env.ImageTag <span class=\"token operator\">=</span> COMMITID + <span class=\"token string\">\"_\"</span> +  BuildTime</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"128\"></td><td><pre>          <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"镜像的Tag: $&#123;ImageTag&#125;\"'</span></pre></td></tr><tr><td data-num=\"129\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作Docker镜像'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>usernamePassword<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">\"<span class=\"token variable\">$&#123;HARBOR_ID&#125;</span>\"</span>, passwordVariable: <span class=\"token string\">'HARBOR_PASSWORD'</span>, usernameVariable: <span class=\"token string\">'HARBOR_USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>              //登陆harbor</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"$&#123;HARBOR_PASSWORD&#125;\" | docker login $&#123;Url&#125; -u \"$&#123;HARBOR_USER&#125;\" --password-stdin'</span></pre></td></tr><tr><td data-num=\"138\"></td><td><pre></pre></td></tr><tr><td data-num=\"139\"></td><td><pre>              //构建镜像</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker build -t $&#123;ImageName&#125;:$&#123;ImageTag&#125; .'</span></pre></td></tr><tr><td data-num=\"141\"></td><td><pre>              //推送镜像</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker push $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span></pre></td></tr><tr><td data-num=\"143\"></td><td><pre>              //删除镜像</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'docker rmi $&#123;ImageName&#125;:$&#123;ImageTag&#125;'</span> </pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"147\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"148\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"149\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'交付应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"150\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p /root/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >/root/.kube/config'</span></pre></td></tr><tr><td data-num=\"154\"></td><td><pre></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>              //替换depoy.yaml中<span class=\"token punctuation\">&#123;</span>namespace<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>Image<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">&#123;</span>host<span class=\"token punctuation\">&#125;</span> </pre></td></tr><tr><td data-num=\"156\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cat deploy.yaml'</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'sed -i \"s#&#123;namespace&#125;#dev#g\" deploy.yaml'</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'sed -i \"s#&#123;Image&#125;#$&#123;ImageName&#125;:$&#123;ImageTag&#125;#g\" deploy.yaml'</span></pre></td></tr><tr><td data-num=\"159\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'sed -i \"s#&#123;host&#125;#$&#123;Ingress_Host&#125;#g\" deploy.yaml'</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'cat deploy.yaml'</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl apply -f deploy.yaml'</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"164\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"165\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"166\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/CtUFtcP.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1F41fQQ.png\" alt=\"2.png\" /></p>\n<h5 id=\"28-配置自动触发构建\"><a class=\"anchor\" href=\"#28-配置自动触发构建\">#</a> 2.8 配置自动触发构建</h5>\n<p><strong>Jenkins 配置：</strong></p>\n<p>#Gitee 配置参考连接 https://blog.csdn.net/hali90s/article/details/126991514</p>\n<p>#Gitlab 配置参考连接 https://blog.csdn.net/weixin_58423196/article/details/146407508</p>\n<p>1、安装插件：<a href=\"https://so.csdn.net/so/search?q=GitLab&amp;spm=1001.2101.3001.7020\">GitLab</a> Plugin</p>\n<p>2、配置 -&gt;Triggers</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1Chji1c.png\" alt=\"1.png\" /></p>\n<p>点击右下角的 &quot;Advanced&quot;，进入触发器的高级配置，在 &quot;Allowed branched&quot; 部分按需选择 webhook 作用于哪些分支，然后点击 &quot;Generate&quot; 生成唯一的 secret token。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/YbtVvMh.png\" alt=\"2.png\" /></p>\n<p><strong>Gitlab 配置：</strong></p>\n<p>1、设置 -&gt; 网络 -&gt; 外部请求 -&gt; 允许 Webhook 和服务对本地网络的请求</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/jlcu5UF.png\" alt=\"4.png\" /></p>\n<p>1、Gitlab 点击对应项目 -&gt; 设置 -&gt;Webhooks</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/odZ46yy.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/UEqybx9.png\" alt=\"6.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KBeFU1v.png\" alt=\"1.png\" /></p>\n<h4 id=\"三-cd阶段\"><a class=\"anchor\" href=\"#三-cd阶段\">#</a> 三、CD 阶段</h4>\n<p>CD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 生产环境；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"31-获取完整的镜像名称\"><a class=\"anchor\" href=\"#31-获取完整的镜像名称\">#</a> 3.1 获取完整的镜像名称</h5>\n<p><strong>1、获取 Harbor 镜像 Tag</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -s -uadmin:passwd -H'Content-Type: application/json' -X GET https://s.hmallleasing.com/v2/base/springboot/tags/list | sed -r 's#(\\&#123;.*\\[)(.*)(\\]\\&#125;)#\\2#g' | xargs -d \",\" -n1 | xargs -n1 | sort -t \"_\" -k2 -k3 -nr | head -5</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>3e24684_20230326_153018</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>5041fbd_20230326_144343</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>5da8d15_20230326_143533</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>5da8d15_20230326_005207</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>5da8d15_20230326_004940</pre></td></tr></table></figure><p><strong>2、安装插件</strong></p>\n<p>系统管理 -&gt; 插件管理 -&gt;Active Choices</p>\n<p><strong>3、级联变量的方式来提取对应的 tag</strong><br />\n<strong> 变量：Harbor_Url</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;Active Choices Parameter<br />\n 语法：return [&quot;<a href=\"http://s.hmallleasing.com\">s.hmallleasing.com</a>&quot;,&quot;<a href=\"http://harbor.hmallleasing.com\">harbor.hmallleasing.com</a>&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/pTJQ8re.png\" alt=\"2.png\" /></p>\n<p><strong>变量：Harbor_Pro</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Parameter</strong><br />\n 语法：return [&quot;base&quot;,&quot;nf-flms&quot;,&quot;ops&quot;,&quot;xx&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TVJfqv7.png\" alt=\"3.png\" /></p>\n<p><strong>变量：Image_Name</strong><br />\n 项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Parameter</strong><br />\n 语法：return [&quot;springboot&quot;,&quot;nf-flms-statistics&quot;,&quot;nf-flms-order&quot;,&quot;xx&quot;]</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zDHvJft.png\" alt=\"4.png\" /></p>\n<p><strong>级联变量：Image_Tag</strong></p>\n<p>项目 -&gt; 配置 -&gt; 参数化构建 -&gt;<strong>Active Choices Reactive Parameter</strong><br />\n 语法：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>def get_tag <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"bash\"</span>, <span class=\"token string\">\"-c\"</span>, <span class=\"token string\">\"curl -s -uadmin:passwd -H'Content-Type: application/json' -X GET https://s.hmallleasing.com/v2/base/springboot/tags/list | sed -r 's#(<span class=\"token entity\" title=\"\\\\\">\\\\</span>&#123;.*<span class=\"token entity\" title=\"\\\\\">\\\\</span>[)(.*)(<span class=\"token entity\" title=\"\\\\\">\\\\</span>]<span class=\"token entity\" title=\"\\\\\">\\\\</span>&#125;)#<span class=\"token entity\" title=\"\\\\\">\\\\</span>2#g' | xargs -d ',' -n1 | xargs -n1 | sort -t '_' -k2 -k3 -nr | head -5\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">return</span> get_tag.execute<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.text.tokenize<span class=\"token punctuation\">(</span><span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span><span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TnMaVGW.png\" alt=\"1.png\" /></p>\n<p>级联变量：Harbor_Url,Harbor_Pro,Image_Name</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gpzEcvH.png\" alt=\"2.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xwYX0Db.png\" alt=\"5.png\" /></p>\n<p><strong>4、编写 pipeline 输出完整的镜像名称</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KjO5RQx.png\" alt=\"6.png\" /></p>\n<h5 id=\"32-生产环境中部署对应至k8s\"><a class=\"anchor\" href=\"#32-生产环境中部署对应至k8s\">#</a> 3.2 生产环境中部署对应至 K8S</h5>\n<p>1、编写 yaml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-prod.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: springboot</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod\t\t\t<span class=\"token comment\">#修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: spring</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: spring</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: springboot</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: s.hmallleasing.com/base/springboot:f04e3f0_20250611_185645\t\t\t<span class=\"token comment\"># 修改为 &#123;&#125; 特殊字符，后期好替换</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        env:            <span class=\"token comment\"># 传递初始堆内存和最大堆内存占用</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: XMS_OPTS</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              resource: requests.memory</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: XMX_OPTS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            resourceFieldRef:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              resource: limits.memory</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            memory: 150Mi</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            memory: 300Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针；如果端口不存活，则从负载均衡中移除</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            port: http          <span class=\"token comment\"># http 是一个名字；它会获取这个名字对应的端口；</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针；获取 url，状态码不对那么则触发重启操作</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            path: /</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port: http</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  name: spring-svc</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    app: spring</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  name: springboot-ingress</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  - host: <span class=\"token string\">\"spring-prod.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            name: spring-svc</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr></table></figure><p>2、部署应用</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=s.hmallleasing.com --docker-username=admin --docker-password=passwd -n prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f deploy-prod.yaml</span></pre></td></tr></table></figure><h5 id=\"33-cd流水线部署指定tag版本到k8s生产环境\"><a class=\"anchor\" href=\"#33-cd流水线部署指定tag版本到k8s生产环境\">#</a> 3.3 CD 流水线部署指定 Tag 版本到 K8S 生产环境</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/$&#123;Image_Name&#125; $&#123;Image_Name&#125;=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/n1DHjdK.png\" alt=\"7.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/n1DHjdK.png\" alt=\"7.png\" /></p>\n<h5 id=\"34-询问是否需要回退\"><a class=\"anchor\" href=\"#34-询问是否需要回退\">#</a> 3.4 询问是否需要回退</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            image: s.hmallleasing.com/ops/kubectl:1.22.6</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  environment <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      Full_Image <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>:<span class=\"token variable\">$&#123;Image_Tag&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出完整的镜像名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token function\">sh</span> <span class=\"token string\">'echo 镜像名称-tag: $&#123;Full_Image&#125;'</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用至K8S'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl set image deployment/$&#123;Image_Name&#125; $&#123;Image_Name&#125;=$&#123;Full_Image&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'快速回滚'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          withCredentials<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>file<span class=\"token punctuation\">(</span>credentialsId: <span class=\"token string\">'kubeconfig'</span>, variable: <span class=\"token string\">'KUBECONFIG'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                timeout<span class=\"token punctuation\">(</span>time:1 , unit: <span class=\"token string\">'HOURS'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                  def UserInput <span class=\"token operator\">=</span> input message: <span class=\"token string\">'是否回退至上一个版本'</span>, parameters: <span class=\"token punctuation\">[</span>choice<span class=\"token punctuation\">(</span>choices: <span class=\"token punctuation\">[</span><span class=\"token string\">'No'</span>, <span class=\"token string\">'Yes'</span><span class=\"token punctuation\">]</span>, name: <span class=\"token string\">'rollback'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>UserInput <span class=\"token operator\">==</span> <span class=\"token string\">\"Yes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'mkdir -p ~/.kube &amp;&amp; echo $&#123;KUBECONFIG&#125; >> ~/.kube/config'</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>                    <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl rollout undo deployment $&#123;Image_Name&#125; -n prod'</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span>else <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"没有选择回退\"</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>                  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Z6xxgHC.png\" alt=\"9.png\" /></p>\n<p>#如果选择 “Yes” 继续，则回退至上一个版本，等待时间为 1 小时</p>\n<p>#如果选择 “No” 继续，则不回退至上一个版本</p>\n<p>#如果没有选择，则不回退至上一个版本</p>\n",
            "tags": [
                "DevOps"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1208493697.html",
            "url": "http://ixuyong.cn/posts/1208493697.html",
            "title": "K8S基于Jenkins实现SpringCloud微服务CI与CD实践（一）",
            "date_published": "2025-06-16T02:28:16.000Z",
            "content_html": "<h3 id=\"k8s基于jenkins实现springcloud微服务ci与cd实践一\"><a class=\"anchor\" href=\"#k8s基于jenkins实现springcloud微服务ci与cd实践一\">#</a> K8S 基于 Jenkins 实现 SpringCloud 微服务 CI 与 CD 实践（一）</h3>\n<p>CI 阶段：开发人员 -&gt; 提交代码 -&gt;gitlab 仓库 -&gt;Jenkins/CI 抓取代码 -&gt; 漏洞扫描 -&gt; 编译 -&gt; 构建镜像 -&gt; 推送 Harbor-&gt; 部署应用至 K8S 测试环境；</p>\n<p>CD 阶段：Jenkins/CD-&gt; 拉取 Harbor 仓库对应项目镜像 -&gt; 部署应用至 K8S 测试环境</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/reddUL2.jpeg\" alt=\"1.jpg\" /></p>\n<h4 id=\"一-部署harbor\"><a class=\"anchor\" href=\"#一-部署harbor\">#</a> 一、部署 Harbor</h4>\n<h5 id=\"11-安装基础环境\"><a class=\"anchor\" href=\"#11-安装基础环境\">#</a> 1.1 安装基础环境</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum remove docker*</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -o /etc/yum.repos.d/docker-ce.repo  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum list docker-ce --showduplicates |sort -r </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install docker-ce docker-compose -y</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">### 提示：No match for argument: python-pip</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#改成为 Centos 8 已经换成 python3 使用该命令解决 yum install python3-pip</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install python-pip</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#升级</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install --upgrade pip</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># pip3 install docker-compose</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@Harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose -version</span></pre></td></tr></table></figure><h5 id=\"12-配置-docker-加速\"><a class=\"anchor\" href=\"#12-配置-docker-加速\">#</a> 1.2 配置 Docker 加速</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#Docker 加速 1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#Docker 加速 2</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token string\">\"https://hub.littlediary.cn\"</span>,</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token string\">\"https://docker.kejilion.pro\"</span>,</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token string\">\"https://docker.1ms.run\"</span>,</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token string\">\"https://lispy.org\"</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token string\">\"https://docker.xiaogenban1993.com\"</span>,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    <span class=\"token string\">\"https://docker.xuanyuan.me\"</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token string\">\"https://docker.mybacc.com\"</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    <span class=\"token string\">\"https://docker-0.unsee.tech\"</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token string\">\"https://dockerpull.cn\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  <span class=\"token punctuation\">]</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable docker --now</span></pre></td></tr></table></figure><h5 id=\"13-装-harbor\"><a class=\"anchor\" href=\"#13-装-harbor\">#</a> 1.3 装 Harbor</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/goharbor/harbor/releases/download/v2.6.1/harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd harbor</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@Harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp harbor.yml.tmpl harbor.yml</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@Harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat harbor.yml</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>hostname: s.hmallleasing.com</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>http:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\"># port for http, default is 80. If https enabled, this port will redirect to https port</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># https related config</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>https:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token comment\"># https port for harbor, default is 443</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token comment\"># The path of cert and key files for nginx</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  certificate: /soft/harbor/ssl/hmallleasing.com.pem</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  private_key: /soft/harbor/ssl/hmallleasing.com.key</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>harbor_admin_password: Harbor12345</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ./install.sh</span></pre></td></tr></table></figure><h5 id=\"14-配置-nginx-负载均衡调度\"><a class=\"anchor\" href=\"#14-配置-nginx-负载均衡调度\">#</a> 1.4 配置 Nginx 负载均衡调度</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim s.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    server_name harbor.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ssl_certificate  /etc/nginx/sslkey/_.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ssl_certificate_key  /etc/nginx/sslkey/_.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        proxy_pass http://192.168.1.134<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#       include proxy_params;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#       proxy_set_header Host $http_host;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"15-推送镜像至-harbor\"><a class=\"anchor\" href=\"#15-推送镜像至-harbor\">#</a> 1.5 推送镜像至 Harbor</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag beae173ccac6 harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login harbor.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr></table></figure><h5 id=\"16-harbor-停止与启动\"><a class=\"anchor\" href=\"#16-harbor-停止与启动\">#</a> 1.6 Harbor 停止与启动</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#停用 Harbor</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/soft/harbor</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose down</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#启动 Harbor</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose up -d</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose start</span></pre></td></tr></table></figure><h4 id=\"二-部署gitlab\"><a class=\"anchor\" href=\"#二-部署gitlab\">#</a> 二、部署 Gitlab</h4>\n<p>通常 Gitlab 都是在独立服务器进行部署和维护，但为了更好的掌握 Kubernetes，所以本次课程采用资源清单方式将 Gitlab 以</p>\n<p>StatefulSet 方式交付到 Kubernetes 中；</p>\n<p>Gitlab 以容器方式运行，需要持久化如下几个目录中的数据：</p>\n<table>\n<thead>\n<tr>\n<th><strong>持久化本地位置</strong></th>\n<th><strong>容器位置</strong></th>\n<th><strong>使用</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>${pvc}/data</td>\n<td>/var/opt/gitlab</td>\n<td>用于存储应用程序数据</td>\n</tr>\n<tr>\n<td>${pvc}/logs</td>\n<td>/var/log/gitlab</td>\n<td>用于存储日志</td>\n</tr>\n<tr>\n<td>${pvc}/config</td>\n<td>/etc/gitlab</td>\n<td>用于存储 GitLab 配置文件</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"21下载gitlab镜像推送至harbor\"><a class=\"anchor\" href=\"#21下载gitlab镜像推送至harbor\">#</a> 2.1 下载 Gitlab 镜像推送至 Harbor</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull gitlab/gitlab-ce:14.6.0-ce.0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag gitlab/gitlab-ce:14.6.0-ce.0 s.hmallleasing.com/base/gitlab-ce:14.6.0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/gitlab-ce:14.6.0</span></pre></td></tr></table></figure><h5 id=\"22-创建service\"><a class=\"anchor\" href=\"#22-创建service\">#</a> 2.2 创建 Service</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 gitlab<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-gitlab-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: gitlab-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: gitlab</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: https</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">443</span></pre></td></tr></table></figure><h5 id=\"23-创建statefulset\"><a class=\"anchor\" href=\"#23-创建statefulset\">#</a> 2.3 创建 Statefulset</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-gitlab-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: gitlab</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"gitlab-svc\"</span>               <span class=\"token comment\"># 关联的 headlessService</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: gitlab</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: gitlab</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: gitlab-ce</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: s.hmallleasing.com/base/gitlab-ce:14.6.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: GITLAB_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          value: <span class=\"token string\">\"admin123\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: GITLAB_OMNIBUS_CONFIG</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          value: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            external_url <span class=\"token string\">\"http://gitlab.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'time_zone'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            node_exporter<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            redis_exporter<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            postgres_exporter<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            gitlab_exporter<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            grafana<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            grafana<span class=\"token punctuation\">[</span><span class=\"token string\">'reporting_enabled'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            prometheus<span class=\"token punctuation\">[</span><span class=\"token string\">'enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            prometheus<span class=\"token punctuation\">[</span><span class=\"token string\">'monitor_kubernetes'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'gitlab_email_enabled'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'gitlab_email_from'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'373370405@qq.com'</span>  <span class=\"token comment\">#发件邮箱</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'gitlab_email_display_name'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">'Nfzl-Gitlab'</span>  <span class=\"token comment\">#发件人显示名称</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_enable'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_address'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"smtp.qq.com\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_port'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token number\">465</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_user_name'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"373370405@qq.com\"</span>   <span class=\"token comment\">#发件人邮箱账户</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_password'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"pohleicnfawvb\"</span>   <span class=\"token comment\">#发件人邮箱客户端授权码</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_domain'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"smtp.qq.com\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_authentication'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"login\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_enable_starttls_auto'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            gitlab_rails<span class=\"token punctuation\">[</span><span class=\"token string\">'smtp_tls'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: https</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          containerPort: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/gitlab</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          subPath: config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /var/opt/gitlab</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          mountPath: /var/log/gitlab</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  volumeClaimTemplates:         <span class=\"token comment\"># pvc</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          storage: 2Gi</pre></td></tr></table></figure><h5 id=\"24-创建ingress\"><a class=\"anchor\" href=\"#24-创建ingress\">#</a> 2.4 创建 Ingress</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 gitlab<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-gitlab-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: gitlab-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"gitlab.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: gitlab-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              name: http</pre></td></tr></table></figure><h5 id=\"25-更新资源清单\"><a class=\"anchor\" href=\"#25-更新资源清单\">#</a> 2.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 gitlab<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns ops</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 gitlab<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=s.hmallleasing.com --docker-username=admin --docker-password=passwd -n ops</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 gitlab<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h5 id=\"26-访问gitlab\"><a class=\"anchor\" href=\"#26-访问gitlab\">#</a> 2.6 访问 Gitlab</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KX8NiKX.png\" alt=\"PixPin_2025-06-09_14-27-11.png\" /></p>\n<h4 id=\"三-部署sonarqube\"><a class=\"anchor\" href=\"#三-部署sonarqube\">#</a> 三、部署 Sonarqube</h4>\n<p>SonarQube 是一个开源的代码质量管理系统，用于检测代码中的错误、漏洞。它可以与 Jenkins 集成，让我们能自动化进行</p>\n<p>代码质量扫描。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9h7nyjZ.jpeg\" alt=\"1.jpg\" /></p>\n<p><strong>Sonarqube 扫描流程：</strong></p>\n<ol>\n<li>使用 SonarScanner 客户端工具将代码源文件以 http/https 方式推送给 Sonarqube 服务端；</li>\n<li>Sonarqube 服务端基于 ElasticSerach 对代码进行分析，而后将分析结果存储至 Database；</li>\n<li>Sonarqube 服务端读取 Database 数据，然后将扫描结果进行前端展示；</li>\n</ol>\n<p>所以，安装 Sonarqube 之前需要先安装依赖的数据库，后期进行漏洞扫描时还需要借助 SonarScanner 客户端；</p>\n<h5 id=\"31-部署pgsql\"><a class=\"anchor\" href=\"#31-部署pgsql\">#</a> 3.1 部署 Pgsql</h5>\n<h6 id=\"311-下载postgresql镜像推送至harbor\"><a class=\"anchor\" href=\"#311-下载postgresql镜像推送至harbor\">#</a> 3.1.1 下载 postgresql 镜像推送至 Harbor</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull postgres:13.8</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag postgres:13.8 s.hmallleasing.com/base/postgres:13.8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/postgres:13.8</span></pre></td></tr></table></figure><h6 id=\"312-部署pgsql-sts\"><a class=\"anchor\" href=\"#312-部署pgsql-sts\">#</a> 3.1.2 部署 Pgsql-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 sonarqube<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-pgsql-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pgsql-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: pgsql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - port: <span class=\"token number\">5432</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  name: postgresql</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  serviceName: <span class=\"token string\">\"pgsql-svc\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      app: pgsql</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        app: pgsql</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      - name: postgresql</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        image: s.hmallleasing.com/ops/postgres:13.8</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: POSTGRES_DB                   <span class=\"token comment\"># 数据库</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          value: sonardb</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: POSTGRES_USER                 <span class=\"token comment\"># 用户</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          value: sonar</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        - name: POSTGRES_PASSWORD             <span class=\"token comment\"># 密码</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          value: <span class=\"token string\">\"Superman*2023\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        - containerPort: <span class=\"token number\">5432</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        - name: db</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          mountPath: /var/lib/postgresql/data</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  volumeClaimTemplates:         </pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      name: db</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"313-检查postgresql\"><a class=\"anchor\" href=\"#313-检查postgresql\">#</a> 3.1.3 检查 postgresql</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 sonarqube<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it postgresql-0 -n ops -- /bin/bash</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@postgresql-0:/<span class=\"token comment\"># psql -Usonar -d sonardb </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>psql <span class=\"token punctuation\">(</span><span class=\"token number\">13.8</span> <span class=\"token punctuation\">(</span>Debian <span class=\"token number\">13.8</span>-1.pgdg110+1<span class=\"token punctuation\">))</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Type <span class=\"token string\">\"help\"</span> <span class=\"token keyword\">for</span> help.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">sonardb</span><span class=\"token operator\">=</span><span class=\"token comment\"># \\l</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                             List of databases</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   Name    <span class=\"token operator\">|</span> Owner <span class=\"token operator\">|</span> Encoding <span class=\"token operator\">|</span>  Collate   <span class=\"token operator\">|</span>   Ctype    <span class=\"token operator\">|</span> Access privileges </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-----------+-------+----------+------------+------------+-------------------</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> postgres  <span class=\"token operator\">|</span> sonar <span class=\"token operator\">|</span> UTF8     <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre> sonardb   <span class=\"token operator\">|</span> sonar <span class=\"token operator\">|</span> UTF8     <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre> template0 <span class=\"token operator\">|</span> sonar <span class=\"token operator\">|</span> UTF8     <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> <span class=\"token operator\">=</span>c/sonar         +</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>           <span class=\"token operator\">|</span>       <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">sonar</span><span class=\"token operator\">=</span>CTc/sonar</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> template1 <span class=\"token operator\">|</span> sonar <span class=\"token operator\">|</span> UTF8     <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> en_US.utf8 <span class=\"token operator\">|</span> <span class=\"token operator\">=</span>c/sonar         +</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>           <span class=\"token operator\">|</span>       <span class=\"token operator\">|</span>          <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span>            <span class=\"token operator\">|</span> <span class=\"token assign-left variable\">sonar</span><span class=\"token operator\">=</span>CTc/sonar</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">(</span><span class=\"token number\">4</span> rows<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"32-部署sonarqube\"><a class=\"anchor\" href=\"#32-部署sonarqube\">#</a> 3.2 部署 Sonarqube</h5>\n<h6 id=\"321-下载sonarqube镜像推送至harbor\"><a class=\"anchor\" href=\"#321-下载sonarqube镜像推送至harbor\">#</a> 3.2.1 下载 sonarqube 镜像推送至 Harbor</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull sonarqube:9.9.8-community</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag sonarqube:9.9.8-community s.hmallleasing.com/base/sonarqube:9.9.8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/sonarqube:9.9.8</span></pre></td></tr></table></figure><h6 id=\"322-部署sonarqube-sts\"><a class=\"anchor\" href=\"#322-部署sonarqube-sts\">#</a> 3.2.2 部署 Sonarqube-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-sonarqube-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: sonarqube-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: sonarqube</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: web</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">9000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  name: sonarqube</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  serviceName: <span class=\"token string\">\"sonarqube-svc\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      app: sonarqube</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        app: sonarqube</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      initContainers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - name: set-kernel</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>, <span class=\"token string\">\"-c\"</span>, <span class=\"token string\">\"sysctl -w vm.max_map_count=524288 ; sysctl -w fs.file-max=131072 ; ulimit -n 131072 ; ulimit -u 8192\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      - name: sonarqube</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        image: s.hmallleasing.com/base/sonarqube:9.9.8</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        - name: JAVA_OPTS</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          value: <span class=\"token parameter variable\">-Duser.timezone</span><span class=\"token operator\">=</span>Asia/Shanghai</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        - name: SONARQUBE_JDBC_USERNAME               <span class=\"token comment\"># 连接 pgsql 用户名</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          value: sonar</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: SONARQUBE_JDBC_PASSWORD               <span class=\"token comment\"># 连接 pgsql 密码</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          value: <span class=\"token string\">\"admin123\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: SONARQUBE_JDBC_URL                    <span class=\"token comment\"># 连接 pgsql 地址 / 数据库</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          value: jdbc:postgresql://pgsql-svc:5432/sonardb</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            cpu: 1500m</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            memory: 2048Mi</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: web</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          containerPort: <span class=\"token number\">9000</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /opt/sonarqube/data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          mountPath: /opt/sonarqube/logs</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /opt/sonarqube/extensions</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          subPath: extensions</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  volumeClaimTemplates:         </pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          storage: 5G</pre></td></tr></table></figure><h6 id=\"323-创建ingress\"><a class=\"anchor\" href=\"#323-创建ingress\">#</a> 3.2.3 创建 Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 sonarqube<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-sonarqube-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: sonarqube-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"sonar.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: sonarqube-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              name: web</pre></td></tr></table></figure><h6 id=\"324-访问sonarqube\"><a class=\"anchor\" href=\"#324-访问sonarqube\">#</a> 3.2.4 访问 sonarqube</h6>\n<p>通过 http://sonar.hmallleasing.com ，用户名：admin，密码：admin</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/uTo5Uoy.png\" alt=\"1.png\" /></p>\n<p>安装中文插件</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gD2k8u1.png\" alt=\"image-20230322101425876.png\" /></p>\n<h4 id=\"四-部署jenkins\"><a class=\"anchor\" href=\"#四-部署jenkins\">#</a> 四、部署 Jenkins</h4>\n<p>既然是基于 Kubernetes 来实现 CI/CD，那么最好将 Jenkins 以 Pod 的形式运行在 Kubernetes 集群中。其次 Jenkins 没有数</p>\n<p>据库，所有的数据都存储在本地，所以只需要将 Jenkins 的数据目录持久化下来就可以了。</p>\n<h5 id=\"41-下载jenkins镜像\"><a class=\"anchor\" href=\"#41-下载jenkins镜像\">#</a> 4.1 下载 Jenkins 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull jenkins/jenkins:2.504.2-lts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag jenkins/jenkins:2.504.2-lts s.hmallleasing.com/base/jenkins:2.504.2</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login s.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/jenkins:2.504.2</span></pre></td></tr></table></figure><h5 id=\"42-创建rbac\"><a class=\"anchor\" href=\"#42-创建rbac\">#</a> 4.2 创建 RBAC</h5>\n<p>后期 Jenkins 需要创建 Slave Pod 来完成流水线的执行，为此我们需要一些权限。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 jenkins<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-jenkins-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># serviceaccount</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: jenkins</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># clusterRole</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  name: jenkins</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"extensions\"</span>, <span class=\"token string\">\"apps\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"deployments\"</span>, <span class=\"token string\">\"ingresses\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span>, <span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"patch\"</span>, <span class=\"token string\">\"update\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"services\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span>, <span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"patch\"</span>, <span class=\"token string\">\"update\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span>, <span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"patch\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods/exec\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span>, <span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"patch\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"pods/log\"</span>, <span class=\"token string\">\"events\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"secrets\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># clusterrolebinding</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  name: jenkins</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  name: jenkins</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  - kind: ServiceAccount</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    name: jenkins</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    namespace: ops</pre></td></tr></table></figure><h5 id=\"43-创建service\"><a class=\"anchor\" href=\"#43-创建service\">#</a> 4.3 创建 Service</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 jenkins<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-jenkins-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: jenkins-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: jenkins</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    - name: http</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    - name: agent</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      port: <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      targetPort: <span class=\"token number\">50000</span></pre></td></tr></table></figure><h5 id=\"44-创建statefulset\"><a class=\"anchor\" href=\"#44-创建statefulset\">#</a> 4.4 创建 StatefulSet</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 jenkins<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-jenkins-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: jenkins</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"jenkins-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: jenkins</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: jenkins</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      serviceAccount: jenkins</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: jenkins</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: s.hmallleasing.com/base/jenkins:2.504.2</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          securityContext:     <span class=\"token comment\"># 添加参数启用容器 root 权限</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            runAsUser: <span class=\"token number\">0</span>        <span class=\"token comment\"># root 身份运行</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          env:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: JAVA_OPTS     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            value: <span class=\"token parameter variable\">-Duser.timezone</span><span class=\"token operator\">=</span>Asia/Shanghai</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          ports:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - name: http</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            - name: agent</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              containerPort: <span class=\"token number\">50000</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              cpu: 1500m</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              memory: 4096Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          readinessProbe:          <span class=\"token comment\"># 就绪探针</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            httpGet:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              path: /login</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            failureThreshold: <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              mountPath: /var/jenkins_home</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>              mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>              mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"45-创建ingress\"><a class=\"anchor\" href=\"#45-创建ingress\">#</a> 4.5 创建 Ingress</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 jenkins<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 04-jenkins-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: jenkins-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: ops</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: jenkins.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: jenkins-svc </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              name: http</pre></td></tr></table></figure><h5 id=\"46-初始化jenkins\"><a class=\"anchor\" href=\"#46-初始化jenkins\">#</a> 4.6 初始化 Jenkins</h5>\n<p>1、查看 jenkins 对应的初始化密码；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7oXyJkT.png\" alt=\"1.png\" /></p>\n<p>2、跳过插件安装，进入 jenkins 自行安装即可；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Yd8GYZ3.png\" alt=\"2.png\" /></p>\n<h5 id=\"47-jenkins配置与插件\"><a class=\"anchor\" href=\"#47-jenkins配置与插件\">#</a> 4.7 Jenkins 配置与插件</h5>\n<p>1、修改默认管理员密码</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/QhEqsq2.png\" alt=\"3.png\" /></p>\n<p>2、安装 Jenkins 插件</p>\n<p>#1. 将 jenkins 插件的路径，更改为国内源<br />\n系统管理 -&gt; 插件管理 -&gt; 高级 -&gt; 升级站点 -&gt; 修改 URL-&gt;<a href=\"https://updates.jenkins.io/update-center.json\">https://updates.jenkins.io/update-center.json</a> 替换 https://mirrors.huaweicloud.com/jenkins/updates/update-center.json</p>\n<p>#2. 安装 Jenkins 插件</p>\n<p>中文插件： Localization: Chinese</p>\n<p>Git 插件： git、gitlab</p>\n<p>Sonar 插件： SonarQube Scanner</p>\n<p>Pipeline 插件： pipeline、Stage View、BlueOcean</p>\n<p>Kubernetes 插件： Kubernetes</p>\n<h4 id=\"五-jenkins-pipeline\"><a class=\"anchor\" href=\"#五-jenkins-pipeline\">#</a> 五、Jenkins Pipeline</h4>\n<h5 id=\"51-什么是pipeline\"><a class=\"anchor\" href=\"#51-什么是pipeline\">#</a> 5.1 什么是 Pipeline</h5>\n<p>Pipeline 就是通过 “代码的方式” 将多个步骤的任务连接起来。共同来完成一件事；比如：应用发布就会牵扯到非常多的步骤，获取代码 -&gt; 代码扫描 -&gt; 代码编译 -&gt; 制作镜像 -&gt; 推送仓库 -&gt; 部署应用，将这些步骤通过代码的方式组织在一起完成这次应用发布，这个就可以称之为流水线，亦或者是 Pipeline 流水线；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/YhNTYQC.png\" alt=\"1.png\" /></p>\n<h5 id=\"52-pipeline代码示例\"><a class=\"anchor\" href=\"#52-pipeline代码示例\">#</a> 5.2 Pipeline 代码示例</h5>\n<p>agent: 节点</p>\n<p>stage: 阶段</p>\n<p>steps: 动作</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline<span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    agent any    //目前只有一台jenkins，所以他会在本地执行</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tenvironment <span class=\"token punctuation\">&#123;</span>       //全局变量</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token assign-left variable\">Harbor_Url</span><span class=\"token operator\">=</span><span class=\"token string\">\"s.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token assign-left variable\">Harbor_Pro</span><span class=\"token operator\">=</span><span class=\"token string\">\"base\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'下载代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\tenvironment <span class=\"token punctuation\">&#123;</span>     //局部变量</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token assign-left variable\">Image_Name</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-order:v1.1\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t\t<span class=\"token assign-left variable\">Full_Image</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t\t<span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Get Gitlab Code $&#123;Full_Image&#125;\"'</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'检测代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tenvironment <span class=\"token punctuation\">&#123;</span>     //局部变量</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t\t<span class=\"token assign-left variable\">Image_Name</span><span class=\"token operator\">=</span><span class=\"token string\">\"nf-flms-static:v1.1\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t\t\t<span class=\"token assign-left variable\">Full_Image</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$&#123;Harbor_Url&#125;</span>/<span class=\"token variable\">$&#123;Harbor_Pro&#125;</span>/<span class=\"token variable\">$&#123;Image_Name&#125;</span>\"</span>\t\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Unit Test $&#123;Full_Image&#125;\"'</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'编译代码'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Build Code\"'</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'制作镜像'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t    <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Build Docker\"'</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        stage<span class=\"token punctuation\">(</span><span class=\"token string\">'部署应用'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                <span class=\"token function\">sh</span> <span class=\"token string\">'echo \"Deploy Code\"'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"六-jenkins-slave架构\"><a class=\"anchor\" href=\"#六-jenkins-slave架构\">#</a> 六、 Jenkins Slave 架构</h4>\n<h5 id=\"61-架构基本说明\"><a class=\"anchor\" href=\"#61-架构基本说明\">#</a> 6.1 架构基本说明</h5>\n<p>所谓 JenkinsMaster/Slave 架构，及在 Master 上进行任务分配。然后由 Slave 来完成，不过 Slave 运行方式有两种：</p>\n<ul>\n<li>静态 SLave：需要固定的节点，配置其对应环境，手动注册到 Master，然后执行任务，任务完成节点处于空闲等待状态；</li>\n<li>动态 Slave：由 Master 动态创建 Slave 的 Pod，自动注册到 Master，然后执行任务，任务结束 Pod 自动销毁；</li>\n</ul>\n<p><strong>静态 Jenkins Slave</strong></p>\n<p>1、能够分担主节点上的压力，加快构建速度（所有任务都由 Master 执行，造成构建速度缓慢，且任务多会出现排队现象</p>\n<p>2、能够将特定的任务在特定的主机上运行（比如：不同的任务需要不同的编译环境）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/mayAACO.png\" alt=\"2.png\" /></p>\n<p><strong>痛点：</strong></p>\n<ul>\n<li>1、Master 发生单点故障时，整个 Jenkins 都没办法使用；</li>\n<li>2、每个 Slave 的环境不一样，用于完成不同项目的编译打包工作，但这些不同环境的配置管理及维护都特别困难；</li>\n<li>3、有的 Slave 构建任务频繁，可能出现排队等待，而有的 Slave 又处于空闲状态，所以会出现资源分配严重不均衡；</li>\n<li>4、因为每个 Slave 都需要一台虚拟机，当 Slave 空间时，等于就是空跑，资源浪费明显；</li>\n</ul>\n<p>** 动态 Jenkins Slave **</p>\n<p>所谓动态 Slave，就是根据任务进行动态供应和动态删除。Jenkins Master 和 Jenkins Slave 都是以 Pod 的形式运行在 Kubernetes 集群节点上，Master 运行在其中一个节点上，其配置数据存储在一个持久卷声明中。而 Slave 则随机运行在各个节点上，但它不会一直处于运行状态，而是根据需求动态创建并自动删除。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ngDX7Wo.png\" alt=\"3.png\" /></p>\n<p><strong>优势：</strong></p>\n<ul>\n<li>1、高可用性：（当 Jenkins Master 故障时，Kubernetes 会自动创建一个新的 Jenkins Master 容器，并将持久卷挂载至新创建的容器，保证数据不会丢失，从而实现 Jenkins 的高可用性。）</li>\n<li>2、高可扩缩性：（当 Kubernetes 集群因资源不足而导致任务长时间排队等待时，可以向集群新增节点，来环节压力。）</li>\n<li>3、资源分配合理：（Kubernetes 动态分配 Slave 至空闲节点，避免因单个节点资源利用率高而导致任务排队等待。）</li>\n</ul>\n<h4 id=\"七-jenkins动态slave配置\"><a class=\"anchor\" href=\"#七-jenkins动态slave配置\">#</a> 七、Jenkins 动态 Slave 配置</h4>\n<h5 id=\"71-配置kubernetes\"><a class=\"anchor\" href=\"#71-配置kubernetes\">#</a> 7.1 配置 Kubernetes</h5>\n<p><em><mark>系统管理 -&gt; 节点管理 -&gt;Cloud-&gt;Add a New Cloud-&gt;Kubernetes</mark></em></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/teMdRgu.png\" alt=\"1.png\" /></p>\n<ul>\n<li>Kubernetes 地址： <a href=\"https://kubernetes.default.svc.cluster.local\">https://kubernetes.default.svc.cluster.local</a></li>\n<li>Kubernetes 命名空间：ops</li>\n</ul>\n<p>由于 Jenkins 是通过 Pod 运行在 Kubernetes 集群中，所以通过 service 地址即可连接 Kubernetes 集群，正常通信。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fJss696.png\" alt=\"2.png\" /></p>\n<h5 id=\"72-配置jenkins\"><a class=\"anchor\" href=\"#72-配置jenkins\">#</a> 7.2 配置 Jenkins</h5>\n<p>Jenkins 地址：<a href=\"http://jenkins-svc.ops.svc.cluster.local:8080\">http://jenkins-svc.ops.svc.cluster.local:8080</a></p>\n<p>Jenkins 通道：jenkins-svc.ops.svc.cluster.local:50000</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8rRPlr9.png\" alt=\"3.png\" /></p>\n<h5 id=\"73-运行测试流水线\"><a class=\"anchor\" href=\"#73-运行测试流水线\">#</a> 7.3 运行测试流水线</h5>\n<p>1、编写流水线</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tstages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\tstage<span class=\"token punctuation\">(</span><span class=\"token string\">'输出主机名称'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t\tsteps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t\t<span class=\"token function\">sh</span> <span class=\"token string\">'hostname'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tstage<span class=\"token punctuation\">(</span><span class=\"token string\">'等待片刻'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\tsteps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\t\t<span class=\"token function\">sh</span> <span class=\"token string\">'sleep 60'</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p>2、jenkins 会自动拉起一个 Pod，运行 agent 容器注册到 Master 节点，然后进行任务的执行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-jenkins<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n ops</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                   READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>gitlab-0                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             20h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>jenkins-0                              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>22m ago<span class=\"token punctuation\">)</span>   86m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pipeline-daemon1-4-z9rqq-0t4nr-ql2v3   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             2s    <span class=\"token comment\">#jenkins slave</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>postgresql-0                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             17h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sonarqube-0                            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             17h</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/MmlW9RG.png\" alt=\"4.png\" /></p>\n<h4 id=\"八-制作pod模板镜像\"><a class=\"anchor\" href=\"#八-制作pod模板镜像\">#</a> 八、制作 Pod 模板镜像</h4>\n<p>jnlp 镜像是用来连接 JenkinsMaster 以及共享 Master 的 WORKSPACE，但该镜像并没有 maven、docker、kubectl 等常用命令，为此我们需要定制几个镜像，后期通过 Pipeline 将不同的任务交由同一个 Pod 的不同的容器来执行。</p>\n<h5 id=\"81-maven\"><a class=\"anchor\" href=\"#81-maven\">#</a> 8.1 Maven</h5>\n<p>1、下载 settings.xml</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 maven<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://linux.oldxu.net/settings_docker.xml</span></pre></td></tr></table></figure><p>2、Dockerfile</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 maven<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM maven:3.8.6-openjdk-8</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ADD ./settings_docker.xml /usr/share/maven/conf/settings.xml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr></table></figure><p>3、构建镜像并推送私有仓库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 maven<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker build -t s.hmallleasing.com/base/maven:3.8.6 .</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 maven<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/maven:3.8.6</span></pre></td></tr></table></figure><h5 id=\"82-sonar\"><a class=\"anchor\" href=\"#82-sonar\">#</a> 8.2 sonar</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull emeraldsquad/sonar-scanner:2.3.0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag emeraldsquad/sonar-scanner:2.3.0 s.hmallleasing.com/base/sonar-scanner:2.3.0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/sonar-scanner:2.3.0</span></pre></td></tr></table></figure><h5 id=\"83-nodejs\"><a class=\"anchor\" href=\"#83-nodejs\">#</a> 8.3 NodeJs</h5>\n<p>1、Dockerfile</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nodejs<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM centos:7</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>RUN <span class=\"token function\">curl</span> <span class=\"token parameter variable\">--silent</span> <span class=\"token parameter variable\">--location</span> https://rpm.nodesource.com/setup_14.x <span class=\"token operator\">|</span><span class=\"token function\">bash</span> -</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>RUN yum <span class=\"token function\">install</span> nodejs gcc-c++ <span class=\"token function\">make</span> <span class=\"token function\">vim</span> <span class=\"token parameter variable\">-y</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    yum clean all</pre></td></tr></table></figure><p>2、构建镜像并推送私有仓库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nodejs<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker build -t s.hmallleasing.com/base/nodejs:14.20 .</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nodejs<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/nodejs:14.20</span></pre></td></tr></table></figure><h5 id=\"84-docker\"><a class=\"anchor\" href=\"#84-docker\">#</a> 8.4 Docker</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker pull docker:20.10 </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag docker:20.10 s.hmallleasing.com/base/docker:20.10</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/docker:20.10</span></pre></td></tr></table></figure><h5 id=\"85-kubectl\"><a class=\"anchor\" href=\"#85-kubectl\">#</a> 8.5 kubectl</h5>\n<p>1、编写 kubernetes.repo 文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span>EOF<span class=\"token operator\">></span> ./kubernetes.repo</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>kubernetes<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span>Kubernetes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">baseurl</span><span class=\"token operator\">=</span>https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">enabled</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">gpgcheck</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">gpgkey</span><span class=\"token operator\">=</span>https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/repodata/repomd.xml.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>EOF</pre></td></tr></table></figure><p>2、Dockerfile</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 kubectl<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM centos:7</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 1、调整时区</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>RUN <span class=\"token function\">curl</span> <span class=\"token parameter variable\">-o</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2、添加 yum 源</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ADD ./kubernetes.repo /etc/yum.repos.d/kubernetes.repo</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 3、安装 Kubectl</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>RUN yum makecache <span class=\"token operator\">&amp;&amp;</span> yum <span class=\"token function\">install</span> kubectl-1.32.3 <span class=\"token parameter variable\">-y</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    yum clean all</pre></td></tr></table></figure><p>3、构建镜像并推送私有仓库</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 kubectl<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker build -t s.hmallleasing.com/base/kubectl:1.32.3 .</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 kubectl<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push s.hmallleasing.com/base/kubectl:1.32.3</span></pre></td></tr></table></figure><h4 id=\"九-测试pod模板镜像\"><a class=\"anchor\" href=\"#九-测试pod模板镜像\">#</a> 九、测试 Pod 模板镜像</h4>\n<p>运行一个流水线任务，定义 Pod 模板中的容器名称以及容器镜像地址，而后定义任务，不同的任务由不同的容器来执行</p>\n<h5 id=\"91-定义podtemplate\"><a class=\"anchor\" href=\"#91-定义podtemplate\">#</a> 9.1 定义 podTemplate</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>pipeline <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  agent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kubernetes <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      cloud <span class=\"token string\">'kubernetes'</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      yaml <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        apiVersion: v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        kind: Pod</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>          imagePullSecrets:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          - name: harbor-admin</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          volumes:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>            nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>              server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>              path: /data/nfs/maven</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          - name: dockersocket</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            hostPath:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              path: /run/docker.sock</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - name: maven</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            image: s.hmallleasing.com/base/maven:3.8.6</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            - name: data</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              mountPath: /root/.m2</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          - name: nodejs</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            image: s.hmallleasing.com/base/nodejs:14.20</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          - name: sonar</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            image: s.hmallleasing.com/base/sonar-scanner:2.3.0</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          - name: <span class=\"token function\">docker</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            image: s.hmallleasing.com/base/docker:20.10</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - name: dockersocket</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              mountPath: /run/docker.sock</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          - name: kubectl</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            image: s.hmallleasing.com/base/kubectl:1.32.3</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"cat\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            tty: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      <span class=\"token string\">''</span>'</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  stages <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'maven测试'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'maven'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'mvn --version'</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs测试'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'nodejs'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'node -v'</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'docker测试'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'docker'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'docker ps'</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>    stage<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl测试'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      steps <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        container<span class=\"token punctuation\">(</span><span class=\"token string\">'kubectl'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t  <span class=\"token function\">sh</span> <span class=\"token string\">'kubectl version'</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span>\t\t</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><em><strong>#在 nfs 中创建 /data/maven 文件夹，将 maven 缓存 /root/.m2 挂载至该目录</strong></em></p>\n<h5 id=\"92-运行pipeline\"><a class=\"anchor\" href=\"#92-运行pipeline\">#</a> 9.2 运行 Pipeline</h5>\n<p>构建流水线，检查各个阶段调用容器执行的输出结果是否 OK；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iLcep5b.png\" alt=\"5.png\" /></p>\n",
            "tags": [
                "DevOps"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1528713798.html",
            "url": "http://ixuyong.cn/posts/1528713798.html",
            "title": "阿里云ECS、SLB、RDS、CDN、ESS应用与实践",
            "date_published": "2025-06-08T02:55:56.000Z",
            "content_html": "<h3 id=\"阿里云ecs-slb-rds-cdn-ess应用与实践\"><a class=\"anchor\" href=\"#阿里云ecs-slb-rds-cdn-ess应用与实践\">#</a> 阿里云 ECS、SLB、RDS、CDN、ESS 应用与实践</h3>\n",
            "tags": [
                "Aliyun"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/754945111.html",
            "url": "http://ixuyong.cn/posts/754945111.html",
            "title": "Tomcat JVM调优实践",
            "date_published": "2025-06-08T02:51:57.000Z",
            "content_html": "<h3 id=\"tomcat-jvm调优实践\"><a class=\"anchor\" href=\"#tomcat-jvm调优实践\">#</a> Tomcat JVM 调优实践</h3>\n<h4 id=\"一-jvm基础架构\"><a class=\"anchor\" href=\"#一-jvm基础架构\">#</a> 一、JVM 基础架构</h4>\n<h5 id=\"11-jvm执行过程\"><a class=\"anchor\" href=\"#11-jvm执行过程\">#</a> 1.1 Jvm 执行过程</h5>\n<ol>\n<li>使用 java 编程语言开发 java 源代码，然后通过编译器把 java 编译为 java 类文件也叫字节码；</li>\n<li>通过类加载器 ClassLoader 将字节码加载到内存中，将其放在运行时数据区中的方法区内；</li>\n<li>然后调用执行引擎在 JVM 虚拟机中运行，然后将字节码编译成底层系统指令，在交由 CPU 执行；</li>\n<li>同时我们在编写程序时，不可能从头到尾去实现所有代码功能，可以通过 Java API 调用本地库接口（Native Interface）当中已经有的 java 代码来实现其他的功能（比如图形库、语言等）；</li>\n<li>总结：类的加载指的是将类的.class 文件中的二进制数据读取到内存中，将其放在运行时数据区的方法区内，然后在堆区创建一个对象，用来封装类在方法区的数据结构；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nKBTppH.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"12-jvm堆内存模型\"><a class=\"anchor\" href=\"#12-jvm堆内存模型\">#</a> 1.2 JVM 堆内存模型</h5>\n<ul>\n<li>\n<p>当 jvm 启动时，jvm 会自动从主机操作系统中取到一部分内存空间；</p>\n</li>\n<li>\n<p>然后 jvm 会自动将内存空间按照特定的格式，进行区域划分；</p>\n</li>\n<li>\n<p>划分区段的目的，主要是让垃圾回收算法能够更好的利用这些区域完成垃圾回收；</p>\n</li>\n<li>\n<p>jvm Heap 内存空间有三部分组成：</p>\n<ul>\n<li>年轻代</li>\n<li>老年代</li>\n</ul>\n</li>\n<li>\n<p>年轻代又可以划分三个子组成部分：</p>\n<ul>\n<li>新生区（Eden）：当一个对象刚刚创建时则创建在 Eden 中；</li>\n<li>存活区（Suvivor）：步入成熟区的初创对象；\n<ul>\n<li>Suvivor to</li>\n<li>Suvivor from</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>老年代</p>\n<ul>\n<li>\n<p>那些活跃的对象，很久都没有被回收掉，那么就送到老年代；</p>\n</li>\n<li>\n<p>如果年轻代内存不够，创建的对象过于庞大，则直接进入老年代，称之为分配担保；</p>\n</li>\n</ul>\n</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/EudJYlc.jpeg\" alt=\"3.jpg\" /></p>\n<h5 id=\"13-jvm堆内存参数分配\"><a class=\"anchor\" href=\"#13-jvm堆内存参数分配\">#</a> 1.3 JVM 堆内存参数分配</h5>\n<p>分配 JVM 内存空间，我们应该安装业务运行过程中，运行模式、或内存使用方式，来指定使用这些内存空间的大小，指定这些参数可以通过 java -opts 传递；</p>\n<ul>\n<li>-Xms：新生代和老年代初始空间；</li>\n<li>-Xmx：新生代和老年代总共可用的空间；</li>\n<li>-XX:NewSize：新生代初始空间；</li>\n<li>-XX:MaxNewSize：新生代最大空间</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fnsr075.jpeg\" alt=\"4.jpg\" /></p>\n<h6 id=\"131-设置java项目的堆空间\"><a class=\"anchor\" href=\"#131-设置java项目的堆空间\">#</a> 1.3.1 设置 java 项目的堆空间</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat jvm_heap_params.java </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms100m</span> <span class=\"token parameter variable\">-Xmx100m</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *    *************************************************</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    */</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>public class jvm_heap_params <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\ttry <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t\tThread.sleep<span class=\"token punctuation\">(</span>Integer.MAX_VALUE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span> catch <span class=\"token punctuation\">(</span>InterruptedException e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t\te.printStackTrace<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"132-编译代码\"><a class=\"anchor\" href=\"#132-编译代码\">#</a> 1.3.2 编译代码</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac jvm_heap_params.java </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>jvm_heap_params.class  jvm_heap_params.java</pre></td></tr></table></figure><h6 id=\"133-指定堆内存启动\"><a class=\"anchor\" href=\"#133-指定堆内存启动\">#</a> 1.3.3 指定堆内存启动</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms200M -Xmx200M -cp . jvm_heap_params &amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1664</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1676</span> Jps</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#通过 jinfo -flags 查看当前项目的内存分配</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jinfo -flags 1664</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Attaching to process ID <span class=\"token number\">1664</span>, please wait<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Debugger attached successfully.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Server compiler detected.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>JVM version is <span class=\"token number\">25.451</span>-b10</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Non-default VM flags: <span class=\"token parameter variable\">-XX:CICompilerCount</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">209715200</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">209715200</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">69730304</span> <span class=\"token parameter variable\">-XX:MinHeapDeltaBytes</span><span class=\"token operator\">=</span><span class=\"token number\">524288</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">69730304</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">139984896</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseFastUnorderedTimeStamps</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Command line:  <span class=\"token parameter variable\">-Xms200M</span> <span class=\"token parameter variable\">-Xmx200M</span></pre></td></tr></table></figure><h6 id=\"134-不指定堆内存启动\"><a class=\"anchor\" href=\"#134-不指定堆内存启动\">#</a> 1.3.4 不指定堆内存启动</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java  -cp . jvm_heap_params &amp;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">1763</span> Jps</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1751</span> jvm_heap_params</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#通过 jinfo -flags 查看当前项目的内存分配</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># jinfo -flags 1751</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Attaching to process ID <span class=\"token number\">1751</span>, please wait<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Debugger attached successfully.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Server compiler detected.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>JVM version is <span class=\"token number\">25.451</span>-b10</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Non-default VM flags: <span class=\"token parameter variable\">-XX:CICompilerCount</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">31457280</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">478150656</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">159383552</span> <span class=\"token parameter variable\">-XX:MinHeapDeltaBytes</span><span class=\"token operator\">=</span><span class=\"token number\">524288</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">20971520</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseFastUnorderedTimeStamps</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Command line:</pre></td></tr></table></figure><h5 id=\"14-tomcat设置堆空间\"><a class=\"anchor\" href=\"#14-tomcat设置堆空间\">#</a> 1.4 Tomcat 设置堆空间</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/bin/catalina.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加如下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token variable\">$JSSE_OPTS</span>\"</span>  <span class=\"token comment\">#下面添加</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms200m -Xmx200m -XX:+UseConcMarkSweepGC\"</span>\t</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#生产服务器配置参数</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms2G -Xmx2G -XX:+UseConcMarkSweepGC\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1g8Q3Rg.jpeg\" alt=\"5.jpg\" /></p>\n<h4 id=\"二-gc垃圾回收算法\"><a class=\"anchor\" href=\"#二-gc垃圾回收算法\">#</a> 二、 GC 垃圾回收算法</h4>\n<h5 id=\"21-什么是垃圾\"><a class=\"anchor\" href=\"#21-什么是垃圾\">#</a> 2.1 什么是垃圾</h5>\n<ul>\n<li>GC 指的就是垃圾，垃圾指的是不在需要使用的 java 对象；</li>\n<li>程序在运行的过程中需要申请内存资源的，而在运行过程中，可能会产生无效的对象资源，如果不及时处理则会占用内存，最后造成内存溢出；</li>\n<li>Java 有自动垃圾回收机制，也就是 GC，使得开发能更专注业务代码，而无需关心内存释放问题；\n<ul>\n<li>那我们需要知道哪些对象是垃圾；</li>\n<li>以及这些垃圾对象该如何回收</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"22-如何确定哪些是垃圾\"><a class=\"anchor\" href=\"#22-如何确定哪些是垃圾\">#</a> 2.2 如何确定哪些是垃圾</h5>\n<p>如何确定哪些是垃圾，其实就是判断 “对象的存活状态”，常见的判断分析有两种：</p>\n<ul>\n<li>引用计数算法</li>\n<li>可达性分析算法</li>\n</ul>\n<h6 id=\"221-引用计数算法\"><a class=\"anchor\" href=\"#221-引用计数算法\">#</a> 2.2.1 引用计数算法</h6>\n<ul>\n<li>\n<p>实现原理：</p>\n<ul>\n<li>\n<p>给每个 Java 对象添加一个引用计数器；</p>\n</li>\n<li>\n<p>每当有一个地方引用它，计数器 + 1，引用失效则 - 1；</p>\n</li>\n<li>\n<p>当计数器不为 0 时，则判断对象为存活，否则判断为死亡；</p>\n</li>\n</ul>\n</li>\n<li>\n<p>算法优势</p>\n<ul>\n<li>\n<p>实现简单</p>\n</li>\n<li>\n<p>判断高效</p>\n</li>\n</ul>\n</li>\n<li>\n<p>算法缺陷</p>\n<ul>\n<li>每次对象被引用，都需要跟新计数器，存在时间开销；</li>\n<li>即使内存够用，在运行时进行计数，会让费 CPU 资源</li>\n<li>无法解决对象相互循环引用的问题，比如：\n<ul>\n<li><a href=\"http://objA.name\">objA.name</a> = objB;</li>\n<li><a href=\"http://objB.name\">objB.name</a> = objA;</li>\n<li>objA、objB 他们的计数器至少为 1，所以不可能被回收；</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p>算法小结：</p>\n<ul>\n<li>由于算法存在判断逻辑漏洞，所以 JVM 虚拟机没有采用该算法判断 JAVA 对象是否存活；</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"222-可达性分析算法\"><a class=\"anchor\" href=\"#222-可达性分析算法\">#</a> 2.2.2 可达性分析算法</h6>\n<p>Java 虚拟机采用的算法，可达性分析算法；</p>\n<ul>\n<li>将一系列 GC Roots 对象作为起点，从这些起点开始向下搜索；</li>\n<li>当一个对象 GC Roots 没有任何引用链相连时，则判断对象不可达，可以被 GC 回收；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/B6OLSwC.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"23-gc垃圾回收算法\"><a class=\"anchor\" href=\"#23-gc垃圾回收算法\">#</a> 2.3 GC 垃圾回收算法</h5>\n<p>GC 通过 “可达性分析算法” 标记了垃圾对象以及存活对象，那么该如何将标记的垃圾对象回收呢？</p>\n<ul>\n<li>标记 - 清除算法</li>\n<li>标记 - 复制算法</li>\n<li>标记 - 压缩算法</li>\n</ul>\n<h6 id=\"231-标记-清除算法\"><a class=\"anchor\" href=\"#231-标记-清除算法\">#</a> 2.3.1 标记 - 清除算法</h6>\n<p>标记清除算法分为两个阶段：</p>\n<ul>\n<li>标记阶段：标记出存活的对象，以及可回收的对象；</li>\n<li>清除阶段：回收掉所有被标记的对象；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sx5sxl8.jpeg\" alt=\"2.jpg\" /></p>\n<p>标记清除算法缺点：</p>\n<ul>\n<li>效率不高，因为需要遍历所有的对象，然后标记存活对象，同时还要标记可回收对象；</li>\n<li>清除对象后位置不连续，难以找到连续的可用空间，所以容易产生碎片；</li>\n</ul>\n<h6 id=\"232-标记-复制算法\"><a class=\"anchor\" href=\"#232-标记-复制算法\">#</a> 2.3.2 标记 - 复制算法</h6>\n<p>算法基本概念：</p>\n<ul>\n<li>首先将内存划分为两块相等大小的区域，每次数据存储仅使用其中一块区域；</li>\n<li>当这一块区域使用完后，就将还存活的对象复制到另一块区域上面；</li>\n<li>最后将使用过的内存空间进行一次清理；</li>\n</ul>\n<p>算法工作过程：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ABEC1KS.jpeg\" alt=\"3.jpg\" /></p>\n<p>标记复制算法优点：</p>\n<ul>\n<li>在垃圾对象多的情况下，效率较高；</li>\n<li>垃圾清理后，内存无碎片；</li>\n</ul>\n<p>标记复制算法缺点：</p>\n<ul>\n<li>分配的两块内存区域，在同一时刻，只能使用一半，造成空间让费；</li>\n<li>如果创建的对象存活率较高时，需要在两个内存空间来回复制，效率低；</li>\n</ul>\n<h6 id=\"233-标记-压缩算法\"><a class=\"anchor\" href=\"#233-标记-压缩算法\">#</a> 2.3.3 标记 - 压缩算法</h6>\n<p>算法思想：它与 “标记复制” 算法类似，但是标记压缩算法不是把存活对象复制到另一块内存，而是把存活对象往内存的一端移动，然后直接回收边界以外的内存，因此不会产生内存碎片；</p>\n<p>算法工作过程：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Eg0fT8T.jpeg\" alt=\"4.jpg\" /></p>\n<h4 id=\"三-gc分代垃圾回收算法\"><a class=\"anchor\" href=\"#三-gc分代垃圾回收算法\">#</a> 三、GC 分代垃圾回收算法</h4>\n<p>由于 JVM 堆空间划分了年轻代和老年代，而且年轻代和老年代中存储对象各有特点，所以不同阶段适合使用不同的 GC 算法进行 GC 回收。</p>\n<p>根据回收对象的特点进行选择，在 JVM 中：</p>\n<ul>\n<li>年轻代对象存活时间低，适合使用 “复制算法”；</li>\n<li>老年代对象存活时间长，适合使用 “标记清除算法、标记压缩算法”；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/nlZrrag.jpeg\" alt=\"5.jpg\" /></p>\n<p>MinorGC/YoungGC：指年轻代触发 GC 动作</p>\n<p>MajorGC/OldGC：指老年代触发 GC 动作</p>\n<p>FullGC ：年轻代和老年代都没有空间，则全部回收，称之为 FullGC</p>\n<h5 id=\"31-gc年轻代垃圾回收-minorgcyounggc\"><a class=\"anchor\" href=\"#31-gc年轻代垃圾回收-minorgcyounggc\">#</a> 3.1 GC 年轻代垃圾回收 - MinorGC/YoungGC</h5>\n<h6 id=\"311-minorgcyounggc回收阶段1\"><a class=\"anchor\" href=\"#311-minorgcyounggc回收阶段1\">#</a> 3.1.1 MinorGC/YoungGC 回收阶段 1</h6>\n<ol>\n<li>刚刚启动 JVM 时，创建的对象会进入 Eden 区；</li>\n<li>当 Eden 区满了后，如果任然有新的对象需要创建，则会触发一次 MinorGC/YoungGC\n<ul>\n<li>通过根可达算法标记垃圾对象；</li>\n<li>将活跃的对象通过复制算法，复制到 S0 区域；</li>\n<li>然后将 Eden 对象去全部清除；</li>\n</ul>\n</li>\n<li>清理完成后，Eden 中没有任何对象，S0 中有存活对象，S1 中没有任何对象；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iCz29Yz.jpeg\" alt=\"8.jpg\" /></p>\n<h6 id=\"312-minorgcyounggc回收阶段2\"><a class=\"anchor\" href=\"#312-minorgcyounggc回收阶段2\">#</a> 3.1.2 MinorGC/YoungGC 回收阶段 2</h6>\n<ol>\n<li>当再次创建对象时，对象任然会创建在 Eden 区；</li>\n<li>当 Eden 区空间满了后，会再次触发 GC 垃圾回收；\n<ul>\n<li>此时会将 Eden 区的对象复制到 S1 区；</li>\n<li>将 S0 存活的对象复制到 S1 区；</li>\n</ul>\n</li>\n<li>然后清理所有 Eden 区对象及 S0 区对象；</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aCsOoV3.jpeg\" alt=\"9.jpg\" /></p>\n<h5 id=\"32-gc老年代垃圾回收-majorgcoldgc\"><a class=\"anchor\" href=\"#32-gc老年代垃圾回收-majorgcoldgc\">#</a> 3.2 GC 老年代垃圾回收 - MajorGC/OldGC</h5>\n<h6 id=\"321-majorgcoldgc回收阶段1\"><a class=\"anchor\" href=\"#321-majorgcoldgc回收阶段1\">#</a> 3.2.1 MajorGC/OldGC 回收阶段 1</h6>\n<ul>\n<li>当有较大对象创建时，可能不会出现在 Eden 区，而是直接进入老年代；</li>\n<li>每次在 From Survivor 到 To Survivor 移动时都存活的对象，年龄就 + 1，当年龄达到 15（Default）时，升级为老年代；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wquhJo9.jpeg\" alt=\"6.jpg\" /></p>\n<h6 id=\"322-majorgcoldgc回收阶段2\"><a class=\"anchor\" href=\"#322-majorgcoldgc回收阶段2\">#</a> 3.2.2 MajorGC/OldGC 回收阶段 2</h6>\n<ul>\n<li>当创建新对象，如果 Eden + Survivor +Old 都无法存储时，就会发生 MajorGC/OldGC；\n<ul>\n<li>遍历整个堆，用来标记不存在使用的对象；</li>\n<li>将不在使用，或不存在访问的对象清除掉；</li>\n</ul>\n</li>\n<li>通常出现 MajorGC/OldGC 是指老年代发生了 GC；\n<ul>\n<li>当出现 MajorGC/OldGC 通常会伴随至少一次 MinorGC/YoungGC；</li>\n<li>而 MajorGC/OldGC 的速度通常会比 MinorGC/YoungGC 慢 10 倍以上；</li>\n</ul>\n</li>\n<li>如果 MinorGC/YoungGC 回收资源后，还是没有空间，则会触发 FullGC；将老年代和年轻代内存全部清空，一旦触发 FullGC 就需要熬过漫长的时间，甚至有可能要手动进行垃圾回收；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8hHenlL.jpeg\" alt=\"7.jpg\" /></p>\n<h5 id=\"33-stop-the-world\"><a class=\"anchor\" href=\"#33-stop-the-world\">#</a> 3.3 Stop-The-World</h5>\n<ul>\n<li>STW 是 Java 中一种全局暂停现象，多半有 GC 引起，所谓全局停顿，就是所有 Java 代码停止运行；</li>\n<li>一旦发生 GC，就是触发短暂的 STW，就好像垃圾车从家门口驶过，什么也做不了；</li>\n<li>STW 容易造成服务器长时间停止，以及资源不响应，对于 HA 系统，可能还会应急主备切换；</li>\n</ul>\n<h4 id=\"四-gc垃圾收集器\"><a class=\"anchor\" href=\"#四-gc垃圾收集器\">#</a> 四、GC 垃圾收集器</h4>\n<p>如果说 GC 垃圾回收算法只是内存回收的方法论，那 GC 垃圾收集器就是来具体实现这些算法，并实现内存回收；</p>\n<h5 id=\"41-gc垃圾收集器类型\"><a class=\"anchor\" href=\"#41-gc垃圾收集器类型\">#</a> 4.1 GC 垃圾收集器类型</h5>\n<ul>\n<li>串行垃圾收集器：GC 单线程实现内存垃圾回收，会暂停所有用户线程，如 Serial；</li>\n<li>并行垃圾收集器：GC 多线程并发实现内存垃圾回收，会暂停所有用户线程，如 ParNew、Parallel；</li>\n<li>并发垃圾收集器：用户线程和 GC 线程同时执行实现内存垃圾回收（不一定完全并行，可能交替执行），不停顿用户进程，或短暂停顿，如 CMS；</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/olWEGJp.jpeg\" alt=\"11.jpg\" /></p>\n<p>Serial（复制算法）新生代单线程收集器，标记和清理都是单线程，优点简单高效；</p>\n<p>Serial Old（标记整理算法）老年代单线程收集器，Serial 收集器的老年代版本；</p>\n<p>ParNew（复制算法）新生代并行收集器，是 Serial 收集器的多线程版本，在多核 CPU 环境下会比 Serial 表现更好；</p>\n<p>Parallel Scavenge（复制算法）新生代并行收集器，追求高吞吐量，高效利用 CPU；</p>\n<p>Parallel Old（标记整理算法）Parallel Scavenge 老年代并行收集器，吞吐量优先；</p>\n<p>CMS（Concurrent Mark Sweep）（标记清除算法）老年代并行收集器，以获取最短回收停顿时间为目标的收集器，具有高并发、低停顿的特点，追求最短 GC 回收停顿时间；</p>\n<p>G1（Garbage First）（标记整理算法）并行收集器，G1 回收的范围是整个 Java 堆，包括新生代、老年代，而前六种收集器回收的范围仅限于新生代或老年代。</p>\n<h5 id=\"42-修改默认gc收集器\"><a class=\"anchor\" href=\"#42-修改默认gc收集器\">#</a> 4.2 修改默认 GC 收集器</h5>\n<p>Java 默认垃圾收集器为年轻代使用 Parallel Scavenge 垃圾收集器，老年代使用 Parallel Old 垃圾收集器，Tomcat 可以通过如下参数进行修改:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/bin/catalina.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加如下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPTS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token variable\">$JSSE_OPTS</span>\"</span>  <span class=\"token comment\">#下面添加</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">JAVA_OPS</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\">$JAVA_OPTS</span> -Xms2G -Xmx2G -XX:+UseConcMarkSweepGC\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/LJLXv5v.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"43-串行垃圾收集器serial\"><a class=\"anchor\" href=\"#43-串行垃圾收集器serial\">#</a> 4.3 串行垃圾收集器 Serial</h5>\n<h6 id=\"431-serial基本概念\"><a class=\"anchor\" href=\"#431-serial基本概念\">#</a> 4.3.1 Serial 基本概念</h6>\n<ul>\n<li>串行垃圾收集器是最基本的、发展历史最悠久的收集器；</li>\n<li>特点：单线程、简单高效、对于限定单个 CPU 的环境来说，Serial 收集器由于没有线程交互的开销，专心做垃圾收集可以获得最高的单线程收集效率；</li>\n<li>注意：串行垃圾收集器在进行垃圾回收时，必须暂停其他所有的工作线程，直到它结束；</li>\n</ul>\n<h6 id=\"432-serial运行示意图\"><a class=\"anchor\" href=\"#432-serial运行示意图\">#</a> 4.3.2 Serial 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zdXbx6M.jpeg\" alt=\"2.jpg\" /></p>\n<h6 id=\"433-serialgc代码测试案例\"><a class=\"anchor\" href=\"#433-serialgc代码测试案例\">#</a> 4.3.3 SerialGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat SerialGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *   </pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *    思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *     <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseSerialGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *      <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> SerialGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *       *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *       */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class SerialGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac SerialGC.java</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># -XX:+UseSerialGC 表示使用的 SerialGC</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 年轻代采用 SerialGC, 复制算法</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 老年代采用 SerialGCOld, 标记整理算法</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># GC 日志 https://www.cnblogs.com/gouge/p/9112782.html</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseSerialGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . SerialGC</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseSerialGC</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011904</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1148K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0012255</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2341K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0009890</span> secs<span class=\"token punctuation\">]</span> 3169K-<span class=\"token operator\">></span>2132K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010105</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2678K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006912</span> secs<span class=\"token punctuation\">]</span> 4810K-<span class=\"token operator\">></span>3444K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007214</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 1366K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004334</span> secs<span class=\"token punctuation\">]</span> 4810K-<span class=\"token operator\">></span>4756K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004566</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span> <span class=\"token builtin class-name\">:</span> 2678K-<span class=\"token operator\">></span>2678K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0002689</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 4755K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0028598</span> secs<span class=\"token punctuation\">]</span> 7434K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0031812</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2678K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018376</span> secs<span class=\"token punctuation\">]</span> 6449K-<span class=\"token operator\">></span>6395K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018952</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>DefNew: 2677K-<span class=\"token operator\">></span>2677K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0000409</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 6395K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0032290</span> secs<span class=\"token punctuation\">]</span> 9073K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0033621</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Tenured: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0028646</span> secs<span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3013K-<span class=\"token operator\">></span>3013K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0028871</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tat SerialGC.main<span class=\"token punctuation\">(</span>SerialGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"49\"></td><td><pre> def new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre> tenured generation   total 6848K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>   the space 6848K,  <span class=\"token number\">64</span>% used <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x00000000ffd9e2b0, 0x00000000ffd9e400, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre> Metaspace       used 3046K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"44并行垃圾收集器parnew\"><a class=\"anchor\" href=\"#44并行垃圾收集器parnew\">#</a> 4.4 并行垃圾收集器 ParNew</h5>\n<h6 id=\"441-parnew基本概念\"><a class=\"anchor\" href=\"#441-parnew基本概念\">#</a> 4.4.1 ParNew 基本概念</h6>\n<p>并行垃圾收集器在串行垃圾收集器的基础上做了改进，将单线程改为了多线程进行垃圾回收，这样可以缩短垃圾回收的时间，但还是会存在 STW （ Stop-The-World）的问题。</p>\n<h6 id=\"442-parnew运行示意图\"><a class=\"anchor\" href=\"#442-parnew运行示意图\">#</a> 4.4.2 ParNew 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0Ad9b9b.jpeg\" alt=\"1.jpg\" /></p>\n<h6 id=\"443-parnewgc代码测试案例\"><a class=\"anchor\" href=\"#443-parnewgc代码测试案例\">#</a> 4.4.3 ParNewGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ParNewGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *   思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *    <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *     <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> ParNewGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *      </pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *       *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *       */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class ParNewGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac ParNewGC.java</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 UseParNew GC 默认激活老年代 SeariaOld GC（单线程）</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseParNewGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . ParNewGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Java HotSpot<span class=\"token punctuation\">(</span>TM<span class=\"token punctuation\">)</span> <span class=\"token number\">64</span>-Bit Server VM warning: Using the ParNew young collector with the Serial old collector is deprecated and will likely be removed <span class=\"token keyword\">in</span> a future release</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010884</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1160K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011451</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2341K-<span class=\"token operator\">></span>227K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019999</span> secs<span class=\"token punctuation\">]</span> 3181K-<span class=\"token operator\">></span>2380K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0020246</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2905K-<span class=\"token operator\">></span>28K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011000</span> secs<span class=\"token punctuation\">]</span> 5058K-<span class=\"token operator\">></span>3493K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011400</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 1394K-<span class=\"token operator\">></span>7K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011553</span> secs<span class=\"token punctuation\">]</span> 4859K-<span class=\"token operator\">></span>4783K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011894</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span>: 2685K-<span class=\"token operator\">></span>2679K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006935</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 4776K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0032073</span> secs<span class=\"token punctuation\">]</span> 7461K-<span class=\"token operator\">></span>3771K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0039609</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2678K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011295</span> secs<span class=\"token punctuation\">]</span> 6449K-<span class=\"token operator\">></span>6397K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011634</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2679K-<span class=\"token operator\">></span>2679K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0000115</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Tenured: 6395K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0039025</span> secs<span class=\"token punctuation\">]</span> 9075K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0039539</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Tenured: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0024659</span> secs<span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3010K-<span class=\"token operator\">></span>3010K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0024877</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat ParNewGC.main<span class=\"token punctuation\">(</span>ParNewGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"48\"></td><td><pre> par new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre> tenured generation   total 6848K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>   the space 6848K,  <span class=\"token number\">64</span>% used <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x00000000ffd9e208, 0x00000000ffd9e400, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> Metaspace       used 3044K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"45-并行垃圾收集器parallel\"><a class=\"anchor\" href=\"#45-并行垃圾收集器parallel\">#</a> 4.5 并行垃圾收集器 Parallel</h5>\n<h6 id=\"451-parallel基本概念\"><a class=\"anchor\" href=\"#451-parallel基本概念\">#</a> 4.5.1 Parallel 基本概念</h6>\n<p>并行垃圾收集器在串行垃圾收集器的基础上做了改进，将单线程改为了多线程进行垃圾回收，这样可以缩短垃圾回收的时间，但还是会存在 STW （ Stop-The-World）的问题。</p>\n<h6 id=\"452-parallel运行示意图\"><a class=\"anchor\" href=\"#452-parallel运行示意图\">#</a> 4.5.2 Parallel 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7PSWcv2.jpeg\" alt=\"3.jpg\" /></p>\n<h6 id=\"453-parallelgc代码测试案例\"><a class=\"anchor\" href=\"#453-parallelgc代码测试案例\">#</a> 4.5.3 ParallelGC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ParallelGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *  思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> ParallelGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *     *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *     */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class ParallelGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac ParallelGC.java  \t\t\t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 ParallelScauenge GC 默认激活老年代 ParallelOld GC（单线程）\t\t\t</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\">#  java -Xms10m -Xmx10m -XX:+UseParallelGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . ParallelGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseParallelGC</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 1744K-<span class=\"token operator\">></span>501K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 1744K-<span class=\"token operator\">></span>773K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0013675</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2509K-<span class=\"token operator\">></span>503K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 2781K-<span class=\"token operator\">></span>843K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0006946</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2184K-<span class=\"token operator\">></span>240K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 3835K-<span class=\"token operator\">></span>2547K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0022336</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 2248K-<span class=\"token operator\">></span>240K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 8491K-<span class=\"token operator\">></span>6483K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007844</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> --<span class=\"token punctuation\">[</span>PSYoungGen: 1592K-<span class=\"token operator\">></span>1592K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7836K-<span class=\"token operator\">></span>7836K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0011287</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Ergonomics<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 1592K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 6243K-<span class=\"token operator\">></span>3114K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7836K-<span class=\"token operator\">></span>3114K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0064498</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 40K-<span class=\"token operator\">></span>64K<span class=\"token punctuation\">(</span>2560K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5779K-<span class=\"token operator\">></span>5802K<span class=\"token punctuation\">(</span>9728K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007213</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 64K-<span class=\"token operator\">></span>32K<span class=\"token punctuation\">(</span>1536K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5802K-<span class=\"token operator\">></span>5770K<span class=\"token punctuation\">(</span>8704K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010992</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 32K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>1536K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 5738K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 5770K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>8704K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0030299</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 0K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2048K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4427K<span class=\"token punctuation\">(</span>9216K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007654</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>PSYoungGen: 0K-<span class=\"token operator\">></span>0K<span class=\"token punctuation\">(</span>2048K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>ParOldGen: 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>7168K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4427K-<span class=\"token operator\">></span>4408K<span class=\"token punctuation\">(</span>9216K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0056029</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\tat ParallelGC.main<span class=\"token punctuation\">(</span>ParallelGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"50\"></td><td><pre> PSYoungGen      total 2048K, used 41K <span class=\"token punctuation\">[</span>0x00000000ffd00000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  eden space 1024K, <span class=\"token number\">4</span>% used <span class=\"token punctuation\">[</span>0x00000000ffd00000,0x00000000ffd0a428,0x00000000ffe00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  from space 1024K, <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ffe00000,0x00000000ffe00000,0x00000000fff00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  to   space 1024K, <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000fff00000,0x00000000fff00000,0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre> ParOldGen       total 7168K, used 4408K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ffd00000, 0x00000000ffd00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  object space 7168K, <span class=\"token number\">61</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000,0x00000000ffa4e218,0x00000000ffd00000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre> Metaspace       used 3042K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h5 id=\"46-并发垃圾收集器cms\"><a class=\"anchor\" href=\"#46-并发垃圾收集器cms\">#</a> 4.6 并发垃圾收集器 CMS</h5>\n<h6 id=\"461-cms基本概念\"><a class=\"anchor\" href=\"#461-cms基本概念\">#</a> 4.6.1 CMS 基本概念</h6>\n<ul>\n<li>CMS 全程 Concurrent Mark Sweep，是一款并发的、使用标记清除算法的垃圾回收器；</li>\n<li>CMS 回收器是针对老年代进行垃圾回收，它在某些阶段尽量与工作线程一起运行，以获取最短响应时间，减少 STW 时长（200ms 以内），提升响应速度，是互联网系统上较佳的回收算法；</li>\n<li>通过 - XX:+UseConcMarkSweepGC 参数启用老年代 CMS 回收器，会同时激活年轻代的 ParNEW 回收器；</li>\n</ul>\n<h6 id=\"462-cms运行示意图\"><a class=\"anchor\" href=\"#462-cms运行示意图\">#</a> 4.6.2 CMS 运行示意图</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XeTE8CT.jpeg\" alt=\"4.jpg\" /></p>\n<ul>\n<li>CMS 优点：低停顿，并发执行；</li>\n<li>CMS 缺点：\n<ul>\n<li>并发执行对 CPU 资源压力大；</li>\n<li>无法处理在处理过程中产生的垃圾；</li>\n<li>采用标记清除算法会导致大量碎片，从而在分配大对象时，可能会触发 FullGC;</li>\n</ul>\n</li>\n</ul>\n<h6 id=\"463-cms-gc代码测试案例\"><a class=\"anchor\" href=\"#463-cms-gc代码测试案例\">#</a> 4.6.3 CMS GC 代码测试案例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 1. 编写 java 代码 GC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat CMSGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.util.UUID<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> *  *************************************************</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"8\"></td><td><pre> *  思路：while循环中不断拼接字符串，直到oom异常</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> *   <span class=\"token function\">java</span> <span class=\"token parameter variable\">-Xms10m</span> <span class=\"token parameter variable\">-Xmx10m</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> *    <span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> CMSGC</pre></td></tr><tr><td data-num=\"11\"></td><td><pre> *</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> *     *************************************************</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> *     */</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>public class CMSGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\tpublic static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\tString str <span class=\"token operator\">=</span> <span class=\"token string\">\"Oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t\tstr <span class=\"token operator\">+=</span> str + UUID.randomUUID<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t\tstr.intern<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac CMSGC.java \t\t\t</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 2. 执行 java 代码，指定对应的 GC 收集器</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># 使用年轻代 ParNewGC 默认激活老年代 ConcMarkSweepGC</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms10m -Xmx10m -XX:+UseConcMarkSweepGC -XX:+PrintGCDetails -XX:+PrintCommandLineFlags -cp . CMSGC</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span><span class=\"token number\">10485760</span> <span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span><span class=\"token number\">3497984</span> <span class=\"token parameter variable\">-XX:MaxTenuringThreshold</span><span class=\"token operator\">=</span><span class=\"token number\">6</span> <span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span><span class=\"token number\">3497984</span> <span class=\"token parameter variable\">-XX:OldPLABSize</span><span class=\"token operator\">=</span><span class=\"token number\">16</span> <span class=\"token parameter variable\">-XX:OldSize</span><span class=\"token operator\">=</span><span class=\"token number\">6987776</span> <span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+UseCompressedClassPointers</span> <span class=\"token parameter variable\">-XX:+UseCompressedOops</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2747K-<span class=\"token operator\">></span>320K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0023735</span> secs<span class=\"token punctuation\">]</span> 2747K-<span class=\"token operator\">></span>1159K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0024383</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2341K-<span class=\"token operator\">></span>116K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0018810</span> secs<span class=\"token punctuation\">]</span> 3181K-<span class=\"token operator\">></span>2261K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019107</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2794K-<span class=\"token operator\">></span>58K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0009690</span> secs<span class=\"token punctuation\">]</span> 4938K-<span class=\"token operator\">></span>3514K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0010009</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 1424K-<span class=\"token operator\">></span>14K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007894</span> secs<span class=\"token punctuation\">]</span> 4880K-<span class=\"token operator\">></span>4783K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008156</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 4768K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 7460K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004243</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew <span class=\"token punctuation\">(</span>promotion failed<span class=\"token punctuation\">)</span>: 2692K-<span class=\"token operator\">></span>2681K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004579</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>CMS<span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.002 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"38\"></td><td><pre> <span class=\"token punctuation\">(</span>concurrent mode failure<span class=\"token punctuation\">)</span>: 4768K-<span class=\"token operator\">></span>3778K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0040684</span> secs<span class=\"token punctuation\">]</span> 7460K-<span class=\"token operator\">></span>3778K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3008K-<span class=\"token operator\">></span>3008K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0046737</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2678K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0007443</span> secs<span class=\"token punctuation\">]</span> 6456K-<span class=\"token operator\">></span>6408K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008044</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 6406K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 9031K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0003723</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.001 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-abortable-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-abortable-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Final Remark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>YG occupancy: <span class=\"token number\">2679</span> K <span class=\"token punctuation\">(</span><span class=\"token number\">3072</span> K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Rescan <span class=\"token punctuation\">(</span>parallel<span class=\"token punctuation\">)</span> , <span class=\"token number\">0.0010492</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>weak refs processing, <span class=\"token number\">0.0000088</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>class unloading, <span class=\"token number\">0.0002491</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub symbol table, <span class=\"token number\">0.0003293</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub string table, <span class=\"token number\">0.0002142</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-remark: 6406K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 9085K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0019372</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>ParNew: 2679K-<span class=\"token operator\">></span>2K<span class=\"token punctuation\">(</span>3072K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0008976</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>CMS: 5749K-<span class=\"token operator\">></span>4433K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0029519</span> secs<span class=\"token punctuation\">]</span> 5805K-<span class=\"token operator\">></span>4433K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0038988</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>Full GC <span class=\"token punctuation\">(</span>Allocation Failure<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>CMS: 4433K-<span class=\"token operator\">></span>4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0027747</span> secs<span class=\"token punctuation\">]</span> 4433K-<span class=\"token operator\">></span>4414K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token punctuation\">[</span>Metaspace: 3009K-<span class=\"token operator\">></span>3009K<span class=\"token punctuation\">(</span>1056768K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>, <span class=\"token number\">0.0028025</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Initial Mark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-initial-mark: 4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4468K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0004950</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-mark-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Exception <span class=\"token keyword\">in</span> thread <span class=\"token string\">\"main\"</span> <span class=\"token punctuation\">[</span>CMS-concurrent-mark: <span class=\"token number\">0.001</span>/0.001 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>java.lang.OutOfMemoryError: Java heap space</pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-preclean: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">[</span>GC <span class=\"token punctuation\">(</span>CMS Final Remark<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>YG occupancy: <span class=\"token number\">54</span> K <span class=\"token punctuation\">(</span><span class=\"token number\">3072</span> K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>Rescan <span class=\"token punctuation\">(</span>parallel<span class=\"token punctuation\">)</span> , <span class=\"token number\">0.0006640</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>weak refs processing, <span class=\"token number\">0.0000071</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>class unloading, <span class=\"token number\">0.0002738</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub symbol table, <span class=\"token number\">0.0003376</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span>scrub string table, <span class=\"token number\">0.0002713</span> secs<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span> CMS-remark: 4414K<span class=\"token punctuation\">(</span>6848K<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> 4468K<span class=\"token punctuation\">(</span>9920K<span class=\"token punctuation\">)</span>, <span class=\"token number\">0.0016334</span> secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.01</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-sweep: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset-start<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>CMS-concurrent-reset: <span class=\"token number\">0.000</span>/0.000 secs<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>Times: <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> <span class=\"token assign-left variable\">sys</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span>, <span class=\"token assign-left variable\">real</span><span class=\"token operator\">=</span><span class=\"token number\">0.00</span> secs<span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>\tat java.util.Arrays.copyOf<span class=\"token punctuation\">(</span>Arrays.java:3332<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>\tat java.lang.AbstractStringBuilder.ensureCapacityInternal<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:124<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\tat java.lang.AbstractStringBuilder.append<span class=\"token punctuation\">(</span>AbstractStringBuilder.java:448<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:142<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\tat java.lang.StringBuilder.append<span class=\"token punctuation\">(</span>StringBuilder.java:137<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\tat CMSGC.main<span class=\"token punctuation\">(</span>CMSGC.java:17<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Heap</pre></td></tr><tr><td data-num=\"72\"></td><td><pre> par new generation   total 3072K, used 109K <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff950000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  eden space 2752K,   <span class=\"token number\">3</span>% used <span class=\"token punctuation\">[</span>0x00000000ff600000, 0x00000000ff61b5a8, 0x00000000ff8b0000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  from space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff900000, 0x00000000ff900000, 0x00000000ff950000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  to   space 320K,   <span class=\"token number\">0</span>% used <span class=\"token punctuation\">[</span>0x00000000ff8b0000, 0x00000000ff8b0000, 0x00000000ff900000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre> concurrent mark-sweep generation total 6848K, used 477K <span class=\"token punctuation\">[</span>0x00000000ff950000, 0x0000000100000000, 0x0000000100000000<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre> Metaspace       used 3042K, capacity 4486K, committed 4864K, reserved 1056768K</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  class space    used 330K, capacity 386K, committed 512K, reserved 1048576K</pre></td></tr></table></figure><h4 id=\"五-jvm性能调优实践\"><a class=\"anchor\" href=\"#五-jvm性能调优实践\">#</a> 五、JVM 性能调优实践</h4>\n<ul>\n<li>调优一般包含多个层次，如：架构调优、代码调优、数据库调优、JVM 调优、操作系统调优；</li>\n<li>架构调优和代码调优是 JVM 调优的基础；</li>\n<li>当我们的架构和代码都已经调优后，还不能满足业务需求，才需要进行 JVM 调优；</li>\n</ul>\n<h5 id=\"51-什么是jvm调优\"><a class=\"anchor\" href=\"#51-什么是jvm调优\">#</a> 5.1 什么是 JVM 调优</h5>\n<ul>\n<li>\n<p>既然要进行 JVM 调优，那么就一定需要量化指标；</p>\n</li>\n<li>\n<p>JVM 调优原则：尽可能使用较小的内存和 CPU 来让 JAVA 程序获得更高的吞吐量以及较低的延迟；</p>\n<ul>\n<li>吞吐量：是指不考虑垃圾收集器引起的停顿时间或内存消耗，应用达到的最高性能指标</li>\n<li>低延迟：GC 停顿时间端，以及 GC 触发频率低；</li>\n<li>低内存：比较低的内存空间，能够获取程序的稳定运行；</li>\n</ul>\n</li>\n<li>\n<p>值得注意的是：任何一个指标性能的提高，几乎都是以牺牲其他性能指标的损耗为代价，两者不可兼得，具体需要根据业务的重要性做权衡；</p>\n</li>\n</ul>\n<h5 id=\"52-何时不需要jvm调优\"><a class=\"anchor\" href=\"#52-何时不需要jvm调优\">#</a> 5.2 何时不需要 JVM 调优</h5>\n<ul>\n<li>MinorGC 执行时间不到 50ms;</li>\n<li>MinorGC 执行不频繁，约 10s 一次；</li>\n<li>FullGC 执行时间不到 1s;</li>\n</ul>\n<h5 id=\"53-何时需要jvm调优\"><a class=\"anchor\" href=\"#53-何时需要jvm调优\">#</a> 5.3 何时需要 JVM 调优</h5>\n<p>当运行业务代码出现如下情况，则需要考虑进行 JVM 调优，但前提是代码没有办法进行优化了：</p>\n<ul>\n<li>FullGC 次数频繁：FullGC 如果很频繁的话，基本上可以肯定是分配的内存不够用；</li>\n<li>GC 停顿时间过长 1s：GC 过长会导致 STM 时间过长，肯定是内存堆空间分配不合理；</li>\n<li>应用出现 OOM 内存溢出；</li>\n<li>系统吞吐量与响应性能不高或持续下降：一般是 GC 停顿问题造成；</li>\n</ul>\n<h5 id=\"54-jvm调优常规方法\"><a class=\"anchor\" href=\"#54-jvm调优常规方法\">#</a> 5.4 JVM 调优常规方法</h5>\n<p>JVM 调优是一个手段，但是并不是定所有问题都可以通过 JVM 进行调优解决；</p>\n<ul>\n<li>大多数的 JAVA 应用不需要进行 JVM 调优；\n<ul>\n<li>首先项目还没有复杂到需要做 JVM 调优的程序，而且现在的机器内存都很大，可以尽情使用；</li>\n<li>其次 JVM 调优有一定难度，需要有相应工程调优经验，否则没有作用，或者造成性能反而下降；</li>\n</ul>\n</li>\n<li>大多数导致 GC 问题的原因是代码层面的问题导致；</li>\n<li>选择合适的 GC 收集器，并设置合理的堆空间参数；</li>\n<li>减少使用全局变量和大对象，减少创建对象的数量；\n<ul>\n<li>全局变量几乎不会被回收；</li>\n<li>大对象会直接进入老年代，从而造成 MajorGC；</li>\n</ul>\n</li>\n<li>分析 GC 日志优化代码比优化 JVM 参数效果更好；</li>\n<li>优先架构调优和代码调优，JVM 优化优先级放到最低；</li>\n<li>JVM 堆设置，一般通过 - Xms、-Xmx 限定最小值、最大值，为了避免垃圾收集器在最小、最大之间收缩堆而产生额外的时间和资源开销，通常把最大、最小设置为相同的值；</li>\n</ul>\n<h5 id=\"55-jvm各区域的默认值\"><a class=\"anchor\" href=\"#55-jvm各区域的默认值\">#</a> 5.5 JVM 各区域的默认值</h5>\n<p>参考链接：<a href=\"https://blog.csdn.net/qq_27184497/article/details/119055669\">https://blog.csdn.net/qq_27184497/article/details/119055669</a></p>\n<ul>\n<li>堆空间初始值：由 - Xms 指定，默认是物理内存的 1/64。比如电脑内存是 16G，由此得出公式为：16*1024/64=256M</li>\n<li>堆空间最大值：由 - Xmx 指定，默认是物理内存的 1/4。比如我电脑内存是 16G，由此得出公式为：16/4=4G</li>\n<li>老年代 ：占用整个堆内存 2/3 的空间，比如我目前堆内存是 4G，由此得出公式为：4*1024*(2/3)≈ 2730</li>\n<li>新生代：占用整个堆的 1/3 的空间；实际可用的是 4*1024*(1/3)≈ 1365 ，另外新生代实际可用的内存为 1365*80% ;</li>\n</ul>\n<p>新生代通过以下参数设置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>256m      <span class=\"token comment\">#设置新生代初始内存</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>256m   <span class=\"token comment\">#设置新生代最大内存</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-Xmn256m</span>             <span class=\"token comment\">#将 NewSize 与 MaxNewSize 设为一致 256m</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/wprIX9J.png\" alt=\"1.png\" /></p>\n<p>可以自行指定的参数：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token parameter variable\">-Xms500M</span>  \t\t\t\t\t  <span class=\"token comment\">#指定初始堆空间大小；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token parameter variable\">-Xmx500M</span> \t\t\t\t\t  <span class=\"token comment\">#最大的堆空间大小；</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token parameter variable\">-XX:NewRatio</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t\t\t      <span class=\"token comment\">#调整新生代和老年的比率； \t1:1，  默认是 1:2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">6</span>  \t      <span class=\"token comment\">#调整年轻代中 Eden 和 Sur 比率： 6:2:2  默认 8:1:1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#参数示例</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token parameter variable\">-Xms500M</span>  <span class=\"token parameter variable\">-Xmx500M</span> <span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">6</span>  <span class=\"token parameter variable\">-XX:NewRatio</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>新生代：\t250MB</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Eden：\t  150M\t\t    <span class=\"token number\">60</span>%</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>From：\t  50M\t\t\t<span class=\"token number\">20</span>%</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>To：  \t  50M\t\t\t<span class=\"token number\">20</span>%</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>老年代：\t250MB</pre></td></tr></table></figure><h5 id=\"56-jvm优化代码示例一\"><a class=\"anchor\" href=\"#56-jvm优化代码示例一\">#</a> 5.6 JVM 优化代码示例一</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 示例代码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat MoreMinorGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>@SuppressWarnings<span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>public class MoreMinorGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    private static void minorGC<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   // 在 Eden 区域放入一个 1MB 的对象</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        x <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  // 会导致前两个 1MB 的对象成为垃圾对象</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        x <span class=\"token operator\">=</span> null<span class=\"token punctuation\">;</span>   // 将之前的三个 1MB 的对象都变成垃圾对象</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        // 这句代码就会触发年轻代的 Minor GC</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        byte<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> y <span class=\"token operator\">=</span> new byte<span class=\"token punctuation\">[</span><span class=\"token number\">2</span> * <span class=\"token number\">1024</span> * <span class=\"token number\">1024</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>   // 在 Eden 区中分配一个 2MB 的对象</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        Thread.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    public static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            minorGC<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#2. 编译代码</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac MoreMinorGC.java</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#3. 运行代码</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java \\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>5M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>5M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>10M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>10M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">#4. 代码运行参数描述</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>5M                           <span class=\"token comment\">#新生代初始内存</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>5M                   <span class=\"token comment\">#新生代最大内存</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>10M             <span class=\"token comment\">#初始堆空间 Xms</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>10M               <span class=\"token comment\">#最大堆空间 Xmx</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span>                     <span class=\"token comment\">#Eden、Survivore from、Survivore to 比例为 8:1:1</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span>                     <span class=\"token comment\">#新生代使用 ParNewGC</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span>     <span class=\"token comment\">#老年代使用 CMSGC</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span>                     <span class=\"token comment\">#打印 GC 日志</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span>   <span class=\"token comment\">#打印 GC 日志</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#5. 追踪 GC</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token number\">8325</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token number\">8361</span> Jps</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8325</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token number\">512.0</span>  <span class=\"token number\">512.0</span>   <span class=\"token number\">0.0</span>    <span class=\"token number\">0.0</span>    <span class=\"token number\">4096.0</span>   <span class=\"token number\">2048.0</span>    <span class=\"token number\">5120.0</span>     <span class=\"token number\">3320.4</span>   <span class=\"token number\">4864.0</span> <span class=\"token number\">2479.2</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">264.9</span>     <span class=\"token number\">199</span>    <span class=\"token number\">0.057</span>  <span class=\"token number\">49</span>      <span class=\"token number\">0.028</span>    <span class=\"token number\">0.08</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\">#6 将程序运行的堆内存扩大 10 倍</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java \\</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token parameter variable\">-XX:NewSize</span><span class=\"token operator\">=</span>50M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxNewSize</span><span class=\"token operator\">=</span>50M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token parameter variable\">-XX:InitialHeapSize</span><span class=\"token operator\">=</span>100M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token parameter variable\">-XX:MaxHeapSize</span><span class=\"token operator\">=</span>100M <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token parameter variable\">-XX:SurvivorRatio</span><span class=\"token operator\">=</span><span class=\"token number\">8</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">#7. 追踪 GC，发现 YGC 没有那么频繁了，同时没有产生 FGC，GCT 时间明显变短了</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token number\">8400</span> MoreMinorGC</pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token number\">8414</span> Jps</pre></td></tr><tr><td data-num=\"81\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8400</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token number\">5120.0</span> <span class=\"token number\">5120.0</span> <span class=\"token number\">1414.5</span>  <span class=\"token number\">0.0</span>   <span class=\"token number\">40960.0</span>  <span class=\"token number\">39715.8</span>   <span class=\"token number\">51200.0</span>      <span class=\"token number\">0.0</span>     <span class=\"token number\">4864.0</span> <span class=\"token number\">2479.2</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">264.9</span>       <span class=\"token number\">2</span>    <span class=\"token number\">0.008</span>   <span class=\"token number\">0</span>      <span class=\"token number\">0.000</span>    <span class=\"token number\">0.00</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token comment\">#8.GC 参数描述</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>S0C：Surivor区S0的大小</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>S1C：Surivor区S1的大小</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>S0U：Surivor区S0的使用大小</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>S1U：Surivor区S1的使用大小</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>EC： Eden区的大小</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>EU：Eden区的使用大小</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>OC：老年代大小</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>OU：老年代使用大小</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>MC：方法区大小</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>MU：方法区使用大小</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>CCSC:压缩类空间大小</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>CCSU:压缩类空间使用大小</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>YGC：年轻代垃圾回收次数</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>YGCT：年轻代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>FGC：老年代垃圾回收次数</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>FGCT：老年代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>GCT：垃圾回收消耗总时间</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>单位：KB</pre></td></tr></table></figure><h5 id=\"57-jvm优化代码示例二fullgc\"><a class=\"anchor\" href=\"#57-jvm优化代码示例二fullgc\">#</a> 5.7 JVM 优化代码示例二 FullGC</h5>\n<p>FullGc：清理整个内存堆，即包括年轻的也包括老年代</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 示例代码</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat MoreFullGC.java </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">import</span> java.time.LocalDate<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">import</span> java.util.ArrayList<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">import</span> java.util.List<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.ScheduledThreadPoolExecutor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.ThreadPoolExecutor<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">import</span> java.util.concurrent.TimeUnit<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/*</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>优化前</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token parameter variable\">-Xms20M</span> <span class=\"token parameter variable\">-Xmx20M</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintGCTimeStamps</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>优化后</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token parameter variable\">-Xms200M</span> <span class=\"token parameter variable\">-Xmx200M</span> <span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token parameter variable\">-XX:+PrintGCTimeStamps</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>*/</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>@SuppressWarnings<span class=\"token punctuation\">(</span><span class=\"token string\">\"all\"</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>public class MoreFullGC <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    private static class Oldxu <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        private String name <span class=\"token operator\">=</span> <span class=\"token string\">\"oldxu\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        private int age <span class=\"token operator\">=</span> <span class=\"token number\">18</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        private String gender <span class=\"token operator\">=</span> <span class=\"token string\">\"male\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        private LocalDate birthday <span class=\"token operator\">=</span> LocalDate.MAX<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        public void <span class=\"token function-name function\">func</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            //</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    /** 线程池 */</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    private static final ScheduledThreadPoolExecutor executor <span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            new ScheduledThreadPoolExecutor<span class=\"token punctuation\">(</span><span class=\"token number\">50</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    new ThreadPoolExecutor.DiscardOldestPolicy<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    private static void processOldxu<span class=\"token punctuation\">(</span>List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> Oldxu<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        Oldxu.forEach<span class=\"token punctuation\">(</span>i -<span class=\"token operator\">></span> executor.scheduleWithFixedDelay<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                i::func, <span class=\"token number\">2</span>, <span class=\"token number\">3</span>, TimeUnit.<span class=\"token environment constant\">SECONDS</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        <span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    private static List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> getAllOldxu<span class=\"token punctuation\">(</span>int count<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        List<span class=\"token operator\">&lt;</span>Oldxu<span class=\"token operator\">></span> Oldxu <span class=\"token operator\">=</span> new ArrayList<span class=\"token operator\">&lt;></span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>int i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">!=</span> count<span class=\"token punctuation\">;</span> ++i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            Oldxu.add<span class=\"token punctuation\">(</span>new Oldxu<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        <span class=\"token builtin class-name\">return</span> Oldxu<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    public static void main<span class=\"token punctuation\">(</span>String<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> args<span class=\"token punctuation\">)</span> throws InterruptedException <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        executor.setMaximumPoolSize<span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            processOldxu<span class=\"token punctuation\">(</span>getAllOldxu<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            Thread.sleep<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#2. 编译代码</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># javac MoreFullGC.java</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token comment\">#3. 运行代码</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms20M -Xmx20M \\</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreFullGC</pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token comment\">#4. 追踪 GC</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token number\">8492</span> MoreFullGC</pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token number\">8557</span> Jps</pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8492</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token number\">640.0</span>  <span class=\"token number\">640.0</span>   <span class=\"token number\">0.0</span>    <span class=\"token number\">0.0</span>    <span class=\"token number\">5504.0</span>   <span class=\"token number\">4440.6</span>   <span class=\"token number\">13696.0</span>    <span class=\"token number\">13696.0</span>   <span class=\"token number\">4864.0</span> <span class=\"token number\">3916.4</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">433.9</span>      <span class=\"token number\">10</span>    <span class=\"token number\">0.036</span>  <span class=\"token number\">53</span>      <span class=\"token number\">0.182</span>    <span class=\"token number\">0.21</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">#5. 将程序运行的堆内存扩大 10 倍</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 java<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -Xms200M -Xmx200M \\</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseParNewGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre><span class=\"token parameter variable\">-XX:+UseConcMarkSweepGC</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintGCDetails</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre><span class=\"token parameter variable\">-XX:+PrintCommandLineFlags</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token parameter variable\">-cp</span> <span class=\"token builtin class-name\">.</span> MoreFullGC</pre></td></tr><tr><td data-num=\"89\"></td><td><pre></pre></td></tr><tr><td data-num=\"90\"></td><td><pre><span class=\"token comment\">#6. 追踪 GC，发现 YGC 没有那么频繁了，同时没有产生 FGC，GCT 时间明显变短了</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jps</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre><span class=\"token number\">8696</span> Jps</pre></td></tr><tr><td data-num=\"93\"></td><td><pre><span class=\"token number\">6553</span> Bootstrap</pre></td></tr><tr><td data-num=\"94\"></td><td><pre><span class=\"token number\">8633</span> MoreFullGC</pre></td></tr><tr><td data-num=\"95\"></td><td><pre><span class=\"token number\">6574</span> plugin-core.jar</pre></td></tr><tr><td data-num=\"96\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># jstat -gc 8633</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre> S0C    S1C    S0U    S1U      EC       EU        OC         OU       MC     MU    CCSC   CCSU   YGC     YGCT    FGC    FGCT     GCT   </pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token number\">6784.0</span> <span class=\"token number\">6784.0</span>  <span class=\"token number\">0.0</span>   <span class=\"token number\">993.6</span>  <span class=\"token number\">54656.0</span>  <span class=\"token number\">38837.2</span>   <span class=\"token number\">136576.0</span>     <span class=\"token number\">0.0</span>     <span class=\"token number\">4864.0</span> <span class=\"token number\">3906.9</span> <span class=\"token number\">512.0</span>  <span class=\"token number\">436.1</span>       <span class=\"token number\">1</span>    <span class=\"token number\">0.009</span>   <span class=\"token number\">0</span>      <span class=\"token number\">0.000</span>    <span class=\"token number\">0.00</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre></pre></td></tr><tr><td data-num=\"100\"></td><td><pre><span class=\"token comment\">#7.GC 参数描述</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>S0C：Surivor区S0的大小</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>S1C：Surivor区S1的大小</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>S0U：Surivor区S0的使用大小</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>S1U：Surivor区S1的使用大小</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>EC： Eden区的大小</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>EU：Eden区的使用大小</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>OC：老年代大小</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>OU：老年代使用大小</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>MC：方法区大小</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>MU：方法区使用大小</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>CCSC:压缩类空间大小</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>CCSU:压缩类空间使用大小</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>YGC：年轻代垃圾回收次数</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>YGCT：年轻代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>FGC：老年代垃圾回收次数</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>FGCT：老年代垃圾回收消耗时间</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>GCT：垃圾回收消耗总时间</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>单位：KB</pre></td></tr></table></figure><h4 id=\"六-tomcat开启jmx监控详解\"><a class=\"anchor\" href=\"#六-tomcat开启jmx监控详解\">#</a> 六、 Tomcat 开启 JMX 监控详解</h4>\n<h5 id=\"61-windows安装java\"><a class=\"anchor\" href=\"#61-windows安装java\">#</a> 6.1 Windows 安装 JAVA</h5>\n<p>参考链接：<a href=\"https://blog.csdn.net/qq_39652397/article/details/124045623\">https://blog.csdn.net/qq_39652397/article/details/124045623</a></p>\n<h5 id=\"62-tomcat启动jmx远程管理端口\"><a class=\"anchor\" href=\"#62-tomcat启动jmx远程管理端口\">#</a> 6.2 Tomcat 启动 JMX 远程管理端口</h5>\n<pre><code>[root@web01 ~]# vim /soft/tomcat/bin/catalina.sh\n#!/bin/sh\n\nCATALINA_OPTS=&quot;$CATALINA_OPTS \\\n-Dcom.sun.management.jmxremote \\\n-DJava.rmi.server.hostname=192.168.40.101 \\\n-Dcom.sun.management.jmxremote.port=9999 \\\n-Dcom.sun.management.jmxremote.ssl=false \\\n-Dcom.sun.management.jmxremote.authenticate=false&quot;\n...\n[root@web01 ~]# systemctl stop tomcat &amp;&amp; systemctl start tomcat\n[root@web01 ~]# netstat -lntp|grep java\ntcp6       0      0 :::9999                 :::*                    LISTEN      9725/java           \ntcp6       0      0 :::8080                 :::*                    LISTEN      9725/java \n</code></pre>\n<h5 id=\"63-通过jconsole监控jvm\"><a class=\"anchor\" href=\"#63-通过jconsole监控jvm\">#</a> 6.3 通过 Jconsole 监控 jvm</h5>\n<p>Jconsole-&gt; 远程进程 192.168.40.101:9999-&gt; 连接</p>\n<h5 id=\"64-通过jvisualvm监控jvm\"><a class=\"anchor\" href=\"#64-通过jvisualvm监控jvm\">#</a> 6.4 通过 Jvisualvm 监控 jvm</h5>\n<p>1、安装 visualvm<br />\n 在高版本 JDK（大于 1.8 或后期更新的 1.8 版本）中已经不会再自动集成 VisualVM，需手动安装；</p>\n<p>2、添加远程主机</p>\n<p>visualvm-&gt;remote-&gt;ADD remote host-&gt;192.168.40.101-&gt;ADD JMX connection-&gt;192.168.40.101:9999</p>\n<p>3、安装 GC 插件</p>\n<p>Tools-&gt;plugins-&gt;Auvilable pluginS-&gt;Visual GC-&gt;install</p>\n",
            "tags": [
                "Tomcat"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/4201058646.html",
            "url": "http://ixuyong.cn/posts/4201058646.html",
            "title": "Tomcat配置管理实践",
            "date_published": "2025-06-08T02:51:48.000Z",
            "content_html": "<h3 id=\"tomcat配置管理实践\"><a class=\"anchor\" href=\"#tomcat配置管理实践\">#</a> Tomcat 配置管理实践</h3>\n<h4 id=\"一-oraclejdk安装\"><a class=\"anchor\" href=\"#一-oraclejdk安装\">#</a> 一、OracleJdk 安装</h4>\n<p>OracleJdk 下载地址：<a href=\"https://www.oracle.com/java/technologies/downloads/#java8\">https://www.oracle.com/java/technologies/downloads/#java8</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz -C /usr/local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h4 id=\"二-tomcat安装\"><a class=\"anchor\" href=\"#二-tomcat安装\">#</a> 二、Tomcat 安装</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft &amp;&amp; cd /soft</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.106/bin/apache-tomcat-9.0.106.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf apache-tomcat-9.0.106.tar.gz -C /soft</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># /soft/tomcat/bin/startup.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1765</span>/java           </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1765</span>/javaa</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#Tomcat 启停配置文件</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># /usr/lib/systemd/system/tomcat.service</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Apache Tomcat</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>forking</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>JAVA_HOME<span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_HOME<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span>CATALINA_BASE<span class=\"token operator\">=</span>/soft/tomcat</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/soft/tomcat/bin/startup.sh</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">ExecStop</span><span class=\"token operator\">=</span>/soft/tomcat/bin/shutdown.sh</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat      </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1842</span>/java           </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1842</span>/java</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Vc1v1lK.jpeg\" alt=\"Snipaste_2025-06-14_14-57-42.jpg\" /></p>\n<h4 id=\"三-tomcat配置\"><a class=\"anchor\" href=\"#三-tomcat配置\">#</a> 三、Tomcat 配置</h4>\n<h5 id=\"31-tomcat目录结构\"><a class=\"anchor\" href=\"#31-tomcat目录结构\">#</a> 3.1 Tomcat 目录结构</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>bin\t\t：  二进制可执行（脚本文件 windwos版bat、linux版sh）</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>conf\t：  配置文件，主配置是server.xml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>lib\t\t：  都是一些java语言编写的jar包，这些都需要被调用，才能执行； module （jar、war）</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>logs\t：  tomcat的日志存放位置，可修改；</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>temp\t：  tomcat的临时目录；</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>webapps ：  相当于nginx中  root /soft/tomcat/webapps/     /soft/tomcat/webapps/ROOT</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>work\t<span class=\"token builtin class-name\">:</span>   tomcat的一个缓存目录；（java代码，编译为class字节码对外提供；）</pre></td></tr></table></figure><h5 id=\"32-tomcat配置文件说明\"><a class=\"anchor\" href=\"#32-tomcat配置文件说明\">#</a> 3.2 Tomcat 配置文件说明</h5>\n<ul>\n<li>server：表示一个 tomcat 实例；</li>\n<li>Listener：监听器；</li>\n<li>connector：连接器，支持 http、https、ajp 等协议请求；</li>\n<li>service：将 connector 与 engine 关联的组件；</li>\n<li>engine：具体 http、https 的请求与响应； （Nginx 中  http {}）</li>\n<li>host：与用户请求的 Host 字段进行比对；哪个 Host 匹配则哪个处理，如没有符合的则交给默认的 defaultHost 处理</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--关闭tomcat的端口--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>Server <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8005\"</span> <span class=\"token assign-left variable\">shutdown</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHUTDOWN\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--监听器 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.startup.VersionLoggerListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.AprLifecycleListener\"</span> <span class=\"token assign-left variable\">SSLEngine</span><span class=\"token operator\">=</span><span class=\"token string\">\"on\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.JreMemoryLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Listener <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.core.ThreadLocalLeakPreventionListener\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--全局资源限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token operator\">&lt;</span>GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Resource <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span> <span class=\"token assign-left variable\">auth</span><span class=\"token operator\">=</span><span class=\"token string\">\"Container\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.UserDatabase\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              <span class=\"token assign-left variable\">description</span><span class=\"token operator\">=</span><span class=\"token string\">\"User database that can be updated and saved\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              <span class=\"token assign-left variable\">factory</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.users.MemoryUserDatabaseFactory\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>              <span class=\"token assign-left variable\">pathname</span><span class=\"token operator\">=</span><span class=\"token string\">\"conf/tomcat-users.xml\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/GlobalNamingResources<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--连接器--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token operator\">&lt;</span>Service <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Connector <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token string\">\"8080\"</span> <span class=\"token assign-left variable\">protocol</span><span class=\"token operator\">=</span><span class=\"token string\">\"HTTP/1.1\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>               <span class=\"token assign-left variable\">connectionTimeout</span><span class=\"token operator\">=</span><span class=\"token string\">\"20000\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>               <span class=\"token assign-left variable\">redirectPort</span><span class=\"token operator\">=</span><span class=\"token string\">\"8443\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--引擎--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token operator\">&lt;</span>Engine <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"Catalina\"</span> <span class=\"token assign-left variable\">defaultHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--调用限制--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.LockOutRealm\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Realm <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.realm.UserDatabaseRealm\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>               <span class=\"token assign-left variable\">resourceName</span><span class=\"token operator\">=</span><span class=\"token string\">\"UserDatabase\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Realm<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--虚拟主机--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"webapps\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    <span class=\"token operator\">&lt;</span>/Engine<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  <span class=\"token operator\">&lt;</span>/Service<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">&lt;</span>/Server<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"33tomcat请求流程\"><a class=\"anchor\" href=\"#33tomcat请求流程\">#</a> 3.3Tomcat 请求流程</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZU2ezrN.jpeg\" alt=\"2.jpg\" /></p>\n<p>假设来自用户的请求为：<a href=\"http://tomcat.hmallleasing.com:8080/index.jsp\">http://tomcat.hmallleasing.com:8080/index.jsp</a></p>\n<ul>\n<li>1. 服务端运行 Tomcat 应用，监听在本机的 8080 端口，等待连接；</li>\n<li>2. 浏览器发送 http 请求，并且请求服务端的 8080 端口，也就是 Tomcat 进程；</li>\n<li>3. 服务端通过 http connector 连接器获取请求，然后通过 service 将请求交给符合条件的 engine;</li>\n<li><a href=\"http://4.xn--Enginetomcat-4l2xh11ksszesu1a.hmallleasing.com:8080/index.jsp%EF%BC%8C%E9%81%8D%E5%8E%86%E5%AE%83%E6%89%80%E6%9C%89%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BAHost;\">4.Engine 获得请求 tomcat.hmallleasing.com:8080/index.jsp，遍历它所有虚拟主机 Host;</a></li>\n<li>5. 如果 Engine 匹配不到对应的 Host，就把请求交给 Engine 中的 defaultHost 处理；</li>\n<li>6. 如果 Engine 匹配到对应的 Host,  则提取该 Host 中指定的 appBase（代码存储路径）；</li>\n<li>7. 最后 Engine 将解析后的结果返回给 connector，connector 返回给浏览器；</li>\n</ul>\n<h5 id=\"35-tomcat与nginx对比\"><a class=\"anchor\" href=\"#35-tomcat与nginx对比\">#</a> 3.5 Tomcat 与 Nginx 对比</h5>\n<p>Nginx 中：</p>\n<ul>\n<li>http 层：只能有一个；</li>\n<li>server：可以有多个，多个表示多个站点；</li>\n<li>location：一个站点的多个 uri 的路径匹配</li>\n</ul>\n<p>Tomcat 中：</p>\n<ul>\n<li>engine：只能有一个，也是负责请求与响应的；</li>\n<li>Host：  可以有多个，多个表示多个站点；</li>\n<li>context：用来定义用户请求的 uri，将其调度到指定的目录中提取代码；</li>\n</ul>\n<h5 id=\"36-tomcat虚拟主机host\"><a class=\"anchor\" href=\"#36-tomcat虚拟主机host\">#</a> 3.6 Tomcat 虚拟主机 Host</h5>\n<ul>\n<li>name: 主机名称</li>\n<li>appBase：网站代码存放路径</li>\n<li>unpackWARs：自动解压 war 包</li>\n<li>autoDeploy：自动部署</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>创建网站代码存放路径，写入测试代码，并重启 Tomcat；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/tom1/ROOT -p</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"Tomcat Test Page\" > /code/tom1/ROOT/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ieCVXl0.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"37-tomcat虚拟主机context\"><a class=\"anchor\" href=\"#37-tomcat虚拟主机context\">#</a> 3.7 Tomcat 虚拟主机 Context</h5>\n<p>context 使用方式</p>\n<ul>\n<li>docBase: 站点存放的路径</li>\n<li>path: 访问站点的 URI 路径</li>\n<li>reloadable：修改了 jsp 文件，无需重启就可以实现显示的同步</li>\n</ul>\n<p>访问 http:/tom2.hamllleasing.com/zh-&gt; 映射 -&gt;/code/zh</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--tom1.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tom1.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/tom1\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Context <span class=\"token assign-left variable\">docBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zh\"</span> <span class=\"token assign-left variable\">path</span><span class=\"token operator\">=</span><span class=\"token string\">\"/zh\"</span> <span class=\"token assign-left variable\">reloadable</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>注意：如果设定了 context，没有创建对应目录则无法启动 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /soft/tomcat/logs/catalina.out</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tCaused by: java.lang.IllegalArgumentException: The main resource <span class=\"token builtin class-name\">set</span> specified <span class=\"token punctuation\">[</span>/code/zh<span class=\"token punctuation\">]</span> is not a directory or war file, or is not readable <span class=\"token punctuation\">(</span>it does not exist or permissions to access it are missing<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.createMainResourceSet<span class=\"token punctuation\">(</span>StandardRoot.java:758<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\tat org.apache.catalina.webresources.StandardRoot.startInternal<span class=\"token punctuation\">(</span>StandardRoot.java:715<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\tat org.apache.catalina.util.LifecycleBase.start<span class=\"token punctuation\">(</span>LifecycleBase.java:164<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>创建对应目录，写入测试代码，并重启 Tomcat</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"hello zh\" > /code/zh/index.html</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp;  systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/GoiPhZp.jpeg\" alt=\"2.jpg\" /></p>\n<h5 id=\"38-tomcat管理页面配置\"><a class=\"anchor\" href=\"#38-tomcat管理页面配置\">#</a> 3.8 Tomcat 管理页面配置</h5>\n<p>1、配置 Tomcat Bsic 认证，配置文件 /soft/tomcat/conf/tomcat-users.xml 最后添加用户，然后关联至对应资源的角色名称；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web03 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/tomcat-users.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  <span class=\"token operator\">&lt;</span>role <span class=\"token assign-left variable\">rolename</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"123456\"</span> <span class=\"token assign-left variable\">roles</span><span class=\"token operator\">=</span><span class=\"token string\">\"manager-gui,admin-gui\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>/tomcat-users<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、由于 Tomcat 仅语序本地 127.0.0.1 进行 basic 认证，如果需要其他网段通过 basic 认证，还需配置允许访问规则。找到 webapps/ 项目 / META-INF/context.xml 配置；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 修改第一个项目</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/webapps/host-manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>修改为：</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2. 修改第二个项目</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 tomcat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /soft/tomcat/webapps/manager/META-INF/context.xml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>修改后：</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">allow</span><span class=\"token operator\">=</span><span class=\"token string\">\"127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1|192\\.168\\.40\\.\\d+\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#3. 重启 tomcat</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gV1iMaz.jpeg\" alt=\"3.jpg\" /></p>\n<h4 id=\"四-tomcat部署zrlog\"><a class=\"anchor\" href=\"#四-tomcat部署zrlog\">#</a> 四、Tomcat 部署 zrlog</h4>\n<h5 id=\"41-zrlog单节点部署\"><a class=\"anchor\" href=\"#41-zrlog单节点部署\">#</a> 4.1 zrlog 单节点部署</h5>\n<h6 id=\"411-部署mysql\"><a class=\"anchor\" href=\"#411-部署mysql\">#</a> 4.1.1 部署 MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、关闭防火墙、selinux、环境配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_db01</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#2、安装 Mysql5.7</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@aizj_db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'zrlog'</span>@<span class=\"token string\">'192.168.40.%'</span> identified by <span class=\"token string\">'Superman*2023'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#3、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下：</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql <span class=\"token parameter variable\">-u</span> root -p<span class=\"token string\">\"youpass\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>mysql<span class=\"token operator\">></span>GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'Superman*2023'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#4. 创建数据库</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>mysql<span class=\"token operator\">></span> create database zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Query OK, <span class=\"token number\">1</span> row affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"412-配置tomcat虚拟主机\"><a class=\"anchor\" href=\"#412-配置tomcat虚拟主机\">#</a> 4.1.2 配置 Tomcat 虚拟主机</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--zrlog.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/zrlog\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h6 id=\"413-准备项目代码\"><a class=\"anchor\" href=\"#413-准备项目代码\">#</a> 4.1.3 准备项目代码</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /code/zrlog</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv zrlog-2.2.0-5e8a51f-release.war /code/zrlog/ROOT.war</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /code/zrlog/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ROOT.war</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hR5jFTN.jpeg\" alt=\"1.jpg\" /></p>\n<h5 id=\"42-zrlog集群部署\"><a class=\"anchor\" href=\"#42-zrlog集群部署\">#</a> 4.2 zrlog 集群部署</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">服务器名称</th>\n<th style=\"text-align:center\">服务器 IP</th>\n<th style=\"text-align:center\">服务器角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">lb01</td>\n<td style=\"text-align:center\">192.168.40.150</td>\n<td style=\"text-align:center\">Nginx</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web01</td>\n<td style=\"text-align:center\">192.168.40.7</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">web02</td>\n<td style=\"text-align:center\">192.168.40.8</td>\n<td style=\"text-align:center\">Tomcat</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">NFS</td>\n<td style=\"text-align:center\">192.168.40.32</td>\n<td style=\"text-align:center\">NFS</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">db01</td>\n<td style=\"text-align:center\">192.168.40.51</td>\n<td style=\"text-align:center\">MySQL</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">Redis</td>\n<td style=\"text-align:center\">192.168.40.41</td>\n<td style=\"text-align:center\">Redis</td>\n</tr>\n</tbody>\n</table>\n<h6 id=\"421-安装jdk\"><a class=\"anchor\" href=\"#421-安装jdk\">#</a> 4.2.1 安装 jdk</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp jdk-8u451-linux-x64.tar.gz root@192.168.40.8:/root</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u451-linux-x64.tar.gz  -C /usr/local/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_451/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#添加环境变量</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/jdk.sh</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><h6 id=\"422-安装tomcat\"><a class=\"anchor\" href=\"#422-安装tomcat\">#</a> 4.2.2 安装 Tomcat</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp  /soft root@192.168.40.8:/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rm -rf /soft/tomcat/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/apache-tomcat-9.0.106 /soft/tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp /usr/lib/systemd/system/tomcat.service root@192.168.40.8:/usr/lib/systemd/system/tomcat.service</span></pre></td></tr></table></figure><h6 id=\"423-部署zrlog\"><a class=\"anchor\" href=\"#423-部署zrlog\">#</a> 4.2.3 部署 zrlog</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp -rp /code/* root@192.168.40.8:/code/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep java</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8080                 :::*                    LISTEN      <span class=\"token number\">1806</span>/java           </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:8005          :::*                    LISTEN      <span class=\"token number\">1806</span>/java</pre></td></tr></table></figure><h6 id=\"424-接入nginx负载均衡\"><a class=\"anchor\" href=\"#424-接入nginx负载均衡\">#</a> 4.2.4 接入 Nginx 负载均衡</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nginx -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tlisten <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/proxy_params</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nginx &amp;&amp; systemctl enable nginx</span></pre></td></tr></table></figure><h6 id=\"425-接入共享存储nfs\"><a class=\"anchor\" href=\"#425-接入共享存储nfs\">#</a> 4.2.5 接入共享存储 Nfs</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/data/zrlog <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">(</span>rw,all_squash,anonuid<span class=\"token operator\">=</span><span class=\"token number\">666</span>,anongid<span class=\"token operator\">=</span><span class=\"token number\">666</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/zrlog -p</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R www.www /data/zrlog/</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#web01 挂载 nfs</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#web02 挂载 nfs, 由于 web02 节点没有该静态资源目录，所以自行创建</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/zrlog/ROOT/attached</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mount -t nfs 192.168.40.32:/data/zrlog /code/zrlog/ROOT/attached/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># groupadd -g 666 www</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -u 666 -g 666 www</span></pre></td></tr></table></figure><h6 id=\"426-集群配置https\"><a class=\"anchor\" href=\"#426-集群配置https\">#</a> 4.2.6 集群配置 Https</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># [root@lb01 ~]# cat /etc/nginx/conf.d/zrlog.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream zrlog <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://zrlog<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name zrlog.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#创建证书目录</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/ssl_key</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ssl_key<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><h6 id=\"427-tomcat会话保持session\"><a class=\"anchor\" href=\"#427-tomcat会话保持session\">#</a> 4.2.7 Tomcat 会话保持 session</h6>\n<p>1、为 web01、web02 节点添加虚拟主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/server.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--session.hmallleasing.com--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      <span class=\"token operator\">&lt;</span>Host <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"session.hmallleasing.com\"</span>  <span class=\"token assign-left variable\">appBase</span><span class=\"token operator\">=</span><span class=\"token string\">\"/code/session\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>            <span class=\"token assign-left variable\">unpackWARs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">autoDeploy</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"org.apache.catalina.valves.AccessLogValve\"</span> <span class=\"token assign-left variable\">directory</span><span class=\"token operator\">=</span><span class=\"token string\">\"logs\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>               <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span><span class=\"token string\">\"zrlog_access_log\"</span> <span class=\"token assign-left variable\">suffix</span><span class=\"token operator\">=</span><span class=\"token string\">\".txt\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>               <span class=\"token assign-left variable\">pattern</span><span class=\"token operator\">=</span><span class=\"token string\">\"%h %l %u %t &amp;quot;%r&amp;quot; %s %b\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token operator\">&lt;</span>/Host<span class=\"token operator\">></span></pre></td></tr></table></figure><p>2、为 web01、web02 配置 session 相关的网页</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置 web01</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web01 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#2. 配置 web02</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /code/session/ROOT -p</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /code/session/ROOT/index.jsp</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">&lt;</span>%</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>//HttpSession session <span class=\"token operator\">=</span> request.getSession<span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>System.out.println<span class=\"token punctuation\">(</span>session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"&lt;br> web02 SESSION ID:\"</span> + session.getId<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> + <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>out.println<span class=\"token punctuation\">(</span><span class=\"token string\">\"Session created time is :\"</span> + session.getCreationTime<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>+ <span class=\"token string\">\"&lt;br>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>%<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -HHost:session.hmallleasing.com http://192.168.40.7:8080</span></pre></td></tr></table></figure><p>3、接入负载均衡，测试检查，看看是否通过轮询调度，获取的 session 是不一致</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_certificate  /etc/nginx/ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate_key  /etc/nginx/ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 conf.d<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3syDtTJ.jpeg\" alt=\"1.jpg\" /></p>\n<p>当用户通过负载均衡向服务器 A 发起 http 请求，A 服务器会下发一个 sessionID，通过 head 中 set-cookie 回传用户，用户下次请求时会携带 cookie 字段加上服务器用户名和密码进行请求 A 服务器，该值就是 A 服务器下发的 sessionID，如果验证通过则登录成功。由于负载均衡采用轮询调度机制，请求 A 节点下发一个 sessionID，用户带着 A 节点下发一个 sessionID 请求负载均衡，会调度到 B 节点，B 节点不认 A 节点 sessionID，最终形成死循环。</p>\n<p>4、使用负载均衡 ip_hash 来解决 session；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/session.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream session <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>         ip_hash<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.7:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.8:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tserver_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        client_max_body_size 1G<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        ssl_certificate  ssl_key/hmallleasing.com.pem<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ssl_certificate_key  ssl_key/hmallleasing.com.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ssl_session_timeout 100m<span class=\"token punctuation\">;</span>               <span class=\"token comment\">#多长时间内如果再进行连接，则不需要进行握手过程</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        ssl_session_cache shared:cache:10m<span class=\"token punctuation\">;</span>     <span class=\"token comment\">#建立会话的缓存</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\tlocation / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\tproxy_pass http://session<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\tinclude proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      server_name session.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># nginx -t </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl reload nginx</span></pre></td></tr></table></figure><p>5、通过 redis 来解决 session 会话保持</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WcgGtb7.jpeg\" alt=\"1.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 redis, 配置 redis</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install redis -y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/redis.conf</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">192.168</span>.40.104</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>requirepass <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start redis &amp;&amp; systemctl enable redis</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 检查 redis 是否正常能对外提供服务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">192.168</span>.40.104:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3.tomcat 要支持 redis，需要模块（需要的是 jar 包）所有的应用节点都需要配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>https://github.com/ran-jit/tomcat-cluster-redis-session-manager</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/ran-jit/tomcat-cluster-redis-session-manager/releases/download/4.0/tomcat-cluster-redis-session-manager.zip\t</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#4.web01、web02 复制 jar 包到 tomcat/lib 目录中</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># unzip tomcat-cluster-redis-session-manager.zip</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/lib/* /soft/tomcat/lib/</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#5.web01、web02 复制 redis 配置文件到 tomcat/conf 目录中。并更新他；</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp tomcat-cluster-redis-session-manager/conf/redis-data-cache.properties /soft/tomcat/conf/</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#6.web01、web02 修改 redis 配置信息</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/redis-data-cache.properties</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#- redis hosts. ex: 127.0.0.1:6379, 127.0.0.2:6379, 127.0.0.2:6380, ....</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">redis.hosts</span><span class=\"token operator\">=</span><span class=\"token number\">192.16</span>.40.41:6379</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#- redis password.</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">redis.password</span><span class=\"token operator\">=</span><span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#7..web01、web02 添加两行配置文件在 tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@web02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/context.xml</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Valve <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionHandlerValve\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        <span class=\"token operator\">&lt;</span>Manager <span class=\"token assign-left variable\">className</span><span class=\"token operator\">=</span><span class=\"token string\">\"tomcat.request.session.redis.SessionManager\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">&lt;</span>/Context<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#8.web01、web02 可选：修改 session 过期时间，默认 30m</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /soft/tomcat/conf/web.xml</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">&lt;</span>session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  <span class=\"token operator\">&lt;</span>session-timeout<span class=\"token operator\">></span><span class=\"token number\">6</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/session-timeout<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token operator\">&lt;</span>/session-config<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\">#8.web01、web02 重启 tomcat</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token punctuation\">[</span>root@web01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop tomcat &amp;&amp; systemctl start tomcat</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\">#9.redis 查看 session</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -h 192.168.40.41 -a 123456</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> flushdb</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token number\">192.168</span>.40.41:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> keys *</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token string\">\"A8704CF8988CF60C30080420BA66AD0F\"</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/NbEnM7U.jpeg\" alt=\"2.jpg\" /></p>\n",
            "tags": [
                "Tomcat"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2041568856.html",
            "url": "http://ixuyong.cn/posts/2041568856.html",
            "title": "Prometheus监控Kubernetes",
            "date_published": "2025-06-08T02:33:49.000Z",
            "content_html": "<h3 id=\"prometheus监控kubernetes\"><a class=\"anchor\" href=\"#prometheus监控kubernetes\">#</a> Prometheus 监控 Kubernetes</h3>\n",
            "tags": [
                "Prometheus"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1595025559.html",
            "url": "http://ixuyong.cn/posts/1595025559.html",
            "title": "Prometheus监控实战",
            "date_published": "2025-06-08T02:33:41.000Z",
            "content_html": "<h3 id=\"prometheus监控实战\"><a class=\"anchor\" href=\"#prometheus监控实战\">#</a> Prometheus 监控实战</h3>\n",
            "tags": [
                "Prometheus"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2260957686.html",
            "url": "http://ixuyong.cn/posts/2260957686.html",
            "title": "Linux—Centos7修改网卡名称",
            "date_published": "2025-06-07T02:40:25.000Z",
            "content_html": "<h3 id=\"linuxcentos7修改网卡名称\"><a class=\"anchor\" href=\"#linuxcentos7修改网卡名称\">#</a> Linux—Centos7 修改网卡名称</h3>\n<p>首先我们先了解不同网卡名称对应的内核参数：</p>\n<ol>\n<li>biosdevname=0  net.ifnames=1：网卡名 “enp<em>s</em>” 此内核参数一般为默认</li>\n<li>biosdevname=1  net.ifnames=0：网卡名 “em*”</li>\n<li>biosdevname=0  net.ifnames=0：网卡名 “eth*”</li>\n</ol>\n<p>本次以将网卡名命名为 eth * 格式作示例</p>\n<h4 id=\"1-查看当前网卡的信息\"><a class=\"anchor\" href=\"#1-查看当前网卡的信息\">#</a> 1. 查看当前网卡的信息</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ens33: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.88  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        inet6 fe80::b92f:3dd3:19e7:1311  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        ether 00:0c:29:5e:a0:59  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        RX packets <span class=\"token number\">75</span>  bytes <span class=\"token number\">8065</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7.8</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        TX packets <span class=\"token number\">63</span>  bytes <span class=\"token number\">7754</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7.5</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"2-修改配置文件\"><a class=\"anchor\" href=\"#2-修改配置文件\">#</a> 2 . 修改配置文件</h4>\n<p>（1）在下列路径下找到 ifcgf-ens33</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/sysconfig/network-scripts/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager network-scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ifcfg-ens33  ifdown-ippp  ifdown-routes    <span class=\"token function\">ifup</span>          ifup-ipv6   ifup-ppp       ifup-tunnel</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ifcfg-lo     ifdown-ipv6  ifdown-sit       ifup-aliases  ifup-isdn   ifup-routes    ifup-wireless</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ifdown</span>       ifdown-isdn  ifdown-Team      ifup-bnep     ifup-plip   ifup-sit       init.ipv6-global</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ifdown-bnep  ifdown-post  ifdown-TeamPort  ifup-eth      ifup-plusb  ifup-Team      network-functions</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ifdown-eth   ifdown-ppp   ifdown-tunnel    ifup-ippp     ifup-post   ifup-TeamPort  network-functions-ipv6</pre></td></tr></table></figure><p>（2）使用 MV 命令，修改当前网卡的名称</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv ifcfg-ens33 ifcfg-eth0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager network-scripts<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ifcfg-eth0   ifdown-ippp  ifdown-routes    <span class=\"token function\">ifup</span>          ifup-ipv6   ifup-ppp       ifup-tunnel</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ifcfg-lo     ifdown-ipv6  ifdown-sit       ifup-aliases  ifup-isdn   ifup-routes    ifup-wireless</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">ifdown</span>       ifdown-isdn  ifdown-Team      ifup-bnep     ifup-plip   ifup-sit       init.ipv6-global</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ifdown-bnep  ifdown-post  ifdown-TeamPort  ifup-eth      ifup-plusb  ifup-Team      network-functions</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ifdown-eth   ifdown-ppp   ifdown-tunnel    ifup-ippp     ifup-post   ifup-TeamPort  network-functions-ipv6</pre></td></tr></table></figure><p>（3）同步修改网卡配置文件中的 name 和 device，修改为需要配置网卡的名字</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"ens33\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"ens33\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>将上列命令修改为</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">NAME</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">DEVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"eth0\"</span></pre></td></tr></table></figure><p>（4）修改 grub</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/default/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#编辑内核信息，在 GRUB_CMDLINE_LINUX 行添加字段 net.ifnames=0 biosdevname=0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager default<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat grub </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">GRUB_TIMEOUT</span><span class=\"token operator\">=</span><span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DISTRIBUTOR</span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">sed</span> <span class=\"token string\">'s, release .*$,,g'</span> /etc/system-release<span class=\"token variable\">)</span></span>\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DEFAULT</span><span class=\"token operator\">=</span>saved</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DISABLE_SUBMENU</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">GRUB_TERMINAL_OUTPUT</span><span class=\"token operator\">=</span><span class=\"token string\">\"console\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">GRUB_CMDLINE_LINUX</span><span class=\"token operator\">=</span><span class=\"token string\">\"crashkernel=auto rhgb net.ifnames=0 biosdevname=0 quiet\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">GRUB_DISABLE_RECOVERY</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#生成启动菜单</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager default<span class=\"token punctuation\">]</span><span class=\"token comment\"># grub2-mkconfig -o /boot/grub2/grub.cfg</span></pre></td></tr></table></figure><p>（5）完成之后 reboot 重启系统即可</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager default<span class=\"token punctuation\">]</span><span class=\"token comment\"># reboot</span></pre></td></tr></table></figure><p>（6）使用 ifconfig 即可查看</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>eth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.88  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        inet6 fe80::63d4:467f:9b76:e34f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        inet6 fe80::1856:7b0:9d1e:7208  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        ether 00:0c:29:5e:a0:59  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        RX packets <span class=\"token number\">77</span>  bytes <span class=\"token number\">8117</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7.9</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        TX packets <span class=\"token number\">62</span>  bytes <span class=\"token number\">7842</span> <span class=\"token punctuation\">(</span><span class=\"token number\">7.6</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure>",
            "tags": [
                "Linux"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2126514413.html",
            "url": "http://ixuyong.cn/posts/2126514413.html",
            "title": "虚拟隧道网络Openvpn",
            "date_published": "2025-06-05T13:50:22.000Z",
            "content_html": "<h3 id=\"虚拟隧道网络openvpn\"><a class=\"anchor\" href=\"#虚拟隧道网络openvpn\">#</a> 虚拟隧道网络 Openvpn</h3>\n<h4 id=\"一-什么是vpn\"><a class=\"anchor\" href=\"#一-什么是vpn\">#</a> 一、什么是 VPN</h4>\n<p>VPN（Virtual Private Network） 翻译过来就是虚拟专⽤⽹络，那虚拟专⽤⽹提供什么功能</p>\n<ol>\n<li>将两个或多个 “不同地域 “的⽹络通过⼀条虚拟隧道的⽅式连接起来，实现互通；</li>\n<li>在不安全的线路上提供安全的数据传输；</li>\n</ol>\n<h4 id=\"二-vpn应用场景\"><a class=\"anchor\" href=\"#二-vpn应用场景\">#</a> 二、VPN 应⽤场景</h4>\n<h5 id=\"21-点对点连接\"><a class=\"anchor\" href=\"#21-点对点连接\">#</a> 2.1 点对点连接</h5>\n<p>Peer-to-Peer VPN (点对点连接)，将 Internet 两台机器（公⽹地址）使⽤ VPN 连接起来，⽐如上海服务器和北京服务器的之间的数据需要相互调⽤，但是数据⼜⽐较敏感，直接通过 http 公共⽹络传输，容易被窃取。如果拉⼀条专线成本⼜太⾼。所以我们可以通过 VPN 将两台主机逻辑上捆绑在⼀个虚拟⽹络中，这样既保证了数据传输安全，同时⼜节省了成本。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ZjDn2SI.png\" alt=\"1.png\" /></p>\n<h5 id=\"22-站点对站点\"><a class=\"anchor\" href=\"#22-站点对站点\">#</a> 2.2 站点对站点</h5>\n<p>SIte-to-Site VPN (站点对站点连接) ，⽤于连接两个或者多个地域上不同的局域⽹ LAN，每个 LAN 有⼀台 OpenVPN 服务器作为接⼊点，组成虚拟专⽤⽹络，使得不同 LAN ⾥⾯的主机和服务器都能够相互通讯。（⽐如国内公司与海外公司分公司的连接）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/W5Yg3v0.png\" alt=\"2.png\" /></p>\n<h5 id=\"23-远程访问\"><a class=\"anchor\" href=\"#23-远程访问\">#</a> 2.3 远程访问</h5>\n<p>Remote AccessVPN（远程访问），应⽤于外⽹⽤户访问内部资源。在这个场景中远程访问者⼀般通过公⽹ IP 连接 VPN 服务，然后通过分配后的内⽹地址与其内⽹⽹段进⾏通信。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6f3PYIK.png\" alt=\"3.png\" /></p>\n<h4 id=\"三-openvpn基本介绍\"><a class=\"anchor\" href=\"#三-openvpn基本介绍\">#</a> 三、OpenVPN 基本介绍</h4>\n<h5 id=\"31-什么是openvpn\"><a class=\"anchor\" href=\"#31-什么是openvpn\">#</a> 3.1 什么是 OpenVPN</h5>\n<p>OpenVPN 就像它的名字⼀样，是⼀个开源的软件，且提供</p>\n<p>VPN 虚拟专⽤⽹络功能；</p>\n<ul>\n<li>⽀持 SSL/TLS 协议，使得数据传输更安全；</li>\n<li>⽀持 TCP、UDP 隧道；</li>\n<li>⽀持动态分配虚拟 IP 地址；</li>\n<li>⽀持数百甚⾄数千⽤户同时使⽤；</li>\n<li>⽀持⼤多数主流操作系统平台；</li>\n</ul>\n<p>OpenVPN 官⽹：<a href=\"https://openvpn.net\">https://openvpn.net</a></p>\n<p>GitHub 地址：<a href=\"https://github.com/OpenVPN/openvpn\">https://github.com/OpenVPN/openvpn</a></p>\n<h5 id=\"32-openvpn应用场景\"><a class=\"anchor\" href=\"#32-openvpn应用场景\">#</a> 3.2 OpenVPN 应⽤场景</h5>\n<p>场景 1：拨⼊ OpenVPN，然后连接内部服务器；</p>\n<p>场景 2：实现两个不同地域主机、且两个地域主机 IP 不固定，互连互通；</p>\n<h5 id=\"33-openvpn实现场景\"><a class=\"anchor\" href=\"#33-openvpn实现场景\">#</a> 3.3 OpenVPN 实现场景</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3GCg7Qd.png\" alt=\"1.png\" /></p>\n<h4 id=\"四-openvpn证书配置\"><a class=\"anchor\" href=\"#四-openvpn证书配置\">#</a> 四、OpenVPN 证书配置</h4>\n<h5 id=\"41-安装easy-rsa\"><a class=\"anchor\" href=\"#41-安装easy-rsa\">#</a> 4.1 安装 easy-rsa</h5>\n<p>1. 为了保证 OpenVPN 数据传输安全，所以需要证书，可以通过 easy-rsa ⼯具创建相关证书</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install easy-rsa -y</span></pre></td></tr></table></figure><p>2. 创建证书前，需要拷⻉配置⽂件，以及 vars ⽂件，定义证书相关的属性</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@open ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /opt/easy-rsa</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@open ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /opt/easy-rsa/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -a /usr/share/easy-rsa/3/* ./</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp -a /usr/share/doc/easy-rsa-*/vars.example ./vars</span></pre></td></tr></table></figure><p>3. 修改 vars ⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat vars </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$EASYRSA_CALLER</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"You appear to be sourcing an Easy-RSA 'vars' file.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"This is no longer necessary and is disallowed. See the section called\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"'How to use this file' near the top comments for more details.\"</span> <span class=\"token operator\">></span><span class=\"token file-descriptor important\">&amp;2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token builtin class-name\">return</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>set_var EASYRSA_CA_EXPIRE <span class=\"token number\">3650</span>            <span class=\"token comment\">#证书有效期</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>set_var EASYRSA_CERT_EXPIRE <span class=\"token number\">3650</span>          <span class=\"token comment\">#服务端证书有效期，默为 825 天</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>set_var EASYRSA_DN <span class=\"token string\">\"cn_only\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>set_var EASYRSA_REQ_COUNTRY <span class=\"token string\">\"CN\"</span>          <span class=\"token comment\">#所在的国家</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>set_var EASYRSA_REQ_PROVINCE <span class=\"token string\">\"Guangdong\"</span>    <span class=\"token comment\">#所在的省份</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>set_var EASYRSA_REQ_CITY <span class=\"token string\">\"Shenzhen\"</span>        <span class=\"token comment\">#所在的城市</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>set_var EASYRSA_REQ_ORG <span class=\"token string\">\"nfzl\"</span>           <span class=\"token comment\">#所在的组织</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>set_var EASYRSA_REQ_EMAIL <span class=\"token string\">\"xuy@nf-leasing.com\"</span> <span class=\"token comment\">#邮箱的地址</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>set_var EASYRSA_NS_SUPPORT <span class=\"token string\">\"yes\"</span></pre></td></tr></table></figure><h5 id=\"42-创建证书文件\"><a class=\"anchor\" href=\"#42-创建证书文件\">#</a> 4.2 创建证书⽂件</h5>\n<h6 id=\"421初始化pki\"><a class=\"anchor\" href=\"#421初始化pki\">#</a> 4.2.1 初始化 PKI</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 初始化，在当前⽬录创建 PKI ⽬录，⽤于存储证书</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa init-pki</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>init-pki complete<span class=\"token punctuation\">;</span> you may now create a CA or requests.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Your newly created PKI <span class=\"token function\">dir</span> is: /opt/easy-rsa/pki</pre></td></tr></table></figure><h6 id=\"422-创建ca机构\"><a class=\"anchor\" href=\"#422-创建ca机构\">#</a> 4.2.2 创建 CA 机构</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 ca 证书，主要对后续创建的 server、client 证书进⾏签名；会提示设置密码，其他可默认</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa build-ca</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Enter New CA Key Passphrase:        <span class=\"token comment\">#设置密码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Re-Enter New CA Key Passphrase:     <span class=\"token comment\">#确认密码</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Generating RSA private key, <span class=\"token number\">2048</span> bit long modulus</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>e is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x10001<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>Easy-RSA CA<span class=\"token punctuation\">]</span>:nfzl     <span class=\"token comment\">#输入 nfzl</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>CA creation complete and you may now <span class=\"token function\">import</span> and sign cert requests.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Your new CA certificate <span class=\"token function\">file</span> <span class=\"token keyword\">for</span> publishing is at:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>/opt/easy-rsa/pki/ca.crt</pre></td></tr></table></figure><h6 id=\"423-签发服务端证书\"><a class=\"anchor\" href=\"#423-签发服务端证书\">#</a> 4.2.3 签发服务端证书</h6>\n<p>1. 创建 server 端证书，nopass 表示不加密私钥⽂件，其他可默认</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-req server nopass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Generating a <span class=\"token number\">2048</span> bit RSA private key</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>writing new private key to <span class=\"token string\">'/opt/easy-rsa/pki/easy-rsa-1983.z07ECs/tmp.PBZXuy'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>server<span class=\"token punctuation\">]</span>:     <span class=\"token comment\">#回车即可</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Keypair and certificate request completed. Your files are:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>req: /opt/easy-rsa/pki/reqs/server.req            <span class=\"token comment\">#请求⽂件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>key: /opt/easy-rsa/pki/private/server.key         <span class=\"token comment\">#私钥</span></pre></td></tr></table></figure><p>2. 给 server 端证书签名，⾸先是对信息的确认，可以输⼊ yes，然后输⼊创建 ca 根证书时设置的密码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 第⼀个 server 是类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 第⼆个 server 是 req 请求⽂件名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa sign server server</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>You are about to sign the following certificate.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Please check over the details shown below <span class=\"token keyword\">for</span> accuracy. Note that this request</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>has not been cryptographically verified. Please be sure it came from a trusted</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">source</span> or that you have verified the request checksum with the sender.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Request subject, to be signed as a server certificate <span class=\"token keyword\">for</span> <span class=\"token number\">3650</span> days:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    commonName                <span class=\"token operator\">=</span> server</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>Type the word <span class=\"token string\">'yes'</span> to continue, or any other input to abort.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  Confirm request details: <span class=\"token function\">yes</span>             <span class=\"token comment\">#输入 yes</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Using configuration from /opt/easy-rsa/pki/easy-rsa-2098.GEv4iZ/tmp.oyIjPH</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Enter pass phrase <span class=\"token keyword\">for</span> /opt/easy-rsa/pki/private/ca.key:    <span class=\"token comment\">#输入密码</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Check that the request matches the signature</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Signature ok</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>The Subject<span class=\"token string\">'s Distinguished Name is as follows</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>commonName            :ASN.1 12:'</span>server'</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Certificate is to be certified <span class=\"token keyword\">until</span> Jun  <span class=\"token number\">8</span> <span class=\"token number\">13</span>:22:49 <span class=\"token number\">2033</span> GMT <span class=\"token punctuation\">(</span><span class=\"token number\">3650</span> days<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Write out database with <span class=\"token number\">1</span> new entries</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Data Base Updated</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Certificate created at: /opt/easy-rsa/pki/issued/server.crt   <span class=\"token comment\"># 公钥</span></pre></td></tr></table></figure><h6 id=\"424-创建dh密钥\"><a class=\"anchor\" href=\"#424-创建dh密钥\">#</a> 4.2.4 创建 DH 密钥</h6>\n<p>Diffie-Hellman 是⼀种安全协议；让双⽅在完全没有对⽅任何信息情况下通过不安全信道建⽴⼀个密钥； 这个密钥⼀般作为 “对称加密” 的密钥⽽被双⽅在后续数据传输中使⽤；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-dh DH parameters of size 2048 created at /opt/easy-rsa/pki/dh.pem</span></pre></td></tr></table></figure><h6 id=\"425-签发客户端证书\"><a class=\"anchor\" href=\"#425-签发客户端证书\">#</a> 4.2.5 签发客户端证书</h6>\n<p>1. 创建 client 端私钥⽂件，nopass 表示不加密私钥⽂件，其他可默认</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa gen-req client nopass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Generating a <span class=\"token number\">2048</span> bit RSA private key</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>+++</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>writing new private key to <span class=\"token string\">'/opt/easy-rsa/pki/easy-rsa-2191.qCdaPl/tmp.mqfX2L'</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>You are about to be asked to enter information that will be incorporated</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>into your certificate request.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>What you are about to enter is what is called a Distinguished Name or a DN.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>There are quite a few fields but you can leave some blank</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>For some fields there will be a default value,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>If you enter <span class=\"token string\">'.'</span>, the field will be left blank.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>-----</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Common Name <span class=\"token punctuation\">(</span>eg: your user, host, or server name<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>client<span class=\"token punctuation\">]</span>:    <span class=\"token comment\">#回车即可</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Keypair and certificate request completed. Your files are:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>req: /opt/easy-rsa/pki/reqs/client.req        <span class=\"token comment\">#请求⽂件</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>key: /opt/easy-rsa/pki/private/client.key     <span class=\"token comment\">#私钥⽂件</span></pre></td></tr></table></figure><p>2. 给 client 端证书签名，⾸先是对信息的确认，可以输⼊ yes，然后创建 ca 根证书时设置的密码</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 第⼀个 client 是类型</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 第⼆个 client 是 req 请求⽂件名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./easyrsa sign client client</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Note: using Easy-RSA configuration from: /opt/easy-rsa/vars</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Using SSL: openssl OpenSSL <span class=\"token number\">1.0</span>.2k-fips  <span class=\"token number\">26</span> Jan <span class=\"token number\">2017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>You are about to sign the following certificate.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Please check over the details shown below <span class=\"token keyword\">for</span> accuracy. Note that this request</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>has not been cryptographically verified. Please be sure it came from a trusted</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">source</span> or that you have verified the request checksum with the sender.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Request subject, to be signed as a client certificate <span class=\"token keyword\">for</span> <span class=\"token number\">3650</span> days:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">subject</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    commonName                <span class=\"token operator\">=</span> <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Type the word <span class=\"token string\">'yes'</span> to continue, or any other input to abort.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  Confirm request details: <span class=\"token function\">yes</span>                      <span class=\"token comment\">#输入 yes</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>Using configuration from /opt/easy-rsa/pki/easy-rsa-2218.aCZcDB/tmp.Z2nHgS</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>Enter pass phrase <span class=\"token keyword\">for</span> /opt/easy-rsa/pki/private/ca.key:            <span class=\"token comment\">#输入密码</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Check that the request matches the signature</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Signature ok</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>The Subject<span class=\"token string\">'s Distinguished Name is as follows</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>commonName            :ASN.1 12:'</span>yes'</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Certificate is to be certified <span class=\"token keyword\">until</span> Jun  <span class=\"token number\">8</span> <span class=\"token number\">13</span>:29:01 <span class=\"token number\">2033</span> GMT <span class=\"token punctuation\">(</span><span class=\"token number\">3650</span> days<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Write out database with <span class=\"token number\">1</span> new entries</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Data Base Updated</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>Certificate created at: /opt/easy-rsa/pki/issued/client.crt     <span class=\"token comment\"># 客户端公钥</span></pre></td></tr></table></figure><h4 id=\"五-openvpn服务安装\"><a class=\"anchor\" href=\"#五-openvpn服务安装\">#</a> 五、OpenVPN 服务安装</h4>\n<h5 id=\"51-安装openvpn服务\"><a class=\"anchor\" href=\"#51-安装openvpn服务\">#</a> 5.1 安装 Openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com         #⼀定要同步时间</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -l</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install openvpn -y</span></pre></td></tr></table></figure><h5 id=\"52-配置openvpn服务\"><a class=\"anchor\" href=\"#52-配置openvpn服务\">#</a> 5.2 配置 openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/openvpn/server.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>port <span class=\"token number\">1194</span>                              <span class=\"token comment\">#端口</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                              <span class=\"token comment\">#协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dev tun                                <span class=\"token comment\">#采用路由隧道模式 tun</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ca ca.crt                              <span class=\"token comment\">#ca 证书文件位置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cert server.crt                        <span class=\"token comment\">#服务端公钥名称</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>key server.key                         <span class=\"token comment\">#服务端私钥名称</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dh dh.pem                              <span class=\"token comment\">#交换证书</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token number\">10.8</span>.0.0 <span class=\"token number\">255.255</span>.255.0          <span class=\"token comment\">#给客户端分配地址池，注意：不能和 VPN 服务器内网网段有相同</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>push <span class=\"token string\">\"route 172.16.1.0 255.255.255.0\"</span>  <span class=\"token comment\">#允许客户端访问内网 172.16.1.0 网段，根据实际情况修改</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># push \"redirect-gateway def1\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># push \"dhcp-option DNS 8.8.8.8\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ifconfig-pool-persist ipp.txt       <span class=\"token comment\">#地址池记录文件位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>keepalive <span class=\"token number\">10</span> <span class=\"token number\">120</span>                    <span class=\"token comment\">#存活时间，10 秒 ping ⼀次，120 如未收到响应则视为断线</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>max-clients <span class=\"token number\">100</span>                     <span class=\"token comment\">#最多允许 100 个客户端连接</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>status openvpn-status.log           <span class=\"token comment\">#日志记录位置</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>verb <span class=\"token number\">3</span>                              <span class=\"token comment\">#openvpn 版本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>client-to-client                    <span class=\"token comment\">#客户端与客户端之间通信</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>log /var/log/openvpn.log            <span class=\"token comment\">#openvpn 日志记录位置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>persist-key                         <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使的 keys</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>persist-tun                         <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>duplicate-cn</pre></td></tr></table></figure><h5 id=\"53-拷服务端证书文件\"><a class=\"anchor\" href=\"#53-拷服务端证书文件\">#</a> 5.3 拷⻉服务端证书⽂件</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 将服务端证书拷⻉⾄ /etc/openvpn ⽬录下</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/ca.crt /etc/openvpn/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/dh.pem /etc/openvpn/</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/issued/server.crt /etc/openvpn/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">cp</span> /opt/easy-rsa/pki/private/server.key /etc/openvpn/</pre></td></tr></table></figure><h5 id=\"54-开启内核转发参数\"><a class=\"anchor\" href=\"#54-开启内核转发参数\">#</a> 5.4 开启内核转发参数</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 必须开启内核转发功能</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo \"net.ipv4.ip_forward = 1\" >> /etc/sysctl.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sysctl -p</span></pre></td></tr></table></figure><h5 id=\"55-启动openvpn服务\"><a class=\"anchor\" href=\"#55-启动openvpn服务\">#</a> 5.5 启动 openvpn 服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable openvpn@server &amp;&amp; systemctl start openvpn@server</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 1194</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:1194            <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">2522</span>/openvpn</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#检测 1194 端口是否通，阿里云服务器需安全组规则放行 1194</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@jumpserver ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.40.70 1194</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.40.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.40.70.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>eth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.70  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        inet6 fe80::1856:7b0:9d1e:7208  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        ether 00:0c:29:75:9b:a9  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        RX packets <span class=\"token number\">2542</span>  bytes <span class=\"token number\">836133</span> <span class=\"token punctuation\">(</span><span class=\"token number\">816.5</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        TX packets <span class=\"token number\">3150</span>  bytes <span class=\"token number\">327134</span> <span class=\"token punctuation\">(</span><span class=\"token number\">319.4</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>eth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        inet <span class=\"token number\">172.16</span>.1.70  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">172.16</span>.1.255</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        inet6 fe80::1607:3fa8:6c0d:8f7f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        ether 00:0c:29:75:9b:b3  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        TX packets <span class=\"token number\">18</span>  bytes <span class=\"token number\">1382</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1.3</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>tun0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">430</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>&lt;</span>UP,POINTOPOINT,RUNNING,NOARP,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        inet <span class=\"token number\">10.8</span>.0.1  netmask <span class=\"token number\">255.255</span>.255.255  destination <span class=\"token number\">10.8</span>.0.2</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        inet6 fe80::d334:578d:2988:1996  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span class=\"token number\">100</span>  <span class=\"token punctuation\">(</span>UNSPEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        TX packets <span class=\"token number\">3</span>  bytes <span class=\"token number\">144</span> <span class=\"token punctuation\">(</span><span class=\"token number\">144.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure><h4 id=\"六-openvpn客户端\"><a class=\"anchor\" href=\"#六-openvpn客户端\">#</a> 六、OpenVPN 客户端</h4>\n<h5 id=\"61-客户端连接linux\"><a class=\"anchor\" href=\"#61-客户端连接linux\">#</a> 6.1 客户端连接 Linux</h5>\n<p>1. 端安装 openvpn</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install openvpn -y</span></pre></td></tr></table></figure><p>2. 下载客户端公钥与私钥以及 Ca 证书⾄客户端</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /etc/openvpn/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/ca.crt ./</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/issued/client.crt ./</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># scp root@192.168.40.70:/opt/easy-rsa/pki/private/client.key ./</span></pre></td></tr></table></figure><p>3. 客户端有了公钥和私钥后，还需要准备对应的客户端配置⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat client.ovpn</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>client                        <span class=\"token comment\">#指定当前 VPN 是客户端</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>dev tun                       <span class=\"token comment\">#使用 tun 隧道传输协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>proto tcp                     <span class=\"token comment\">#使用 udp 协议传输数据</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>remote <span class=\"token number\">192.168</span>.40.70 <span class=\"token number\">1194</span>     <span class=\"token comment\">#openvpn 服务器 IP 地址端口号</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>resolv-retry infinite         <span class=\"token comment\">#断线后动重新连接，在网络不稳定的情况下非常有用</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nobind                        <span class=\"token comment\">#不绑定本地特定的端口号</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ca ca.crt                     <span class=\"token comment\">#指定 CA 证书的文件路径</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>cert client.crt               <span class=\"token comment\">#指定当前客户端的证书文件路径</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>key client.key                <span class=\"token comment\">#指定当前客户端的私钥文件路径</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>verb <span class=\"token number\">3</span>                        <span class=\"token comment\">#指定日志文件的记录详细级别，可选 0-9，等级越高日志内容越详细</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>persist-key                   <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第几次使用的 keys</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>persist-tun                   <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr></table></figure><p>4. 启动 openvpn 客户端</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># openvpn --daemon --cd /etc/openvpn --config client.ovpn --log-append /var/log/openvpn.log</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># --daemon：openvpn 以 daemon ⽅式启动。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># --cd dir：配置⽂件的⽬录，openvpn 初始化前，先切换到此⽬录。</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># --config file：客户端配置⽂件的路径。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># --log-append file：⽇志⽂件路径，如果⽂件不存在会⾃动创建。</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># ps aux|grep openvpn</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>root       <span class=\"token number\">2675</span>  <span class=\"token number\">0.0</span>  <span class=\"token number\">0.1</span>  <span class=\"token number\">75164</span>  <span class=\"token number\">3448</span> ?        Ss   <span class=\"token number\">16</span>:20   <span class=\"token number\">0</span>:00 openvpn <span class=\"token parameter variable\">--daemon</span> <span class=\"token parameter variable\">--cd</span> /etc/openvpn <span class=\"token parameter variable\">--config</span> client.ovpn --log-append /var/log/openvpn.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root       <span class=\"token number\">2705</span>  <span class=\"token number\">0.0</span>  <span class=\"token number\">0.0</span> <span class=\"token number\">112812</span>   <span class=\"token number\">980</span> pts/0    S+   <span class=\"token number\">16</span>:21   <span class=\"token number\">0</span>:00 <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto openvpn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 openvpn<span class=\"token punctuation\">]</span><span class=\"token comment\"># ifconfig</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>eth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        inet <span class=\"token number\">192.168</span>.40.51  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">192.168</span>.40.255</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        inet6 fe80::63d4:467f:9b76:e34f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        inet6 fe80::1856:7b0:9d1e:7208  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        ether 00:0c:29:e0:f8:86  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        RX packets <span class=\"token number\">2911</span>  bytes <span class=\"token number\">880086</span> <span class=\"token punctuation\">(</span><span class=\"token number\">859.4</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        TX packets <span class=\"token number\">1943</span>  bytes <span class=\"token number\">249205</span> <span class=\"token punctuation\">(</span><span class=\"token number\">243.3</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>eth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        inet <span class=\"token number\">172.16</span>.1.51  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">172.16</span>.1.255</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        inet6 fe80::1607:3fa8:6c0d:8f7f  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        inet6 fe80::b64e:4e5e:1653:e542  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        ether 00:0c:29:e0:f8:90  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        RX packets <span class=\"token number\">6</span>  bytes <span class=\"token number\">516</span> <span class=\"token punctuation\">(</span><span class=\"token number\">516.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        TX packets <span class=\"token number\">66</span>  bytes <span class=\"token number\">5642</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5.5</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>lo: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">7</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class=\"token operator\">></span>  mtu <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        inet <span class=\"token number\">127.0</span>.0.1  netmask <span class=\"token number\">255.0</span>.0.0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        inet6 ::1  prefixlen <span class=\"token number\">128</span>  scopeid 0x1<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>host<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        loop  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Local Loopback<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        RX packets <span class=\"token number\">97</span>  bytes <span class=\"token number\">15400</span> <span class=\"token punctuation\">(</span><span class=\"token number\">15.0</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        TX packets <span class=\"token number\">97</span>  bytes <span class=\"token number\">15400</span> <span class=\"token punctuation\">(</span><span class=\"token number\">15.0</span> KiB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>tun0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">430</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>&lt;</span>UP,POINTOPOINT,RUNNING,NOARP,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        inet <span class=\"token number\">10.8</span>.0.6  netmask <span class=\"token number\">255.255</span>.255.255  destination <span class=\"token number\">10.8</span>.0.5</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        inet6 fe80::7cc6:553f:e98d:9633  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen <span class=\"token number\">100</span>  <span class=\"token punctuation\">(</span>UNSPEC<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        TX packets <span class=\"token number\">3</span>  bytes <span class=\"token number\">144</span> <span class=\"token punctuation\">(</span><span class=\"token number\">144.0</span> B<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"62-客户端连接windows\"><a class=\"anchor\" href=\"#62-客户端连接windows\">#</a> 6.2 客户端连接 Windows</h5>\n<p>openvpn for windows 客户端下载地址、openvpn-2.4.11-Win7.exe、openvpn-2.4.11-Win10.exe</p>\n<p>1. 下载服务端准备的客户端密钥⽂件和 ca ⽂件⾄ C:\\Program Files\\OpenVPN\\config ⽬录中</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/ca.crt</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/issued/client.crt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sz /opt/easy-rsa/pki/private/client.key</span></pre></td></tr></table></figure><p>2. 在 C:\\Program Files\\OpenVPN\\config 创建⼀个客户端配置⽂件，名称叫 client.ovpn</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>client                       <span class=\"token comment\">#指定当前 VPN 是客户端</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>dev tun                      <span class=\"token comment\">#使用 tun 隧道传输协议</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                    <span class=\"token comment\">#使用 udp 协议传输数据</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>remote <span class=\"token number\">192.168</span>.40.70 <span class=\"token number\">1194</span>   <span class=\"token comment\">#openvpn 服务器 IP 地址端口号</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>resolv-retry infinite        <span class=\"token comment\">#断线自动重新连接，在网络不稳定的情况下非常有用</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nobind                       <span class=\"token comment\">#不绑定本地特定的端口号</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ca ca.crt                    <span class=\"token comment\">#指定 CA 证书的文件路径</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cert client.crt              <span class=\"token comment\">#指定当前客户端的证书文件路径</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>key client.key               <span class=\"token comment\">#指定当前客户端的私钥文件路径</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>verb <span class=\"token number\">3</span>                       <span class=\"token comment\">#指定日志文件的记录详细级别，可选 0-9，等级越越高志内容越详细</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>persist-key                  <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使用的 keys</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>persist-tun                  <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr></table></figure><p>3. 最终 windows 的⽬录中配置⽂件如下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>C:<span class=\"token punctuation\">\\</span>Program Files<span class=\"token punctuation\">\\</span>OpenVPN<span class=\"token punctuation\">\\</span>config</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ca.crt</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>client.crt</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>client.key</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>client.ovpn</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>README.txt</pre></td></tr></table></figure><p>4. 登陆成功后，通过 windows 查看 openvpn 服务推送过来的路由信息；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 查看连接状态 10.8.0.6 连接 172.16.1.60</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -nt</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Active Internet connections <span class=\"token punctuation\">(</span>w/o servers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State      </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.70:22          <span class=\"token number\">10.8</span>.0.6:52391          ESTABLISHED</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.70:1194      <span class=\"token number\">192.168</span>.40.1:52319      ESTABLISHED</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.70:22        <span class=\"token number\">192.168</span>.40.1:51544      ESTABLISHED</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># windows 查看推送过来的路由信息</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>C:<span class=\"token punctuation\">\\</span>~<span class=\"token punctuation\">]</span>$ route print <span class=\"token parameter variable\">-4</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>接口列表</pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">14</span><span class=\"token punctuation\">..</span>.94 c6 <span class=\"token number\">91</span> <span class=\"token number\">22</span> 3a e8 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Realtek PCIe GBE Family Controller</pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">13</span><span class=\"token punctuation\">..</span>.00 ff 9c <span class=\"token number\">82</span> 0c c4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>TAP-Windows Adapter V9</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token number\">5</span><span class=\"token punctuation\">..</span>.52 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Microsoft Wi-Fi Direct Virtual Adapter</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">18</span><span class=\"token punctuation\">..</span>.50 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Microsoft Wi-Fi Direct Virtual Adapter <span class=\"token comment\">#2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre> <span class=\"token number\">20</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 01 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">11</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 08 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet8</pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">10</span><span class=\"token punctuation\">..</span>.00 <span class=\"token number\">50</span> <span class=\"token number\">56</span> c0 00 0f <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>VMware Virtual Ethernet Adapter <span class=\"token keyword\">for</span> VMnet15</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">17</span><span class=\"token punctuation\">..</span>.50 2b <span class=\"token number\">73</span> e8 4f b4 <span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>Realtek 8188GU Wireless LAN <span class=\"token number\">802</span>.11n USB NIC</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.Software Loopback Interface <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>IPv4 路由表</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>活动路由:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>网络目标        网络掩码          网关       接口   跃点数</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          <span class=\"token number\">0.0</span>.0.0          <span class=\"token number\">0.0</span>.0.0      <span class=\"token number\">192.168</span>.1.1    <span class=\"token number\">192.168</span>.1.102     <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.0    <span class=\"token number\">255.255</span>.255.0         <span class=\"token number\">10.8</span>.0.5         <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.4  <span class=\"token number\">255.255</span>.255.252            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.6  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>         <span class=\"token number\">10.8</span>.0.7  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        <span class=\"token number\">127.0</span>.0.0        <span class=\"token number\">255.0</span>.0.0            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        <span class=\"token number\">127.0</span>.0.1  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  <span class=\"token number\">127.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>       <span class=\"token number\">172.16</span>.1.0    <span class=\"token number\">255.255</span>.255.0         <span class=\"token number\">10.8</span>.0.5         <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span>         <span class=\"token comment\">#路由条目</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      <span class=\"token number\">192.168</span>.1.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token number\">192.168</span>.1.102  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token number\">192.168</span>.1.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>     <span class=\"token number\">192.168</span>.40.0    <span class=\"token number\">255.255</span>.255.0            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>     <span class=\"token number\">192.168</span>.40.1  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>   <span class=\"token number\">192.168</span>.40.255  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    <span class=\"token number\">192.168</span>.137.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    <span class=\"token number\">192.168</span>.137.1  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  <span class=\"token number\">192.168</span>.137.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    <span class=\"token number\">192.168</span>.195.0    <span class=\"token number\">255.255</span>.255.0            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    <span class=\"token number\">192.168</span>.195.1  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  <span class=\"token number\">192.168</span>.195.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        <span class=\"token number\">224.0</span>.0.0        <span class=\"token number\">240.0</span>.0.0            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上         <span class=\"token number\">127.0</span>.0.1    <span class=\"token number\">331</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.195.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上      <span class=\"token number\">192.168</span>.40.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.137.1    <span class=\"token number\">291</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上          <span class=\"token number\">10.8</span>.0.6    <span class=\"token number\">281</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  <span class=\"token number\">255.255</span>.255.255  <span class=\"token number\">255.255</span>.255.255            在链路上     <span class=\"token number\">192.168</span>.1.102    <span class=\"token number\">306</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">==</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>永久路由:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  无</pre></td></tr></table></figure><h4 id=\"七-openvpn用户密码认证\"><a class=\"anchor\" href=\"#七-openvpn用户密码认证\">#</a> 七、OpenVPN ⽤户密码认证</h4>\n<p>我们⽬前使⽤密钥进⾏加密传输，可以说已经很安全了，为什么还要需要⽤户名秘密呢。</p>\n<p>1、首先管理这些秘钥和证书⽐较麻烦，如果⽤户⽐较多，单独为每个⽤户都创建⼀套秘钥⽐较麻烦；<br />\n2、其次多⼈使⽤同⼀秘钥⼜不具有唯⼀性，⽐如说有⽤户不在需要 VPN 的时候，我们就需要吊销证书，如果多⼈使⽤⼀个秘钥的情况下，吊销证书会造成其他⽤户也⽆法正常登录。</p>\n<p>所以就需要秘钥加⽤户名密码，这样就可以实现多个⽤户使⽤同⼀个证书，使⽤不同的⽤户名和密码； 当有新⽤户加⼊时，只需要添加⼀个⽤户名和密码即可，如果不需要使⽤，则删除⽤户名和密码即可；</p>\n<h5 id=\"71-openvpn服务端配置\"><a class=\"anchor\" href=\"#71-openvpn服务端配置\">#</a> 7.1 OpenVPN 服务端配置</h5>\n<p>1、修改服务端配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加如下三⾏代码，使其服务端⽀持密码认证⽅式</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/openvpn/server.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>script-security <span class=\"token number\">3</span>                                         <span class=\"token comment\">#允许使用自定义脚本</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>auth-user-pass-verify /etc/openvpn/check.sh via-env       <span class=\"token comment\">#自定义脚本路径</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>username-as-common-name                                   <span class=\"token comment\">#用户密码登陆方式验证</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 表示只使用用户名密码方式验证，不加该参数，则代表需要证书、用户名、密码多重验证登录</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># client-cert-not-required</span></pre></td></tr></table></figure><p>2、创建⾃定义脚本</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/openvpn/check.sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">###########################################################</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">PASSFILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"/etc/openvpn/openvpnfile\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">LOG_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"/var/log/openvpn-password.log\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">TIME_STAMP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> <span class=\"token string\">\"+%Y-%m-%d %T\"</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-r</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;PASSFILE&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Could not open password file <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;PASSFILE&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span> for reading.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">CORRECT_PASSWORD</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">awk</span> <span class=\"token string\">'!/^;/&amp;&amp;!/^#/&amp;&amp;$1==\"'</span>$<span class=\"token punctuation\">&#123;</span>username<span class=\"token punctuation\">&#125;</span><span class=\"token string\">'\"&#123;print $2;exit&#125;'</span> $<span class=\"token punctuation\">&#123;</span>PASSFILE<span class=\"token punctuation\">&#125;</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;CORRECT_PASSWORD&#125;</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: User does not exist: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, password=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;password&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;password&#125;</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;CORRECT_PASSWORD&#125;</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span> </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Successful authentication: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">$&#123;TIME_STAMP&#125;</span>: Incorrect password: username=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;username&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, password=<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\">$&#123;password&#125;</span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>.\"</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;LOG_FILE&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 为脚本增加执⾏权限</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /etc/openvpn/check.sh</span></pre></td></tr></table></figure><p>3、创建⽤户密码⽂件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 创建 `check.sh` 脚本中定义 `openvpn` 使⽤的⽤户和密码认证⽂件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /etc/openvpn/openvpnfile <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>xuyong 123456</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p>4、重启 OpenVPN 服务</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart openvpn@server</span></pre></td></tr></table></figure><h5 id=\"72-openvpn客户端配置\"><a class=\"anchor\" href=\"#72-openvpn客户端配置\">#</a> 7.2 OpenVPN 客户端配置</h5>\n<p>1、修改客户端配置 C:\\Program Files\\OpenVPN\\config</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改客户端配置文件，增加如下代码，使其支持用户名 / 密码与服务器进行身份验证；</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>auth-user-pass                <span class=\"token comment\">#用户密码认证</span></pre></td></tr></table></figure><p>2、客户端重新登陆</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HwnEpBm.jpeg\" alt=\"Snipaste_2025-06-07_23-10-45.jpg\" /></p>\n<h4 id=\"八-openvpn访问内部网段\"><a class=\"anchor\" href=\"#八-openvpn访问内部网段\">#</a> 八、OpenVPN 访问内部⽹段</h4>\n<h5 id=\"81-内部节点无法正常访问\"><a class=\"anchor\" href=\"#81-内部节点无法正常访问\">#</a> <strong>8.1</strong> 内部节点无法正常访问</h5>\n<p>抓包分析数据包能抵达 openvpn 的内⽹地址，但⽆法与 OpenVPN 服务同内⽹⽹段主机进⾏通信；</p>\n<p>因为后端主机没有去往 10.8.0.0 ⽹段的路由，所以数据包⽆法原路返回，最终造成⽆法 ping 通</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@windows ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 172.16.1.51 -t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>正在 Ping <span class=\"token number\">172.16</span>.1.51 具有 <span class=\"token number\">32</span> 字节的数据:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>请求超时。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#在后端的主机上抓包分析，发现能接收到数据包，但没有回去的路由所以⽆法通信</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> tcpdump  <span class=\"token parameter variable\">-i</span> eth1 <span class=\"token parameter variable\">-nn</span> <span class=\"token parameter variable\">-p</span> icmp</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>tcpdump: verbose output suppressed, use <span class=\"token parameter variable\">-v</span> or <span class=\"token parameter variable\">-vv</span> <span class=\"token keyword\">for</span> full protocol decode</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listening on eth1, link-type EN10MB <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>, capture size <span class=\"token number\">262144</span> bytes</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">16</span>:44:54.957022 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">137</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">16</span>:44:59.956197 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">138</span>, length <span class=\"token number\">40</span></pre></td></tr></table></figure><p>解决此问题有如下⼏种⽅式：</p>\n<p>⽅式 1：在每台节点添加⼀条路由，下⼀跳为 Openvpn 节点；</p>\n<p>⽅式 2：在所有内⽹主机的默认路由器上添加⼀条路由，下⼀跳为 Openvpn 节点；</p>\n<p>⽅式 3：配置 iptables、firewalld 的 NAT 规则</p>\n<h5 id=\"82-在节点上添加主机路由\"><a class=\"anchor\" href=\"#82-在节点上添加主机路由\">#</a> 8.2 在节点上添加主机路由</h5>\n<p>1、在后端主机添加抵达去往 10.8.0.0/24 ⽹段的⾛ openvpn 的内⽹地址进⾏路由（原理如下图）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HKR4TLX.jpeg\" alt=\"1.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> route <span class=\"token function\">add</span> <span class=\"token parameter variable\">-net</span> <span class=\"token number\">10.8</span>.0.0/24 gw <span class=\"token number\">172.16</span>.1.70</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># route -n</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Kernel IP routing table</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">192.168</span>.40.2    <span class=\"token number\">0.0</span>.0.0         UG    <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">10.8</span>.0.0        <span class=\"token number\">172.16</span>.1.70     <span class=\"token number\">255.255</span>.255.0   UG    <span class=\"token number\">0</span>      <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.1.0      <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">101</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.40.0    <span class=\"token number\">0.0</span>.0.0         <span class=\"token number\">255.255</span>.255.0   U     <span class=\"token number\">100</span>    <span class=\"token number\">0</span>        <span class=\"token number\">0</span> eth0</pre></td></tr></table></figure><p>2、添加完路由后，继续 ping 该节点，在抓包查看</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> tcpdump  <span class=\"token parameter variable\">-i</span> eth1 <span class=\"token parameter variable\">-nn</span> <span class=\"token parameter variable\">-p</span> icmp</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcpdump: verbose output suppressed, use <span class=\"token parameter variable\">-v</span> or <span class=\"token parameter variable\">-vv</span> <span class=\"token keyword\">for</span> full protocol decode</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>listening on eth1, link-type EN10MB <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>, capture size <span class=\"token number\">262144</span> bytes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">16</span>:48:14.054654 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">240</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">16</span>:48:14.054673 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">240</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">16</span>:48:15.055662 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">241</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">16</span>:48:15.055683 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">241</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">16</span>:48:16.056026 IP <span class=\"token number\">10.8</span>.0.10 <span class=\"token operator\">></span> <span class=\"token number\">172.16</span>.1.51: ICMP <span class=\"token builtin class-name\">echo</span> request, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">242</span>, length <span class=\"token number\">40</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">16</span>:48:16.056046 IP <span class=\"token number\">172.16</span>.1.51 <span class=\"token operator\">></span> <span class=\"token number\">10.8</span>.0.10: ICMP <span class=\"token builtin class-name\">echo</span> reply, <span class=\"token function\">id</span> <span class=\"token number\">1</span>, <span class=\"token function\">seq</span> <span class=\"token number\">242</span>, length <span class=\"token number\">40</span></pre></td></tr></table></figure><p>3、通过 vpn 连接内⽹服务器，检查内⽹服务器与哪个 IP 建⽴连接（会发现是真实的 VPN 客户端节点）；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn-client ~<span class=\"token punctuation\">]</span> <span class=\"token function\">netstat</span> <span class=\"token parameter variable\">-nt</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Active Internet connections <span class=\"token punctuation\">(</span>w/o servers<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Proto Recv-Q Send-Q Local Address           Foreign Address         State      </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.51:22          <span class=\"token number\">10.8</span>.0.10:53947         ESTABLISHED</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.51:22        <span class=\"token number\">192.168</span>.40.1:53130      ESTABLISHED</pre></td></tr></table></figure><h5 id=\"83-配置nat地址替换\"><a class=\"anchor\" href=\"#83-配置nat地址替换\">#</a> 8.3 配置 NAT 地址替换</h5>\n<p>如上的配置需要在所有后端主机添加，如果机器量过多，那么添加起来⾮常的麻烦，可以在 VPN 节点上增加防⽕墙规则配置，实现地址替换（原理如下图）</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bhcIl0l.jpeg\" alt=\"2.jpg\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Iptables</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j MASQUERADE    # ⾃动</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth1 -j SNAT --to 172.16.1.70</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Firewalld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start firewalld</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --add\u0002service=openvpn --permanent</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --add-masquerade --permanent</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># firewall-cmd --reload</span></pre></td></tr></table></figure><p>2. 通过 vpn 连接内⽹服务器，检查内⽹服务器与哪个 IP 建⽴连接（会发现是 SNAT 后的内⽹ IP）；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@windows ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh root@172.16.1.51</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -nt|grep 22</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.51:22        <span class=\"token number\">192.168</span>.40.1:60083      ESTABLISHED</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>     <span class=\"token number\">36</span> <span class=\"token number\">172.16</span>.1.51:22          <span class=\"token number\">172.16</span>.1.70:60439       ESTABLISHED</pre></td></tr></table></figure><h5 id=\"84-配置路由器路由条目公有云\"><a class=\"anchor\" href=\"#84-配置路由器路由条目公有云\">#</a> 8.4 配置路由器路由条⽬（公有云）</h5>\n<p><strong>实验环境准备</strong>：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JvZgcbw.jpeg\" alt=\"2.jpg\" /></p>\n<p>1. 华南 3 买三台，公网 IP，安全组放行 1194 端口；</p>\n<p>2. 西南购买 1 台，公网 IP；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/k6asgYc.jpeg\" alt=\"1.jpg\" /></p>\n<p><strong>实现场景 1：</strong><br />\n1.Windows 主机通过远程访问 vpn，能够直接链接阿里云内网主机；</p>\n<p>方法一：给路由器添加路由条目，指向 VPN 主机；</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/dHe7eNU.jpeg\" alt=\"5.jpg\" /></p>\n<p>方法二： 在 VPN 主机上使用 iptables 或 firewalld 规则；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>iptables <span class=\"token parameter variable\">-t</span> nat <span class=\"token parameter variable\">-A</span> POSTROUTING <span class=\"token parameter variable\">-s</span> <span class=\"token number\">10.8</span>.0.0/24 <span class=\"token parameter variable\">-o</span> eth0 <span class=\"token parameter variable\">-j</span> SNAT <span class=\"token parameter variable\">--to</span> <span class=\"token number\">172.16</span>.1.70</pre></td></tr></table></figure><p><strong>实现场景 2：</strong>\t<br />\n1. 西南 Linux 主机拨入 vpn 后，可以直接访问华南地域的内网；</p>\n<p><strong>实现场景 3：</strong><br />\n1.windows 和西南地区的 Linux 主机都拨入了 VPN，它们之间通过虚拟地址是可以互通；</p>\n<h4 id=\"九-openvp结合jumpserver\"><a class=\"anchor\" href=\"#九-openvp结合jumpserver\">#</a> 九、OpenVP 结合 Jumpserver</h4>\n<p>实现拨通 OpenVPN 后，仅能够访问 Jumpserver172.16.1.61.</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@openvpn easy-rsa<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/openvpn/server.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>port <span class=\"token number\">1194</span>                              <span class=\"token comment\">#端口</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>proto tcp                              <span class=\"token comment\">#协议</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>dev tun                                <span class=\"token comment\">#采用路由隧道模式 tun</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ca ca.crt                              <span class=\"token comment\">#ca 证书文件位置</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cert server.crt                        <span class=\"token comment\">#服务端公钥名称</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>key server.key                         <span class=\"token comment\">#服务端私钥名称</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>dh dh.pem                              <span class=\"token comment\">#交换证书</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>server <span class=\"token number\">10.8</span>.0.0 <span class=\"token number\">255.255</span>.255.0          <span class=\"token comment\">#给客户端分配地址池，注意：不能和 VPN 服务器内网网段有相同</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>push <span class=\"token string\">\"route 172.16.1.61 255.255.255.255\"</span>  <span class=\"token comment\">#允许客户端访问内网 172.16.1.61 主机，根据实际情况修改</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># push \"redirect-gateway def1\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># push \"dhcp-option DNS 8.8.8.8\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ifconfig-pool-persist ipp.txt       <span class=\"token comment\">#地址池记录文件位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>keepalive <span class=\"token number\">10</span> <span class=\"token number\">120</span>                    <span class=\"token comment\">#存活时间，10 秒 ping ⼀次，120 如未收到响应则视为断线</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>max-clients <span class=\"token number\">100</span>                     <span class=\"token comment\">#最多允许 100 个客户端连接</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>status openvpn-status.log           <span class=\"token comment\">#日志记录位置</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>verb <span class=\"token number\">3</span>                              <span class=\"token comment\">#openvpn 版本</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>client-to-client                    <span class=\"token comment\">#客户端与客户端之间通信</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>log /var/log/openvpn.log            <span class=\"token comment\">#openvpn 日志记录位置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>persist-key                         <span class=\"token comment\">#通过 keepalive 检测超时后，重新启动 VPN，不重新读取 keys，保留第一次使的 keys</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>persist-tun                         <span class=\"token comment\">#检测超时后，重新启动 VPN，一直保持 tun 是 linkup 的。否则网络会先 linkdown 然后再 linkup</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>duplicate-cn</pre></td></tr></table></figure>",
            "tags": [
                "Openvpn"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/570469260.html",
            "url": "http://ixuyong.cn/posts/570469260.html",
            "title": "ELK收集Kubernetes组件日志分析与实践",
            "date_published": "2025-06-05T11:06:21.000Z",
            "content_html": "<h3 id=\"elk收集kubernetes组件日志分析与实践\"><a class=\"anchor\" href=\"#elk收集kubernetes组件日志分析与实践\">#</a> ELK 收集 Kubernetes 组件日志分析与实践</h3>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Og7liF6.jpeg\" alt=\"Snipaste_2025-05-25_13-43-46.jpg\" /></p>\n<h4 id=\"一-elk创建namespace和secrets\"><a class=\"anchor\" href=\"#一-elk创建namespace和secrets\">#</a> 一、ELK 创建 Namespace 和 Secrets</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create ns logging</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin -n logging --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xyapples@163.com --docker-password=passwd</span></pre></td></tr></table></figure><h4 id=\"二-交付zookeeper集群至k8s\"><a class=\"anchor\" href=\"#二-交付zookeeper集群至k8s\">#</a> 二、交付 Zookeeper 集群至 K8S</h4>\n<h5 id=\"21-制作zk集群镜像\"><a class=\"anchor\" href=\"#21-制作zk集群镜像\">#</a> 2.1 制作 ZK 集群镜像</h5>\n<h6 id=\"211-dockerfile\"><a class=\"anchor\" href=\"#211-dockerfile\">#</a> 2.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、拷贝 Zookeeper 压缩包和配置文件</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">3.8</span>.4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ADD ./apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin.tar.gz /</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ADD ./zoo.cfg /apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin/conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 2、对 Zookeeper 文件夹名称重新命名</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>RUN <span class=\"token function\">mv</span> /apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin /zookeeper</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 3、拷贝 eentrpoint 的启动脚本文件</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 4、暴露 Zookeeper 端口</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>EXPOSE <span class=\"token number\">2181</span> <span class=\"token number\">2888</span> <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 5、执行启动脚本</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"212-zoocfg\"><a class=\"anchor\" href=\"#212-zoocfg\">#</a> 2.1.2 zoo.cfg</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat zoo.cfg </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 服务器之间或客户端与服务器之间维持心跳的时间间隔 tickTime 以毫秒为单位。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">tickTime</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_TICKTIME<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 集群中的 follower 服务器 (F) 与 leader 服务器 (L) 之间的初始连接心跳数 10* tickTime</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">initLimit</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_INIT_LIMIT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 集群中的 follower 服务器与 leader 服务器之间请求和应答之间能容忍的最多心跳数 5 * tickTime</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">syncLimit</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SYNC_LIMIT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 数据保存目录</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">dataDir</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_DATA_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 日志保存目录</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">dataLogDir</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_LOG_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 客户端连接端口</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">clientPort</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_CLIENT_PORT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 客户端最大连接数。# 根据自己实际情况设置，默认为 60 个</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">maxClientCnxns</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_MAX_CLIENT_CNXNS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 客户端获取 zookeeper 服务的当前状态及相关信息</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">4lw.commands.whitelist</span><span class=\"token operator\">=</span>*</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 三个接点配置，格式为： server. 服务编号 = 服务地址、LF 通信端口、选举端口</span></pre></td></tr></table></figure><h6 id=\"213-entrypoint\"><a class=\"anchor\" href=\"#213-entrypoint\">#</a> 2.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#设定变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_BIN_DIR</span><span class=\"token operator\">=</span>/zookeeper/bin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_CONF_DIR</span><span class=\"token operator\">=</span>/zookeeper/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、对配置文件中的字符串进行变量替换</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_TICKTIME<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_TICKTIME<span class=\"token operator\">:-</span>2000&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_INIT_LIMIT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_INIT_LIMIT<span class=\"token operator\">:-</span>10&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SYNC_LIMIT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SYNC_LIMIT<span class=\"token operator\">:-</span>5&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_LOG_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_LOG_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>logs&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_CLIENT_PORT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_CLIENT_PORT<span class=\"token operator\">:-</span>2181&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_MAX_CLIENT_CNXNS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_MAX_CLIENT_CNXNS<span class=\"token operator\">:-</span>60&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 3、准备 ZK 的集群节点地址，后期肯定是需要通过 ENV 的方式注入进来</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">server</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$&#123;server&#125;</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 4、在 datadir 目录中创建 myid 的文件，并填入对应的编号</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_MYID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span> $<span class=\"token punctuation\">(</span>hostname <span class=\"token operator\">|</span> sed 's#.<span class=\"token operator\">*</span><span class=\"token operator\">-</span>##g'<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token variable\">))</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$&#123;ZOOK_MYID<span class=\"token operator\">:-</span>99&#125;</span> <span class=\"token operator\">></span> <span class=\"token variable\">$&#123;ZOOK_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>/myid</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#5、前台运行 Zookeeper</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$&#123;ZOOK_BIN_DIR&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>./zkServer.sh start-foreground</pre></td></tr></table></figure><h6 id=\"214-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#214-构建镜像并推送仓库\">#</a> 2.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push  registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4</span></pre></td></tr></table></figure><h5 id=\"22-迁移zookeeper至k8s\"><a class=\"anchor\" href=\"#22-迁移zookeeper至k8s\">#</a> 2.2  迁移 zookeeper 至 K8S</h5>\n<h6 id=\"221-zookeeper-headless\"><a class=\"anchor\" href=\"#221-zookeeper-headless\">#</a> 2.2.1 zookeeper-headless</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-zookeeper-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: zookeeper-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: zookeeper</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: client</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: leader-follwer</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: selection</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">3888</span></pre></td></tr></table></figure><h6 id=\"222-zookeeper-sts\"><a class=\"anchor\" href=\"#222-zookeeper-sts\">#</a> 2.2.2 zookeeper-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim 02-zookeeper-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: zookeeper               </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"zookeeper-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: zookeeper</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: zookeeper</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"zookeeper\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: zookeeper</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4           </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: client</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: leader-follwer</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          containerPort: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: selection</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          containerPort: <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          value: <span class=\"token string\">\"server.1=zookeeper-0.zookeeper-svc.logging.svc.cluster.local:2888:3888 server.2=zookeeper-1.zookeeper-svc.logging.svc.cluster.local:2888:3888 server.3=zookeeper-2.zookeeper-svc.logging.svc.cluster.local:2888:3888\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则不介入流量</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            - <span class=\"token string\">'[[ \"$(/zookeeper/bin/zkServer.sh status 2>/dev/null|grep 2181)\" ]] &amp;&amp; exit 0 || exit 1'</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        livenessProbe:         <span class=\"token comment\"># 存活探针。如果不存活则根据重启策略进行重启</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            - <span class=\"token string\">'[[ \"$(/zookeeper/bin/zkServer.sh status 2>/dev/null|grep 2181)\" ]] &amp;&amp; exit 0 || exit 1'</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /logs</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"223-更新资源清单\"><a class=\"anchor\" href=\"#223-更新资源清单\">#</a> 2.2.3 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-zookeeper-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-zookeeper-sts.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>zookeeper-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>zookeeper-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>zookeeper-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          11m</pre></td></tr></table></figure><h6 id=\"224-检查zookeeper集群状态\"><a class=\"anchor\" href=\"#224-检查zookeeper集群状态\">#</a> 2.2.4 检查 zookeeper 集群状态</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># for i in 0 1 2 ; do kubectl exec zookeeper-$i -n logging -- /zookeeper/bin/zkServer.sh status; done</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Mode: follower</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Mode: leader</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Mode: follower</pre></td></tr></table></figure><h6 id=\"225-连接zookeeper集群\"><a class=\"anchor\" href=\"#225-连接zookeeper集群\">#</a> 2.2.5 连接 Zookeeper 集群</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it zookeeper-0 -n logging -- /bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># /zookeeper/bin/zkCli.sh -server zookeeper-svc</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>zk: zookeeper-svc<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  create /hello oldxu</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created /hello</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>zk: zookeeper-svc<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> get /hello</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>oldxu</pre></td></tr></table></figure><h4 id=\"三-交付kafka集群至k8s\"><a class=\"anchor\" href=\"#三-交付kafka集群至k8s\">#</a> 三、 交付 Kafka 集群至 K8S</h4>\n<h5 id=\"31-制作kafka集群镜像\"><a class=\"anchor\" href=\"#31-制作kafka集群镜像\">#</a> 3.1 制作 Kafka 集群镜像</h5>\n<h6 id=\"311-dockerfile\"><a class=\"anchor\" href=\"#311-dockerfile\">#</a> 3.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、调整时区</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span> /etc/timezone</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2、拷贝 kafka 软件以及 kafka 的配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">2.12</span>-2.2.0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ADD ./kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span>.tgz /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ADD ./server.properties /kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span>/config/server.properties</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 3、修改 kafka 的名称</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>RUN <span class=\"token function\">mv</span> /kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span> /kafka</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、启动脚本（修改 kafka 配置）</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 5、暴露 kafka 端口 9999 是 jmx 的端口</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EXPOSE <span class=\"token number\">9092</span> <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 6、运行启动脚本</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"312-serverproperties\"><a class=\"anchor\" href=\"#312-serverproperties\">#</a> 3.1.2 server.properties</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat server.properties </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">############################# Server Basics ############################# </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># broker 的 id，值为整数，且必须唯一，在一个集群中不能重复</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">broker.id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>BROKER_ID<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">############################# Socket Server Settings ############################# </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># kafka 监听端口，默认 9092</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">listeners</span><span class=\"token operator\">=</span>PLAINTEXT://<span class=\"token punctuation\">&#123;</span>LISTENERS<span class=\"token punctuation\">&#125;</span>:9092</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 处理网络请求的线程数量，默认为 3 个</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">num.network.threads</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 执行磁盘 IO 操作的线程数量，默认为 8 个 </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">num.io.threads</span><span class=\"token operator\">=</span><span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># socket 服务发送数据的缓冲区大小，默认 100KB</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">socket.send.buffer.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">102400</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># socket 服务接受数据的缓冲区大小，默认 100KB</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">socket.receive.buffer.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">102400</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># socket 服务所能接受的一个请求的最大大小，默认为 100M</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">socket.request.max.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">104857600</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">############################# Log Basics ############################# </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># kafka 存储消息数据的目录</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">log.dirs</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>KAFKA_DATA_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 每个 topic 默认的 partition</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">num.partitions</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 设置副本数量为 3, 当 Leader 的 Replication 故障，会进行故障自动转移。</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">default.replication.factor</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 在启动时恢复数据和关闭时刷新数据时每个数据目录的线程数量</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">num.recovery.threads.per.data.dir</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">############################# Log Flush Policy ############################# </span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\"># 消息刷新到磁盘中的消息条数阈值</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token assign-left variable\">log.flush.interval.messages</span><span class=\"token operator\">=</span><span class=\"token number\">10000</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\"># 消息刷新到磁盘中的最大时间间隔，1s</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">log.flush.interval.ms</span><span class=\"token operator\">=</span><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">############################# Log Retention Policy ############################# </span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># 日志保留小时数，超时会自动删除，默认为 7 天</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">log.retention.hours</span><span class=\"token operator\">=</span><span class=\"token number\">168</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># 日志保留大小，超出大小会自动删除，默认为 1G</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#log.retention.bytes=1073741824</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\"># 日志分片策略，单个日志文件的大小最大为 1G，超出后则创建一个新的日志文件</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token assign-left variable\">log.segment.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">1073741824</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\"># 每隔多长时间检测数据是否达到删除条件，300s</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\">log.retention.check.interval.ms</span><span class=\"token operator\">=</span><span class=\"token number\">300000</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\">############################# Zookeeper ############################# </span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># Zookeeper 连接信息，如果是 zookeeper 集群，则以逗号隔开</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token assign-left variable\">zookeeper.connect</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># 连接 zookeeper 的超时时间，6s</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token assign-left variable\">zookeeper.connection.timeout.ms</span><span class=\"token operator\">=</span><span class=\"token number\">6000</span></pre></td></tr></table></figure><h6 id=\"313-entrypoint\"><a class=\"anchor\" href=\"#313-entrypoint\">#</a> 3.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">KAFKA_DIR</span><span class=\"token operator\">=</span>/kafka</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">KAFKA_CONF</span><span class=\"token operator\">=</span>/kafka/config/server.properties</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 1、基于主机名 + 1 获取 Broker_id  这个是用来标识集群节点 在整个集群中必须唯一</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">BROKER_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span> $<span class=\"token punctuation\">(</span>hostname <span class=\"token operator\">|</span> sed 's#.<span class=\"token operator\">*</span><span class=\"token operator\">-</span>##g'<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token variable\">))</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">LISTENERS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span> <span class=\"token parameter variable\">-i</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 2、替换配置文件内容，后期 ZK 集群的地址通过 ENV 传递</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>BROKER_ID<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;BROKER_ID&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>LISTENERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;LISTENERS&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>KAFKA_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;KAFKA_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 3、启动 Kafka</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$&#123;KAFKA_DIR&#125;</span>/bin</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/export KAFKA_HEAP_OPTS/a export JMX_PORT=\"9999\"'</span> kafka-server-start.sh</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>./kafka-server-start.sh <span class=\"token punctuation\">..</span>/config/server.properties</pre></td></tr></table></figure><h6 id=\"314-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#314-构建镜像并推送仓库\">#</a> 3.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://archive.apache.org/dist/kafka/2.2.0/kafka_2.12-2.2.0.tgz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2</span></pre></td></tr></table></figure><h5 id=\"32-迁移kafka集群至k8s\"><a class=\"anchor\" href=\"#32-迁移kafka集群至k8s\">#</a> 3.2 迁移 Kafka 集群至 K8S</h5>\n<h6 id=\"321-kafka-headless\"><a class=\"anchor\" href=\"#321-kafka-headless\">#</a> 3.2.1 kafka-headless</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-kafka-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kafka-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: kafka</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: client</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: jmx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9999</span></pre></td></tr></table></figure><h6 id=\"322-kafka-sts\"><a class=\"anchor\" href=\"#322-kafka-sts\">#</a> 3.2.2 kafka-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-kafka-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kafka</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"kafka-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: kafka</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: kafka</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"kafka\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: kafka</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2 </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: client</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: jmxport</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          containerPort: <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          value: <span class=\"token string\">\"zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则不介入流量</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        livenessProbe:         <span class=\"token comment\"># 存活探针。如果不存活则根据重启策略进行重启</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"323-更新资源清单\"><a class=\"anchor\" href=\"#323-更新资源清单\">#</a> 3.2.3 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-kafka-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-kafka-sts.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME          READY   STATUS    RESTARTS       AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kafka-0       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              5m49s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kafka-1       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m43s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kafka-2       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              3m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#查看 kafka 是否注册到 zookeeper</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it zookeeper-0 -n logging -- /bin/bash</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@zookeeper-0:/<span class=\"token comment\"># /zookeeper/bin/zkCli.sh </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> get /brokers/ids/1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.85.201:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.85.201\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162470218\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> get /brokers/ids/2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.58.205:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.58.205\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162532658\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> get /brokers/ids/3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.195.1:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.195.1\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162649250\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"324-检查kafka集群\"><a class=\"anchor\" href=\"#324-检查kafka集群\">#</a> 3.2.4 检查 Kafka 集群</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建一个topic</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@kafka-0:/<span class=\"token comment\"># /kafka/bin/kafka-topics.sh --create --zookeeper zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181 --partitions 1 --replication-factor 3 --topic oldxu</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.模拟消息发布</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@kafka-1:/<span class=\"token comment\"># /kafka/bin/kafka-console-producer.sh --broker-list kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092 --topic oldxu</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span>hello kubernetes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span>hello world</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">3</span>.模拟消息订阅</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@kafka-2:/<span class=\"token comment\"># /kafka/bin/kafka-console-consumer.sh  --bootstrap-server kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092 --topic oldxu --from-beginning</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>hello kubernetes</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>hello world</pre></td></tr></table></figure><h4 id=\"四-交付efak至k8s\"><a class=\"anchor\" href=\"#四-交付efak至k8s\">#</a> 四、交付 efak 至 K8S</h4>\n<h5 id=\"41-制作efak镜像\"><a class=\"anchor\" href=\"#41-制作efak镜像\">#</a> 4.1 制作 efak 镜像</h5>\n<h6 id=\"411-dockerfile\"><a class=\"anchor\" href=\"#411-dockerfile\">#</a> 4.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、调整时区</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span> /etc/timezone</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2、拷贝 kafka 软件以及 kafka 的配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">3.0</span>.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ADD ./efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin.tar.gz /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ADD ./system-config.properties /efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span>/conf/system-config.properties</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 3、修改 efak 的名称</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>RUN <span class=\"token function\">mv</span> /efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span> /efak</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、环境变量</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ENV <span class=\"token assign-left variable\">KE_HOME</span><span class=\"token operator\">=</span>/efak</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ENV <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$KE_HOME</span>/bin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 5、启动脚本（修改 kafka 配置）</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 6、暴露 kafka 端口 9999 是 jmx 的端口</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>EXPOSE <span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 7、运行启动脚本</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"412-system-config\"><a class=\"anchor\" href=\"#412-system-config\">#</a> 4.1.2 system-config</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat system-config.properties </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 填写 zookeeper 集群列表</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">efak.zk.cluster.alias</span><span class=\"token operator\">=</span>cluster1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">cluster1.zk.list</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># broker 最大规模数量</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.broker.size</span><span class=\"token operator\">=</span><span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># zk 客户端线程数</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">kafka.zk.limit.size</span><span class=\"token operator\">=</span><span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># EFAK webui 端口</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">efak.webui.port</span><span class=\"token operator\">=</span><span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># kafka offset storage</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.offset.storage</span><span class=\"token operator\">=</span>kafka</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># kafka jmx uri</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.jmx.uri</span><span class=\"token operator\">=</span>service:jmx:rmi:///jndi/rmi://%s/jmxrmi</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># kafka metrics 指标，默认存储 15 天</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">efak.metrics.charts</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">efak.metrics.retain</span><span class=\"token operator\">=</span><span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># kafka sql topic records max</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">efak.sql.topic.records.max</span><span class=\"token operator\">=</span><span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">efak.sql.topic.preview.records.max</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># delete kafka topic token</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token assign-left variable\">efak.topic.token</span><span class=\"token operator\">=</span>keadmin</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\"># kafka sqlite 数据库地址（需要修改存储路径）</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token assign-left variable\">efak.driver</span><span class=\"token operator\">=</span>org.sqlite.JDBC</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token assign-left variable\">efak.url</span><span class=\"token operator\">=</span>jdbc:sqlite:<span class=\"token punctuation\">&#123;</span>EFAK_DATA_DIR<span class=\"token punctuation\">&#125;</span>/db/ke.db</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token assign-left variable\">efak.username</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\">efak.password</span><span class=\"token operator\">=</span>www.kafka-eagle.org</pre></td></tr></table></figure><h6 id=\"413-entrypoint\"><a class=\"anchor\" href=\"#413-entrypoint\">#</a> 4.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 1、变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">EFAK_DIR</span><span class=\"token operator\">=</span>/efak</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">EFAK_CONF</span><span class=\"token operator\">=</span>/efak/conf/system-config.properties</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、替换配置文件内容，后期 ZK 集群的地址通过 ENV 传递</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>EFAK_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>@g  <span class=\"token variable\">$&#123;EFAK_CONF&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span>@g  <span class=\"token variable\">$&#123;EFAK_CONF&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 3、启动 efka</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>/bin/ke.sh start</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">tail</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>/logs/ke_console.out</pre></td></tr></table></figure><h6 id=\"414-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#414-构建镜像并推送仓库\">#</a> 4.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://github.com/smartloli/kafka-eagle-bin/archive/v3.0.1.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0</span></pre></td></tr></table></figure><h5 id=\"42-迁移efak至k8s\"><a class=\"anchor\" href=\"#42-迁移efak至k8s\">#</a> 4.2 迁移 efak 至 K8S</h5>\n<h6 id=\"421-efak-deploy\"><a class=\"anchor\" href=\"#421-efak-deploy\">#</a> 4.2.1 efak-deploy</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-efak-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: efak</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: efak</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: efak</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: efak</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          value: <span class=\"token string\">\"zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181\"</span></pre></td></tr></table></figure><h6 id=\"422-efak-service\"><a class=\"anchor\" href=\"#422-efak-service\">#</a> 4.2.2 efak-service</h6>\n<pre><code># cat 02-efak-service.yaml \napiVersion: v1\nkind: Service\nmetadata:\n  name: efak-svc\n  namespace: logging\nspec:\n  selector:\n    app: efak\n  ports:\n  - port: 8048\n    targetPort: 8048\n</code></pre>\n<h6 id=\"423-efak-ingress\"><a class=\"anchor\" href=\"#423-efak-ingress\">#</a> 4.2.3 efak-ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-efak-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: efak-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"efak.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: efak-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port: </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">8048</span></pre></td></tr></table></figure><h6 id=\"424-更新资源清单\"><a class=\"anchor\" href=\"#424-更新资源清单\">#</a> 4.2.4 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-efak-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-efak-service.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-efak-ingress.yaml</span></pre></td></tr></table></figure><h6 id=\"425-访问efka\"><a class=\"anchor\" href=\"#425-访问efka\">#</a> 4.2.5 访问 efka</h6>\n<p>1、初始用户名密码 admin   123456</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Nq16u4z.png\" alt=\"1.png\" /></p>\n<p>2、查看 Topics</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9Bin9cr.png\" alt=\"2.png\" /></p>\n<p>3、查看 kafka 集群状态</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/U76YIck.png\" alt=\"3.png\" /></p>\n<p>4、查看 Zookeeper 集群状态</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/cY5LeWx.png\" alt=\"4.png\" /></p>\n<h4 id=\"五-交付elastic集群\"><a class=\"anchor\" href=\"#五-交付elastic集群\">#</a> 五、交付 Elastic 集群</h4>\n<ul>\n<li>ES 集群是由多个节点组成的，通过 <a href=\"http://cluster.name\">cluster.name</a> 设置 ES 集群名称，同时用于区分其它的 ES 集群。</li>\n<li>每个节点通过 <a href=\"http://node.name\">node.name</a> 参数来设定所在集群的节点名称。</li>\n<li>节点使用 discovery.send_hosts 参数来设定集群节点的列表。</li>\n<li>集群在第一次启动时，需要初始化，同时需要指定参与选举的 master 节点 IP，或节点名称。</li>\n<li>每个节点可以通过 node.master:true 设定为 master 角色，通过 node.data:true 设定为 data 角色。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep \"^[a-Z]\" /etc/elasticsearch/elasticsearch.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 集群名称 cluster.name: my-oldxu</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 节点名称 node.name: node1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 数据存储路径 path.data: /var/lib/elasticsearch</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 日志存储路径 path.logs: /var/log/elasticsearch</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 监听在本地哪个地址上 network.host: 10.0.0.100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 监听端口 http.port: 9200</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 集群主机列表 discovery.seed_hosts: [\"ip1\", \"ip2\", \"ip3\"]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 仅第一次启动集群时进行选举（可以填写 node.name 的名称）cluster.initial_master_nodes: [\"node01\", \"node02\", \"node03\"]</span></pre></td></tr></table></figure><h5 id=\"51-下载elastic镜像\"><a class=\"anchor\" href=\"#51-下载elastic镜像\">#</a> 5.1 下载 elastic 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull elasticsearch:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag elasticsearch:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6</span></pre></td></tr></table></figure><h5 id=\"52-交付es-service\"><a class=\"anchor\" href=\"#52-交付es-service\">#</a> 5.2 交付 ES-Service</h5>\n<p>创建 es-headlessService，为每个 ES Pod 设定固定的 DNS 名称，无论它是 Master 或是 Data，易或是 Coordinating</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-es-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: es</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: cluster</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: transport</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9300</span></pre></td></tr></table></figure><h5 id=\"53-交付es-master节点\"><a class=\"anchor\" href=\"#53-交付es-master节点\">#</a> 5.3 交付 ES-Master 节点</h5>\n<ol>\n<li>\n<p>ES 无法使用 root 直接启动，需要授权数据目录 UID=1000，同时还需要持久化 /usr/share/elasticsearch/data ；</p>\n</li>\n<li>\n<p>ES 所有节点都需要设定 vm.max_map_count 内核参数以及 ulimit；</p>\n</li>\n<li>\n<p>ES 启动是通过 ENV 环境变量传参来完成的；</p>\n<ul>\n<li>\n<p>集群名称、节点名称、角色类型；</p>\n</li>\n<li>\n<p>discovery.seed_hosts 集群地址列表；</p>\n</li>\n<li>\n<p>cluster.initial_master_nodes 初始集群参与选举的 master 节点名称；</p>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-es-master.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-master</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"es-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span>           <span class=\"token comment\"># es-pod 运行的实例</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:             <span class=\"token comment\"># 需要管理的 ES-Pod 标签</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: es</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: master</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: es</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: master</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:                       <span class=\"token comment\"># 定义 pod 规范</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:         <span class=\"token comment\"># 镜像拉取使用的认证信息</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      affinity:                 <span class=\"token comment\"># 设定 pod 反亲和</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"es\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - key: role</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>       <span class=\"token comment\"># 每个节点就是一个位置</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"chown -R 1000:1000 /usr/share/elasticsearch/data ; sysctl -w vm.max_map_count=262144; ulimit -n 65536\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      containers:               <span class=\"token comment\"># ES 主容器</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: es</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6 </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            memory: 4096Mi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            cpu: 300m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: cluster</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          containerPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: transport</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          containerPort: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: ES_JAVA_OPTS</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: <span class=\"token string\">\"-Xms1g -Xmx1g\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: cluster.name</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          value: es-cluster</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: node.name</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - name: node.master</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: node.data</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: discovery.seed_hosts</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0.es-svc,es-master-1.es-svc,es-master-2.es-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: cluster.initial_master_nodes</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0,es-master-1,es-master-2\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  volumeClaimTemplates: <span class=\"token comment\"># 动态 pvc</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"54-交付es-data节点\"><a class=\"anchor\" href=\"#54-交付es-data节点\">#</a> 5.4 交付 ES-Data 节点</h5>\n<ol>\n<li>\n<p>ES 无法使用 root 直接启动，需要授权数据目录 UID=1000，同时还需要持久化 /usr/share/elasticsearch/data</p>\n</li>\n<li>\n<p>ES 所有节点都需要设定 vm.max_map_count 内核参数以及 ulimit；</p>\n</li>\n<li>\n<p>ES 启动是通过 ENV 环境变量传参来完成的</p>\n<ul>\n<li>\n<p>集群名称、节点名称、角色类型</p>\n</li>\n<li>\n<p>discovery.seed_hosts 集群地址列表</p>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-es-data.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-data</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"es-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">2</span>           <span class=\"token comment\"># es-pod 运行的实例</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:             <span class=\"token comment\"># 需要管理的 ES-Pod 标签</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: es</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: data</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: es</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: data</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:                       <span class=\"token comment\"># 定义 pod 规范</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:         <span class=\"token comment\"># 镜像拉取使用的认证信息</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      affinity:                 <span class=\"token comment\"># 设定 pod 反亲和</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"es\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - key: role</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>       <span class=\"token comment\"># 每个节点就是一个位置</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"chown -R 1000:1000 /usr/share/elasticsearch/data ; sysctl -w vm.max_map_count=262144; ulimit -n 65536\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      containers:               <span class=\"token comment\"># ES 主容器</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: es</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6 </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            memory: 4096Mi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            cpu: 300m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: cluster</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          containerPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: transport</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          containerPort: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: ES_JAVA_OPTS</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: <span class=\"token string\">\"-Xms1g -Xmx1g\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: cluster.name</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          value: es-cluster</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: node.name</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - name: node.master</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: node.data</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: discovery.seed_hosts</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0.es-svc,es-master-1.es-svc,es-master-2.es-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  volumeClaimTemplates: <span class=\"token comment\"># 动态 pvc</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"55-更新资源清单\"><a class=\"anchor\" href=\"#55-更新资源清单\">#</a> 5.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-es-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-es-master.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-es-data.yaml</span></pre></td></tr></table></figure><h5 id=\"56-验证es集群\"><a class=\"anchor\" href=\"#56-验证es集群\">#</a> 5.6 验证 ES 集群</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 解析 headlessService 获取对应 ES 集群任一节点的 IP 地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># dig @10.96.0.10 es-svc.logging.svc.cluster.local  +short</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.58.229</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.122.191</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">172.16</span>.195.21</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">172.16</span>.122.129</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.32.164</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 通过 curl 访问 ES，检查 ES 集群是否正常（如果仅交付 Master，没有 data 节点，集群状态可能会 Red，因为没有数据节点进行数据存储；）</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># curl -XGET \"http://172.16.122.129:9200/_cluster/health?pretty\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token string\">\"cluster_name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"es-cluster\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token string\">\"status\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"green\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token string\">\"timed_out\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token string\">\"number_of_nodes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token string\">\"number_of_data_nodes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token string\">\"active_primary_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"active_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token string\">\"relocating_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token string\">\"initializing_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token string\">\"unassigned_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token string\">\"delayed_unassigned_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token string\">\"number_of_pending_tasks\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token string\">\"number_of_in_flight_fetch\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token string\">\"task_max_waiting_in_queue_millis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token string\">\"active_shards_percent_as_number\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100.0</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#3. 查看 ES 各个节点详情</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># curl -XGET \"http://172.16.122.129:9200/_cat/nodes\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">172.16</span>.122.129 <span class=\"token number\">16</span> <span class=\"token number\">33</span> <span class=\"token number\">20</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.56</span> <span class=\"token number\">0.38</span> ilmr       - es-master-2</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">172.16</span>.58.229  <span class=\"token number\">66</span> <span class=\"token number\">33</span> <span class=\"token number\">22</span> <span class=\"token number\">0.64</span> <span class=\"token number\">0.66</span> <span class=\"token number\">0.44</span> ilmr       * es-master-1</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">172.16</span>.122.191 <span class=\"token number\">52</span> <span class=\"token number\">34</span> <span class=\"token number\">15</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.56</span> <span class=\"token number\">0.38</span> cdfhilrstw - es-data-0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">172.16</span>.195.21  <span class=\"token number\">38</span> <span class=\"token number\">35</span> <span class=\"token number\">19</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.53</span> <span class=\"token number\">0.36</span> cdfhilrstw - es-data-1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">172.16</span>.32.164  <span class=\"token number\">31</span> <span class=\"token number\">33</span> <span class=\"token number\">12</span> <span class=\"token number\">0.28</span> <span class=\"token number\">0.50</span> <span class=\"token number\">0.59</span> ilmr       - es-master-0</pre></td></tr></table></figure><h4 id=\"六-交付kibana可视化\"><a class=\"anchor\" href=\"#六-交付kibana可视化\">#</a> 六、交付 Kibana 可视化</h4>\n<h5 id=\"61-下载kibana镜像\"><a class=\"anchor\" href=\"#61-下载kibana镜像\">#</a> 6.1 下载 kibana 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull kibana:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag kibana:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6</span></pre></td></tr></table></figure><h5 id=\"62-kibana-deploy\"><a class=\"anchor\" href=\"#62-kibana-deploy\">#</a> 6.2 kibana-deploy</h5>\n<ol>\n<li>Kibana 需要连接 ES 集群，通过 ELASTICSEARCH_HOSTS 变量来传递 ES 集群地址</li>\n<li>kibana 通过 I18N_LOCALE 来传递语言环境</li>\n<li>Kibana 通过 SERVER_PUBLICBASEURL 来传递服务访问的公开地址</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-kibana-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: kibana</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: kibana</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: kibana</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - containerPort: <span class=\"token number\">5601</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - name: ELASTICSEARCH_HOSTS</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          value: <span class=\"token string\">'[\"http://es-data-0.es-svc:9200\",\"http://es-data-1.es-svc:9200\"]'</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: I18N_LOCALE</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          value: <span class=\"token string\">\"zh-CN\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: SERVER_PUBLICBASEURL</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          value: <span class=\"token string\">\"http://kibana.hmallleasing.com\"</span>   <span class=\"token comment\">#kibana 访问 UI</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"63-kibana-svc\"><a class=\"anchor\" href=\"#63-kibana-svc\">#</a> 6.3 kibana-svc</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-kibana-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: kibana</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - name: web</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    port: <span class=\"token number\">5601</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">5601</span></pre></td></tr></table></figure><h5 id=\"64-kibana-ingress\"><a class=\"anchor\" href=\"#64-kibana-ingress\">#</a> 6.4 kibana-ingress</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-kibana-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"kibana.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: kibana-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">5601</span></pre></td></tr></table></figure><h5 id=\"65-更新资源清单\"><a class=\"anchor\" href=\"#65-更新资源清单\">#</a> 6.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-kibana-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-kibana-svc.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-kibana-ingress.yaml</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>efak-5cdc74bf59-nrhb4     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h33m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>es-data-0                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          16m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>es-data-1                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>es-master-0               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>es-master-1               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>es-master-2               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kafka-0                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h39m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kafka-1                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h39m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kafka-2                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h38m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kibana-5ccc46864b-ndzx9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          118s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>zookeeper-0               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h42m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>zookeeper-1               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h42m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>zookeeper-2               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h41m</pre></td></tr></table></figure><h5 id=\"66-访问kibana\"><a class=\"anchor\" href=\"#66-访问kibana\">#</a> 6.6 访问 kibana</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sUXTx1J.png\" alt=\"1.png\" /></p>\n<h4 id=\"七-daemonset运行日志agent实践\"><a class=\"anchor\" href=\"#七-daemonset运行日志agent实践\">#</a> 七、DaemonSet 运行日志 Agent 实践</h4>\n<h5 id=\"71-部署架构说明\"><a class=\"anchor\" href=\"#71-部署架构说明\">#</a> 7.1 部署架构说明</h5>\n<p>对于那些将日志输出到，stdout 与 stderr 的 Pod，可以直接使用 DaemonSet 控制器在每个 Node 节点上运行一个 filebeat、logstash、fluentd 容器进行统一的收集，而后写入到日志存储系统</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/UOlaNE1.png\" alt=\"1.png\" /></p>\n<h5 id=\"72-创建serviceaccount\"><a class=\"anchor\" href=\"#72-创建serviceaccount\">#</a> 7.2 创建 ServiceAccount</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create serviceaccount filebeat <span class=\"token parameter variable\">-n</span> logging</pre></td></tr></table></figure><h5 id=\"73-创建clusterrole\"><a class=\"anchor\" href=\"#73-创建clusterrole\">#</a> 7.3 创建 ClusterRole</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create clusterrole filebeat <span class=\"token parameter variable\">--verb</span><span class=\"token operator\">=</span>get,list,watch <span class=\"token parameter variable\">--resource</span><span class=\"token operator\">=</span>namespace,pods,nodes</pre></td></tr></table></figure><h5 id=\"74-创建clusterrolebinding\"><a class=\"anchor\" href=\"#74-创建clusterrolebinding\">#</a> 7.4 创建 ClusterRolebinding</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create clusterrolebinding filebeat <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>logging:filebeat <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>filebeat</pre></td></tr></table></figure><h5 id=\"75-交付filebeat\"><a class=\"anchor\" href=\"#75-交付filebeat\">#</a> 7.5 交付 Filebeat</h5>\n<h6 id=\"751-下载filebeat镜像\"><a class=\"anchor\" href=\"#751-下载filebeat镜像\">#</a> <strong>7.5.1 下载 filebeat 镜像</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull docker.elastic.co/beats/filebeat:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag docker.elastic.co/beats/filebeat:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat:7.17.6</span></pre></td></tr></table></figure><h6 id=\"752-交付filebeat\"><a class=\"anchor\" href=\"#752-交付filebeat\">#</a> <strong>7.5.2 交付 filebeat</strong></h6>\n<ol>\n<li>从 ConfigMap 中挂载 filebeat.yaml 配置文件；</li>\n<li>挂载 /var/log、/var/lib/docker/containers 日志相关目录；</li>\n<li>使用 hostPath 方式挂载 /usr/share/filebeat/data 数据目录，该目录下有一个 registry 文件，里面记录了 filebeat 采集日志位置的相关内容，比如文件 offset、source、timestamp 等，如果 Pod 发生异常后 K8S 自动将 Pod 进行重启，不挂载的情况下 registry 会被重置，将导致日志文件又从 offset=0 开始采集，会造成重复收集日志。</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 07-filebeat-daemoset<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-filebeat-ds.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: DaemonSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: filebeat</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      app: filebeat</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        app: filebeat</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      serviceAccountName: <span class=\"token string\">\"filebeat\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      tolerations:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - key: node-role.kubernetes.io/master</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        operator: <span class=\"token string\">\"Exists\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        effect: <span class=\"token string\">\"NoSchedule\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat:7.17.6</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        args: <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          <span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"/etc/filebeat.yml\"</span>,</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          <span class=\"token string\">\"-e\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          runAsUser: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            memory: 300Mi</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: config                          <span class=\"token comment\"># 从 ConfigMap 中读取</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          mountPath: /etc/filebeat.yml</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          subPath: filebeat.yml</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: varlog</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          mountPath: /var/log</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: varlibdockercontainers</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          mountPath: /var/lib/docker/containers</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          mountPath: /usr/share/filebeat/data</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          name: filebeat-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: varlog</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          path: /var/log</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: varlibdockercontainers</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /var/lib/docker/containers</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: data</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          path: /var/lib/filebeat-data</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          type: DirectoryOrCreate</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h6 id=\"753-filebeat配置文件\"><a class=\"anchor\" href=\"#753-filebeat配置文件\">#</a> 7.5.3 Filebeat 配置文件</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-filebeat-configmap.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: filebeat-config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  filebeat.yml: <span class=\"token operator\">|</span>-</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\"># ============================== Filebeat inputs ==============================</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    logging.level: warning</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    filebeat.inputs:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - type: log</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      encoding: utf-8</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      paths: /var/log/messages</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      include_lines: <span class=\"token punctuation\">[</span><span class=\"token string\">'kubelet'</span><span class=\"token punctuation\">]</span>            <span class=\"token comment\"># 获取与 kubelet 相关的日志</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      fields:                               <span class=\"token comment\"># 添加 filebeat 字段</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        namespace: kubelet</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      fields_under_root: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token comment\"># ============================== Filebeat autodiscover ============================</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    filebeat.autodiscover:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      providers:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - type: kubernetes</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          templates:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          - condition:\t\t\t\t\t\t<span class=\"token comment\"># 匹配 kube-system 名称空间下所有日志</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              equals:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                kubernetes.namespace: kube-system</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              - type: container</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                stream: all\t\t\t\t\t<span class=\"token comment\"># 收集 stdout、stderr 类型日志，all 是所有</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                encoding: utf-8</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                paths: /var/log/containers/*-<span class=\"token variable\">$&#123;data.kubernetes.container.id&#125;</span>.log</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                exclude_lines: <span class=\"token punctuation\">[</span><span class=\"token string\">'info'</span><span class=\"token punctuation\">]</span>     <span class=\"token comment\"># 排除 info 相关的日志</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          - condition:                      <span class=\"token comment\"># 收集 ingress-nginx 命名空间下 stdout 日志</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              equals:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                kubernetes.namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              - type: container</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                stream: stdout</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>                encoding: utf-8</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                paths: /var/log/containers/*-<span class=\"token variable\">$&#123;data.kubernetes.container.id&#125;</span>.log</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                json.keys_under_root: <span class=\"token boolean\">true</span>  <span class=\"token comment\"># 默认将 json 解析存储至 messages，true 则不存储至 message</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                json.overwrite_keys: <span class=\"token boolean\">true</span>   <span class=\"token comment\"># 覆盖默认 message 字段，使用自定义 json 格式的 key</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                <span class=\"token comment\">#exclude_lines: ['kibana']   # 与 kibana 相关的则排除</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - condition:                              <span class=\"token comment\"># 收集 ingress-nginx 命名空间下 stderr 日志</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              equals:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                kubernetes.namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            config:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              - type: container</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                stream: stderr</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                encoding: utf-8</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                paths:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                  - /var/log/containers/*-<span class=\"token variable\">$&#123;data.kubernetes.container.id&#125;</span>.log</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    <span class=\"token comment\"># ============================== Filebeat Processors ===========================</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    processors:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - rename:                              <span class=\"token comment\"># 重写 kubernetes 源数据信息</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          fields:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          - from: <span class=\"token string\">\"kubernetes.namespace\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            to: <span class=\"token string\">\"namespace\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          - from: <span class=\"token string\">\"kubernetes.pod.name\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            to: <span class=\"token string\">\"podname\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          - from: <span class=\"token string\">\"kubernetes.pod.ip\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            to: <span class=\"token string\">\"podip\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - drop_fields:                        <span class=\"token comment\"># 删除无用的字段</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          fields: <span class=\"token punctuation\">[</span><span class=\"token string\">\"host\"</span>,<span class=\"token string\">\"agent\"</span>,<span class=\"token string\">\"ecs\"</span>,<span class=\"token string\">\"input\"</span>,<span class=\"token string\">\"container\"</span>,<span class=\"token string\">\"kubernetes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    <span class=\"token comment\"># ================================== Kafka Output ===================================</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>    output.kafka:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>      hosts: <span class=\"token punctuation\">[</span><span class=\"token string\">\"kafka-0.kafka-svc:9092\"</span>,<span class=\"token string\">\"kafka-1.kafka-svc:9092\"</span>,<span class=\"token string\">\"kafka-2.kafka-svc:9092\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      topic: <span class=\"token string\">\"app-%&#123;[namespace]&#125;\"</span>\t<span class=\"token comment\"># %&#123;[namespace]&#125; 会自动将其转换为 namespace 对应的值</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>      required_acks: <span class=\"token number\">1</span>              <span class=\"token comment\"># 保证消息可靠，0 不保证，1 等待写入主分区（默认）-1 等待写入副本分区</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>      compression: <span class=\"token function\">gzip</span>             <span class=\"token comment\"># 压缩</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>      max_message_bytes: <span class=\"token number\">1000000</span>    <span class=\"token comment\"># 每条消息最大的长度，多余的被删除</span></pre></td></tr></table></figure><h6 id=\"754-收集ingress-nginx名称空间\"><a class=\"anchor\" href=\"#754-收集ingress-nginx名称空间\">#</a> 7.5.4 收集 ingress-nginx 名称空间</h6>\n<p>修改 Ingress 日志输出格式</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl edit configmap -n ingress-nginx ingress-nginx-controller </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  log-format-upstream: <span class=\"token string\">'&#123;\"timestamp\":\"$time_iso8601\",\"domain\":\"$server_name\",\"hostname\":\"$hostname\",\"remote_user\":\"$remote_user\",\"clientip\":\"$remote_addr\",\"proxy_protocol_addr\":\"$proxy_protocol_addr\",\"@source\":\"$server_addr\",\"host\":\"$http_host\",\"request\":\"$request\",\"args\":\"$args\",\"upstreamaddr\":\"$upstream_addr\",\"status\":\"$status\",\"upstream_status\":\"$upstream_status\",\"bytes\":\"$body_bytes_sent\",\"responsetime\":\"$request_time\",\"upstreamtime\":\"$upstream_response_time\",\"proxy_upstream_name\":\"$proxy_upstream_name\",\"x_forwarded\":\"$http_x_forwarded_for\",\"upstream_response_length\":\"$upstream_response_length\",\"referer\":\"$http_referer\",\"user_agent\":\"$http_user_agent\",\"request_length\":\"$request_length\",\"request_method\":\"$request_method\",\"scheme\":\"$scheme\",\"k8s_ingress_name\":\"$ingress_name\",\"k8s_service_name\":\"$service_name\",\"k8s_service_port\":\"$service_port\"&#125;'</span></pre></td></tr></table></figure><h6 id=\"755-更新资源清单\"><a class=\"anchor\" href=\"#755-更新资源清单\">#</a> 7.5.5 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> 01-filebeat-configmap.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> 02-filebeat-ds.yaml</pre></td></tr></table></figure><h6 id=\"756-检查kafka对应topic\"><a class=\"anchor\" href=\"#756-检查kafka对应topic\">#</a> 7.5.6 检查 kafka 对应 Topic</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/shg5F6T.png\" alt=\"PixPin_2025-06-05_16-02-45.png\" /></p>\n<h4 id=\"八-交付logstash\"><a class=\"anchor\" href=\"#八-交付logstash\">#</a> 八、 交付 Logstash</h4>\n<h5 id=\"81-下载logstash镜像\"><a class=\"anchor\" href=\"#81-下载logstash镜像\">#</a> 8.1 下载 Logstash 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull docker.elastic.co/logstash/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag docker.elastic.co/logstash/logstash-oss:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr></table></figure><h5 id=\"82-如何交付logstash\"><a class=\"anchor\" href=\"#82-如何交付logstash\">#</a> 8.2 如何交付 Logstash</h5>\n<ol>\n<li>Logstash 需要设定环境变量来调整主配置文件参数，比如：worker 运行数量，以及批量处理的最大条目是多少；</li>\n<li>Logstash 需要调整 JVM 堆内存使用的范围，没办法传参调整，但可以通过 postStart 来修改其文件对应的 jvm 参数；</li>\n<li>Logstash 需要配置文件，读取 Kafka 数据，而后通过 filter 处理，最后输出至 ES</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># /usr/share/logstash/config/logstash.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 可通过变量传参修改</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pipeline.workers: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pipeline.batch.size: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># /usr/share/logstash/config/jvm.options-Xms512m-Xmx512m</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># /usr/share/logstash/config/logstash.conf</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>input <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tkafka</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>filter <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"83-准备logstash配置\"><a class=\"anchor\" href=\"#83-准备logstash配置\">#</a> 8.3 准备 logstash 配置</h5>\n<p><strong>input 段含义</strong></p>\n<ol>\n<li>所有数据都从 kafka 集群中获取；</li>\n<li>获取 kafka 集群中 topic，主要有 app-kube-system、app-ingress-nginx、app-kubelet</li>\n</ol>\n<p><strong>filter 段含义</strong></p>\n<ol>\n<li>判断 namespace 等于 kubelet，则为其添加一个索引字段名称；</li>\n<li>判断 namespace 等于 kube-system，则为其添加一个索引字段名称；</li>\n<li>判断 namespace 等于 ingress-nginx，并且 stream 等于 stderr，则为其添加一个索引字段名称；</li>\n<li>判断 namespace 等于 ingress-nginx，并且 stream 等于 stdout，则使用 geoip 获取地址来源，使用 useragent 模块分析来访客户端设备，使用 date 处理时间，使用 mutate 转换对应字段格式，最后添加一个索引字段名称；</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat logstash-node.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>input <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tkafka <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tbootstrap_servers <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        group_id <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"logstash-node\"</span>     <span class=\"token comment\"># 消费者组名称</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        consumer_threads <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"3\"</span>         <span class=\"token comment\"># 理想情况下，您应该拥有与分区数一样多的线程，以实现完美的平衡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        topics <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"app-kube-system\"</span>,<span class=\"token string\">\"app-ingress-nginx\"</span>,<span class=\"token string\">\"app-kubelet\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t    codec <span class=\"token operator\">=</span><span class=\"token operator\">></span> json</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>filter <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">##########################################################################</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token string\">\"kubelet\"</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span>namespace<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\tmutate <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"16\"></td><td><pre> \t\t\tadd_field <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"target_index\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-%&#123;[namespace]&#125;-%&#123;+YYYY.MM.dd&#125;\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">##########################################################################</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token string\">\"kube-system\"</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span>namespace<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\tmutate <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre> \t\t\tadd_field <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"target_index\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-%&#123;[namespace]&#125;-%&#123;+YYYY.MM.dd&#125;\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\">##########################################################################</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span>namespace<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"ingress-nginx\"</span> and <span class=\"token punctuation\">[</span>stream<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"stdout\"</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\tgeoip <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        \t\t<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"clientip\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    \t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\tuseragent <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        \t\t<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"user_agent\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\ttarget <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"user_agent\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        \t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    \t\t<span class=\"token function\">date</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t<span class=\"token comment\"># 2022-10-08T13:13:20.000Z</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        \t\tmatch <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"timestamp\"</span>,<span class=\"token string\">\"ISO8601\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        \t\ttarget <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"@timestamp\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        \t\ttimezone <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"Asia/Shanghai\"</span>\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    \t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\tmutate <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\tconvert <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"bytes\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"integer\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"responsetime\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"float\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t\t\t<span class=\"token string\">\"upstreamtime\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"float\"</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t\tadd_field <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"target_index\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-%&#123;[namespace]&#125;-%&#123;[stream]&#125;-%&#123;+YYYY.MM.dd&#125;\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">##########################################################################</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span>namespace<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"ingress-nginx\"</span> and <span class=\"token punctuation\">[</span>stream<span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"stderr\"</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\tmutate <span class=\"token punctuation\">&#123;</span> </pre></td></tr><tr><td data-num=\"57\"></td><td><pre> \t\t  add_field <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span> <span class=\"token string\">\"target_index\"</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-%&#123;[namespace]&#125;-%&#123;[stream]&#125;-%&#123;+YYYY.MM.dd&#125;\"</span> <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>output <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    stdout <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        codec <span class=\"token operator\">=</span><span class=\"token operator\">></span> rubydebug</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    elasticsearch <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        hosts <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"es-data-0.es-svc:9200\"</span>,<span class=\"token string\">\"es-data-1.es-svc:9200\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        index <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"%&#123;[target_index]&#125;\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        template_overwrite <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"84-创建configmap\"><a class=\"anchor\" href=\"#84-创建configmap\">#</a> 8.4 创建 ConfigMap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create configmap logstash-node-conf --from-file<span class=\"token operator\">=</span>logstash.conf<span class=\"token operator\">=</span>conf/logstash-node.conf <span class=\"token parameter variable\">-n</span> logging</pre></td></tr></table></figure><h5 id=\"85-创建service\"><a class=\"anchor\" href=\"#85-创建service\">#</a> 8.5 创建 Service</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-logstash-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: logstash</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - port: <span class=\"token number\">9600</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">9600</span></pre></td></tr></table></figure><h5 id=\"86-交付logstash\"><a class=\"anchor\" href=\"#86-交付logstash\">#</a> 8.6 交付 Logstash</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-logstash-node-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-node</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"logstash-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: logstash</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      env: <span class=\"token function\">node</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: logstash</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        env: <span class=\"token function\">node</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - name: logstash</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6 </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        args: <span class=\"token punctuation\">[</span><span class=\"token string\">\"-f\"</span>,<span class=\"token string\">\"config/logstash.conf\"</span><span class=\"token punctuation\">]</span>                     <span class=\"token comment\"># 启动时指定加载的配置文件</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: PIPELINE_WORKERS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          value: <span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: PIPELINE_BATCH_SIZE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          value: <span class=\"token string\">\"10000\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        lifecycle:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          postStart:                                            <span class=\"token comment\"># 设定 JVM</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            exec:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              command:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              - <span class=\"token string\">\"sed -i -e '/^-Xms/c-Xms512m' -e '/^-Xmx/c-Xmx512m' /usr/share/logstash/config/jvm.options\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: data                                            <span class=\"token comment\"># 持久化数据目录</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          mountPath: /usr/share/logstash/data</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: conf</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /usr/share/logstash/config/logstash.conf</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          subPath: logstash.conf</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: conf</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          name: logstash-node-conf</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"87-更新资源清单\"><a class=\"anchor\" href=\"#87-更新资源清单\">#</a> 8.7 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> 01-logstash-svc.yaml </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> 02-logstash-node-sts.yaml</pre></td></tr></table></figure><h5 id=\"88-检查kibana索引\"><a class=\"anchor\" href=\"#88-检查kibana索引\">#</a> 8.8 检查 kibana 索引</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/DB4w8Ln.png\" alt=\"2.png\" /></p>\n<h4 id=\"九-kibana可视化\"><a class=\"anchor\" href=\"#九-kibana可视化\">#</a> 九、Kibana 可视化</h4>\n<h5 id=\"91-创建索引\"><a class=\"anchor\" href=\"#91-创建索引\">#</a> 9.1 创建索引</h5>\n<p>kube-system 索引</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/agOzRmb.png\" alt=\"3.png\" /></p>\n<p>ingress-stdout 索引</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Iv0xBBe.png\" alt=\"4.png\" /></p>\n<p>ingress-stderr 索引</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/RpbsKpc.png\" alt=\"1.png\" /></p>\n<p>kubelet 索引</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2JBN6fi.png\" alt=\"5.png\" /></p>\n<h5 id=\"92-日志展示\"><a class=\"anchor\" href=\"#92-日志展示\">#</a> 9.2 日志展示</h5>\n<p>app-ingress-nginx-stdout 索引日志</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Yyf0gyS.png\" alt=\"1.png\" /></p>\n<p>app-ingress-nginx-stderr 索引日志</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/dUWbjv3.png\" alt=\"2.png\" /></p>\n<p>app-kube-system 索引日志</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HQO7ECM.png\" alt=\"3.png\" /></p>\n<p>app-kubelet 索引日志</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/HN2BpY7.png\" alt=\"4.png\" /></p>\n<h5 id=\"93-图形展示\"><a class=\"anchor\" href=\"#93-图形展示\">#</a> 9.3 图形展示</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fcx5E8m.png\" alt=\"5.png\" /></p>\n",
            "tags": [
                "ELKStack"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1384812626.html",
            "url": "http://ixuyong.cn/posts/1384812626.html",
            "title": "Kubenetes部署Rabbitmq集群",
            "date_published": "2025-05-29T12:48:49.000Z",
            "content_html": "<h3 id=\"kubenetes部署rabbitmq集群\"><a class=\"anchor\" href=\"#kubenetes部署rabbitmq集群\">#</a> Kubenetes 部署 Rabbitmq 集群</h3>\n<h6 id=\"1-创建rbac权限\"><a class=\"anchor\" href=\"#1-创建rbac权限\">#</a> 1. 创建 RBAC 权限</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-rabbitmq-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  namespace: prod</pre></td></tr></table></figure><h6 id=\"2-创建集群的secret\"><a class=\"anchor\" href=\"#2-创建集群的secret\">#</a> 2. 创建集群的 Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-rabbitmq-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  password: talent</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  url: amqp://RABBITMQ_USER:RABBITMQ_PASS@rmq-cluster-balancer</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  username: superman</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"3-创建configmap\"><a class=\"anchor\" href=\"#3-创建configmap\">#</a> 3. 创建 ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-rabbitmq-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    addonmanager.kubernetes.io/mode: Reconcile</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled_plugins: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">[</span>rabbitmq_management,rabbitmq_peer_discovery_k8s<span class=\"token punctuation\">]</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    rabbitmq.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      loopback_users.guest <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      default_user <span class=\"token operator\">=</span> RABBITMQ_USER</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      default_pass <span class=\"token operator\">=</span> RABBITMQ_PASS</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">## Cluster </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cluster_formation.peer_discovery_backend <span class=\"token operator\">=</span> rabbit_peer_discovery_k8s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cluster_formation.k8s.host <span class=\"token operator\">=</span> kubernetes.default.svc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">#cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cluster_formation.k8s.address_type <span class=\"token operator\">=</span> <span class=\"token function\">hostname</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\"># prod is rabbitmq-cluster's namespace#</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      cluster_formation.k8s.hostname_suffix <span class=\"token operator\">=</span> .rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      cluster_formation.node_cleanup.interval <span class=\"token operator\">=</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      cluster_formation.node_cleanup.only_log_warning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      cluster_partition_handling <span class=\"token operator\">=</span> autoheal</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">## queue master locator</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      queue_master_locator <span class=\"token operator\">=</span> min-masters</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.min <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.max <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\"># memory</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      vm_memory_high_watermark.absolute <span class=\"token operator\">=</span> 100MB</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\"># disk</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      disk_free_limit.absolute <span class=\"token operator\">=</span> 2GB</pre></td></tr></table></figure><p><em>注：配置文件 cluster_formation.k8s.host 设置为 kubernetes.default.svc.cluster.local，然后就是各种连不上，后来换上 kubernetes.default.svc 就可以了，不知道是不是 k8s 新版本的问题。</em></p>\n<h6 id=\"4-创建集群的svc\"><a class=\"anchor\" href=\"#4-创建集群的svc\">#</a> 4. 创建集群的 svc</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-rabbitmq-cluster-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    app: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  name: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"5-创建statefulset\"><a class=\"anchor\" href=\"#5-创建statefulset\">#</a> 5. 创建 StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-rabbitmq-cluster-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  serviceName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-cluster\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-v</span> /etc/rabbitmq/rabbitmq.conf <span class=\"token variable\">$&#123;RABBITMQ_CONFIG_FILE&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exec</span> docker-entrypoint.sh rabbitmq-server</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: username</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              key: password </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: TZ</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          value: <span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: RABBITMQ_ERLANG_COOKIE</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          value: <span class=\"token string\">'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: K8S_SERVICE_NAME</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          value: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: POD_IP</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: RABBITMQ_USE_LONGNAME</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: RABBITMQ_NODENAME</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          value: rabbit@<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>K8S_SERVICE_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc.cluster.local</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: RABBITMQ_CONFIG_FILE</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: /var/lib/rabbitmq/rabbitmq.conf</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        name: rabbitmq</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          name: amqp</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        - mountPath: /etc/rabbitmq</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          name: config-volume</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      serviceAccountName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      - name: config-volume</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          - key: rabbitmq.conf</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            path: rabbitmq.conf</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          - key: enabled_plugins</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            path: enabled_plugins</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      accessModes:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      - ReadWriteMany</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"6-创建ingress\"><a class=\"anchor\" href=\"#6-创建ingress\">#</a> 6. 创建 Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"7-更新资源清单\"><a class=\"anchor\" href=\"#7-更新资源清单\">#</a> <strong>7. 更新资源清单</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmq-cluster-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m53s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rabbitmq-cluster-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m47s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rabbitmq-cluster-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rabbitmq-cluster-0 -n prod -- /bin/bash</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@rabbitmq-cluster-0:/<span class=\"token comment\"># rabbitmqctl cluster_status</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>RABBITMQ_ERLANG_COOKIE <span class=\"token function\">env</span> variable support is deprecated and will be REMOVED <span class=\"token keyword\">in</span> a future version. Use the <span class=\"token environment constant\">$HOME</span>/.erlang.cookie <span class=\"token function\">file</span> or the --erlang-cookie switch instead.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Cluster status of <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Basics</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Cluster name: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Disk Nodes</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Running Nodes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Versions</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Maintenance status</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Alarms</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Network Partitions</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>none<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Listeners</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>Feature flags</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>Flag: drop_unroutable_metric, state: enabled</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>Flag: empty_basic_get_metric, state: enabled</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>Flag: implicit_default_bindings, state: enabled</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Flag: maintenance_mode_status, state: enabled</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Flag: quorum_queue, state: enabled</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Flag: stream_queue, state: enabled</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Flag: user_limits, state: enabled</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Flag: virtual_host_metadata, state: enabled</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XqURJbg.jpeg\" alt=\"Snipaste_2025-05-17_17-42-47.jpg\" /></p>\n<h6 id=\"8-web访问rabbitmq\"><a class=\"anchor\" href=\"#8-web访问rabbitmq\">#</a> <strong>8. Web 访问 rabbitmq</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://rabbitmq.hmallleasing.com/<span class=\"token comment\">#/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user:superman</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pwd:talent</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7qKxUBf.jpeg\" alt=\"Snipaste_2025-05-17_17-14-54.jpg\" /></p>\n<h6 id=\"9-rabbitmq全部挂了无法重启解决方案\"><a class=\"anchor\" href=\"#9-rabbitmq全部挂了无法重启解决方案\">#</a> 9. rabbitMQ 全部挂了，无法重启解决方案</h6>\n<p>Kubernetes 环境中，遇到 RabbitMQ 集群无法启动的问题。原因是 RabbitMQ 所有实例均失效，需要在每个 Pod 对应的持久化存储路径下创建 force_load 文件来强制启动。通过获取 PV 存储路径，在指定目录创建该文件后，重新启动 RabbitMQ 服务，成功解决了集群启动问题</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token comment\"># cd /data/dev-rabbitmq-storage-rabbitmq-cluster-0-pvc-3abca920-3c68-44eb-b0fd-406a4358b153/mnesia/rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch force_load</span></pre></td></tr></table></figure>",
            "tags": [
                "Rabbitmq"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2692178654.html",
            "url": "http://ixuyong.cn/posts/2692178654.html",
            "title": "Rabbitmq集群部署",
            "date_published": "2025-05-29T12:35:53.000Z",
            "content_html": "<h3 id=\"rabbitmq集群部署\"><a class=\"anchor\" href=\"#rabbitmq集群部署\">#</a> Rabbitmq 集群部署</h3>\n<h4 id=\"一-环境配置\"><a class=\"anchor\" href=\"#一-环境配置\">#</a> 一、环境配置</h4>\n<h5 id=\"11-关闭防火墙-selinux\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux\">#</a> 1.1 关闭防火墙、Selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr></table></figure><h5 id=\"12-配置-yum-源\"><a class=\"anchor\" href=\"#12-配置-yum-源\">#</a> 1.2 配置 yum 源</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#rocky linux 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/rocky-*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>yum clean all <span class=\"token operator\">&amp;&amp;</span> yum makecache</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> /soft /data /scripts /backup</pre></td></tr></table></figure><h5 id=\"13-安装ntpdate\"><a class=\"anchor\" href=\"#13-安装ntpdate\">#</a> 1.3 安装 ntpdate</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><h5 id=\"14-配置时间同步\"><a class=\"anchor\" href=\"#14-配置时间同步\">#</a> 1.4 配置时间同步</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><h5 id=\"15-配置文件描述符\"><a class=\"anchor\" href=\"#15-配置文件描述符\">#</a> 1.5 配置文件描述符</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><h5 id=\"16-系统内核参数调优\"><a class=\"anchor\" href=\"#16-系统内核参数调优\">#</a> 1.6 系统内核参数调优</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/sysctl.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>vm.max_map_count = 262144</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vm.swappiness=1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>net.ipv4.tcp_fin_timeout=2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.tcp_tw_reuse=1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>#net.ipv4.tcp_tw_recycle=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>net.ipv4.tcp_syncookies=1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>net.ipv4.tcp_keepalive_time=600</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>net.ipv4.ip_local_port_range=4000 65000</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>net.ipv4.tcp_max_syn_backlog=16384</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.ipv4.route.gc_timeout=100</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>net.ipv4.tcp_max_tw_buckets= 5000</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_syn_retries=1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_synack_retries=1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.core.somaxconn=16384</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.core.netdev_max_backlog=16384</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans=16384</pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre># 设置最大内存共享段大小bytes</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kernel.shmmax=15461882265</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kernel.shmall=3774873</pre></td></tr><tr><td data-num=\"24\"></td><td><pre># 修改消息队列长度</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kernel.msgmax=65535</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kernel.msgmnb=65535</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"17-修改默认资源限制\"><a class=\"anchor\" href=\"#17-修改默认资源限制\">#</a> 1.7 修改默认资源限制</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/systemd/system.conf<span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DefaultLimitNOFILE=65536</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DefaultLimitNPROC=32000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DefaultLimitMEMLOCK=infinity</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"18-执行命令生效状态\"><a class=\"anchor\" href=\"#18-执行命令生效状态\">#</a> 1.8 执行命令生效状态</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><h5 id=\"19-安装基础软件包\"><a class=\"anchor\" href=\"#19-安装基础软件包\">#</a> 1.9 安装基础软件包</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> <span class=\"token function\">unzip</span> net-tools telnet tree yum-utils device-mapper-persistent-data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lvm2 <span class=\"token function\">git</span> nfs-utils iotop httpd-tools dos2unix lrzsz <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"110-升级系统\"><a class=\"anchor\" href=\"#110-升级系统\">#</a> 1.10 升级系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum update <span class=\"token parameter variable\">-y</span> <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>kernel* <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">reboot</span></pre></td></tr></table></figure><h4 id=\"二-rabbitmq集群部署\"><a class=\"anchor\" href=\"#二-rabbitmq集群部署\">#</a> 二、Rabbitmq 集群部署</h4>\n<h5 id=\"21-环境准备\"><a class=\"anchor\" href=\"#21-环境准备\">#</a> 2.1 环境准备</h5>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">192.168.40.101</th>\n<th style=\"text-align:center\">192.168.40.102</th>\n<th style=\"text-align:center\">192.168.40.103</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">master</td>\n<td style=\"text-align:center\">slave1</td>\n<td style=\"text-align:center\">slave2</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"22-修改hosts\"><a class=\"anchor\" href=\"#22-修改hosts\">#</a> 2.2 修改 hosts</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/hosts</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">192.168</span>.40.101 rabbitmq-01</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.40.102 rabbitmq-02</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.40.103 rabbitmq-03</pre></td></tr></table></figure><h5 id=\"23-配置hosts\"><a class=\"anchor\" href=\"#23-配置hosts\">#</a> 2.3 配置 hosts</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname rabbitmq-01</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>hostnamectl set-hostname rabbitmq-02</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>hostnamectl set-hostname rabbitmq-03</pre></td></tr></table></figure><h5 id=\"24-安装包下载\"><a class=\"anchor\" href=\"#24-安装包下载\">#</a> 2.4 安装包下载</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/rabbitmq/erlang-rpm/releases/download/v27.3.1/erlang-27.3.1-1.el8.x86_64.rpm</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> http://repo.iotti.biz/CentOS/7/x86_64/socat-1.7.3.2-5.el7.lux.x86_64.rpm</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">wget</span> https://github.com/rabbitmq/rabbitmq-server/releases/download/v4.1.0/rabbitmq-server-4.1.0-1.el8.noarch.rpm</pre></td></tr></table></figure><h5 id=\"25-安装rabbitmq\"><a class=\"anchor\" href=\"#25-安装rabbitmq\">#</a> 2.5 安装 rabbitmq</h5>\n<ul>\n<li>RabbitMQ 是采用 Erlang 语言开发的，所以系统环境必须提供 Erlang 环境，需要是安装 Erlang。</li>\n<li>在 RabiitMQ 安装过程中需要依赖 socat 插件，首先安装该插件。</li>\n<li>Erlang 和 RabbitMQ 版本对照： <a href=\"https://www.rabbitmq.com/which-erlang.html\">https://www.rabbitmq.com/which-erlang.html</a></li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum localinstall erlang-27.3.1-1.el8.x86_64.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum localinstall socat-1.7.3.2-5.el7.lux.x86_64.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>yum localinstall rabbitmq-server-4.1.0-1.el8.noarch.rpm <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"26-配置rabbitmq\"><a class=\"anchor\" href=\"#26-配置rabbitmq\">#</a> 2.6 配置 rabbitmq</h5>\n<p>所有节点创建自定义数据和日志目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /data/rabbitmq/data /data/rabbitmq/log</pre></td></tr></table></figure><p>所有节点编辑配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/rabbitmq/rabbitmq-env.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_MNESIA_BASE</span><span class=\"token operator\">=</span>/data/rabbitmq/data</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_LOG_BASE</span><span class=\"token operator\">=</span>/data/rabbitmq/log</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">RABBITMQ_ERLANG_COOKIE</span><span class=\"token operator\">=</span>/data/rabbitmq/.erlang.cookie</pre></td></tr></table></figure><p>所有节点赋予.erlang.cookie 文件权限（其他 2 台从节点 cookie 值要保持一致，权限为 owner 只读），RabbitMQ 的集群是依赖 erlang 集群，而 erlang 集群是通过这个 cookie 进行通信认证的。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /data/rabbitmq/.erlang.cookie</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>KAIJQVKJHAGMUCWXZGVG </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">chmod</span> <span class=\"token parameter variable\">-R</span> <span class=\"token number\">400</span> /data/rabbitmq/.erlang.cookie</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> rabbitmq.rabbitmq /data/rabbitmq/</pre></td></tr></table></figure><h5 id=\"27-rabbitmq启动\"><a class=\"anchor\" href=\"#27-rabbitmq启动\">#</a> 2.7 rabbitmq 启动</h5>\n<p>所有节点启动 web 管理插件和分片插件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rabbitmq-plugins <span class=\"token builtin class-name\">enable</span> rabbitmq_management</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmq-plugins <span class=\"token builtin class-name\">enable</span> rabbitmq_sharding</pre></td></tr></table></figure><p>所有节点设置开机自启</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> rabbitmq-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl restart rabbitmq-server</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl status rabbitmq-server</pre></td></tr></table></figure><h5 id=\"28-加入集群\"><a class=\"anchor\" href=\"#28-加入集群\">#</a> 2.8 加入集群</h5>\n<p>创建集群，在 node2 和 node3 上执行加入集群命令（主节点无需执行如下操作）:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 关闭服务</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl stop_app</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 加入集群</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl join_cluster rabbit@rabbitmq-01</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 启动服务</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl start_app</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 查看集群状态，任意节点执行</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>rabbitmqctl cluster_status</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/gWflncf.jpeg\" alt=\"Snipaste_2025-05-29_20-40-27.jpg\" /></p>\n<h5 id=\"29-配置rabbitmq权限\"><a class=\"anchor\" href=\"#29-配置rabbitmq权限\">#</a> 2.9 配置 rabbitmq 权限</h5>\n<p>rabbitmq 有一个默认的账号密码 guest，但该情况仅限于本机 localhost 进行访问，所以需要添加一个远程登录的用户。</p>\n<p><strong>角色有四种：</strong></p>\n<ul>\n<li>administrator：可以登录控制台、查看所有信息、并对 rabbitmq 进行管理</li>\n<li>monToring：监控者；登录控制台，查看所有信息</li>\n<li>policymaker：策略制定者；登录控制台指定策略</li>\n<li>managment：普通管理员；登录控制</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl add_user admin <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 为用户添加资源权限 (授予访问虚拟机根节点的所有权限)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/\"</span> admin <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 设置用户角色，分配操作权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl set_user_tags admin administrator</pre></td></tr></table></figure><p>这里创建用户 xuyong，密码 123456，设置 adminstator 角色，赋予所有权限</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 添加用户</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rabbitmqctl add_user xuyong <span class=\"token number\">123456</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 为用户添加资源权限 (授予访问虚拟机根节点的所有权限)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/\"</span> xuyong <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 新增虚拟主机</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rabbitmqctl add_vhost /xuyong</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 将新虚拟主机授权给新用户</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># rabbitmqctl set_permissions -p vhost_name username “.*” “.*” “.*”(后面三个”*” 代表用户拥有配置、写、读全部权限)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>rabbitmqctl set_permissions <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"/xuyong\"</span> xuyong <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span> <span class=\"token string\">\".*\"</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#查看权限</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rabbitmqctl list_permissions <span class=\"token parameter variable\">-p</span> /xuyong</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 设置用户角色，分配操作权限</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>rabbitmqctl set_user_tags xuyong administrator</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 删除 guest 用户</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbitmqctl delete_user guest</pre></td></tr></table></figure><p>在其他节点检查，账户是否已同步</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>rabbitmqctl list_users</pre></td></tr></table></figure><h5 id=\"210-访问rabbitmq\"><a class=\"anchor\" href=\"#210-访问rabbitmq\">#</a> 2.10 访问 rabbitmq</h5>\n<p>浏览器访问:<a href=\"http://192.168.40.101:15672/\">http://192.168.40.101:15672/</a><br />\n 用户名: admin<br />\n 密码：123456</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KQpvPU4.jpeg\" alt=\"Snipaste_2025-05-29_20-29-59.jpg\" /></p>\n",
            "tags": [
                "Rabbitmq"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/170066797.html",
            "url": "http://ixuyong.cn/posts/170066797.html",
            "title": "消费租赁项目Kubernetes基于ELK日志分析与实践",
            "date_published": "2025-05-25T06:35:21.000Z",
            "content_html": "<h3 id=\"消费租赁项目kubernetes基于elk日志分析与实践\"><a class=\"anchor\" href=\"#消费租赁项目kubernetes基于elk日志分析与实践\">#</a> 消费租赁项目 Kubernetes 基于 ELK 日志分析与实践</h3>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Og7liF6.jpeg\" alt=\"Snipaste_2025-05-25_13-43-46.jpg\" /></p>\n<h4 id=\"一-elk创建namespace和secrets\"><a class=\"anchor\" href=\"#一-elk创建namespace和secrets\">#</a> 一、ELK 创建 Namespace 和 Secrets</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create ns logging</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin -n logging --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xyapples@163.com --docker-password=passwd</span></pre></td></tr></table></figure><h4 id=\"二-交付zookeeper集群至k8s\"><a class=\"anchor\" href=\"#二-交付zookeeper集群至k8s\">#</a> 二、交付 Zookeeper 集群至 K8S</h4>\n<h5 id=\"21-制作zk集群镜像\"><a class=\"anchor\" href=\"#21-制作zk集群镜像\">#</a> 2.1 制作 ZK 集群镜像</h5>\n<h6 id=\"211-dockerfile\"><a class=\"anchor\" href=\"#211-dockerfile\">#</a> 2.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、拷贝 Zookeeper 压缩包和配置文件</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">3.8</span>.4</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ADD ./apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin.tar.gz /</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ADD ./zoo.cfg /apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin/conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 2、对 Zookeeper 文件夹名称重新命名</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>RUN <span class=\"token function\">mv</span> /apache-zookeeper-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin /zookeeper</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># 3、拷贝 eentrpoint 的启动脚本文件</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 4、暴露 Zookeeper 端口</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>EXPOSE <span class=\"token number\">2181</span> <span class=\"token number\">2888</span> <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 5、执行启动脚本</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"212-zoocfg\"><a class=\"anchor\" href=\"#212-zoocfg\">#</a> 2.1.2 zoo.cfg</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat zoo.cfg </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 服务器之间或客户端与服务器之间维持心跳的时间间隔 tickTime 以毫秒为单位。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">tickTime</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_TICKTIME<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 集群中的 follower 服务器 (F) 与 leader 服务器 (L) 之间的初始连接心跳数 10* tickTime</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">initLimit</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_INIT_LIMIT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 集群中的 follower 服务器与 leader 服务器之间请求和应答之间能容忍的最多心跳数 5 * tickTime</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">syncLimit</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SYNC_LIMIT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> </pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 数据保存目录</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">dataDir</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_DATA_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 日志保存目录</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">dataLogDir</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_LOG_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 客户端连接端口</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token assign-left variable\">clientPort</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_CLIENT_PORT<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 客户端最大连接数。# 根据自己实际情况设置，默认为 60 个</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">maxClientCnxns</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_MAX_CLIENT_CNXNS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 客户端获取 zookeeper 服务的当前状态及相关信息</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token assign-left variable\">4lw.commands.whitelist</span><span class=\"token operator\">=</span>*</pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 三个接点配置，格式为： server. 服务编号 = 服务地址、LF 通信端口、选举端口</span></pre></td></tr></table></figure><h6 id=\"213-entrypoint\"><a class=\"anchor\" href=\"#213-entrypoint\">#</a> 2.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#设定变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_BIN_DIR</span><span class=\"token operator\">=</span>/zookeeper/bin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_CONF_DIR</span><span class=\"token operator\">=</span>/zookeeper/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、对配置文件中的字符串进行变量替换</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_TICKTIME<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_TICKTIME<span class=\"token operator\">:-</span>2000&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_INIT_LIMIT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_INIT_LIMIT<span class=\"token operator\">:-</span>10&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SYNC_LIMIT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SYNC_LIMIT<span class=\"token operator\">:-</span>5&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_LOG_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_LOG_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>logs&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_CLIENT_PORT<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_CLIENT_PORT<span class=\"token operator\">:-</span>2181&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_MAX_CLIENT_CNXNS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_MAX_CLIENT_CNXNS<span class=\"token operator\">:-</span>60&#125;</span>@g <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 3、准备 ZK 的集群节点地址，后期肯定是需要通过 ENV 的方式注入进来</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">server</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$&#123;server&#125;</span> <span class=\"token operator\">>></span> <span class=\"token variable\">$&#123;ZOOK_CONF_DIR&#125;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 4、在 datadir 目录中创建 myid 的文件，并填入对应的编号</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token assign-left variable\">ZOOK_MYID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span> $<span class=\"token punctuation\">(</span>hostname <span class=\"token operator\">|</span> sed 's#.<span class=\"token operator\">*</span><span class=\"token operator\">-</span>##g'<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token variable\">))</span></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$&#123;ZOOK_MYID<span class=\"token operator\">:-</span>99&#125;</span> <span class=\"token operator\">></span> <span class=\"token variable\">$&#123;ZOOK_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>/myid</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#5、前台运行 Zookeeper</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$&#123;ZOOK_BIN_DIR&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>./zkServer.sh start-foreground</pre></td></tr></table></figure><h6 id=\"214-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#214-构建镜像并推送仓库\">#</a> 2.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://dlcdn.apache.org/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push  registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4</span></pre></td></tr></table></figure><h5 id=\"22-迁移zookeeper至k8s\"><a class=\"anchor\" href=\"#22-迁移zookeeper至k8s\">#</a> 2.2  迁移 zookeeper 至 K8S</h5>\n<h6 id=\"221-zookeeper-headless\"><a class=\"anchor\" href=\"#221-zookeeper-headless\">#</a> 2.2.1 zookeeper-headless</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-zookeeper-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: zookeeper-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: zookeeper</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: client</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: leader-follwer</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: selection</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">3888</span></pre></td></tr></table></figure><h6 id=\"222-zookeeper-sts\"><a class=\"anchor\" href=\"#222-zookeeper-sts\">#</a> 2.2.2 zookeeper-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim 02-zookeeper-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: zookeeper               </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"zookeeper-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: zookeeper</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: zookeeper</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"zookeeper\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: zookeeper</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/zookeeper:3.8.4           </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: client</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">2181</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: leader-follwer</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          containerPort: <span class=\"token number\">2888</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: selection</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          containerPort: <span class=\"token number\">3888</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          value: <span class=\"token string\">\"server.1=zookeeper-0.zookeeper-svc.logging.svc.cluster.local:2888:3888 server.2=zookeeper-1.zookeeper-svc.logging.svc.cluster.local:2888:3888 server.3=zookeeper-2.zookeeper-svc.logging.svc.cluster.local:2888:3888\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则不介入流量</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            - <span class=\"token string\">'[[ \"$(/zookeeper/bin/zkServer.sh status 2>/dev/null|grep 2181)\" ]] &amp;&amp; exit 0 || exit 1'</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        livenessProbe:         <span class=\"token comment\"># 存活探针。如果不存活则根据重启策略进行重启</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>            - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            - <span class=\"token string\">'[[ \"$(/zookeeper/bin/zkServer.sh status 2>/dev/null|grep 2181)\" ]] &amp;&amp; exit 0 || exit 1'</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /logs</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"223-更新资源清单\"><a class=\"anchor\" href=\"#223-更新资源清单\">#</a> 2.2.3 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-zookeeper-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-zookeeper-sts.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME          READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>zookeeper-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>zookeeper-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>zookeeper-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          11m</pre></td></tr></table></figure><h6 id=\"224-检查zookeeper集群状态\"><a class=\"anchor\" href=\"#224-检查zookeeper集群状态\">#</a> 2.2.4 检查 zookeeper 集群状态</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># for i in 0 1 2 ; do kubectl exec zookeeper-$i -n logging -- /zookeeper/bin/zkServer.sh status; done</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Mode: follower</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Mode: leader</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ZooKeeper JMX enabled by default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Using config: /zookeeper/bin/<span class=\"token punctuation\">..</span>/conf/zoo.cfg</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Client port found: <span class=\"token number\">2181</span>. Client address: localhost. Client SSL: false.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Mode: follower</pre></td></tr></table></figure><h6 id=\"225-连接zookeeper集群\"><a class=\"anchor\" href=\"#225-连接zookeeper集群\">#</a> 2.2.5 连接 Zookeeper 集群</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-zookeeper<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it zookeeper-0 -n logging -- /bin/sh</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># /zookeeper/bin/zkCli.sh -server zookeeper-svc</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>zk: zookeeper-svc<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span>  create /hello oldxu</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created /hello</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>zk: zookeeper-svc<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> get /hello</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>oldxu</pre></td></tr></table></figure><h4 id=\"三-交付kafka集群至k8s\"><a class=\"anchor\" href=\"#三-交付kafka集群至k8s\">#</a> 三、 交付 Kafka 集群至 K8S</h4>\n<h5 id=\"31-制作kafka集群镜像\"><a class=\"anchor\" href=\"#31-制作kafka集群镜像\">#</a> 3.1 制作 Kafka 集群镜像</h5>\n<h6 id=\"311-dockerfile\"><a class=\"anchor\" href=\"#311-dockerfile\">#</a> 3.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、调整时区</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span> /etc/timezone</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2、拷贝 kafka 软件以及 kafka 的配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">2.12</span>-2.2.0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ADD ./kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span>.tgz /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ADD ./server.properties /kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span>/config/server.properties</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 3、修改 kafka 的名称</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>RUN <span class=\"token function\">mv</span> /kafka_<span class=\"token variable\">$&#123;VERSION&#125;</span> /kafka</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、启动脚本（修改 kafka 配置）</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 5、暴露 kafka 端口 9999 是 jmx 的端口</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EXPOSE <span class=\"token number\">9092</span> <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 6、运行启动脚本</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"312-serverproperties\"><a class=\"anchor\" href=\"#312-serverproperties\">#</a> 3.1.2 server.properties</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat server.properties </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">############################# Server Basics ############################# </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># broker 的 id，值为整数，且必须唯一，在一个集群中不能重复</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">broker.id</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>BROKER_ID<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">############################# Socket Server Settings ############################# </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># kafka 监听端口，默认 9092</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">listeners</span><span class=\"token operator\">=</span>PLAINTEXT://<span class=\"token punctuation\">&#123;</span>LISTENERS<span class=\"token punctuation\">&#125;</span>:9092</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 处理网络请求的线程数量，默认为 3 个</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">num.network.threads</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 执行磁盘 IO 操作的线程数量，默认为 8 个 </span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">num.io.threads</span><span class=\"token operator\">=</span><span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># socket 服务发送数据的缓冲区大小，默认 100KB</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">socket.send.buffer.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">102400</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># socket 服务接受数据的缓冲区大小，默认 100KB</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token assign-left variable\">socket.receive.buffer.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">102400</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># socket 服务所能接受的一个请求的最大大小，默认为 100M</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token assign-left variable\">socket.request.max.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">104857600</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">############################# Log Basics ############################# </span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># kafka 存储消息数据的目录</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">log.dirs</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>KAFKA_DATA_DIR<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># 每个 topic 默认的 partition</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">num.partitions</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 设置副本数量为 3, 当 Leader 的 Replication 故障，会进行故障自动转移。</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token assign-left variable\">default.replication.factor</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># 在启动时恢复数据和关闭时刷新数据时每个数据目录的线程数量</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">num.recovery.threads.per.data.dir</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">############################# Log Flush Policy ############################# </span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\"># 消息刷新到磁盘中的消息条数阈值</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token assign-left variable\">log.flush.interval.messages</span><span class=\"token operator\">=</span><span class=\"token number\">10000</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\"># 消息刷新到磁盘中的最大时间间隔，1s</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">log.flush.interval.ms</span><span class=\"token operator\">=</span><span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">############################# Log Retention Policy ############################# </span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># 日志保留小时数，超时会自动删除，默认为 7 天</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">log.retention.hours</span><span class=\"token operator\">=</span><span class=\"token number\">168</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># 日志保留大小，超出大小会自动删除，默认为 1G</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#log.retention.bytes=1073741824</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\"># 日志分片策略，单个日志文件的大小最大为 1G，超出后则创建一个新的日志文件</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token assign-left variable\">log.segment.bytes</span><span class=\"token operator\">=</span><span class=\"token number\">1073741824</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token comment\"># 每隔多长时间检测数据是否达到删除条件，300s</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\">log.retention.check.interval.ms</span><span class=\"token operator\">=</span><span class=\"token number\">300000</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token comment\">############################# Zookeeper ############################# </span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token comment\"># Zookeeper 连接信息，如果是 zookeeper 集群，则以逗号隔开</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token assign-left variable\">zookeeper.connect</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token comment\"># 连接 zookeeper 的超时时间，6s</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token assign-left variable\">zookeeper.connection.timeout.ms</span><span class=\"token operator\">=</span><span class=\"token number\">6000</span></pre></td></tr></table></figure><h6 id=\"313-entrypoint\"><a class=\"anchor\" href=\"#313-entrypoint\">#</a> 3.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">KAFKA_DIR</span><span class=\"token operator\">=</span>/kafka</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">KAFKA_CONF</span><span class=\"token operator\">=</span>/kafka/config/server.properties</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 1、基于主机名 + 1 获取 Broker_id  这个是用来标识集群节点 在整个集群中必须唯一</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">BROKER_ID</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$((</span> $<span class=\"token punctuation\">(</span>hostname <span class=\"token operator\">|</span> sed 's#.<span class=\"token operator\">*</span><span class=\"token operator\">-</span>##g'<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span> <span class=\"token variable\">))</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">LISTENERS</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span> <span class=\"token parameter variable\">-i</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 2、替换配置文件内容，后期 ZK 集群的地址通过 ENV 传递</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>BROKER_ID<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;BROKER_ID&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>LISTENERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;LISTENERS&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>KAFKA_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;KAFKA_DATA_DIR<span class=\"token operator\">:-</span><span class=\"token operator\">/</span>data&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span>@g  <span class=\"token variable\">$&#123;KAFKA_CONF&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 3、启动 Kafka</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$&#123;KAFKA_DIR&#125;</span>/bin</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'/export KAFKA_HEAP_OPTS/a export JMX_PORT=\"9999\"'</span> kafka-server-start.sh</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>./kafka-server-start.sh <span class=\"token punctuation\">..</span>/config/server.properties</pre></td></tr></table></figure><h6 id=\"314-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#314-构建镜像并推送仓库\">#</a> 3.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://archive.apache.org/dist/kafka/2.2.0/kafka_2.12-2.2.0.tgz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2</span></pre></td></tr></table></figure><h5 id=\"32-迁移kafka集群至k8s\"><a class=\"anchor\" href=\"#32-迁移kafka集群至k8s\">#</a> 3.2 迁移 Kafka 集群至 K8S</h5>\n<h6 id=\"321-kafka-headless\"><a class=\"anchor\" href=\"#321-kafka-headless\">#</a> 3.2.1 kafka-headless</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-kafka-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kafka-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: kafka</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: client</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: jmx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9999</span></pre></td></tr></table></figure><h6 id=\"322-kafka-sts\"><a class=\"anchor\" href=\"#322-kafka-sts\">#</a> 3.2.2 kafka-sts</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-kafka-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kafka</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"kafka-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: kafka</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: kafka</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"kafka\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: kafka</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kafka:2.12.2 </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: client</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: jmxport</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          containerPort: <span class=\"token number\">9999</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          value: <span class=\"token string\">\"zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则不介入流量</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        livenessProbe:         <span class=\"token comment\"># 存活探针。如果不存活则根据重启策略进行重启</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port: <span class=\"token number\">9092</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"323-更新资源清单\"><a class=\"anchor\" href=\"#323-更新资源清单\">#</a> 3.2.3 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-kafka-headless.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-kafka-sts.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME          READY   STATUS    RESTARTS       AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kafka-0       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              5m49s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kafka-1       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m43s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kafka-2       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              3m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#查看 kafka 是否注册到 zookeeper</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-kafka<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it zookeeper-0 -n logging -- /bin/bash</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@zookeeper-0:/<span class=\"token comment\"># /zookeeper/bin/zkCli.sh </span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> get /brokers/ids/1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.85.201:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.85.201\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162470218\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> get /brokers/ids/2</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.58.205:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.58.205\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162532658\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>zk: localhost:2181<span class=\"token punctuation\">(</span>CONNECTED<span class=\"token punctuation\">)</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span> get /brokers/ids/3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"listener_security_protocol_map\"</span>:<span class=\"token punctuation\">&#123;</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"PLAINTEXT\"</span><span class=\"token punctuation\">&#125;</span>,<span class=\"token string\">\"endpoints\"</span>:<span class=\"token punctuation\">[</span><span class=\"token string\">\"PLAINTEXT://172.16.195.1:9092\"</span><span class=\"token punctuation\">]</span>,<span class=\"token string\">\"jmx_port\"</span>:9999,<span class=\"token string\">\"host\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"172.16.195.1\"</span>,<span class=\"token string\">\"timestamp\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"1748162649250\"</span>,<span class=\"token string\">\"port\"</span>:9092,<span class=\"token string\">\"version\"</span>:4<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"324-检查kafka集群\"><a class=\"anchor\" href=\"#324-检查kafka集群\">#</a> 3.2.4 检查 Kafka 集群</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建一个topic</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>root@kafka-0:/<span class=\"token comment\"># /kafka/bin/kafka-topics.sh --create --zookeeper zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181 --partitions 1 --replication-factor 3 --topic oldxu</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.模拟消息发布</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>root@kafka-1:/<span class=\"token comment\"># /kafka/bin/kafka-console-producer.sh --broker-list kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092 --topic oldxu</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">></span>hello kubernetes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">></span>hello world</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">3</span>.模拟消息订阅</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@kafka-2:/<span class=\"token comment\"># /kafka/bin/kafka-console-consumer.sh  --bootstrap-server kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092 --topic oldxu --from-beginning</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>hello kubernetes</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>hello world</pre></td></tr></table></figure><h4 id=\"四-交付efak至k8s\"><a class=\"anchor\" href=\"#四-交付efak至k8s\">#</a> 四、交付 efak 至 K8S</h4>\n<h5 id=\"41-制作efak镜像\"><a class=\"anchor\" href=\"#41-制作efak镜像\">#</a> 4.1 制作 efak 镜像</h5>\n<h6 id=\"411-dockerfile\"><a class=\"anchor\" href=\"#411-dockerfile\">#</a> 4.1.1 Dockerfile</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 1、调整时区</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span> /etc/timezone</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 2、拷贝 kafka 软件以及 kafka 的配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">3.0</span>.1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ADD ./efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span>-bin.tar.gz /</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ADD ./system-config.properties /efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span>/conf/system-config.properties</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 3、修改 efak 的名称</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>RUN <span class=\"token function\">mv</span> /efak-web-<span class=\"token variable\">$&#123;VERSION&#125;</span> /efak</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># 4、环境变量</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>ENV <span class=\"token assign-left variable\">KE_HOME</span><span class=\"token operator\">=</span>/efak</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ENV <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$KE_HOME</span>/bin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># 5、启动脚本（修改 kafka 配置）</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 6、暴露 kafka 端口 9999 是 jmx 的端口</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>EXPOSE <span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># 7、运行启动脚本</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h6 id=\"412-system-config\"><a class=\"anchor\" href=\"#412-system-config\">#</a> 4.1.2 system-config</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat system-config.properties </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 填写 zookeeper 集群列表</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">efak.zk.cluster.alias</span><span class=\"token operator\">=</span>cluster1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">cluster1.zk.list</span><span class=\"token operator\">=</span><span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># broker 最大规模数量</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.broker.size</span><span class=\"token operator\">=</span><span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># zk 客户端线程数</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">kafka.zk.limit.size</span><span class=\"token operator\">=</span><span class=\"token number\">32</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># EFAK webui 端口</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token assign-left variable\">efak.webui.port</span><span class=\"token operator\">=</span><span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># kafka offset storage</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.offset.storage</span><span class=\"token operator\">=</span>kafka</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\"># kafka jmx uri</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">cluster1.efak.jmx.uri</span><span class=\"token operator\">=</span>service:jmx:rmi:///jndi/rmi://%s/jmxrmi</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\"># kafka metrics 指标，默认存储 15 天</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token assign-left variable\">efak.metrics.charts</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token assign-left variable\">efak.metrics.retain</span><span class=\"token operator\">=</span><span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># kafka sql topic records max</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">efak.sql.topic.records.max</span><span class=\"token operator\">=</span><span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">efak.sql.topic.preview.records.max</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token comment\"># delete kafka topic token</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token assign-left variable\">efak.topic.token</span><span class=\"token operator\">=</span>keadmin</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\"># kafka sqlite 数据库地址（需要修改存储路径）</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">######################################</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token assign-left variable\">efak.driver</span><span class=\"token operator\">=</span>org.sqlite.JDBC</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token assign-left variable\">efak.url</span><span class=\"token operator\">=</span>jdbc:sqlite:<span class=\"token punctuation\">&#123;</span>EFAK_DATA_DIR<span class=\"token punctuation\">&#125;</span>/db/ke.db</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token assign-left variable\">efak.username</span><span class=\"token operator\">=</span>root</pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token assign-left variable\">efak.password</span><span class=\"token operator\">=</span>www.kafka-eagle.org</pre></td></tr></table></figure><h6 id=\"413-entrypoint\"><a class=\"anchor\" href=\"#413-entrypoint\">#</a> 4.1.3 entrypoint</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 1、变量</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">EFAK_DIR</span><span class=\"token operator\">=</span>/efak</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">EFAK_CONF</span><span class=\"token operator\">=</span>/efak/conf/system-config.properties</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 2、替换配置文件内容，后期 ZK 集群的地址通过 ENV 传递</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>EFAK_DATA_DIR<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>@g  <span class=\"token variable\">$&#123;EFAK_CONF&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ZOOK_SERVERS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ZOOK_SERVERS&#125;</span>@g  <span class=\"token variable\">$&#123;EFAK_CONF&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># 3、启动 efka</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>/bin/ke.sh start</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token function\">tail</span> <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$&#123;EFAK_DIR&#125;</span>/logs/ke_console.out</pre></td></tr></table></figure><h6 id=\"414-构建镜像并推送仓库\"><a class=\"anchor\" href=\"#414-构建镜像并推送仓库\">#</a> 4.1.4 构建镜像并推送仓库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://github.com/smartloli/kafka-eagle-bin/archive/v3.0.1.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0</span></pre></td></tr></table></figure><h5 id=\"42-迁移efak至k8s\"><a class=\"anchor\" href=\"#42-迁移efak至k8s\">#</a> 4.2 迁移 efak 至 K8S</h5>\n<h6 id=\"421-efak-deploy\"><a class=\"anchor\" href=\"#421-efak-deploy\">#</a> 4.2.1 efak-deploy</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-efak-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: efak</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: efak</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: efak</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: efak</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/efak:3.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - name: ZOOK_SERVERS</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          value: <span class=\"token string\">\"zookeeper-0.zookeeper-svc:2181,zookeeper-1.zookeeper-svc:2181,zookeeper-2.zookeeper-svc:2181\"</span></pre></td></tr></table></figure><h6 id=\"422-efak-service\"><a class=\"anchor\" href=\"#422-efak-service\">#</a> 4.2.2 efak-service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-efak-service.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: efak-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: efak</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - port: <span class=\"token number\">8048</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    targetPort: <span class=\"token number\">8048</span></pre></td></tr></table></figure><h6 id=\"423-efak-ingress\"><a class=\"anchor\" href=\"#423-efak-ingress\">#</a> 4.2.3 efak-ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-efak-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: efak-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"efak.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: efak-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port: </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">8048</span></pre></td></tr></table></figure><h6 id=\"424-更新资源清单\"><a class=\"anchor\" href=\"#424-更新资源清单\">#</a> 4.2.4 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-efak-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-efak-service.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-efak<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-efak-ingress.yaml</span></pre></td></tr></table></figure><h6 id=\"425-访问efka\"><a class=\"anchor\" href=\"#425-访问efka\">#</a> 4.2.5 访问 efka</h6>\n<p>1、初始用户名密码 admin   123456</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Nq16u4z.png\" alt=\"1.png\" /></p>\n<p>2、查看 Topics</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9Bin9cr.png\" alt=\"2.png\" /></p>\n<p>3、查看 kafka 集群状态</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/U76YIck.png\" alt=\"3.png\" /></p>\n<p>4、查看 Zookeeper 集群状态</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/cY5LeWx.png\" alt=\"4.png\" /></p>\n<h4 id=\"五-交付elastic集群\"><a class=\"anchor\" href=\"#五-交付elastic集群\">#</a> 五、交付 Elastic 集群</h4>\n<ul>\n<li>ES 集群是由多个节点组成的，通过 <a href=\"http://cluster.name\">cluster.name</a> 设置 ES 集群名称，同时用于区分其它的 ES 集群。</li>\n<li>每个节点通过 <a href=\"http://node.name\">node.name</a> 参数来设定所在集群的节点名称。</li>\n<li>节点使用 discovery.send_hosts 参数来设定集群节点的列表。</li>\n<li>集群在第一次启动时，需要初始化，同时需要指定参与选举的 master 节点 IP，或节点名称。</li>\n<li>每个节点可以通过 node.master:true 设定为 master 角色，通过 node.data:true 设定为 data 角色。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># grep \"^[a-Z]\" /etc/elasticsearch/elasticsearch.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 集群名称 cluster.name: my-oldxu</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 节点名称 node.name: node1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 数据存储路径 path.data: /var/lib/elasticsearch</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 日志存储路径 path.logs: /var/log/elasticsearch</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 监听在本地哪个地址上 network.host: 10.0.0.100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># 监听端口 http.port: 9200</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 集群主机列表 discovery.seed_hosts: [\"ip1\", \"ip2\", \"ip3\"]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># 仅第一次启动集群时进行选举（可以填写 node.name 的名称）cluster.initial_master_nodes: [\"node01\", \"node02\", \"node03\"]</span></pre></td></tr></table></figure><h5 id=\"51-下载elastic镜像\"><a class=\"anchor\" href=\"#51-下载elastic镜像\">#</a> 5.1 下载 elastic 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull elasticsearch:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag elasticsearch:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6</span></pre></td></tr></table></figure><h5 id=\"52-交付es-service\"><a class=\"anchor\" href=\"#52-交付es-service\">#</a> 5.2 交付 ES-Service</h5>\n<p>创建 es-headlessService，为每个 ES Pod 设定固定的 DNS 名称，无论它是 Master 或是 Data，易或是 Coordinating</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-es-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: es</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: cluster</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: transport</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9300</span></pre></td></tr></table></figure><h5 id=\"53-交付es-master节点\"><a class=\"anchor\" href=\"#53-交付es-master节点\">#</a> 5.3 交付 ES-Master 节点</h5>\n<ol>\n<li>\n<p>ES 无法使用 root 直接启动，需要授权数据目录 UID=1000，同时还需要持久化 /usr/share/elasticsearch/data ；</p>\n</li>\n<li>\n<p>ES 所有节点都需要设定 vm.max_map_count 内核参数以及 ulimit；</p>\n</li>\n<li>\n<p>ES 启动是通过 ENV 环境变量传参来完成的；</p>\n<ul>\n<li>\n<p>集群名称、节点名称、角色类型；</p>\n</li>\n<li>\n<p>discovery.seed_hosts 集群地址列表；</p>\n</li>\n<li>\n<p>cluster.initial_master_nodes 初始集群参与选举的 master 节点名称；</p>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-es-master.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-master</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"es-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span>           <span class=\"token comment\"># es-pod 运行的实例</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:             <span class=\"token comment\"># 需要管理的 ES-Pod 标签</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: es</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: master</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: es</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: master</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:                       <span class=\"token comment\"># 定义 pod 规范</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:         <span class=\"token comment\"># 镜像拉取使用的认证信息</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      affinity:                 <span class=\"token comment\"># 设定 pod 反亲和</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"es\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - key: role</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"master\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>       <span class=\"token comment\"># 每个节点就是一个位置</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"chown -R 1000:1000 /usr/share/elasticsearch/data ; sysctl -w vm.max_map_count=262144; ulimit -n 65536\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      containers:               <span class=\"token comment\"># ES 主容器</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: es</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6 </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            memory: 4096Mi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            cpu: 300m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: cluster</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          containerPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: transport</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          containerPort: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: ES_JAVA_OPTS</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: <span class=\"token string\">\"-Xms1g -Xmx1g\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: cluster.name</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          value: es-cluster</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: node.name</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - name: node.master</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: node.data</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: discovery.seed_hosts</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0.es-svc,es-master-1.es-svc,es-master-2.es-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: cluster.initial_master_nodes</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0,es-master-1,es-master-2\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  volumeClaimTemplates: <span class=\"token comment\"># 动态 pvc</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"54-交付es-data节点\"><a class=\"anchor\" href=\"#54-交付es-data节点\">#</a> 5.4 交付 ES-Data 节点</h5>\n<ol>\n<li>\n<p>ES 无法使用 root 直接启动，需要授权数据目录 UID=1000，同时还需要持久化 /usr/share/elasticsearch/data</p>\n</li>\n<li>\n<p>ES 所有节点都需要设定 vm.max_map_count 内核参数以及 ulimit；</p>\n</li>\n<li>\n<p>ES 启动是通过 ENV 环境变量传参来完成的</p>\n<ul>\n<li>\n<p>集群名称、节点名称、角色类型</p>\n</li>\n<li>\n<p>discovery.seed_hosts 集群地址列表</p>\n</li>\n</ul>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-es-data.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: es-data</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"es-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">2</span>           <span class=\"token comment\"># es-pod 运行的实例</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:             <span class=\"token comment\"># 需要管理的 ES-Pod 标签</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: es</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: data</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: es</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: data</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:                       <span class=\"token comment\"># 定义 pod 规范</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:         <span class=\"token comment\"># 镜像拉取使用的认证信息</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      affinity:                 <span class=\"token comment\"># 设定 pod 反亲和</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"es\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - key: role</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"data\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>       <span class=\"token comment\"># 每个节点就是一个位置</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"chown -R 1000:1000 /usr/share/elasticsearch/data ; sysctl -w vm.max_map_count=262144; ulimit -n 65536\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      containers:               <span class=\"token comment\"># ES 主容器</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: es</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/elasticsearch:7.17.6 </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            memory: 4096Mi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            cpu: 300m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: cluster</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          containerPort: <span class=\"token number\">9200</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: transport</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          containerPort: <span class=\"token number\">9300</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          mountPath: /usr/share/elasticsearch/data</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: ES_JAVA_OPTS</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: <span class=\"token string\">\"-Xms1g -Xmx1g\"</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: cluster.name</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          value: es-cluster</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: node.name</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - name: node.master</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: node.data</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: discovery.seed_hosts</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"es-master-0.es-svc,es-master-1.es-svc,es-master-2.es-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  volumeClaimTemplates: <span class=\"token comment\"># 动态 pvc</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteOnce\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"55-更新资源清单\"><a class=\"anchor\" href=\"#55-更新资源清单\">#</a> 5.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-es-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-es-master.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-elasticsearch<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-es-data.yaml</span></pre></td></tr></table></figure><h5 id=\"56-验证es集群\"><a class=\"anchor\" href=\"#56-验证es集群\">#</a> 5.6 验证 ES 集群</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 解析 headlessService 获取对应 ES 集群任一节点的 IP 地址</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># dig @10.96.0.10 es-svc.logging.svc.cluster.local  +short</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.58.229</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.122.191</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">172.16</span>.195.21</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">172.16</span>.122.129</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">172.16</span>.32.164</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 通过 curl 访问 ES，检查 ES 集群是否正常（如果仅交付 Master，没有 data 节点，集群状态可能会 Red，因为没有数据节点进行数据存储；）</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># curl -XGET \"http://172.16.122.129:9200/_cluster/health?pretty\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  <span class=\"token string\">\"cluster_name\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"es-cluster\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token string\">\"status\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"green\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token string\">\"timed_out\"</span> <span class=\"token builtin class-name\">:</span> false,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token string\">\"number_of_nodes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">5</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token string\">\"number_of_data_nodes\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">2</span>,</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token string\">\"active_primary_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">3</span>,</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"active_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">6</span>,</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  <span class=\"token string\">\"relocating_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token string\">\"initializing_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  <span class=\"token string\">\"unassigned_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  <span class=\"token string\">\"delayed_unassigned_shards\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  <span class=\"token string\">\"number_of_pending_tasks\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  <span class=\"token string\">\"number_of_in_flight_fetch\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  <span class=\"token string\">\"task_max_waiting_in_queue_millis\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">0</span>,</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token string\">\"active_shards_percent_as_number\"</span> <span class=\"token builtin class-name\">:</span> <span class=\"token number\">100.0</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#3. 查看 ES 各个节点详情</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># curl -XGET \"http://172.16.122.129:9200/_cat/nodes\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">172.16</span>.122.129 <span class=\"token number\">16</span> <span class=\"token number\">33</span> <span class=\"token number\">20</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.56</span> <span class=\"token number\">0.38</span> ilmr       - es-master-2</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">172.16</span>.58.229  <span class=\"token number\">66</span> <span class=\"token number\">33</span> <span class=\"token number\">22</span> <span class=\"token number\">0.64</span> <span class=\"token number\">0.66</span> <span class=\"token number\">0.44</span> ilmr       * es-master-1</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">172.16</span>.122.191 <span class=\"token number\">52</span> <span class=\"token number\">34</span> <span class=\"token number\">15</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.56</span> <span class=\"token number\">0.38</span> cdfhilrstw - es-data-0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">172.16</span>.195.21  <span class=\"token number\">38</span> <span class=\"token number\">35</span> <span class=\"token number\">19</span> <span class=\"token number\">0.38</span> <span class=\"token number\">0.53</span> <span class=\"token number\">0.36</span> cdfhilrstw - es-data-1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">172.16</span>.32.164  <span class=\"token number\">31</span> <span class=\"token number\">33</span> <span class=\"token number\">12</span> <span class=\"token number\">0.28</span> <span class=\"token number\">0.50</span> <span class=\"token number\">0.59</span> ilmr       - es-master-0</pre></td></tr></table></figure><h4 id=\"六-交付kibana可视化\"><a class=\"anchor\" href=\"#六-交付kibana可视化\">#</a> 六、交付 Kibana 可视化</h4>\n<h5 id=\"61-下载kibana镜像\"><a class=\"anchor\" href=\"#61-下载kibana镜像\">#</a> 6.1 下载 kibana 镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull kibana:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag kibana:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6</span></pre></td></tr></table></figure><h5 id=\"62-kibana-deploy\"><a class=\"anchor\" href=\"#62-kibana-deploy\">#</a> 6.2 kibana-deploy</h5>\n<ol>\n<li>Kibana 需要连接 ES 集群，通过 ELASTICSEARCH_HOSTS 变量来传递 ES 集群地址</li>\n<li>kibana 通过 I18N_LOCALE 来传递语言环境</li>\n<li>Kibana 通过 SERVER_PUBLICBASEURL 来传递服务访问的公开地址</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-kibana-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: kibana</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: kibana</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: kibana</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kibana:7.17.6 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            cpu: 1000m</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - containerPort: <span class=\"token number\">5601</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - name: ELASTICSEARCH_HOSTS</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          value: <span class=\"token string\">'[\"http://es-data-0.es-svc:9200\",\"http://es-data-1.es-svc:9200\"]'</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: I18N_LOCALE</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          value: <span class=\"token string\">\"zh-CN\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: SERVER_PUBLICBASEURL</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          value: <span class=\"token string\">\"http://kibana.hmallleasing.com\"</span>   <span class=\"token comment\">#kibana 访问 UI</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"63-kibana-svc\"><a class=\"anchor\" href=\"#63-kibana-svc\">#</a> 6.3 kibana-svc</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-kibana-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: kibana</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - name: web</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    port: <span class=\"token number\">5601</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">5601</span></pre></td></tr></table></figure><h5 id=\"64-kibana-ingress\"><a class=\"anchor\" href=\"#64-kibana-ingress\">#</a> 6.4 kibana-ingress</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-kibana-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: kibana-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: <span class=\"token string\">\"kibana.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: kibana-svc</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">5601</span></pre></td></tr></table></figure><h5 id=\"65-更新资源清单\"><a class=\"anchor\" href=\"#65-更新资源清单\">#</a> 6.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-kibana-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-kibana-svc.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-kibana-ingress.yaml</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-kibana<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n logging</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>NAME                      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>efak-5cdc74bf59-nrhb4     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h33m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>es-data-0                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          16m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>es-data-1                 <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>es-master-0               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>es-master-1               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>es-master-2               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kafka-0                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h39m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kafka-1                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h39m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kafka-2                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h38m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kibana-5ccc46864b-ndzx9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          118s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>zookeeper-0               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h42m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>zookeeper-1               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h42m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>zookeeper-2               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5h41m</pre></td></tr></table></figure><h5 id=\"66-访问kibana\"><a class=\"anchor\" href=\"#66-访问kibana\">#</a> 6.6 访问 kibana</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sUXTx1J.png\" alt=\"1.png\" /></p>\n<h4 id=\"七-filebeat-sidecar收集业务应用日志\"><a class=\"anchor\" href=\"#七-filebeat-sidecar收集业务应用日志\">#</a> 七、filebeat-sidecar 收集业务应用日志</h4>\n<h5 id=\"71-部署架构说明\"><a class=\"anchor\" href=\"#71-部署架构说明\">#</a> 7.1 部署架构说明</h5>\n<p>对于那些能够将日志输出到本地文件的 Pod，我们可以使用 Sidecar 模式方式运行一个日志采集 Agent，对其进行单独收集日志。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/u20K1ll.png\" alt=\"1.png\" /></p>\n<ol>\n<li>首先需要将 Pod 中的业务容器日志输出至本地文件，而后运行一个 Filebeat 边车容器，采集本地路径下的日志；</li>\n<li>Filebeat 容器需要传递如下变量；\n<ul>\n<li>ENV：了解 Pod 属于隶属于哪个环境；</li>\n<li>PROJECT_NAME：为了后期能在单个索引中区分出不同的项目；</li>\n<li>PodIP：为了让用户清楚该 Pod 属于哪个 IP；</li>\n<li>Node：用于获取该 Pod 所处的节点；</li>\n</ul>\n</li>\n<li>Logstash 根据不同的环境，拉取不同的 topic 数据，然后将数据存储至 ES 对应的索引中；</li>\n<li>Kibana 添加不同环境的 index pattern，而后选择对应环境不同的项目进行日志探索与展示；</li>\n</ol>\n<h5 id=\"72-sidecar部署思路\"><a class=\"anchor\" href=\"#72-sidecar部署思路\">#</a> 7.2 Sidecar 部署思路</h5>\n<ol>\n<li>制作一个业务镜像，要求镜像输出日志至本地；</li>\n<li>制作 Filebeat 镜像，配置 Input、output 等信息；</li>\n<li>采用边车模式运行不同环境的 Pod，确保日志信息能输出至 Kafka 集群；</li>\n<li>准备不同环境下 Logstash 配置文件，而后读取数据写入 ES 集群；</li>\n<li>使用 kibana 添加索引，进行日志探索与展示；</li>\n</ol>\n<h5 id=\"73-制作filebeat镜像\"><a class=\"anchor\" href=\"#73-制作filebeat镜像\">#</a> 7.3 制作 Filebeat 镜像</h5>\n<p><strong>7.3.1 下载 filebeat</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">curl</span> <span class=\"token parameter variable\">-L</span> <span class=\"token parameter variable\">-O</span> https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.6-x86_64.rpm</pre></td></tr></table></figure><p><strong>7.3.2 编写 Dockerfile</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 1、基础镜像</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FROM centos:7</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 2、拷贝 filebeat</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ENV <span class=\"token assign-left variable\">VERSION</span><span class=\"token operator\">=</span><span class=\"token number\">7.17</span>.6</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ADD ./filebeat-<span class=\"token variable\">$&#123;VERSION&#125;</span>-x86_64.rpm /</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>RUN <span class=\"token function\">rpm</span> <span class=\"token parameter variable\">-ivh</span> /filebeat-<span class=\"token variable\">$&#123;VERSION&#125;</span>-x86_64.rpm <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /filebeat-<span class=\"token variable\">$&#123;VERSION&#125;</span>-x86_64.rpm</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># 3、拷贝 filebeat 配置文件（核心）</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ADD ./filebeat.yml /etc/filebeat/filebeat.yml</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 4、拷贝启动脚本</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ADD ./entrypoint.sh /entrypoint.sh</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>RUN <span class=\"token function\">chmod</span> +x /entrypoint.sh</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># 5、执行启动脚本</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>CMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"/bin/bash\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"/entrypoint.sh\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p><strong>7.3.3 编写 entrypoint</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat entrypoint.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#启动脚本</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#1、替换 filbeat 配置文件中的内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Beat_Conf</span><span class=\"token operator\">=</span>/etc/filebeat/filebeat.yml</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>ENV<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;ENV<span class=\"token operator\">:-</span>test&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>PodIP<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;PodIP<span class=\"token operator\">:-</span>\"no-ip\"&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>Node<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;Node<span class=\"token operator\">:-</span>\"none\"&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>PROJECT_NAME<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;PROJECT_NAME<span class=\"token operator\">:-</span>\"no-define\"&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>MULTILINE<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;MULTILINE<span class=\"token operator\">:-</span>\"<span class=\"token operator\">^</span>\\\\\\d&#123;2&#125;</span>\"<span class=\"token punctuation\">&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span>\t\t<span class=\"token comment\"># \\\\ 用来转义</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> s@<span class=\"token punctuation\">&#123;</span>KAFKA_HOSTS<span class=\"token punctuation\">&#125;</span>@<span class=\"token variable\">$&#123;KAFKA_HOSTS&#125;</span>@g <span class=\"token variable\">$&#123;Beat_Conf&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># 2、运行 filebeat</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>filebeat <span class=\"token parameter variable\">-e</span> <span class=\"token parameter variable\">-c</span> /etc/filebeat/filebeat.yml</pre></td></tr></table></figure><p><strong>7.3.4 编写 filebeat 配置</strong></p>\n<p>{ENV}：用于定义环境的变量；<br />\n{PROJECT_NAME}：用于定义项目名称的变量；<br />\n{MULTILINE}：用于定义多行合并的正则变量；<br />\n{KAFKA_HOSTS}：用于定义 KAFKA 集群地址的变量；<br />\n{PodIP}：用于获取该 Pod 地址的变量；<br />\n{Node}：用于获取该 Pod 所处的节点；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 filebeat_sidecar_dockerfile<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat filebeat.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>filebeat.inputs:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>- type: log</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  paths:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - /logu/*.log</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    - /logu/*/*.log</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  tags: <span class=\"token punctuation\">[</span><span class=\"token string\">\"logu\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  fields:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    topic: <span class=\"token punctuation\">&#123;</span>PROJECT_NAME<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    podip: <span class=\"token punctuation\">&#123;</span>PodIP<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    node: <span class=\"token punctuation\">&#123;</span>Node<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  fields_under_root: <span class=\"token boolean\">true</span>               <span class=\"token comment\"># 增加的所有字段都为顶级字段</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>- type: log</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  paths:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - /logm/*.log</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - /logm/*/*.log</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  tags: <span class=\"token punctuation\">[</span><span class=\"token string\">\"logm\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  fields:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    topic: <span class=\"token punctuation\">&#123;</span>PROJECT_NAME<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    podip: <span class=\"token punctuation\">&#123;</span>PodIP<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    node: <span class=\"token punctuation\">&#123;</span>Node<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  fields_under_root: <span class=\"token boolean\">true</span>               <span class=\"token comment\"># 增加的所有字段都为顶级字段</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  multiline.pattern: <span class=\"token string\">'&#123;MULTILINE&#125;'</span>      </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  multiline.negate: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  multiline.match: after</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  multiline.max_lines: <span class=\"token number\">10000</span>    <span class=\"token comment\">#默认最大合并行为 500，可根据实际情况调整。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>output.kafka:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  hosts: <span class=\"token punctuation\">[</span><span class=\"token punctuation\">&#123;</span>KAFKA_HOSTS<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  topic: app-<span class=\"token punctuation\">&#123;</span>ENV<span class=\"token punctuation\">&#125;</span>-%<span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">[</span>topic<span class=\"token punctuation\">]</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  required_acks: <span class=\"token number\">1</span>              <span class=\"token comment\"># 保证消息可靠，0 不保证，1 等待写入主分区（默认），-1 等待写入副本分区</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  compression: <span class=\"token function\">gzip</span>             <span class=\"token comment\"># 压缩</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  max_message_bytes: <span class=\"token number\">1000000</span>    <span class=\"token comment\"># 每条消息最大的长度，多余的被删除</span></pre></td></tr></table></figure><p><strong>7.3.5 构建并推送镜像</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6 .</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</span></pre></td></tr></table></figure><h5 id=\"74-nf-flms-gateway日志收集\"><a class=\"anchor\" href=\"#74-nf-flms-gateway日志收集\">#</a> 7.4 nf-flms-gateway 日志收集</h5>\n<p><strong>7.4.1 创建 Namespace 和 Secrets</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls prod-api.hmallleasig.com --key hmallleasing.com.key --cert hmallleasing.com.pem -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xyapples@163.com --docker-password=passwd -n prod</span></pre></td></tr></table></figure><p><strong>7.4.2 创建 nf-flms-gateway</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-nf-flms-gateway.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2.2 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-gateway.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /logs    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6 </pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          mountPath: /logm    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-gateway\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  name: gateway-svc</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"113\"></td><td><pre></pre></td></tr><tr><td data-num=\"114\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"115\"></td><td><pre></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  name: gateway-ingress</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"123\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"125\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  - host: <span class=\"token string\">\"prod-api.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"127\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>            name: gateway-svc</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"137\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>    - prod-api.hmallleasing.com</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretNam</span></pre></td></tr></table></figure><p><strong>7.4.3 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SkS0yA0.png\" alt=\"2.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0SOP2qi.png\" alt=\"3.png\" /></p>\n<h5 id=\"75-nf-flms-order日志收集\"><a class=\"anchor\" href=\"#75-nf-flms-order日志收集\">#</a> 7.5 nf-flms-order 日志收集</h5>\n<p><strong>7.5.1 创建 PVC</strong></p>\n<p>创建 PVC 存储订单合同、身份证复印件等附件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-data-image.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: data-image</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      storage: 2Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr></table></figure><p><strong>7.5.2 创建 nf-flms-order</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-nf-flms-order.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-order</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-order</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-order</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-order</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-order.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: data-image</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          mountPath: /logs    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /logm    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-order\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      - name: data-image</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          claimName: data-image</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>7.5.3 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/AxF7dhj.png\" alt=\"4.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/bYpKAsJ.png\" alt=\"5.png\" /></p>\n<h5 id=\"76-nf-flms-statistics日志收集\"><a class=\"anchor\" href=\"#76-nf-flms-statistics日志收集\">#</a> 7.6 nf-flms-statistics 日志收集</h5>\n<p><strong>7.6.1 创建 nf-flms-statistics</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nf-flms-statistics.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-statistics.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /logs    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          mountPath: /logm    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-statistics\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>7.6.2 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/kD0B7C3.png\" alt=\"6.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JO9HMip.png\" alt=\"7.png\" /></p>\n<h5 id=\"77-nf-flms-system日志收集\"><a class=\"anchor\" href=\"#77-nf-flms-system日志收集\">#</a> 7.7 nf-flms-system 日志收集</h5>\n<p><strong>7.7.1 创建 nf-flms-system</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-nf-flms-system.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-system</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-system</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-system</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-system</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-system.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          mountPath: /logs    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /logm    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-system\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>7.7.2 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Rj4wUMF.png\" alt=\"1.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JYCPcgP.png\" alt=\"2.png\" /></p>\n<h5 id=\"78-nf-flms-openapi日志收集\"><a class=\"anchor\" href=\"#78-nf-flms-openapi日志收集\">#</a> 7.8 nf-flms-openapi 日志收集</h5>\n<p><strong>7.8.1 创建 nf-flms-openapi</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 06-nf-flms-openapi.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v2.2 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-openapi.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          mountPath: /logs    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /logm    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-openapi\"</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>7.8.2 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/esmEJF7.png\" alt=\"3.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2HvC3KR.png\" alt=\"4.png\" /></p>\n<h5 id=\"79-nf-flms-ui日志收集\"><a class=\"anchor\" href=\"#79-nf-flms-ui日志收集\">#</a> 7.9 nf-flms-ui 日志收集</h5>\n<p><strong>7.9.1 准备 Nginx 配置文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat prod.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server_name prod.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        root /code/prod<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            index  index.html index.htm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        server_name prod-api.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                proxy_set_header REMOTE-HOST <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                proxy_pass http://gateway-svc.prod.svc.cluster.local:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><strong>7.9.2 创建 ConfigMap</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create configmap nf-flms-ui-conf --from-file<span class=\"token operator\">=</span>./prod.hmallleasing.com.conf <span class=\"token parameter variable\">-n</span> prod</pre></td></tr></table></figure><p><strong>7.9.3 创建 nf-flms-ui</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 07-ui-deploy-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-ui</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-ui</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-ui</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-ui</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: ngxconfs</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /etc/nginx/conf.d/</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /var/log/nginx/    <span class=\"token comment\"># 业务容器日志目录</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: filebeat</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/filebeat_sidecar:7.17.6</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: log</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /logu    <span class=\"token comment\"># 匹配多行日志</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        - name: ENV</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        - name: PodIP</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - name: Node</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>              fieldPath: spec.nodeName</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: PROJECT_NAME</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"nf-flms-ui\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: KAFKA_HOSTS</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">'\"kafka-0.kafka-svc.logging:9092\",\"kafka-1.kafka-svc.logging:9092\",\"kafka-2.kafka-svc.logging:9092\"'</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>      - name: ngxconfs</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          name: nf-flms-ui-conf</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      - name: log</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    app: nf-flms-ui</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>    targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  name: nf-flms-ui-ingress</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  - host: <span class=\"token string\">\"prod.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>            name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"131\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    - prod.hmallleasing.com</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretName</span></pre></td></tr></table></figure><p><strong>7.9.2 检查 KafkaTopic</strong></p>\n<p>1、检查是否有对应的 topic</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9Nh2ywz.png\" alt=\"1.png\" /></p>\n<p>2、点击对应的 Preview，查看 topic 中的最新数据</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xB0bjWA.png\" alt=\"2.png\" /></p>\n<h4 id=\"八-交付生产环境logstash\"><a class=\"anchor\" href=\"#八-交付生产环境logstash\">#</a> 八、交付生产环境 Logstash</h4>\n<h5 id=\"81-拉取镜像\"><a class=\"anchor\" href=\"#81-拉取镜像\">#</a> 8.1 拉取镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull docker.elastic.co/logstash/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag docker.elastic.co/logstash/logstash-oss:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr></table></figure><h5 id=\"82-编写logstash配置\"><a class=\"anchor\" href=\"#82-编写logstash配置\">#</a> 8.2 编写 logstash 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 conf<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat logstash-prod.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>input <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kafka <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        bootstrap_servers <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        group_id <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"logstash-prod\"</span>      <span class=\"token comment\"># 消费者组名称</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        consumer_threads <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"3\"</span>          <span class=\"token comment\"># 理想情况下，配置与分区数一样多的线程，实现均衡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        topics_pattern <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-prod-.*\"</span>  <span class=\"token comment\"># 通过正则表达式匹配要订阅的主题</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>filter <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tjson <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"message\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>output <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    stdout <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        codec <span class=\"token operator\">=</span><span class=\"token operator\">></span> rubydebug</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    elasticsearch <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        hosts <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"es-data-0.es-svc:9200\"</span>,<span class=\"token string\">\"es-data-1.es-svc:9200\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        index <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-prod-%&#123;+YYYY.MM.dd&#125;\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        template_overwrite <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"83-创建生产环境configmap\"><a class=\"anchor\" href=\"#83-创建生产环境configmap\">#</a> 8.3 创建生产环境 configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create configmap logstash-prod-conf --from-file<span class=\"token operator\">=</span>logstash.conf<span class=\"token operator\">=</span>conf/logstash-prod.conf <span class=\"token parameter variable\">-n</span> logging</pre></td></tr></table></figure><h5 id=\"84-创建生产环境logstash\"><a class=\"anchor\" href=\"#84-创建生产环境logstash\">#</a> 8.4 创建生产环境 Logstash</h5>\n<p>1、创建 logstash-svc</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-logstash-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: logstash</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - port: <span class=\"token number\">9600</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">9600</span></pre></td></tr></table></figure><p>2、创建 logstash-StatefulSet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-logstash-prod-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-prod</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"logstash-svc\"</span>           <span class=\"token comment\"># 使用此前创建的 svc，则无需重复创建</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: logstash</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      env: prod</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: logstash</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        env: prod</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - name: logstash</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        args: <span class=\"token punctuation\">[</span><span class=\"token string\">\"-f\"</span>,<span class=\"token string\">\"config/logstash.conf\"</span><span class=\"token punctuation\">]</span>                     <span class=\"token comment\"># 启动时指定加载的配置文件</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: PIPELINE_WORKERS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          value: <span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: PIPELINE_BATCH_SIZE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          value: <span class=\"token string\">\"10000\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        lifecycle:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          postStart:                                            <span class=\"token comment\"># 设定 JVM</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            exec:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              command:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              - <span class=\"token string\">\"sed -i -e '/^-Xms/c-Xms1024m' -e '/^-Xmx/c-Xmx1024m' /usr/share/logstash/config/jvm.options\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: data                                            <span class=\"token comment\"># 持久化数据目录</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          mountPath: /usr/share/logstash/data</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: conf</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /usr/share/logstash/config/logstash.conf</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          subPath: logstash.conf</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: conf</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          name: logstash-prod-conf</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          type: <span class=\"token string\">\"\"</span>         </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"85-更新资源清单\"><a class=\"anchor\" href=\"#85-更新资源清单\">#</a> 8.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-logstash-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 05-logstash-prod-sts.yaml</span></pre></td></tr></table></figure><h5 id=\"86-检查es生产环境索引\"><a class=\"anchor\" href=\"#86-检查es生产环境索引\">#</a> 8.6 检查 ES 生产环境索引</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0OV3zd4.png\" alt=\"1.png\" /></p>\n<h4 id=\"九-交付测试环境logstash\"><a class=\"anchor\" href=\"#九-交付测试环境logstash\">#</a> 九、交付测试环境 Logstash</h4>\n<h5 id=\"91-拉取镜像\"><a class=\"anchor\" href=\"#91-拉取镜像\">#</a> 9.1 拉取镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># docker pull docker.elastic.co/logstash/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker tag docker.elastic.co/logstash/logstash-oss:7.17.6 registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</span></pre></td></tr></table></figure><h5 id=\"92-编写logstash配置\"><a class=\"anchor\" href=\"#92-编写logstash配置\">#</a> 9.2 编写 logstash 配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat conf/logstash-test.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>input <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    kafka <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        bootstrap_servers <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"kafka-0.kafka-svc:9092,kafka-1.kafka-svc:9092,kafka-2.kafka-svc:9092\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        group_id <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"logstash-test\"</span>      <span class=\"token comment\"># 消费者组名称</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        consumer_threads <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"3\"</span>          <span class=\"token comment\"># 理想情况下，配置与分区数一样多的线程，实现均衡</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        topics_pattern <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-test-.*\"</span>  <span class=\"token comment\"># 通过正则表达式匹配要订阅的主题</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>filter <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\tjson <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token builtin class-name\">source</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"message\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>output <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    stdout <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        codec <span class=\"token operator\">=</span><span class=\"token operator\">></span> rubydebug</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    elasticsearch <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        hosts <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"es-data-0.es-svc:9200\"</span>,<span class=\"token string\">\"es-data-1.es-svc:9200\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        index <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token string\">\"app-test-%&#123;+YYYY.MM.dd&#125;\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        template_overwrite <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h5 id=\"93-创建测试环境configmap\"><a class=\"anchor\" href=\"#93-创建测试环境configmap\">#</a> 9.3 创建测试环境 configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create configmap logstash-test-conf --from-file<span class=\"token operator\">=</span>logstash.conf<span class=\"token operator\">=</span>conf/logstash-test.conf <span class=\"token parameter variable\">-n</span> logging</pre></td></tr></table></figure><h5 id=\"94-创建测试环境logstash\"><a class=\"anchor\" href=\"#94-创建测试环境logstash\">#</a> 9.4 创建测试环境 Logstash</h5>\n<p>1、创建 logstash-svc</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-logstash-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: logstash</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - port: <span class=\"token number\">9600</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">9600</span></pre></td></tr></table></figure><p>2、创建 logstash-StatefulSet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-logstash-test-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: logstash-test</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: logging</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"logstash-svc\"</span>           <span class=\"token comment\"># 使用此前创建的 svc，则无需重复创建</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: logstash</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      env: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: logstash</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        env: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - name: logstash</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/logstash-oss:7.17.6</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        args: <span class=\"token punctuation\">[</span><span class=\"token string\">\"-f\"</span>,<span class=\"token string\">\"config/logstash.conf\"</span><span class=\"token punctuation\">]</span>                     <span class=\"token comment\"># 启动时指定加载的配置文件</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            memory: 1024Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: PIPELINE_WORKERS</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          value: <span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: PIPELINE_BATCH_SIZE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          value: <span class=\"token string\">\"10000\"</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        lifecycle:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          postStart:                                            <span class=\"token comment\"># 设定 JVM</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            exec:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              command:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              - <span class=\"token string\">\"/bin/bash\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              - <span class=\"token string\">\"sed -i -e '/^-Xms/c-Xms1024m' -e '/^-Xmx/c-Xmx1024m' /usr/share/logstash/config/jvm.options\"</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: data                                            <span class=\"token comment\"># 持久化数据目录</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          mountPath: /usr/share/logstash/data</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: conf</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /usr/share/logstash/config/logstash.conf</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          subPath: logstash.conf</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/timezone          </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      - name: conf</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          name: logstash-test-conf</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          type: <span class=\"token string\">\"\"</span>          </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h5 id=\"95-更新资源清单\"><a class=\"anchor\" href=\"#95-更新资源清单\">#</a> 9.5 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-logstash-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 08-logstash<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 03-logstash-test-sts.yaml</span></pre></td></tr></table></figure><h5 id=\"96-检查es测试环境索引\"><a class=\"anchor\" href=\"#96-检查es测试环境索引\">#</a> 9.6 检查 ES 测试环境索引</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0OV3zd4.png\" alt=\"1.png\" /></p>\n<h4 id=\"十-kibana数据展示\"><a class=\"anchor\" href=\"#十-kibana数据展示\">#</a> 十、Kibana 数据展示</h4>\n<h5 id=\"101-添加生产环境索引\"><a class=\"anchor\" href=\"#101-添加生产环境索引\">#</a> 10.1 添加生产环境索引</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/B5uofDF.png\" alt=\"2.png\" /></p>\n<h5 id=\"102-查看生产环境数据\"><a class=\"anchor\" href=\"#102-查看生产环境数据\">#</a> 10.2 查看生产环境数据</h5>\n<p>kibana-&gt;Discover</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/yY4Y4Sz.png\" alt=\"3.png\" /></p>\n<p>①点击开发环境索引 -&gt;②选择需要查看的字段 -&gt;③进行 filter 筛选项目 -&gt;④选择对应时间段</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/9i3HsC6.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/PPAQczE.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/NkOwqO3.png\" alt=\"6.png\" /></p>\n",
            "tags": [
                "ELKStack"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/626047790.html",
            "url": "http://ixuyong.cn/posts/626047790.html",
            "title": "消费租赁系统微服务应用交付实践",
            "date_published": "2025-05-18T13:42:46.000Z",
            "content_html": "<h3 id=\"消费租赁系统微服务应用交付实践\"><a class=\"anchor\" href=\"#消费租赁系统微服务应用交付实践\">#</a> 消费租赁系统微服务应用交付实践</h3>\n<h4 id=\"一-部署中间件\"><a class=\"anchor\" href=\"#一-部署中间件\">#</a> 一、部署中间件</h4>\n<h5 id=\"11-部署mysql\"><a class=\"anchor\" href=\"#11-部署mysql\">#</a> 1.1 部署 MySQL</h5>\n<h6 id=\"111-mysql-configmap\"><a class=\"anchor\" href=\"#111-mysql-configmap\">#</a> 1.1.1 MySQL-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-mysql-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-cm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  my.cnf: <span class=\"token operator\">|</span>-</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token punctuation\">[</span>mysqld<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\">#performance setttings</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    lock_wait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    open_files_limit <span class=\"token operator\">=</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    back_log <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    max_connections <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    max_connect_errors <span class=\"token operator\">=</span> <span class=\"token number\">1000000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    table_open_cache <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    table_definition_cache <span class=\"token operator\">=</span> <span class=\"token number\">1024</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    thread_stack <span class=\"token operator\">=</span> 512K</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    sort_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    join_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    read_buffer_size <span class=\"token operator\">=</span> 8M</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    read_rnd_buffer_size <span class=\"token operator\">=</span> 4M</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    bulk_insert_buffer_size <span class=\"token operator\">=</span> 64M</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    thread_cache_size <span class=\"token operator\">=</span> <span class=\"token number\">768</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    interactive_timeout <span class=\"token operator\">=</span> <span class=\"token number\">600</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    wait_timeout <span class=\"token operator\">=</span> <span class=\"token number\">600</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    tmp_table_size <span class=\"token operator\">=</span> 32M</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    max_heap_table_size <span class=\"token operator\">=</span> 32M</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    max_allowed_packet <span class=\"token operator\">=</span> 128M</pre></td></tr></table></figure><h6 id=\"112-mysql-secret\"><a class=\"anchor\" href=\"#112-mysql-secret\">#</a> 1.1.2 MySQL-Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-mysql-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  MYSQL_ROOT_PASSWORD: Superman*2023</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"113-mysql-statefulset\"><a class=\"anchor\" href=\"#113-mysql-statefulset\">#</a> 1.1.3 MySQL-StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-mysql-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nf-flms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-nf-flms-svc\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      role: nf-flms</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        role: nf-flms</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              name: mysql-secret</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              key: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_DATABASE      <span class=\"token comment\">#数据库名称</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: nf-flms        </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: tcp-3306</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            cpu: 2000m</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            cpu: 200m</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          mountPath: /etc/mysql/conf.d/my.cnf</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          subPath: my.cnf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: mysql-cm</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            - key: my.cnf</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>              path: my.cnf</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          defaultMode: <span class=\"token number\">420</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"114-mysql-service\"><a class=\"anchor\" href=\"#114-mysql-service\">#</a> 1.1.4 MySQL Service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-mysql-nf-flms-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nf-flms-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: nf-flms</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - name: tcp-mysql-svc</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: mysql-nf-flms-svc-balance</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    role: nf-flms</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  - name: tcp-mysql-balance</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    nodePort: <span class=\"token number\">32206</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"115-更新资源清单\"><a class=\"anchor\" href=\"#115-更新资源清单\">#</a> 1.1.5 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create ns prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h6 id=\"116-导入数据库\"><a class=\"anchor\" href=\"#116-导入数据库\">#</a> 1.1.6 导入数据库</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">172.16</span>.85.231</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.85.231 -uroot -p\"Superman*2023\" -B nf_flms &lt; 202503310038/sggyl_nf_flms_202503310038.sql</span></pre></td></tr></table></figure><h6 id=\"117-连接外部数据库示例\"><a class=\"anchor\" href=\"#117-连接外部数据库示例\">#</a> 1.1.7 连接外部数据库示例</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05-mysql-nf-flms-svc-external.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">3306</span> </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Endpoints</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    app: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  name: mysql-nf-flms-svc-external</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>subsets:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>- addresses:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - ip: <span class=\"token number\">192.168</span>.1.68</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 01-nf-flms-mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nf-flms-svc-external.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">192.168</span>.1.68</pre></td></tr></table></figure><h5 id=\"12-部署redis-single\"><a class=\"anchor\" href=\"#12-部署redis-single\">#</a> 1.2 部署 Redis-single</h5>\n<h6 id=\"121-redis-configmap\"><a class=\"anchor\" href=\"#121-redis-configmap\">#</a> 1.2.1 Redis-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-redis-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis-conf</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  redis.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    appendonly <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    protected-mode no</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token function\">dir</span> /data</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    requirepass Superman*2023</pre></td></tr></table></figure><h6 id=\"122-redis-statefulset\"><a class=\"anchor\" href=\"#122-redis-statefulset\">#</a> 1.2.2 Redis-StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-redis-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  serviceName: redis-svc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: redis</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: redis</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: redis</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        image: redis:6.2.7</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - <span class=\"token string\">\"redis-server\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"/etc/redis/redis.conf\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: redis-6379</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          containerPort: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          mountPath: /etc/redis</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          name: redis-conf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          - key: redis.conf</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            path: redis.conf</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          storage: 2Gi</pre></td></tr></table></figure><h6 id=\"123-redis-service\"><a class=\"anchor\" href=\"#123-redis-service\">#</a> 1.2.3 Redis-Service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-redis-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redis-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: redis</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: redis-6379</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      targetPort: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: redis</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  clusterIP: None</pre></td></tr></table></figure><h6 id=\"124-更新资源清单\"><a class=\"anchor\" href=\"#124-更新资源清单\">#</a> 1.2.4 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 02-redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h5 id=\"14-部署nacos集群\"><a class=\"anchor\" href=\"#14-部署nacos集群\">#</a> 1.4 部署 Nacos 集群</h5>\n<h6 id=\"141-部署nacos-mysql\"><a class=\"anchor\" href=\"#141-部署nacos-mysql\">#</a> 1.4.1 部署 Nacos-MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-mysql-nacos-sts-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: nacos</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: mysql-nacos-balance</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    role: nacos</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - name: tcp-mysql-balance</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    nodePort: <span class=\"token number\">31106</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  name: mysql-nacos</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-nacos-svc\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      role: nacos</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        role: nacos</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          value: Superman*2023</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        - name: MYSQL_DATABASE    <span class=\"token comment\">#nacos 库名称</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          value: nacos</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"142-导入数据库\"><a class=\"anchor\" href=\"#142-导入数据库\">#</a> 1.4.2 导入数据库</h6>\n<p>nacos 下载地址：<a href=\"https://nacos.io/download/release-history/?spm=5238cd80.7a4232a8.0.0.f834e7559caaaK\">https://nacos.io/download/release-history/?spm=5238cd80.7a4232a8.0.0.f834e7559caaaK</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\">#  sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-mysql-nacos-sts-svc.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-nacos-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">172.16</span>.32.159</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.32.159 -uroot -p\"Superman*2023\" -B nacos &lt; nacos/conf/mysql-schema.sql</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.32.159 -uroot -p\"Superman*2023\" -B nacos &lt; sggyl_nf_nacos_202505210038.sql</span></pre></td></tr></table></figure><h6 id=\"143-部署nacos-configmap\"><a class=\"anchor\" href=\"#143-部署nacos-configmap\">#</a> 1.4.3 部署 Nacos-ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-nacos-configmap.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-cm</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  mysql.host: <span class=\"token string\">\"mysql-nacos-svc.prod.svc.cluster.local\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  mysql.db.name: <span class=\"token string\">\"nacos\"</span>   <span class=\"token comment\">#nacos 数据库名称</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  mysql.port: <span class=\"token string\">\"3306\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mysql.user: <span class=\"token string\">\"root\"</span>    <span class=\"token comment\">#nacos 数据库用户名</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  mysql.password: <span class=\"token string\">\"Superman*2023\"</span>   <span class=\"token comment\">#nacos 数据库密码</span></pre></td></tr></table></figure><h6 id=\"144-部署nacos-service-statefulset\"><a class=\"anchor\" href=\"#144-部署nacos-service-statefulset\">#</a> 1.4.4 部署 Nacos-Service-StatefulSet</h6>\n<p><strong>1. 开启鉴权</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nacos-sts-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: nacos</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: client-rpc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: raft-rpc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    port: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    targetPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: nacos</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  serviceName: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nacos</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        app: nacos</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nacos\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      initContainers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      - name: peer-finder-plugin-install</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        image: nacos/nacos-peer-finder-plugin:1.1</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        imagePullPolicy: IfNotPresent </pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            subPath: peer-finder</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: nacos</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        image: nacos/nacos-server:v2.4.3</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            memory: 4Gi</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: client-port</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          containerPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: client-rpc</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          containerPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: raft-rpc</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          containerPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          containerPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: NACOS_REPLICAS</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: SERVICE_NAME</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: DOMAIN_NAME</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"cluster.local\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>        - name: MYSQL_SERVICE_HOST</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>              key: mysql.host</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: MYSQL_SERVICE_DB_NAME</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              key: mysql.db.name</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>        - name: MYSQL_SERVICE_PORT</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              key: mysql.port</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        - name: MYSQL_SERVICE_USER</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              key: mysql.user</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>        - name: MYSQL_SERVICE_PASSWORD</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>              key: mysql.password</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        - name: SPRING_DATASOURCE_PLATFORM</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          value: <span class=\"token string\">\"mysql\"</span></pre></td></tr><tr><td data-num=\"116\"></td><td><pre>        - name: NACOS_SERVER_PORT</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        - name: NACOS_APPLICATION_PORT</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        - name: PREFER_HOST_MODE</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          value: <span class=\"token string\">\"hostname\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        - name: NACOS_AUTH_ENABLE</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>        - name: NACOS_AUTH_IDENTITY_KEY</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          value: <span class=\"token string\">\"nacosAuthKey\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>        - name: NACOS_AUTH_IDENTITY_VALUE</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>          value: <span class=\"token string\">\"nacosSecurtyValue\"</span></pre></td></tr><tr><td data-num=\"128\"></td><td><pre>        - name: NACOS_AUTH_TOKEN</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>          value: <span class=\"token string\">\"SecretKey012345678901234567890123456789012345678901234567890123456789\"</span></pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        - name: NACOS_AUTH_TOKEN_EXPIRE_SECONDS</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>          value: <span class=\"token string\">\"18000\"</span></pre></td></tr><tr><td data-num=\"132\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>          mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          subPath: peer-finder</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>          mountPath: /home/nacos/data</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>          mountPath: /home/nacos/logs</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"153\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>    - metadata:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        name: data</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>      spec:</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"162\"></td><td><pre>        accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"163\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>            storage: 5Gi</pre></td></tr></table></figure><p><strong>2. 关闭鉴权</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nacos-sts-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: nacos</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: server</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: client-rpc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    targetPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - name: raft-rpc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    targetPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    port: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    targetPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: nacos</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  serviceName: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nacos</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        app: nacos</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nacos\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      initContainers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      - name: peer-finder-plugin-install</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        image: nacos/nacos-peer-finder-plugin:1.1</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        imagePullPolicy: Always</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: data</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            subPath: peer-finder</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: nacos</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        image: nacos/nacos-server:v2.4.3</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            cpu: <span class=\"token string\">'2'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            memory: 4Gi</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: client-port</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          containerPort: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: client-rpc</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          containerPort: <span class=\"token number\">9848</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: raft-rpc</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          containerPort: <span class=\"token number\">9849</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        - name: old-raft-rpc</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          containerPort: <span class=\"token number\">7848</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        - name: NACOS_AUTH_ENABLE</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          value: <span class=\"token string\">\"false\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        - name: MODE  </pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          value: <span class=\"token string\">\"cluster\"</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        - name: NACOS_SERVERS</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          value: <span class=\"token string\">\"nacos-0.nacos-svc.prod.svc.cluster.local:8848  nacos-1.nacos-svc.prod.svc.cluster.local:8848 nacos-2.nacos-svc.prod.svc.cluster.local:8848\"</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        - name: NACOS_VERSION</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          value: <span class=\"token number\">2.4</span>.3</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>        - name: SPRING_DATASOURCE_PLATFORM</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>          value: <span class=\"token string\">\"mysql\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: NACOS_REPLICAS</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          value: <span class=\"token string\">\"3\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: SERVICE_NAME </pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          value: <span class=\"token string\">\"nacos-svc\"</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: DOMAIN_NAME </pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          value: <span class=\"token string\">\"cluster.local\"</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: NACOS_SERVER_PORT   </pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        - name: NACOS_APPLICATION_PORT</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          value: <span class=\"token string\">\"8848\"</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - name: PREFER_HOST_MODE</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          value: <span class=\"token string\">\"hostname\"</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>        - name: POD_NAMESPACE      </pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>              apiVersion: v1</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: MYSQL_SERVICE_HOST</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>              key: mysql.host</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        - name: MYSQL_SERVICE_DB_NAME</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>              key: mysql.db.name</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>        - name: MYSQL_SERVICE_PORT</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>              key: mysql.port</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>        - name: MYSQL_SERVICE_USER</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>              key: mysql.user</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>        - name: MYSQL_SERVICE_PASSWORD</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>              name: nacos-cm</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>              key: mysql.password</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>          mountPath: /home/nacos/plugins/peer-finder</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>          subPath: peer-finder</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          mountPath: /home/nacos/data</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>          subPath: data</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>          mountPath: /home/nacos/logs</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>          subPath: logs</pre></td></tr><tr><td data-num=\"140\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"151\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"155\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>    - metadata:</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>        name: data</pre></td></tr><tr><td data-num=\"158\"></td><td><pre>      spec:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>        storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"160\"></td><td><pre>        accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"161\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>            storage: 5Gi</pre></td></tr></table></figure><h6 id=\"145-部署nacos-ingress\"><a class=\"anchor\" href=\"#145-部署nacos-ingress\">#</a> 1.4.5 部署 Nacos-Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-nacos-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nacos-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: nacos.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: nacos-svc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">8848</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"146-更新资源清单\"><a class=\"anchor\" href=\"#146-更新资源清单\">#</a> 1.4.6 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#检查 cluster 是否一致</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 03-nacos<span class=\"token punctuation\">]</span><span class=\"token comment\"># for i in &#123;0..2&#125;; do echo nacos-$i; kubectl exec nacos-$i -c nacos -n prod -- cat conf/cluster.conf; donenacos-0</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:12.668</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nacos-1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:14.879</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nacos-2</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#2025-05-21T10:43:17.299</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nacos-0.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nacos-1.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nacos-2.nacos-svc.prod.svc.cluster.local:8848</pre></td></tr></table></figure><h6 id=\"147-web访问nacos\"><a class=\"anchor\" href=\"#147-web访问nacos\">#</a> 1.4.7 Web 访问 nacos</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Url：http://nacos.hmallleasing.com/nacos </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>User: nacos</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Passwd: nacos</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iNiUErY.jpeg\" alt=\"Snipaste_2025-05-18_21-13-44.jpg\" /></p>\n<h5 id=\"15-部署xxl-job\"><a class=\"anchor\" href=\"#15-部署xxl-job\">#</a> 1.5 部署 xxl-job</h5>\n<h6 id=\"151-部署xxl-job-mysql\"><a class=\"anchor\" href=\"#151-部署xxl-job-mysql\">#</a> 1.5.1 部署 xxl-job-MySQL</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-mysql-xxljob-sts-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-xxljob-svc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    role: xxljob</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    - name: tcp-mysql-svc</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  name: mysql-xxljob-external</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    - name: tcp-mysql-external</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      nodePort: <span class=\"token number\">31206</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    app: mysql</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    role: xxljob</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  name: mysql-xxljob</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  serviceName: <span class=\"token string\">\"mysql-xxljob-svc\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      app: mysql</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      role: xxljob</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        app: mysql</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        role: xxljob</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      - name: db</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        image: mysql:8.0</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        args:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - <span class=\"token string\">\"--character-set-server=utf8\"</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          value: Superman*2023</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        - containerPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>            cpu: 2000m</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            memory: 4000Mi</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            cpu: 200m</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>            port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>        - name: data</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>          mountPath: /var/lib/mysql/</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      name: data</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span><span class=\"token string\">\"ReadWriteMany\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"111\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"152-导入数据库\"><a class=\"anchor\" href=\"#152-导入数据库\">#</a> 1.5.2 导入数据库</h6>\n<p>xxljob 表结构下载地址：<a href=\"https://gitee.com/xuxueli0323/xxl-job/tree/3.1.0-release/doc/db\">https://gitee.com/xuxueli0323/xxl-job/tree/3.1.0-release/doc/db</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-mysql-xxljob-sts-svc.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># dig @10.96.0.10 mysql-xxljob-svc.prod.svc.cluster.local +short</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">172.16</span>.85.250</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 172.16.85.250  -uroot -p\"Superman*2023\"  &lt; tables_xxl_job.sql</span></pre></td></tr></table></figure><h6 id=\"153-部署xxl-job-service-deployment\"><a class=\"anchor\" href=\"#153-部署xxl-job-service-deployment\">#</a> 1.5.3 部署 xxl-job-Service-Deployment</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-xxljob-deploy-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxl-job</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: xxl-job</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: xxl-job</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - image: xuxueli/xxl-job-admin:3.1.0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        name: xxl-job</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - name: PARAMS</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          value: <span class=\"token string\">\"--spring.datasource.url=jdbc:mysql://mysql-xxljob-svc.prod.svc.cluster.local:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai --spring.datasource.username=root --spring.datasource.password=Superman*2023\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            cpu: <span class=\"token string\">'1'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            memory: 2000Mi</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            memory: 500Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  name: xxljob-svc</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>    name: http</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    app: xxl-job</pre></td></tr></table></figure><h6 id=\"154-部署xxl-job-service\"><a class=\"anchor\" href=\"#154-部署xxl-job-service\">#</a> 1.5.4 部署 xxl-job-service</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 04-xxljob-external.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxljob-balancer</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  type: NodePort</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - name: xxljob-balancer</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: xxl-job</pre></td></tr></table></figure><h6 id=\"155-部署xxl-job-ingress\"><a class=\"anchor\" href=\"#155-部署xxl-job-ingress\">#</a> 1.5.5 部署 xxl-job-Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-xxljob-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: xxljob-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: xxljob.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: xxljob-svc</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"156-更新资源清单\"><a class=\"anchor\" href=\"#156-更新资源清单\">#</a> 1.5.6 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 05-xxl-job<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h6 id=\"157-web访问xxl-job\"><a class=\"anchor\" href=\"#157-web访问xxl-job\">#</a> 1.5.7 Web 访问 xxl-job</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://192.168.40.101:30904/xxl-job-admin/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>http://xxljob.hmallleasing.com/xxl-job-admin/ </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>user:admin    </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>pwd:1223456</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/A5NbU2Z.jpeg\" alt=\"Snipaste_2025-05-18_14-54-59.jpg\" /></p>\n<h5 id=\"16-部署rabbitmq集群\"><a class=\"anchor\" href=\"#16-部署rabbitmq集群\">#</a> 1.6 部署 rabbitmq 集群</h5>\n<h6 id=\"161-创建rbac权限\"><a class=\"anchor\" href=\"#161-创建rbac权限\">#</a> 1.6.1 创建 RBAC 权限</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 01-rabbitmq-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  namespace: prod</pre></td></tr></table></figure><h6 id=\"162-创建集群的secret\"><a class=\"anchor\" href=\"#162-创建集群的secret\">#</a> 1.6.2 创建集群的 Secret</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-rabbitmq-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  password: talent</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  url: amqp://RABBITMQ_USER:RABBITMQ_PASS@rmq-cluster-balancer</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  username: superman</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h6 id=\"163-创建configmap\"><a class=\"anchor\" href=\"#163-创建configmap\">#</a> 1.6.3 创建 ConfigMap</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-rabbitmq-cm.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    addonmanager.kubernetes.io/mode: Reconcile</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled_plugins: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      <span class=\"token punctuation\">[</span>rabbitmq_management,rabbitmq_peer_discovery_k8s<span class=\"token punctuation\">]</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    rabbitmq.conf: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      loopback_users.guest <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      default_user <span class=\"token operator\">=</span> RABBITMQ_USER</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      default_pass <span class=\"token operator\">=</span> RABBITMQ_PASS</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      <span class=\"token comment\">## Cluster </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cluster_formation.peer_discovery_backend <span class=\"token operator\">=</span> rabbit_peer_discovery_k8s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cluster_formation.k8s.host <span class=\"token operator\">=</span> kubernetes.default.svc</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      <span class=\"token comment\">#cluster_formation.k8s.host = kubernetes.default.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cluster_formation.k8s.address_type <span class=\"token operator\">=</span> <span class=\"token function\">hostname</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      <span class=\"token comment\"># prod is rabbitmq-cluster's namespace#</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      <span class=\"token comment\">#################################################</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      cluster_formation.k8s.hostname_suffix <span class=\"token operator\">=</span> .rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      cluster_formation.node_cleanup.interval <span class=\"token operator\">=</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      cluster_formation.node_cleanup.only_log_warning <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      cluster_partition_handling <span class=\"token operator\">=</span> autoheal</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      <span class=\"token comment\">## queue master locator</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      queue_master_locator <span class=\"token operator\">=</span> min-masters</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.min <span class=\"token operator\">=</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      cluster_formation.randomized_startup_delay_range.max <span class=\"token operator\">=</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      <span class=\"token comment\"># memory</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      vm_memory_high_watermark.absolute <span class=\"token operator\">=</span> 100MB</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      <span class=\"token comment\"># disk</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      disk_free_limit.absolute <span class=\"token operator\">=</span> 2GB</pre></td></tr></table></figure><p><em>注：配置文件 cluster_formation.k8s.host 设置为 kubernetes.default.svc.cluster.local，然后就是各种连不上，后来换上 kubernetes.default.svc 就可以了，不知道是不是 k8s 新版本的问题。</em></p>\n<h6 id=\"164-创建集群的svc\"><a class=\"anchor\" href=\"#164-创建集群的svc\">#</a> 1.6.4 创建集群的 svc</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-rabbitmq-cluster-svc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    app: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  name: rabbitmq-cluster-balancer</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: rmqport</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h6 id=\"165-创建statefulset\"><a class=\"anchor\" href=\"#165-创建statefulset\">#</a> 1.6.5 创建 StatefulSet</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-rabbitmq-cluster-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  serviceName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      affinity:                                                 <span class=\"token comment\"># 避免 Pod 运行到同一个节点上了</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-cluster\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              topologyKey: <span class=\"token string\">\"kubernetes.io/hostname\"</span>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-v</span> /etc/rabbitmq/rabbitmq.conf <span class=\"token variable\">$&#123;RABBITMQ_CONFIG_FILE&#125;</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">exec</span> docker-entrypoint.sh rabbitmq-server</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: username</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              key: password </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              name: rabbitmq-secret</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: TZ</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          value: <span class=\"token string\">'Asia/Shanghai'</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: RABBITMQ_ERLANG_COOKIE</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          value: <span class=\"token string\">'SWvCP0Hrqv43NG7GybHC95ntCJKoW8UyNFWnBEWG8TY='</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: K8S_SERVICE_NAME</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          value: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: POD_IP</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              fieldPath: status.podIP</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        - name: RABBITMQ_USE_LONGNAME</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          value: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - name: RABBITMQ_NODENAME</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          value: rabbit@<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>K8S_SERVICE_NAME<span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">.</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc.cluster.local</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        - name: RABBITMQ_CONFIG_FILE</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          value: /var/lib/rabbitmq/rabbitmq.conf</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        name: rabbitmq</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          name: amqp</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmq-diagnostics\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          periodSeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        - mountPath: /etc/rabbitmq</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          name: config-volume</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>        - mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>          name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>      serviceAccountName: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>      - name: config-volume</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>          items:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>          - key: rabbitmq.conf</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>            path: rabbitmq.conf</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          - key: enabled_plugins</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>            path: enabled_plugins</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>          name: rabbitmq-cluster-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"122\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"124\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"126\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>      name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>      accessModes:</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>      - ReadWriteMany</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>      storageClassName: <span class=\"token string\">\"nfs-storage\"</span></pre></td></tr><tr><td data-num=\"133\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>          storage: 5Gi</pre></td></tr></table></figure><h6 id=\"166-创建ingress\"><a class=\"anchor\" href=\"#166-创建ingress\">#</a> 1.6.6 创建 Ingress</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            name: rabbitmq-cluster</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h6 id=\"167-更新资源清单\"><a class=\"anchor\" href=\"#167-更新资源清单\">#</a> 1.6.7 更新资源清单</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                 READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rabbitmq-cluster-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          9m53s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rabbitmq-cluster-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m47s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rabbitmq-cluster-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m40s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rabbitmq-cluster-0 -n prod -- /bin/bash</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@rabbitmq-cluster-0:/<span class=\"token comment\"># rabbitmqctl cluster_status</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>RABBITMQ_ERLANG_COOKIE <span class=\"token function\">env</span> variable support is deprecated and will be REMOVED <span class=\"token keyword\">in</span> a future version. Use the <span class=\"token environment constant\">$HOME</span>/.erlang.cookie <span class=\"token function\">file</span> or the --erlang-cookie switch instead.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Cluster status of <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local <span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Basics</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Cluster name: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>Disk Nodes</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Running Nodes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Versions</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local: RabbitMQ <span class=\"token number\">3.9</span>.29 on Erlang <span class=\"token number\">25.3</span>.2.9</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Maintenance status</pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, status: not under maintenance</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Alarms</pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>Memory alarm on <span class=\"token function\">node</span> rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"46\"></td><td><pre></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>Network Partitions</pre></td></tr><tr><td data-num=\"48\"></td><td><pre></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">(</span>none<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>Listeners</pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>Node: rabbit@rabbitmq-cluster-0.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>Node: rabbit@rabbitmq-cluster-1.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">15672</span>, protocol: http, purpose: HTTP API</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">25672</span>, protocol: clustering, purpose: inter-node and CLI tool communication</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>Node: rabbit@rabbitmq-cluster-2.rabbitmq-cluster.prod.svc.cluster.local, interface: <span class=\"token punctuation\">[</span>::<span class=\"token punctuation\">]</span>, port: <span class=\"token number\">5672</span>, protocol: amqp, purpose: AMQP <span class=\"token number\">0</span>-9-1 and AMQP <span class=\"token number\">1.0</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>Feature flags</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>Flag: drop_unroutable_metric, state: enabled</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>Flag: empty_basic_get_metric, state: enabled</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>Flag: implicit_default_bindings, state: enabled</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>Flag: maintenance_mode_status, state: enabled</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>Flag: quorum_queue, state: enabled</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Flag: stream_queue, state: enabled</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Flag: user_limits, state: enabled</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Flag: virtual_host_metadata, state: enabled</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XqURJbg.jpeg\" alt=\"Snipaste_2025-05-17_17-42-47.jpg\" /></p>\n<h6 id=\"168-web访问rabbitmq\"><a class=\"anchor\" href=\"#168-web访问rabbitmq\">#</a> 1.6.8 Web 访问 rabbitmq</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://rabbitmq.hmallleasing.com/<span class=\"token comment\">#/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>user:superman</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>pwd:talent</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/7qKxUBf.jpeg\" alt=\"Snipaste_2025-05-17_17-14-54.jpg\" /></p>\n<h6 id=\"168-rabbitmq全部挂了无法重启解决方案\"><a class=\"anchor\" href=\"#168-rabbitmq全部挂了无法重启解决方案\">#</a> 1.6.8 rabbitMQ 全部挂了，无法重启解决方案</h6>\n<p>Kubernetes 环境中，遇到 RabbitMQ 集群无法启动的问题。原因是 RabbitMQ 所有实例均失效，需要在每个 Pod 对应的持久化存储路径下创建 force_load 文件来强制启动。通过获取 PV 存储路径，在指定目录创建该文件后，重新启动 RabbitMQ 服务，成功解决了集群启动问题</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token comment\"># cd /data/dev-rabbitmq-storage-rabbitmq-cluster-0-pvc-3abca920-3c68-44eb-b0fd-406a4358b153/mnesia/rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 rabbit@rabbitmq-cluster-0.rabbitmq-cluster.dev.svc.cluster.local<span class=\"token punctuation\">]</span><span class=\"token comment\"># touch force_load</span></pre></td></tr></table></figure><h5 id=\"17-部署rabbitmq-single\"><a class=\"anchor\" href=\"#17-部署rabbitmq-single\">#</a> 1.7 部署 rabbitmq-single</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 04-rabbitmq<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 06-rabbitmq-single.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rabbitmq-single-data</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  - port: <span class=\"token number\">5672</span> </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    targetPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - name: http</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    targetPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    app: rabbitmq-single</pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>apiVersion: networking.k8s.io/v1 <span class=\"token comment\"># k8s >= 1.22 必须 v1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  name: rabbitmq-single-ingress</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  ingressClassName: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  - host: rabbitmq.hmallleasing.com</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            name: rabbitmq-single-svc</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>              number: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  name: rabbitmq-single</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>      app: rabbitmq-single</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        app: rabbitmq-single</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: rabbitmq-single</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        image: rabbitmq:3.9-management</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>        - containerPort: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - containerPort: <span class=\"token number\">15672</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>        - name: RABBITMQ_DEFAULT_USER  <span class=\"token comment\"># 自定义环境变量</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>          value: admin</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>        - name: RABBITMQ_DEFAULT_PASS</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>          value: Superman*2025</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>            memory: <span class=\"token string\">\"1Gi\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>            cpu: <span class=\"token string\">\"500m\"</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmqctl\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>          exec:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>            command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"rabbitmqctl\"</span>, <span class=\"token string\">\"status\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"102\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>        - name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>          mountPath: /var/lib/rabbitmq</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>      - name: rabbitmq-storage</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>        persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>          claimName: rabbitmq-single-data</pre></td></tr></table></figure><h4 id=\"二-微服务配置\"><a class=\"anchor\" href=\"#二-微服务配置\">#</a> 二、微服务配置</h4>\n<h5 id=\"21-代码编译前配置\"><a class=\"anchor\" href=\"#21-代码编译前配置\">#</a> 2.1 代码编译前配置</h5>\n<p>每个微服务需要配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nf-flms-order/src/main/resources/bootstrap-prd.yml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>info:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  groupId: @project.groupId@</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  artifactId: @project.artifactId@</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  version: @project.version@</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: 南方手机租赁平台</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  copyright: <span class=\"token number\">2021</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  description: 诚信 务实 专注 专业 创新</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>server:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  application:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    name: @artifactId@</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  profiles:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    active: prd</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  cloud:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    nacos:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      discovery:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        server-addr: nacos-svc.prod.svc.cluster.local:8848</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        namespace: 1d994267-0b13-45aa-bdbd-b810a37725ef</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        group: nf-flms</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      config:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        server-addr: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.server-addr&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        namespace: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.namespace&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        group: <span class=\"token variable\">$&#123;spring.cloud.nacos.discovery.group&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        file-extension: yml</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        shared-configs:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - data-id: nf-flms-application-<span class=\"token variable\">$&#123;spring.profiles.active&#125;</span><span class=\"token builtin class-name\">.</span><span class=\"token variable\">$&#123;spring.cloud.nacos.config.file-extension&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            group: nf-flms</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            refresh: <span class=\"token boolean\">true</span></pre></td></tr></table></figure><h5 id=\"22-导入mvn本地依赖\"><a class=\"anchor\" href=\"#22-导入mvn本地依赖\">#</a> 2.2 导入 mvn 本地依赖</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins repository<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll ~/.m2/repository</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>total <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> aopalliance</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">35</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> asm</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">30</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> avalon-framework</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">38</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> backport-util-concurrent</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">17</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> ch</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> classworlds</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">6</span> root root   <span class=\"token number\">62</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> cn</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>drwxr-xr-x <span class=\"token number\">36</span> root root <span class=\"token number\">4096</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> com</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">61</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-beanutils</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-cli</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">27</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-codec</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">33</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-collections</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">35</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-configuration</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-dbcp</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">30</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-digester</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-el</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">32</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-fileupload</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">32</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-httpclient</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-io</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-lang</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">29</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-logging</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> commons-net</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">26</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> commons-pool</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> concurrent</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">25</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> de</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> dom4j</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">28</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> doxia</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>drwxr-xr-x <span class=\"token number\">17</span> root root  <span class=\"token number\">251</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> io</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">8</span> root root   <span class=\"token number\">96</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> jakarta</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>drwxr-xr-x <span class=\"token number\">14</span> root root  <span class=\"token number\">175</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> javax</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">23</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> joda-time</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> junit</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> log4j</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> logkit</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> math</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">18</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> me</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">34</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> mysql</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>drwxr-xr-x <span class=\"token number\">13</span> root root  <span class=\"token number\">167</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> net</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">18</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> ognl</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>drwxr-xr-x <span class=\"token number\">56</span> root root <span class=\"token number\">4096</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> org</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">21</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> redis</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">22</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> stax</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">5</span> root root   <span class=\"token number\">72</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> tomcat</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">19</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xalan</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">24</span> Mar <span class=\"token number\">29</span>  <span class=\"token number\">2023</span> xerces</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">4</span> root root   <span class=\"token number\">42</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xml-apis</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>drwxr-xr-x  <span class=\"token number\">3</span> root root   <span class=\"token number\">20</span> Jun <span class=\"token number\">20</span>  <span class=\"token number\">2023</span> xmlenc</pre></td></tr></table></figure><h5 id=\"23-mvn打包代码\"><a class=\"anchor\" href=\"#23-mvn打包代码\">#</a> 2.3 mvn 打包代码</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/root/qzj-system-back/nf-flms</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms<span class=\"token punctuation\">]</span><span class=\"token comment\"># mvn -B -U clean package -Dmaven.test.skip=true -Dautoconfig.skip</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3zRSM8b.png\" alt=\"PixPin_2025-05-22_15-40-30.png\" /></p>\n<h5 id=\"24-nacos配置\"><a class=\"anchor\" href=\"#24-nacos配置\">#</a> 2.4 Nacos 配置</h5>\n<h6 id=\"241-nf-flms-application-prdyml\"><a class=\"anchor\" href=\"#241-nf-flms-application-prdyml\">#</a> 2.4.1 nf-flms-application-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  mq:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    qos: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    maxRetries <span class=\"token builtin class-name\">:</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  security:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    jwt:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      issuer: nf-fmls</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token comment\">#到期时间，单位毫秒</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      expiration: <span class=\"token punctuation\">&#123;</span>SYSTEM: <span class=\"token number\">1800000</span>, ALIPAY_MEMBER: <span class=\"token number\">31536000000</span>, SALES_MEMBER: <span class=\"token number\">31536000000</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      maxRetries: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      patterns:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        - /**</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    feign:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      allowHeads:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        - SOURCE_TYPE</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  rabbitmq:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    host: rabbitmq-cluster.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    port: <span class=\"token number\">5672</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    username: superman</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    password: talent</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    publisher-confirms: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    publisher-returns: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    virtual-host: /</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    listener:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      simple:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        acknowledge-mode: manual</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        concurrency: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        max-concurrency: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        retry:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  klock:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token comment\"># redis 地址</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    address: redis-0.redis-svc.prod.svc.cluster.local:6379</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    <span class=\"token comment\"># redis 密码</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\"># redis 数据索引</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    database: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\"># 获取锁最长阻塞时间（默认：60，单位：秒）</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    waitTime: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    <span class=\"token comment\"># 已获取锁后自动释放时间（默认：60，单位：秒）</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    leaseTime: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>jetcache:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  statIntervalMinutes: <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  areaInCacheName: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  hiddenPackages: com.timedigit</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  local:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    default:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      type: linkedhashmap</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>      keyConvertor: fastjson</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  remote:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    default:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      type: redis</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      keyConvertor: fastjson</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      valueEncoder: <span class=\"token function\">java</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      valueDecoder: <span class=\"token function\">java</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      poolConfig:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        minIdle: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        maxIdle: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        maxTotal: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      host: redis-0.redis-svc.prod.svc.cluster.local</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      port: <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      password: Superman*2023</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      database: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\"># feign 配置</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>feign:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  client:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>    config:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>      default:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>        connectTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        readTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre></pre></td></tr><tr><td data-num=\"75\"></td><td><pre><span class=\"token comment\">#ribbon 请求处理的超时时间</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>ribbon:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  <span class=\"token comment\">#全局请求连接的超时时间</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  ReadTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  <span class=\"token comment\">#全局请求的超时时间</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  ConnectTimeout: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>xgyq:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  url: https://qiaozuji-flms-api.test.qiaozuji.com</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  accessKey: 7d82b81b9b6075f7</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  secretKey: 17b85704043f57759983af5a744d82c0</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  path: /data/</pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>ant:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    <span class=\"token comment\">#正式参数</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  blockchainv3:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    endpoint: https://openapi.alipay.com/gateway.do</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    appId: <span class=\"token string\">'2021002169667748'</span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    privateKey: MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCxCce/eHKuTv+joeDwQv1a2Po0HsoJWdnBK8DMlflC3P8bUbPLom690tIWSo1JQyAFEFDGnE3Wqc/GFEySNZvHJ693YRiyLoLtBTJw9i/yH8aINX8fQ+SbM9SxyiMl9wqc+16hxp93Rar7zZY9UbMI3bRhRquPA7rGm/66I5BldDaL1Hnh1ZQ2WwNMOpiw5vAN8ulqm3HAkUC4pReG+SCtgzu6jj2pfbViakXDCO0G7JdNKUI2G4Bhstx3V+mLYKD7+jRwaVWyZDmtiFfjPDXx2u9UYFYDrfLZb7FBs9EjzLO5z6qPerjxu5T8P5qKmsXpmyu6hfj1R3pKwILTIGGzAgMBAAECggEBAJt9U4q/Zzng+HXnP4DF1W9tEpOkVx5PZAldPEBzmDE5mHWOFLPNPiZKe2pIoD6wTfcklU1bCqJ3Ep2ORpJDs0X/fQUEqoQUhblWzy6XixTFA8Gt+rCjGK2XoD9moeg+SXwG6t57bKN89OejcUj58Jzg3ARz5Un+pJS7fcZOZgwzxoyDnhnfe7mEcN8bkuy/2PhRkZWcTkY6ND/Ey5VHk8dqjIQ7uLf3TEilL+mNdcNoguju3I0yhAEtJlhsefeKKcFADWxWZRY129RJPn22TlHNk6h5GmCktnNthaMH1yDWq7mhi/2dUYqE6KlKD37zveQnVUtR6OtMV0wcFeKqY8ECgYEA5aIDJzRicxKdbuX6+aIoGHkH3iU6gfHQRUdI4FGf3+ZqfZ3AKbsBQ5EtzIns9HXVLsPdqq7ZTeFcAeIR7hdeiTWec+fxTu0VROu4z8SMQFQQW2QlvBMfNcPhACOlCFw2aZGbsaqwFmXqshxOBeqzR57MYvTAERvtgN6NxZm0Ar8CgYEAxV3DnOi8uFnttYtf4jI06Fba2LcRJgVL10jUZBDdZLfgMCcWLVHKYc50VQIK7lnzH7uP8+mJEVwT7fMWAmi1+x4XX2o+hbx4rsLbAwTMlWgnj3bFtR1/3r4VW8IF2BN9U95+KuxdQ9UMCsStVYlL4RldEDS3Q2jSwfyRX7B5Qg0CgYAVogOmB9tWd+R49BWGuu4IEC7bkKpIX519SU/mQgpLr4tMtjXKOKHP2bd003GNPiSNOUqCr+Is4hQm4UNLKMxxJKn+xVUIWHFugr5wZFXKIaFA2thrNWn1SLTDrJf5h6Zgn6UJQclA8uz/RodbK1ckYiNjFyeY9QaU42J7wRUiRQKBgQCKxigh7x+rPEhBS3Oq94RuDYwpr2cWZcjy4hm9FoKlLAktsn4MdaMo7GKt1xbai1LA8EAC0CV5mFXHDRJftUKoBHuIsoqtvFza/NXEJJ65Oxf97xSLCef8NYmNEDrNuL55t0rdYX8ej/G8rJf4OeapqwzdtUNa2Zy/m5iYQNyyDQKBgDYtXji8LJFtuF5hOVLC5X9xZKUCiFnblD9Rkv2P5OwyfFkq8tQq1a122ha/8Vwyuv4M/C4yfeEVPbE45OMBxlcggLbtSyubEdno1etmNBftOSHeG7xXjoNqJqP7cRiFE3EgjHsbDOCiED7YCk0RsFnvXmCqL8jgUJUsuXQFZwMK</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    alipayPublicKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgi1cntxez3ul/BPoOBpp2/4VczWnBZ2Hv1+r7hbsOjYqflOsBQYid/p8bN7WlyZ6QgwQO32288mORWH6scXBDAMc5g+nn4rBhSOqDHh0ZxVnf+RTqSMpp+207DcCO8MbEP5EucpYOsTIvOqufSY7QkTMcaNfaYxxTPLi20Y+VKY/EsB+m8UpY93f9cxKl8vwmpJUfOtU3ENxKfrAZhm1+h4QcFy5W7ERae1Htk40bMLCvWFCrNkhTXQ0LY9bJAPLGlr8zqv0Vb7PxauNdStgIuM7SPdFQ+ZJisj7kbvfeUbPFWMRRBJaBJJWmZYWsKP7RF1f7wSocZxodEUHyJp8IwIDAQAB</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    sceneCode: NFZL</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>    subSceneCode: <span class=\"token string\">'0000000000025599'</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>    siteUserId: <span class=\"token string\">'2088731937333632'</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    notifyUrl: </pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    timeout: 25h</pre></td></tr></table></figure><h6 id=\"242-nf-flms-gateway-prdyml\"><a class=\"anchor\" href=\"#242-nf-flms-gateway-prdyml\">#</a> 2.4.2 nf-flms-gateway-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  cloud:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    gateway:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      discovery:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>         locator:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>           lowerCaseServiceId: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>           enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      routes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        - id: nf-flms-system</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>          uri: lb://nf-flms-system</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>          order: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/system/**</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        - id: nf-flms-order</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          uri: lb://nf-flms-order</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>          order: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/order/**</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - id: nf-flms-statistics</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          uri: lb://nf-flms-statistics</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          order: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/statistics/**</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        - id: nf-flms-openapi</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          uri: lb://nf-flms-openapi</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          order: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          predicates:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          - <span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/openapi/**</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          filters:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          - <span class=\"token assign-left variable\">StripPrefix</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr></table></figure><h6 id=\"243-nf-flms-order-prdyml\"><a class=\"anchor\" href=\"#243-nf-flms-order-prdyml\">#</a> 2.4.3 nf-flms-order-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 订单服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 订单服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 档案</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>document:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  path: /data/</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    appName: nf-flms</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span>  </pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>sign:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  saas:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    <span class=\"token comment\">#appId: 7438855101</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    <span class=\"token comment\">#appKey: c8def27d26d9493d745cfba4a96fa3b5</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    appId: <span class=\"token number\">7438905950</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    appKey: 9554565359962695be2842dda660587a</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    host: https://smlopenapi.esign.cn</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>bairong:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  apiCode: <span class=\"token number\">3030942</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  appKey: f997bd90b4457e7407b249a228d903e35f71acf7a65544c08620fa41e32e1867</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  url: https://sandbox-api2.100credit.cn</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  strategyId: STR_BR0003107</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  confId: MCP_BR0001643</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  befor:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    path: /strategy_api/v3/hx_query</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  valid:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>    path: /infoverify/v3/info_verify  </pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"244-nf-flms-statistics-prdyml\"><a class=\"anchor\" href=\"#244-nf-flms-statistics-prdyml\">#</a> 2.4.4 nf-flms-statistics-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 统计服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 统计服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>   </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    appName: nf-flms-statistics</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"245-nf-flms-system-prdyml\"><a class=\"anchor\" href=\"#245-nf-flms-system-prdyml\">#</a> 2.4.5 nf-flms-system-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 系统服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 系统服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"246-nf-flms-openapi-prdyml\"><a class=\"anchor\" href=\"#246-nf-flms-openapi-prdyml\">#</a> 2.4.6 nf-flms-openapi-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 订单服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 订单服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>    </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    adminAddresses: http://xxljob-svc.prod.svc.cluster.local:8080/xxl-job-admin</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    appName: nf-flms</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span>  </pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#蚂蚁区块链代扣</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ant:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  blockchainv2:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>     callbackKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAgi1cntxez3ul/BPoOBpp2/4VczWnBZ2Hv1+r7hbsOjYqflOsBQYid/p8bN7WlyZ6QgwQO32288mORWH6scXBDAMc5g+nn4rBhSOqDHh0ZxVnf+RTqSMpp+207DcCO8MbEP5EucpYOsTIvOqufSY7QkTMcaNfaYxxTPLi20Y+VKY/EsB+m8UpY93f9cxKl8vwmpJUfOtU3ENxKfrAZhm1+h4QcFy5W7ERae1Htk40bMLCvWFCrNkhTXQ0LY9bJAPLGlr8zqv0Vb7PxauNdStgIuM7SPdFQ+ZJisj7kbvfeUbPFWMRRBJaBJJWmZYWsKP7RF1f7wSocZxodEUHyJp8IwIDAQAB</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>     <span class=\"token comment\">#callbackKey: MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAigh2X40D7Rm6zu3UFkFVnnLU0higr3Q/IRN+qyAOO2CGddQ1xhyqNr82mYUHcUvKUkTV/QDi3yvfMfo2DUaffURWab0Ucth02mz70Jknse/BmkZLX0r3jiJGDErbwP1xb149GwkgM3ffwDB+LhXe/4Y0cOXJV2Qen0p3Krl5I5QFiuGfFNHPHsBJ6WRMNie8J/rvdOriVZlYmevzDxbeuvsdrXqLRIiLazvK1B0+8NcGhInCkVLFw/Zvu7piCUkyh01AyVDB13Qau6M4l93usp5jQXcTLLxMhjJTnO1L2kwGUCekKgutLbUXLa0Ar8DHrD6Z2sw8iz2hVJUXjufYMwIDAQAB</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    enable: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"247-nf-flms-admin-prdyml\"><a class=\"anchor\" href=\"#247-nf-flms-admin-prdyml\">#</a> 2.4.7 nf-flms-admin-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  security:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    user:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      name: admin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      password: 4Q3NGIqsnU3Arwg9</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  boot:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    admin:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      ui:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        title: <span class=\"token string\">'俏租机 服务状态监控'</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        brand: <span class=\"token string\">'俏租机 服务状态监控'</span></pre></td></tr></table></figure><h6 id=\"248-nf-flms-file-prdyml\"><a class=\"anchor\" href=\"#248-nf-flms-file-prdyml\">#</a> 2.4.8 nf-flms-file-prd.yml</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>spring:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  datasource:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    url: jdbc:mysql://mysql-nf-flms-0.mysql-nf-flms-svc.prod.svc.cluster.local:3306/nf-flms?serverTimezone<span class=\"token operator\">=</span>Asia/Shanghai<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useUnicode</span><span class=\"token operator\">=</span>true<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">characterEncoding</span><span class=\"token operator\">=</span>utf8<span class=\"token operator\">&amp;</span><span class=\"token assign-left variable\">useSSL</span><span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    username: root</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    password: Superman*2023</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>swagger:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  title: 文件服务接口</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  description: 文件服务接口</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  version: <span class=\"token number\">1.0</span>.0.SNAPSHOT</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  base-package: com.timedigit</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  authorization: </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    name: Authorization</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    key-name: Authorization</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    auth-regex:  ^.*$</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>prometheus:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  project-enviroment: <span class=\"token variable\">$&#123;spring.profiles.active&#125;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  project-name: <span class=\"token variable\">$&#123;spring.application.name&#125;</span>   </pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>timedigit:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  job:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    adminAddresses: http://192.168.1.70:30959/xxl-job-admin/</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    appName: nf-flms-statistics</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    ip:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    port: <span class=\"token number\">9996</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    logPath: /logs/jobhandler</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    accessToken:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    logRetentionDays: <span class=\"token number\">5</span> </pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>knife4j:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  enable: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  setting:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    language: zh-CN</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    enableVersion: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    enableSearch: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    enableFooter: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    enableFooterCustom: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    footerCustomContent: Copyright  <span class=\"token number\">2020</span>-<span class=\"token punctuation\">[</span>深圳市租享生活科技有限公司<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>https://www.qiaozuji.com<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  basic:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    enable: <span class=\"token boolean\">false</span> </pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># 档案</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>document:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  path: /data/</pre></td></tr></table></figure><h5 id=\"25-构建镜像\"><a class=\"anchor\" href=\"#25-构建镜像\">#</a> 2.5 构建镜像</h5>\n<h6 id=\"251-构建nf-flms-order\"><a class=\"anchor\" href=\"#251-构建nf-flms-order\">#</a> 2.5.1 构建 nf-flms-order</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins nf-flms-order<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>COPY target/nf-flms-order.jar nf-flms-order.jar</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-order.jar</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-order</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0 .</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0</span></pre></td></tr></table></figure><h6 id=\"252-构建nf-flms-statistics\"><a class=\"anchor\" href=\"#252-构建nf-flms-statistics\">#</a> 2.5.2 构建 nf-flms-statistics</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-statistics.jar nf-flms-statistics.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-statistics.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-statistics</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v1</span></pre></td></tr></table></figure><h6 id=\"253-构建nf-flms-system\"><a class=\"anchor\" href=\"#253-构建nf-flms-system\">#</a> 2.5.3 构建 nf-flms-system</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-system.jar nf-flms-system.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30011</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-system.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-system</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v1</span></pre></td></tr></table></figure><h6 id=\"254-构建nf-flms-openapi\"><a class=\"anchor\" href=\"#254-构建nf-flms-openapi\">#</a> 2.5.4 构建 nf-flms-openapi</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-openapi.jar nf-flms-openapi.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30022</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-openapi.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-openapi</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v1</span></pre></td></tr></table></figure><h6 id=\"255-构建nf-flms-gateway\"><a class=\"anchor\" href=\"#255-构建nf-flms-gateway\">#</a> 2.5.5 构建 nf-flms-gateway</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-gateway.jar nf-flms-gateway.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-gateway.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-gateway</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2</span></pre></td></tr></table></figure><h6 id=\"256-构建nf-flms-file\"><a class=\"anchor\" href=\"#256-构建nf-flms-file\">#</a> 2.5.6 构建 nf-flms-file</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-file.jar nf-flms-file.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30017</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-file.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-file</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-file:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-file:v1</span></pre></td></tr></table></figure><h6 id=\"257-构建nf-flms-admin\"><a class=\"anchor\" href=\"#257-构建nf-flms-admin\">#</a> 2.5.7 构建 nf-flms-admin</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM openjdk:8-jre</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>VOLUME /tmp</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>COPY target/nf-flms-admin.jar nf-flms-admin.jar</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EXPOSE <span class=\"token number\">30013</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>CMD <span class=\"token function\">java</span> <span class=\"token variable\">$JAVA_OPTS</span> <span class=\"token parameter variable\">-Djava.security.egd</span><span class=\"token operator\">=</span>file:/dev/./urandom <span class=\"token parameter variable\">-jar</span> nf-flms-admin.jar</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>/root/qzj-system-back/nf-flms/nf-flms-admin</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v1 .</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># docker login --username=xyapples@163.com registry.cn-hangzhou.aliyuncs.com</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v1</span></pre></td></tr></table></figure><h5 id=\"26-配置xxl-job执行器\"><a class=\"anchor\" href=\"#26-配置xxl-job执行器\">#</a> 2.6 配置 XXL-JOB 执行器</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/LrPhTlM.png\" alt=\"微信图片_20250523105717.png\" /></p>\n<h4 id=\"三-部署微服务应用\"><a class=\"anchor\" href=\"#三-部署微服务应用\">#</a> 三、部署微服务应用</h4>\n<h5 id=\"31-创建secret\"><a class=\"anchor\" href=\"#31-创建secret\">#</a> 3.1 创建 secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#  sed -i \"s#dev#prod#g\" *.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls prod-api.hmallleasig.com --key hmallleasing.com.key --cert hmallleasing.com.pem -n prod</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harbor-admin --docker-server=registry.cn-hangzhou.aliyuncs.com --docker-username=xyapples@163.com --docker-password=passwd -n prod</span></pre></td></tr></table></figure><h5 id=\"32-创建nf-flms-gateway\"><a class=\"anchor\" href=\"#32-创建nf-flms-gateway\">#</a> 3.2 创建 nf-flms-gateway</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl apply -f 01-nf-flms-gateway.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nf-flms-gateway created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>service/gateway-svc created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ingress.networking.k8s.io/gateway-ingress created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-nf-flms-gateway.yaml </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      - name: nf-flms-gateway</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-gateway:v2.2 </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-gateway.jar\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  name: gateway-svc</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>    app: nf-flms-gateway</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  name: gateway-ingress</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - host: <span class=\"token string\">\"prod-api.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>            name: gateway-svc</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>    - prod-api.hmallleasing.com</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretName</span></pre></td></tr></table></figure><h5 id=\"33-创建nf-flms-statistics\"><a class=\"anchor\" href=\"#33-创建nf-flms-statistics\">#</a> 3.3 创建 nf-flms-statistics</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 03-nf-flms-statistics.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-statistics</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-statistics</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-statistics:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-statistics.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"34-创建nf-flms-order\"><a class=\"anchor\" href=\"#34-创建nf-flms-order\">#</a> 3.4 创建 nf-flms-order</h5>\n<h6 id=\"341-创建pvc\"><a class=\"anchor\" href=\"#341-创建pvc\">#</a> 3.4.1 创建 PVC</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-data-image.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: data-image</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      storage: 2Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr></table></figure><h6 id=\"342-创建nf-flms-order\"><a class=\"anchor\" href=\"#342-创建nf-flms-order\">#</a> 3.4.2 创建 nf-flms-order</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 02-nf-flms-order.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-order</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-order</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-order</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-order</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-order:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-order.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>        - name: data-image</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          mountPath: /data</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: data-image</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          claimName: data-image</pre></td></tr></table></figure><h5 id=\"35-创建nf-flms-system\"><a class=\"anchor\" href=\"#35-创建nf-flms-system\">#</a> 3.5 创建 nf-flms-system</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 04-nf-flms-system.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-system</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-system</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-system</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-system</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-system:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-system.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"36-创建nf-flms-admin\"><a class=\"anchor\" href=\"#36-创建nf-flms-admin\">#</a> 3.6 创建 nf-flms-admin</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 05-nf-flms-admin.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-admin   </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-admin</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-admin</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-admin</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-admin:v2.0 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-admin.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  name: nf-flms-admin-svc</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>    app: nf-flms-admin</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>    targetPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"80\"></td><td><pre></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  name: nf-flms-admin-ingress</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  - host: <span class=\"token string\">\"monitor.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>            name: nf-flms-admin-svc</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr></table></figure><h5 id=\"37-创建nf-flms-openapi\"><a class=\"anchor\" href=\"#37-创建nf-flms-openapi\">#</a> 3.7 创建 nf-flms-openapi</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 06-nf-flms-openapi.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-openapi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-openapi</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-openapi:v2.2 </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        command: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token string\">\"/bin/sh\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token string\">\"-c\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - <span class=\"token string\">\"java -Xms256m -Xmx1024m -Dspring.profiles.active=prd -Djava.security.egd=file:/dev/./urandom -jar -Duser.timezone=GMT+08 nf-flms-openapi.jar\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            port: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr></table></figure><h5 id=\"38-查看服务是否注册nacos\"><a class=\"anchor\" href=\"#38-查看服务是否注册nacos\">#</a> 3.8 查看服务是否注册 Nacos</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/I3obzQJ.png\" alt=\"1.png\" /></p>\n<h4 id=\"四-部署前端ui\"><a class=\"anchor\" href=\"#四-部署前端ui\">#</a> 四、部署前端 UI</h4>\n<h5 id=\"41-修改前端配置\"><a class=\"anchor\" href=\"#41-修改前端配置\">#</a> 4.1 修改前端配置</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># git checkout nf-flms-ui-v2.2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim src/environments/environment.prod.ts</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat src/environments/environment.prod.ts</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> const environment <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  // SERVER_URL: <span class=\"token variable\"><span class=\"token variable\">`</span>https://nf-flms-api.prd.qiaozuji.com<span class=\"token variable\">`</span></span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  SERVER_URL: <span class=\"token variable\"><span class=\"token variable\">`</span>https://prod-api.hmallleasing.com<span class=\"token variable\">`</span></span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  production: true,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  useHash: true,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  hmr: false,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h5 id=\"42-编译项目\"><a class=\"anchor\" href=\"#42-编译项目\">#</a> 4.2 编译项目</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://nodejs.org/dist/v12.20.0/node-v12.20.0-linux-x64.tar.xz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf node-v12.20.0-linux-x64.tar.xz -C /usr/local/</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /usr/local/node-v12.20.0-linux-x64/</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 node<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv node-v12.20.0-linux-x64 node </span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 node<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/profile.d/nodejs.sh </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">NODE_HOME</span><span class=\"token operator\">=</span>/usr/local/node</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token variable\">$NODE_HOME</span>/bin:<span class=\"token environment constant\">$PATH</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># node -v &amp;&amp; npm -v</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>v12.20.0</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">6.14</span>.8</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm install yarn -g</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># yarn -v</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">1.22</span>.19</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd nf-flms-ui/</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm install -g yarn -registry=https://registry.npm.taobao.org</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># yarn install</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build-qnyp </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 nf-flms-ui<span class=\"token punctuation\">]</span><span class=\"token comment\"># npm run build-test</span></pre></td></tr></table></figure><h5 id=\"43编写dockerfile\"><a class=\"anchor\" href=\"#43编写dockerfile\">#</a> 4.3 编写 Dockerfile</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@jenkins qzj-system-front<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>FROM nginx</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>COPY ./dist/ /code</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>RUN <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /etc/nginx/conf.d/default.conf</pre></td></tr></table></figure><h5 id=\"44-制作镜像并推送仓库\"><a class=\"anchor\" href=\"#44-制作镜像并推送仓库\">#</a> 4.4 制作镜像并推送仓库</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cd /root/nf-flms-ui</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># docker build -t registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0 .</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># docker push registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0</span></pre></td></tr></table></figure><h5 id=\"45-创建configmap\"><a class=\"anchor\" href=\"#45-创建configmap\">#</a> 4.5 创建 ConfigMap</h5>\n<h6 id=\"451-准备nginx配置文件\"><a class=\"anchor\" href=\"#451-准备nginx配置文件\">#</a> 4.5.1 准备 Nginx 配置文件</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat prod.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        server_name prod.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>        root /code/prod<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>            index  index.html index.htm<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        server_name prod-api.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>                proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                proxy_set_header REMOTE-HOST <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                proxy_pass http://gateway-svc.prod.svc.cluster.local:8080<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h6 id=\"452-创建configmap\"><a class=\"anchor\" href=\"#452-创建configmap\">#</a> 4.5.2 创建 ConfigMap</h6>\n<p>在启动 ui 项目时，通过 configmap 挂载配置，便于后期动态修改；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create configmap nf-flms-ui-conf --from-file=./prod.hmallleasing.com.conf -n prod</span></pre></td></tr></table></figure><h5 id=\"46-创建前端ui\"><a class=\"anchor\" href=\"#46-创建前端ui\">#</a> 4.6 创建前端 UI</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat 07-ui-deploy-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nf-flms-ui</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nf-flms-ui</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nf-flms-ui</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imagePullSecrets:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: harbor-admin</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      - name: nf-flms-ui</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/nf-flms-ui:v1.0</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          limits:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            cpu: <span class=\"token string\">'1000m'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            memory: 1Gi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            cpu: <span class=\"token string\">\"200m\"</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            memory: <span class=\"token string\">\"500Mi\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        readinessProbe:         <span class=\"token comment\"># 就绪探针，不就绪则从负载均衡移除</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        livenessProbe:          <span class=\"token comment\"># 存活探针，不存活会重启</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          tcpSocket:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: ngxconfs</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /etc/nginx/conf.d/</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      - name: ngxconfs</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          name: nf-flms-ui-conf</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>    app: nf-flms-ui</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>    targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  name: nf-flms-ui-ingress</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  - host: <span class=\"token string\">\"prod.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>            name: nf-flms-ui-svc</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>    - prod.hmallleasing.com</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>    secretName: <span class=\"token string\">\"prod-api.hmallleasig.com\"</span>   <span class=\"token comment\">#配置默认证书可不添加 secretName</span></pre></td></tr></table></figure><h5 id=\"47-创建ssl-secret\"><a class=\"anchor\" href=\"#47-创建ssl-secret\">#</a> 4.7 创建 ssl secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd ssl/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ssl<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create secret tls prod-api.hmallleasig.com --key *.hmallleasing.com_key.key --cert *.hmallleasing.com_chain.crt -n dev</span></pre></td></tr></table></figure><h5 id=\"48-更新资源清单\"><a class=\"anchor\" href=\"#48-更新资源清单\">#</a> 4.8 更新资源清单</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 07-ui-deploy-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 06-service-all<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n prod</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>mysql-nacos-0                         <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>mysql-nf-flms-0                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7d4h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mysql-xxljob-0                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nacos-0                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nacos-1                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>nacos-2                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4d22h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>nf-flms-admin-576b8fb949-2w6vg        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          13m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nf-flms-gateway-55cb54cc7c-jtmjj      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          28m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>nf-flms-gateway-55cb54cc7c-zmgpc      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          28m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>nf-flms-openapi-67d66d97cf-ldhgz      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          16m</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nf-flms-openapi-67d66d97cf-vq82b      <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>nf-flms-order-599dcd884c-k7rtf        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          7m57s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf-flms-order-599dcd884c-wjtn7        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          11m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nf-flms-statistics-77bf7dd847-n7k46   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          23m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>nf-flms-statistics-77bf7dd847-qjp7q   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          23m</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>nf-flms-system-8d5c784b9-2cwrj        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15m</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nf-flms-system-8d5c784b9-lhs2f        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          14m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>nf-flms-ui-55467cd98b-gl99s           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          57m</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>rabbitmq-cluster-0                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rabbitmq-cluster-1                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rabbitmq-cluster-2                    <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>redis-0                               <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>xxl-job-76c9464876-dzntc              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8d</pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1888662579.html",
            "url": "http://ixuyong.cn/posts/1888662579.html",
            "title": "Containerd常用命令",
            "date_published": "2025-05-14T12:29:07.000Z",
            "content_html": "<h3 id=\"containerd常用命令\"><a class=\"anchor\" href=\"#containerd常用命令\">#</a> Containerd 常用命令</h3>\n<h4 id=\"1-安装containerd\"><a class=\"anchor\" href=\"#1-安装containerd\">#</a> 1. 安装 Containerd</h4>\n<p><strong>1.1 配置安装源</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr></table></figure><p><strong>1.2 安装 docker-ce、containerd</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> docker-ce containerd <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p>\n<p><strong>1.3 配置 Containerd 所需的模块</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>overlay</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>br_netfilter</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</pre></td></tr></table></figure><p><strong>1.4 加载模块</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><strong>1.5 配置 Containerd 所需的内核</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><strong>1.6 加载内核</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></pre></td></tr></table></figure><p><strong>1.7 生成 Containerd 的配置文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/containerd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>containerd config default <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/containerd/config.toml</pre></td></tr></table></figure><p><strong>1.8 更改 Containerd 的 Cgroup 和 Pause 镜像</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr></table></figure><p><strong>1.9 启动 Containerd，并配置开机自启动</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> containerd</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl status  containerd</pre></td></tr></table></figure><h4 id=\"2-containerd-配置镜像加速\"><a class=\"anchor\" href=\"#2-containerd-配置镜像加速\">#</a> 2. Containerd 配置镜像加速</h4>\n<p>打开 /etc/containerd/config.toml 文件，找到 [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors] 部分，添加所需的镜像源配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/containerd/config.toml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加以下配置镜像加速服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"docker.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    endpoint <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>      <span class=\"token string\">\"https://docker.io\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      <span class=\"token string\">\"https://6qxc6b6n.mirror.aliyuncs.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token string\">\"https://dockerproxy.com/\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"gcr.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    endpoint <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token string\">\"https://gcr.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token string\">\"https://gcr.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      <span class=\"token string\">\"https://gcr.dockerproxy.com\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    <span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p><strong>重新启动 Containerd</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl restart containerd</pre></td></tr></table></figure><h4 id=\"3-containerd常用操作命令实践\"><a class=\"anchor\" href=\"#3-containerd常用操作命令实践\">#</a> 3. Containerd 常用操作命令实践</h4>\n<h5 id=\"31-查看containerd命名空间\"><a class=\"anchor\" href=\"#31-查看containerd命名空间\">#</a> <strong>3.1 查看 Containerd 命名空间</strong></h5>\n<p>namespace 来于指定类似于工作空间的隔离区域</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ctr namespace ls </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME    LABELS </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>default        </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s.io         </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>moby</pre></td></tr></table></figure><h5 id=\"32-查看containerd镜像\"><a class=\"anchor\" href=\"#32-查看containerd镜像\">#</a> <strong>3.2 查看 Containerd 镜像</strong></h5>\n<p>因为没有指定 namespace，所以查看的是默认命名空间下的镜像</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr images <span class=\"token function\">ls</span></pre></td></tr></table></figure><p>查看指定命名空间 k8s.io 下的镜像</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io images <span class=\"token function\">ls</span></pre></td></tr></table></figure><h5 id=\"33-拉取containerd镜像\"><a class=\"anchor\" href=\"#33-拉取containerd镜像\">#</a> <strong>3.3 拉取 Containerd 镜像</strong></h5>\n<p>拉取指定命名空间 k8s.io 镜像 pause-amd64:3.2</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io images pull registry.aliyuncs.com/google_containers/pause-amd64:3.2</pre></td></tr><tr><td data-num=\"2\"></td><td><pre> ctr <span class=\"token parameter variable\">-n</span> k8s.io images pull docker.io/library/nginx:1.21</pre></td></tr></table></figure><h5 id=\"34-删除containerd镜像\"><a class=\"anchor\" href=\"#34-删除containerd镜像\">#</a> <strong>3.4 删除 containerd 镜像</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io images <span class=\"token function\">rm</span> registry.aliyuncs.com/google_containers/pause-amd64:3.2</pre></td></tr></table></figure><h5 id=\"35-导出containerd镜像\"><a class=\"anchor\" href=\"#35-导出containerd镜像\">#</a> <strong>3.5 导出 Containerd 镜像</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io images <span class=\"token builtin class-name\">export</span> pause.tar.gz registry.aliyuncs.com/google_containers/pause-amd64:3.2</pre></td></tr></table></figure><h5 id=\"36-导入containerd镜像\"><a class=\"anchor\" href=\"#36-导入containerd镜像\">#</a> <strong>3.6 导入 Containerd 镜像</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io image <span class=\"token function\">import</span> pause.tar.gz</pre></td></tr></table></figure><p><em>docker save -o 命令导出来的镜像可以用 ctr images import 导出，同理 ctr images export 导出来的镜像也可以有 docker load 还原。</em></p>\n<h5 id=\"37-标记containerd镜像\"><a class=\"anchor\" href=\"#37-标记containerd镜像\">#</a> <strong>3.7 标记 Containerd 镜像</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io images tag registry.aliyuncs.com/google_containers/pause-amd64:3.2 pause:3.2</pre></td></tr></table></figure><h5 id=\"38-运行containerd容器\"><a class=\"anchor\" href=\"#38-运行containerd容器\">#</a> <strong>3.8 运行 Containerd 容器</strong></h5>\n<p>在后台运行一个 centos 镜像的容器，名称叫做 centos_k8s</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io  run <span class=\"token parameter variable\">-d</span>  docker.io/library/nginx:1.21 web</pre></td></tr></table></figure><h5 id=\"39-查看运行容器的task\"><a class=\"anchor\" href=\"#39-查看运行容器的task\">#</a> <strong>3.9 查看运行容器的 task</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io task <span class=\"token function\">ls</span></pre></td></tr></table></figure><h5 id=\"310-启动指定容器task\"><a class=\"anchor\" href=\"#310-启动指定容器task\">#</a> 3.10 启动指定容器 task</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io task start <span class=\"token parameter variable\">-d</span> centos_k8s</pre></td></tr></table></figure><h5 id=\"311-进入指定容器task\"><a class=\"anchor\" href=\"#311-进入指定容器task\">#</a> 3.11 进入指定容器 task</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io task <span class=\"token builtin class-name\">exec</span> --exec-id <span class=\"token number\">3118</span> <span class=\"token parameter variable\">-t</span> web /bin/bash</pre></td></tr></table></figure><h5 id=\"312-删除指定容器task\"><a class=\"anchor\" href=\"#312-删除指定容器task\">#</a> 3.12 删除指定容器 task</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io task <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> web</pre></td></tr></table></figure><h5 id=\"313-停止指定容器task\"><a class=\"anchor\" href=\"#313-停止指定容器task\">#</a> 3.13 停止指定容器 task</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io task <span class=\"token function\">kill</span> <span class=\"token parameter variable\">--signal</span> <span class=\"token number\">9</span> centos_k8s</pre></td></tr></table></figure><h5 id=\"314-查看容器\"><a class=\"anchor\" href=\"#314-查看容器\">#</a> 3.14 查看容器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io c list</pre></td></tr></table></figure><h5 id=\"315-删除容器\"><a class=\"anchor\" href=\"#315-删除容器\">#</a> 3.15 删除容器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ctr <span class=\"token parameter variable\">-n</span> k8s.io c <span class=\"token function\">rm</span> centos</pre></td></tr></table></figure><p>删除容器以前需要将 task 删除，不然会报以下错误</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ctr -n k8s.io c rm web </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ERRO<span class=\"token punctuation\">[</span>0000<span class=\"token punctuation\">]</span> failed to delete container <span class=\"token string\">\"web\"</span>              <span class=\"token assign-left variable\">error</span><span class=\"token operator\">=</span><span class=\"token string\">\"cannot delete a non stopped container: &#123;running 0 0001-01-01 00:00:00 +0000 UTC&#125;\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ctr: cannot delete a non stopped container: <span class=\"token punctuation\">&#123;</span>running <span class=\"token number\">0</span> 0001-01-01 00:00:00 +0000 UTC<span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"4-docker与containerd常用命令对比\"><a class=\"anchor\" href=\"#4-docker与containerd常用命令对比\">#</a> 4. Docker 与 Containerd 常用命令对比</h4>\n<table>\n<thead>\n<tr>\n<th>说明</th>\n<th>docker 命令</th>\n<th>containerd 命令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>查看本地镜像</td>\n<td>docker images</td>\n<td>ctr images ls</td>\n</tr>\n<tr>\n<td>拉取镜像</td>\n<td>docker pull imagename</td>\n<td>ctr images pull imagename</td>\n</tr>\n<tr>\n<td>推送镜像</td>\n<td>docker push imagename</td>\n<td>ctr images push imagename</td>\n</tr>\n<tr>\n<td>给镜像打标签</td>\n<td>docker tag imagename tagname</td>\n<td>ctr images tag imagename tagname</td>\n</tr>\n<tr>\n<td>导出镜像</td>\n<td>docker save filename imagename</td>\n<td>ctr images export filename imagename</td>\n</tr>\n<tr>\n<td>导入镜像</td>\n<td>docker load filename</td>\n<td>ctr image import filename</td>\n</tr>\n<tr>\n<td>运行并创建容器</td>\n<td>docker run [options] imagename commond</td>\n<td>ctr run [options]  imagenamecontainername</td>\n</tr>\n<tr>\n<td>进入容器</td>\n<td>docker exec [options] names commond</td>\n<td>ctr task exec [options]  names commond</td>\n</tr>\n<tr>\n<td>查看运行的容器</td>\n<td>docker ps</td>\n<td>ctr task list</td>\n</tr>\n<tr>\n<td>删除容器</td>\n<td>docker rm [options] names</td>\n<td>1.ctr task rm -f names 2. ctr c rm -f names</td>\n</tr>\n</tbody>\n</table>\n",
            "tags": [
                "Docker"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1490514396.html",
            "url": "http://ixuyong.cn/posts/1490514396.html",
            "title": "Redis Cluster集群部署",
            "date_published": "2025-05-12T13:21:44.000Z",
            "content_html": "<h3 id=\"redis-cluster集群部署\"><a class=\"anchor\" href=\"#redis-cluster集群部署\">#</a> Redis Cluster 集群部署</h3>\n<h4 id=\"1-环境配置\"><a class=\"anchor\" href=\"#1-环境配置\">#</a> 1、环境配置</h4>\n<h5 id=\"11-关闭防火墙-selinux\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux\">#</a> 1.1 关闭防火墙、Selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr></table></figure><h5 id=\"11-配置yum源\"><a class=\"anchor\" href=\"#11-配置yum源\">#</a> 1.1 配置 yum 源</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#rocky linux 配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/rocky-*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>yum clean all <span class=\"token operator\">&amp;&amp;</span> yum makecache</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">mkdir</span> /soft /data /scripts /backup</pre></td></tr></table></figure><h5 id=\"13-配置文件描述符\"><a class=\"anchor\" href=\"#13-配置文件描述符\">#</a> 1.3 配置文件描述符</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><h5 id=\"14-系统内核参数调优\"><a class=\"anchor\" href=\"#14-系统内核参数调优\">#</a> 1.4 系统内核参数调优</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 修改 /etc/sysctl.conf 文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span> /etc/sysctl.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>vm.max_map_count = 262144</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>vm.swappiness=1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.tcp_fin_timeout=2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>net.ipv4.tcp_tw_reuse=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#net.ipv4.tcp_tw_recycle=1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>net.ipv4.tcp_syncookies=1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>net.ipv4.tcp_keepalive_time=600</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>net.ipv4.ip_local_port_range=4000 65000</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.ipv4.tcp_max_syn_backlog=16384</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>net.ipv4.route.gc_timeout=100</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net.ipv4.tcp_max_tw_buckets= 5000</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_syn_retries=1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.ipv4.tcp_synack_retries=1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.core.somaxconn=16384</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.core.netdev_max_backlog=16384</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net.ipv4.tcp_max_orphans=16384</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre># 设置最大内存共享段大小bytes</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kernel.shmmax=15461882265</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kernel.shmall=3774873</pre></td></tr><tr><td data-num=\"25\"></td><td><pre># 修改消息队列长度</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kernel.msgmax=65535</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kernel.msgmnb=65535</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"15-修改默认限制内存\"><a class=\"anchor\" href=\"#15-修改默认限制内存\">#</a> 1.5 修改默认限制内存</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/systemd/system.conf<span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>DefaultLimitNOFILE=65536</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>DefaultLimitNPROC=32000</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>DefaultLimitMEMLOCK=infinity</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"16-执行命令生效状态\"><a class=\"anchor\" href=\"#16-执行命令生效状态\">#</a> 1.6 执行命令生效状态</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><h5 id=\"17-安装基础软件包\"><a class=\"anchor\" href=\"#17-安装基础软件包\">#</a> 1.7 安装基础软件包</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> <span class=\"token function\">unzip</span> net-tools telnet tree yum-utils device-mapper-persistent-data <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lvm2 <span class=\"token function\">git</span> ntpdate nfs-utils iotop httpd-tools dos2unix lrzsz <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><h5 id=\"18-升级系统\"><a class=\"anchor\" href=\"#18-升级系统\">#</a> 1.8 升级系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum update <span class=\"token parameter variable\">-y</span> <span class=\"token parameter variable\">--exclude</span><span class=\"token operator\">=</span>kernel* <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">reboot</span></pre></td></tr></table></figure><h4 id=\"2-redis-cluster部署\"><a class=\"anchor\" href=\"#2-redis-cluster部署\">#</a> 2、Redis cluster 部署</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:center\">192.168.1.135</th>\n<th style=\"text-align:center\">192.168.1.136</th>\n<th style=\"text-align:center\">192.168.1.137</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:center\">node1：7001</td>\n<td style=\"text-align:center\">node1：7001</td>\n<td style=\"text-align:center\">node1：7001</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">node2：7002</td>\n<td style=\"text-align:center\">node2：7002</td>\n<td style=\"text-align:center\">node2：7002</td>\n</tr>\n<tr>\n<td style=\"text-align:center\">node3：7003</td>\n<td style=\"text-align:center\">node3：7003</td>\n<td style=\"text-align:center\">node3：7003</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"21-安装包下载\"><a class=\"anchor\" href=\"#21-安装包下载\">#</a> 2.1 安装包下载</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> https://download.redis.io/releases/redis-7.2.1.tar.gz</pre></td></tr></table></figure><h5 id=\"22-安装-redis\"><a class=\"anchor\" href=\"#22-安装-redis\">#</a> 2.2 安装 redis</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> gcc-c++ <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> /soft</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-xzvf</span> redis-7.2.1.tar.gz <span class=\"token parameter variable\">-C</span> /soft</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /soft/redis-7.2.1 /soft/redis</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /soft/redis</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">make</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token function\">make</span> <span class=\"token function\">install</span> <span class=\"token assign-left variable\">prefix</span><span class=\"token operator\">=</span>/soft/redis</pre></td></tr></table></figure><h5 id=\"23-生成集群配置文件\"><a class=\"anchor\" href=\"#23-生成集群配置文件\">#</a> 2.3 生成集群配置文件</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /soft/redis/data/7001</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /soft/redis/data/7002</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /soft/redis/data/7003</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /soft/redis/log</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /soft/redis</pre></td></tr></table></figure><p><strong>redis_7001.conf 配置文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /soft/redis/redis_7001.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>protected-mode yes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port 7001</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>requirepass admin123</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>masterauth admin123</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cluster-enabled yes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cluster-config-file nodes-7001.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cluster-node-timeout 5000</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>maxmemory 2GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>maxmemory-policy volatile-lru</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp-backlog 511</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>timeout 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp-keepalive 300</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>daemonize yes</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pidfile /soft/redis/data/redis7001.pid</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>loglevel notice</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>logfile \"/soft/redis/log/redis7001.log\"</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>#databases 16</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>always-show-logo no</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>set-proc-title yes</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proc-title-template \"&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;\"</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>locale-collate \"\"</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>stop-writes-on-bgsave-error yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rdbcompression yes</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rdbchecksum yes</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>dbfilename dump.rdb</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rdb-del-sync-files no</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>dir /soft/redis/data/7001</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>replica-serve-stale-data yes</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>replica-read-only yes</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>repl-diskless-sync yes</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>repl-diskless-sync-delay 5</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>repl-diskless-sync-max-replicas 0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>repl-diskless-load disabled</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>repl-disable-tcp-nodelay no</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>replica-priority 100</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>acllog-max-len 128</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>lazyfree-lazy-eviction no</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>lazyfree-lazy-expire no</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>lazyfree-lazy-server-del no</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>replica-lazy-flush no</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>lazyfree-lazy-user-del no</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>lazyfree-lazy-user-flush no</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>oom-score-adj no</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>oom-score-adj-values 0 200 800</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>disable-thp yes</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>appendonly no</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>appendfilename \"appendonly.aof\"</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>appenddirname \"appendonlydir\"</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>appendfsync everysec</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>no-appendfsync-on-rewrite no</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>auto-aof-rewrite-percentage 100</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>auto-aof-rewrite-min-size 64mb</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>aof-load-truncated yes</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>aof-use-rdb-preamble yes</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>aof-timestamp-enabled no</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>slowlog-log-slower-than 10000</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>slowlog-max-len 128</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>latency-monitor-threshold 0</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>notify-keyspace-events \"\"</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>hash-max-listpack-entries 512</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>hash-max-listpack-value 64</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>list-max-listpack-size -2</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>list-compress-depth 0</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>set-max-intset-entries 512</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>set-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>set-max-listpack-value 64</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>zset-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>zset-max-listpack-value 64</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>hll-sparse-max-bytes 3000</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>stream-node-max-bytes 4096</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>stream-node-max-entries 100</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>activerehashing yes</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>client-output-buffer-limit normal 0 0 0</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>client-output-buffer-limit replica 256mb 64mb 60</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>client-output-buffer-limit pubsub 32mb 8mb 60</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>hz 10</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>dynamic-hz yes</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>aof-rewrite-incremental-fsync yes</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>rdb-save-incremental-fsync yes</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>jemalloc-bg-thread yes</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><strong>redis_7002.conf 配置文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /soft/redis/redis_7002.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>protected-mode yes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port 7002</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>requirepass admin123</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>masterauth admin123</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cluster-enabled yes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cluster-config-file nodes-7002.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cluster-node-timeout 5000</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>maxmemory 2GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>maxmemory-policy  volatile-lru</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp-backlog 511</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>timeout 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp-keepalive 300</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>daemonize yes</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pidfile /soft/redis/data/redis7002.pid</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>loglevel notice</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>logfile \"/soft/redis/log/redis7002.log\"</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>#databases 16</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>always-show-logo no</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>set-proc-title yes</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proc-title-template \"&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;\"</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>locale-collate \"\"</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>stop-writes-on-bgsave-error yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rdbcompression yes</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rdbchecksum yes</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>dbfilename dump.rdb</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rdb-del-sync-files no</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>dir /soft/redis/data/7002</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>replica-serve-stale-data yes</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>replica-read-only yes</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>repl-diskless-sync yes</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>repl-diskless-sync-delay 5</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>repl-diskless-sync-max-replicas 0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>repl-diskless-load disabled</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>repl-disable-tcp-nodelay no</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>replica-priority 100</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>acllog-max-len 128</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>lazyfree-lazy-eviction no</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>lazyfree-lazy-expire no</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>lazyfree-lazy-server-del no</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>replica-lazy-flush no</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>lazyfree-lazy-user-del no</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>lazyfree-lazy-user-flush no</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>oom-score-adj no</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>oom-score-adj-values 0 200 800</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>disable-thp yes</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>appendonly no</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>appendfilename \"appendonly.aof\"</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>appenddirname \"appendonlydir\"</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>appendfsync everysec</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>no-appendfsync-on-rewrite no</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>auto-aof-rewrite-percentage 100</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>auto-aof-rewrite-min-size 64mb</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>aof-load-truncated yes</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>aof-use-rdb-preamble yes</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>aof-timestamp-enabled no</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>slowlog-log-slower-than 10000</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>slowlog-max-len 128</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>latency-monitor-threshold 0</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>notify-keyspace-events \"\"</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>hash-max-listpack-entries 512</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>hash-max-listpack-value 64</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>list-max-listpack-size -2</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>list-compress-depth 0</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>set-max-intset-entries 512</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>set-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>set-max-listpack-value 64</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>zset-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>zset-max-listpack-value 64</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>hll-sparse-max-bytes 3000</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>stream-node-max-bytes 4096</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>stream-node-max-entries 100</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>activerehashing yes</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>client-output-buffer-limit normal 0 0 0</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>client-output-buffer-limit replica 256mb 64mb 60</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>client-output-buffer-limit pubsub 32mb 8mb 60</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>hz 10</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>dynamic-hz yes</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>aof-rewrite-incremental-fsync yes</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>rdb-save-incremental-fsync yes</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>jemalloc-bg-thread yes</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><strong>redis_7003.conf 配置文件</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">></span> /soft/redis/redis_7003.conf <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>protected-mode yes</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port 7003</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>requirepass admin123</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>masterauth admin123</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cluster-enabled yes</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cluster-config-file nodes-7003.conf</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cluster-node-timeout 5000</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>maxmemory 2GB</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>maxmemory-policy  volatile-lru</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp-backlog 511</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>timeout 0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp-keepalive 300</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>daemonize yes</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>pidfile /soft/redis/data/redis7003.pid</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>loglevel notice</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>logfile \"/soft/redis/log/redis7003.log\"</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>#databases 16</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>always-show-logo no</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>set-proc-title yes</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>proc-title-template \"&#123;title&#125; &#123;listen-addr&#125; &#123;server-mode&#125;\"</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>locale-collate \"\"</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>stop-writes-on-bgsave-error yes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rdbcompression yes</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rdbchecksum yes</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>dbfilename dump.rdb</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rdb-del-sync-files no</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>dir /soft/redis/data/7003</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>replica-serve-stale-data yes</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>replica-read-only yes</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>repl-diskless-sync yes</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>repl-diskless-sync-delay 5</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>repl-diskless-sync-max-replicas 0</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>repl-diskless-load disabled</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>repl-disable-tcp-nodelay no</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>replica-priority 100</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>acllog-max-len 128</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>lazyfree-lazy-eviction no</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>lazyfree-lazy-expire no</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>lazyfree-lazy-server-del no</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>replica-lazy-flush no</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>lazyfree-lazy-user-del no</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>lazyfree-lazy-user-flush no</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>oom-score-adj no</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>oom-score-adj-values 0 200 800</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>disable-thp yes</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>appendonly no</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>appendfilename \"appendonly.aof\"</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>appenddirname \"appendonlydir\"</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>appendfsync everysec</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>no-appendfsync-on-rewrite no</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>auto-aof-rewrite-percentage 100</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>auto-aof-rewrite-min-size 64mb</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>aof-load-truncated yes</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>aof-use-rdb-preamble yes</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>aof-timestamp-enabled no</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>slowlog-log-slower-than 10000</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>slowlog-max-len 128</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>latency-monitor-threshold 0</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>notify-keyspace-events \"\"</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>hash-max-listpack-entries 512</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>hash-max-listpack-value 64</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>list-max-listpack-size -2</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>list-compress-depth 0</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>set-max-intset-entries 512</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>set-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>set-max-listpack-value 64</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>zset-max-listpack-entries 128</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>zset-max-listpack-value 64</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>hll-sparse-max-bytes 3000</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>stream-node-max-bytes 4096</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>stream-node-max-entries 100</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>activerehashing yes</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>client-output-buffer-limit normal 0 0 0</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>client-output-buffer-limit replica 256mb 64mb 60</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>client-output-buffer-limit pubsub 32mb 8mb 60</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>hz 10</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>dynamic-hz yes</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>aof-rewrite-incremental-fsync yes</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>rdb-save-incremental-fsync yes</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>jemalloc-bg-thread yes</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>EOF</span></pre></td></tr></table></figure><h5 id=\"24-redis开机自启\"><a class=\"anchor\" href=\"#24-redis开机自启\">#</a> 2.4 Redis 开机自启</h5>\n<p><strong>redis_7001.service</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"EOF\"<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /usr/lib/systemd/system/redis_7001.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[Unit]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Description=Redis 7001 service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Documentation=https://redis.io/documentation</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Wants=network-online.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>After=network-online.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[Service]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Type=forking</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>LimitNOFILE=10032</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>User=root</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Group=root</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ExecStart=/soft/redis/src/redis-server /soft/redis/redis_7001.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PrivateTmp=true</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>[Install]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>WantedBy=multi-user.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><strong>redis_7002.service</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"EOF\"<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /usr/lib/systemd/system/redis_7002.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[Unit]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Description=Redis 7002 service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Documentation=https://redis.io/documentation</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Wants=network-online.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>After=network-online.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[Service]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Type=forking</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>LimitNOFILE=10032</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>User=root</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Group=root</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ExecStart=/soft/redis/src/redis-server /soft/redis/redis_7002.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PrivateTmp=true</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>[Install]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>WantedBy=multi-user.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><strong>redis_7003.service</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token string\">\"EOF\"<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /usr/lib/systemd/system/redis_7003.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[Unit]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Description=Redis 7003 service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Documentation=https://redis.io/documentation</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Wants=network-online.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>After=network-online.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>[Service]</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Type=forking</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>LimitNOFILE=10032</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>User=root</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Group=root</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ExecStart=/soft/redis/src/redis-server /soft/redis/redis_7003.conf</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>PrivateTmp=true</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>[Install]</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>WantedBy=multi-user.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><strong>设置开机自启</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chown</span> <span class=\"token parameter variable\">-R</span> root.root /soft/redis</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> redis_7001.service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> redis_7002.service</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> redis_7003.service</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl start redis_7001.service</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>systemctl start redis_7002.service</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>systemctl start redis_7003.service</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>systemctl status redis_7001.service</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>systemctl status redis_7002.service</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>systemctl status redis_7003.service</pre></td></tr></table></figure><h5 id=\"25-启动redis集群服务\"><a class=\"anchor\" href=\"#25-启动redis集群服务\">#</a> 2.5 启动 redis 集群服务</h5>\n<p>--cluster-replicas 2 表示为集群中的每个主节点创建 2 个从节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /soft/redis/src</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./redis-cli <span class=\"token parameter variable\">--cluster</span> create <span class=\"token punctuation\">\\</span>  </pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.1.135:7001 <span class=\"token number\">192.168</span>.1.135:7002 <span class=\"token number\">192.168</span>.1.135:7003 <span class=\"token punctuation\">\\</span>  </pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.136:7001 <span class=\"token number\">192.168</span>.1.136:7002 <span class=\"token number\">192.168</span>.1.136:7003 <span class=\"token punctuation\">\\</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.137:7001 <span class=\"token number\">192.168</span>.1.137:7002 <span class=\"token number\">192.168</span>.1.137:7003 <span class=\"token punctuation\">\\</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>--cluster-replicas <span class=\"token number\">2</span> <span class=\"token parameter variable\">-a</span> admin123</pre></td></tr></table></figure><p>输入创建集群的命令后会出现以下提示，注意 Can I set the above configuration? (type 'yes' to accept): yes，该处请输入 yes</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@qnyp_node01 src<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./redis-cli --cluster create \\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.135:7001 <span class=\"token number\">192.168</span>.1.135:7002 <span class=\"token number\">192.168</span>.1.135:7003 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.136:7001 <span class=\"token number\">192.168</span>.1.136:7002 <span class=\"token number\">192.168</span>.1.136:7003 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">></span> <span class=\"token number\">192.168</span>.1.137:7001 <span class=\"token number\">192.168</span>.1.137:7002 <span class=\"token number\">192.168</span>.1.137:7003 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">></span> --cluster-replicas <span class=\"token number\">2</span> <span class=\"token parameter variable\">-a</span> admin123</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Warning: Using a password with <span class=\"token string\">'-a'</span> or <span class=\"token string\">'-u'</span> option on the <span class=\"token builtin class-name\">command</span> line interface may not be safe.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Performing <span class=\"token builtin class-name\">hash</span> slots allocation on <span class=\"token number\">9</span> nodes<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>Master<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span> -<span class=\"token operator\">></span> Slots <span class=\"token number\">0</span> - <span class=\"token number\">5460</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Master<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> -<span class=\"token operator\">></span> Slots <span class=\"token number\">5461</span> - <span class=\"token number\">10922</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Master<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span> -<span class=\"token operator\">></span> Slots <span class=\"token number\">10923</span> - <span class=\"token number\">16383</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.136:7002 to <span class=\"token number\">192.168</span>.1.135:7001</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.137:7002 to <span class=\"token number\">192.168</span>.1.135:7001</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.135:7003 to <span class=\"token number\">192.168</span>.1.136:7001</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.137:7003 to <span class=\"token number\">192.168</span>.1.136:7001</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.136:7003 to <span class=\"token number\">192.168</span>.1.137:7001</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>Adding replica <span class=\"token number\">192.168</span>.1.135:7002 to <span class=\"token number\">192.168</span>.1.137:7001</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>M: 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7 <span class=\"token number\">192.168</span>.1.135:7001</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-5460<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5461</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>S: 4508bee0c33784e0d5be25b64e4c7e677cd9d396 <span class=\"token number\">192.168</span>.1.135:7002</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>   replicates f9133541e2175958117753ef4e206ea43a21f07c</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>S: a0e13083fcc1d6e96398f3bb2ea5581b7a64e05e <span class=\"token number\">192.168</span>.1.135:7003</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   replicates 06ea827f8d328d9d776c9643109317b0100727a6</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>M: 06ea827f8d328d9d776c9643109317b0100727a6 <span class=\"token number\">192.168</span>.1.136:7001</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">5461</span>-10922<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5462</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>S: 1d1b9817e39ee8987a3518f62a9b91c3ab666eff <span class=\"token number\">192.168</span>.1.136:7002</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>   replicates 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>S: a73c099dcc63f5d46a11d0f61c91270ef61290ff <span class=\"token number\">192.168</span>.1.136:7003</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   replicates f9133541e2175958117753ef4e206ea43a21f07c</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>M: f9133541e2175958117753ef4e206ea43a21f07c <span class=\"token number\">192.168</span>.1.137:7001</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">10923</span>-16383<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5461</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>S: 626dc659bb1059ec40039869241f7de88a49cd87 <span class=\"token number\">192.168</span>.1.137:7002</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>   replicates 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>S: 622f73cd06c5658f8d02056925ac708750f12c1a <span class=\"token number\">192.168</span>.1.137:7003</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   replicates 06ea827f8d328d9d776c9643109317b0100727a6</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>Can I <span class=\"token builtin class-name\">set</span> the above configuration? <span class=\"token punctuation\">(</span>type <span class=\"token string\">'yes'</span> to accept<span class=\"token punctuation\">)</span>:</pre></td></tr></table></figure><p>输完 yes 后，会出现如下提示，[OK] All 16384 slots covered. 说明成功啦</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Can I <span class=\"token builtin class-name\">set</span> the above configuration? <span class=\"token punctuation\">(</span>type <span class=\"token string\">'yes'</span> to accept<span class=\"token punctuation\">)</span>: <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Nodes configuration updated</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Assign a different config epoch to each <span class=\"token function\">node</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Sending CLUSTER MEET messages to <span class=\"token function\">join</span> the cluster</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Waiting <span class=\"token keyword\">for</span> the cluster to <span class=\"token function\">join</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Performing Cluster Check <span class=\"token punctuation\">(</span>using <span class=\"token function\">node</span> <span class=\"token number\">192.168</span>.1.135:7001<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>M: 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7 <span class=\"token number\">192.168</span>.1.135:7001</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">0</span>-5460<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5461</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token number\">2</span> additional replica<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>M: 06ea827f8d328d9d776c9643109317b0100727a6 <span class=\"token number\">192.168</span>.1.136:7001</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">5461</span>-10922<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5462</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   <span class=\"token number\">2</span> additional replica<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>S: 622f73cd06c5658f8d02056925ac708750f12c1a <span class=\"token number\">192.168</span>.1.137:7003</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>   replicates 06ea827f8d328d9d776c9643109317b0100727a6</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>S: 1d1b9817e39ee8987a3518f62a9b91c3ab666eff <span class=\"token number\">192.168</span>.1.136:7002</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>   replicates 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>S: a73c099dcc63f5d46a11d0f61c91270ef61290ff <span class=\"token number\">192.168</span>.1.136:7003</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>   replicates f9133541e2175958117753ef4e206ea43a21f07c</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>S: a0e13083fcc1d6e96398f3bb2ea5581b7a64e05e <span class=\"token number\">192.168</span>.1.135:7003</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>   replicates 06ea827f8d328d9d776c9643109317b0100727a6</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>M: f9133541e2175958117753ef4e206ea43a21f07c <span class=\"token number\">192.168</span>.1.137:7001</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>   slots:<span class=\"token punctuation\">[</span><span class=\"token number\">10923</span>-16383<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">5461</span> slots<span class=\"token punctuation\">)</span> master</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>   <span class=\"token number\">2</span> additional replica<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>S: 626dc659bb1059ec40039869241f7de88a49cd87 <span class=\"token number\">192.168</span>.1.137:7002</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>   replicates 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>S: 4508bee0c33784e0d5be25b64e4c7e677cd9d396 <span class=\"token number\">192.168</span>.1.135:7002</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>   slots: <span class=\"token punctuation\">(</span><span class=\"token number\">0</span> slots<span class=\"token punctuation\">)</span> slave</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>   replicates f9133541e2175958117753ef4e206ea43a21f07c</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>OK<span class=\"token punctuation\">]</span> All nodes agree about slots configuration.</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Check <span class=\"token keyword\">for</span> <span class=\"token function\">open</span> slots<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token operator\">>></span><span class=\"token operator\">></span> Check slots coverage<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>OK<span class=\"token punctuation\">]</span> All <span class=\"token number\">16384</span> slots covered.</pre></td></tr></table></figure><h5 id=\"26-访问reids集群并验证\"><a class=\"anchor\" href=\"#26-访问reids集群并验证\">#</a> 2.6 访问 reids 集群并验证</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /data/redis/src</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>./redis-cli <span class=\"token parameter variable\">-h</span> <span class=\"token number\">192.168</span>.1.135 <span class=\"token parameter variable\">-p</span> <span class=\"token number\">7001</span> <span class=\"token parameter variable\">-c</span> <span class=\"token parameter variable\">-a</span> admin123</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#列出当前节点的信息：cluster info</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Warning: Using a password with <span class=\"token string\">'-a'</span> or <span class=\"token string\">'-u'</span> option on the <span class=\"token builtin class-name\">command</span> line interface may not be safe.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.135:700<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> cluster info</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>cluster_state:ok</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cluster_slots_assigned:16384</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>cluster_slots_ok:16384</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>cluster_slots_pfail:0</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>cluster_slots_fail:0</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>cluster_known_nodes:9</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>cluster_size:3</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cluster_current_epoch:9</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>cluster_my_epoch:1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>cluster_stats_messages_ping_sent:344</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>cluster_stats_messages_pong_sent:354</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>cluster_stats_messages_sent:698</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>cluster_stats_messages_ping_received:346</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>cluster_stats_messages_pong_received:344</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>cluster_stats_messages_meet_received:8</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>cluster_stats_messages_received:698</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>total_cluster_links_buffer_limit_exceeded:0</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>列出集群的节点的信息：cluster nodes</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">192.168</span>.1.135:700<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>></span> cluster nodes</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>06ea827f8d328d9d776c9643109317b0100727a6 <span class=\"token number\">192.168</span>.1.136:7001@17001 master - <span class=\"token number\">0</span> <span class=\"token number\">1747034145581</span> <span class=\"token number\">4</span> connected <span class=\"token number\">5461</span>-10922</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>622f73cd06c5658f8d02056925ac708750f12c1a <span class=\"token number\">192.168</span>.1.137:7003@17003 slave 06ea827f8d328d9d776c9643109317b0100727a6 <span class=\"token number\">0</span> <span class=\"token number\">1747034145581</span> <span class=\"token number\">4</span> connected</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>1d1b9817e39ee8987a3518f62a9b91c3ab666eff <span class=\"token number\">192.168</span>.1.136:7002@17002 slave 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7 <span class=\"token number\">0</span> <span class=\"token number\">1747034145581</span> <span class=\"token number\">1</span> connected</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>a73c099dcc63f5d46a11d0f61c91270ef61290ff <span class=\"token number\">192.168</span>.1.136:7003@17003 slave f9133541e2175958117753ef4e206ea43a21f07c <span class=\"token number\">0</span> <span class=\"token number\">1747034145581</span> <span class=\"token number\">7</span> connected</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>a0e13083fcc1d6e96398f3bb2ea5581b7a64e05e <span class=\"token number\">192.168</span>.1.135:7003@17003 slave 06ea827f8d328d9d776c9643109317b0100727a6 <span class=\"token number\">0</span> <span class=\"token number\">1747034144077</span> <span class=\"token number\">4</span> connected</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>f9133541e2175958117753ef4e206ea43a21f07c <span class=\"token number\">192.168</span>.1.137:7001@17001 master - <span class=\"token number\">0</span> <span class=\"token number\">1747034145079</span> <span class=\"token number\">7</span> connected <span class=\"token number\">10923</span>-16383</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>626dc659bb1059ec40039869241f7de88a49cd87 <span class=\"token number\">192.168</span>.1.137:7002@17002 slave 928637d72deb6a2e7935f8a7bb5ebd9455cf64a7 <span class=\"token number\">0</span> <span class=\"token number\">1747034144000</span> <span class=\"token number\">1</span> connected</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>928637d72deb6a2e7935f8a7bb5ebd9455cf64a7 <span class=\"token number\">192.168</span>.1.135:7001@17001 myself,master - <span class=\"token number\">0</span> <span class=\"token number\">1747034144000</span> <span class=\"token number\">1</span> connected <span class=\"token number\">0</span>-5460</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>4508bee0c33784e0d5be25b64e4c7e677cd9d396 <span class=\"token number\">192.168</span>.1.135:7002@17002 slave f9133541e2175958117753ef4e206ea43a21f07c <span class=\"token number\">0</span> <span class=\"token number\">1747034144578</span> <span class=\"token number\">7</span> connected</pre></td></tr></table></figure>",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/170573601.html",
            "url": "http://ixuyong.cn/posts/170573601.html",
            "title": "K8s服务发布Ingress",
            "date_published": "2025-04-26T08:52:06.000Z",
            "content_html": "<h4 id=\"1-ingress-nginx-controller-安装\"><a class=\"anchor\" href=\"#1-ingress-nginx-controller-安装\">#</a> 1. Ingress Nginx Controller 安装</h4>\n<table>\n<thead>\n<tr>\n<th>Supported</th>\n<th>Ingress-NGINX version</th>\n<th>k8s supported version</th>\n<th>Alpine Version</th>\n<th>Nginx Version</th>\n<th>Helm Chart Version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.1</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.21.3</td>\n<td>1.25.5</td>\n<td>4.12.1</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.0</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.12.0</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.12.0-beta.0</strong></td>\n<td>1.32, 1.31, 1.30, 1.29, 1.28</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.12.0-beta.0</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.5</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.3</td>\n<td>1.25.5</td>\n<td>4.11.5</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.4</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.11.4</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.3</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.11.3</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.2</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.2</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.1</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.1</td>\n</tr>\n<tr>\n<td>🔄</td>\n<td><strong>v1.11.0</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.11.0</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.6</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.21.0</td>\n<td>1.25.5</td>\n<td>4.10.6</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.5</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.3</td>\n<td>1.25.5</td>\n<td>4.10.5</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.4</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.4</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.3</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.3</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.2</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.20.0</td>\n<td>1.25.5</td>\n<td>4.10.2</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.1</strong></td>\n<td>1.30, 1.29, 1.28, 1.27, 1.26</td>\n<td>3.19.1</td>\n<td>1.25.3</td>\n<td>4.10.1</td>\n</tr>\n<tr>\n<td></td>\n<td><strong>v1.10.0</strong></td>\n<td>1.29, 1.28, 1.27, 1.26</td>\n<td>3.19.1</td>\n<td>1.25.3</td>\n<td>4.10.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.6</td>\n<td>1.29, 1.28, 1.27, 1.26, 1.25</td>\n<td>3.19.0</td>\n<td>1.21.6</td>\n<td>4.9.1</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.5</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.9.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.4</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.3</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.3</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.1</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.4</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.9.0</td>\n<td>1.28, 1.27, 1.26, 1.25</td>\n<td>3.18.2</td>\n<td>1.21.6</td>\n<td>4.8.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.8.4</td>\n<td>1.27, 1.26, 1.25, 1.24</td>\n<td>3.18.2</td>\n<td>1.21.6</td>\n<td>4.7.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.7.1</td>\n<td>1.27, 1.26, 1.25, 1.24</td>\n<td>3.17.2</td>\n<td>1.21.6</td>\n<td>4.6.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.6.4</td>\n<td>1.26, 1.25, 1.24, 1.23</td>\n<td>3.17.0</td>\n<td>1.21.6</td>\n<td>4.5.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.5.1</td>\n<td>1.25, 1.24, 1.23</td>\n<td>3.16.2</td>\n<td>1.21.6</td>\n<td>4.4.*</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.4.0</td>\n<td>1.25, 1.24, 1.23, 1.22</td>\n<td>3.16.2</td>\n<td>1.19.10†</td>\n<td>4.3.0</td>\n</tr>\n<tr>\n<td></td>\n<td>v1.3.1</td>\n<td>1.24, 1.23, 1.22, 1.21, 1.20</td>\n<td>3.16.2</td>\n<td>1.19.10†</td>\n<td>4.2.5</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"11-helm安装ingress-nginx-controller\"><a class=\"anchor\" href=\"#11-helm安装ingress-nginx-controller\">#</a> 1.1 Helm 安装 Ingress Nginx Controller</h5>\n<ol>\n<li>安装 Helm</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># wget https://get.helm.sh/helm-v3.6.3-linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># tar xf helm-v3.6.3-linux-amd64.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># mv linux-amd64/helm /usr/local/bin/helm</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm version</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>下载 Ingress Nginx Controller 安装包</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>官方文档：https://github.com/kubernetes/ingress-nginx/tree/helm-chart-4.8.2         <span class=\"token comment\">#根据自己 k8s 版本下载</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># helm repo update</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm repo list</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># helm pull ingress-nginx/ingress-nginx --version 4.8.2</span></pre></td></tr></table></figure><ol start=\"3\">\n<li>配置 Ingress Nginx Controller</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># tar xf ingress-nginx-4.8.2.tgz</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cd ingress-nginx</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># vim values.yaml</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token number\">16</span> controller:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> <span class=\"token number\">17</span>   name: controller</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token number\">18</span>   enableAnnotationValidations: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token number\">19</span>   image:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre> <span class=\"token number\">20</span>     <span class=\"token comment\">## Keep false as default for now!</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre> <span class=\"token number\">21</span>     chroot: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> <span class=\"token number\">22</span>     registry: registry.cn-hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> <span class=\"token number\">23</span>     image: kubernetes_public/ingress-nginx-controller</pre></td></tr><tr><td data-num=\"13\"></td><td><pre> <span class=\"token number\">24</span>     <span class=\"token comment\">## for backwards compatibility consider setting the full image url via the repository value below</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre> <span class=\"token number\">25</span>     <span class=\"token comment\">## use *either* current default registry/image or repository format or installing chart by providing the values.yaml wil    l fail</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre> <span class=\"token number\">26</span>     <span class=\"token comment\">## repository:</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre> <span class=\"token number\">27</span>     tag: <span class=\"token string\">\"v1.9.3\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> <span class=\"token number\">28</span>     <span class=\"token comment\">#digest: sha256:8fd21d59428507671ce0fb47f818b1d859c92d2ad07bb7c947268d433030ba98</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre> <span class=\"token number\">42</span>   <span class=\"token comment\"># -- Will add custom configuration options to Nginx https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configurat    ion/configmap/</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre> <span class=\"token number\">43</span>   config:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre> <span class=\"token number\">44</span>     allow-snippet-annotations: <span class=\"token boolean\">true</span>          <span class=\"token comment\">#开启 server snippet 的配置</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"23\"></td><td><pre> <span class=\"token number\">67</span>   dnsPolicy: ClusterFirstWithHostNet</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"25\"></td><td><pre> <span class=\"token number\">88</span>   hostNetwork: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token number\">107</span>   ingressClassResource:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token number\">108</span>     <span class=\"token comment\"># -- Name of the ingressClass</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token number\">109</span>     name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token number\">110</span>     <span class=\"token comment\"># -- Is this ingressClass enabled or not</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token number\">111</span>     enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token number\">112</span>     <span class=\"token comment\"># -- Is this the default ingressClass for the cluster</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">113</span>     default: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">184</span>   kind: DaemonSet</pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token number\">287</span>   nodeSelector:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token number\">288</span>     kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token number\">289</span>     ingress: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token number\">638</span>       image:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token number\">639</span>         registry: registry.cn-hangzhou.aliyuncs.com</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token number\">640</span>         image: kubernetes_public/kube-webhook-certgen</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token number\">641</span>         <span class=\"token comment\">## for backwards compatibility consider setting the full image url via the repository value below</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token number\">642</span>         <span class=\"token comment\">## use *either* current default registry/image or repository format or installing chart by providing the values.yaml     will fail</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token number\">643</span>         <span class=\"token comment\">## repository:</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token number\">644</span>         tag: v20231011-8b53cabe0</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token number\">645</span>         <span class=\"token comment\">#digest: sha256:a7943503b45d552785aa3b5e457f169a5661fb94d82b8a3373bcd9ebaf9aac80</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>4. 给需要部署 ingress 的节点上打标签</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node02 ingress=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node01 ingress=true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl create ns ingress-nginx</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># helm install ingress-nginx -n ingress-nginx .     #安装</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># helm upgrade ingress-nginx -n ingress-nginx .     #更新</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl get pods -n ingress-nginx </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME                             READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ingress-nginx-controller-7nfqn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          27s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ingress-nginx-controller-k4p2n   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx-controller-kw5jk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24s</pre></td></tr></table></figure><h5 id=\"12-bare-metal安装ingress-nginx-controller\"><a class=\"anchor\" href=\"#12-bare-metal安装ingress-nginx-controller\">#</a> 1.2 Bare metal 安装 Ingress Nginx Controller</h5>\n<ol>\n<li>下载 Ingress 部署文件，链接地址：<a href=\"https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters\">https://kubernetes.github.io/ingress-nginx/deploy/#bare-metal-clusters</a></li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.1/deploy/static/provider/baremetal/deploy.yaml</span></pre></td></tr></table></figure><ol start=\"2\">\n<li>配置 Ingress</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Namespace</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>automountServiceAccountToken: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>automountServiceAccountToken: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  - ingresses/status</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  - ingressclasses</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  resourceNames:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - ingress-nginx-leader</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"109\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  - patch</pre></td></tr><tr><td data-num=\"117\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"118\"></td><td><pre>  - discovery.k8s.io</pre></td></tr><tr><td data-num=\"119\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"120\"></td><td><pre>  - endpointslices</pre></td></tr><tr><td data-num=\"121\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"122\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"123\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"124\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"125\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"126\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"127\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"128\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"129\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"130\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"131\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"132\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"133\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"134\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"135\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"136\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"137\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"138\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"139\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"140\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"141\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"142\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"143\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"144\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"145\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"146\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"147\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"148\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"149\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"150\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"151\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"152\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"153\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"154\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"155\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"156\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"157\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"158\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"159\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"160\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"161\"></td><td><pre>  - nodes</pre></td></tr><tr><td data-num=\"162\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"163\"></td><td><pre>  - secrets</pre></td></tr><tr><td data-num=\"164\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"165\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"166\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"167\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"168\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"169\"></td><td><pre>  - coordination.k8s.io</pre></td></tr><tr><td data-num=\"170\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"171\"></td><td><pre>  - leases</pre></td></tr><tr><td data-num=\"172\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"173\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"174\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"175\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"176\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"177\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"178\"></td><td><pre>  - nodes</pre></td></tr><tr><td data-num=\"179\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"180\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"181\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"182\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"183\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"184\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"185\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"186\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"187\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"188\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"189\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"190\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"191\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"192\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"193\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"194\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"195\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"196\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"197\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"198\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"199\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"200\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"201\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"202\"></td><td><pre>  - create</pre></td></tr><tr><td data-num=\"203\"></td><td><pre>  - patch</pre></td></tr><tr><td data-num=\"204\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"205\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"206\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"207\"></td><td><pre>  - ingresses/status</pre></td></tr><tr><td data-num=\"208\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"209\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"210\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"211\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"212\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"213\"></td><td><pre>  - ingressclasses</pre></td></tr><tr><td data-num=\"214\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"215\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"216\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"217\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"218\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"219\"></td><td><pre>  - discovery.k8s.io</pre></td></tr><tr><td data-num=\"220\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"221\"></td><td><pre>  - endpointslices</pre></td></tr><tr><td data-num=\"222\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"223\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"224\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"225\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"226\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"227\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"228\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"229\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"230\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"231\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"232\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"233\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"234\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"235\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"236\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"237\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"238\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"239\"></td><td><pre>  - admissionregistration.k8s.io</pre></td></tr><tr><td data-num=\"240\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"241\"></td><td><pre>  - validatingwebhookconfigurations</pre></td></tr><tr><td data-num=\"242\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"243\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"244\"></td><td><pre>  - update</pre></td></tr><tr><td data-num=\"245\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"246\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"247\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"248\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"249\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"250\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"251\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"252\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"253\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"254\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"255\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"256\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"257\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"258\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"259\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"260\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"261\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"262\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"263\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"264\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"265\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"266\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"267\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"268\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"269\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"270\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"271\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"272\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"273\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"274\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"275\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"276\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"277\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"278\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"279\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"280\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"281\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"282\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"283\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"284\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"285\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"286\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"287\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"288\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"289\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"290\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"291\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"292\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"293\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"294\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"295\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"296\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"297\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"298\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"299\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"300\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"301\"></td><td><pre>  name: ingress-nginx</pre></td></tr><tr><td data-num=\"302\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"303\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"304\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"305\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"306\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"307\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"308\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"309\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"310\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"311\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"312\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"313\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"314\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"315\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"316\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"317\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"318\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"319\"></td><td><pre>- kind: ServiceAccount</pre></td></tr><tr><td data-num=\"320\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"321\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"322\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"323\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"324\"></td><td><pre>data: null</pre></td></tr><tr><td data-num=\"325\"></td><td><pre>kind: ConfigMap</pre></td></tr><tr><td data-num=\"326\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"327\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"328\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"329\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"330\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"331\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"332\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"333\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"334\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"335\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"336\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"337\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"338\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"339\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"340\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"341\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"342\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"343\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"344\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"345\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"346\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"347\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"348\"></td><td><pre>  ipFamilies:</pre></td></tr><tr><td data-num=\"349\"></td><td><pre>  - IPv4</pre></td></tr><tr><td data-num=\"350\"></td><td><pre>  ipFamilyPolicy: SingleStack</pre></td></tr><tr><td data-num=\"351\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"352\"></td><td><pre>  - appProtocol: http</pre></td></tr><tr><td data-num=\"353\"></td><td><pre>    name: http</pre></td></tr><tr><td data-num=\"354\"></td><td><pre>    port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"355\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"356\"></td><td><pre>    targetPort: http</pre></td></tr><tr><td data-num=\"357\"></td><td><pre>  - appProtocol: https</pre></td></tr><tr><td data-num=\"358\"></td><td><pre>    name: https</pre></td></tr><tr><td data-num=\"359\"></td><td><pre>    port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"360\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"361\"></td><td><pre>    targetPort: https</pre></td></tr><tr><td data-num=\"362\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"363\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"364\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"365\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"366\"></td><td><pre>  <span class=\"token comment\">#type: NodePort</span></pre></td></tr><tr><td data-num=\"367\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"368\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"369\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"370\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"371\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"372\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"373\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"374\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"375\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"376\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"377\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"378\"></td><td><pre>  name: ingress-nginx-controller-admission</pre></td></tr><tr><td data-num=\"379\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"380\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"381\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"382\"></td><td><pre>  - appProtocol: https</pre></td></tr><tr><td data-num=\"383\"></td><td><pre>    name: https-webhook</pre></td></tr><tr><td data-num=\"384\"></td><td><pre>    port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"385\"></td><td><pre>    targetPort: webhook</pre></td></tr><tr><td data-num=\"386\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"387\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"388\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"389\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"390\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"391\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"392\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"393\"></td><td><pre><span class=\"token comment\">#kind: Deployment</span></pre></td></tr><tr><td data-num=\"394\"></td><td><pre>kind: DaemonSet</pre></td></tr><tr><td data-num=\"395\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"396\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"397\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"398\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"399\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"400\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"401\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"402\"></td><td><pre>  name: ingress-nginx-controller</pre></td></tr><tr><td data-num=\"403\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"404\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"405\"></td><td><pre>  minReadySeconds: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"406\"></td><td><pre>  revisionHistoryLimit: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"407\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"408\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"409\"></td><td><pre>      app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"410\"></td><td><pre>      app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"411\"></td><td><pre>      app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"412\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"413\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"414\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"415\"></td><td><pre>        app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"416\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"417\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"418\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"419\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"420\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"421\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"422\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"423\"></td><td><pre>        - /nginx-ingress-controller</pre></td></tr><tr><td data-num=\"424\"></td><td><pre>        - --election-id<span class=\"token operator\">=</span>ingress-nginx-leader</pre></td></tr><tr><td data-num=\"425\"></td><td><pre>        - --controller-class<span class=\"token operator\">=</span>k8s.io/ingress-nginx</pre></td></tr><tr><td data-num=\"426\"></td><td><pre>        - --ingress-class<span class=\"token operator\">=</span>nginx</pre></td></tr><tr><td data-num=\"427\"></td><td><pre>        - <span class=\"token parameter variable\">--configmap</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>/ingress-nginx-controller</pre></td></tr><tr><td data-num=\"428\"></td><td><pre>        - --validating-webhook<span class=\"token operator\">=</span>:8443</pre></td></tr><tr><td data-num=\"429\"></td><td><pre>        - --validating-webhook-certificate<span class=\"token operator\">=</span>/usr/local/certificates/cert</pre></td></tr><tr><td data-num=\"430\"></td><td><pre>        - --validating-webhook-key<span class=\"token operator\">=</span>/usr/local/certificates/key</pre></td></tr><tr><td data-num=\"431\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"432\"></td><td><pre>        - name: POD_NAME</pre></td></tr><tr><td data-num=\"433\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"434\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"435\"></td><td><pre>              fieldPath: metadata.name</pre></td></tr><tr><td data-num=\"436\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"437\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"438\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"439\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"440\"></td><td><pre>        - name: LD_PRELOAD</pre></td></tr><tr><td data-num=\"441\"></td><td><pre>          value: /usr/local/lib/libmimalloc.so</pre></td></tr><tr><td data-num=\"442\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/ingress-nginx-controller-v1.12.1:v1.12.1 </pre></td></tr><tr><td data-num=\"443\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"444\"></td><td><pre>        lifecycle:</pre></td></tr><tr><td data-num=\"445\"></td><td><pre>          preStop:</pre></td></tr><tr><td data-num=\"446\"></td><td><pre>            exec:</pre></td></tr><tr><td data-num=\"447\"></td><td><pre>              command:</pre></td></tr><tr><td data-num=\"448\"></td><td><pre>              - /wait-shutdown</pre></td></tr><tr><td data-num=\"449\"></td><td><pre>        livenessProbe:</pre></td></tr><tr><td data-num=\"450\"></td><td><pre>          failureThreshold: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"451\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"452\"></td><td><pre>            path: /healthz</pre></td></tr><tr><td data-num=\"453\"></td><td><pre>            port: <span class=\"token number\">10254</span></pre></td></tr><tr><td data-num=\"454\"></td><td><pre>            scheme: HTTP</pre></td></tr><tr><td data-num=\"455\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"456\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"457\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"458\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"459\"></td><td><pre>        name: controller</pre></td></tr><tr><td data-num=\"460\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"461\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"462\"></td><td><pre>          name: http</pre></td></tr><tr><td data-num=\"463\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"464\"></td><td><pre>        - containerPort: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"465\"></td><td><pre>          name: https</pre></td></tr><tr><td data-num=\"466\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"467\"></td><td><pre>        - containerPort: <span class=\"token number\">8443</span></pre></td></tr><tr><td data-num=\"468\"></td><td><pre>          name: webhook</pre></td></tr><tr><td data-num=\"469\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"470\"></td><td><pre>        readinessProbe:</pre></td></tr><tr><td data-num=\"471\"></td><td><pre>          failureThreshold: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"472\"></td><td><pre>          httpGet:</pre></td></tr><tr><td data-num=\"473\"></td><td><pre>            path: /healthz</pre></td></tr><tr><td data-num=\"474\"></td><td><pre>            port: <span class=\"token number\">10254</span></pre></td></tr><tr><td data-num=\"475\"></td><td><pre>            scheme: HTTP</pre></td></tr><tr><td data-num=\"476\"></td><td><pre>          initialDelaySeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"477\"></td><td><pre>          periodSeconds: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"478\"></td><td><pre>          successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"479\"></td><td><pre>          timeoutSeconds: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"480\"></td><td><pre>        resources:</pre></td></tr><tr><td data-num=\"481\"></td><td><pre>          requests:</pre></td></tr><tr><td data-num=\"482\"></td><td><pre>            cpu: 100m</pre></td></tr><tr><td data-num=\"483\"></td><td><pre>            memory: 90Mi</pre></td></tr><tr><td data-num=\"484\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"485\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"486\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"487\"></td><td><pre>            add:</pre></td></tr><tr><td data-num=\"488\"></td><td><pre>            - NET_BIND_SERVICE</pre></td></tr><tr><td data-num=\"489\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"490\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"491\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"492\"></td><td><pre>          runAsGroup: <span class=\"token number\">82</span></pre></td></tr><tr><td data-num=\"493\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"494\"></td><td><pre>          runAsUser: <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"495\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"496\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"497\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"498\"></td><td><pre>        - mountPath: /usr/local/certificates/</pre></td></tr><tr><td data-num=\"499\"></td><td><pre>          name: webhook-cert</pre></td></tr><tr><td data-num=\"500\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"501\"></td><td><pre>      hostNetwork: <span class=\"token boolean\">true</span>                         <span class=\"token comment\"># 与节点共享网络名称空间</span></pre></td></tr><tr><td data-num=\"502\"></td><td><pre>      <span class=\"token comment\">#dnsPolicy: ClusterFirst</span></pre></td></tr><tr><td data-num=\"503\"></td><td><pre>      dnsPolicy: ClusterFirstWithHostNet        <span class=\"token comment\"># dns 策略</span></pre></td></tr><tr><td data-num=\"504\"></td><td><pre>      nodeSelector:                             <span class=\"token comment\"># 节点选择器</span></pre></td></tr><tr><td data-num=\"505\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"506\"></td><td><pre>        ingress: <span class=\"token string\">\"true\"</span></pre></td></tr><tr><td data-num=\"507\"></td><td><pre>      serviceAccountName: ingress-nginx</pre></td></tr><tr><td data-num=\"508\"></td><td><pre>      terminationGracePeriodSeconds: <span class=\"token number\">300</span></pre></td></tr><tr><td data-num=\"509\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"510\"></td><td><pre>      - name: webhook-cert</pre></td></tr><tr><td data-num=\"511\"></td><td><pre>        secret:</pre></td></tr><tr><td data-num=\"512\"></td><td><pre>          secretName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"513\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"514\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"515\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"516\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"517\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"518\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"519\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"520\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"521\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"522\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"523\"></td><td><pre>  name: ingress-nginx-admission-create</pre></td></tr><tr><td data-num=\"524\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"525\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"526\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"527\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"528\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"529\"></td><td><pre>        app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"530\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"531\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"532\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"533\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"534\"></td><td><pre>      name: ingress-nginx-admission-create</pre></td></tr><tr><td data-num=\"535\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"536\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"537\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"538\"></td><td><pre>        - create</pre></td></tr><tr><td data-num=\"539\"></td><td><pre>        - <span class=\"token parameter variable\">--host</span><span class=\"token operator\">=</span>ingress-nginx-controller-admission,ingress-nginx-controller-admission.<span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span>.svc</pre></td></tr><tr><td data-num=\"540\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"541\"></td><td><pre>        - --secret-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"542\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"543\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"544\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"545\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"546\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"547\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kube-webhook-certgen-v1.5.2:v1.5.2 </pre></td></tr><tr><td data-num=\"548\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"549\"></td><td><pre>        name: create</pre></td></tr><tr><td data-num=\"550\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"551\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"552\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"553\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"554\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"555\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"556\"></td><td><pre>          runAsGroup: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"557\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"558\"></td><td><pre>          runAsUser: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"559\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"560\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"561\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"562\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"563\"></td><td><pre>      restartPolicy: OnFailure</pre></td></tr><tr><td data-num=\"564\"></td><td><pre>      serviceAccountName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"565\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"566\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"567\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"568\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"569\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"570\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"571\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"572\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"573\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"574\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"575\"></td><td><pre>  name: ingress-nginx-admission-patch</pre></td></tr><tr><td data-num=\"576\"></td><td><pre>  namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"577\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"578\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"579\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"580\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"581\"></td><td><pre>        app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"582\"></td><td><pre>        app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"583\"></td><td><pre>        app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"584\"></td><td><pre>        app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"585\"></td><td><pre>        app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"586\"></td><td><pre>      name: ingress-nginx-admission-patch</pre></td></tr><tr><td data-num=\"587\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"588\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"589\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"590\"></td><td><pre>        - patch</pre></td></tr><tr><td data-num=\"591\"></td><td><pre>        - --webhook-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"592\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>POD_NAMESPACE<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"593\"></td><td><pre>        - --patch-mutating<span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"594\"></td><td><pre>        - --secret-name<span class=\"token operator\">=</span>ingress-nginx-admission</pre></td></tr><tr><td data-num=\"595\"></td><td><pre>        - --patch-failure-policy<span class=\"token operator\">=</span>Fail</pre></td></tr><tr><td data-num=\"596\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"597\"></td><td><pre>        - name: POD_NAMESPACE</pre></td></tr><tr><td data-num=\"598\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"599\"></td><td><pre>            fieldRef:</pre></td></tr><tr><td data-num=\"600\"></td><td><pre>              fieldPath: metadata.namespace</pre></td></tr><tr><td data-num=\"601\"></td><td><pre>        image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/kube-webhook-certgen-v1.5.2:v1.5.2 </pre></td></tr><tr><td data-num=\"602\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"603\"></td><td><pre>        name: patch</pre></td></tr><tr><td data-num=\"604\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"605\"></td><td><pre>          allowPrivilegeEscalation: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"606\"></td><td><pre>          capabilities:</pre></td></tr><tr><td data-num=\"607\"></td><td><pre>            drop:</pre></td></tr><tr><td data-num=\"608\"></td><td><pre>            - ALL</pre></td></tr><tr><td data-num=\"609\"></td><td><pre>          readOnlyRootFilesystem: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"610\"></td><td><pre>          runAsGroup: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"611\"></td><td><pre>          runAsNonRoot: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"612\"></td><td><pre>          runAsUser: <span class=\"token number\">65532</span></pre></td></tr><tr><td data-num=\"613\"></td><td><pre>          seccompProfile:</pre></td></tr><tr><td data-num=\"614\"></td><td><pre>            type: RuntimeDefault</pre></td></tr><tr><td data-num=\"615\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"616\"></td><td><pre>        kubernetes.io/os: linux</pre></td></tr><tr><td data-num=\"617\"></td><td><pre>      restartPolicy: OnFailure</pre></td></tr><tr><td data-num=\"618\"></td><td><pre>      serviceAccountName: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"619\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"620\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"621\"></td><td><pre>kind: IngressClass</pre></td></tr><tr><td data-num=\"622\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"623\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"624\"></td><td><pre>    app.kubernetes.io/component: controller</pre></td></tr><tr><td data-num=\"625\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"626\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"627\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"628\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"629\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"630\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"631\"></td><td><pre>  controller: k8s.io/ingress-nginx</pre></td></tr><tr><td data-num=\"632\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"633\"></td><td><pre>apiVersion: admissionregistration.k8s.io/v1</pre></td></tr><tr><td data-num=\"634\"></td><td><pre>kind: ValidatingWebhookConfiguration</pre></td></tr><tr><td data-num=\"635\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"636\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"637\"></td><td><pre>    app.kubernetes.io/component: admission-webhook</pre></td></tr><tr><td data-num=\"638\"></td><td><pre>    app.kubernetes.io/instance: ingress-nginx</pre></td></tr><tr><td data-num=\"639\"></td><td><pre>    app.kubernetes.io/name: ingress-nginx</pre></td></tr><tr><td data-num=\"640\"></td><td><pre>    app.kubernetes.io/part-of: ingress-nginx</pre></td></tr><tr><td data-num=\"641\"></td><td><pre>    app.kubernetes.io/version: <span class=\"token number\">1.12</span>.1</pre></td></tr><tr><td data-num=\"642\"></td><td><pre>  name: ingress-nginx-admission</pre></td></tr><tr><td data-num=\"643\"></td><td><pre>webhooks:</pre></td></tr><tr><td data-num=\"644\"></td><td><pre>- admissionReviewVersions:</pre></td></tr><tr><td data-num=\"645\"></td><td><pre>  - v1</pre></td></tr><tr><td data-num=\"646\"></td><td><pre>  clientConfig:</pre></td></tr><tr><td data-num=\"647\"></td><td><pre>    service:</pre></td></tr><tr><td data-num=\"648\"></td><td><pre>      name: ingress-nginx-controller-admission</pre></td></tr><tr><td data-num=\"649\"></td><td><pre>      namespace: ingress-nginx</pre></td></tr><tr><td data-num=\"650\"></td><td><pre>      path: /networking/v1/ingresses</pre></td></tr><tr><td data-num=\"651\"></td><td><pre>      port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"652\"></td><td><pre>  failurePolicy: Fail</pre></td></tr><tr><td data-num=\"653\"></td><td><pre>  matchPolicy: Equivalent</pre></td></tr><tr><td data-num=\"654\"></td><td><pre>  name: validate.nginx.ingress.kubernetes.io</pre></td></tr><tr><td data-num=\"655\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"656\"></td><td><pre>  - apiGroups:</pre></td></tr><tr><td data-num=\"657\"></td><td><pre>    - networking.k8s.io</pre></td></tr><tr><td data-num=\"658\"></td><td><pre>    apiVersions:</pre></td></tr><tr><td data-num=\"659\"></td><td><pre>    - v1</pre></td></tr><tr><td data-num=\"660\"></td><td><pre>    operations:</pre></td></tr><tr><td data-num=\"661\"></td><td><pre>    - CREATE</pre></td></tr><tr><td data-num=\"662\"></td><td><pre>    - UPDATE</pre></td></tr><tr><td data-num=\"663\"></td><td><pre>    resources:</pre></td></tr><tr><td data-num=\"664\"></td><td><pre>    - ingresses</pre></td></tr><tr><td data-num=\"665\"></td><td><pre>  sideEffects: None</pre></td></tr></table></figure><ul>\n<li>type: ClusterIP                                              #service 类型改为 ClusterIP</li>\n<li>hostNetwork: true                                      # 与节点共享网络名称空间</li>\n<li>dnsPolicy: ClusterFirstWithHostNet        # dns 策略</li>\n<li>nodeSelector:                                             # 节点选择器</li>\n<li>kind: DaemonSet                                        # 资源类型 DaemonSet</li>\n</ul>\n<ol start=\"3\">\n<li>在指定节点部署 Ingress-Controller</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f deploy.yaml -n ingress-nginx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-node01 ingress=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-node02 ingress=true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label node k8s-master03 ingress-     #取消节点部署</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress-master<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n ingress-nginx </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME                                   READY   STATUS      RESTARTS   AGE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ingress-nginx-admission-create-zp6mh   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx-admission-patch-f2bpd    <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          12m</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ingress-nginx-controller-rgtkc         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          3m59s</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ingress-nginx-controller-trmn8         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>          3m59s</pre></td></tr></table></figure><h4 id=\"2-ingress-nginx-入门使用\"><a class=\"anchor\" href=\"#2-ingress-nginx-入门使用\">#</a> 2. Ingress Nginx 入门使用</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat web-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: web-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - host: test.hmallleasing.com</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"3-ingress-nginx-域名重定向-redirect\"><a class=\"anchor\" href=\"#3-ingress-nginx-域名重定向-redirect\">#</a> 3. Ingress Nginx 域名重定向 Redirect</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat redirect-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: redirect-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: redirect.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"4-ingress-nginx-前后端分离-rewrite\"><a class=\"anchor\" href=\"#4-ingress-nginx-前后端分离-rewrite\">#</a> 4. Ingress Nginx 前后端分离 Rewrite</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat rewrite-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rewrite-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/rewrite-target: /<span class=\"token variable\">$2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: rewrite.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /api<span class=\"token punctuation\">(</span>/<span class=\"token operator\">|</span>$<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>.*<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecif</pre></td></tr></table></figure><h4 id=\"5-ingress-nginx-错误代码重定向\"><a class=\"anchor\" href=\"#5-ingress-nginx-错误代码重定向\">#</a> 5. Ingress Nginx 错误代码重定向</h4>\n<pre><code>\n</code></pre>\n<h4 id=\"6-ingress-nginx-ssl\"><a class=\"anchor\" href=\"#6-ingress-nginx-ssl\">#</a> 6. Ingress Nginx SSL</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.生成证书</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.cert -subj \"/CN=s.hmallleasing.com/O=tls.hmallleasing.com\"</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.创建证书</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls tls.hmallleasig.com --key tls.key --cert tls.cert</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">3</span>.ingress配置</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls tls.hmallleasig.com --cert=tls.crt --key=tls.key</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># cat tls-ingress.yaml </span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  name: tls-ingress</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-redirect: <span class=\"token string\">\"false\"</span>    <span class=\"token comment\">#禁用 https 强制跳转</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - host: tls.hmallleasing.com</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  tls:                  <span class=\"token comment\">#https</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  - hosts:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    - tls.hmallleasing.com</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    secretName: <span class=\"token string\">\"tls.hmallleasig.com\"</span></pre></td></tr></table></figure><h4 id=\"7-ingress-nginx-匹配请求头\"><a class=\"anchor\" href=\"#7-ingress-nginx-匹配请求头\">#</a> 7. Ingress Nginx 匹配请求头</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.部署移动端应用</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create deploy phone --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:phone</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy phone --port 80</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># vim m-ingress.yaml</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: m-ingress</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: m.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: phone</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">2</span>.部署PC端应用\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># kubectl create deploy laptop --image=registry.cn-beijing.aliyuncs.com/dotbalo/nginx:laptop\t</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy laptop --port 80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># vim laptop-ingress.yaml</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    kubernetes.io/ingress.class: nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    nginx.ingress.kubernetes.io/server-snippet: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$agentflag</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$http_user_agent</span> ~* <span class=\"token string\">\"(Android|iPhone|Windows Phone|UC|Kindle)\"</span> <span class=\"token punctuation\">)</span><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              <span class=\"token builtin class-name\">set</span> <span class=\"token variable\">$agentflag</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span> <span class=\"token variable\">$agentflag</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              <span class=\"token builtin class-name\">return</span> <span class=\"token number\">301</span> http://m.hmallleaing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  name: laptop-ingress</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  - host: hmallleasing.com</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            name: laptop</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"8ingress-nginx-基本认证\"><a class=\"anchor\" href=\"#8ingress-nginx-基本认证\">#</a> 8.Ingress Nginx 基本认证</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install httpd -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># htpasswd -c auth superman</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># cat auth </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>superman:<span class=\"token variable\">$apr1</span><span class=\"token variable\">$AC1pc3dK</span><span class=\"token variable\">$RJyWnyDJFNKY6twneGVrA1</span>\t\t</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl create secret generic basic-auth --from-file=auth</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># cat basic-ingress.yaml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  name: basic-ingress</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-type: basic  <span class=\"token comment\"># 认证类型</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-secret: basic-auth  <span class=\"token comment\"># 包含用户和密码的 secret 资源名称</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    nginx.ingress.kubernetes.io/auth-realm: <span class=\"token string\">'Please User password'</span>  <span class=\"token comment\"># 要显示的信息</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - host: basic.hmallleasing.com</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr></table></figure><h4 id=\"9-ingress-nginx-黑白名单\"><a class=\"anchor\" href=\"#9-ingress-nginx-黑白名单\">#</a> 9. Ingress Nginx 黑 / 白名单</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>写法一：</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    nginx.ingress.kubernetes.io/whitelist-source-range: <span class=\"token string\">\"192.168.40.101\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific\t</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>写法二：\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    nginx.ingress.kubernetes.io/whitelist-source-range: <span class=\"token string\">\"192.168.40.0/24\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>写法三：</pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\"># cat white-ingress.yaml </span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  name: white-ingress</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    nginx.ingress.kubernetes.io/server-snippet: <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      allow <span class=\"token number\">192.168</span>.40.0/24<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>      deny all<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - host: white.hmallleasing.com</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">#Master01 测试\t\t</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:white.hmallleasing.com\" http://192.168.40.103 -I</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>HTTP/1.1 <span class=\"token number\">200</span> OK</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>Date: Sat, <span class=\"token number\">14</span> Oct <span class=\"token number\">2023</span> <span class=\"token number\">13</span>:12:03 GMT</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>Content-Length: <span class=\"token number\">612</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>Connection: keep-alive</pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Last-Modified: Tue, <span class=\"token number\">16</span> Apr <span class=\"token number\">2019</span> <span class=\"token number\">13</span>:08:19 GMT</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>ETag: <span class=\"token string\">\"5cb5d3c3-264\"</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>Accept-Ranges: bytes\t\t</pre></td></tr><tr><td data-num=\"81\"></td><td><pre></pre></td></tr><tr><td data-num=\"82\"></td><td><pre><span class=\"token comment\">#Master02 测试</span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:white.hmallleasing.com\" http://192.168.40.103 -I</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>HTTP/1.1 <span class=\"token number\">403</span> Forbidden</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>Date: Sat, <span class=\"token number\">14</span> Oct <span class=\"token number\">2023</span> <span class=\"token number\">13</span>:13:34 GMT</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>Content-Type: text/html</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>Content-Length: <span class=\"token number\">146</span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>Connection: keep-alive</pre></td></tr></table></figure><h4 id=\"10-ingress-nginx-速率限制\"><a class=\"anchor\" href=\"#10-ingress-nginx-速率限制\">#</a> 10. Ingress Nginx 速率限制</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limit-rate-ingress.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: rate-limit-ingress</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    nginx.ingress.kubernetes.io/limit-rps: <span class=\"token string\">\"50\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - host: rate-limit.hmallleasing.com</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>            name: nginx</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>              number: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># ab -c 20 -n 1000 http://rate-limit.hmallleasing.com/ |grep request</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Complete requests:      <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Failed requests:        <span class=\"token number\">724</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>Time per request:       <span class=\"token number\">10.301</span> <span class=\"token punctuation\">[</span>ms<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mean<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Time per request:       <span class=\"token number\">0.515</span> <span class=\"token punctuation\">[</span>ms<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>mean, across all concurrent requests<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Percentage of the requests served within a certain <span class=\"token function\">time</span> <span class=\"token punctuation\">(</span>ms<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"11使用-nginx-实现灰度金丝雀发布\"><a class=\"anchor\" href=\"#11使用-nginx-实现灰度金丝雀发布\">#</a> 11. 使用 Nginx 实现灰度 / 金丝雀发布</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建 v1 版本</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl create deploy canary-v1 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v1\t</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy canary-v1 --port 8080</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># cat canary-v1-ingress.yaml </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: canary-v1-ingress</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - host: canary.hmallleasing.com</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      - backend:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>            name: canary-v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        path: /</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        pathType: ImplementationSpecific</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># curl -H \"Host:canary.hmallleasing.com\" http://192.168.40.103 \t</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token number\">2</span>.创建 v2 版本</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\"># kubectl create deploy canary-v2 --image=registry.cn-beijing.aliyuncs.com/dotbalo/canary:v2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># kubectl expose deploy canary-v2 --port 8080</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\"># cat canary-v2-ingress.yaml </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  name: canary-v2-ingress</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    nginx.ingress.kubernetes.io/canary: <span class=\"token string\">\"true\"</span>    <span class=\"token comment\">#启动灰度发布</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    nginx.ingress.kubernetes.io/canary-weight: <span class=\"token string\">\"20\"</span>  <span class=\"token comment\">#基于权重，50% 流量调度到这个灰度的版本上</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  - host: canary.hmallleasing.com</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            name: canary-v2</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              number: <span class=\"token number\">8080</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#测试灰度发布</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ingress<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat canary.sh </span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-H</span> <span class=\"token string\">\"Host:canary.hmallleasing.com\"</span> http://192.168.40.103</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t<span class=\"token function\">sleep</span> <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><h4 id=\"12-kubernetes-dashboard配置证书\"><a class=\"anchor\" href=\"#12-kubernetes-dashboard配置证书\">#</a> 12. kubernetes-dashboard 配置证书</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.创建证书</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl create secret tls kubernetes-dashboard-certs <span class=\"token parameter variable\">--key</span> *.hmallleasing.com_key.key <span class=\"token parameter variable\">--cert</span> *.hmallleasing.com_chain.crt <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">2</span>.修改kubernetes-dashboard资源清单</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl edit deployment <span class=\"token parameter variable\">-n</span> kubernetes-dashboard kubernetes-dashboard</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      - args:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        - --auto-generate-certificates<span class=\"token operator\">=</span>false</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        - --tls-key-file<span class=\"token operator\">=</span>_.hmallleasing.com_key.key</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        - --tls-cert-file<span class=\"token operator\">=</span>_.hmallleasing.com_chain.crt</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        - --token-ttl<span class=\"token operator\">=</span><span class=\"token number\">21600</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        - --authentication-mode<span class=\"token operator\">=</span>basic,token</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        - <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>kubernetes-dashboard</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">3</span>.创建ingress</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#cat dashboard-ingress.yaml </span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: dashboard-ingress</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  namespace: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    nginx.ingress.kubernetes.io/ssl-passthrough: <span class=\"token string\">\"true\"</span>    </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    nginx.ingress.kubernetes.io/backend-protocol: <span class=\"token string\">\"HTTPS\"</span>    </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - host: dashboard.hmallleasing.com</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    http:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      paths:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      - path: /</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        pathType: Prefix</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        backend:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          service:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            name: kubernetes-dashboard</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            port:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              number: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\"># kubectl apply -f dashboard-ingress.yaml</span></pre></td></tr></table></figure><h4 id=\"13-入口lb配置\"><a class=\"anchor\" href=\"#13-入口lb配置\">#</a> 13. 入口 LB 配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb nginx<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/nginx/conf.d/ingress.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>upstream ingress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.103:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.104:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tserver <span class=\"token number\">192.168</span>.40.105:80 <span class=\"token assign-left variable\">max_conns</span><span class=\"token operator\">=</span><span class=\"token number\">2000</span> <span class=\"token assign-left variable\">max_fails</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">fail_timeout</span><span class=\"token operator\">=</span>5s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    server_name test.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    ssl_certificate  /etc/nginx/sslkey/*.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ssl_certificate_key  /etc/nginx/sslkey/*.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_pass http://ingress<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        include proxy_params<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t    proxy_next_upstream error <span class=\"token function\">timeout</span> http_500 http_502 http_503 http_504<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t    proxy_next_upstream_tries <span class=\"token number\">2</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t    proxy_next_upstream_timeout 3s<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    server_name test.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/nginx/sslkey -p</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat proxy_params </span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>proxy_http_version <span class=\"token number\">1.1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>proxy_set_header Connectin <span class=\"token string\">\"\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>proxy_connect_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>proxy_send_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>proxy_read_timeout <span class=\"token number\">120</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3364424907.html",
            "url": "http://ixuyong.cn/posts/3364424907.html",
            "title": "阿里云+Github构建镜像仓库",
            "date_published": "2025-04-26T08:20:14.000Z",
            "content_html": "<h3 id=\"阿里云github构建镜像仓库解决-k8sgcrio访问\"><a class=\"anchor\" href=\"#阿里云github构建镜像仓库解决-k8sgcrio访问\">#</a> 阿里云 + github 构建镜像仓库解决 k8s.gcr.io 访问</h3>\n<p><a href=\"http://xn--k8s-xi9d897o.gcr.io/\">由于 k8s.gcr.io/</a> 镜像仓库位于国外，国内使用 kubeadm 构建 docker 集群时无法访问相应的 docker 镜像。</p>\n<h4 id=\"1-登录github创建仓库\"><a class=\"anchor\" href=\"#1-登录github创建仓库\">#</a> <strong>1.</strong> 登录 Github 创建仓库</h4>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/vgZkKBC.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/VnJlhBE.png\" alt=\"2.png\" /></p>\n<h4 id=\"2-创建dockerfile\"><a class=\"anchor\" href=\"#2-创建dockerfile\">#</a> <strong>2.</strong> 创建 Dockerfile</h4>\n<p>仓库下面创建一个 Dockerfile，以 ingress-nginx-controller 为例下的 dockerfile 内容如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir ingress-nginx-controller</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd ingress-nginx-controller/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat Dockerfile </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>FROM registry.k8s.io/ingress-nginx/controller:v1.12.1</pre></td></tr></table></figure><h4 id=\"3-ssh免密登录github\"><a class=\"anchor\" href=\"#3-ssh免密登录github\">#</a> 3. SSH 免密登录 GitHub</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># ssh-keygen</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ~/.ssh/id_rsa.pub</span></pre></td></tr></table></figure><p>进入<em> GitHub</em> 的个人设置，找到【<em>SSH and GPG keys</em>】，然后点击新增 SSH Key，进入如下界面，<em>title</em> 输入你对于当前<em> SSH key</em> 的备注，下面的<em> key</em> 就粘贴上一步生成的<em> id_rsa.pub</em> 内的内容</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/3djSHRS.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8gVcVu4.png\" alt=\"5.png\" /></p>\n<h4 id=\"4-推送dockerfile至github\"><a class=\"anchor\" href=\"#4-推送dockerfile至github\">#</a> 4. 推送 Dockerfile 至 Github</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install git -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git --version</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git config --global user.email \"373370405@qq.com\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git config --global color.ui true</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git init</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git add .</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git commit -m \"first commit\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git branch -M main</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git remote add origin git@github.com:xyapples/ingress-nginx-controller.git   #添加远程仓库</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git remote -v</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git push -u origin main</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@manager ingress-nginx-controller<span class=\"token punctuation\">]</span><span class=\"token comment\"># git remote remove origin  #移除远程仓库</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/N3t49eX.png\" alt=\"6.png\" /></p>\n<h4 id=\"5-登录阿里云创建镜像仓库\"><a class=\"anchor\" href=\"#5-登录阿里云创建镜像仓库\">#</a> <strong>5.</strong> 登录阿里云创建镜像仓库</h4>\n<p>登录阿里云镜像：<a href=\"https://cr.console.aliyun.com/%EF%BC%8C%E5%88%9B%E5%BB%BA%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93%EF%BC%9A\">https://cr.console.aliyun.com/，创建镜像仓库：</a></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/1zFqa35.png\" alt=\"7.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/PhzoeeT.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iYAbB0x.png\" alt=\"2.png\" /></p>\n<h4 id=\"6-构建镜像\"><a class=\"anchor\" href=\"#6-构建镜像\">#</a> 6. 构建镜像</h4>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KD3DI7J.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/WiwNBRK.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/155pUrE.png\" alt=\"7.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/155pUrE.png\" alt=\"7.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/AU1371X.png\" alt=\"8.png\" /></p>\n",
            "tags": [
                "Docker"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3030097036.html",
            "url": "http://ixuyong.cn/posts/3030097036.html",
            "title": "K8S云原生存储Rook-Ceph",
            "date_published": "2025-04-24T13:43:19.000Z",
            "content_html": "<h3 id=\"k8s云原生存储rook-ceph\"><a class=\"anchor\" href=\"#k8s云原生存储rook-ceph\">#</a> K8S 云原生存储 Rook-Ceph</h3>\n<h4 id=\"1-storageclass动态存储\"><a class=\"anchor\" href=\"#1-storageclass动态存储\">#</a> 1. StorageClass 动态存储</h4>\n<p>StorageClass：存储类，由 K8s 管理员创建，用于动态 PV 的管理，可以链接至不同的后端存储，比如 Ceph、GlusterFS 等。之后对存储的请求可以指向 StorageClass，然后 StorageClass 会自动的创建、删除 PV。</p>\n<p>实现方式：</p>\n<ul>\n<li>in-tree: 内置于 K8s 核心代码，对于存储的管理，都需要编写相应的代码。</li>\n<li>out-of-tree：由存储厂商提供一个驱动（CSI 或 Flex Volume），安装到 K8s 集群，然后 StorageClass 只需要配置该驱动即可，驱动器会代替 StorageClass 管理存储。</li>\n</ul>\n<p>StorageClass 官网介绍：<a href=\"https://kubernetes.io/docs/concepts/storage/storage-classes/\">https://kubernetes.io/docs/concepts/storage/storage-classes/</a></p>\n<h4 id=\"2-云原生存储rook\"><a class=\"anchor\" href=\"#2-云原生存储rook\">#</a> 2. 云原生存储 Rook</h4>\n<p>Rook 是一个自我管理的分布式存储编排系统，它本身并不是存储系统，在存储和 k8s 之前搭建了一个桥梁，使存储系统的搭建或者维护变得特别简单，Rook 将分布式存储系统转变为自我管理、自我扩展、自我修复的存储服务。它让一些存储的操作，比如部署、配置、扩容、升级、迁移、灾难恢复、监视和资源管理变得自动化，无需人工处理。并且 Rook 支持 CSI，可以利用 CSI 做一些 PVC 的快照、扩容、克隆等操作。</p>\n<p>Rook 官网介绍：<a href=\"https://rook.io/\">https://rook.io/</a></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/CK4Gn1u.jpeg\" alt=\"Snipaste_2025-05-07_20-15-59.jpg\" /></p>\n<h4 id=\"3-rook-安装\"><a class=\"anchor\" href=\"#3-rook-安装\">#</a> 3. Rook 安装</h4>\n<p>环境准备</p>\n<ul>\n<li>K8s 集群至少五个节点，每个节点的内存不低于 5G，CPU 不低于 2 核</li>\n<li>所有节点时间同步</li>\n<li>至少有三个存储节点，并且每个节点至少有一个裸盘，k8s-master03、k8s-node01、k8s-node02 增加裸盘</li>\n</ul>\n<h5 id=\"31-下载-rook-安装文件\"><a class=\"anchor\" href=\"#31-下载-rook-安装文件\">#</a> 3.1 下载 Rook 安装文件</h5>\n<pre><code>[root@k8s-master01 ~]# git clone --single-branch --branch v1.17.2 https://github.com/rook/rook.git\n</code></pre>\n<h5 id=\"32-配置更改\"><a class=\"anchor\" href=\"#32-配置更改\">#</a> 3.2 配置更改</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim operator.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>  ROOK_CSI_CEPH_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephcsi:v3.14.0\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  ROOK_CSI_REGISTRAR_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-node-driver-registrar:v2.13.0\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ROOK_CSI_RESIZER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-resizer:v1.13.1\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  ROOK_CSI_PROVISIONER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-provisioner:v5.1.0\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ROOK_CSI_SNAPSHOTTER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-snapshotter:v8.2.0\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ROOK_CSI_ATTACHER_IMAGE: <span class=\"token string\">\"registry.cn-hangzhou.aliyuncs.com/kubernetes_public/csi-attacher:v4.8.0\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#ROOK_ENABLE_DISCOVERY_DAEMON 改成 true 即可</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ROOK_ENABLE_DISCOVERY_DAEMON: <span class=\"token string\">\"true\"</span></pre></td></tr></table></figure><h5 id=\"33-部署-rook\"><a class=\"anchor\" href=\"#33-部署-rook\">#</a> 3.3 部署 rook</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ceph<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f crds.yaml -f common.yaml -f operator.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                                  READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-operator-84ff77778b-7ww2w   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          91m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-discover-6j68f                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-discover-9w4kt                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-discover-h2zfm                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>rook-discover-hsz8b                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          19m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>rook-discover-rj4t7                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          82m</pre></td></tr></table></figure><h4 id=\"4创建-ceph-集群\"><a class=\"anchor\" href=\"#4创建-ceph-集群\">#</a> 4. 创建 Ceph 集群</h4>\n<h5 id=\"41-配置更改\"><a class=\"anchor\" href=\"#41-配置更改\">#</a> 4.1 配置更改</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim cluster.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    image: registry.cn-hangzhou.aliyuncs.com/kubernetes_public/cephv19.2.2:v19.2.2</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  skipUpgradeChecks: <span class=\"token boolean\">true</span>     <span class=\"token comment\">#改为 true，跳过升级</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  dashboard:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard under a subpath (useful when you are accessing the dashboard via a reverse proxy)</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    <span class=\"token comment\"># urlPrefix: /ceph-dashboard</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard at the given port.</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token comment\"># port: 8443</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    <span class=\"token comment\"># serve the dashboard using SSL</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    ssl: <span class=\"token boolean\">false</span>          <span class=\"token comment\">#改为 false</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  storage: <span class=\"token comment\"># cluster level storage configuration and selection</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    useAllNodes: <span class=\"token boolean\">false</span>      <span class=\"token comment\">#改为 false, 不使用所有的节点当 osd</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    useAllDevices: <span class=\"token boolean\">false</span>    <span class=\"token comment\">#改为 false, 不使用所有的磁盘当 osd</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token comment\">#     deviceFilter: \"^sd.\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    nodes:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-master03\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-node01\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - name: <span class=\"token string\">\"k8s-node02\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      devices:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      - name: <span class=\"token string\">\"sdb\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p>注意：新版必须采用裸盘，即未格式化的磁盘。其中 k8s-master03、 k8s-node01、  k8s-node02 有新加的一个磁盘，可以通过 lsblk -f 查看新添加的磁盘名称。建议最少三个节点，否则后面的试验可能会出现问题</p>\n<h5 id=\"42-创建-ceph-集群\"><a class=\"anchor\" href=\"#42-创建-ceph-集群\">#</a> 4.2 创建 Ceph 集群</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f cluster.yaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                                                     READY   STATUS      RESTARTS        AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>csi-cephfsplugin-5nmnl                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>csi-cephfsplugin-6b6ct                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>csi-cephfsplugin-8xlnl                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>csi-cephfsplugin-fh9w5                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>csi-cephfsplugin-mslst                                   <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-5zwj2            <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               61s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>csi-cephfsplugin-provisioner-59bd447c6d-7t2kg            <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>20s ago<span class=\"token punctuation\">)</span>     61s</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>csi-rbdplugin-5gvmp                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>csi-rbdplugin-dzcs4                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>csi-rbdplugin-n82b5                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-86hw8               <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               19s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>csi-rbdplugin-provisioner-6856fb8b86-lj9s4               <span class=\"token number\">6</span>/6     Running     <span class=\"token number\">0</span>               19s</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>csi-rbdplugin-vh8j2                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>csi-rbdplugin-xfgwr                                      <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>60m ago<span class=\"token punctuation\">)</span>     62m</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>rook-ceph-crashcollector-k8s-master01-bbc78d496-bzjk8    <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               8m26s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>rook-ceph-crashcollector-k8s-master03-765ff964bb-95wmt   <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>rook-ceph-crashcollector-k8s-node01-7cf4c4b6b6-r4n84     <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               20m</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>rook-ceph-crashcollector-k8s-node02-f887f8cf9-jz2l8      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>rook-ceph-detect-version-nsrwj                           <span class=\"token number\">0</span>/1     Init:0/1    <span class=\"token number\">0</span>               3s</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>rook-ceph-exporter-k8s-master01-5cd4577b79-ckd4m         <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               8m26s</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rook-ceph-exporter-k8s-master03-75f4cf6f7-hc9zb          <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>rook-ceph-exporter-k8s-node01-96fc7cf49-d2r24            <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               20m</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>rook-ceph-exporter-k8s-node02-777b9f555b-7j6cz           <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               27m</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>rook-ceph-mgr-a-6f46b4b945-q6cjb                         <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">3</span> <span class=\"token punctuation\">(</span>14m ago<span class=\"token punctuation\">)</span>     35m</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>rook-ceph-mgr-b-5d4cc5465b-8dfh6                         <span class=\"token number\">3</span>/3     Running     <span class=\"token number\">0</span>               35m</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>rook-ceph-mon-a-7c7b7555c7-nlhwg                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">2</span> <span class=\"token punctuation\">(</span>6m14s ago<span class=\"token punctuation\">)</span>   51m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>rook-ceph-mon-c-559bcf95fd-cl62w                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               8m27s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>rook-ceph-mon-d-7dbc6b8f5c-8264t                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               28m</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>rook-ceph-operator-645478ff5b-jdcrp                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               102m</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>rook-ceph-osd-0-6d9cf78f76-4zhx8                         <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               12m</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>rook-ceph-osd-1-88c78bbcb-cn48c                          <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               5m15s</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>rook-ceph-osd-2-b464c9fc6-458hv                          <span class=\"token number\">2</span>/2     Running     <span class=\"token number\">0</span>               4m29s</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>rook-ceph-osd-prepare-k8s-master03-pwnrc                 <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               86s</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>rook-ceph-osd-prepare-k8s-node01-xxp2j                   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               83s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>rook-ceph-osd-prepare-k8s-node02-8nz7x                   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>               78s</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>rook-discover-jzmkr                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>rook-discover-k7pxt                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>rook-discover-vqjh5                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>rook-discover-wk8jq                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>rook-discover-x8rsn                                      <span class=\"token number\">1</span>/1     Running     <span class=\"token number\">0</span>               91m</pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get cephcluster -n rook-ceph</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>NAME        DATADIRHOSTPATH   MONCOUNT   AGE   PHASE   MESSAGE                        HEALTH        EXTERNAL   FSID</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>rook-ceph   /var/lib/rook     <span class=\"token number\">3</span>          63m   Ready   Cluster created successfully   HEALTH_WARN              ca429602-66f4-4a1e-9d5c-a5773a0f594f</pre></td></tr></table></figure><h5 id=\"43-安装-ceph-snapshot-控制器\"><a class=\"anchor\" href=\"#43-安装-ceph-snapshot-控制器\">#</a> 4.3 安装 ceph snapshot 控制器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># git checkout manual-installation-v1.32.x</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f snapshotter/ -n kube-system</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system -l app=snapshot-controller</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>snapshot-controller-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          67s</pre></td></tr></table></figure><h4 id=\"5-安装-ceph-客户端工具\"><a class=\"anchor\" href=\"#5-安装-ceph-客户端工具\">#</a> 5. 安装 ceph 客户端工具</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f toolbox.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n rook-ceph -l app=rook-ceph-tools</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                               READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-tools-7b75b967db-sqddk   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it rook-ceph-tools-7b75b967db-sqddk -n rook-ceph -- bash</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>bash-5.1$ ceph status</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  cluster:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    id:     87b85368-9487-4967-a4e4-5970d2e0ec94</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    health: HEALTH_WARN</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>            <span class=\"token number\">1</span> mgr modules have recently crashed</pre></td></tr><tr><td data-num=\"12\"></td><td><pre> </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  services:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    mon: <span class=\"token number\">3</span> daemons, quorum b,c <span class=\"token punctuation\">(</span>age 12s<span class=\"token punctuation\">)</span>, out of quorum: a</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    mgr: a<span class=\"token punctuation\">(</span>active, since 7m<span class=\"token punctuation\">)</span>, standbys: b</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    osd: <span class=\"token number\">3</span> osds: <span class=\"token number\">3</span> up <span class=\"token punctuation\">(</span>since 8m<span class=\"token punctuation\">)</span>, <span class=\"token number\">3</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">(</span>since 3h<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre> </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  data:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    pools:   <span class=\"token number\">0</span> pools, <span class=\"token number\">0</span> pgs</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    objects: <span class=\"token number\">0</span> objects, <span class=\"token number\">0</span> B</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    usage:   <span class=\"token number\">82</span> MiB used, <span class=\"token number\">60</span> GiB / <span class=\"token number\">60</span> GiB avail</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    pgs: </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>bash-4.4$  ceph osd status</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>ID  HOST           USED  AVAIL  WR OPS  WR DATA  RD OPS  RD DATA  STATE      </pre></td></tr><tr><td data-num=\"26\"></td><td><pre> <span class=\"token number\">0</span>  k8s-master03  <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up  </pre></td></tr><tr><td data-num=\"27\"></td><td><pre> <span class=\"token number\">1</span>  k8s-node01    <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre> <span class=\"token number\">2</span>  k8s-node02    <span class=\"token number\">20</span>.6M  <span class=\"token number\">19</span>.9G      <span class=\"token number\">0</span>        <span class=\"token number\">0</span>       <span class=\"token number\">0</span>        <span class=\"token number\">0</span>   exists,up </pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>bash-4.4$ ceph <span class=\"token function\">df</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>--- RAW STORAGE ---</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>CLASS    SIZE   AVAIL    USED  RAW USED  %RAW USED</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>hdd    <span class=\"token number\">60</span> GiB  <span class=\"token number\">60</span> GiB  <span class=\"token number\">62</span> MiB    <span class=\"token number\">62</span> MiB       <span class=\"token number\">0.10</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>TOTAL  <span class=\"token number\">60</span> GiB  <span class=\"token number\">60</span> GiB  <span class=\"token number\">62</span> MiB    <span class=\"token number\">62</span> MiB       <span class=\"token number\">0.10</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>--- POOLS ---</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>POOL  ID  PGS   STORED  OBJECTS     USED  %USED  MAX AVAIL</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>.mgr   <span class=\"token number\">1</span>    <span class=\"token number\">1</span>  <span class=\"token number\">449</span> KiB        <span class=\"token number\">2</span>  <span class=\"token number\">1.3</span> MiB      <span class=\"token number\">0</span>     <span class=\"token number\">19</span> GiB</pre></td></tr></table></figure><h4 id=\"6-ceph-dashboard\"><a class=\"anchor\" href=\"#6-ceph-dashboard\">#</a> 6. Ceph dashboard</h4>\n<h5 id=\"61-暴露服务\"><a class=\"anchor\" href=\"#61-暴露服务\">#</a> 6.1 暴露服务</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n rook-ceph</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>             AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>rook-ceph-mgr             ClusterIP   <span class=\"token number\">10.96</span>.54.15     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">9283</span>/TCP            133m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-mgr-dashboard   ClusterIP   <span class=\"token number\">10.96</span>.97.117    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">7000</span>/TCP            133m        <span class=\"token comment\">#暴露 ingresss 也可</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-mon-a           ClusterIP   <span class=\"token number\">10.96</span>.125.216   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   170m</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-mon-b           ClusterIP   <span class=\"token number\">10.96</span>.34.183    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-ceph-mon-c           ClusterIP   <span class=\"token number\">10.96</span>.232.252   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">6789</span>/TCP,3300/TCP   133m</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f dashboard-external-http.yaml           #暴露 nodeport</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc -n rook-ceph rook-ceph-mgr-dashboard-external-http</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>NAME                                     TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>          AGE</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rook-ceph-mgr-dashboard-external-https   NodePort   <span class=\"token number\">10.96</span>.11.120   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">8443</span>:32611/TCP   45s</pre></td></tr></table></figure><h5 id=\"62-配置ingress访问ceph\"><a class=\"anchor\" href=\"#62-配置ingress访问ceph\">#</a> 6.2 配置 ingress 访问 ceph</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat dashboard-ingress-https.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># This example is for Kubernetes running an nginx-ingress</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># and an ACME (e.g. Let's Encrypt) certificate service</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># The nginx-ingress annotations support the dashboard</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># running using HTTPS with a self-signed certificate</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: networking.k8s.io/v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: Ingress</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: rook-ceph <span class=\"token comment\"># namespace:cluster</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#  annotations:</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#    kubernetes.io/ingress.class: \"nginx\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#    kubernetes.io/tls-acme: \"true\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#    nginx.ingress.kubernetes.io/backend-protocol: \"HTTPS\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#    nginx.ingress.kubernetes.io/server-snippet: |</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#      proxy_ssl_verify off;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  ingressClassName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#  tls:</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#    - hosts:</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#        - rook-ceph.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#      secretName: rook-ceph.example.com</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  rules:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    - host: rook-ceph.hmallleasing.com</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      http:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        paths:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>          - path: /</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            pathType: Prefix</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            backend:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              service:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                name: rook-ceph-mgr-dashboard</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                port:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                  name: http-dashboard</pre></td></tr></table></figure><h5 id=\"63-登录\"><a class=\"anchor\" href=\"#63-登录\">#</a> 6.3 登录</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>http://192.168.40.100:32611</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>用户名：admin</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>密码：kubectl <span class=\"token parameter variable\">-n</span> rook-ceph get secret rook-ceph-dashboard-password <span class=\"token parameter variable\">-o</span> <span class=\"token assign-left variable\">jsonpath</span><span class=\"token operator\">=</span><span class=\"token string\">\"&#123;['data']['password']&#125;\"</span> <span class=\"token operator\">|</span> base64 <span class=\"token parameter variable\">--decode</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">echo</span></pre></td></tr></table></figure><h4 id=\"7-ceph-块存储的使用\"><a class=\"anchor\" href=\"#7-ceph-块存储的使用\">#</a> 7. Ceph 块存储的使用</h4>\n<p>块存储一般用于一个 Pod 挂载一块存储使用，相当于一个服务器新挂了一个盘，只给一个应用使用。</p>\n<h5 id=\"71-创建-storageclass-和-ceph-的存储池\"><a class=\"anchor\" href=\"#71-创建-storageclass-和-ceph-的存储池\">#</a> 7.1 创建 StorageClass 和 ceph 的存储池</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get csidriver</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES        AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>rook-ceph.cephfs.csi.ceph.com   <span class=\"token boolean\">true</span>             <span class=\"token boolean\">false</span>            <span class=\"token boolean\">false</span>             <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>         <span class=\"token boolean\">false</span>               Persistent   15h       <span class=\"token comment\">#文件存储 csi</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph.rbd.csi.ceph.com      <span class=\"token boolean\">true</span>             <span class=\"token boolean\">false</span>            <span class=\"token boolean\">false</span>             <span class=\"token operator\">&lt;</span>unset<span class=\"token operator\">></span>         <span class=\"token boolean\">false</span>               Persistent   15h       <span class=\"token comment\">#块存储 csi</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim csi/rbd/storageclass.yaml</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: ceph.rook.io/v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: CephBlockPool</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: replicapool</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: rook-ceph <span class=\"token comment\"># namespace:cluster</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  failureDomain: <span class=\"token function\">host</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  replicated:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    size: <span class=\"token number\">3</span>                <span class=\"token comment\">#数据保存几份，测试环境可以将副本数设置成了 2（不能设置为 1），生产环境最少为 3，且要小于等于 osd 的数量</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>allowVolumeExpansion: <span class=\"token boolean\">true</span>     <span class=\"token comment\">#是否可以扩容</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>reclaimPolicy: Delete          <span class=\"token comment\">#pv 回收策略</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f csi/rbd/storageclass.yaml -n rook-ceph</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get cephblockpool -n rook-ceph</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>NAME          PHASE</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>replicapool   Ready</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME              PROVISIONER                  RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>nfs-storage       nfzl.com/nfs                 Delete          Immediate           <span class=\"token boolean\">false</span>                  16h</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   37s</pre></td></tr></table></figure><h5 id=\"72-挂载测试\"><a class=\"anchor\" href=\"#72-挂载测试\">#</a> 7.2 挂载测试</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc.yaml        #创建 PVC</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: ceph-block-pvc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc.yaml </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME             STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ceph-block-pvc   Bound    pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            rook-ceph-block   3s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                    STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>pvc-86c94d8d-c359-47b8-b5d3-31dcdaf86551   1Gi        RWO            Delete           Bound    default/ceph-block-pvc   rook-ceph-block</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t  </pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc-pod.yaml    #挂载 PVC 测试 </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - name: ceph-block-pvc-pod</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    - name: nginx-page</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  - name: nginx-page</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      claimName: ceph-block-pv</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc-pod.yaml</span></pre></td></tr></table></figure><h5 id=\"73-statefulset-volumeclaimtemplates\"><a class=\"anchor\" href=\"#73-statefulset-volumeclaimtemplates\">#</a> 7.3 StatefulSet volumeClaimTemplates</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      clusterIP: None</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      app: nginx <span class=\"token comment\"># 必须匹配 .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  serviceName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token comment\"># 默认值是 1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        app: nginx <span class=\"token comment\"># 必须匹配 .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        image: nginx:1.20</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    name: www</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          storage: 1Gi</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>    \t  </pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f ceph-block-pvc-sts.yaml </span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS       AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>web-0                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m19s</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>web-1                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              4m10s</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>web-2                                     <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>              2m21s</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS      AGE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>www-web-0   Bound    pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            rook-ceph-block   4m23s</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>www-web-1   Bound    pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            rook-ceph-block   4m14s</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>www-web-2   Bound    pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            rook-ceph-block   2m25s</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM               STORAGECLASS      REASON   AGE</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>pvc-27cab5bf-f989-4050-aa84-1b2dac9fa745   1Gi        RWO            Delete           Bound    default/www-web-0   rook-ceph-block            4m25s</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>pvc-6b858cd9-288f-48bc-bc96-33e6eb519613   1Gi        RWO            Delete           Bound    default/www-web-2   rook-ceph-block            2m27s</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>pvc-76fb08f4-2195-4678-b6b8-286c2f722cc9   1Gi        RWO            Delete           Bound    default/www-web-1   rook-ceph-block            4m16s</pre></td></tr></table></figure><h4 id=\"8-共享文件系统的使用\"><a class=\"anchor\" href=\"#8-共享文件系统的使用\">#</a> 8. 共享文件系统的使用</h4>\n<p>共享文件系统一般用于多个 Pod 共享一个存储</p>\n<h5 id=\"81-创建共享类型的文件系统\"><a class=\"anchor\" href=\"#81-创建共享类型的文件系统\">#</a> 8.1 创建共享类型的文件系统</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/rook/deploy/examples/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f filesystem.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -l app=rook-ceph-mds -n rook-ceph</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME                                    READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-ceph-mds-myfs-a-7d76cb5988-9nz9p   <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          36s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-mds-myfs-b-76ff7c784c-vs8nm   <span class=\"token number\">2</span>/2     Running   <span class=\"token number\">0</span>          33s</pre></td></tr></table></figure><h5 id=\"82-创建共享类型文件系统的-storageclass\"><a class=\"anchor\" href=\"#82-创建共享类型文件系统的-storageclass\">#</a> 8.2 创建共享类型文件系统的 StorageClass</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd csi/cephfs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cephfs<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f storageclass.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cephfs<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class=\"token boolean\">false</span>                  17h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class=\"token boolean\">true</span>                   82m</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   13s</pre></td></tr></table></figure><h5 id=\"83-挂载测试\"><a class=\"anchor\" href=\"#83-挂载测试\">#</a> 8.3 挂载测试</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cephfs-pvc-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  name: nginx-share-pvc</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  storageClassName: rook-cephfs </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kind: Deployment </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      app: nginx <span class=\"token comment\"># has to match .spec.template.metadata.labels</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token comment\"># by default is 1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        app: nginx <span class=\"token comment\"># has to match .spec.selector.matchLabels</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        image: nginx </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            claimName: nginx-share-pvc</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t\t\t</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f cephfs-pvc-deploy.yaml</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">84</span> <span class=\"token punctuation\">(</span>4m2s ago<span class=\"token punctuation\">)</span>   16d</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>123m ago<span class=\"token punctuation\">)</span>    18h</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               46s</pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    52s</pre></td></tr><tr><td data-num=\"69\"></td><td><pre></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             53s</pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># echo \"hello cephfs\" >> index.html</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>NAME                 TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>    AGE</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>kubernetes           ClusterIP   <span class=\"token number\">10.96</span>.0.1     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP    16d</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>mysql-svc-external   ClusterIP   None          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">3306</span>/TCP   9d</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx                ClusterIP   <span class=\"token number\">10.96</span>.58.17   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP     4m34s</pre></td></tr><tr><td data-num=\"83\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 10.96.58.17</span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id=\"9pvc-扩容\"><a class=\"anchor\" href=\"#9pvc-扩容\">#</a> 9.PVC 扩容</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME              PROVISIONER                     RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nfs-storage       nfzl.com/nfs                    Delete          Immediate           <span class=\"token boolean\">false</span>                  18h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>rook-ceph-block   rook-ceph.rbd.csi.ceph.com      Delete          Immediate           <span class=\"token boolean\">true</span>                   104m     <span class=\"token comment\">#true 允许扩容</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>rook-cephfs       rook-ceph.cephfs.csi.ceph.com   Delete          Immediate           <span class=\"token boolean\">true</span>                   22m      <span class=\"token comment\">#true 允许扩容</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   2Gi        RWX            rook-cephfs    13m</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl edit pvc nginx-share-pvc</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - ReadWriteMany</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      storage: 5Gi         <span class=\"token comment\">#更改 pvc 大小</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  storageClassName: rook-cephfs</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc       #查看 PVC 是否扩容</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv         #查看 PV 是否扩容</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                     STORAGECLASS   REASON   AGE</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            Delete           Bound    default/nginx-share-pvc   rook-cephfs             15m</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash       #进入容器，查看 pod 是否扩容  </span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># df -h </span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>Filesystem                                                                                                                                             Size  Used Avail Use% Mounted on</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>overlay                                                                                                                                                 17G   13G  <span class=\"token number\">4</span>.1G  <span class=\"token number\">76</span>% /</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>tmpfs                                                                                                                                                   64M     <span class=\"token number\">0</span>   64M   <span class=\"token number\">0</span>% /dev</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /sys/fs/cgroup</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>/dev/sda3                                                                                                                                               17G   13G  <span class=\"token number\">4</span>.1G  <span class=\"token number\">76</span>% /etc/hosts</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>shm                                                                                                                                                     64M     <span class=\"token number\">0</span>   64M   <span class=\"token number\">0</span>% /dev/shm</pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token number\">10.96</span>.121.140:6789,10.96.131.130:6789,10.96.62.64:6789:/volumes/csi/csi-vol-3b645a11-58f4-475a-9404-5d84964f5291/e4bdf743-eb18-42c8-b04f-41964f76de4f  <span class=\"token number\">5</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">5</span>.0G   <span class=\"token number\">0</span>% /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">3</span>.8G   12K  <span class=\"token number\">3</span>.8G   <span class=\"token number\">1</span>% /run/secrets/kubernetes.io/serviceaccount</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/asound</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/acpi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /proc/scsi</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>tmpfs                                                                                                                                                  <span class=\"token number\">2</span>.0G     <span class=\"token number\">0</span>  <span class=\"token number\">2</span>.0G   <span class=\"token number\">0</span>% /sys/firmware</pre></td></tr></table></figure><h4 id=\"10-pvc-快照\"><a class=\"anchor\" href=\"#10-pvc-快照\">#</a> 10. PVC 快照</h4>\n<h5 id=\"101-文件共享类型快照\"><a class=\"anchor\" href=\"#101-文件共享类型快照\">#</a> 10.1 文件共享类型快照</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd rook/deploy/examples</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f csi/cephfs/snapshotclass.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshotclass</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>NAME                         DRIVER                          DELETIONPOLICY   AGE</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>csi-cephfsplugin-snapclass   rook-ceph.cephfs.csi.ceph.com   Delete           25s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#拍摄快照\t</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash         #pvc 新增数据</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># touch &#123;1..10&#125;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc       #查看 pvs 并对 nginx-share-pvc 拍摄快照</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>NAME              STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>nginx-share-pvc   Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h23m</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/snapshot.yaml         #拍摄快照</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\"># 1.17 &lt;= K8s &lt;= v1.19</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># apiVersion: snapshot.storage.k8s.io/v1beta1</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># K8s >= v1.20</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>apiVersion: snapshot.storage.k8s.io/v1</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kind: VolumeSnapshot</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  name: cephfs-pvc-snapshot</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  volumeSnapshotClassName: csi-cephfsplugin-snapclass</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  source:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    persistentVolumeClaimName: nginx-share-pvc         <span class=\"token comment\">#基于那个 PVC 拍摄快照</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/snapshot.yaml</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   4m6s           4m8s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#删除 pvc 数据</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it web-6c59f8559-g5xzb -- bash</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>root@web-6c59f8559-g5xzb:/<span class=\"token comment\"># cd /usr/share/nginx/html/</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># rm -rf &#123;1..10&#125;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>root@web-6c59f8559-g5xzb:/usr/share/nginx/html<span class=\"token comment\"># ls</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>index.html</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\">#pvc 回滚数据</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   7m39s          7m41s</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pvc-restore.yaml </span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  name: cephfs-pvc-restore</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  storageClassName: rook-cephfs       <span class=\"token comment\">#创建 pv 的 storageclass 名称相同</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>    name: cephfs-pvc-snapshot         <span class=\"token comment\">#volumesnapshot 数据源</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    kind: VolumeSnapshot</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    apiGroup: snapshot.storage.k8s.io</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      storage: 5Gi      <span class=\"token comment\">#大小等于 snapshot 大小</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pvc-restore.yaml</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre></pre></td></tr><tr><td data-num=\"73\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    54s          </pre></td></tr><tr><td data-num=\"76\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    4h50m</pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token comment\">#挂载 PVC 测试数据是否恢复</span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>        claimName: cephfs-pvc-restore        <span class=\"token comment\">#挂载恢复 pvc</span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>        readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre></pre></td></tr><tr><td data-num=\"98\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pod.yaml</span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS        AGE</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">88</span> <span class=\"token punctuation\">(</span>57m ago<span class=\"token punctuation\">)</span>    16d</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>csicephfs-demo-pod                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               24s</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>6h57m ago<span class=\"token punctuation\">)</span>   23h</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>               4h54m</pre></td></tr><tr><td data-num=\"107\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num=\"108\"></td><td><pre>root@csicephfs-demo-pod:/<span class=\"token comment\"># ls /var/lib/www/html/               #s 删除数据已经恢复</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre><span class=\"token number\">1</span>  <span class=\"token number\">10</span>  <span class=\"token number\">2</span>  <span class=\"token number\">3</span>  <span class=\"token number\">4</span>\t<span class=\"token number\">5</span>  <span class=\"token number\">6</span>  <span class=\"token number\">7</span>  <span class=\"token number\">8</span>  <span class=\"token number\">9</span>  index.html</pre></td></tr></table></figure><h5 id=\"102-pvc-克隆\"><a class=\"anchor\" href=\"#102-pvc-克隆\">#</a> 10.2 PVC 克隆</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    11m</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h1m</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pvc-clone.yaml </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: cephfs-pvc-clone</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  storageClassName: rook-cephfs      <span class=\"token comment\"># pvc 的 storageClass 名称</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  dataSource:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    name: nginx-share-pvc          <span class=\"token comment\">#克隆的 PVC 名称</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      storage: 5Gi                 <span class=\"token comment\">#大小等于所克隆的 PVC 大小</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pvc-clone.yaml</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>cephfs-pvc-clone     Bound    pvc-0a19b65e-cb5e-4379-a7f7-e0783fcf8ddf   5Gi        RWX            rook-cephfs    22s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>cephfs-pvc-restore   Bound    pvc-9e845f2b-df1f-450d-8aa2-f9a46db6adb6   5Gi        RWX            rook-cephfs    15m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>nginx-share-pvc      Bound    pvc-4de733fe-c2fb-437b-baff-aaeba0235d54   5Gi        RWX            rook-cephfs    5h4m</pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\">#挂载克隆 PVC 测试</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat csi/cephfs/pod.yaml </span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  name: csicephfs-demo-pod</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    - name: web-server</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      image: nginx</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      volumeMounts:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        - name: mypvc</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          mountPath: /var/lib/www/html</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    - name: mypvc</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        claimName: cephfs-pvc-clone      <span class=\"token comment\">#挂载克隆的 pvc</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        readOnly: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f csi/cephfs/pod.yaml          </span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS         AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>cluster-test-84dfc9c68b-5q4ng             <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">89</span> <span class=\"token punctuation\">(</span>9m54s ago<span class=\"token punctuation\">)</span>   16d</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>csicephfs-demo-pod                        <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                17s</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nfs-client-provisioner-5dbbd8d796-lhdgw   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">5</span> <span class=\"token punctuation\">(</span>7h9m ago<span class=\"token punctuation\">)</span>     23h</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>web-6c59f8559-g5xzb                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>web-6c59f8559-ns77q                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>web-6c59f8559-qxb5f                       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>                5h6m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 examples<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it csicephfs-demo-pod -- bash</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>root@csicephfs-demo-pod:/<span class=\"token comment\"># cat /var/lib/www/html/index.html </span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>hello cephfs</pre></td></tr></table></figure><h4 id=\"11-测试数据清理\"><a class=\"anchor\" href=\"#11-测试数据清理\">#</a> 11. 测试数据清理</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>参考文档：https://rook.io/docs/rook/v1.11/Getting-Started/ceph-teardown/<span class=\"token comment\">#delete-the-cephcluster-crd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete deploy web</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pods csicephfs-demo-pod</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete pvc --all</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pvc</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>No resources found <span class=\"token keyword\">in</span> default namespace.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pv</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>No resources found</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get volumesnapshot</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>NAME                  READYTOUSE   SOURCEPVC         SOURCESNAPSHOTCONTENT   RESTORESIZE   SNAPSHOTCLASS                SNAPSHOTCONTENT                                    CREATIONTIME   AGE</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>cephfs-pvc-snapshot   <span class=\"token boolean\">true</span>         nginx-share-pvc                           5Gi           csi-cephfsplugin-snapclass   snapcontent-bdaddb97-debe-4f42-9423-13bf1c5b5402   61m            61m</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl delete volumesnapshot cephfs-pvc-snapshot</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>volumesnapshot.snapshot.storage.k8s.io <span class=\"token string\">\"cephfs-pvc-snapshot\"</span> deleted</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-n</span> rook-ceph cephblockpool replicapool</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-n</span> rook-ceph cephfilesystem myfs</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kubectl delete storageclass rook-ceph-block</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kubectl delete storageclass rook-cephfs</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> csi/cephfs/kube-registry.yaml</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kubectl delete storageclass csi-cephfs</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kubectl <span class=\"token parameter variable\">-n</span> rook-ceph delete cephcluster rook-ceph</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> operator.yaml</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> common.yaml</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>kubectl delete <span class=\"token parameter variable\">-f</span> crds.yaml</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3890389502.html",
            "url": "http://ixuyong.cn/posts/3890389502.html",
            "title": "K8S持久化存储NFS+StorageClass",
            "date_published": "2025-04-23T12:08:26.000Z",
            "content_html": "<h3 id=\"k8s持久化存储nfsstorageclass\"><a class=\"anchor\" href=\"#k8s持久化存储nfsstorageclass\">#</a> K8S 持久化存储 NFS+StorageClass</h3>\n<h4 id=\"1-搭建nfs服务器\"><a class=\"anchor\" href=\"#1-搭建nfs服务器\">#</a> 1. 搭建 NFS 服务器</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#所有 K8S 节点安装 nfs-utils</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y    </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#K8S-node02 节点配置 nfs 服务</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /data/nfs -p</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/exports</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>/data/nfs <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># exportfs -arv   #NFS 配置生效 </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server &amp;&amp; systemctl status nfs-server</span></pre></td></tr></table></figure><h4 id=\"2-创建rbac\"><a class=\"anchor\" href=\"#2-创建rbac\">#</a> 2.  创建 RBAC</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-node02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 01-rbac.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ServiceAccount</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: nfs-client-provisioner-runner</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"nodes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"persistentvolumes\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"delete\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"persistentvolumeclaims\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"update\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"storage.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"storageclasses\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"events\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  name: run-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  - kind: ServiceAccount</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    namespace: default</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  name: nfs-client-provisioner-runner</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>kind: Role</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - apiGroups: <span class=\"token punctuation\">[</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    resources: <span class=\"token punctuation\">[</span><span class=\"token string\">\"endpoints\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    verbs: <span class=\"token punctuation\">[</span><span class=\"token string\">\"get\"</span>, <span class=\"token string\">\"list\"</span>, <span class=\"token string\">\"watch\"</span>, <span class=\"token string\">\"create\"</span>, <span class=\"token string\">\"update\"</span>, <span class=\"token string\">\"patch\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>kind: RoleBinding</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - kind: ServiceAccount</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>    name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>    <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    namespace: default</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  kind: Role</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  name: leader-locking-nfs-client-provisioner</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"72\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 01-rbac.yaml </span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>serviceaccount/nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</pre></td></tr></table></figure><h4 id=\"3-创建nfs-provisioner\"><a class=\"anchor\" href=\"#3-创建nfs-provisioner\">#</a> 3. 创建 nfs-provisioner</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 02-nfs-provisioner.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  <span class=\"token comment\"># replace with namespace where provisioner is deployed</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  strategy:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    type: Recreate</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        app: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      serviceAccountName: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: nfs-client-provisioner</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          image: registry.cn-hangzhou.aliyuncs.com/old_xu/nfs-subdir-external-provisioner:v4.0.2</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            - name: nfs-client-root</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              mountPath: /persistentvolumes</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          env:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            - name: PROVISIONER_NAME\t<span class=\"token comment\"># nfs-provisioner 的名称，后续 storageClass 要与该名称一致</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              value: nfzl.com/nfs</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            - name: NFS_SERVER\t\t<span class=\"token comment\"># NFS 服务的 IP 地址</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              value: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            - name: NFS_PATH\t\t<span class=\"token comment\"># NFS 服务共享的路径</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>              value: /data/nfs</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nfs-client-root</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          nfs:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            path: /data/nfs</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 02-nfs-provisioner.yaml </span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>nfs-client-provisioner-6bcc4587f8-zp8qc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          17s</pre></td></tr></table></figure><h4 id=\"4-创建storageclass\"><a class=\"anchor\" href=\"#4-创建storageclass\">#</a> 4. 创建 StorageClass</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 03-storageClass.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: storage.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: StorageClass</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nfs-storage \t<span class=\"token comment\"># pvc 申请时需明确指定的 storageClass 名称</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>provisioner: nfzl.com/nfs        <span class=\"token comment\"># 供应商名称，必须和上面创建的 \"PROVISIONER_NAME\" 变量值致</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>parameters:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  archiveOnDelete: <span class=\"token string\">\"false\"</span>     <span class=\"token comment\"># 如果值为 false，删除 PVC 后也会删除目录内容，\"true\" 则会对数据进行保留</span></pre></td></tr></table></figure><h4 id=\"5-创建pvc\"><a class=\"anchor\" href=\"#5-创建pvc\">#</a> 5. 创建 PVC</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 04-nginx-pvc.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: sc-pvc-001</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      storage: 1Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 04-nginx-pvc.yaml</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fgpaP15.png\" alt=\"1.png\" /></p>\n<h4 id=\"6-挂载pvc测试\"><a class=\"anchor\" href=\"#6-挂载pvc测试\">#</a> 6. 挂载 PVC 测试</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat 05-nginx-pod.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Pod</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-sc-001</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  containers:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - name: nginx-sc-001</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    image: nginx</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    volumeMounts:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    - name: nginx-page</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  volumes:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - name: nginx-page</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    persistentVolumeClaim:      </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      claimName: sc-pvc-001</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f 05-nginx-pod.yaml</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>NAME                                      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>nginx-sc-001                              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          15s   <span class=\"token number\">172.16</span>.85.244   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 172.16.85.244</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>hello world</pre></td></tr></table></figure>",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/722512536.html",
            "url": "http://ixuyong.cn/posts/722512536.html",
            "title": "K8s细粒度权限控制RBAC",
            "date_published": "2025-04-23T12:04:03.000Z",
            "content_html": "<h3 id=\"k8s细粒度权限控制rbac\"><a class=\"anchor\" href=\"#k8s细粒度权限控制rbac\">#</a> K8s 细粒度权限控制 RBAC</h3>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KCZPPkv.jpeg\" alt=\"rbac.jpg\" /></p>\n<h4 id=\"1-创建不同权限的clusterrole\"><a class=\"anchor\" href=\"#1-创建不同权限的clusterrole\">#</a> 1. 创建不同权限的 clusterrole</h4>\n<h5 id=\"11-命令空间只读namespace-readonly\"><a class=\"anchor\" href=\"#11-命令空间只读namespace-readonly\">#</a> 1.1 命令空间只读 namespace-readonly</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> namespace-readonly.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: namespace-readonly</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  - metrics.k8s.io</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"12-资源查看resource-readonly\"><a class=\"anchor\" href=\"#12-资源查看resource-readonly\">#</a> 1.2 资源查看 resource-readonly</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> resource-readonly.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: resource-readonly</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - configmaps</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - endpoints</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - persistentvolumeclaims</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - replicationcontrollers</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - replicationcontrollers/scale</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  - serviceaccounts</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - services</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  - bindings</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - events</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  - limitranges</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  - namespaces/status</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  - pods/log</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  - pods/status</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  - replicationcontrollers/status</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  - resourcequotas</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  - resourcequotas/status</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  - namespaces</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  - apps</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>  - controllerrevisions</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>  - daemonsets</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  - deployments</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>  - deployments/scale</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>  - replicasets</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>  - replicasets/scale</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  - statefulsets</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>  - statefulsets/scale</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>  - autoscaling</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  - horizontalpodautoscalers</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>  - batch</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>  - cronjobs</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>  - <span class=\"token function\">jobs</span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"77\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>  - extensions</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>  - daemonsets</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  - deployments</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>  - deployments/scale</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  - ingresses</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>  - networkpolicies</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>  - replicasets</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>  - replicasets/scale</pre></td></tr><tr><td data-num=\"88\"></td><td><pre>  - replicationcontrollers/scale</pre></td></tr><tr><td data-num=\"89\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"93\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>  - policy</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"96\"></td><td><pre>  - poddisruptionbudgets</pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"100\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  - networking.k8s.io</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>  - networkpolicies</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"108\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr><tr><td data-num=\"109\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"110\"></td><td><pre>  - metrics.k8s.io</pre></td></tr><tr><td data-num=\"111\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"112\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"113\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"114\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"115\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"116\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"13-pod日志查看\"><a class=\"anchor\" href=\"#13-pod日志查看\">#</a> 1.3 pod 日志查看</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-log.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-log</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  - pods/log</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - <span class=\"token function\">watch</span></pre></td></tr></table></figure><h5 id=\"14-pod删除\"><a class=\"anchor\" href=\"#14-pod删除\">#</a> 1.4 Pod 删除</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-delete.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-delete</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  - delete</pre></td></tr></table></figure><h5 id=\"15-pod执行\"><a class=\"anchor\" href=\"#15-pod执行\">#</a> 1.5 Pod 执行</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> pod-exec.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRole</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: pod-exec</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>rules:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - pods</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  - get</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  - list</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>- apiGroups:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  - <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  - pods/exec</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  verbs:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - create</pre></td></tr></table></figure><h5 id=\"16-创建不同权限的clusterrole\"><a class=\"anchor\" href=\"#16-创建不同权限的clusterrole\">#</a> 1.6 创建不同权限的 clusterrole</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 rbac<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f .</span></pre></td></tr></table></figure><h4 id=\"2-创建serviceaccount\"><a class=\"anchor\" href=\"#2-创建serviceaccount\">#</a> 2. 创建 serviceaccount</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create ns kube-users</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>$ kubectl create sa <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-n</span> kube-users   </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>$ kubectl create sa dev <span class=\"token parameter variable\">-n</span> kube-users    </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>$ kubectl create sa ops <span class=\"token parameter variable\">-n</span> kube-users    </pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>$ kubectl create token <span class=\"token builtin class-name\">test</span> <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>$ kubectl create token dev <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>$ kubectl create token ops <span class=\"token parameter variable\">-n</span> kube-users</pre></td></tr></table></figure><h4 id=\"3-创建clusterrolebinding\"><a class=\"anchor\" href=\"#3-创建clusterrolebinding\">#</a> 3. 创建 ClusterRoleBinding</h4>\n<h5 id=\"31-绑定全局命名空间查看权限\"><a class=\"anchor\" href=\"#31-绑定全局命名空间查看权限\">#</a> 3.1 绑定全局命名空间查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ <span class=\"token function\">cat</span> clusterrolebinding-namespace-readonly.yaml </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: rbac.authorization.k8s.io/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: ClusterRoleBinding</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: clusterrolebinding-namespace-readonly </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>subjects:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>- kind: Group</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: system:serviceaccounts:kube-users</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>roleRef:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  kind: ClusterRole</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  name: namespace-readonly</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  apiGroup: rbac.authorization.k8s.io</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>$ kubectl apply <span class=\"token parameter variable\">-f</span> clusterrolebinding-namespace-readonly.yaml</pre></td></tr></table></figure><h5 id=\"32-绑定日志查看权限\"><a class=\"anchor\" href=\"#32-绑定日志查看权限\">#</a> 3.2 绑定日志查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-log <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-log <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-log <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-log <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"33-绑定资源查看权限\"><a class=\"anchor\" href=\"#33-绑定资源查看权限\">#</a> 3.3 绑定资源查看权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-resource-readonly <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>resource-readonly <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-resource-readonly <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>resource-readonly <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"34-绑定pod执行权限\"><a class=\"anchor\" href=\"#34-绑定pod执行权限\">#</a> 3.4 绑定 Pod 执行权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-exec <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-exec <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-exec <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-exec <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><h5 id=\"35-绑定pod删除权限\"><a class=\"anchor\" href=\"#35-绑定pod删除权限\">#</a> 3.5 绑定 Pod 删除权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>$ kubectl create rolebinding ops-pod-delete <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-delete <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectA</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>$ kubectl create rolebinding ops-pod-delete <span class=\"token parameter variable\">--clusterrole</span><span class=\"token operator\">=</span>pod-delete <span class=\"token parameter variable\">--serviceaccount</span><span class=\"token operator\">=</span>kube-users:ops <span class=\"token parameter variable\">--namespace</span><span class=\"token operator\">=</span>projectB</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/176412055.html",
            "url": "http://ixuyong.cn/posts/176412055.html",
            "title": "K8s准入控制ResourceQuota、LimitRange、QoS服务质量",
            "date_published": "2025-04-23T11:55:19.000Z",
            "content_html": "<h3 id=\"k8s准入控制resourcequota-limitrange-qos服务质量\"><a class=\"anchor\" href=\"#k8s准入控制resourcequota-limitrange-qos服务质量\">#</a> K8s 准入控制 ResourceQuota、LimitRange、QoS 服务质量</h3>\n<h4 id=\"1-resourcequota配置解析\"><a class=\"anchor\" href=\"#1-resourcequota配置解析\">#</a> 1. ResourceQuota 配置解析</h4>\n<p>ResourceQuotas 实现资源配额，避免过度创建资源，针对 namespace 进行限制。cpu 内存则是根据 pod 配置的 resources 总额进行限制，如果没有配置 resources 参数则无法限制。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: ResourceQuota</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: resourcequota-test</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: resourcequota</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  hard:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    pods: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    requests.cpu: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    requests.memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    limits.cpu: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    limits.memory: 16Gi</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    configmaps: <span class=\"token number\">201</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    requests.storage: 40Gi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    persistentvolumeclaims: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    replicationcontrollers: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    secrets: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    services: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    services.loadbalancers: <span class=\"token string\">\"2\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    services.nodeports: <span class=\"token string\">\"10\"</span></pre></td></tr></table></figure><ul>\n<li>pods：限制最多启动 Pod 的个数</li>\n<li>requests.cpu：限制最高 CPU 请求数</li>\n<li>requests.memory：限制最高内存的请求数</li>\n<li>limits.cpu：限制最高 CPU 的 limit 上限</li>\n<li>limits.memory：限制最高内存的 limit 上限</li>\n<li>services：限制 services 数量</li>\n<li>services.nodeports：限制 services 中 nodeport 类型 service 数量</li>\n<li>services.loadbalancers：限制 services 中 loadbalancers 类型 service 数量</li>\n</ul>\n<h5 id=\"11-resourcequota配置示例\"><a class=\"anchor\" href=\"#11-resourcequota配置示例\">#</a> 1.1 ResourceQuota 配置示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 限制 test 命名空间 pods 数量量为 3、configmap 数量为 2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat rq-test.yaml</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: ResourceQuota</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: resourcequota-test</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: resourcequota</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  hard:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    pods: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#    requests.cpu: 3</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#    requests.memory: 512Mi</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#    limits.cpu: 8</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#    limits.memory: 16Gi</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    configmaps: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#    requests.storage: 40Gi</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#    persistentvolumeclaims: 20</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#    replicationcontrollers: 20</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\">#    secrets: 20</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token comment\">#    services: 50</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#    services.loadbalancers: \"2\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#    services.nodeports: \"10\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#2.test 命名空间已创建 configmap 数量为 1, 限制数量为 2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get resourcequota -n test</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME                 AGE   REQUEST                      LIMIT</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>resourcequota-test   61s   configmaps: <span class=\"token number\">1</span>/2, pods: <span class=\"token number\">0</span>/3  </pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#3.test 命名空间创建第 2 个 configmap 时正常，创建第 3 个 configmap 时报错</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm rq-cm1 -n test --from-literal=key1=value1</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm rq-cm2 -n test --from-literal=key2=value2</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>error: failed to create configmap: configmaps <span class=\"token string\">\"rq-cm2\"</span> is forbidden: exceeded quota: resourcequota-test, requested: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">1</span>, used: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>, limited: <span class=\"token assign-left variable\">configmaps</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><h4 id=\"2-limitrange配置解析\"><a class=\"anchor\" href=\"#2-limitrange配置解析\">#</a> 2. LimitRange 配置解析</h4>\n<p>虽然 ResourceQuota 可以实现资源配额，可以限制某个命名空间内存和 CPU，但是如果创建的 Pod 都没有配置 resources 参数则无法限制。如果配置 LimitRange，Pod 没有配置 resources 情况下，创建的 Pod 会根据 LimitRange 配置自动添加 CPU 内存配置，并且可以限制 resources 参数最大配置和最小配置，LimitRange 针对 Pod 进行限制。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 1Gi</pre></td></tr></table></figure><ul>\n<li>default：默认 limits 配置</li>\n<li>defaultRequest：默认 requests 配置</li>\n</ul>\n<h5 id=\"21-配置默认的requests和limits\"><a class=\"anchor\" href=\"#21-配置默认的requests和limits\">#</a> 2.1 配置默认的 requests 和 limits</h5>\n<p>Pod 没有配置 resources 情况下，创建的 Pod 会根据 LimitRange 配置自动添加 CPU 内存配置。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f limitrange.yaml</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get limitrange -n test</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>NAME                  CREATED AT</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>cpu-mem-limit-range   <span class=\"token number\">2025</span>-04-23T07:55:03Z</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#2. 创建 deployment, 查看是否会根据 LimitRange 自动添加 CPU 内存配置</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-limitrange.yaml</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  name: deploy-limirange</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    app: deploy-limirange</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      app: deploy-limirange</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        app: deploy-limirange</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>        - name: deploy-limirange</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"58\"></td><td><pre></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n test</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>NAME                                READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>deploy-limirange-854c9545ff-grpxr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          39s</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pod -n test -oyaml</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>  spec:</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>    containers:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>    - image: nginx</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      name: deploy-limirange</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        limits:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          cpu: <span class=\"token string\">\"1\"</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          memory: 512Mi</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          cpu: 500m</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          memory: 256Mi</pre></td></tr><tr><td data-num=\"76\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"22-限制requests和limits范围\"><a class=\"anchor\" href=\"#22-限制requests和limits范围\">#</a> 2.2 限制 requests 和 limits 范围</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#2. 创建 deployment, CPU 内存 limits 和 requests 高于 / 低于 LimitRangeCPU 内存 max、min 配置</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy-limitrange.yaml </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  name: deploy-limirange</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    app: deploy-limirange</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      app: deploy-limirange</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        app: deploy-limirange</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>        - name: deploy-limirange</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>              memory: 8096Mi</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              cpu: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>              memory: 64Mi</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              cpu: 10m</pre></td></tr><tr><td data-num=\"60\"></td><td><pre></pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token comment\">#3. 由于创建 deployment, CPU 内存 limits 和 requests 高于 / 低于 LimitRangeCPU 内存 max、min 配置，pod 没有创建</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f deploy-limitrange.yaml </span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre></pre></td></tr><tr><td data-num=\"64\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get deploy deploy-limirange -n test</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>NAME               READY   UP-TO-DATE   AVAILABLE   AGE</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>deploy-limirange   <span class=\"token number\">0</span>/1     <span class=\"token number\">0</span>            <span class=\"token number\">0</span>           2m7s</pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n test</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe rs deploy-limirange-54c5d69b4b -n test</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>Name:           deploy-limirange-54c5d69b4b</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>Namespace:      <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Selector:       <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange,pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>Labels:         <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>                pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>Annotations:    deployment.kubernetes.io/desired-replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>                deployment.kubernetes.io/max-replicas: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>                deployment.kubernetes.io/revision: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>Controlled By:  Deployment/deploy-limirange</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>Replicas:       <span class=\"token number\">0</span> current / <span class=\"token number\">1</span> desired</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>Pods Status:    <span class=\"token number\">0</span> Running / <span class=\"token number\">0</span> Waiting / <span class=\"token number\">0</span> Succeeded / <span class=\"token number\">0</span> Failed</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>  Labels:  <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>deploy-limirange</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>           pod-template-hash<span class=\"token operator\">=</span>54c5d69b4b</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>   deploy-limirange:</pre></td></tr><tr><td data-num=\"86\"></td><td><pre>    Image:      nginx</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>    Port:       <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>    Host Port:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>    Limits:</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>      cpu:     <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>      memory:  8096Mi</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>    Requests:</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>      cpu:         10m</pre></td></tr><tr><td data-num=\"94\"></td><td><pre>      memory:      64Mi</pre></td></tr><tr><td data-num=\"95\"></td><td><pre>    Environment:   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>    Mounts:        <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>  Volumes:         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>  Node-Selectors:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>  Tolerations:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num=\"101\"></td><td><pre>  Type             Status  Reason</pre></td></tr><tr><td data-num=\"102\"></td><td><pre>  ----             ------  ------</pre></td></tr><tr><td data-num=\"103\"></td><td><pre>  ReplicaFailure   True    FailedCreate</pre></td></tr><tr><td data-num=\"104\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"105\"></td><td><pre>  Type     Reason        Age                 From                   Message</pre></td></tr><tr><td data-num=\"106\"></td><td><pre>  ----     ------        ----                ----                   -------</pre></td></tr><tr><td data-num=\"107\"></td><td><pre>  Warning  FailedCreate  3m8s                replicaset-controller  Error creating: pods <span class=\"token string\">\"deploy-limirange-54c5d69b4b-zxhzk\"</span> is forbidden: <span class=\"token punctuation\">[</span>minimum cpu usage per Container is 100m, but request is 10m, minimum memory usage per Container is 100Mi, but request is 64Mi, maximum cpu usage per Container is <span class=\"token number\">4</span>, but limit is <span class=\"token number\">5</span>, maximum memory usage per Container is 4Gi, but limit is 8096Mi<span class=\"token punctuation\">]</span></pre></td></tr></table></figure><h5 id=\"23-限制存储空间大小\"><a class=\"anchor\" href=\"#23-限制存储空间大小\">#</a> 2.3 限制存储空间大小</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 LimitRange</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 resourcequota<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat limitrange.yaml </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: LimitRange</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: cpu-mem-limit-range</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: <span class=\"token builtin class-name\">test</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  limits:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - default:         <span class=\"token comment\">#限制 CPU 内存默认 limits 配置</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      memory: 512Mi</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    defaultRequest:  <span class=\"token comment\">#限制 CPU 内存默认 request 配置</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      cpu: <span class=\"token number\">0.5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      memory: 256Mi</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    max:                <span class=\"token comment\">#限制 CPU 内存最大配置 </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      cpu: <span class=\"token string\">\"4000m\"</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      memory: 4Gi</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    min:                <span class=\"token comment\">#限制 CPU 内存最小配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      cpu: <span class=\"token string\">\"100m\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      memory: 100Mi</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    type: Container</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  - type: PersistentVolumeClaim    <span class=\"token comment\">#限制 pvc 大小</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    max:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      storage: 2Gi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    min:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      storage: 1Gi  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#2. 由于创建的 pvc 大于 2G，所以报错  </span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat pvc.yaml </span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  name: sc-pvc-001</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  storageClassName: <span class=\"token string\">\"nfs-storage\"</span>     <span class=\"token comment\"># 明确指定使用哪个 sc 的供应商来创建 pv</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    - ReadWriteMany</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      storage: 3Gi                      <span class=\"token comment\"># 根据业务实际大小进行资源申请  </span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f pvc.yaml -n test</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>Error from server <span class=\"token punctuation\">(</span>Forbidden<span class=\"token punctuation\">)</span>: error when creating <span class=\"token string\">\"pvc.yaml\"</span><span class=\"token builtin class-name\">:</span> persistentvolumeclaims <span class=\"token string\">\"sc-pvc-001\"</span> is forbidden: maximum storage usage per PersistentVolumeClaim is 2Gi, but request is 3Gi</pre></td></tr></table></figure><h4 id=\"3-服务质量-qos\"><a class=\"anchor\" href=\"#3-服务质量-qos\">#</a> 3. 服务质量 QoS</h4>\n<ul>\n<li>Guaranteed：最高服务质量，当宿主机内存不够时，会先 kill 掉 QoS 为 BestEffort 和 Burstable 的 Pod，如果内存还是不够，才会 kill 掉 QoS 为 Guaranteed，该级别 Pod 的资源占用量一般比较明确，即 requests 的 cpu 和 memory 和 limits 的 cpu 和 memory 配置的一致。</li>\n<li>Burstable： 服务质量低于 Guaranteed，当宿主机内存不够时，会先 kill 掉 QoS 为 BestEffort 的 Pod，如果内存还是不够之后就会 kill 掉 QoS 级别为 Burstable 的 Pod，用来保证 QoS 质量为 Guaranteed 的 Pod，该级别 Pod 一般知道最小资源使用量，但是当机器资源充足时，还是想尽可能的使用更多的资源，即 limits 字段的 cpu 和 memory 大于 requests 的 cpu 和 memory 的配置。</li>\n<li>BestEffort：尽力而为，当宿主机内存不够时，首先 kill 的就是该 QoS 的 Pod，用以保证 Burstable 和 Guaranteed 级别的 Pod 正常运行。</li>\n</ul>\n<h5 id=\"31-实现qos为guaranteed的pod\"><a class=\"anchor\" href=\"#31-实现qos为guaranteed的pod\">#</a> 3.1 实现 QoS 为 Guaranteed 的 Pod</h5>\n<ol>\n<li>\n<p>Pod 中的每个容器必须指定 limits.memory 和 requests.memory，并且两者需要相等；</p>\n</li>\n<li>\n<p>Pod 中的每个容器必须指定 limits.cpu 和 limits.memory，并且两者需要相等。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr></table></figure><h5 id=\"32-实现qos为burstable的pod\"><a class=\"anchor\" href=\"#32-实现qos为burstable的pod\">#</a> 3.2 实现 QoS 为 Burstable 的 Pod</h5>\n<ol>\n<li>\n<p>Pod 不符合 Guaranteed 的配置要求；</p>\n</li>\n<li>\n<p>Pod 中至少有一个容器配置了 requests.cpu 或 requests.memory。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><h5 id=\"33-实现qos为besteffort的pod\"><a class=\"anchor\" href=\"#33-实现qos为besteffort的pod\">#</a> 3.3 实现 QoS 为 BestEffort 的 Pod</h5>\n<ol>\n<li>不设置 resources 参数</li>\n</ol>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/312010518.html",
            "url": "http://ixuyong.cn/posts/312010518.html",
            "title": "K8s亲和力Affinity",
            "date_published": "2025-04-20T09:59:58.000Z",
            "content_html": "<h3 id=\"k8s亲和力affinity\"><a class=\"anchor\" href=\"#k8s亲和力affinity\">#</a> K8s 亲和力 Affinity</h3>\n<p>Pod 和节点之间的关系：</p>\n<ul>\n<li>某些 Pod 优先选择有 ssd=true 标签的节点，如果没有在考虑部署到其它节点；</li>\n<li>某些 Pod 需要部署在 ssd=true 和 type=physical 的节点上，但是优先部署在 ssd=true 的节点上。</li>\n</ul>\n<p>Pod 和 Pod 之间的关系：</p>\n<ul>\n<li>同一个应用的 Pod 不同的副本或者同一个项目的应用尽量或必须不部署在同一个节点或者符合某个标签的一类节点上或者不同的区域；</li>\n<li>相互依赖的两个 Pod 尽量或必须部署在同一个节点上或者同一个域内。</li>\n</ul>\n<h4 id=\"1-affinity分类\"><a class=\"anchor\" href=\"#1-affinity分类\">#</a> 1. Affinity 分类</h4>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/hTd0wmD.png\" alt=\"1.png\" /></p>\n<h4 id=\"2-节点亲和力配置详解\"><a class=\"anchor\" href=\"#2-节点亲和力配置详解\">#</a> 2. 节点亲和力配置详解</h4>\n<h5 id=\"21-硬亲和力required\"><a class=\"anchor\" href=\"#21-硬亲和力required\">#</a> 2.1 硬亲和力 required</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            nodeSelectorTerms:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              - matchExpressions:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                  - key: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>                      - k8s-node01</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>                      - k8s-node02</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><ul>\n<li>requiredDuringSchedulingIgnoredDuringExecution：硬亲和力配置</li>\n<li>nodeSelectorTerms：节点选择器配置，可以配置多个 matchExpressions（满足其一即可）</li>\n<li>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</li>\n<li>operator：\n<ul>\n<li>IN 相当于 key = value 的形式，<strong>NotIn 相当于 key!=value 的形式 (反亲和力)</strong></li>\n<li>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>Gt：大于 value 指定的值</li>\n<li>Lt：小于 value 指定的值</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"22-软亲和力preferred\"><a class=\"anchor\" href=\"#22-软亲和力preferred\">#</a> 2.2 软亲和力 preferred</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                  - key: ssd</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            - weight: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                  - key: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                      - k8s-master01</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><ul>\n<li>preferredDuringSchedulingIgnoredDuringExecution：软亲和力配置</li>\n<li>weight：软亲和力的权重，权重越高优先级越大，范围 1-100</li>\n<li>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</li>\n<li>operator：\n<ul>\n<li>IN 相当于 key = value 的形式，<strong>NotIn 相当于 key!=value 的形式 (反亲和力)</strong></li>\n<li>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</li>\n<li>Gt：大于 value 指定的值</li>\n<li>Lt：小于 value 指定的值</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"3-pod亲和力详解\"><a class=\"anchor\" href=\"#3-pod亲和力详解\">#</a> 3. Pod 亲和力详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAntiAffinity:   <span class=\"token comment\">#pod 硬反亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                values:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                - nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        podAntiAffinity:       <span class=\"token comment\">#pod 软反亲和力</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            podAffinityTerm:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              labelSelector:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                  values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                  - nginx-deploy</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              namespaces:     <span class=\"token comment\">#和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              - default</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr></table></figure><ul>\n<li>\n<p>labelSelector：Pod 选择器配置，可以配置多个</p>\n</li>\n<li>\n<p>matchExpressions：matchExpressions 下可以配置多个 key、values（都需要满足），其中 values 可以配置多个（满足其一即可）</p>\n</li>\n<li>\n<p>topologyKey：匹配的拓扑域的 key，也就是节点上 label 的 key，key 和 value 相同的为同一个域，可以用于标注不同的机房和地区</p>\n</li>\n<li>\n<p>Namespaces: 和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</p>\n</li>\n<li>\n<p>operator：配置和节点亲和力一致，但是没有 Gt 和 Lt</p>\n<ul>\n<li>\n<p>IN 相当于 key = value 的形式；</p>\n</li>\n<li>\n<p>Exists: 节点存在 label 的 key 为指定的值即可，不能配置 values 字段；</p>\n</li>\n<li>\n<p>DoesNotExist: 节点不存在 label 的 key 为指定的值即可，不能配置 values 字段</p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"4-节点亲和力配置示例\"><a class=\"anchor\" href=\"#4-节点亲和力配置示例\">#</a> 4. 节点亲和力配置示例</h4>\n<p>Pod 尽量部署在 ssd=true 和 type=physical 的节点上，但是优先部署在 ssd=true 的节点上，不能部署 label 为 gpu=true 的节点。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-node01 ssd=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-master01 ssd=true</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-master01 gpu=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl label nodes k8s-node02 type=physical</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      annotations:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        nodeAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                  - key: ssd</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                  - key: gpu</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>                    operator: NotIn</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>                      - <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            - weight: <span class=\"token number\">50</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              preference:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>                  - key: <span class=\"token builtin class-name\">type</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>                      - physical</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre></pre></td></tr><tr><td data-num=\"78\"></td><td><pre></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>NAME                          READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx-deploy-7d65fbdf-2b4jr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.236   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>nginx-deploy-7d65fbdf-jjzwr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.58.251   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>nginx-deploy-7d65fbdf-kx5lm   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.237   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>nginx-deploy-7d65fbdf-lrmcg   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.85.238   k8s-node01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>nginx-deploy-7d65fbdf-n6mlp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          5s    <span class=\"token number\">172.16</span>.58.250   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h4 id=\"5-pod亲和力-反亲和力配置示例\"><a class=\"anchor\" href=\"#5-pod亲和力-反亲和力配置示例\">#</a> 5. Pod 亲和力、反亲和力配置示例</h4>\n<h5 id=\"51-pod反亲和力required\"><a class=\"anchor\" href=\"#51-pod反亲和力required\">#</a> 5.1 Pod 反亲和力 required</h5>\n<p>同一个应用部署在不同的宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 节点存在污点 pod 无法调度至该节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl describe nodes|grep -i taint</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2.pod 反亲和力 required</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - labelSelector:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  - key: app</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    operator: In</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                    values:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                      - nginx-deploy</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre><span class=\"token comment\">#3. 部署 deployment</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>nginx-deploy-5787887b6f-4654b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.85.234    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>nginx-deploy-5787887b6f-8mq7s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.122.152   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>nginx-deploy-5787887b6f-fdkft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.58.247    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>nginx-deploy-5787887b6f-jzcmd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.32.152    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>nginx-deploy-5787887b6f-qdq9g   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4s    <span class=\"token number\">172.16</span>.195.14    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token comment\">#4. 将副本扩成 6 个，由于 K8s 集群只有 5 个节点，即 5 个 topologyKey（拓扑域），每个域只能有一个副本，所以有一个 pod 会 pending</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl scale deploy nginx-deploy --replicas=6 </span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>nginx-deploy-5787887b6f-4654b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.85.234    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>nginx-deploy-5787887b6f-8mq7s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.122.152   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>nginx-deploy-5787887b6f-fdkft   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.58.247    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>nginx-deploy-5787887b6f-jzcmd   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.32.152    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"85\"></td><td><pre>nginx-deploy-5787887b6f-qdq9g   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          4m44s   <span class=\"token number\">172.16</span>.195.14    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>nginx-deploy-5787887b6f-sztm7   <span class=\"token number\">0</span>/1     Pending   <span class=\"token number\">0</span>          9s      <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"87\"></td><td><pre></pre></td></tr><tr><td data-num=\"88\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl describe pods nginx-deploy-5787887b6f-sztm7</span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"90\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"91\"></td><td><pre>  Type     Reason            Age   From               Message</pre></td></tr><tr><td data-num=\"92\"></td><td><pre>  ----     ------            ----  ----               -------</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>  Warning  FailedScheduling  102s  default-scheduler  <span class=\"token number\">0</span>/5 nodes are available: <span class=\"token number\">5</span> node<span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span> didn't match pod anti-affinity rules. preemption: <span class=\"token number\">0</span>/5 nodes are available: <span class=\"token number\">5</span> No preemption victims found <span class=\"token keyword\">for</span> incoming pod.</pre></td></tr></table></figure><p><strong>将副本扩成 6 个，有一个会 pending 状态，原因 K8s 集群只有 5 个节点，即 5 个 topologyKey（拓扑域），每个拓扑域只能有一个副本，所以有一个 pod 会 pending。</strong></p>\n<p><strong>topologyKey：匹配的拓扑域的 key，也就是节点上 label 的 key，key 和 value 相同的为同一个域，可以用于标注不同的机房和地区</strong>。</p>\n<h5 id=\"52-pod反亲和力preferred\"><a class=\"anchor\" href=\"#52-pod反亲和力preferred\">#</a> 5.2 Pod 反亲和力 preferred</h5>\n<p>同一个应用尽量部署在不同的宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 节点存在污点 pod 无法调度至该节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl describe nodes|grep -i taint</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Taints:             <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2.pod 反亲和力 preferred</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  replicas: <span class=\"token number\">6</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      affinity:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        podAntiAffinity:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            - podAffinityTerm:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>                labelSelector:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>                  matchExpressions:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>                    - key: app</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                      operator: In</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                      values:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                        - nginx-deploy</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>                topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token comment\">#3. 部署 deployment</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>nginx-deploy-7c47567b79-97qs5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.122.153   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>nginx-deploy-7c47567b79-g49h4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.85.235    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>nginx-deploy-7c47567b79-g5n2s   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.58.248    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>nginx-deploy-7c47567b79-g5v5b   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.195.15    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>nginx-deploy-7c47567b79-pjwws   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.58.249    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>nginx-deploy-7c47567b79-q2hn5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6s    <span class=\"token number\">172.16</span>.32.153    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"53-pod亲和力required\"><a class=\"anchor\" href=\"#53-pod亲和力required\">#</a> 5.3 Pod 亲和力 required</h5>\n<p>同一个应用必须部署在同一个宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">8</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAffinity:   <span class=\"token comment\">#pod 硬亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          requiredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - labelSelector:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              matchExpressions:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              - key: app</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                operator: In</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                values:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                - nginx-deploy</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"47\"></td><td><pre></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl apply -f nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>nginx-deploy-dbcc4d65c-2sthn   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.255   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>nginx-deploy-dbcc4d65c-78nxf   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.197   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>nginx-deploy-dbcc4d65c-82ssq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.194   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>nginx-deploy-dbcc4d65c-986cb   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.254   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>nginx-deploy-dbcc4d65c-9rnt7   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.252   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>nginx-deploy-dbcc4d65c-knm8q   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.195   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nginx-deploy-dbcc4d65c-kx56f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.253   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>nginx-deploy-dbcc4d65c-sqlhf   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          12s   <span class=\"token number\">172.16</span>.58.198   k8s-node02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><h5 id=\"54-pod亲和力preferre\"><a class=\"anchor\" href=\"#54-pod亲和力preferre\">#</a> 5.4 Pod 亲和力 preferre</h5>\n<p>同一个应用尽量部署在同一个宿主机</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">20</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      affinity:              </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        podAffinity:       <span class=\"token comment\">#pod 软亲和力</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          preferredDuringSchedulingIgnoredDuringExecution:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          - weight: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            podAffinityTerm:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              labelSelector:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>                matchExpressions:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                - key: app</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>                  operator: In</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>                  values:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>                  - nginx-deploy</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              namespaces:     <span class=\"token comment\">#和哪个命名空间的 Pod 进行匹配，为空为当前命名空间</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              - default</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              topologyKey: kubernetes.io/hostname</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>          type: File</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3254599477.html",
            "url": "http://ixuyong.cn/posts/3254599477.html",
            "title": "K8s容忍和污点",
            "date_published": "2025-04-20T07:51:58.000Z",
            "content_html": "<h3 id=\"k8s容忍和污点\"><a class=\"anchor\" href=\"#k8s容忍和污点\">#</a> K8s 容忍和污点</h3>\n<p>Taint 指定服务器上打上污点，让不能容忍这个污点的 Pod 不能部署在打了污点的服务器上。Toleration 是让 Pod 容忍节点上配置的污点，可以让一些需要特殊配置的 Pod 能够调用到具有污点和特殊配置的节点上。</p>\n<h4 id=\"1-taint配置解析\"><a class=\"anchor\" href=\"#1-taint配置解析\">#</a> 1. Taint 配置解析</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1.Taint 语法</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes NODE_NAME TAINT_KEY=TAINT_VALUE:EFFECT</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2. 创建 Taint 示例</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#3. 查看污点</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># kubectl describe node k8s-node01 | grep Taints -A 10</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#4. 删除污点</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd-                   #基于 Key 删除</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd:PreferNoSchedule-  #基于 Key+Effect 删除</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#5. 修改污点（Key 和 Effect 相同）</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule --overwrite</span></pre></td></tr></table></figure><p>EFFECT 排斥等级：</p>\n<ul>\n<li>NoSchedule：禁止调度到该节点，已经在该节点上的 Pod 不受影响</li>\n<li>NoExecute：禁止调度到该节点，如果不符合这个污点，会立马被驱逐（或在一段时间后）</li>\n<li>PreferNoSchedule：尽量避免将 Pod 调度到指定的节点上，如果没有更合适的节点，可以部署到该节点</li>\n</ul>\n<h4 id=\"2toleration配置解析\"><a class=\"anchor\" href=\"#2toleration配置解析\">#</a> 2.Toleration 配置解析</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 完全匹配</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>- key: <span class=\"token string\">\"taintKey\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  operator: <span class=\"token string\">\"Equal\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  value: <span class=\"token string\">\"taintValue\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  effect: <span class=\"token string\">\"NoSchedule</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>#2.不完全匹配 </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>- key: \"</span>taintKey<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  operator: \"</span>Exists<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  effect: \"</span>NoSchedule<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>#3.大范围匹配（不推荐key为内置Taint，会导致节点故障pod无法漂移）</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>- key: \"</span>taintKey<span class=\"token string\">\"</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  operator: \"</span>Exists</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#4. 容忍时间配置</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>tolerations:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>- key: <span class=\"token string\">\"key1\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  operator: <span class=\"token string\">\"Equal\"</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  value: <span class=\"token string\">\"value1\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  effect: <span class=\"token string\">\"NoExecute\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  tolerationSeconds: <span class=\"token number\">3600</span></pre></td></tr></table></figure><h4 id=\"3-taint-toleration配置示例\"><a class=\"anchor\" href=\"#3-taint-toleration配置示例\">#</a> 3. Taint、Toleration 配置示例</h4>\n<p>有一个 K8s 节点是纯 SSD 硬盘的节点，现需要只有一些需要高性能存储的 Pod 才能调度到该节点上。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 给节点打上污点和标签</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl taint nodes k8s-node01 ssd=true:PreferNoSchedule</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl label node k8s-node01 ssd=true</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#2. 配置 Toleration：</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      nodeSelector:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        ssd: <span class=\"token string\">'true'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      tolerations:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>        - key: ssd</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          effect: NoSchedule</pre></td></tr></table></figure><h4 id=\"4-k8s内置污点\"><a class=\"anchor\" href=\"#4-k8s内置污点\">#</a> 4. K8s 内置污点</h4>\n<ul>\n<li><a href=\"http://node.kubernetes.io/not-ready%EF%BC%9A%E8%8A%82%E7%82%B9%E6%9C%AA%E5%87%86%E5%A4%87%E5%A5%BD%EF%BC%8C%E7%9B%B8%E5%BD%93%E4%BA%8E%E8%8A%82%E7%82%B9%E7%8A%B6%E6%80%81Ready%E7%9A%84%E5%80%BC%E4%B8%BAFalse%E3%80%82\">node.kubernetes.io/not-ready：节点未准备好，相当于节点状态 Ready 的值为 False。</a></li>\n<li><a href=\"http://node.kubernetes.io/unreachable%EF%BC%9ANode\">node.kubernetes.io/unreachable：Node</a> Controller 访问不到节点，相当于节点状态 Ready 的值为 Unknown。</li>\n<li><a href=\"http://node.kubernetes.io/out-of-disk%EF%BC%9A%E8%8A%82%E7%82%B9%E7%A3%81%E7%9B%98%E8%80%97%E5%B0%BD%E3%80%82\">node.kubernetes.io/out-of-disk：节点磁盘耗尽。</a></li>\n<li><a href=\"http://node.kubernetes.io/memory-pressure%EF%BC%9A%E8%8A%82%E7%82%B9%E5%AD%98%E5%9C%A8%E5%86%85%E5%AD%98%E5%8E%8B%E5%8A%9B%E3%80%82\">node.kubernetes.io/memory-pressure：节点存在内存压力。</a></li>\n<li><a href=\"http://node.kubernetes.io/disk-pressure%EF%BC%9A%E8%8A%82%E7%82%B9%E5%AD%98%E5%9C%A8%E7%A3%81%E7%9B%98%E5%8E%8B%E5%8A%9B%E3%80%82\">node.kubernetes.io/disk-pressure：节点存在磁盘压力。</a></li>\n<li><a href=\"http://node.kubernetes.io/network-unavailable%EF%BC%9A%E8%8A%82%E7%82%B9%E7%BD%91%E7%BB%9C%E4%B8%8D%E5%8F%AF%E8%BE%BE%E3%80%82\">node.kubernetes.io/network-unavailable：节点网络不可达。</a></li>\n<li><a href=\"http://node.kubernetes.io/unschedulable%EF%BC%9A%E8%8A%82%E7%82%B9%E4%B8%8D%E5%8F%AF%E8%B0%83%E5%BA%A6%E3%80%82\">node.kubernetes.io/unschedulable：节点不可调度。</a></li>\n<li><a href=\"http://node.cloudprovider.kubernetes.io/uninitialized%EF%BC%9A%E5%A6%82%E6%9E%9CKubelet%E5%90%AF%E5%8A%A8%E6%97%B6%E6%8C%87%E5%AE%9A%E4%BA%86%E4%B8%80%E4%B8%AA%E5%A4%96%E9%83%A8%E7%9A%84cloudprovider%EF%BC%8C%E5%AE%83%E5%B0%86%E7%BB%99%E5%BD%93%E5%89%8D%E8%8A%82%E7%82%B9%E6%B7%BB%E5%8A%A0%E4%B8%80%E4%B8%AATaint%E5%B0%86%E5%85%B6%E6%A0%87%E8%AE%B0%E4%B8%BA%E4%B8%8D%E5%8F%AF%E7%94%A8%E3%80%82%E5%9C%A8cloud-controller-manager%E7%9A%84%E4%B8%80%E4%B8%AAcontroller%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%99%E4%B8%AA%E8%8A%82%E7%82%B9%E5%90%8E%EF%BC%8CKubelet%E5%B0%86%E5%88%A0%E9%99%A4%E8%BF%99%E4%B8%AATaint%E3%80%82\">node.cloudprovider.kubernetes.io/uninitialized：如果 Kubelet 启动时指定了一个外部的 cloudprovider，它将给当前节点添加一个 Taint 将其标记为不可用。在 cloud-controller-manager 的一个 controller 初始化这个节点后，Kubelet 将删除这个 Taint。</a></li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/vO7kURL.png\" alt=\"1.png\" /></p>\n<p>Deployment 创建后 K8s 默认为 Pod 添加容忍，当 Pod 所在的节点宕机，300 秒后 pod 会漂移，默认容忍时间 300 秒。</p>\n<h4 id=\"5节点宕机快速恢复业务应用\"><a class=\"anchor\" href=\"#5节点宕机快速恢复业务应用\">#</a> 5. 节点宕机快速恢复业务应用</h4>\n<p>节点不健康，180 秒后再驱逐（默认是 300 秒）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      tolerations:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - key: node.kubernetes.io/unreachable</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          effect: NoExecute</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          tolerationSeconds: <span class=\"token number\">180</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - key: node.kubernetes.io/not-ready</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          operator: Exists</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          effect: NoExecute</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          tolerationSeconds: <span class=\"token number\">180</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3142072607.html",
            "url": "http://ixuyong.cn/posts/3142072607.html",
            "title": "K8s初始化容器、临时容器",
            "date_published": "2025-04-19T13:07:20.000Z",
            "content_html": "<h3 id=\"k8s初始化容器-临时容器\"><a class=\"anchor\" href=\"#k8s初始化容器-临时容器\">#</a> K8s 初始化容器、临时容器</h3>\n<h4 id=\"1-初始化容器\"><a class=\"anchor\" href=\"#1-初始化容器\">#</a> 1. 初始化容器</h4>\n<h5 id=\"1-1-初始化容器的用途\"><a class=\"anchor\" href=\"#1-1-初始化容器的用途\">#</a> 1. 1 初始化容器的用途</h5>\n<p>初始化容器主要是在主应用启动之前，做一些初始化的操作，比如创建文件、修改内核参数、等待依赖程序启动或其他需要在主程序启动之前需要做的工作。</p>\n<ul>\n<li>Init 容器可以包含一些安装过程中应用容器中不存在的实用工具或个性化代码；</li>\n<li>Init 容器可以安全地运行这些工具，避免这些工具导致应用镜像的安全性降低；</li>\n<li>Init 容器可以以 root 身份运行，执行一些高权限命令；</li>\n<li>Init 容器相关操作执行完成以后即退出，不会给业务容器带来安全隐患。</li>\n</ul>\n<h5 id=\"12-初始化容器和poststart区别\"><a class=\"anchor\" href=\"#12-初始化容器和poststart区别\">#</a> 1.2 初始化容器和 PostStart 区别</h5>\n<p>PostStart：依赖主应用的环境，而且并不一定先于 Command 运行。</p>\n<p>InitContainer：不依赖主应用的环境，可以有更高的权限和更多的工具，一定会在主应用启动之前完成</p>\n<h5 id=\"13-初始化容器和普通容器的区别\"><a class=\"anchor\" href=\"#13-初始化容器和普通容器的区别\">#</a> 1.3 初始化容器和普通容器的区别</h5>\n<p>Init 容器与普通的容器非常像，除了如下几点：</p>\n<ul>\n<li>\n<p>第一个 Init 容器运行成功后才会运行下一个 Init 容器；</p>\n</li>\n<li>\n<p>所有的 Init 容器运行成功后才会运行主容器；</p>\n</li>\n<li>\n<p>如果 Pod 的 Init 容器失败，Kubernetes 会不断地重启该 Pod，直到 Init 容器成功为止，但是 Pod 对应的 restartPolicy 值为 Never，Kubernetes 不会重新启动 Pod。</p>\n</li>\n<li>\n<p>Init 容器不支持 lifecycle、livenessProbe、readinessProbe 和 startupProbe</p>\n</li>\n</ul>\n<h5 id=\"14-初始化容器示例\"><a class=\"anchor\" href=\"#14-初始化容器示例\">#</a> 1.4 初始化容器示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat init.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      initContainers:           <span class=\"token comment\"># 初始化容器设定</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: fix-permissions</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command: <span class=\"token punctuation\">[</span><span class=\"token string\">\"sh\"</span>,<span class=\"token string\">\"-c\"</span>,<span class=\"token string\">\"echo hello kubernetes>/usr/share/nginx/html/index.html\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        securityContext:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          privileged: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: timezone</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: tz-config</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      - name: share-volume</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: File</pre></td></tr><tr><td data-num=\"50\"></td><td><pre></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f init.yaml</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 172.16.32.145</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>hello kubernetes</pre></td></tr></table></figure><h4 id=\"2-临时容器\"><a class=\"anchor\" href=\"#2-临时容器\">#</a> 2. 临时容器</h4>\n<h5 id=\"21-注入临时容器到pod\"><a class=\"anchor\" href=\"#21-注入临时容器到pod\">#</a> 2.1 注入临时容器到 Pod</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-7dd6cd4b44-ktw5k   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span>             16h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-7dd6cd4b44-mjcgq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>28m ago<span class=\"token punctuation\">)</span>   16h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-deploy-7dd6cd4b44-wdm6p   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>28m ago<span class=\"token punctuation\">)</span>   16h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#1. 进入容器发现 pod 没有 ps 和 netstat 命令</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it nginx-deploy-7dd6cd4b44-ktw5k  -- bash</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>root@nginx-deploy-7dd6cd4b44-ktw5k:/<span class=\"token comment\"># ps aux</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>root@nginx-deploy-7dd6cd4b44-ktw5k:/<span class=\"token comment\"># netstat -lntp</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#2. 注入临时容器至该 Pod</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl debug nginx-deploy-7dd6cd4b44-wdm6p -ti --image=registry.cn-hangzhou.aliyuncs.com/old_xu/debug-tools</span></pre></td></tr></table></figure><h5 id=\"21-注入临时容器到节点\"><a class=\"anchor\" href=\"#21-注入临时容器到节点\">#</a> 2.1 注入临时容器到节点</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl debug <span class=\"token function\">node</span> k8s-node01 <span class=\"token parameter variable\">-it</span> <span class=\"token parameter variable\">--image</span><span class=\"token operator\">=</span>registry.cn-hangzhou.aliyuncs.com/old_xu/debug-tools</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3833778957.html",
            "url": "http://ixuyong.cn/posts/3833778957.html",
            "title": "K8s计划任务Job、Cronjob",
            "date_published": "2025-04-19T13:00:21.000Z",
            "content_html": "<h3 id=\"k8s计划任务job-cronjob\"><a class=\"anchor\" href=\"#k8s计划任务job-cronjob\">#</a> K8s 计划任务 Job、Cronjob</h3>\n<h4 id=\"1-job配置参数详解\"><a class=\"anchor\" href=\"#1-job配置参数详解\">#</a> 1. Job 配置参数详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat job.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Job</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    job-name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token comment\">#suspend: true # 1.21+</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">#ttlSecondsAfterFinished: 100</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  backoffLimit: <span class=\"token number\">4</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  completions: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  parallelism: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: <span class=\"token builtin class-name\">echo</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        image: busybox</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        command:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Hello Job\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      restartPolicy: Never</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get jobs</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>NAME   STATUS     COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token builtin class-name\">echo</span>   Complete   <span class=\"token number\">1</span>/1           70s        2m5s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NAME          READY   STATUS      RESTARTS      AGE</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>echo-564c8    <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>             2m10s</pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs echo-564c8</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>Hello Job</pre></td></tr></table></figure><ul>\n<li>backoffLimit:：如果任务执行失败，失败多少次后不再执行</li>\n<li>completions：有多少个 Pod 执行成功，认为任务是成功的，默认为空和 parallelism 数值一样</li>\n<li>parallelism：并行执行任务的数量，如果 parallelism 数值大于 completions 数值，只会创建 completions 的数量；如果 completions 是 4，并发是 3，第一次会创建 3 个 Pod 执行任务，第二次只会创建一个 Pod 执行任务</li>\n<li>ttlSecondsAfterFinished：Job 在执行结束之后（状态为 completed 或 Failed）自动清理。设置为 0 表示执行结束立即删除，不设置则不会清除，需要开启 TTLAfterFinished 特性</li>\n</ul>\n<h4 id=\"2-cronjob配置参数详解\"><a class=\"anchor\" href=\"#2-cronjob配置参数详解\">#</a> 2. CronJob 配置参数详解</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat cronjob.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: batch/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: CronJob</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: hello</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  schedule: <span class=\"token string\">\"*/1 * * * *\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  concurrencyPolicy: Allow   <span class=\"token comment\">#允许同时运行多个任务</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  failedJobsHistoryLimit: <span class=\"token number\">10</span>  <span class=\"token comment\">#保留多少失败的任务</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  successfulJobsHistoryLimit: <span class=\"token number\">10</span>  <span class=\"token comment\">#保留多少已完成的任务</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token comment\">#suspend: true             #如果 true 则取消周期性执行任务</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  jobTemplate:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        spec:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>          containers:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>          - name: hello</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>            image: busybox</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>            command:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>            - <span class=\"token parameter variable\">-c</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            - <span class=\"token function\">date</span><span class=\"token punctuation\">;</span> <span class=\"token builtin class-name\">echo</span> Hello from the Kubernetes cluster</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          restartPolicy: OnFailure </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          </pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  cj</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>NAME    SCHEDULE      TIMEZONE   SUSPEND   ACTIVE   LAST SCHEDULE   AGE</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>hello   */1 * * * *   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>     False     <span class=\"token number\">0</span>        6s              81s</pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  jobs</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>NAME             STATUS     COMPLETIONS   DURATION   AGE</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>hello-29084454   Complete   <span class=\"token number\">1</span>/1           4s         72s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>hello-29084455   Complete   <span class=\"token number\">1</span>/1           5s         12s</pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get  pods</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>NAME                   READY   STATUS      RESTARTS   AGE</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>hello-29084454-hwv7p   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          78s</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>hello-29084455-vf99w   <span class=\"token number\">0</span>/1     Completed   <span class=\"token number\">0</span>          18s</pre></td></tr><tr><td data-num=\"38\"></td><td><pre></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl logs -f hello-29084455-vf99w</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Sat Apr <span class=\"token number\">19</span> <span class=\"token number\">12</span>:55:02 UTC <span class=\"token number\">2025</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>Hello from the Kubernetes cluster</pre></td></tr></table></figure><ul>\n<li>apiVersion: batch/v1beta1   #1.21+ batch/v1</li>\n<li>schedule：调度周期，和 Linux 一致，分别是分时日月周。</li>\n<li>restartPolicy：重启策略，和 Pod 一致。</li>\n<li>concurrencyPolicy：并发调度策略。可选参数如下：\n<ul>\n<li>Allow：允许同时运行多个任务。</li>\n<li>Forbid：不允许并发运行，如果之前的任务尚未完成，新的任务不会被创建。</li>\n<li>Replace：如果之前的任务尚未完成，新的任务会替换的之前的任务。</li>\n</ul>\n</li>\n<li>suspend：如果设置为 true，则暂停后续的任务，默认为 false。</li>\n<li>successfulJobsHistoryLimit：保留多少已完成的任务，按需配置。</li>\n<li>failedJobsHistoryLimit：保留多少失败的任务。</li>\n</ul>\n<p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/169153047.html",
            "url": "http://ixuyong.cn/posts/169153047.html",
            "title": "K8s持久化存储",
            "date_published": "2025-04-18T14:25:17.000Z",
            "content_html": "<h3 id=\"k8s持久化存储\"><a class=\"anchor\" href=\"#k8s持久化存储\">#</a> K8s 持久化存储</h3>\n<h4 id=\"1-volume\"><a class=\"anchor\" href=\"#1-volume\">#</a> 1. Volume</h4>\n<p>Container（容器）中的磁盘文件是短暂的，当容器崩溃时，kubelet 会重新启动容器，Container 会以最干净的状态启动，最初的文件将丢失。另外，当一个 Pod 运行多个 Container 时，各个容器可能需要共享一些文件。Kubernetes Volume 可以解决这两个问题。</p>\n<ul>\n<li>一些需要持久化数据的程序才会用到 Volumes，或者一些需要共享数据的容器需要 volumes。</li>\n<li>日志收集的需求需要在应用程序的容器里面加一个 sidecar，这个容器是一个收集日志的容器，比如 filebeat，它通过 volumes 共享应用程序的日志文件目录。</li>\n</ul>\n<h5 id=\"11-emptydir实现数据共享\"><a class=\"anchor\" href=\"#11-emptydir实现数据共享\">#</a> 1.1 EmptyDir 实现数据共享</h5>\n<p>和上述 volume 不同的是，如果删除 Pod，emptyDir 卷中的数据也将被删除，一般 emptyDir 卷用于 Pod 中的不同 Container 共享数据。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: share-volume</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            - name: share-volume</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>              mountPath: /opt</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nginx2</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          command:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>            - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            - <span class=\"token function\">sleep</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            - name: share-volume</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              mountPath: /mnt</pre></td></tr></table></figure><h5 id=\"12-volumes-hostpath挂载宿主机路径\"><a class=\"anchor\" href=\"#12-volumes-hostpath挂载宿主机路径\">#</a> 1.2 Volumes HostPath 挂载宿主机路径</h5>\n<p>hostPath 卷可将节点上的文件或目录挂载到 Pod 上，用于 Pod 自定义日志输出或访问 Docker 内部的容器等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - name: share-volume</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        emptyDir: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          - name: share-volume</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            mountPath: /opt</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx2</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          command:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>            - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>            - <span class=\"token function\">sleep</span> <span class=\"token number\">3600</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: share-volume</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /mnt</pre></td></tr></table></figure><p>hostPath 卷常用的 type（类型）如下：</p>\n<ul>\n<li>type 为空字符串：默认选项，意味着挂载 hostPath 卷之前不会执行任何检查。</li>\n<li>DirectoryOrCreate：如果给定的 path 不存在任何东西，那么将根据需要创建一个权限为 0755 的空目录，和 Kubelet 具有相同的组和权限。</li>\n<li>Directory：目录必须存在于给定的路径下。</li>\n<li>FileOrCreate：如果给定的路径不存储任何内容，则会根据需要创建一个空文件，权限设置为 0644，和 Kubelet 具有相同的组和所有权。</li>\n<li>File：文件，必须存在于给定路径中。</li>\n<li>Socket：UNIX 套接字，必须存在于给定路径中。</li>\n<li>CharDevice：字符设备，必须存在于给定路径中。</li>\n<li>BlockDevice：块设备，必须存在于给定路径中。</li>\n</ul>\n<h5 id=\"13-挂载nfs至容器\"><a class=\"anchor\" href=\"#13-挂载nfs至容器\">#</a> 1.3 挂载 NFS 至容器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 安装 nfs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># yum install nfs-utils -y       </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># mkdir /data/nfs -p</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># vim /etc/exports </span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>/data <span class=\"token number\">192.168</span>.1.0/24<span class=\"token punctuation\">(</span>rw,no_root_squash<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># exportfs -arv   </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\"># systemctl start nfs-server &amp;&amp; systemctl enable nfs-server &amp;&amp; systemctl status nfs-server </span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2. 测试客户端挂载</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># showmount -e 192.168.1.75</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># mount -t nfs 192.168.1.75:/data/nfs /mnt</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3.Deploy 挂载 NFS</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy-nfs.yaml </span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      annotations:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      - name: nfs-volume</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>        nfs:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          path: /data/nfs</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>      - name: tz-config</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>          path: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>      - name: timezone</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>        hostPath:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          path: /etc/timezone</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          type: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>          volumeMounts:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>          - name: nfs-volume</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>            mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>            mountPath: /usr/share/zoneinfo/Asia/Shanghai</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>          - name: tz-config</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            mountPath: /etc/localtime</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>          - name: timezone</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            mountPath: /etc/timezone</pre></td></tr></table></figure><h4 id=\"2-pv-pvc\"><a class=\"anchor\" href=\"#2-pv-pvc\">#</a> 2. PV、PVC</h4>\n<p>PersistentVolume：简称 PV，是由 Kubernetes 管理员设置的存储，可以配置 Ceph、NFS、GlusterFS 等常用存储配置，相对于 Volume 配置，提供了更多的功能，比如生命周期的管理、大小的限制。PV 分为静态和动态。</p>\n<p>PersistentVolumeClaim：简称 PVC，是对存储 PV 的请求，表示需要什么类型的 PV，需要存储的技术人员只需要配置 PVC 即可使用存储，或者 Volume 配置 PVC 的名称即可。</p>\n<h5 id=\"21-pv回收策略\"><a class=\"anchor\" href=\"#21-pv回收策略\">#</a> 2.1 PV 回收策略</h5>\n<ul>\n<li>Retain：保留，该策略允许手动回收资源，当删除 PVC 时，PV 仍然存在，PV 被视为已释放，管理员可以手动回收卷。</li>\n<li>Recycle：回收，如果 Volume 插件支持，Recycle 策略会对卷执行 rm -rf 清理该 PV，并使其可用于下一个新的 PVC，但是本策略将来会被弃用，目前只有 NFS 和 HostPath 支持该策略。</li>\n<li>Delete：删除，如果 Volume 插件支持，删除 PVC 时会同时删除 PV，动态卷默认为 Delete，目前支持 Delete 的存储后端包括 AWS EBS, GCE PD, Azure Disk, or OpenStack Cinder 等。</li>\n<li>可以通过 persistentVolumeReclaimPolicy: Recycle 字段配置</li>\n</ul>\n<h5 id=\"22-pv访问策略\"><a class=\"anchor\" href=\"#22-pv访问策略\">#</a> 2.2 PV 访问策略</h5>\n<ul>\n<li>ReadWriteOnce：可以被单节点以读写模式挂载，命令行中可以被缩写为 RWO。</li>\n<li>ReadOnlyMany：可以被多个节点以只读模式挂载，命令行中可以被缩写为 ROX。</li>\n<li>ReadWriteMany：可以被多个节点以读写模式挂载，命令行中可以被缩写为 RWX。</li>\n<li>ReadWriteOncePod ：只允许被单个 Pod 访问，需要 K8s 1.22 + 以上版本，并且是 CSI 创建的 PV 才可使用，缩写为 RWOP</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Volume Plugin</th>\n<th style=\"text-align:center\">ReadWriteOnce</th>\n<th style=\"text-align:center\">ReadOnlyMany</th>\n<th style=\"text-align:center\">ReadWriteMany</th>\n<th style=\"text-align:center\">ReadWriteOncePod</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">AzureFile</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CephFS</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CSI</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">depends on the driver</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FC</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">FlexVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">depends on the driver</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">HostPath</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">iSCSI</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">NFS</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">RBD</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">VsphereVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">- (works when Pods are collocated)</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">PortworxVolume</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n<td style=\"text-align:center\">✓</td>\n<td style=\"text-align:center\">-</td>\n</tr>\n</tbody>\n</table>\n<h5 id=\"23-存储分类\"><a class=\"anchor\" href=\"#23-存储分类\">#</a> 2.3 存储分类</h5>\n<ul>\n<li>文件存储：一些数据可能需要被多个节点使用，比如用户的头像、用户上传的文件等，实现方式：NFS、NAS、FTP、CephFS 等。</li>\n<li>块存储：一些数据只能被一个节点使用，或者是需要将一块裸盘整个挂载使用，比如数据库、Redis 等，实现方式：Ceph、GlusterFS、公有云。</li>\n<li>对象存储：由程序代码直接实现的一种存储方式，云原生应用无状态化常用的实现方式，实现方式：一般是符合 S3 协议的云存储，比如 AWS 的 S3 存储、Minio、七牛云等。</li>\n</ul>\n<h5 id=\"24-pv配置示例nfs\"><a class=\"anchor\" href=\"#24-pv配置示例nfs\">#</a> 2.4 PV 配置示例 NFS</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nfs-pv1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  capacity:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    storage: 5Gi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  volumeMode: Filesystem</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  persistentVolumeReclaimPolicy: Retain</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  storageClassName: nfs-slow</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  nfs:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    path: /data/pv1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    server: <span class=\"token number\">192.168</span>.1.75</pre></td></tr></table></figure><p>capacity：容量配置</p>\n<p>volumeMode：卷的模式，目前支持 Filesystem（文件系统） 和 Block（块），其中 Block 类型需要后端存储支持，默认为文件系统</p>\n<p>accessModes：该 PV 的访问模式</p>\n<p>storageClassName：PV 的类，一个特定类型的 PV 只能绑定到特定类别的 PVC；</p>\n<p>persistentVolumeReclaimPolicy：回收策略</p>\n<p>mountOptions：非必须，新版本中已弃用</p>\n<p>nfs：NFS 服务配置，包括以下两个选项</p>\n<ul>\n<li>path：NFS 上的共享目录</li>\n<li>server：NFS 的 IP 地址</li>\n</ul>\n<h5 id=\"25-pv配置示例hostpath\"><a class=\"anchor\" href=\"#25-pv配置示例hostpath\">#</a> 2.5 PV 配置示例 HostPath</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolume</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: hostpath</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  capacity:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    storage: 5Gi</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  volumeMode: Filesystem</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  persistentVolumeReclaimPolicy: Retain</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  storageClassName: hostpath</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  hostPath:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    path: <span class=\"token string\">\"/mnt/data\"</span></pre></td></tr></table></figure><p>hostPath：hostPath 服务配置</p>\n<ul>\n<li>path：宿主机路径</li>\n</ul>\n<h5 id=\"26-pv的状态\"><a class=\"anchor\" href=\"#26-pv的状态\">#</a> 2.6 PV 的状态</h5>\n<ul>\n<li>Available：可用，没有被 PVC 绑定的空闲资源。</li>\n<li>Bound：已绑定，已经被 PVC 绑定。</li>\n<li>Released：已释放，PVC 被删除，但是资源还未被重新使用。</li>\n<li>Failed：失败，自动回收失败。</li>\n</ul>\n<h5 id=\"27-pvc绑定pv\"><a class=\"anchor\" href=\"#27-pvc绑定pv\">#</a> 2.7 PVC 绑定 PV</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: PersistentVolumeClaim</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nfs-pvc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  storageClassName: nfs-slow</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  accessModes:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - ReadWriteOnce</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  resources:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    requests:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      storage: 5Gi</pre></td></tr></table></figure><ul>\n<li>PVC 的空间申请大小≤PV 的大小</li>\n<li>PVC 的 StorageClassName 和 PV 的一致</li>\n<li>PVC 的 accessModes 和 PV 的一致</li>\n</ul>\n<h5 id=\"28-depoyment挂载pvc\"><a class=\"anchor\" href=\"#28-depoyment挂载pvc\">#</a> 2.8 Depoyment 挂载 PVC</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      - name: nfs-pvc-storage  <span class=\"token comment\">#volume 名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        persistentVolumeClaim:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          claimName: nfs-pvc   <span class=\"token comment\">#PVC 名称</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>         - name: nfs-pvc-storage</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr></table></figure><p>挂载 PVC 的 Pod 一直处于 Pending：</p>\n<ul>\n<li>PVC 没有创建成功或 PVC 不存在</li>\n<li>PVC 和 Pod 不在同一个 Namespace</li>\n</ul>\n<p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3992668367.html",
            "url": "http://ixuyong.cn/posts/3992668367.html",
            "title": "K8s配置管理Configmap",
            "date_published": "2025-04-14T13:47:47.000Z",
            "content_html": "<h3 id=\"k8s配置管理configmap\"><a class=\"anchor\" href=\"#k8s配置管理configmap\">#</a> K8s 配置管理 Configmap</h3>\n<h4 id=\"1-configmap\"><a class=\"anchor\" href=\"#1-configmap\">#</a> 1. Configmap</h4>\n<h5 id=\"1-1-基于from-env-file创建configmap\"><a class=\"anchor\" href=\"#1-1-基于from-env-file创建configmap\">#</a> 1. 1 基于 from-env-file 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat cm_env.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">podname</span><span class=\"token operator\">=</span>nf-flms-system</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">podip</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.100</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">env</span><span class=\"token operator\">=</span>prod</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">nacosaddr</span><span class=\"token operator\">=</span>nacos.svc.cluster.local</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#kubectl create cm cmenv --from-env-file=./cm_env.conf</span></pre></td></tr></table></figure><h5 id=\"12-基于from-literal创建configmap\"><a class=\"anchor\" href=\"#12-基于from-literal创建configmap\">#</a> 1.2 基于 from-literal 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create cm cmliteral --from-literal=level=INFO --from-literal=passwd=Superman*2023</span></pre></td></tr></table></figure><h5 id=\"13-基于from-file创建configmap\"><a class=\"anchor\" href=\"#13-基于from-file创建configmap\">#</a> 1.3 基于 from-file 创建 Configmap</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat s.hmallleasing.com.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>        proxy_pass http://192.168.1.134<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        proxy_set_header Host <span class=\"token variable\">$http_host</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>        proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\"># kubectl create cm nginxconfig --from-file=./s.hmallleasing.com.conf</span></pre></td></tr></table></figure><h5 id=\"14-deployment挂载configmap示例\"><a class=\"anchor\" href=\"#14-deployment挂载configmap示例\">#</a> 1.4 Deployment 挂载 configmap 示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr></table></figure><h5 id=\"15-重命名挂载的configmaq-key的名称\"><a class=\"anchor\" href=\"#15-重命名挂载的configmaq-key的名称\">#</a> 1.5 重命名挂载的 configmaq key 的名称</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          items:                <span class=\"token comment\"># 重命名挂载的 configmaq key 的名称为 nginx.conf</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - key: s.hmallleasing.com.conf  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            path: nginx.conf</pre></td></tr><tr><td data-num=\"51\"></td><td><pre> </pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\">#查看挂载的 configmaq key 的名称重命名为 nginx.conf</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>NAME                           READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>nginx-deploy-bc476bc56-flln4   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>nginx-deploy-bc476bc56-jhsh6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>nginx-deploy-bc476bc56-splv9   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          10h</pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl exec -it nginx-deploy-bc476bc56-flln4 -- bash</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>root@nginx-deploy-bc476bc56-flln4:/<span class=\"token comment\"># ls /etc/nginx/conf.d/</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>nginx.conf</pre></td></tr></table></figure><h5 id=\"16-修改挂载的configmaq-权限\"><a class=\"anchor\" href=\"#16-修改挂载的configmaq-权限\">#</a> 1.6 修改挂载的 configmaq 权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        envFrom:         <span class=\"token comment\"># 1. 批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># 2. 自定义环境变量</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># 3. 挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>        volumeMounts:              </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>        - name: nginx-config</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/conf.d\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>          readOnly: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      - name: nginx-config</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          name: nginxconfig      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>          items:                <span class=\"token comment\"># 重命名挂载的 configmaq key 的名称为 nginx.conf</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>          - key: s.hmallleasing.com.conf  </pre></td></tr><tr><td data-num=\"50\"></td><td><pre>            path: nginx.conf</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>            mode: 0644        <span class=\"token comment\"># 配置挂载权限，针对单个 key 生效</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>          defaultMode: 0666   <span class=\"token comment\"># 配置挂载权限，针对整个 key 生效</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>    </pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\">#查看挂载权限</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>root@nginx-deploy-7657fbffc7-k75l5:/<span class=\"token comment\"># ls -l /etc/nginx/conf.d/nginx.conf </span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>lrwxrwxrwx <span class=\"token number\">1</span> root root <span class=\"token number\">17</span> Apr <span class=\"token number\">16</span> <span class=\"token number\">13</span>:37 /etc/nginx/conf.d/nginx.conf -<span class=\"token operator\">></span> <span class=\"token punctuation\">..</span>data/nginx.conf</pre></td></tr><tr><td data-num=\"57\"></td><td><pre>root@nginx-deploy-7657fbffc7-k75l5:/<span class=\"token comment\"># ls -l /etc/nginx/conf.d/..data/nginx.conf </span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>-rw-rw-rw- <span class=\"token number\">1</span> root root <span class=\"token number\">722</span> Apr <span class=\"token number\">16</span> <span class=\"token number\">13</span>:37 /etc/nginx/conf.d/<span class=\"token punctuation\">..</span>data/nginx.conf</pre></td></tr></table></figure><h5 id=\"17-subpath解决挂载覆盖问题\"><a class=\"anchor\" href=\"#17-subpath解决挂载覆盖问题\">#</a> 1.7 subpath 解决挂载覆盖问题</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 创建 configmap</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>user  nginx<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>worker_processes  <span class=\"token number\">1</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>error_log  /var/log/nginx/error.log warn<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>pid        /var/run/nginx.pid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>events <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    worker_connections  <span class=\"token number\">512</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>http <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    include       /etc/nginx/mime.types<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    default_type  application/octet-stream<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    log_format  main  <span class=\"token string\">'$remote_addr - $remote_user [$time_local] \"$request\" '</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                      <span class=\"token string\">'$status $body_bytes_sent \"$http_referer\" '</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>                      <span class=\"token string\">'\"$http_user_agent\" \"$http_x_forwarded_for\"'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    access_log  /var/log/nginx/access.log  main<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    sendfile        on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token comment\">#tcp_nopush     on;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    keepalive_timeout  <span class=\"token number\">65</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token comment\">#gzip  on;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    include /etc/nginx/conf.d/*.conf<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 cm<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create cm nginx-config --from-file=./nginx.conf</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">#subpath 解决挂载覆盖问题</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 study<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cm-deploy.yaml </span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"56\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"57\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"63\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"65\"></td><td><pre>        envFrom:         <span class=\"token comment\"># ①批量挂载 ConfigMap 生成环境变量</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>        - configMapRef:</pre></td></tr><tr><td data-num=\"67\"></td><td><pre>            name: cmenv</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>        env:</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>        - name: MYSQL_ADDR     <span class=\"token comment\"># ②自定义环境变量</span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>          value: <span class=\"token string\">\"192.168.40.150\"</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>        - name: MYSQL_PASSWD</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>          value: Superman*2022</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>        - name: LOG_LEVEL           <span class=\"token comment\"># ③挂载单个 ConfigMap 生成环境变量，这里和 ConfigMap 中的键名是不一样的     </span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"75\"></td><td><pre>            configMapKeyRef:</pre></td></tr><tr><td data-num=\"76\"></td><td><pre>              name: cmliteral       <span class=\"token comment\"># 这个值来自 ConfigMap</span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>              key: level            <span class=\"token comment\"># 来自 ConfigMap 的 key</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"79\"></td><td><pre>        - name: config</pre></td></tr><tr><td data-num=\"80\"></td><td><pre>          mountPath: <span class=\"token string\">\"/etc/nginx/nginx.conf\"</span>   <span class=\"token comment\">#只挂在 nginx.conf 一个文件，不覆盖目录</span></pre></td></tr><tr><td data-num=\"81\"></td><td><pre>          subPath: nginx.conf      </pre></td></tr><tr><td data-num=\"82\"></td><td><pre>      volumes:</pre></td></tr><tr><td data-num=\"83\"></td><td><pre>      - name: config</pre></td></tr><tr><td data-num=\"84\"></td><td><pre>        configMap:</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>          name: nginx-config      <span class=\"token comment\"># 提供你想要挂载的 ConfigMap 的名字</span></pre></td></tr></table></figure><h4 id=\"2-secret\"><a class=\"anchor\" href=\"#2-secret\">#</a> 2. Secret</h4>\n<h5 id=\"21-secret拉取私有仓库镜像\"><a class=\"anchor\" href=\"#21-secret拉取私有仓库镜像\">#</a> 2.1 Secret 拉取私有仓库镜像</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create secret docker-registry harboradmin \\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--docker-server<span class=\"token operator\">=</span>s.hmallleasing.com <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>--docker-username<span class=\"token operator\">=</span>admin <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>--docker-password<span class=\"token operator\">=</span>Superman*2023</pre></td></tr></table></figure><h5 id=\"22-创建ssl-secret\"><a class=\"anchor\" href=\"#22-创建ssl-secret\">#</a> 2.2 创建 ssl Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create secret tls dev.hmallleasig.com --key *.hmallleasing.com_key.key --cert *.hmallleasing.com_chain.crt -n dev</span></pre></td></tr></table></figure><h5 id=\"23-基于命令创建generic-secret\"><a class=\"anchor\" href=\"#23-基于命令创建generic-secret\">#</a> 2.3 基于命令创建 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 通过 from-env-file 创建</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># cat db.conf </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">username</span><span class=\"token operator\">=</span>xuyong</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">passwd</span><span class=\"token operator\">=</span>Superman*2023</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># kubectl create secret generic dbconf --from-env-file=./db.conf</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#2. 通过 from-literal 创建</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kubectl create secret generic db-user-pass <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    --from-literal<span class=\"token operator\">=</span>username<span class=\"token operator\">=</span>admin <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    --from-literal<span class=\"token operator\">=</span>password<span class=\"token operator\">=</span><span class=\"token string\">'S!B\\*d$zDsb='</span></pre></td></tr></table></figure><h5 id=\"24-secret加密-解密\"><a class=\"anchor\" href=\"#24-secret加密-解密\">#</a> 2.4 Secret 加密、解密</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1</span>.加密</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># echo -n \"Superman*2023\" | base64</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">U3VwZXJtYW4qMjAyMw</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>.解密</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># echo \"U3VwZXJtYW4qMjAyMw==\" | base64 --decode</span></pre></td></tr></table></figure><h5 id=\"25-基于文件创建非加密generic-secret\"><a class=\"anchor\" href=\"#25-基于文件创建非加密generic-secret\">#</a> 2.5 基于文件创建非加密 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get secret dbconf -oyaml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  passwd: <span class=\"token assign-left variable\">U3VwZXJtYW4qMjAyMw</span><span class=\"token operator\">==</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  username: eHV5b25n</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  name: dbconf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h5 id=\"2-6-基于yaml创建加密generic-secret\"><a class=\"anchor\" href=\"#2-6-基于yaml创建加密generic-secret\">#</a> 2. 6 基于 yaml 创建加密 generic Secret</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat mysql-secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Secret</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: mysql-secret</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  namespace: dev</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>stringData:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  MYSQL_ROOT_PASSWORD: Superman*2023</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>type: Opaque</pre></td></tr></table></figure><h5 id=\"27-deployment挂载secret示例\"><a class=\"anchor\" href=\"#27-deployment挂载secret示例\">#</a> 2.7 Deployment 挂载 Secret 示例</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 study<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat cm-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      imagePullSecrets:        </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      - name: harboradmin</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      - image: nginx</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        name: nginx</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        - name: http</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>          protocol: TCP</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        - name: MYSQL_ROOT_PASSWORD  </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>          valueFrom:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            secretKeyRef:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>              name: mysql-secret</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              key: MYSQL_ROOT_PASSWORD</pre></td></tr></table></figure><h4 id=\"3-configmapsecret热更新\"><a class=\"anchor\" href=\"#3-configmapsecret热更新\">#</a> 3. ConfigMap&amp;Secret 热更新</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl create cm nginxconfig --from-file=nginx.conf --dry-run=client -oyaml | kubectl replace -f -</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/858611107.html",
            "url": "http://ixuyong.cn/posts/858611107.html",
            "title": "K8s服务发布Service",
            "date_published": "2025-04-14T11:25:51.000Z",
            "content_html": "<h3 id=\"k8s服务发布service\"><a class=\"anchor\" href=\"#k8s服务发布service\">#</a> K8s 服务发布 Service</h3>\n<h4 id=\"1-service类型\"><a class=\"anchor\" href=\"#1-service类型\">#</a> 1. Service 类型</h4>\n<p>Kubernetes Service Type（服务类型）主要包括以下几种：</p>\n<ul>\n<li>ClusterIP：在集群内部使用，默认值，只能从集群中访问。</li>\n<li>NodePort：在所有安装了 Kube-Proxy 的节点上打开一个端口，此端口可以代理至后端 Pod，可以通过 NodePort 从集群外部访问集群内的服务，格式为 NodeIP:NodePort。</li>\n<li>LoadBalancer：使用云提供商的负载均衡器公开服务，成本较高。</li>\n<li>ExternalName：通过返回定义的 CNAME 别名，没有设置任何类型的代理，需要 1.7 或更高版本 kube-dns 支持。</li>\n</ul>\n<h5 id=\"11-nodeport类型\"><a class=\"anchor\" href=\"#11-nodeport类型\">#</a> 1.1 NodePort 类型</h5>\n<p>如果将 Service 的 type 字段设置为 NodePort，则 Kubernetes 将从 --service-node-port-range 参数指定的范围（默认为 30000-32767）中自动分配端口，也可以手动指定 NodePort，创建该 Service 后，集群每个节点都将暴露一个端口，通过某个宿主机的 IP + 端口即可访问到后端的应用。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: NodePort</pre></td></tr></table></figure><h5 id=\"12-clusterip类型\"><a class=\"anchor\" href=\"#12-clusterip类型\">#</a> 1.2 ClusterIP 类型</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  type: ClusterIP</pre></td></tr></table></figure><h5 id=\"13-使用service代理k8s外部服务\"><a class=\"anchor\" href=\"#13-使用service代理k8s外部服务\">#</a> 1.3 使用 Service 代理 K8s 外部服务</h5>\n<p>使用场景：</p>\n<ul>\n<li>希望在生产环境中使用某个固定的名称而非 IP 地址访问外部的中间件服务；</li>\n<li>希望 Service 指向另一个 Namespace 中或其他集群中的服务；</li>\n<li>正在将工作负载转移到 Kubernetes 集群，但是一部分服务仍运行在 Kubernetes 集群之外的 backend。</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    app: mysql-svc-external</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  name: mysql-svc-external</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    port: <span class=\"token number\">3306</span> </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    targetPort: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kind: Endpoints</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    app: mysql-svc-external</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: mysql-svc-external</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>subsets:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>- addresses:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  - ip: <span class=\"token number\">192.168</span>.40.150</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  - name: mysql</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    protocol: TCP</pre></td></tr></table></figure><h5 id=\"14-externalname-service\"><a class=\"anchor\" href=\"#14-externalname-service\">#</a> 1.4 ExternalName Service</h5>\n<p>ExternalName Service 是 Service 的特例，它没有 Selector，也没有定义任何端口和 Endpoint，它通过返回该外部服务的别名来提供服务。</p>\n<p>比如可以定义一个 Service，后端设置为一个外部域名，这样通过 Service 的名称即可访问到该域名。使用 nslookup 解析以下文件定义的 Service，集群的 DNS <a href=\"http://xn--my-uu2cmg2cx7mswf9rko5lsx1a5n3h.database.example.com\">服务将返回一个值为 my.database.example.com</a> 的 CNAME 记录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: my-service</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: prod</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  type: ExternalName</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  externalName: my.database.example.com</pre></td></tr></table></figure><h5 id=\"15-多端口-service\"><a class=\"anchor\" href=\"#15-多端口-service\">#</a> 1.5 多端口 Service</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-svc</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - port: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      targetPort: <span class=\"token number\">443</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      name: https</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  type: ClusterIP</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/108692210.html",
            "url": "http://ixuyong.cn/posts/108692210.html",
            "title": "K8s资源调度deployment、statefulset、daemonset",
            "date_published": "2025-04-14T11:25:00.000Z",
            "content_html": "<h3 id=\"k8s资源调度deployment-statefulset-daemonset\"><a class=\"anchor\" href=\"#k8s资源调度deployment-statefulset-daemonset\">#</a> K8s 资源调度 deployment、statefulset、daemonset</h3>\n<h4 id=\"1-无状态应用管理-deployment\"><a class=\"anchor\" href=\"#1-无状态应用管理-deployment\">#</a> 1. 无状态应用管理 Deployment</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          image: nginx:1.21.0</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><p>示例解析：</p>\n<ol>\n<li>\n<p>nginx-deploy：Deployment 的名称；</p>\n</li>\n<li>\n<p>replicas： 创建 Pod 的副本数；</p>\n</li>\n<li>\n<p>selector：定义 Deployment 如何找到要管理的 Pod，与 template 的 label（标签）对应，apiVersion 为 apps/v1 必须指定该字段；</p>\n</li>\n<li>\n<p>template 字段包含以下字段：</p>\n<ul>\n<li>\n<p>app: nginx-deploy 使用 label（标签）标记 Pod；</p>\n</li>\n<li>\n<p>spec：表示 Pod 运行一个名字为 nginx 的容器；</p>\n</li>\n<li>\n<p>image：运行此 Pod 使用的镜像；</p>\n</li>\n<li>\n<p>Port：容器用于发送和接收流量的端口。</p>\n</li>\n</ul>\n</li>\n</ol>\n<h5 id=\"11-更新-deployment\"><a class=\"anchor\" href=\"#11-更新-deployment\">#</a> 1.1 更新 Deployment</h5>\n<p>假如更新 Nginx Pod 的 image 使用 nginx:latest，并使用 --record 记录当前更改的参数，后期回滚时可以查看到对应的信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:latest --record</span></pre></td></tr></table></figure><p>更新过程为新旧交替更新，首先新建一个 Pod，当 Pod 状态为 Running 时，删除一个旧的 Pod，同时再创建一个新的 Pod。当触发一个更新后，会有新的 ReplicaSet 产生，旧的 ReplicaSet 会被保存，查看此时 ReplicaSet，可以从 AGE 或 READY 看出来新旧 ReplicaSet：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get rs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                      DESIRED   CURRENT   READY   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-65bfb77869   <span class=\"token number\">0</span>         <span class=\"token number\">0</span>         <span class=\"token number\">0</span>       50s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-85b94dddb4   <span class=\"token number\">3</span>         <span class=\"token number\">3</span>         <span class=\"token number\">3</span>       8s</pre></td></tr></table></figure><p>通过 describe 查看 Deployment 的详细信息：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl describe deploy nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Name:                   nginx-deploy</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Namespace:              default</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>CreationTimestamp:      Mon, <span class=\"token number\">14</span> Apr <span class=\"token number\">2025</span> <span class=\"token number\">11</span>:28:03 +0800</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Labels:                 <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Annotations:            app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                        deployment.kubernetes.io/revision: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>                        kubernetes.io/change-cause: kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Selector:               <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Replicas:               <span class=\"token number\">3</span> desired <span class=\"token operator\">|</span> <span class=\"token number\">3</span> updated <span class=\"token operator\">|</span> <span class=\"token number\">3</span> total <span class=\"token operator\">|</span> <span class=\"token number\">3</span> available <span class=\"token operator\">|</span> <span class=\"token number\">0</span> unavailable</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>StrategyType:           RollingUpdate</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>MinReadySeconds:        <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>RollingUpdateStrategy:  <span class=\"token number\">25</span>% max unavailable, <span class=\"token number\">25</span>% max surge</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Labels:  <span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>   nginx-deploy:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    Image:         nginx:latest</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    Port:          <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    Host Port:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    Environment:   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    Mounts:        <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  Volumes:         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  Node-Selectors:  <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  Tolerations:     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Conditions:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  Type           Status  Reason</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  ----           ------  ------</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  Available      True    MinimumReplicasAvailable</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  Progressing    True    NewReplicaSetAvailable</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>OldReplicaSets:  nginx-deploy-65bfb77869 <span class=\"token punctuation\">(</span><span class=\"token number\">0</span>/0 replicas created<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>NewReplicaSet:   nginx-deploy-85b94dddb4 <span class=\"token punctuation\">(</span><span class=\"token number\">3</span>/3 replicas created<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>Events:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  Type    Reason             Age   From                   Message</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  ----    ------             ----  ----                   -------</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  Normal  ScalingReplicaSet  71s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">0</span> to <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  Normal  ScalingReplicaSet  29s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">0</span> to <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  Normal  ScalingReplicaSet  28s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">3</span> to <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  Normal  ScalingReplicaSet  28s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">1</span> to <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">2</span> to <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  Normal  ScalingReplicaSet  27s   deployment-controller  Scaled up replica <span class=\"token builtin class-name\">set</span> nginx-deploy-85b94dddb4 from <span class=\"token number\">2</span> to <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  Normal  ScalingReplicaSet  26s   deployment-controller  Scaled down replica <span class=\"token builtin class-name\">set</span> nginx-deploy-65bfb77869 from <span class=\"token number\">1</span> to <span class=\"token number\">0</span></pre></td></tr></table></figure><p>在 describe 中可以看出，第一次创建时，它创建了一个名为 nginx-deploy-65bfb77869 的 ReplicaSet，并直接将其扩展为 3 个副本。更新部署时，它创建了一个新的 ReplicaSet，命名为 nginx-deploy-85b94dddb4，并将其副本数扩展为 1，然后将旧的 ReplicaSet 缩小为 2，这样至少可以有 2 个 Pod 可用，最多创建了 4 个 Pod。以此类推，使用相同的滚动更新策略向上和向下扩展新旧 ReplicaSet，最终新的 ReplicaSet 可以拥有 3 个副本，并将旧的 ReplicaSet 缩小为 0。</p>\n<h5 id=\"12-回滚-deployment\"><a class=\"anchor\" href=\"#12-回滚-deployment\">#</a> 1.2 回滚 Deployment</h5>\n<p>当更新了版本不稳定或配置不合理时，可以对其进行回滚操作，假设我们又进行了几次更新（此处以更新镜像版本触发更新，更改配置效果类似）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.1 --record</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.2 --record</span></pre></td></tr></table></figure><p>使用 kubectl rollout history 查看更新历史：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1</span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">3</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.1 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">4</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><p>查看 Deployment 某次更新的详细信息，使用 --revision 指定某次更新版本号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy --revision=4</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy with revision <span class=\"token comment\">#4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Pod Template:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  Labels:\t<span class=\"token assign-left variable\">app</span><span class=\"token operator\">=</span>nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tpod-template-hash<span class=\"token operator\">=</span>65b576b795</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  Annotations:\tkubernetes.io/change-cause: kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  Containers:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   nginx-deploy:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    Image:\tnginx:1.21.2</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    Port:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Host Port:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    Environment:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    Mounts:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  Volumes:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  Node-Selectors:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  Tolerations:\t<span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><p>如果只需要回滚到上一个稳定版本，使用 kubectl rollout undo 即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo deployment nginx-deploy</span></pre></td></tr></table></figure><p>再次查看更新历史，发现 REVISION3 回到了 nginx:1.21.1：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout history deployment nginx-deploy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>deployment.apps/nginx-deploy </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>REVISION  CHANGE-CAUSE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">1</span>         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:latest <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">4</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.2 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">5</span>         kubectl <span class=\"token builtin class-name\">set</span> image deployment nginx-deploy nginx-deploy<span class=\"token operator\">=</span>nginx:1.21.1 <span class=\"token parameter variable\">--record</span><span class=\"token operator\">=</span>true</pre></td></tr></table></figure><p>如果要回滚到指定版本，使用 --to-revision 参数：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo deployment nginx-deploy --to-revision=2</span></pre></td></tr></table></figure><h5 id=\"13-扩容-deployment\"><a class=\"anchor\" href=\"#13-扩容-deployment\">#</a> 1.3 扩容 Deployment</h5>\n<p>当公司访问量变大，或者有预期内的活动时，三个 Pod 可能已无法支撑业务时，可以提前对其进行扩展。</p>\n<p>使用 kubectl scale 动态调整 Pod 的副本数，比如增加 Pod 为 5 个：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl scale deployment nginx-deploy --replicas=5</span></pre></td></tr></table></figure><p>查看 Pod，此时 Pod 已经变成了 5 个：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                            READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-deploy-85b94dddb4-2qrh6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m9s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-deploy-85b94dddb4-gvkqj   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m10s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-deploy-85b94dddb4-mdfjs   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          22s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-deploy-85b94dddb4-rhgpr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          2m8s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-deploy-85b94dddb4-vwjhl   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          22s</pre></td></tr></table></figure><h5 id=\"14-暂停和恢复-deployment-更新\"><a class=\"anchor\" href=\"#14-暂停和恢复-deployment-更新\">#</a> 1.4 暂停和恢复 Deployment 更新</h5>\n<p>上述演示的均为更改某一处的配置，更改后立即触发更新，大多数情况下可能需要针对一个资源文件更改多处地方，而并不需要多次触发更新，此时可以使用 Deployment 暂停功能，临时禁用更新操作，对 Deployment 进行多次修改后在进行更新。</p>\n<p>使用 kubectl rollout pause 命令即可暂停 Deployment 更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout pause deployment nginx-deploy</span></pre></td></tr></table></figure><p>然后对 Deployment 进行相关更新操作，比如先更新镜像，然后对其资源进行限制（如果使用的是 kubectl edit 命令，可以直接进行多次修改，无需暂停更新，kubectlset 命令一般会集成在 CICD 流水线中）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image deployment nginx-deploy nginx-deploy=nginx:1.21.3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl set resources deployment nginx-deploy -c=nginx-deploy --limits=cpu=200m,memory=512Mi</span></pre></td></tr></table></figure><p>通过 rollout history 可以看到没有新的更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#  kubectl rollout history deployment nginx-deploy</span></pre></td></tr></table></figure><p>进行完最后一处配置更改后，使用 kubectl rollout resume 恢复 Deployment 更新：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl rollout resume deployment nginx-deploy</span></pre></td></tr></table></figure><p>可以查看到恢复更新的 Deployment 创建了一个新的 RS（ReplicaSet 缩写）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get rs</span></pre></td></tr></table></figure><p>可以查看 Deployment 的 image（镜像）已经变为 nginx:1.21.3</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -oyaml|grep image</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      image: docker.io/library/nginx:1.21.3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:644a70516a26004c97d0d85c7fe1d0c3a67ea8ab7ddf4aff193d9f301670cf36</pre></td></tr></table></figure><h5 id=\"15-更新-deployment-的注意事项\"><a class=\"anchor\" href=\"#15-更新-deployment-的注意事项\">#</a> 1.5 更新 Deployment 的注意事项</h5>\n<p>在默认情况下，revision 保留 10 个旧的 ReplicaSet，其余的将在后台进行垃圾回收，可以在.spec.revisionHistoryLimit 设置保留 ReplicaSet 的个数。当设置为 0 时，不保留历史记录。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  replicas: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          image: nginx:1.21.3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              cpu: 200m</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>              memory: 512Mi</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  strategy:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      maxUnavailable: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      maxSurge: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  revisionHistoryLimit: <span class=\"token number\">10</span></pre></td></tr></table></figure><p>更新策略：</p>\n<ul>\n<li>spec.strategy.type==Recreate，表示重建，先删掉旧的 Pod 再创建新的 Pod；</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>strategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: Recreate</pre></td></tr></table></figure><ul>\n<li>\n<p>spec.strategy.type==RollingUpdate，表示滚动更新，可以指定 maxUnavailable 和 maxSurge 来控制滚动更新过程；</p>\n<ul>\n<li>\n<p>spec.strategy.rollingUpdate.maxUnavailable，指定在回滚更新时最大不可用的 Pod 数量，可选字段，默认为 25%，可以设置为数字或百分比，如果 maxSurge 为 0，则该值不能为 0；</p>\n</li>\n<li>\n<p>spec.strategy.rollingUpdate.maxSurge 可以超过期望值的最大 Pod 数，可选字段，默认为 25%，可以设置成数字或百分比，如果 maxUnavailable 为 0，则该值不能为 0。</p>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>strategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      maxUnavailable: <span class=\"token number\">25</span>%</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      maxSurge: <span class=\"token number\">25</span>%</pre></td></tr></table></figure><h4 id=\"2-有状态应用管理-statefulset\"><a class=\"anchor\" href=\"#2-有状态应用管理-statefulset\">#</a> 2. 有状态应用管理 StatefulSet</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      app: nginx</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        app: nginx</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>        - name: nginx</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              cpu: <span class=\"token string\">'1'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              memory: 1Gi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              cpu: 100m</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>  serviceName: web</pre></td></tr></table></figure><ul>\n<li>kind: Service 定义了一个名字为 web 的 Headless Service，创建的 Service 格式为 nginx-0.web.default.svc.cluster.local，其他的类似，因为没有指定 Namespace（命名空间），所以默认部署在 default；</li>\n<li>kind: StatefulSet 定义了一个名字为 nginx 的 StatefulSet，replicas 表示部署 Pod 的副本数，本实例为 3。</li>\n</ul>\n<h5 id=\"21-创建-statefulset\"><a class=\"anchor\" href=\"#21-创建-statefulset\">#</a> 2.1 创建 StatefulSet</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME      READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-0   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m51s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-1   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m50s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          8m48s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>   AGE</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>kubernetes   ClusterIP   <span class=\"token number\">10.96</span>.0.1    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>/TCP   6d1h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>web          ClusterIP   None         <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">80</span>/TCP    9m28s</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get sts</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>NAME    READY   AGE</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>nginx   <span class=\"token number\">3</span>/3     8m58s</pre></td></tr></table></figure><h5 id=\"22-statefulset创建pod流程\"><a class=\"anchor\" href=\"#22-statefulset创建pod流程\">#</a> 2.2 StatefulSet 创建 Pod 流程</h5>\n<p>StatefulSet 管理的 Pod 部署和扩展规则如下：</p>\n<ul>\n<li>对于具有 N 个副本的 StatefulSet，将按顺序从 0 到 N-1 开始创建 Pod；</li>\n<li>当删除 Pod 时，将按照 N-1 到 0 的反顺序终止；</li>\n<li>在缩放 Pod 之前，必须保证当前的 Pod 是 Running（运行中）或者 Ready（就绪）；</li>\n<li>在终止 Pod 之前，它所有的继任者必须是完全关闭状态。</li>\n</ul>\n<p>StatefulSet 的 pod.Spec.TerminationGracePeriodSeconds（终止 Pod 的等待时间）不应该指定为 0，设置为 0 对 StatefulSet 的 Pod 是极其不安全的做法，优雅地删除 StatefulSet 的 Pod 是非常有必要的，而且是安全的，因为它可以确保在 Kubelet 从 APIServer 删除之前，让 Pod 正常关闭。</p>\n<p>当创建上面的 Nginx 实例时，Pod 将按 nginx-0、nginx-1、nginx-2 的顺序部署 3 个 Pod。在 nginx-0 处于 Running 或者 Ready 之前，nginx-1 不会被部署，相同的，nginx-2 在 web-1 未处于 Running 和 Ready 之前也不会被部署。如果在 nginx-1 处于 Running 和 Ready 状态时，nginx-0 变成 Failed 失败）状态，那么 nginx-2 将不会被启动，直到 nginx-0 恢复为 Running 和 Ready 状态。</p>\n<p>如果用户将 StatefulSet 的 replicas 设置为 1，那么 nginx-2 将首先被终止，在完全关闭并删除 nginx-2 之前，不会删除 nginx-1。如果 nginx-2 终止并且完全关闭后，nginx-0 突然失败，那么在 nginx-0 未恢复成 Running 或者 Ready 时，nginx-1 不会被删除。</p>\n<h5 id=\"23-tatefulset-扩容和缩容\"><a class=\"anchor\" href=\"#23-tatefulset-扩容和缩容\">#</a> 2.3 tatefulSet 扩容和缩容</h5>\n<p>和 Deployment 类似，可以通过更新 replicas 字段扩容 / 缩容 StatefulSet，也可以使用 kubectlscale、kubectl edit 和 kubectl patch 来扩容 / 缩容一个 StatefulSet。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl scale sts nginx --replicas=5</span></pre></td></tr></table></figure><h5 id=\"24-statefulset-更新策略\"><a class=\"anchor\" href=\"#24-statefulset-更新策略\">#</a> 2.4 StatefulSet 更新策略</h5>\n<p><strong>On Delete 策略</strong></p>\n<p>OnDelete 更新策略实现了传统（1.7 版本之前）的行为，它也是默认的更新策略。当我们选择这个更新策略并修改 StatefulSet 的.spec.template 字段时，StatefulSet 控制器不会自动更新 Pod，必须手动删除 Pod 才能使控制器创建新的 Pod。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: OnDelete</pre></td></tr></table></figure><p><strong>RollingUpdate 策略</strong></p>\n<p>RollingUpdate（滚动更新）更新策略会自动更新一个 StatefulSet 中所有的 Pod，采用与序号索引相反的顺序进行滚动更新。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      partition: <span class=\"token number\">0</span></pre></td></tr></table></figure><h5 id=\"25-分段更新\"><a class=\"anchor\" href=\"#25-分段更新\">#</a> 2.5 分段更新</h5>\n<p>将分区改为 2，此时会自动更新 nginx-2、nginx-3、nginx-4（因为之前更改了更新策略），但是不会更新 nginx-0 和 nginx-1：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>updateStrategy:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    type: RollingUpdate</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    rollingUpdate:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      partition: <span class=\"token number\">2</span></pre></td></tr></table></figure><p>将 sts 镜像为 nginx:1.21.1</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image sts nginx nginx=nginx:1.21.1</span></pre></td></tr></table></figure><p>按照上述方式，可以实现分阶段更新，类似于灰度 / 金丝雀发布。查看最终的结果如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -oyaml|grep image</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>    - image: nginx:latest</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>      image: docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:fad8e1cd52e24bce7b72cd7cb674a2efad671647b917055f5bd8a1f7ac9b1af8</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    - image: nginx:latest</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>      image: docker.io/library/nginx:latest</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:fad8e1cd52e24bce7b72cd7cb674a2efad671647b917055f5bd8a1f7ac9b1af8</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    - image: nginx:1.21.1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      image: docker.io/library/nginx:1.21.1</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      imageID: docker.io/library/nginx@sha256:a05b0cdd4fc1be3b224ba9662ebdf98fe44c09c0c9215b45f84344c12867002e</pre></td></tr></table></figure><h5 id=\"26-statefulset-挂载动态存储\"><a class=\"anchor\" href=\"#26-statefulset-挂载动态存储\">#</a> 2.6 StatefulSet 挂载动态存储</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    name: web</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  clusterIP: None</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kind: StatefulSet</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  name: web</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      app: nginx </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  serviceName: <span class=\"token string\">\"nginx\"</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  replicas: <span class=\"token number\">3</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        app: nginx </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      - name: nginx</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>        image: nginx:1.20</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        ports:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>        - containerPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>          name: web</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>        volumeMounts:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: www</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          mountPath: /usr/share/nginx/html</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  volumeClaimTemplates:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  - metadata:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>      name: www</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>      accessModes: <span class=\"token punctuation\">[</span> <span class=\"token string\">\"ReadWriteOnce\"</span> <span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>      storageClassName: <span class=\"token string\">\"rook-ceph-block\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>      resources:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>        requests:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>          storage: 10Gi</pre></td></tr></table></figure><h4 id=\"3守护进程集-daemonset\"><a class=\"anchor\" href=\"#3守护进程集-daemonset\">#</a> 3. 守护进程集 DaemonSet</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: DaemonSet</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-ds</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-ds</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      app: nginx-ds</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        app: nginx-ds</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        - name: nginx-ds</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><p>此时会在每个节点创建一个 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -o wide</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME             READY   STATUS    RESTARTS   AGE   IP               NODE           NOMINATED NODE   READINESS GATES</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>nginx-ds-47dxc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.85.213    k8s-node01     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-ds-4m89f   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.32.143    k8s-master01   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-ds-mtpc2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.195.12    k8s-master03   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-ds-t5rxc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.122.142   k8s-master02   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-ds-x86kc   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          56s   <span class=\"token number\">172.16</span>.58.222    k8s-node02     <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>           <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span></pre></td></tr></table></figure><p>指定节点部署 Pod</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>nodeSelector:</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>        ingress: <span class=\"token string\">'true'</span></pre></td></tr></table></figure><p>更新和回滚 DaemonSet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl set image ds nginx-ds nginx-ds=1.21.0 --record=true</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl rollout undo daemonset &lt;daemonset-name> --to-revision=&lt;revision></span></pre></td></tr></table></figure><p>DaemonSet 的更新和回滚与 Deployment 类似，此处不再演示。</p>\n<h4 id=\"4-hpa\"><a class=\"anchor\" href=\"#4-hpa\">#</a> 4. HPA</h4>\n<p>创建 deployment、service</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Service</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-hpa-svc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ports:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    - port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      targetPort: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      protocol: TCP</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      name: http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    app: nginx-hpa</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  type: ClusterIP</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  name: nginx-hpa</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    app: nginx-hpa</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      app: nginx-hpa</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  replicas: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>        app: nginx-hpa</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      restartPolicy: Always</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>        - name: nginx-hpa</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          resources:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            limits:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>              memory: 1024Mi</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>              cpu: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            requests:</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>              memory: 128Mi</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              cpu: 100m</pre></td></tr></table></figure><p>创建 HPA</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl autoscale deployment nginx-hpa --cpu-percent=10 --min=1 --max=10</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># kubectl get hpa</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME        REFERENCE              TARGETS       MINPODS   MAXPODS   REPLICAS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-hpa   Deployment/nginx-hpa   cpu: <span class=\"token number\">0</span>%/10%   <span class=\"token number\">1</span>         <span class=\"token number\">10</span>        <span class=\"token number\">1</span>          16s</pre></td></tr></table></figure><p>测试自动扩缩容</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">while</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token function\">wget</span> <span class=\"token parameter variable\">-q</span> -O- http://10.96.18.221 <span class=\"token operator\">></span> /dev/null<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                        READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>nginx-hpa-d8bcbdf7d-4mkxp   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          66s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>nginx-hpa-d8bcbdf7d-974q5   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          6m36s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>nginx-hpa-d8bcbdf7d-g6p2h   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          66s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>nginx-hpa-d8bcbdf7d-lvvsq   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>nginx-hpa-d8bcbdf7d-tgqmr   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          111s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>nginx-hpa-d8bcbdf7d-tzfbs   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          21s</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1771242682.html",
            "url": "http://ixuyong.cn/posts/1771242682.html",
            "title": "K8s零宕机服务发布-探针",
            "date_published": "2025-04-14T11:23:48.000Z",
            "content_html": "<h3 id=\"k8s零宕机服务发布-探针\"><a class=\"anchor\" href=\"#k8s零宕机服务发布-探针\">#</a> K8s 零宕机服务发布 - 探针</h3>\n<h4 id=\"1-pod状态及-pod-故障排查命令\"><a class=\"anchor\" href=\"#1-pod状态及-pod-故障排查命令\">#</a> 1. Pod 状态及 Pod 故障排查命令</h4>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">状态</th>\n<th style=\"text-align:left\">说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">Pending（挂起）</td>\n<td style=\"text-align:left\">Pod 已被 Kubernetes 系统接收，但仍有一个或多个容器未被创建，可以通过 kubectl describe 查看处于 Pending 状态的原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Running（运行中）</td>\n<td style=\"text-align:left\">Pod 已经被绑定到一个节点上，并且所有的容器都已经被创建，而且至少有一个是运行状态，或者是正在启动或者重启，可以通过 kubectl logs 查看 Pod 的日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Succeeded（成功）</td>\n<td style=\"text-align:left\">所有容器执行成功并终止，并且不会再次重启，可以通过 kubectl logs 查看 Pod 日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Failed（失败）</td>\n<td style=\"text-align:left\">所有容器都已终止，并且至少有一个容器以失败的方式终止，也就是说这个容器要么以非零状态退出，要么被系统终止，可以通过 logs 和 describe 查看 Pod 日志和状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Unknown（未知）</td>\n<td style=\"text-align:left\">通常是由于通信问题造成的无法获得 Pod 的状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ImagePullBackOff ErrImagePull</td>\n<td style=\"text-align:left\">镜像拉取失败，一般是由于镜像不存在、网络不通或者需要登录认证引起的，可以使用 describe 命令查看具体原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">CrashLoopBackOff</td>\n<td style=\"text-align:left\">容器启动失败，可以通过 logs 命令查看具体原因，一般为启动命令不正确，健康检查不通过等</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">OOMKilled</td>\n<td style=\"text-align:left\">容器内存溢出，一般是容器的内存 Limit 设置的过小，或者程序本身有内存溢出，可以通过 logs 查看程序启动日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Terminating</td>\n<td style=\"text-align:left\">Pod 正在被删除，可以通过 describe 查看状态</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SysctlForbidden</td>\n<td style=\"text-align:left\">Pod 自定义了内核配置，但 kubelet 没有添加内核配置或配置的内核参数不支持，可以通过 describe 查看具体原因</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">Completed</td>\n<td style=\"text-align:left\">容器内部主进程退出，一般计划任务执行结束会显示该状态，此时可以通过 logs 查看容器日志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">ContainerCreating</td>\n<td style=\"text-align:left\">Pod 正在创建，一般为正在下载镜像，或者有配置不当的地方，可以通过 describe 查看具体原因</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"2-pod镜像拉取策略\"><a class=\"anchor\" href=\"#2-pod镜像拉取策略\">#</a> 2. Pod 镜像拉取策略</h4>\n<p>通过 spec.containers [].imagePullPolicy 参数可以指定镜像的拉取策略，目前支持的策略如下：</p>\n<table>\n<thead>\n<tr>\n<th>操作方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Always</td>\n<td>总是拉取，当镜像 tag 为 latest 时，且 imagePullPolicy 未配置，默认为 Always</td>\n</tr>\n<tr>\n<td>Never</td>\n<td>不管是否存在都不会拉取</td>\n</tr>\n<tr>\n<td>IfNotPresent</td>\n<td>镜像不存在时拉取镜像，如果 tag 为非 latest，且 imagePullPolicy 未配置，默认为 IfNotPresent</td>\n</tr>\n</tbody>\n</table>\n<p>更改镜像拉取策略为 IfNotPresent：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr></table></figure><h4 id=\"3-pod-重启策略\"><a class=\"anchor\" href=\"#3-pod-重启策略\">#</a> 3. <strong>Pod</strong> 重启策略</h4>\n<table>\n<thead>\n<tr>\n<th>操作方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Always</td>\n<td>默认策略。容器失效时，自动重启该容器</td>\n</tr>\n<tr>\n<td>OnFailure</td>\n<td>容器以不为 0 的状态码终止，自动重启该容器</td>\n</tr>\n<tr>\n<td>Never</td>\n<td>无论何种状态，都不会重启</td>\n</tr>\n</tbody>\n</table>\n<p>指定重启策略为 Always ：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><h4 id=\"4-pod的三种探针\"><a class=\"anchor\" href=\"#4-pod的三种探针\">#</a> 4. Pod 的三种探针</h4>\n<table>\n<thead>\n<tr>\n<th>种类</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>startupProbe</td>\n<td>Kubernetes1.16 新加的探测方式，用于判断容器内的应用程序是否已经启动。如果配置了 startupProbe，就会先禁用其他探测，直到它成功为止。如果探测失败，Kubelet 会杀死容器，之后根据重启策略进行处理，如果探测成功，或没有配置 startupProbe，则状态为成功，之后就不再探测。</td>\n</tr>\n<tr>\n<td>livenessProbe</td>\n<td>用于探测容器是否在运行，如果探测失败，kubelet 会 “杀死” 容器并根据重启策略进行相应的处理。如果未指定该探针，将默认为 Success</td>\n</tr>\n<tr>\n<td>readinessProbe</td>\n<td>一般用于探测容器内的程序是否健康，即判断容器是否为就绪（Ready）状态。如果是，则可以处理请求，反之 Endpoints Controller 将从所有的 Service 的 Endpoints 中删除此容器所在 Pod 的 IP 地址。如果未指定，将默认为 Success</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"5-pod探针的实现方式\"><a class=\"anchor\" href=\"#5-pod探针的实现方式\">#</a> 5. Pod 探针的实现方式</h4>\n<table>\n<thead>\n<tr>\n<th>实现方式</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ExecAction</td>\n<td>在容器内执行一个指定的命令，如果命令返回值为 0，则认为容器健康</td>\n</tr>\n<tr>\n<td>TCPSocketAction</td>\n<td>通过 TCP 连接检查容器指定的端口，如果端口开放，则认为容器健康</td>\n</tr>\n<tr>\n<td>HTTPGetAction</td>\n<td>对指定的 URL 进行 Get 请求，如果状态码在 200~400 之间，则认为容器健康</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"6-健康检查配置\"><a class=\"anchor\" href=\"#6-健康检查配置\">#</a> 6. 健康检查配置</h4>\n<p>配置健康检查：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          startupProbe:</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>          livenessProbe:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>          readinessProbe:</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            httpGet:</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>              path: /index.html</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              scheme: HTTP</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><h4 id=\"7-prestop和-poststart配置\"><a class=\"anchor\" href=\"#7-prestop和-poststart配置\">#</a> 7. PreStop 和 PostStart 配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat nginx-deploy.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: apps/v1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kind: Deployment</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>metadata:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  name: nginx-deploy</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  labels:</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  annotations:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    app: nginx-deploy</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  namespace: default</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>spec:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  selector:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    matchLabels:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      app: nginx-deploy</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  replicas: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  template:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    metadata:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      labels:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        app: nginx-deploy</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    spec:</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      containers:</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        - name: nginx-deploy</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          image: nginx:latest</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>          imagePullPolicy: IfNotPresent</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>          startupProbe:</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>          livenessProbe:</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>            tcpSocket:</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>          readinessProbe:</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>            initialDelaySeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>            timeoutSeconds: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>            periodSeconds: <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>            successThreshold: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>            failureThreshold: <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            httpGet:</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>              path: /index.html</pre></td></tr><tr><td data-num=\"49\"></td><td><pre>              port: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>              scheme: HTTP</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>          lifecycle:</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>            postStart:</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>              exec:</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>                command:</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>                  - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>                  - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                  - <span class=\"token function\">mkdir</span> /data</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>            preStop:</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>              exec:</pre></td></tr><tr><td data-num=\"60\"></td><td><pre>                command:</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>                  - <span class=\"token function\">sh</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>                  - <span class=\"token string\">'-c'</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                  - <span class=\"token function\">sleep</span> <span class=\"token number\">30</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      restartPolicy: Always</pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3071070979.html",
            "url": "http://ixuyong.cn/posts/3071070979.html",
            "title": "一键永久激活Window、office教程",
            "date_published": "2025-04-10T13:32:09.000Z",
            "content_html": "<h3 id=\"一键永久激活window-office教程\"><a class=\"anchor\" href=\"#一键永久激活window-office教程\">#</a> 一键永久激活 Window、office 教程</h3>\n<p>1、按下 Win 键 + R，调出运行对话框，输入 powershell 并回车，启动命令提示符窗口。接着输入以下指令执行激活：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>irm https://get.activated.win <span class=\"token operator\">|</span> iex</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/ilMT403.png\" alt=\"1.png\" /></p>\n<p>该脚本包含四个功能：首个命令用于 Windows 系统永久激活，第二个用于 Office 永久激活，第三个将系统有效期延长至 2038 年，第四个则实现每 180 天自动循环激活。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/taJbKQr.png\" alt=\"2.png\" /></p>\n<p>2. 我们再次使用 Windows 徽标 + R 快捷键打开运行框，输入 slmgr.vbs/xpr 就可以看到系统已经永久激活了。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>slmgr.vbs /xpr</pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/JMWlUpc.png\" alt=\"3.png\" /></p>\n<p>以上，既然看到这里了，如果觉得不错，随手点个赞、打赏一下吧，⭐～谢谢你看我的文章，我们下次再见。</p>\n",
            "tags": [
                "Windows"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/985149017.html",
            "url": "http://ixuyong.cn/posts/985149017.html",
            "title": "二进制高可用安装K8S集群",
            "date_published": "2025-04-10T12:58:40.000Z",
            "content_html": "<h2 id=\"二进制高可用安装k8s集群\"><a class=\"anchor\" href=\"#二进制高可用安装k8s集群\">#</a> 二进制高可用安装 K8s 集群</h2>\n<h4 id=\"1-基本配置\"><a class=\"anchor\" href=\"#1-基本配置\">#</a> 1. 基本配置</h4>\n<h5 id=\"11-基本环境配置\"><a class=\"anchor\" href=\"#11-基本环境配置\">#</a> 1.1 基本环境配置</h5>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP 地址</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>k8s-master01 ~ 03</td>\n<td>192.168.1.71 ~ 73</td>\n<td>master 节点 * 3</td>\n</tr>\n<tr>\n<td>/</td>\n<td>192.168.1.70</td>\n<td>keepalived 虚拟 IP（不占用机器）</td>\n</tr>\n<tr>\n<td>k8s-node01 ~ 02</td>\n<td>192.168.1.74/75</td>\n<td>worker 节点 * 2</td>\n</tr>\n</tbody>\n</table>\n<p><em>请统一替换这些网段，Pod 网段和 service 和宿主机网段不要重复！！！</em></p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 配置信息 *</strong></em></th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>系统版本</td>\n<td>Rocky Linux 8/9</td>\n</tr>\n<tr>\n<td>Containerd</td>\n<td>latest</td>\n</tr>\n<tr>\n<td>Pod 网段</td>\n<td>172.16.0.0/16</td>\n</tr>\n<tr>\n<td>Service 网段</td>\n<td>10.96.0.0/16</td>\n</tr>\n</tbody>\n</table>\n<p><mark>所有节点</mark>更改主机名（其它节点按需修改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname k8s-master01</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 hosts，修改 /etc/hosts 如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/hosts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.71 k8s-master01</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.72 k8s-master02</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">192.168</span>.1.73 k8s-master03</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">192.168</span>.1.74 k8s-node01</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.1.75 k8s-node02</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 yum 源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置基础源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>yum makecache</pre></td></tr></table></figure><p><mark>所有节点</mark>必备工具安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> rsyslog <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>关闭防火墙、selinux、dnsmasq、swap、开启 rsyslog。服务器配置如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> dnsmasq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> rsyslog</pre></td></tr></table></figure><p><mark>所有节点</mark>关闭 swap 分区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>swapoff <span class=\"token parameter variable\">-a</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">vm.swappiness</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-ri</span> <span class=\"token string\">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 ntpdate：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><p><mark>所有节点</mark>同步时间并配置上海时区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 limit：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><p><mark>所有节点</mark>升级系统：</p>\n<pre><code>yum update -y\n</code></pre>\n<p><mark>Master01 节点</mark>免密钥登录其他节点，安装过程中生成配置文件和证书均在 Master01 上操作，集群管理也在 Master01 上操作：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token parameter variable\">-t</span> rsa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span><span class=\"token keyword\">do</span> ssh-copy-id <span class=\"token parameter variable\">-i</span> .ssh/id_rsa.pub <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><em>注意：公有云环境，可能需要把 kubectl 放在一个非 Master 节点上</em></p>\n<p><mark>Master01 节点</mark>下载安装所有的源码文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/ <span class=\"token punctuation\">;</span> <span class=\"token function\">git</span> clone https://gitee.com/chinagei/k8s-ha-install</pre></td></tr></table></figure><h5 id=\"12-内核配置\"><a class=\"anchor\" href=\"#12-内核配置\">#</a> 1.2 内核配置</h5>\n<p><mark>所有节点</mark>安装 ipvsadm：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 ipvs 模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe -- ip_vs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>modprobe -- ip_vs_rr</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>modprobe -- ip_vs_wrr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>modprobe -- ip_vs_sh</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>modprobe -- nf_conntrack</pre></td></tr></table></figure><p><mark>所有节点</mark>创建 ipvs.conf，并配置开机自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/modules-load.d/ipvs.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 加入以下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ip_vs</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ip_vs_lc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ip_vs_wlc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ip_vs_rr</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ip_vs_wrr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ip_vs_lblc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ip_vs_lblcr</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ip_vs_dh</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ip_vs_fo</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ip_vs_nq</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ip_vs_sed</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ip_vs_ftp</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf_conntrack</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ip_tables</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ip_set</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>xt_set</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ipt_set</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ipt_rpfilter</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ipt_REJECT</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ipip</pre></td></tr></table></figure><p><mark>所有节点</mark>然后执行 systemctl enable --now systemd-modules-load.service 即可（报错不用管）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> systemd-modules-load.service</pre></td></tr></table></figure><p><mark>所有节点</mark>内核优化配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/sysctl.d/k8s.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.ipv4.ip_forward = 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.bridge.bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fs.may_detach_mounts = 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.conf.all.route_localnet = 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vm.overcommit_memory=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vm.panic_on_oom=0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>fs.inotify.max_user_watches=89100</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fs.file-max=52706963</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fs.nr_open=52706963</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.netfilter.nf_conntrack_max=2310720</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net.ipv4.tcp_keepalive_time = 600</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_keepalive_probes = 3</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_keepalive_intvl =15</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.ipv4.tcp_max_tw_buckets = 36000</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.ipv4.tcp_tw_reuse = 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans = 327680</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net.ipv4.tcp_orphan_retries = 3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net.ipv4.tcp_syncookies = 1</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>net.ipv4.ip_conntrack_max = 65536</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>net.ipv4.tcp_timestamps = 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>net.core.somaxconn = 16384</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><mark>所有节点</mark>应用配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置完内核后，重启机器，之后查看内核模块是否已自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lsmod <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto <span class=\"token parameter variable\">-e</span> ip_vs <span class=\"token parameter variable\">-e</span> nf_conntrack</pre></td></tr></table></figure><h4 id=\"2-高可用组件安装\"><a class=\"anchor\" href=\"#2-高可用组件安装\">#</a> 2. 高可用组件安装</h4>\n<p><em>注意：如果安装的不是高可用集群，haproxy 和 keepalived 无需安装</em></p>\n<p><em>注意：公有云要用公有云自带的负载均衡，比如阿里云的 SLB、NLB，腾讯云的 ELB，用来替代 haproxy 和 keepalived，因为公有云大部分都是不支持 keepalived 的。</em></p>\n<p><mark>所有 Master 节点</mark>通过 yum 安装 HAProxy 和 KeepAlived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived haproxy <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 HAProxy，需要注意黄色部分的 IP：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/haproxy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/haproxy/haproxy.cfg </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  maxconn  <span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ulimit-n  <span class=\"token number\">16384</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  log  <span class=\"token number\">127.0</span>.0.1 local0 err</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  stats <span class=\"token function\">timeout</span> 30s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>defaults</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  log global</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mode  http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  option  httplog</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">timeout</span> connect <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">timeout</span> client  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">timeout</span> server  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">timeout</span> http-request 15s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">timeout</span> http-keep-alive 15s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>frontend monitor-in</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> *:33305</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  mode http</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  option httplog</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  monitor-uri /monitor</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>frontend k8s-master</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0:8443       <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1:8443     <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  tcp-request inspect-delay 5s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  default_backend k8s-master</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>backend k8s-master</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  option tcp-check</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  balance roundrobin</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  default-server inter 10s downinter 5s rise <span class=\"token number\">2</span> fall <span class=\"token number\">2</span> slowstart 60s maxconn <span class=\"token number\">250</span> maxqueue <span class=\"token number\">256</span> weight <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  server k8s-master01\t<span class=\"token number\">192.168</span>.1.71:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  server k8s-master02\t<span class=\"token number\">192.168</span>.1.72:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  server k8s-master03\t<span class=\"token number\">192.168</span>.1.73:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 KeepAlived，需要注意黄色部分的配置。</p>\n<p><mark>Master01 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    interface ens160               <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.71      <span class=\"token comment\">#K8s-master01 IP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70        <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master02 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.72       <span class=\"token comment\">#K8s-master02 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70              <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master03 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                 <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.73        <span class=\"token comment\">#K8s-master03 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70          <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置 KeepAlived 健康检查文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/check_apiserver.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">k</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">1</span> <span class=\"token number\">3</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token assign-left variable\">check_code</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>pgrep haproxy<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$check_code</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">expr</span> $err + <span class=\"token number\">1</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token builtin class-name\">break</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$err</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"systemctl stop keepalived\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    /usr/bin/systemctl stop keepalived</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置健康检查文件添加执行权限：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/keepalived/check_apiserver.sh</pre></td></tr></table></figure><p><mark>所有 master 节点</mark>启动 haproxy 和 keepalived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now haproxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now keepalived</span></pre></td></tr></table></figure><p>重要：如果安装了 keepalived 和 haproxy，需要测试 keepalived 是否是正常的</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>所有节点测试VIP</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 192.168.1.70 -c 4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING <span class=\"token number\">192.168</span>.1.70 <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.464</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.062</span> ms</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.1.70 16443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.1.70.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Connection closed by foreign host.</pre></td></tr></table></figure><p>如果 ping 不通且 telnet 没有出现 ] ，则认为 VIP 不可以，不可在继续往下执行，需要排查 keepalived 的问题，比如防火墙和 selinux，haproxy 和 keepalived 的状态，监听端口等</p>\n<ul>\n<li>所有节点查看防火墙状态必须为 disable 和 inactive：systemctl status firewalld</li>\n<li>所有节点查看 selinux 状态，必须为 disable：getenforce</li>\n<li>master 节点查看 haproxy 和 keepalived 状态：systemctl status keepalived haproxy</li>\n<li>master 节点查看监听端口：netstat -lntp</li>\n</ul>\n<p>如果以上都没有问题，需要确认：</p>\n<ol>\n<li>\n<p>是否是公有云机器</p>\n</li>\n<li>\n<p>是否是私有云机器（类似 OpenStack）</p>\n</li>\n</ol>\n<p>上述公有云一般都是不支持 keepalived，私有云可能也有限制，需要和自己的私有云管理员咨询</p>\n<h4 id=\"3-runtime安装\"><a class=\"anchor\" href=\"#3-runtime安装\">#</a> 3. Runtime 安装</h4>\n<p>如果安装的版本低于 1.24，选择 Docker 和 Containerd 均可，高于 1.24 建议选择 Containerd 作为 Runtime，不再推荐使用 Docker 作为 Runtime。</p>\n<h5 id=\"31-安装containerd\"><a class=\"anchor\" href=\"#31-安装containerd\">#</a> 3.1 安装 Containerd</h5>\n<p><mark>所有节点</mark>配置安装源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 docker-ce（如果在以前已经安装过，需要重新安装更新一下）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install docker-ce containerd -y</span></pre></td></tr></table></figure><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p>\n<p>首先配置 Containerd 所需的模块（<mark>所有节点</mark>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>overlay</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>br_netfilter</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># modprobe -- overlay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># modprobe -- br_netfilter</span></pre></td></tr></table></figure><p><mark>所有节点</mark>，配置 Containerd 所需的内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sysctl --system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>生成 Containerd 的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mkdir -p /etc/containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># containerd config default | tee /etc/containerd/config.toml</span></pre></td></tr></table></figure><p><mark>所有节点</mark>更改 Containerd 的 Cgroup 和 Pause 镜像配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 Containerd，并配置开机自启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now containerd</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 crictl 客户端连接的运行时位置（可选）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat > /etc/crictl.yaml &lt;&lt;EOF</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>runtime-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>image-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>timeout: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EOF</pre></td></tr></table></figure><h4 id=\"4-k8s及etcd安装\"><a class=\"anchor\" href=\"#4-k8s及etcd安装\">#</a> 4 . K8S 及 etcd 安装</h4>\n<p><mark>Master01</mark> 下载 kubernetes 安装包（1.32.3 需要更改为你看到的最新版本）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://dl.k8s.io/v1.32.0/kubernetes-server-linux-amd64.tar.gz</span></pre></td></tr></table></figure><p>最新版获取地址：<a href=\"https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.31.md\">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</a></p>\n<p><mark>以下操作都在 master01 执行</mark></p>\n<p>下载 etcd 安装包：<a href=\"https://github.com/etcd-io/etcd/releases/\">https://github.com/etcd-io/etcd/releases/</a></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/etcd-io/etcd/releases/download/v3.5.16/etcd-v3.5.16-linux-amd64.tar.gz</span></pre></td></tr></table></figure><p>解压 kubernetes 安装文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span></pre></td></tr></table></figure><p>解压 etcd 安装文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  tar -zxvf etcd-v3.5.16-linux-amd64.tar.gz --strip-components=1 -C /usr/local/bin etcd-v3.5.16-linux-amd64/etcd&#123;,ctl&#125;</span></pre></td></tr></table></figure><p>版本查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubelet --version</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Kubernetes v1.32.3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># etcdctl version</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>etcdctl version: <span class=\"token number\">3.5</span>.16</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>API version: <span class=\"token number\">3.5</span></pre></td></tr></table></figure><p>将组件发送到其他节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">MasterNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-master02 k8s-master03'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token assign-left variable\">WorkNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-node01 k8s-node02'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$MasterNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token builtin class-name\">echo</span> <span class=\"token variable\">$NODE</span><span class=\"token punctuation\">;</span> <span class=\"token function\">scp</span> /usr/local/bin/kube<span class=\"token punctuation\">&#123;</span>let,ctl,-apiserver,-controller-manager,-scheduler,-proxy<span class=\"token punctuation\">&#125;</span> <span class=\"token variable\">$NODE</span>:/usr/local/bin/<span class=\"token punctuation\">;</span> <span class=\"token function\">scp</span> /usr/local/bin/etcd* <span class=\"token variable\">$NODE</span>:/usr/local/bin/<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$WorkNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>     <span class=\"token function\">scp</span> /usr/local/bin/kube<span class=\"token punctuation\">&#123;</span>let,-proxy<span class=\"token punctuation\">&#125;</span> <span class=\"token variable\">$NODE</span>:/usr/local/bin/ <span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><mark>Master01 节点</mark>切换到 1.32.x 分支（其他版本可以切换到其他分支，.x 即可，不需要更改为具体的小版本）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> checkout manual-installation-v1.32.x</pre></td></tr></table></figure><h4 id=\"5-生成证书\"><a class=\"anchor\" href=\"#5-生成证书\">#</a> 5 . 生成证书</h4>\n<p><em><mark>二进制安装最关键步骤，一步错误全盘皆输，一定要注意每个步骤都要是正确的</mark></em></p>\n<p><mark>Master01</mark> 下载生成证书工具（下载不成功可以去百度网盘）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token string\">\"https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\"</span> <span class=\"token parameter variable\">-O</span> /usr/local/bin/cfssl</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">wget</span> <span class=\"token string\">\"https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\"</span> <span class=\"token parameter variable\">-O</span> /usr/local/bin/cfssljson</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">chmod</span> +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</pre></td></tr></table></figure><h5 id=\"51-etcd证书\"><a class=\"anchor\" href=\"#51-etcd证书\">#</a> 5.1 Etcd 证书</h5>\n<p><mark>所有 Master 节点</mark>创建 etcd 证书目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /etc/etcd/ssl <span class=\"token parameter variable\">-p</span></pre></td></tr></table></figure><p><mark>所有节点</mark>创建 kubernetes 相关目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/kubernetes/pki</pre></td></tr></table></figure><p><mark>Master01 节点</mark>生成 etcd 证书</p>\n<p>生成证书的 CSR（证书签名请求文件，配置了一些域名、公司、单位）文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/pki</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 生成 etcd CA 证书和 CA 证书的 key</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>cfssl gencert <span class=\"token parameter variable\">-initca</span> etcd-ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/etcd/ssl/etcd-ca</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   <span class=\"token parameter variable\">-hostname</span><span class=\"token operator\">=</span><span class=\"token number\">127.0</span>.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.71,192.168.1.72,192.168.1.73 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>   etcd-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/etcd/ssl/etcd</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>执行结果</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generate received request</pre></td></tr><tr><td data-num=\"17\"></td><td><pre> \t<span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> received CSR</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generating key: rsa-2048</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> encoded CSR</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> signed certificate with serial number     <span class=\"token number\">250230878926052708909595617022917808304837732033</span></pre></td></tr></table></figure><p>将证书复制到其他 master 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">MasterNodes</span><span class=\"token operator\">=</span><span class=\"token string\">'k8s-master02 k8s-master03'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\">$MasterNodes</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token function\">ssh</span> <span class=\"token variable\">$NODE</span> <span class=\"token string\">\"mkdir -p /etc/etcd/ssl\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token function\">scp</span> /etc/etcd/ssl/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/etcd/ssl/<span class=\"token variable\">$&#123;FILE&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>     <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><h5 id=\"52-k8s组件证书\"><a class=\"anchor\" href=\"#52-k8s组件证书\">#</a> 5.2 K8s 组件证书</h5>\n<p><mark>Master01</mark> 生成 kubernetes CA 证书：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /root/k8s-ha-install/pki</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cfssl gencert <span class=\"token parameter variable\">-initca</span> ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/ca</pre></td></tr></table></figure><h6 id=\"521-apiserver证书\"><a class=\"anchor\" href=\"#521-apiserver证书\">#</a> 5.2.1 APIServer 证书</h6>\n<p>注意：10.96.0. 是 k8s service 的网段，如果说需要更改 k8s service 网段，那就需要更改 10.96.0.1</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json   <span class=\"token parameter variable\">-hostname</span><span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.1,192.168.1.70,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,192.168.1.71,192.168.1.72,192.168.1.73   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes   apiserver-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/apiserver</pre></td></tr></table></figure><p>生成 apiserver 的聚合证书：：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-initca</span> front-proxy-ca-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/front-proxy-ca </pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>cfssl gencert   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca-key.pem   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes   front-proxy-client-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/front-proxy-client</pre></td></tr></table></figure><p>返回结果（忽略警告）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generate received request</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> received CSR</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> generating key: rsa-2048</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> encoded CSR</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>INFO<span class=\"token punctuation\">]</span> signed certificate with serial number <span class=\"token number\">597484897564859295955894546063479154194995827845</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">2020</span>/12/11 <span class=\"token number\">18</span>:15:28 <span class=\"token punctuation\">[</span>WARNING<span class=\"token punctuation\">]</span> This certificate lacks a <span class=\"token string\">\"hosts\"</span> field. This makes it unsuitable <span class=\"token keyword\">for</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>websites. For <span class=\"token function\">more</span> information see the Baseline Requirements <span class=\"token keyword\">for</span> the Issuance and Management</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum <span class=\"token punctuation\">(</span>https://cabforum.org<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>specifically, section <span class=\"token number\">10.2</span>.3 <span class=\"token punctuation\">(</span><span class=\"token string\">\"Information Requirements\"</span><span class=\"token punctuation\">)</span>.</pre></td></tr></table></figure><h6 id=\"522-controllermanager\"><a class=\"anchor\" href=\"#522-controllermanager\">#</a> 5.2.2 ControllerManager</h6>\n<p>生成 controller-manage 的证书：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   manager-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/controller-manager</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP地址</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># set-cluster：设置一个集群项，</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 设置一个环境项，一个上下文</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kubectl config set-context system:kube-controller-manager@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># set-credentials 设置一个用户项</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kubectl config set-credentials system:kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/controller-manager.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/controller-manager-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># 使用某个环境当做默认环境</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kubectl config use-context system:kube-controller-manager@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig</pre></td></tr></table></figure><h6 id=\"523-scheduler证书\"><a class=\"anchor\" href=\"#523-scheduler证书\">#</a> 5.2.3 Scheduler 证书</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   scheduler-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/scheduler</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP地址</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kubectl config set-credentials system:kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/scheduler.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/scheduler-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kubectl config set-context system:kube-scheduler@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kubectl config use-context system:kube-scheduler@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr></table></figure><h6 id=\"524-生成管理员证书\"><a class=\"anchor\" href=\"#524-生成管理员证书\">#</a> 5.2.4 生成管理员证书</h6>\n<p>Kubectl /etc/Kubernetes/admin.conf ~/.kube/config</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   admin-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/admin</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>注意：修改黄色部分的IP</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>kubectl config set-cluster kubernetes     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kubectl config set-credentials kubernetes-admin     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/admin.pem     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/admin-key.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>kubectl config set-context kubernetes-admin@kubernetes     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>kubernetes-admin     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kubectl config use-context kubernetes-admin@kubernetes     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.kubeconfig</pre></td></tr></table></figure><h6 id=\"525-创建serviceaccount证书\"><a class=\"anchor\" href=\"#525-创建serviceaccount证书\">#</a> 5.2.5 创建 ServiceAccount 证书</h6>\n<p>创建一对公钥，用来签发 ServiceAccount 的 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl genrsa <span class=\"token parameter variable\">-out</span> /etc/kubernetes/pki/sa.key <span class=\"token number\">2048</span></pre></td></tr></table></figure><p>返回结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Generating RSA private key, <span class=\"token number\">2048</span> bit long modulus <span class=\"token punctuation\">(</span><span class=\"token number\">2</span> primes<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++++</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>.+++++</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>e is <span class=\"token number\">65537</span> <span class=\"token punctuation\">(</span>0x010001<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>openssl rsa <span class=\"token parameter variable\">-in</span> /etc/kubernetes/pki/sa.key <span class=\"token parameter variable\">-pubout</span> <span class=\"token parameter variable\">-out</span> /etc/kubernetes/pki/sa.pub</pre></td></tr></table></figure><p>发送证书至其他节点：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ls</span> /etc/kubernetes/pki <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> etcd<span class=\"token variable\">)</span></span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token function\">scp</span> /etc/kubernetes/pki/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/pki/<span class=\"token variable\">$&#123;FILE&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token keyword\">done</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    <span class=\"token function\">scp</span> /etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token keyword\">done</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>查看证书文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /etc/kubernetes/pki/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>admin.csr      apiserver.csr      ca.csr      controller-manager.csr      front-proxy-ca.csr      front-proxy-client.csr      sa.key         scheduler-key.pem</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>admin-key.pem  apiserver-key.pem  ca-key.pem  controller-manager-key.pem  front-proxy-ca-key.pem  front-proxy-client-key.pem  sa.pub         scheduler.pem</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>admin.pem      apiserver.pem      ca.pem      controller-manager.pem      front-proxy-ca.pem      front-proxy-client.pem      scheduler.csr</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># ls /etc/kubernetes/pki/ |wc -l</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">23</span></pre></td></tr></table></figure><h4 id=\"6-kubernetes组件配置\"><a class=\"anchor\" href=\"#6-kubernetes组件配置\">#</a> 6. Kubernetes 组件配置</h4>\n<h5 id=\"61-ecd配置\"><a class=\"anchor\" href=\"#61-ecd配置\">#</a> 6.1 Ecd 配置</h5>\n<p>Etcd 配置大致相同，注意修改每个 Master 节点的 etcd 配置的主机名和 IP 地址</p>\n<h6 id=\"611-master01\"><a class=\"anchor\" href=\"#611-master01\">#</a> 6.1.1 Master01</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master01'</span>     <span class=\"token comment\"># k8s-master01 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.71:2380'</span>            <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.71:2379,http://127.0.0.1:2379'</span>   <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.71:2380'</span>  <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.71:2379'</span>        <span class=\"token comment\"># k8s-master01 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>     <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"612-master02\"><a class=\"anchor\" href=\"#612-master02\">#</a> 6.1.2 Master02</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml\t</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master02'</span>   <span class=\"token comment\"># k8s-master02 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.72:2380'</span>      <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.72:2379,http://127.0.0.1:2379'</span>    <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.72:2380'</span>    <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.72:2379'</span>     <span class=\"token comment\"># k8s-master02 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>             <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP </span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"613-master03\"><a class=\"anchor\" href=\"#613-master03\">#</a> 6.1.3 Master03</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/etcd/etcd.config.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>name: <span class=\"token string\">'k8s-master03'</span>           <span class=\"token comment\"># k8s-master03 名称</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>data-dir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>wal-dir: /var/lib/etcd/wal</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>snapshot-count: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>heartbeat-interval: <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>election-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>quota-backend-bytes: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>listen-peer-urls: <span class=\"token string\">'https://192.168.1.73:2380'</span>           <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>listen-client-urls: <span class=\"token string\">'https://192.168.1.73:2379,http://127.0.0.1:2379'</span>       <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>max-snapshots: <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>max-wals: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>cors:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>initial-advertise-peer-urls: <span class=\"token string\">'https://192.168.1.73:2380'</span>      <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>advertise-client-urls: <span class=\"token string\">'https://192.168.1.73:2379'</span>            <span class=\"token comment\"># k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>discovery:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>discovery-fallback: <span class=\"token string\">'proxy'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>discovery-proxy:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>discovery-srv:</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>initial-cluster: <span class=\"token string\">'k8s-master01=https://192.168.1.71:2380,k8s-master02=https://192.168.1.72:2380,k8s-master03=https://192.168.1.73:2380'</span>                <span class=\"token comment\"># k8s-master01、k8s-master02、k8s-master03 IP</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>initial-cluster-token: <span class=\"token string\">'etcd-k8s-cluster'</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>initial-cluster-state: <span class=\"token string\">'new'</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>strict-reconfig-check: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>enable-v2: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>enable-pprof: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>proxy: <span class=\"token string\">'off'</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>proxy-failure-wait: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>proxy-refresh-interval: <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>proxy-dial-timeout: <span class=\"token number\">1000</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>proxy-write-timeout: <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>proxy-read-timeout: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>client-transport-security:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>peer-transport-security:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  cert-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd.pem'</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  key-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-key.pem'</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  peer-client-cert-auth: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  trusted-ca-file: <span class=\"token string\">'/etc/kubernetes/pki/etcd/etcd-ca.pem'</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>  auto-tls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>log-package-levels:</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>log-outputs: <span class=\"token punctuation\">[</span>default<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>force-new-cluster: <span class=\"token boolean\">false</span></pre></td></tr></table></figure><h6 id=\"614-启动etcd\"><a class=\"anchor\" href=\"#614-启动etcd\">#</a> 6.1.4 启动 Etcd</h6>\n<p><mark>所有 Master 节点</mark>创建 etcd service 并启动</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /usr/lib/systemd/system/etcd.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Etcd Service</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://coreos.com/etcd/docs/latest/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Type</span><span class=\"token operator\">=</span>notify</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/etcd --config-file<span class=\"token operator\">=</span>/etc/etcd/etcd.config.yml</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">Alias</span><span class=\"token operator\">=</span>etcd3.service</pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>创建 etcd 的证书目录：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> /etc/kubernetes/pki/etcd</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-s</span> /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> etcd</pre></td></tr></table></figure><p>查看 etcd 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">ETCDCTL_API</span><span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>etcdctl <span class=\"token parameter variable\">--endpoints</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.73:2379,192.168.1.72:2379,192.168.1.71:2379\"</span> <span class=\"token parameter variable\">--cacert</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd-ca.pem <span class=\"token parameter variable\">--cert</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd.pem <span class=\"token parameter variable\">--key</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out<span class=\"token operator\">=</span>table</pre></td></tr></table></figure><h5 id=\"62-apiserver配置\"><a class=\"anchor\" href=\"#62-apiserver配置\">#</a> 6.2 APIServer 配置</h5>\n<h6 id=\"621-master01\"><a class=\"anchor\" href=\"#621-master01\">#</a> 6.2.1 Master01</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.71 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\"># --token-auth-file=/etc/kubernetes/token.csv</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"622-master02\"><a class=\"anchor\" href=\"#622-master02\">#</a> 6.2.2 Master02</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.72 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"623-master03\"><a class=\"anchor\" href=\"#623-master03\">#</a> 6.2.3 Master03</h6>\n<p>注意：本文档使用的 k8s service 网段为 10.96.0.0/16，该网段不能和宿主机的网段、Pod 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kube-apiserver.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes API Server</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-apiserver <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --allow-privileged<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --bind-address<span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --secure-port<span class=\"token operator\">=</span><span class=\"token number\">6443</span>  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      --advertise-address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.73 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --service-cluster-ip-range<span class=\"token operator\">=</span><span class=\"token number\">10.96</span>.0.0/16  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --service-node-port-range<span class=\"token operator\">=</span><span class=\"token number\">30000</span>-32767  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --etcd-servers<span class=\"token operator\">=</span>https://192.168.1.71:2379,https://192.168.1.72:2379,https://192.168.1.73:2379 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --etcd-cafile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --etcd-certfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --etcd-keyfile<span class=\"token operator\">=</span>/etc/etcd/ssl/etcd-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      --client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --tls-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --tls-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --kubelet-client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --kubelet-client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/apiserver-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      --service-account-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.pub  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>      --service-account-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>      --service-account-issuer<span class=\"token operator\">=</span>https://kubernetes.default.svc.cluster.local <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>      --kubelet-preferred-address-types<span class=\"token operator\">=</span>InternalIP,ExternalIP,Hostname  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>      --enable-admission-plugins<span class=\"token operator\">=</span>NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>      --authorization-mode<span class=\"token operator\">=</span>Node,RBAC  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>      --enable-bootstrap-token-auth<span class=\"token operator\">=</span>true  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>      --proxy-client-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>      --proxy-client-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-client-key.pem  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>      --requestheader-allowed-names<span class=\"token operator\">=</span>aggregator  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>      --requestheader-group-headers<span class=\"token operator\">=</span>X-Remote-Group  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>      --requestheader-extra-headers-prefix<span class=\"token operator\">=</span>X-Remote-Extra-  <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>      --requestheader-username-headers<span class=\"token operator\">=</span>X-Remote-User</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>      <span class=\"token comment\"># --token-auth-file=/etc/kubernetes/token.csv</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>on-failure</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token assign-left variable\">LimitNOFILE</span><span class=\"token operator\">=</span><span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><h6 id=\"624-启动apiserver\"><a class=\"anchor\" href=\"#624-启动apiserver\">#</a> 6.2.4 启动 apiserver</h6>\n<p><mark>所有 Master 节点</mark>开启 kube-apiserver：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload <span class=\"token operator\">&amp;&amp;</span> systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> kube-apiserver</pre></td></tr></table></figure><p>检测 kube-server 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl status kube-apiserver</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>● kube-apiserver.service – Kubernetes API Server</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/kube-apiserver.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Sat <span class=\"token number\">2020</span>-08-22 <span class=\"token number\">21</span>:26:49 CST<span class=\"token punctuation\">;</span> 26s ago</pre></td></tr></table></figure><p>如果系统日志有这些提示可以忽略:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.004739    <span class=\"token number\">7450</span> clientconn.go:948<span class=\"token punctuation\">]</span> ClientConn switching balancer to “pick_first”</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.004843    <span class=\"token number\">7450</span> balancer_conn_wrappers.go:78<span class=\"token punctuation\">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, <span class=\"token punctuation\">&#123;</span>CONNECTING <span class=\"token operator\">&lt;</span>nil<span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.010725    <span class=\"token number\">7450</span> balancer_conn_wrappers.go:78<span class=\"token punctuation\">]</span> pickfirstBalancer: HandleSubConnStateChange: 0xc011bd4c80, <span class=\"token punctuation\">&#123;</span>READY <span class=\"token operator\">&lt;</span>nil<span class=\"token operator\">></span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Dec <span class=\"token number\">11</span> <span class=\"token number\">20</span>:51:15 k8s-master01 kube-apiserver: I1211 <span class=\"token number\">20</span>:51:15.011370    <span class=\"token number\">7450</span> controlbuf.go:508<span class=\"token punctuation\">]</span> transport: loopyWriter.run returning. Connection error: desc <span class=\"token operator\">=</span> “transport is closing”</pre></td></tr></table></figure><h5 id=\"63-controllermanage\"><a class=\"anchor\" href=\"#63-controllermanage\">#</a> 6.3 ControllerManage</h5>\n<p><mark>所有 Master 节点</mark>配置 kube-controller-manager service（所有 master 节点配置一样）</p>\n<p>注意：本文档使用的 k8s Pod 网段为 172.16.0.0/16，该网段不能和宿主机的网段、k8s Service 网段的重复，请按需修改：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-controller-manager.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Controller Manager</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-controller-manager <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      --root-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --cluster-signing-cert-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --cluster-signing-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      --service-account-private-key-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/sa.key <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>      <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>      --authentication-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>      --authorization-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/controller-manager.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>      --leader-elect<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      --use-service-account-credentials<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>      --node-monitor-grace-period<span class=\"token operator\">=</span>40s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>      --node-monitor-period<span class=\"token operator\">=</span>5s <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>      <span class=\"token parameter variable\">--controllers</span><span class=\"token operator\">=</span>*,bootstrapsigner,tokencleaner <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>      --allocate-node-cidrs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>      --cluster-cidr<span class=\"token operator\">=</span><span class=\"token number\">172.16</span>.0.0/16 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>      --requestheader-client-ca-file<span class=\"token operator\">=</span>/etc/kubernetes/pki/front-proxy-ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>      --node-cidr-mask-size<span class=\"token operator\">=</span><span class=\"token number\">24</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>      </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>启动 kube-controller-manager</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-controller-manager</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-controller-manager.service → /usr/lib/systemd/system/kube-controller-manager.service.</pre></td></tr></table></figure><p>查看启动状态</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl  status kube-controller-manager</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>● kube-controller-manager.service – Kubernetes Controller Manager</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/ ubern/system/kube-controller-manager.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Fri <span class=\"token number\">2020</span>-12-11 <span class=\"token number\">20</span>:53:05 CST<span class=\"token punctuation\">;</span> 8s ago</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     Docs: https://github.com/  ubernetes/  ubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre> Main PID: <span class=\"token number\">7518</span> <span class=\"token punctuation\">(</span>kube-controller<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h5 id=\"64-scheduler\"><a class=\"anchor\" href=\"#64-scheduler\">#</a> 6.4 Scheduler</h5>\n<p>所有 Master 节点配置 kube-scheduler service（所有 master 节点配置一样）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/lib/systemd/system/kube-scheduler.service </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Scheduler</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-scheduler <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>      <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>      --leader-elect<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>      --authentication-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>      --authorization-kubeconfig<span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>      <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/scheduler.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p>启动 scheduler：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-scheduler</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-scheduler.service → /usr/lib/systemd/system/kube-scheduler.service.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 pki<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl status kube-scheduler</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>● kube-scheduler.service - Kubernetes Scheduler</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   Loaded: loaded <span class=\"token punctuation\">(</span>/usr/lib/systemd/system/kube-scheduler.service<span class=\"token punctuation\">;</span> enabled<span class=\"token punctuation\">;</span> vendor preset: disabled<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>   Active: active <span class=\"token punctuation\">(</span>running<span class=\"token punctuation\">)</span> since Wed <span class=\"token number\">2022</span>-05-04 <span class=\"token number\">17</span>:31:13 CST<span class=\"token punctuation\">;</span> 6s ago</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>     Docs: https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"10\"></td><td><pre> Main PID: <span class=\"token number\">5815</span> <span class=\"token punctuation\">(</span>kube-scheduler<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    Tasks: <span class=\"token number\">9</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>   Memory: <span class=\"token number\">19</span>.8M</pre></td></tr></table></figure><h4 id=\"7-tls-bootstrapping配置\"><a class=\"anchor\" href=\"#7-tls-bootstrapping配置\">#</a> 7. TLS Bootstrapping 配置</h4>\n<p>只需要在<mark> Master01</mark> 创建 bootstrap</p>\n<p>注意： 修改黄色部分的 IP 地址</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/bootstrap</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl config set-cluster kubernetes     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem     --embed-certs<span class=\"token operator\">=</span>true     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubectl config set-credentials tls-bootstrap-token-user     <span class=\"token parameter variable\">--token</span><span class=\"token operator\">=</span>c8ad9c.2e4d610cf3e7426e <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kubectl config set-context tls-bootstrap-token-user@kubernetes     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>tls-bootstrap-token-user     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>kubectl config use-context tls-bootstrap-token-user@kubernetes     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/bootstrap-kubelet.kubeconfig</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span></pre></td></tr></table></figure><p>可以正常查询集群状态，才可以继续往下，否则不行，需要排查 k8s 组件是否有故障（只要有结果即可，如果返回不一样不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get cs</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Warning: v1 ComponentStatus is deprecated <span class=\"token keyword\">in</span> v1.19+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>NAME                 STATUS    MESSAGE   ERROR</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>controller-manager   Healthy   ok        </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>scheduler            Healthy   ok        </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>etcd-0               Healthy   ok</pre></td></tr></table></figure><p>创建 bootstrap 相关资源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl create -f bootstrap.secret.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>secret/bootstrap-token-c8ad9c created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubelet-bootstrap created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-bootstrap created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/node-autoapprove-certificate-rotation created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:kube-apiserver-to-kubelet created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:kube-apiserver created</pre></td></tr></table></figure><h4 id=\"8-node节点配置\"><a class=\"anchor\" href=\"#8-node节点配置\">#</a> 8. Node 节点配置</h4>\n<h5 id=\"81-复制证书\"><a class=\"anchor\" href=\"#81-复制证书\">#</a> 8.1 复制证书</h5>\n<p><mark>Master01 节点</mark>复制证书至其他节点：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /etc/kubernetes/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>     <span class=\"token function\">ssh</span> <span class=\"token variable\">$NODE</span> <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /etc/kubernetes/pki</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>     <span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">FILE</span> <span class=\"token keyword\">in</span> pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>       <span class=\"token function\">scp</span> /etc/kubernetes/<span class=\"token variable\">$FILE</span> <span class=\"token variable\">$NODE</span>:/etc/kubernetes/<span class=\"token variable\">$&#123;FILE&#125;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>执行结果：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ca.pem                                                                                                                                                                         <span class=\"token number\">100</span>% <span class=\"token number\">1407</span>   <span class=\"token number\">459</span>.5KB/s   00:00    </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>…</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bootstrap-kubelet.kubeconfig                                                                                                                                                   <span class=\"token number\">100</span>% <span class=\"token number\">2291</span>   <span class=\"token number\">685</span>.4KB/s   00:00</pre></td></tr></table></figure><h5 id=\"82-kubelet配置\"><a class=\"anchor\" href=\"#82-kubelet配置\">#</a> 8.2 Kubelet 配置</h5>\n<p><mark>所有节点</mark>创建 Kubelet 配置目录</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 kubelet service</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim  /usr/lib/systemd/system/kubelet.service</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Kubelet</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kubelet</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">StartLimitInterval</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span><span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 kubelet service 的配置文件（也可以写到 kubelet.service）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Runtime 为 Containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># vim /etc/systemd/system/kubelet.service.d/10-kubelet.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig\"</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_SYSTEM_ARGS=--container-runtime-endpoint=unix:///run/containerd/containerd.sock\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_CONFIG_ARGS=--config=/etc/kubernetes/kubelet-conf.yml\"</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Environment</span><span class=\"token operator\">=</span><span class=\"token string\">\"KUBELET_EXTRA_ARGS=--node-labels=node.kubernetes.io/node='' \"</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kubelet <span class=\"token variable\">$KUBELET_KUBECONFIG_ARGS</span> <span class=\"token variable\">$KUBELET_CONFIG_ARGS</span> <span class=\"token variable\">$KUBELET_SYSTEM_ARGS</span> <span class=\"token variable\">$KUBELET_EXTRA_ARGS</span></pre></td></tr></table></figure><p><mark>所有节点</mark>创建 kubelet 的配置文件</p>\n<p><em>注意：如果更改了 k8s 的 service 网段，需要更改 kubelet-conf.yml 的 clusterDNS: 配置，改成 k8s Service 网段的第十个地址，比如 10.96.0.10</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/kubernetes/kubelet-conf.yml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: kubelet.config.k8s.io/v1beta1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kind: KubeletConfiguration</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>address: <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>port: <span class=\"token number\">10250</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>readOnlyPort: <span class=\"token number\">10255</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>authentication:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  anonymous:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    enabled: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    cacheTTL: 2m0s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    enabled: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  x509:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    clientCAFile: /etc/kubernetes/pki/ca.pem</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>authorization:</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  mode: Webhook</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  webhook:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    cacheAuthorizedTTL: 5m0s</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    cacheUnauthorizedTTL: 30s</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>cgroupDriver: systemd</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>cgroupsPerQOS: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>clusterDNS:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>- <span class=\"token number\">10.96</span>.0.10</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>clusterDomain: cluster.local</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>containerLogMaxFiles: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>containerLogMaxSize: 10Mi</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>contentType: application/vnd.kubernetes.protobuf</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>cpuCFSQuota: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>cpuManagerPolicy: none</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>cpuManagerReconcilePeriod: 10s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>enableControllerAttachDetach: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>enableDebuggingHandlers: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>enforceNodeAllocatable:</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>- pods</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>eventBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>eventRecordQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>evictionHard:</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  imagefs.available: <span class=\"token number\">15</span>%</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  memory.available: 100Mi</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  nodefs.available: <span class=\"token number\">10</span>%</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>  nodefs.inodesFree: <span class=\"token number\">5</span>%</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>evictionPressureTransitionPeriod: 5m0s</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>failSwapOn: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>fileCheckFrequency: 20s</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>hairpinMode: promiscuous-bridge</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>healthzBindAddress: <span class=\"token number\">127.0</span>.0.1</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>healthzPort: <span class=\"token number\">10248</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>httpCheckFrequency: 20s</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>imageGCHighThresholdPercent: <span class=\"token number\">85</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>imageGCLowThresholdPercent: <span class=\"token number\">80</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>imageMinimumGCAge: 2m0s</pre></td></tr><tr><td data-num=\"53\"></td><td><pre>iptablesDropBit: <span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>iptablesMasqueradeBit: <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>kubeAPIBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>kubeAPIQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>makeIPTablesUtilChains: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>maxOpenFiles: <span class=\"token number\">1000000</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>maxPods: <span class=\"token number\">110</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>nodeStatusUpdateFrequency: 10s</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>oomScoreAdj: <span class=\"token parameter variable\">-999</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>podPidsLimit: <span class=\"token parameter variable\">-1</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>registryBurst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>registryPullQPS: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre>resolvConf: /etc/resolv.conf</pre></td></tr><tr><td data-num=\"66\"></td><td><pre>rotateCertificates: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>runtimeRequestTimeout: 2m0s</pre></td></tr><tr><td data-num=\"68\"></td><td><pre>serializeImagePulls: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>staticPodPath: /etc/kubernetes/manifests</pre></td></tr><tr><td data-num=\"70\"></td><td><pre>streamingConnectionIdleTimeout: 4h0m0s</pre></td></tr><tr><td data-num=\"71\"></td><td><pre>syncFrequency: 1m0s</pre></td></tr><tr><td data-num=\"72\"></td><td><pre>volumeStatsAggPeriod: 1m0s</pre></td></tr></table></figure><p>启动<mark>所有节点</mark> kubelet</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> kubelet</pre></td></tr></table></figure><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Unable to update cni config: no networks found <span class=\"token keyword\">in</span> /etc/cni/net.d</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pE2ZkVK\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2ZkVK.png\" alt=\"pE2ZkVK.png\" /></a></p>\n<p><em>如果有很多报错日志，或者有大量看不懂的报错，说明 kubelet 的配置有误，需要检查 kubelet 配置</em></p>\n<p>Master01 查看集群状态 (Ready 或 NotReady 都正常)</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 bootstrap<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get node</span></pre></td></tr></table></figure><h5 id=\"83-kube-proxy配置\"><a class=\"anchor\" href=\"#83-kube-proxy配置\">#</a> 8.3 kube-proxy 配置</h5>\n<p><em>注意，如果不是高可用集群，192.168.1.70:8443 改为 master01 的地址，8443 改为 apiserver 的端口，默认是 6443</em></p>\n<p>生成 kube-proxy 的证书，以下操作只在<mark> Master01</mark> 执行</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/pki</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>cfssl gencert <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>   <span class=\"token parameter variable\">-ca</span><span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>   -ca-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>   <span class=\"token parameter variable\">-config</span><span class=\"token operator\">=</span>ca-config.json <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>   <span class=\"token parameter variable\">-profile</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>   kube-proxy-csr.json <span class=\"token operator\">|</span> cfssljson <span class=\"token parameter variable\">-bare</span> /etc/kubernetes/pki/kube-proxy</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>kubectl config set-cluster kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>     --certificate-authority<span class=\"token operator\">=</span>/etc/kubernetes/pki/ca.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>     <span class=\"token parameter variable\">--server</span><span class=\"token operator\">=</span>https://192.168.1.70:8443 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kubectl config set-credentials system:kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>     --client-certificate<span class=\"token operator\">=</span>/etc/kubernetes/pki/kube-proxy.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>     --client-key<span class=\"token operator\">=</span>/etc/kubernetes/pki/kube-proxy-key.pem <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>     --embed-certs<span class=\"token operator\">=</span>true <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kubectl config set-context system:kube-proxy@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>     <span class=\"token parameter variable\">--cluster</span><span class=\"token operator\">=</span>kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>     <span class=\"token parameter variable\">--user</span><span class=\"token operator\">=</span>system:kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kubectl config use-context system:kube-proxy@kubernetes <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>     <span class=\"token parameter variable\">--kubeconfig</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr></table></figure><p>将 kubeconfig 发送至其他节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>     <span class=\"token function\">scp</span> /etc/kubernetes/kube-proxy.kubeconfig  <span class=\"token variable\">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"3\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">NODE</span> <span class=\"token keyword\">in</span> k8s-node01 k8s-node02<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>     <span class=\"token function\">scp</span> /etc/kubernetes/kube-proxy.kubeconfig <span class=\"token variable\">$NODE</span>:/etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><mark>所有节点</mark>添加 kube-proxy 的配置和 service 文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /usr/lib/systemd/system/kube-proxy.service</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>Unit<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">Description</span><span class=\"token operator\">=</span>Kubernetes Kube Proxy</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">Documentation</span><span class=\"token operator\">=</span>https://github.com/kubernetes/kubernetes</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">After</span><span class=\"token operator\">=</span>network.target</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>Service<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">ExecStart</span><span class=\"token operator\">=</span>/usr/local/bin/kube-proxy <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  <span class=\"token parameter variable\">--config</span><span class=\"token operator\">=</span>/etc/kubernetes/kube-proxy.yaml <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token parameter variable\">--v</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">Restart</span><span class=\"token operator\">=</span>always</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token assign-left variable\">RestartSec</span><span class=\"token operator\">=</span>10s</pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>Install<span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token assign-left variable\">WantedBy</span><span class=\"token operator\">=</span>multi-user.target</pre></td></tr></table></figure><p>如果更改了集群 Pod 的网段，需要更改 kube-proxy.yaml 的 clusterCIDR 为自己的 Pod 网段：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/kubernetes/kube-proxy.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>apiVersion: kubeproxy.config.k8s.io/v1alpha1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>bindAddress: <span class=\"token number\">0.0</span>.0.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clientConnection:</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  acceptContentTypes: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  burst: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  contentType: application/vnd.kubernetes.protobuf</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  qps: <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>clusterCIDR: <span class=\"token number\">172.16</span>.0.0/16 </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configSyncPeriod: 15m0s</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>conntrack:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  max: null</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  maxPerCore: <span class=\"token number\">32768</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  min: <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  tcpCloseWaitTimeout: 1h0m0s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  tcpEstablishedTimeout: 24h0m0s</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>enableProfiling: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>healthzBindAddress: <span class=\"token number\">0.0</span>.0.0:10256</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>hostnameOverride: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>iptables:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  masqueradeAll: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  masqueradeBit: <span class=\"token number\">14</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  minSyncPeriod: 0s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  syncPeriod: 30s</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>ipvs:</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  masqueradeAll: <span class=\"token boolean\">true</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  minSyncPeriod: 5s</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  scheduler: <span class=\"token string\">\"rr\"</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  syncPeriod: 30s</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kind: KubeProxyConfiguration</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>metricsBindAddress: <span class=\"token number\">127.0</span>.0.1:10249</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>mode: <span class=\"token string\">\"ipvs\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>nodePortAddresses: null</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>oomScoreAdj: <span class=\"token parameter variable\">-999</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>portRange: <span class=\"token string\">\"\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>udpIdleTimeout: 250ms</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 kube-proxy</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now kube-proxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Created symlink /etc/systemd/system/multi-user.target.wants/kube-proxy.service → /usr/lib/systemd/system/kube-proxy.service.</pre></td></tr></table></figure><p>此时系统日志 /var/log/messages**** 显示只有如下两种信息为正常 ****，安装 calico 后即可恢复</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Unable to update cni config: no networks found <span class=\"token keyword\">in</span> /etc/cni/net.d</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pE2ZkVK\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2ZkVK.png\" alt=\"pE2ZkVK.png\" /></a></p>\n<h4 id=\"9-calico组件的安装\"><a class=\"anchor\" href=\"#9-calico组件的安装\">#</a> 9. Calico 组件的安装</h4>\n<p>以下步骤只在 master01 执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/calico/</pre></td></tr></table></figure><p>更改 calico 的网段，主要需要将红色部分的网段，改为自己的 Pod 网段</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#POD_CIDR#172.16.0.0/16#g\"</span> calico.yaml</pre></td></tr></table></figure><p><em>检查网段是自己的 Pod 网段， grep &quot;IPV4POOL_CIDR&quot; calico.yaml  -A 1</em></p>\n<p>查看容器和节点状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 calico<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                       READY   STATUS    RESTARTS      AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>calico-kube-controllers-66686fdb54-mk2g6   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>20s ago<span class=\"token punctuation\">)</span>   85s</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>calico-node-8fxqp                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             85s</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>calico-node-8nkfl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>calico-node-pmpf4                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>calico-node-vnlk7                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>calico-node-xpchb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             85s</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>calico-typha-67c6dc57d6-259t8              <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>             86s</pre></td></tr></table></figure><p><em>如果容器状态异常可以使用 kubectl describe 或者 kubectl logs 查看容器的日志</em></p>\n<ol>\n<li>Kubectl logs -f POD_NAME -n kube-system</li>\n<li>Kubectl logs -f POD_NAME -c upgrade-ipam -n kube-system</li>\n</ol>\n<h4 id=\"10-安装coredns\"><a class=\"anchor\" href=\"#10-安装coredns\">#</a> 10. 安装 CoreDNS</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/</pre></td></tr></table></figure><p>如果更改了 k8s service 的网段需要将 coredns 的 serviceIP 改成 k8s service 网段的第十个 IP</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">COREDNS_SERVICE_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span>kubectl get svc <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> kubernetes <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'&#123;print $3&#125;'</span><span class=\"token variable\">`</span></span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#KUBEDNS_SERVICE_IP#<span class=\"token variable\">$&#123;COREDNS_SERVICE_IP&#125;</span>#g\"</span> CoreDNS/coredns.yaml</pre></td></tr></table></figure><p>安装 coredns</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 k8s-ha-install<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f CoreDNS/coredns.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>serviceaccount/coredns created</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:coredns created</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>configmap/coredns created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>deployment.apps/coredns created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>service/kube-dns created</pre></td></tr></table></figure><h4 id=\"11-metrics部署\"><a class=\"anchor\" href=\"#11-metrics部署\">#</a> 11. Metrics 部署</h4>\n<p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>\n<p>以下操作均在<mark> master01 节点</mark>执行，安装 metrics server:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/metrics-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>kubectl  create <span class=\"token parameter variable\">-f</span> <span class=\"token builtin class-name\">.</span> </pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/metrics-server created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>service/metrics-server created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>deployment.apps/metrics-server created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</pre></td></tr></table></figure><p>等待 metrics server 启动然后查看状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl  top node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   CPU%   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   MEMORY%   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   231m         <span class=\"token number\">5</span>%     1620Mi          <span class=\"token number\">42</span>%       </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   274m         <span class=\"token number\">6</span>%     1203Mi          <span class=\"token number\">31</span>%       </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   202m         <span class=\"token number\">5</span>%     1251Mi          <span class=\"token number\">32</span>%       </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     69m          <span class=\"token number\">1</span>%     667Mi           <span class=\"token number\">17</span>%       </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     73m          <span class=\"token number\">1</span>%     650Mi           <span class=\"token number\">16</span>%</pre></td></tr></table></figure><p>如果有如下报错，可以等待 10 分钟后，再次查看：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Error from server <span class=\"token punctuation\">(</span>ServiceUnavailable<span class=\"token punctuation\">)</span>: the server is currently unable to handle the request <span class=\"token punctuation\">(</span>get nodes.metrics.k8s.io<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"12-dashboard部署\"><a class=\"anchor\" href=\"#12-dashboard部署\">#</a> 12. Dashboard 部署</h4>\n<h5 id=\"121-安装dashboard\"><a class=\"anchor\" href=\"#121-安装dashboard\">#</a> 12.1 安装 Dashboard</h5>\n<p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/dashboard/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 dashboard<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f .</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/admin-user created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/admin-user created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>namespace/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serviceaccount/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>secret/kubernetes-dashboard-certs created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>secret/kubernetes-dashboard-csrf created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>secret/kubernetes-dashboard-key-holder created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configmap/kubernetes-dashboard-settings created</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>role.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>service/dashboard-metrics-scraper created</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>deployment.apps/dashboard-metrics-scraper created</pre></td></tr></table></figure><h5 id=\"122-登录dashboard\"><a class=\"anchor\" href=\"#122-登录dashboard\">#</a> 12.2 登录 dashboard</h5>\n<p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问 Dashboard 的问题，参考下图：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>--test-type --ignore-certificate-errors</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgWfHJ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgWfHJ.png\" alt=\"pEgWfHJ.png\" /></a></p>\n<p>更改 dashboard 的 svc 为 NodePort:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit svc kubernetes-dashboard <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgW5NR\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW5NR.png\" alt=\"pEgW5NR.png\" /></a></p>\n<p><em>将 ClusterIP 更改为 NodePort（如果已经为 NodePort 忽略此步骤）</em></p>\n<p>查看端口号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>         AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubernetes-dashboard   NodePort   <span class=\"token number\">10.96</span>.139.11   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>:32409/TCP   24h</pre></td></tr></table></figure><p>根据自己的实例端口号，通过任意安装了 kube-proxy 的宿主机的 IP + 端口即可访问到 dashboard：</p>\n<p>访问 Dashboard：<a href=\"https://192.168.181.129:31106\">https://192.168.1.71:32409</a> （把 IP 地址和端口改成你自己的）选择登录方式为令牌（即 token 方式），参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgW736\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW736.png\" alt=\"pEgW736.png\" /></a></p>\n<p>创建登录 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create token admin-user <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>将 token 值输入到令牌后，单击登录即可访问 Dashboard，参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgfPv8\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgfPv8.png\" alt=\"pEgfPv8.png\" /></a></p>\n<h4 id=\"14-containerd配置镜像加速\"><a class=\"anchor\" href=\"#14-containerd配置镜像加速\">#</a> 14. Containerd 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/containerd/config.toml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加以下配置镜像加速服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"docker.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://registry-1.docker.io\"</span>, <span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"registry.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span>, <span class=\"token string\">\"https://k8s.m.daocloud.io\"</span>, <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hub-mirror.c.163.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>所有节点重新启动 Containerd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl restart containerd</span></pre></td></tr></table></figure><h4 id=\"15-docker配置镜像加速\"><a class=\"anchor\" href=\"#15-docker配置镜像加速\">#</a> 15. Docker 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr></table></figure><p>所有节点重新启动 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now docker</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2628187572.html",
            "url": "http://ixuyong.cn/posts/2628187572.html",
            "title": "MySQL运维DBA应用与实践",
            "date_published": "2025-04-09T14:02:40.000Z",
            "content_html": "<h3 id=\"mysql运维dba应用与实践\"><a class=\"anchor\" href=\"#mysql运维dba应用与实践\">#</a> MySQL 运维 DBA 应用与实践</h3>\n<h4 id=\"1日志\"><a class=\"anchor\" href=\"#1日志\">#</a> 1. 日志</h4>\n<p>在任何一种数据库中，都会有各种各样的日志，这些日志记录了数据库运行的各个方面。可以帮助数据库管理员追踪数据库曾经发生的一些事情。</p>\n<p>对于 MySQL 数据库，提供了四种不同的日志帮助我们追踪。</p>\n<ul>\n<li>\n<p>错误日志</p>\n</li>\n<li>\n<p>二进制日志</p>\n</li>\n<li>\n<p>查询日志</p>\n</li>\n<li>\n<p>慢查询日志</p>\n</li>\n</ul>\n<h5 id=\"11-错误日志\"><a class=\"anchor\" href=\"#11-错误日志\">#</a> 1.1 错误日志</h5>\n<p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld (MySQL 服务) 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</p>\n<p>该日志是默认开启的，默认存放目录 /var/log/，默认的日志文件名为 mysqld.log。查看日志位置；</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'%log_error%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>+---------------------+---------------------+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> Variable_name       <span class=\"token operator\">|</span> Value               <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+---------------------+---------------------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> binlog_error_action <span class=\"token operator\">|</span> ABORT_SERVER        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> log_error           <span class=\"token operator\">|</span> /var/log/mysqld.log <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> log_error_verbosity <span class=\"token operator\">|</span> <span class=\"token number\">3</span>                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>+---------------------+---------------------+</pre></td></tr></table></figure><h5 id=\"12-二进制日志\"><a class=\"anchor\" href=\"#12-二进制日志\">#</a> 1.2 二进制日志</h5>\n<p>二进制日志 (BINLOG) 记录了所有的 DDL (数据定义语言) 语句和 DML (数据操纵语言) 语句，但不包括数据查询（SELECT、 SHOW）语句。</p>\n<p>作用:</p>\n<p>①. 灾难时的数据恢复；</p>\n<p>②. MySQL 的主从复制。</p>\n<p>在 MySQL5.7 版本中，默认二进制日志是关闭着的，涉及到的参数如下:</p>\n<h6 id=\"121-开启-bin-log记录\"><a class=\"anchor\" href=\"#121-开启-bin-log记录\">#</a> 1.2.1 开启 bin-log 记录</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">1.1</span>改修配置文件</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server-id<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>log-bin<span class=\"token operator\">=</span>mysql-bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">max_binlog_size</span><span class=\"token operator\">=</span>500M</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">expire_logs_days</span><span class=\"token operator\">=</span><span class=\"token number\">15</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">1.2</span>查看是否开启binlog.</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'log_%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>+----------------------------------------+--------------------------------+</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> Variable_name                          <span class=\"token operator\">|</span> Value                          <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>+----------------------------------------+--------------------------------+</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">|</span> log_bin                                <span class=\"token operator\">|</span> ON                             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">|</span> log_bin_basename                       <span class=\"token operator\">|</span> /var/lib/mysql/mysql-bin       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> log_bin_index                          <span class=\"token operator\">|</span> /var/lib/mysql/mysql-bin.index <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">|</span> log_bin_trust_function_creators        <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> log_bin_use_v1_row_events              <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">|</span> log_builtin_as_identified_by_password  <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">|</span> log_error                              <span class=\"token operator\">|</span> /var/log/mysqld.log            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">|</span> log_error_verbosity                    <span class=\"token operator\">|</span> <span class=\"token number\">3</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token operator\">|</span> log_output                             <span class=\"token operator\">|</span> FILE                           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">|</span> log_queries_not_using_indexes          <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token operator\">|</span> log_slave_updates                      <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">|</span> log_slow_admin_statements              <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> log_slow_slave_statements              <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token operator\">|</span> log_statements_unsafe_for_binlog       <span class=\"token operator\">|</span> ON                             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> log_syslog                             <span class=\"token operator\">|</span> OFF                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token operator\">|</span> log_syslog_facility                    <span class=\"token operator\">|</span> daemon                         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> log_syslog_include_pid                 <span class=\"token operator\">|</span> ON                             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> log_syslog_tag                         <span class=\"token operator\">|</span>                                <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">|</span> log_throttle_queries_not_using_indexes <span class=\"token operator\">|</span> <span class=\"token number\">0</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token operator\">|</span> log_timestamps                         <span class=\"token operator\">|</span> UTC                            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token operator\">|</span> log_warnings                           <span class=\"token operator\">|</span> <span class=\"token number\">2</span>                              <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>+----------------------------------------+--------------------------------+</pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token number\">1.3</span>查看binlog</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>mysql<span class=\"token operator\">></span> show binary logs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>+------------------+-----------+</pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token operator\">|</span> Log_name         <span class=\"token operator\">|</span> File_size <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>+------------------+-----------+</pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000001 <span class=\"token operator\">|</span>     <span class=\"token number\">36825</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000002 <span class=\"token operator\">|</span>    <span class=\"token number\">200464</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000003 <span class=\"token operator\">|</span>    <span class=\"token number\">419809</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>+------------------+-----------+</pre></td></tr><tr><td data-num=\"45\"></td><td><pre></pre></td></tr><tr><td data-num=\"46\"></td><td><pre><span class=\"token number\">1.4</span>查看binlog日志保存天数 </pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token comment\"># 0 表示永久保留，expire_logs_days：保留指定日期范围内的 binlog 历史日志，上示例设置的 15 天内</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'expire_logs_days'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>+------------------+-------+</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token operator\">|</span> Variable_name    <span class=\"token operator\">|</span> Value <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>+------------------+-------+</pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token operator\">|</span> expire_logs_days <span class=\"token operator\">|</span> <span class=\"token number\">15</span>    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>+------------------+-------+</pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token number\">1.5</span>查看binlog日志保存大小</pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token comment\">#max_binlog_size：bin log 日志每达到设定大小后，会使用新的 bin log 日志。如 mysql-bin.000002 达到 500M 后，创建并使用 mysql-bin.000003 文件作为日志记录。</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'max_binlog_size'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>+-----------------+-----------+</pre></td></tr><tr><td data-num=\"60\"></td><td><pre><span class=\"token operator\">|</span> Variable_name   <span class=\"token operator\">|</span> Value     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>+-----------------+-----------+</pre></td></tr><tr><td data-num=\"62\"></td><td><pre><span class=\"token operator\">|</span> max_binlog_size <span class=\"token operator\">|</span> <span class=\"token number\">524288000</span> <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>+-----------------+-----------+</pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token number\">1.6</span>手动执行flush logs</pre></td></tr><tr><td data-num=\"66\"></td><td><pre><span class=\"token comment\">#将会 new 一个新文件用于记录 binlog</span></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>mysql<span class=\"token operator\">></span> flush logs<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre></pre></td></tr><tr><td data-num=\"69\"></td><td><pre><span class=\"token number\">1.7</span>手动清理binlog</pre></td></tr><tr><td data-num=\"70\"></td><td><pre><span class=\"token comment\">#将 mysql-bin.000010 之前的日志清理掉</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>mysql<span class=\"token operator\">></span> purge binary logs to <span class=\"token string\">'mysql-bin.000010'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>Query OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre></pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token comment\">#删除 2022-04-21 18:08:00 之前的 binlog 日志</span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>mysql<span class=\"token operator\">></span> purge binary logs before <span class=\"token string\">'2022-04-21 18:08:00'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre></pre></td></tr><tr><td data-num=\"77\"></td><td><pre><span class=\"token comment\">#清除全部 binlog</span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>mysql<span class=\"token operator\">></span> reset master<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h6 id=\"122-日志格式\"><a class=\"anchor\" href=\"#122-日志格式\">#</a> <strong>1.2.2 日志格式</strong></h6>\n<p>MySQL 服务器中提供了多种格式来记录二进制日志，具体格式及特点如下：</p>\n<table>\n<thead>\n<tr>\n<th><strong>日志格式</strong></th>\n<th><strong>含义</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>STATEMENT</td>\n<td>基于 SQL 语句的日志记录，记录的是 SQL 语句，对数据进行修改的 SQL 都会记录在日志文件中。</td>\n</tr>\n<tr>\n<td>ROW</td>\n<td>基于行的日志记录，记录的是每一行的数据变更。(默认)</td>\n</tr>\n<tr>\n<td>MIXED</td>\n<td>混合了 STATEMENT 和 ROW 两种格式，默认采用 STATEMENT, 在某些特殊情况下会自动切换为 ROW 进行记录。</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'binlog_format'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>+---------------+-------+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> Variable_name <span class=\"token operator\">|</span> Value <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+---------------+-------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> binlog_format <span class=\"token operator\">|</span> ROW   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>+---------------+-------+</pre></td></tr></table></figure><p>由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具 <code>mysqlbinlog</code>  来查看，具体语法:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysqlbinlog <span class=\"token punctuation\">[</span> 参数选项<span class=\"token punctuation\">]</span> logfilename</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>参数选项:</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token parameter variable\">-d</span>\t\t\t指定数据库名称，只列出指定的数据库相关操作。</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t<span class=\"token parameter variable\">-o</span>\t\t\t忽略掉日志中的前n行命令。</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token parameter variable\">-v</span>\t\t\t将行事件<span class=\"token punctuation\">(</span>数据变更<span class=\"token punctuation\">)</span>重构为SQL语句</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t<span class=\"token parameter variable\">-vv</span>\t\t\t将行事件<span class=\"token punctuation\">(</span>数据变更<span class=\"token punctuation\">)</span>重构为SQL语句，并输出注释信息</pre></td></tr></table></figure><figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> use zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Database changed</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> Tables_in_zh   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> account        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> course         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> dept           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> emp            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">|</span> score          <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">|</span> student        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token operator\">|</span> student_course <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token operator\">|</span> tb_user        <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> tb_user_edu    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token operator\">|</span> user           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> user1          <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">11</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span>  update tb_user_edu <span class=\"token builtin class-name\">set</span> university <span class=\"token operator\">=</span> <span class=\"token string\">\"北京大学\"</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>Query OK, <span class=\"token number\">4</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Rows matched: <span class=\"token number\">4</span>  Changed: <span class=\"token number\">4</span>  Warnings: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token comment\">#二进制日志查看</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysqlbinlog -v /var/lib/mysql/mysql-bin.000001</span></pre></td></tr></table></figure><h6 id=\"123-修改binlog格式\"><a class=\"anchor\" href=\"#123-修改binlog格式\">#</a> 1.2.3 修改 binlog 格式</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">binlog_format</span><span class=\"token operator\">=</span>STATEMENT</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart mysqld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>mysql<span class=\"token operator\">></span>  update tb_user_edu <span class=\"token builtin class-name\">set</span> university <span class=\"token operator\">=</span> <span class=\"token string\">'清华大学'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysqlbinlog -v /var/lib/mysql/mysql-bin.000002 </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>SET <span class=\"token assign-left variable\">TIMESTAMP</span><span class=\"token operator\">=</span><span class=\"token number\">1701440373</span>/*<span class=\"token operator\">!</span>*/<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>update tb_user_edu <span class=\"token builtin class-name\">set</span> university <span class=\"token operator\">=</span> <span class=\"token string\">'清华大学'</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"13-查询日志\"><a class=\"anchor\" href=\"#13-查询日志\">#</a> 1.3 查询日志</h5>\n<p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的 SQL 语句。默认情况下，<strong>查询日志是未开启的</strong>。如果需要开启查询日志，可以设置以下配置︰</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> show variables like <span class=\"token string\">'%general%'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>+------------------+-------------------------+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> Variable_name    <span class=\"token operator\">|</span> Value                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+------------------+-------------------------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> general_log      <span class=\"token operator\">|</span> OFF                     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> general_log_file <span class=\"token operator\">|</span> /var/lib/mysql/db01.log <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>+------------------+-------------------------+</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#开启查询日志功能</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">general_log</span><span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">general_log_file</span><span class=\"token operator\">=</span>/var/lib/mysql/mysql_query.log </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart mysqld</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /var/lib/mysql/mysql_query.log </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:31:28.554384Z\t    <span class=\"token number\">2</span> Field List\tstudent </pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:31:28.554743Z\t    <span class=\"token number\">2</span> Field List\tstudent_course </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:31:35.737041Z\t    <span class=\"token number\">2</span> Query\tshow variables like <span class=\"token string\">'%general%'</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:31:37.345179Z\t    <span class=\"token number\">2</span> Query\tshow variables like <span class=\"token string\">'%general%'</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:32:17.593471Z\t    <span class=\"token number\">2</span> Query\tSELECT DATABASE<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:32:17.593651Z\t    <span class=\"token number\">2</span> Init DB\tzh</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token number\">2023</span>-12-01T14:32:25.249258Z\t    <span class=\"token number\">2</span> Query\t<span class=\"token keyword\">select</span> * from emp</pre></td></tr></table></figure><h5 id=\"14-慢查询日志\"><a class=\"anchor\" href=\"#14-慢查询日志\">#</a> 1.4 慢查询日志</h5>\n<p>慢查询<a href=\"https://so.csdn.net/so/search?q=%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95&amp;spm=1001.2101.3001.7020\">日志记录</a>了所有执行时间超过参数 <code>long_ query_time</code>  设置值并且扫描记录数不小于 <code>min_examined_row_limit</code>  的所有的 SQL 语句的日志，默认未开启。<strong> <code>long_query_time</code>  默认为 10 秒，最小为 0，精度可以到微秒。</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#慢查询日志</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">slow_query_log</span><span class=\"token operator\">=</span>on</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">## 执行时间参数</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">long_query_time</span><span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># 若没有指定，默认名字为 hostname_slow.log</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>slow_query_log_file <span class=\"token operator\">=</span> /var/lib/mysql/slow-query.log</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart mysqld</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#制造慢查询并执行</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /var/lib/mysql/slow-query.log </span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>/usr/sbin/mysqld, Version: <span class=\"token number\">5.7</span>.43-log <span class=\"token punctuation\">(</span>MySQL Community Server <span class=\"token punctuation\">(</span>GPL<span class=\"token punctuation\">))</span>. started with:</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Tcp port: <span class=\"token number\">0</span>  Unix socket: /var/lib/mysql/mysql.sock</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>Time                 Id Command    Argument</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># Time: 2023-12-01T14:47:57.763735Z</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># User@Host: root[root] @ localhost []  Id:     2</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\"># Query_time: 3.001229  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>use zh<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>SET <span class=\"token assign-left variable\">timestamp</span><span class=\"token operator\">=</span><span class=\"token number\">1701442077</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token keyword\">select</span> sleep<span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以使用 <code>log_slow_admin_statements</code>  和更改此行为 <code>log_queries_not_using_indexes</code> , 如下所述。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#记录执行较慢的管理语句</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>log_slow_admin_statements <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#记录执行较慢的未使用索引的语句</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>log_queries_not_using_indexes <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr></table></figure><h4 id=\"2-主从复制\"><a class=\"anchor\" href=\"#2-主从复制\">#</a> 2. 主从复制</h4>\n<h5 id=\"21-主从复制的概述\"><a class=\"anchor\" href=\"#21-主从复制的概述\">#</a> 2.1 主从复制的概述</h5>\n<p>主从复制是指将<strong>主数据库的 DDL 和 DML 操作</strong>通过<strong>二进制日志</strong>传到<strong>从库服务器</strong>中，然后在从库上对这些日志重新执行 (也叫重做) ，从而使得从库和主库的数据保持同步。</p>\n<p><a href=\"https://imgse.com/i/pEgO0Mj\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgO0Mj.png\" alt=\"pEgO0Mj.png\" /></a></p>\n<p>MySQL 支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库， 实现链状复制。</p>\n<p>MySQL 复制的有点主要包含以下三个方面：</p>\n<ol>\n<li>主库出现问题，可以快速切换到从库提供服务；</li>\n<li>实现读写分离，降低主库的访问压力；（如果增删改对主库 查询对从库）</li>\n<li>可以在从库中执行备份，以避免备份期间影响主库服务。</li>\n</ol>\n<h5 id=\"22-主从复制的原理\"><a class=\"anchor\" href=\"#22-主从复制的原理\">#</a> 2.2 主从复制的原理</h5>\n<p><a href=\"https://imgse.com/i/pEgOdzQ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgOdzQ.png\" alt=\"pEgOdzQ.png\" /></a></p>\n<p>从上图来看，复制分成三步：</p>\n<ol>\n<li>Master 主库在事务提交时，会把数据变更记录在二进制日志文件 Binlog 中。</li>\n<li>从库 IO 线程读取主库的二进制日志文件 Binlog，写入到从库的中继日志 Relay Log。</li>\n<li>slave 重做中继日志中的事件，SQL 线程将改变反映它自己的数据。</li>\n</ol>\n<h5 id=\"23-主从复制的搭建\"><a class=\"anchor\" href=\"#23-主从复制的搭建\">#</a> 2.3 主从复制的搭建</h5>\n<p><strong>主从复制的搭建步骤</strong>：</p>\n<ol>\n<li>准备主从复制服务器环境</li>\n<li>完成主库配置</li>\n<li>完成从库配置</li>\n</ol>\n<h6 id=\"231-服务器准备\"><a class=\"anchor\" href=\"#231-服务器准备\">#</a> 2.3.1 服务器准备</h6>\n<p><a href=\"https://imgse.com/i/pEgODLn\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgODLn.png\" alt=\"pEgODLn.png\" /></a></p>\n<h6 id=\"232-主库配置\"><a class=\"anchor\" href=\"#232-主库配置\">#</a> 2.3.2 主库配置</h6>\n<p><strong>#1. 安装 MySQL</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1、关闭防火墙、selinux、环境配置</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname db01</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#2、安装 Mysql5.7</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y mysql-community-server</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start mysqld &amp;&amp; systemctl enable mysqld</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -uroot -p$(awk '/temporary password/&#123;print $NF&#125;' /var/log/mysqld.log)</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>mysql<span class=\"token operator\">></span> ALTER <span class=\"token environment constant\">USER</span> <span class=\"token string\">'root'</span>@<span class=\"token string\">'localhost'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> grant all on *.* to <span class=\"token string\">'root'</span>@<span class=\"token string\">'192.168.1.%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#3、允许 root 用户在任何地方进行远程登录，并具有所有库任何操作权限，具体操作如下：</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql <span class=\"token parameter variable\">-u</span> root -p<span class=\"token string\">\"youpass\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>mysql<span class=\"token operator\">></span>GRANT ALL PRIVILEGES ON *.* TO <span class=\"token string\">'root'</span>@<span class=\"token string\">'%'</span> IDENTIFIED BY <span class=\"token string\">'passwd'</span> WITH GRANT OPTION<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>FLUSH PRIVILEGES<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#4. 配置主库</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>server-id<span class=\"token operator\">=</span><span class=\"token number\">1</span>                <span class=\"token comment\">#mysql 服务 ID，保证整个集群环境中唯一， 取值范围: 1 - 2^&#123;32&#125;-1</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>log-bin<span class=\"token operator\">=</span>mysql-bin          <span class=\"token comment\">#启动二进制日志</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>read-only<span class=\"token operator\">=</span><span class=\"token number\">0</span>                <span class=\"token comment\">#是否只读，1 代表只读，0 代表读写</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\">#binlog-ignore-db=mysql    #忽略的数据，指不需要同步的数据库</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#binlog-do-db=db01         #指定同步的数据库</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart mysqld</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#5. 创建 repl 用户，并设置密码，该用户可在任意主机连接该 MySQL 服务</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>mysql<span class=\"token operator\">></span> grant replication slave on *.* to <span class=\"token string\">'repl'</span>@<span class=\"token string\">'%'</span> identified by <span class=\"token string\">'passwd'</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">#6. 查看 master 位置点</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>mysql<span class=\"token operator\">></span> show master status<span class=\"token punctuation\">;</span>        </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token operator\">|</span> File             <span class=\"token operator\">|</span> Position <span class=\"token operator\">|</span> Binlog_Do_DB <span class=\"token operator\">|</span> Binlog_Ignore_DB <span class=\"token operator\">|</span> Executed_Gtid_Set <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token operator\">|</span> mysql-bin.000006 <span class=\"token operator\">|</span>      <span class=\"token number\">889</span> <span class=\"token operator\">|</span>              <span class=\"token operator\">|</span>                  <span class=\"token operator\">|</span>                   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>+------------------+----------+--------------+------------------+-------------------+</pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h6 id=\"233-从库配置\"><a class=\"anchor\" href=\"#233-从库配置\">#</a> 2.3.3 从库配置</h6>\n<table>\n<thead>\n<tr>\n<th>参数名</th>\n<th>含义</th>\n<th><strong>8.0.23 之前</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>SOURCE_HOST</td>\n<td>主库 IP 地址</td>\n<td>MASTER_HOST</td>\n</tr>\n<tr>\n<td>SOURCE_USER</td>\n<td>连接主库的用户名</td>\n<td>MASTER_USER</td>\n</tr>\n<tr>\n<td>SOURCE_PASSWORD</td>\n<td>连接主库的密码</td>\n<td>MASTER_PASSWORD</td>\n</tr>\n<tr>\n<td>SOURCE_LOG FILE</td>\n<td>binlog 日志文件名</td>\n<td>MASTER LOG_FILE</td>\n</tr>\n<tr>\n<td>SOURCE_LOG POS</td>\n<td>binlog 日志文件位置</td>\n<td>MASTER_LOG_POS</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 配置从库</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/my.cnf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>server-id<span class=\"token operator\">=</span><span class=\"token number\">2</span>           <span class=\"token comment\">#mysql 服务 ID</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>read-only<span class=\"token operator\">=</span><span class=\"token number\">1</span>           <span class=\"token comment\">#是否只读，1 代表只读，0 代表读写</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@db02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart mysqld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token comment\">#2.. 配置从服务器，连接主服务器</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>mysql<span class=\"token operator\">></span> change master to <span class=\"token assign-left variable\">master_host</span><span class=\"token operator\">=</span><span class=\"token string\">'192.168.40.150'</span>,master_user<span class=\"token operator\">=</span><span class=\"token string\">'repl'</span>,master_password<span class=\"token operator\">=</span><span class=\"token string\">'passwd'</span>,master_log_file<span class=\"token operator\">=</span><span class=\"token string\">'mysql-bin.000006'</span>,master_log_pos<span class=\"token operator\">=</span><span class=\"token number\">889</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#3. 开启从库</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>mysql<span class=\"token operator\">></span> start slave<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Query OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#4. 检查主从复制状态</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>mysql<span class=\"token operator\">></span> show slave status<span class=\"token punctuation\">\\</span>G</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>*************************** <span class=\"token number\">1</span>. row ***************************</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>               Slave_IO_State: Waiting <span class=\"token keyword\">for</span> master to send event</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>                  Master_Host: <span class=\"token number\">192.168</span>.40.150</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                  Master_User: repl</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>                  Master_Port: <span class=\"token number\">3306</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>                Connect_Retry: <span class=\"token number\">60</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>              Master_Log_File: mysql-bin.000006</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>          Read_Master_Log_Pos: <span class=\"token number\">889</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>               Relay_Log_File: db02-relay-bin.000002</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>                Relay_Log_Pos: <span class=\"token number\">320</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        Relay_Master_Log_File: mysql-bin.000006</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>             Slave_IO_Running: Yes</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>            Slave_SQL_Running: Yes</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>              Replicate_Do_DB: </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>          Replicate_Ignore_DB: </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>           Replicate_Do_Table: </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>       Replicate_Ignore_Table: </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>      Replicate_Wild_Do_Table: </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  Replicate_Wild_Ignore_Table: </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>                   Last_Errno: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>                   Last_Error: </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>                 Skip_Counter: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>          Exec_Master_Log_Pos: <span class=\"token number\">889</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>              Relay_Log_Space: <span class=\"token number\">526</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>              Until_Condition: None</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>               Until_Log_File: </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>                Until_Log_Pos: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>           Master_SSL_Allowed: No</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>           Master_SSL_CA_File: </pre></td></tr><tr><td data-num=\"45\"></td><td><pre>           Master_SSL_CA_Path: </pre></td></tr><tr><td data-num=\"46\"></td><td><pre>              Master_SSL_Cert: </pre></td></tr><tr><td data-num=\"47\"></td><td><pre>            Master_SSL_Cipher: </pre></td></tr><tr><td data-num=\"48\"></td><td><pre>               Master_SSL_Key: </pre></td></tr><tr><td data-num=\"49\"></td><td><pre>        Seconds_Behind_Master: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>Master_SSL_Verify_Server_Cert: No</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>                Last_IO_Errno: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>                Last_IO_Error: </pre></td></tr><tr><td data-num=\"53\"></td><td><pre>               Last_SQL_Errno: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>               Last_SQL_Error: </pre></td></tr><tr><td data-num=\"55\"></td><td><pre>  Replicate_Ignore_Server_Ids: </pre></td></tr><tr><td data-num=\"56\"></td><td><pre>             Master_Server_Id: <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>                  Master_UUID: 9b911bea-43e6-11ee-b239-000c29074f5d</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>             Master_Info_File: /var/lib/mysql/master.info</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>                    SQL_Delay: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>          SQL_Remaining_Delay: NULL</pre></td></tr><tr><td data-num=\"61\"></td><td><pre>      Slave_SQL_Running_State: Slave has <span class=\"token builtin class-name\">read</span> all relay log<span class=\"token punctuation\">;</span> waiting <span class=\"token keyword\">for</span> <span class=\"token function\">more</span> updates</pre></td></tr><tr><td data-num=\"62\"></td><td><pre>           Master_Retry_Count: <span class=\"token number\">86400</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>                  Master_Bind: </pre></td></tr><tr><td data-num=\"64\"></td><td><pre>      Last_IO_Error_Timestamp: </pre></td></tr><tr><td data-num=\"65\"></td><td><pre>     Last_SQL_Error_Timestamp: </pre></td></tr><tr><td data-num=\"66\"></td><td><pre>               Master_SSL_Crl: </pre></td></tr><tr><td data-num=\"67\"></td><td><pre>           Master_SSL_Crlpath: </pre></td></tr><tr><td data-num=\"68\"></td><td><pre>           Retrieved_Gtid_Set: </pre></td></tr><tr><td data-num=\"69\"></td><td><pre>            Executed_Gtid_Set: </pre></td></tr><tr><td data-num=\"70\"></td><td><pre>                Auto_Position: <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"71\"></td><td><pre>         Replicate_Rewrite_DB: </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>                 Channel_Name: </pre></td></tr><tr><td data-num=\"73\"></td><td><pre>           Master_TLS_Version: </pre></td></tr><tr><td data-num=\"74\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><h4 id=\"3-分库分表\"><a class=\"anchor\" href=\"#3-分库分表\">#</a> 3. <a href=\"https://so.csdn.net/so/search?q=%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8&amp;spm=1001.2101.3001.7020\">分库分表</a></h4>\n<h5 id=\"31-分库分表介绍\"><a class=\"anchor\" href=\"#31-分库分表介绍\">#</a> 3.1 分库分表介绍</h5>\n<h6 id=\"311-现在的问题\"><a class=\"anchor\" href=\"#311-现在的问题\">#</a> 3.1.1 现在的问题</h6>\n<p><strong>单数据库</strong></p>\n<p>所有数据都是存放在一个<a href=\"https://so.csdn.net/so/search?q=%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%87%E4%BB%B6&amp;spm=1001.2101.3001.7020\">数据库文件</a>里的，经过常年累月，内存不足了怎么办？</p>\n<p><a href=\"https://imgse.com/i/pEgOyd0\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgOyd0.png\" alt=\"pEgOyd0.png\" /></a></p>\n<p>随着互联网及移动互联网的发展，应用系统的数据量也是成指数式增长，若采用单数据库进行数据存储，存在以下性能瓶颈：</p>\n<p>IO 瓶颈：热点数据太多，数据库缓存不足，产生大量磁盘 IO，效率较低。请求数据太多，带宽不够，网络 IO 瓶颈。<br />\nCPU 瓶颈： 排序、分组、连接查询、聚合统计等 SQL 会耗费大量的 CPU 资源，请求数太多，CPU 出现瓶颈。</p>\n<p><a href=\"https://imgse.com/i/pEgO6oV\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgO6oV.png\" alt=\"pEgO6oV.png\" /></a></p>\n<p><strong>分库分表的中心思想：<br />\n将数据分散存储，使得单一数据库 / 表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。</strong></p>\n<h6 id=\"312-拆分策略\"><a class=\"anchor\" href=\"#312-拆分策略\">#</a> 3.1.2 拆分策略</h6>\n<p><a href=\"https://imgse.com/i/pE2dAXt\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2dAXt.png\" alt=\"pE2dAXt.png\" /></a></p>\n<h6 id=\"313-垂直拆分策略\"><a class=\"anchor\" href=\"#313-垂直拆分策略\">#</a> 3.1.3 垂直拆分策略</h6>\n<p><a href=\"https://imgse.com/i/pE2dnAS\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2dnAS.png\" alt=\"pE2dnAS.png\" /></a></p>\n<p>特点:</p>\n<ol>\n<li>每个库的表结构都不一样。</li>\n<li>每个库的数据也不一样 。</li>\n<li>所有，库的并集是全量数据。</li>\n</ol>\n<p><a href=\"https://imgse.com/i/pE2dQpj\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2dQpj.png\" alt=\"pE2dQpj.png\" /></a></p>\n<p>特点:</p>\n<ol>\n<li>每个表的结构都不一样。</li>\n<li>每个表的数据也术一样，一般通过一列 (主键 / 外键) 关联。</li>\n<li>所有表的并集是全量数据。</li>\n</ol>\n<h6 id=\"314-水平拆分策略\"><a class=\"anchor\" href=\"#314-水平拆分策略\">#</a> 3.1.4 水平拆分策略</h6>\n<p><a href=\"https://imgse.com/i/pE2d3Xq\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/10/pE2d3Xq.png\" alt=\"pE2d3Xq.png\" /></a></p>\n<p>水平分库：以 “字段” 为依据，改为以 “行（记录）” 为依据。讲一个库的数据拆分到多个库</p>\n<p>特点：</p>\n<ol>\n<li>每个库的表结构都一样。</li>\n<li>每个库的数据都不一样。</li>\n<li>所有库的并集是全量数据。</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8Vp5L6j.png\" alt=\"1.png\" /></p>\n<p>特点：</p>\n<ol>\n<li>每个表的表结构都一样 。</li>\n<li>每个表的数据都不一样 。</li>\n<li>所有表的并集是全量数据。</li>\n</ol>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/2ctPFwi.png\" alt=\"2.png\" /></p>\n<ul>\n<li>shardingJDBC：基于 AOP 原理，在应用程序中对本地执行的 SQL 进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持 java 语言，性能较高。</li>\n<li>MyCat：数据库分库分表中间件，不用调整代码即可实现分库分表，支持多种语言，性能不及前者。</li>\n</ul>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/lgs1r8g.png\" alt=\"3.png\" /></p>\n<h5 id=\"32-mycat概述\"><a class=\"anchor\" href=\"#32-mycat概述\">#</a> 3.2 Mycat 概述</h5>\n<p>Mycat 是开源的、活跃的、基于 Java 语言编写的<strong> MySQL 数据库中间件</strong>。可以像使用 mysql 一样来使用 mycat，对于开发人员来说根本感觉不到 mycat 的存在。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KFB4gQ8.png\" alt=\"5.png\" /></p>\n<p>优势：</p>\n<ul>\n<li>性能可靠稳定</li>\n<li>强大的技术团队</li>\n<li>体系完善</li>\n<li>社区活跃</li>\n</ul>\n<p>Mycat 是采用 java 语言开发的开源的数据库中间件，支持 Windows 和 Linux 运行环境，下面介绍 MyCat 的 Linux 中的环境搭建。 我们需要在准备好的服务器中安装如下软件。</p>\n<table>\n<thead>\n<tr>\n<th>服务器</th>\n<th>安装软件</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>192.168.40.213</td>\n<td>JDK、Mycat</td>\n<td>MyCat 中间件服务器</td>\n</tr>\n<tr>\n<td>192.168.40.210</td>\n<td>MySQL</td>\n<td>分片服务器</td>\n</tr>\n<tr>\n<td>192.168.40.211</td>\n<td>MySQL</td>\n<td>分片服务器</td>\n</tr>\n<tr>\n<td>192.168.40.212</td>\n<td>MySQL</td>\n<td>分片服务器</td>\n</tr>\n</tbody>\n</table>\n<p>JDK 安装</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#解压 jdk</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf jdk-8u371-linux-x64.tar.gz -C /usr/local</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/jdk1.8.0_371/ /usr/local/jdk</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 添加环境变量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/profile.d/jdk.sh </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JAVA_HOME</span><span class=\"token operator\">=</span>/usr/local/jdk</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span><span class=\"token environment constant\">$PATH</span><span class=\"token builtin class-name\">:</span><span class=\"token variable\">$JAVA_HOME</span>/bin</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">JRE_HOME</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/jre </pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">CLASSPATH</span><span class=\"token operator\">=</span><span class=\"token variable\">$JAVA_HOME</span>/lib/:<span class=\"token variable\">$JRE_HOME</span>/lib/</pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># source /etc/profile</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># java -version</span></pre></td></tr></table></figure><p>Mycat 安装</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz -C /usr/local/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ll /usr/local/mycat/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>total <span class=\"token number\">12</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>drwxr-xr-x <span class=\"token number\">2</span> root root  <span class=\"token number\">190</span> Dec  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:15 bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>drwxrwxrwx <span class=\"token number\">2</span> root root    <span class=\"token number\">6</span> Mar  <span class=\"token number\">1</span>  <span class=\"token number\">2016</span> catlet</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>drwxrwxrwx <span class=\"token number\">4</span> root root <span class=\"token number\">4096</span> Dec  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:15 conf</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>drwxr-xr-x <span class=\"token number\">2</span> root root <span class=\"token number\">4096</span> Dec  <span class=\"token number\">2</span> <span class=\"token number\">22</span>:15 lib</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>drwxrwxrwx <span class=\"token number\">2</span> root root    <span class=\"token number\">6</span> Oct <span class=\"token number\">28</span>  <span class=\"token number\">2016</span> logs</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token parameter variable\">-rwxrwxrwx</span> <span class=\"token number\">1</span> root root  <span class=\"token number\">217</span> Oct <span class=\"token number\">28</span>  <span class=\"token number\">2016</span> version.txt</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#上传 jar 包</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rz /usr/local/mycat/lib/mysql-connector-java-8.0.25.jar</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat lib<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 777 mysql-connector-java-8.0.25.jar</span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/n86yXtx.png\" alt=\"4.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/U26clQE.png\" alt=\"6.png\" /></p>\n<h6 id=\"321-mycat入门\"><a class=\"anchor\" href=\"#321-mycat入门\">#</a> 3.2.1 Mycat 入门</h6>\n<p>由于 tb_gorder 表中数据量很大，磁盘 IO 及容量都到达了瓶颈，现在需要对 tb_order 表进行数据分片，分为三个数据节点，每一个节点主机位于不同的服务器上，具体的结构，参考下图：</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/YjmWPQf.png\" alt=\"5.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/PQqJdjJ.png\" alt=\"8.png\" /></p>\n<h6 id=\"322-mycat配置\"><a class=\"anchor\" href=\"#322-mycat配置\">#</a> 3.2.2 Mycat 配置</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/iXUxPhi.png\" alt=\"9.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/schema.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:schema SYSTEM <span class=\"token string\">\"schema.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:schema xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"DB01\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"TB_ORDER\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">rule</span><span class=\"token operator\">=</span><span class=\"token string\">\"auto-sharding-long\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"db01\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"db01\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"db01\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:schema<span class=\"token operator\">></span></pre></td></tr></table></figure><p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/KkUttwJ.png\" alt=\"10.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span> <span class=\"token assign-left variable\">encoding</span><span class=\"token operator\">=</span><span class=\"token string\">\"UTF-8\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- - - Licensed under the Apache License, Version <span class=\"token number\">2.0</span> <span class=\"token punctuation\">(</span>the <span class=\"token string\">\"License\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t- you may not use this <span class=\"token function\">file</span> except <span class=\"token keyword\">in</span> compliance with the License. - You </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\tmay obtain a copy of the License at - - http://www.apache.org/licenses/LICENSE-2.0 </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t- - Unless required by applicable law or agreed to <span class=\"token keyword\">in</span> writing, software - </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\tdistributed under the License is distributed on an <span class=\"token string\">\"AS IS\"</span> BASIS, - WITHOUT </pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\tWARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. - See the </pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\tLicense <span class=\"token keyword\">for</span> the specific language governing permissions and - limitations </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\tunder the License. --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:server SYSTEM <span class=\"token string\">\"server.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:server xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>system<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useSqlStat\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- <span class=\"token number\">1</span>为开启实时统计、0为关闭 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useGlobleTableCheck\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span>  <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- <span class=\"token number\">1</span>为开启全加班一致性检测、0为关闭 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"sequnceHandlerType\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>      <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--  <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useCompression\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--1为开启mysql压缩协议--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--  <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"fakeMySQLVersion\"</span><span class=\"token operator\">></span><span class=\"token number\">5.6</span>.2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--设置模拟的MySQL版本号--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processorBufferChunk\"</span><span class=\"token operator\">></span><span class=\"token number\">4096</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span> --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processors\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processorExecutor\"</span><span class=\"token operator\">></span><span class=\"token number\">3</span><span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>&lt;</span>/property<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--默认为type <span class=\"token number\">0</span>: DirectByteBufferPool <span class=\"token operator\">|</span> <span class=\"token builtin class-name\">type</span> <span class=\"token number\">1</span> ByteBufferArena--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processorBufferPoolType\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--默认是65535 64K 用于sql解析时最大文本长度 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"maxStringLiteralLength\"</span><span class=\"token operator\">></span><span class=\"token number\">6553</span><span class=\"token operator\"><span class=\"token file-descriptor important\">5</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"sequnceHandlerType\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"backSocketNoDelay\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"frontSocketNoDelay\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processorExecutor\"</span><span class=\"token operator\">></span><span class=\"token number\">1</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>&lt;</span>/property<span class=\"token operator\">></span>--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"serverPort\"</span><span class=\"token operator\">></span><span class=\"token number\">806</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>&lt;</span>/property<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"managerPort\"</span><span class=\"token operator\">></span><span class=\"token number\">906</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>&lt;</span>/property<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"idleTimeout\"</span><span class=\"token operator\">></span><span class=\"token number\">30000</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"bindIp\"</span><span class=\"token operator\">></span><span class=\"token number\">0.0</span>.0.<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"frontWriteQueueSize\"</span><span class=\"token operator\">></span><span class=\"token number\">409</span><span class=\"token operator\"><span class=\"token file-descriptor important\">6</span>&lt;</span>/property<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"processors\"</span><span class=\"token operator\">></span><span class=\"token number\">3</span><span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>&lt;</span>/property<span class=\"token operator\">></span> --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--分布式事务开关，0为不过滤分布式事务，1为过滤分布式事务（如果分布式事务内只涉及全局表，则不过滤），2为不过滤分布式事务,但是记录分布式事务日志--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"handleDistributedTransactions\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t\toff heap <span class=\"token keyword\">for</span> merge/order/group/limit      <span class=\"token number\">1</span>开启   <span class=\"token number\">0</span>关闭</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useOffHeapForMerge\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t\t单位为m</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"memoryPageSize\"</span><span class=\"token operator\">></span>1m<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t单位为k</pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"spillsFileBufferSize\"</span><span class=\"token operator\">></span>1k<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useStreamOutput\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--</pre></td></tr><tr><td data-num=\"58\"></td><td><pre>\t\t\t单位为m</pre></td></tr><tr><td data-num=\"59\"></td><td><pre>\t\t--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"systemReserveMemorySize\"</span><span class=\"token operator\">></span>384m<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>--是否采用zookeeper协调切换  --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"useZKSwitch\"</span><span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"65\"></td><td><pre></pre></td></tr><tr><td data-num=\"66\"></td><td><pre></pre></td></tr><tr><td data-num=\"67\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/system<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"68\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"69\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 全局SQL防火墙设置 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"70\"></td><td><pre>\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- </pre></td></tr><tr><td data-num=\"71\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>firewall<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"72\"></td><td><pre>\t   <span class=\"token operator\">&lt;</span>whitehost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"73\"></td><td><pre>\t      <span class=\"token operator\">&lt;</span>host <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"127.0.0.1\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"mycat\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"74\"></td><td><pre>\t      <span class=\"token operator\">&lt;</span>host <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"127.0.0.2\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"mycat\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"75\"></td><td><pre>\t   <span class=\"token operator\">&lt;</span>/whitehost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"76\"></td><td><pre>       <span class=\"token operator\">&lt;</span>blacklist <span class=\"token assign-left variable\">check</span><span class=\"token operator\">=</span><span class=\"token string\">\"false\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"77\"></td><td><pre>       <span class=\"token operator\">&lt;</span>/blacklist<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"78\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/firewall<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"79\"></td><td><pre>\t--<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"80\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"81\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"82\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"83\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>DB0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"84\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"85\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 表级 DML 权限设置 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"86\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- \t\t</pre></td></tr><tr><td data-num=\"87\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>privileges <span class=\"token assign-left variable\">check</span><span class=\"token operator\">=</span><span class=\"token string\">\"false\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"88\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"TESTDB\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0110\"</span> <span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"89\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb01\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0000\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"90\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb02\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"1111\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"91\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"92\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>/privileges<span class=\"token operator\">></span>\t\t</pre></td></tr><tr><td data-num=\"93\"></td><td><pre>\t\t --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"94\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"95\"></td><td><pre></pre></td></tr><tr><td data-num=\"96\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"user\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"97\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"98\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>DB0<span class=\"token operator\"><span class=\"token file-descriptor important\">1</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"99\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"readOnly\"</span><span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"100\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"101\"></td><td><pre></pre></td></tr><tr><td data-num=\"102\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:server<span class=\"token operator\">></span></pre></td></tr></table></figure><h6 id=\"323-mycat启动\"><a class=\"anchor\" href=\"#323-mycat启动\">#</a> 3.2.3 Mycat 启动</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 启动 mycat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># ./bin/mycat restart</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#2.wrapper.log 日志中常见错误</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ERROR <span class=\"token operator\">|</span> wrapper <span class=\"token operator\">|</span> <span class=\"token number\">2021</span>/1/10 <span class=\"token number\">13</span>:31:05 <span class=\"token operator\">|</span> Startup failed: Timed out waiting <span class=\"token keyword\">for</span> signal from JVM.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ERROR <span class=\"token operator\">|</span> wrapper <span class=\"token operator\">|</span> <span class=\"token number\">2021</span>/1/10 <span class=\"token number\">13</span>:31:05 <span class=\"token operator\">|</span> JVM did not <span class=\"token builtin class-name\">exit</span> on request, terminated</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#3. 启动 Mycat 超时，前往 wrapper.conf 配置超时策略</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /usr/local/mycat/conf/wrapper.conf</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">wrapper.startup.timeout</span><span class=\"token operator\">=</span><span class=\"token number\">300</span>     //添加此行，超时时间300秒</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">wrapper.ping.timeout</span><span class=\"token operator\">=</span><span class=\"token number\">120</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#4. 查看 mycat 是否启动</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f logs/wrapper.log</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>INFO   <span class=\"token operator\">|</span> jvm <span class=\"token number\">1</span>    <span class=\"token operator\">|</span> <span class=\"token number\">2023</span>/12/02 <span class=\"token number\">22</span>:53:44 <span class=\"token operator\">|</span> MyCAT Server startup successfully. see logs <span class=\"token keyword\">in</span> logs/mycat.log</pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep 8066</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::8066                 :::*                    LISTEN      <span class=\"token number\">18028</span>/java</pre></td></tr></table></figure><h6 id=\"324-分片测试\"><a class=\"anchor\" href=\"#324-分片测试\">#</a> 3.2.4 分片测试</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  mysql -h 192.168.40.213 -P 8066 -uroot -p'Superman*2023'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql: <span class=\"token punctuation\">[</span>Warning<span class=\"token punctuation\">]</span> Using a password on the <span class=\"token builtin class-name\">command</span> line interface can be insecure.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Welcome to the MySQL monitor.  Commands end with <span class=\"token punctuation\">;</span> or <span class=\"token punctuation\">\\</span>g.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Your MySQL connection <span class=\"token function\">id</span> is <span class=\"token number\">3</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Server version: <span class=\"token number\">5.6</span>.29-mycat-1.6-RELEASE-20161028204710 MyCat Server <span class=\"token punctuation\">(</span>OpenCloundDB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Copyright <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token number\">2000</span>, <span class=\"token number\">2023</span>, Oracle and/or its affiliates.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Oracle is a registered trademark of Oracle Corporation and/or its</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>affiliates. Other names may be trademarks of their respective</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>owners.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Type <span class=\"token string\">'help;'</span> or <span class=\"token string\">'\\h'</span> <span class=\"token keyword\">for</span> help. Type <span class=\"token string\">'\\c'</span> to <span class=\"token function\">clear</span> the current input statement.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token operator\">|</span> DB01     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>mysql<span class=\"token operator\">></span> use DB01<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Reading table information <span class=\"token keyword\">for</span> completion of table and <span class=\"token function\">column</span> names</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>You can turn off this feature to get a quicker startup with <span class=\"token parameter variable\">-A</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>Database changed</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token operator\">|</span> Tables <span class=\"token keyword\">in</span> DB01 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token operator\">|</span> tb_order       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>+----------------+</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>mysql<span class=\"token operator\">></span> CREATE TABLE TB_ORDER<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    -<span class=\"token operator\">></span> <span class=\"token function\">id</span> BIGINT<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> NOT NULL,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    -<span class=\"token operator\">></span> title VARCHAR<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> NOT NULL,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    -<span class=\"token operator\">></span> PRIMARY KEY <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    -<span class=\"token operator\">></span> <span class=\"token punctuation\">)</span>ENGINE<span class=\"token operator\">=</span>INNODB DEFAULT <span class=\"token assign-left variable\">CHARSET</span><span class=\"token operator\">=</span>utf8<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Query OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.04</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre> OK<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>mysql<span class=\"token operator\">></span>INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">1</span>,<span class=\"token string\">'guods1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>mysql<span class=\"token operator\">></span>INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">2</span>,<span class=\"token string\">'guods2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>mysql<span class=\"token operator\">></span>INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">3</span>,<span class=\"token string\">'guods3'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>mysql<span class=\"token operator\">></span>INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">4</span>,<span class=\"token string\">'guods4'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> * from TB_ORDER<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>+------+--------+</pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">|</span> <span class=\"token function\">id</span>   <span class=\"token operator\">|</span> title  <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>+------+--------+</pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token operator\">|</span>    <span class=\"token number\">1</span> <span class=\"token operator\">|</span> guods1 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token operator\">|</span>    <span class=\"token number\">2</span> <span class=\"token operator\">|</span> guods2 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token operator\">|</span>    <span class=\"token number\">3</span> <span class=\"token operator\">|</span> guods3 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token operator\">|</span>    <span class=\"token number\">4</span> <span class=\"token operator\">|</span> guods4 <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>+------+--------+</pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token number\">4</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.03</span> sec<span class=\"token punctuation\">)</span></pre></td></tr></table></figure><p><strong>数据写入到 db1 中，因为 mycat 分片规则为 0-50000000 存入节点 1,5000001-10000000 存入节点 2,10000001-15000000 存入节点 3，15000001 以上无法插入数据，需要增加数据节点。</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim conf/rule.xml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>        <span class=\"token operator\">&lt;</span>tableRule <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"auto-sharding-long\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>                <span class=\"token operator\">&lt;</span>rule<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>                        <span class=\"token operator\">&lt;</span>columns<span class=\"token operator\">></span>id<span class=\"token operator\">&lt;</span>/columns<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>                        <span class=\"token operator\">&lt;</span>algorithm<span class=\"token operator\">></span>rang-long<span class=\"token operator\">&lt;</span>/algorithm<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>                <span class=\"token operator\">&lt;</span>/rule<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>        <span class=\"token operator\">&lt;</span>/tableRule<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>       <span class=\"token operator\">&lt;</span>function <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"rang-long\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>                <span class=\"token assign-left variable\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"io.mycat.route.function.AutoPartitionByLong\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>                <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"mapFile\"</span><span class=\"token operator\">></span>autopartition-long.txt<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token operator\">&lt;</span>/function<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat mycat<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat conf/autopartition-long.txt</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># range start-end ,data node index</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># K=1000,M=10000.</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token number\">0</span>-500M<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>500M-1000M<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\">#5000001-10000000 存入节点 2 </span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>mysql<span class=\"token operator\">></span> INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">5000001</span>,<span class=\"token string\">'guods5000001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Query OK, <span class=\"token number\">1</span> row affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre> OK<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre> </pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#10000001-15000000 存入节点 3 </span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>mysql<span class=\"token operator\">></span> INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">10000001</span>,<span class=\"token string\">'guods10000001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>Query OK, <span class=\"token number\">1</span> row affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre> OK<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token comment\">#15000001 以上无法插入数据，需要增加数据节点</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>mysql<span class=\"token operator\">></span> INSERT INTO TB_ORDER<span class=\"token punctuation\">(</span>id,title<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token number\">15000001</span>,<span class=\"token string\">'guods15000001'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>ERROR <span class=\"token number\">1064</span> <span class=\"token punctuation\">(</span>HY000<span class=\"token punctuation\">)</span>: can't <span class=\"token function\">find</span> any valid datanode :TB_ORDER -<span class=\"token operator\">></span> ID -<span class=\"token operator\">></span> <span class=\"token number\">15000001</span></pre></td></tr></table></figure><h5 id=\"33-mycat配置\"><a class=\"anchor\" href=\"#33-mycat配置\">#</a> 3.3 Mycat 配置</h5>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/I9QLBBR.png\" alt=\"11.png\" /></p>\n<h6 id=\"331-schema标签\"><a class=\"anchor\" href=\"#331-schema标签\">#</a> 3.3.1 Schema 标签</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/TmYK7fP.png\" alt=\"13.png\" /></p>\n<p>schema 标签用于定义 MyCat 实例中的逻辑库，一个 MyCat 实例中，可以有多个逻辑库，可以通过 schema 标签来划分不同的逻辑库。MyCat 中的逻辑库的概念，等同于 MySQL 中的 database 概念，需要操作某个逻辑库下的表时也需要切换逻辑库 (use xxx)。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/SGo0DCv.png\" alt=\"14.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/XtDxXWj.png\" alt=\"15.png\" /></p>\n<h6 id=\"332-datanode标签\"><a class=\"anchor\" href=\"#332-datanode标签\">#</a> 3.3.2 Datanode 标签</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/phHZ48F.png\" alt=\"16.png\" /></p>\n<h6 id=\"333-datahost标签\"><a class=\"anchor\" href=\"#333-datahost标签\">#</a> 3.3.3 Datahost 标签</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/fXBnwcS.png\" alt=\"17.png\" /></p>\n<h6 id=\"334-rulexml\"><a class=\"anchor\" href=\"#334-rulexml\">#</a> 3.3.4 rule.xml</h6>\n<p>rule.xml 中定义所有拆分表的规则，在使用过程中可以灵活的使用分片算法，或者对同一个分片算法使用不同的参数，它让分片过程可配置化。主要包含两类标签： <code>tableRule</code> 、 <code>Function</code> 。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Ecm1Nvr.png\" alt=\"18.png\" /></p>\n<h6 id=\"335-serverxml\"><a class=\"anchor\" href=\"#335-serverxml\">#</a> 3.3.5 server.xml</h6>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/xIDxYpu.png\" alt=\"19.png\" /></p>\n<h5 id=\"34-mycat分片\"><a class=\"anchor\" href=\"#34-mycat分片\">#</a> 3.4 Mycat 分片</h5>\n<h6 id=\"341-分库分表-mycat分片-垂直分库\"><a class=\"anchor\" href=\"#341-分库分表-mycat分片-垂直分库\">#</a> 3.4.1 分库分表 - MyCat 分片 - 垂直分库</h6>\n<p>场景：在业务系统中，涉及以下表结构，但是由于用户与订单每天都会产生大量的数据，单台服务器的数据存储及处理能力是有限的，可以对数据库表进行拆分，原有的数据库表如下。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/plSdAyY.png\" alt=\"20.png\" /></p>\n<p><strong>ps: 分库不需要指定 rule，涉及分表需要使用 rule；</strong></p>\n<p><strong>环境准备</strong></p>\n<p>①如图所示准备三台 Linux 服务器（ip 为：192.168.40.210、192.168.40.211、192.168.40.212）可以根据自己的实际情况进行准备。<br />\n②三台服务器上都安装 MySQL，在 192.168.40.213 服务器上安装 MyCat。<br />\n③三台服务器关闭防火墙或者开放对应的端口。<br />\n④分别在三台 MySQL 中创建数据库 shopping。<br />\n<img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/uMZB18q.png\" alt=\"21.png\" /></p>\n<p><strong>schema.xml 文件配置如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/schema.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:schema SYSTEM <span class=\"token string\">\"schema.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:schema xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHOPPING\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_base\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_brand\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_cat\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_desc\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"goods_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_master\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"order_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_pay_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"out_trade_no\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user_address\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_provinces\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_city\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_region\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:schema<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>server.xml 文件配置如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>SHOPPING<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 表级 DML 权限设置 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- \t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>privileges <span class=\"token assign-left variable\">check</span><span class=\"token operator\">=</span><span class=\"token string\">\"false\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"TESTDB\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0110\"</span> <span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb01\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0000\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb02\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"1111\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>/privileges<span class=\"token operator\">></span>\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"user\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>SHOPPING<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"readOnly\"</span><span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:server<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>分库分表 - MyCat 分片 - 垂直分库 - 测试</strong></p>\n<p><strong>垂直分库 - 测试</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 重启 mycat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/mycat/bin/mycat restart</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Stopping Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Stopped Mycat-server.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Starting Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f  /usr/local/mycat/logs/wrapper.log </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>INFO   <span class=\"token operator\">|</span> jvm <span class=\"token number\">1</span>    <span class=\"token operator\">|</span> <span class=\"token number\">2023</span>/12/03 <span class=\"token number\">15</span>:29:02 <span class=\"token operator\">|</span> MyCAT Server startup successfully. see logs <span class=\"token keyword\">in</span> logs/mycat.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#2. 在 3 台节点创建 shopping 数据库</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>mysql<span class=\"token operator\">></span> create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>mysql<span class=\"token operator\">></span> create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>mysql<span class=\"token operator\">></span> create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#3. 登入 mycat</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@db3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 192.168.40.213 -P 8066 -uroot -p'Superman*2023'</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token operator\">|</span> SHOPPING <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#4. 查看逻辑库</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">|</span> SHOPPING <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token number\">1</span> row <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.01</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\">#5. 切换到 SHOPPING 数据库</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>mysql<span class=\"token operator\">></span> use SHOPPING<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>Reading table information <span class=\"token keyword\">for</span> completion of table and <span class=\"token function\">column</span> names</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>You can turn off this feature to get a quicker startup with <span class=\"token parameter variable\">-A</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>Database changed</pre></td></tr><tr><td data-num=\"41\"></td><td><pre></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">#6. 查看逻辑表</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>+--------------------+</pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token operator\">|</span> Tables <span class=\"token keyword\">in</span> SHOPPING <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>+--------------------+</pre></td></tr><tr><td data-num=\"47\"></td><td><pre><span class=\"token operator\">|</span> tb_areas_city      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">|</span> tb_areas_provinces <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token operator\">|</span> tb_areas_region    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token operator\">|</span> tb_goods_base      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token operator\">|</span> tb_goods_brand     <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token operator\">|</span> tb_goods_cat       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token operator\">|</span> tb_goods_desc      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token operator\">|</span> tb_goods_item      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre><span class=\"token operator\">|</span> tb_order_item      <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token operator\">|</span> tb_order_master    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token operator\">|</span> tb_order_pay_log   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre><span class=\"token operator\">|</span> tb_user            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre><span class=\"token operator\">|</span> tb_user_address    <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>+--------------------+</pre></td></tr><tr><td data-num=\"61\"></td><td><pre><span class=\"token number\">13</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre></pre></td></tr><tr><td data-num=\"63\"></td><td><pre><span class=\"token comment\">#7. 上传 shopping-table.sql 表结构文件与 shopping-insert.sql 数据文件</span></pre></td></tr><tr><td data-num=\"64\"></td><td><pre></pre></td></tr><tr><td data-num=\"65\"></td><td><pre><span class=\"token comment\">#8. 执行 shopping-table.sql 文件</span></pre></td></tr><tr><td data-num=\"66\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">source</span> /root/shopping-table.sql</pre></td></tr><tr><td data-num=\"67\"></td><td><pre></pre></td></tr><tr><td data-num=\"68\"></td><td><pre><span class=\"token comment\">#9. 执行 shopping-insert.sql 文件</span></pre></td></tr><tr><td data-num=\"69\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">source</span> /root/shopping-insert.sql</pre></td></tr><tr><td data-num=\"70\"></td><td><pre></pre></td></tr><tr><td data-num=\"71\"></td><td><pre><span class=\"token comment\">#10. 查看三个数据库可以发现（根据 schema.xml 配置文件的配置进行了实现）</span></pre></td></tr><tr><td data-num=\"72\"></td><td><pre>①192.168.40.210的数据库中存放了 tb_goods_base、tb_goods_brand、tb_goods_cat、tb_goods_desc、tb_goods_item这五张表</pre></td></tr><tr><td data-num=\"73\"></td><td><pre>②192.168.40.211的数据库中存放了 tb_order_item、tb_order_master、tb_order_pay_log这三张表；</pre></td></tr><tr><td data-num=\"74\"></td><td><pre>③192.168.40.212的数据库中存放了 tb_user、tb_user_address、tb_areas_provinces、tb_areas_city、tb_areas_region这五张表</pre></td></tr></table></figure><p><strong>exam1: 查询用户的收件人及收件人地址信息 (包含省、市、区)。</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> ua.user_id,ua.contact,p.province,c.city,r.area,ua.address from tb_user_address ua,tb_areas_city c,tb_areas_provinces p,tb_areas_region r where ua.province_id <span class=\"token operator\">=</span> p.provinceid and ua.city_id <span class=\"token operator\">=</span> c.cityid and ua.town_id <span class=\"token operator\">=</span> r.areaid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>+-----------+-----------+-----------+-----------+-----------+--------------------+</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">|</span> user_id   <span class=\"token operator\">|</span> contact   <span class=\"token operator\">|</span> province  <span class=\"token operator\">|</span> city      <span class=\"token operator\">|</span> area      <span class=\"token operator\">|</span> address            <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>+-----------+-----------+-----------+-----------+-----------+--------------------+</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token operator\">|</span> deng      <span class=\"token operator\">|</span> 叶问      <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 西城区    <span class=\"token operator\">|</span> 咏春武馆总部       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token operator\">|</span> java00001 <span class=\"token operator\">|</span> 李佳红    <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 崇文区    <span class=\"token operator\">|</span> 修正大厦           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token operator\">|</span> deng      <span class=\"token operator\">|</span> 李小龙    <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 崇文区    <span class=\"token operator\">|</span> 永春武馆           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token operator\">|</span> zhaoliu   <span class=\"token operator\">|</span> 赵三      <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 宣武区    <span class=\"token operator\">|</span> 西直门             <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token operator\">|</span> java00001 <span class=\"token operator\">|</span> 李嘉诚    <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 朝阳区    <span class=\"token operator\">|</span> 金燕龙办公楼       <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token operator\">|</span> java00001 <span class=\"token operator\">|</span> 李佳星    <span class=\"token operator\">|</span> 北京市    <span class=\"token operator\">|</span> 市辖区    <span class=\"token operator\">|</span> 朝阳区    <span class=\"token operator\">|</span> 中腾大厦           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>+-----------+-----------+-----------+-----------+-----------+--------------------+</pre></td></tr></table></figure><p><em><strong>ps: 此查询语句只涉及了一个分片所以查询成功</strong></em></p>\n<p><strong>exam2: 查询每一笔订单及订单的收件地址信息 (包含省、市、区)。</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> SELECT order_id,payment,receiver,province,city,area FROM tb_order_master o,tb_areas_provinces p,tb_areas_city c,tb_areas_region r WHERE o.receiver_province <span class=\"token operator\">=</span> p.provinceid AND o.receiver_city <span class=\"token operator\">=</span> c.cityid AND o.receiver_region <span class=\"token operator\">=</span> r.areaid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ERROR <span class=\"token number\">1064</span> <span class=\"token punctuation\">(</span>HY000<span class=\"token punctuation\">)</span>: invalid route <span class=\"token keyword\">in</span> sql, multi tables found but datanode has no intersection  sql:SELECT order_id,payment,receiver,province,city,area FROM tb_order_master o,tb_areas_provinces p,tb_areas_city c,tb_areas_region r WHERE o.receiver_province <span class=\"token operator\">=</span> p.provinceid AND o.receiver_city <span class=\"token operator\">=</span> c.cityid AND o.receiver_region <span class=\"token operator\">=</span> r.areaid</pre></td></tr></table></figure><p><em><strong>ps: 此查询语句涉及多个分片所以查询报错，为了解决这个问题需要进行全局表配置</strong></em></p>\n<p><strong>全局表配置</strong></p>\n<p>对于省、市、区 / 县表 tb_areas_provinces，tb_areas_city，tb_areas_region，是属于数据字典表，在多个业务模块中都可能会遇到，可以将其设置为全局表，利于业务操作。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/EqJJ3Yv.png\" alt=\"22.png\" /></p>\n<p><strong>1. 修改 MyCat—schema.xml 文件配置</strong></p>\n<p><strong>schema.xml 文件配置如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/schema.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:schema SYSTEM <span class=\"token string\">\"schema.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:schema xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHOPPING\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_base\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_brand\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_cat\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_desc\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"goods_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_master\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"order_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_pay_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"out_trade_no\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user_address\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_provinces\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_city\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_region\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:schema<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>2. 全局表测试</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 删除 3 个节点上原有表</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#2. 重启 mycat</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/mycat/bin/mycat restart</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Stopping Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>Stopped Mycat-server.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>Starting Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f  /usr/local/mycat/logs/wrapper.log </span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>INFO   <span class=\"token operator\">|</span> jvm <span class=\"token number\">1</span>    <span class=\"token operator\">|</span> <span class=\"token number\">2023</span>/12/03 <span class=\"token number\">15</span>:29:02 <span class=\"token operator\">|</span> MyCAT Server startup successfully. see logs <span class=\"token keyword\">in</span> logs/mycat.log</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#3. 执行 shopping-table.sql 文件</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@db3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 192.168.40.213 -P 8066 -uroot -p'Superman*2023'</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">source</span> /root/shopping-table.sql</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\">#4. 执行 shopping-insert.sql 文件</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token builtin class-name\">source</span> /root/shopping-insert.sql</pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#5 exam1: 查询用户的收件人及收件人地址信息 (包含省、市、区)。</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>mysql<span class=\"token operator\">></span> <span class=\"token keyword\">select</span> ua.user_id,ua.contact,p.province,c.city,r.area,ua.address from tb_user_address ua,tb_areas_city c,tb_areas_provinces p,tb_areas_region r where ua.province_id <span class=\"token operator\">=</span> p.provinceid and ua.city_id <span class=\"token operator\">=</span> c.cityid and ua.town_id <span class=\"token operator\">=</span> r.areaid<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#6 exam2: 查询每一笔订单及订单的收件地址信息 (包含省、市、区)</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>mysql<span class=\"token operator\">></span> SELECT order_id,payment,receiver,province,city,area FROM tb_order_master o,tb_areas_provinces p,tb_areas_city c,tb_areas_region r WHERE o.receiver_province <span class=\"token operator\">=</span> p.provinceid AND o.receiver_city <span class=\"token operator\">=</span> c.cityid AND o.receiver_region <span class=\"token operator\">=</span> r.areaid<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><h6 id=\"342-分库分表-mycat分片-水平分表\"><a class=\"anchor\" href=\"#342-分库分表-mycat分片-水平分表\">#</a> 3.4.2 分库分表 - MyCat 分片 - 水平分表</h6>\n<ul>\n<li><strong>水平分表</strong></li>\n</ul>\n<p><strong>场景</strong>：在业务系统中，有一张表（日志表），业务系统每天都会产生大量的日志数据，单台服务器的数据存储及处理能力是有限的，可以对数据库表进行拆分。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/0kMP4Ru.png\" alt=\"23.png\" /></p>\n<p><strong>准备环境：</strong></p>\n<p>①如图所示准备三台 Linux 服务器（ip 为：192.168.40.210、192.168.40.211、192.168.40.212）可以根据自己的实际情况进行准备。<br />\n②三台服务器上都安装 MySQL，在 192.168.40.213 服务器上安装 MyCat。<br />\n③三台服务器关闭防火墙或者开放对应的端口。<br />\n④分别在三台 MySQL 中创建数据库 itcast。<br />\n<img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/zTm8XwU.png\" alt=\"24.png\" /></p>\n<p><strong>1. 三台 MySQL 中创建数据库 itcast</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>mysql<span class=\"token operator\">></span> create database itcast default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mysql<span class=\"token operator\">></span> create database itcast default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>mysql<span class=\"token operator\">></span> create database itcast default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p><strong>2.MyCat—server.xml 文件配置</strong></p>\n<p><strong>server.xml 文件配置如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/schema.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:schema SYSTEM <span class=\"token string\">\"schema.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:schema xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHOPPING\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_base\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_brand\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_cat\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_desc\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"goods_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_master\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"order_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_pay_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"out_trade_no\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user_address\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_provinces\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_city\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_region\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"ITCAST\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        \t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn4,dn5,dn6\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">rule</span><span class=\"token operator\">=</span><span class=\"token string\">\"mod-long\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        <span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn4\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn5\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn6\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:schema<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>3.MyCat—server.xml 文件配置</strong></p>\n<p><strong>server.xml 文件配置如下：</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/server.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>SHOPPING,ITCAST<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 表级 DML 权限设置 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- \t\t</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>privileges <span class=\"token assign-left variable\">check</span><span class=\"token operator\">=</span><span class=\"token string\">\"false\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"TESTDB\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0110\"</span> <span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb01\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"0000\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb02\"</span> <span class=\"token assign-left variable\">dml</span><span class=\"token operator\">=</span><span class=\"token string\">\"1111\"</span><span class=\"token operator\">></span><span class=\"token operator\">&lt;</span>/table<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>/privileges<span class=\"token operator\">></span>\t\t</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>user <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"user\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"password\"</span><span class=\"token operator\">></span>Superman*202<span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"schemas\"</span><span class=\"token operator\">></span>SHOPPING,ITCAST<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"readOnly\"</span><span class=\"token operator\">></span>true<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/user<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:server<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>4.MyCat 启动</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#1. 重启 mycat</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/mycat/bin/mycat restart</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Stopping Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Stopped Mycat-server.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>Starting Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f  /usr/local/mycat/logs/wrapper.log </span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>INFO   <span class=\"token operator\">|</span> jvm <span class=\"token number\">1</span>    <span class=\"token operator\">|</span> <span class=\"token number\">2023</span>/12/03 <span class=\"token number\">15</span>:29:02 <span class=\"token operator\">|</span> MyCAT Server startup successfully. see logs <span class=\"token keyword\">in</span> logs/mycat.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>create database shopping default charset utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#2. 登入 mycat</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@db3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 192.168.40.213 -P 8066 -uroot -p'Superman*2023'</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> ITCAST   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">|</span> SHOPPING <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>mysql<span class=\"token operator\">></span> use ITCAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"25\"></td><td><pre><span class=\"token operator\">|</span> Tables <span class=\"token keyword\">in</span> ITCAST <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token operator\">|</span> tb_log           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#3. 创建表结构及数据导入</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>mysql<span class=\"token operator\">></span> CREATE TABLE tb_log <span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    -<span class=\"token operator\">></span>   <span class=\"token function\">id</span> bigint<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> NOT NULL COMMENT <span class=\"token string\">'ID'</span>,</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    -<span class=\"token operator\">></span>   model_name varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'模块名'</span>,</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>    -<span class=\"token operator\">></span>   model_value varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'模块值'</span>,</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>    -<span class=\"token operator\">></span>   return_value varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'返回值'</span>,</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>    -<span class=\"token operator\">></span>   return_class varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'返回值类型'</span>,</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>    -<span class=\"token operator\">></span>   operate_user varchar<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'操作用户'</span>,</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    -<span class=\"token operator\">></span>   operate_time varchar<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'操作时间'</span>,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    -<span class=\"token operator\">></span>   param_and_value varchar<span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'请求参数名及参数值'</span>,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    -<span class=\"token operator\">></span>   operate_class varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'操作类'</span>,</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>    -<span class=\"token operator\">></span>   operate_method varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'操作方法'</span>,</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>    -<span class=\"token operator\">></span>   cost_time bigint<span class=\"token punctuation\">(</span><span class=\"token number\">20</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'执行方法耗时, 单位 ms'</span>,</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>    -<span class=\"token operator\">></span>   <span class=\"token builtin class-name\">source</span> int<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> DEFAULT NULL COMMENT <span class=\"token string\">'来源 : 1 PC , 2 Android , 3 IOS'</span>,</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>    -<span class=\"token operator\">></span>   PRIMARY KEY <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>    -<span class=\"token operator\">></span> <span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">ENGINE</span><span class=\"token operator\">=</span>InnoDB DEFAULT <span class=\"token assign-left variable\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>Query OK, <span class=\"token number\">0</span> rows affected <span class=\"token punctuation\">(</span><span class=\"token number\">0.09</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre> OK<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>查看三个数据库可以发现表和表结构都有了</pre></td></tr><tr><td data-num=\"49\"></td><td><pre></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\">#4. 添加数据</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'1'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:12:28'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"20\\\",\\\"name\\\":\\\"Tom\\\",\\\"gender\\\":\\\"1\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'10'</span>,1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'2'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:12:27'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"20\\\",\\\"name\\\":\\\"Tom\\\",\\\"gender\\\":\\\"1\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'23'</span>,1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'3'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'update'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:16:45'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"20\\\",\\\"name\\\":\\\"Tom\\\",\\\"gender\\\":\\\"1\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'update'</span>,<span class=\"token string\">'34'</span>,1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'4'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'update'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:16:45'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"20\\\",\\\"name\\\":\\\"Tom\\\",\\\"gender\\\":\\\"1\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'update'</span>,<span class=\"token string\">'13'</span>,2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'5'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:30:31'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"200\\\",\\\"name\\\":\\\"TomCat\\\",\\\"gender\\\":\\\"0\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'insert'</span>,<span class=\"token string\">'29'</span>,3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>INSERT INTO tb_log <span class=\"token punctuation\">(</span>id, model_name, model_value, return_value, return_class, operate_user, operate_time, param_and_value, operate_class, operate_method, cost_time，source<span class=\"token punctuation\">)</span> VALUES<span class=\"token punctuation\">(</span><span class=\"token string\">'6'</span>,<span class=\"token string\">'user'</span>,<span class=\"token string\">'find'</span>,<span class=\"token string\">'success'</span>,<span class=\"token string\">'java.lang.String'</span>,<span class=\"token string\">'10001'</span>,<span class=\"token string\">'2022-01-06 18:30:31'</span>,<span class=\"token string\">'&#123;\\\"age\\\":\\\"200\\\",\\\"name\\\":\\\"TomCat\\\",\\\"gender\\\":\\\"0\\\"&#125;'</span>,<span class=\"token string\">'cn.itcast.controller.UserController'</span>,<span class=\"token string\">'find'</span>,<span class=\"token string\">'29'</span>,2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>查看三个数据库内的tb_log表发现有数据了，数据的分布规则是 id模以3的结果为0的数据分布在第一个节点，id模以3的结果为1的数据分布在第二个节点，id模以3的结果为2的数据分布在第三个节点</pre></td></tr></table></figure><h5 id=\"33-分库分表-分片规则\"><a class=\"anchor\" href=\"#33-分库分表-分片规则\">#</a> 3.3 分库分表 - 分片规则</h5>\n<h6 id=\"331-分库分表-分片规则-范围分片\"><a class=\"anchor\" href=\"#331-分库分表-分片规则-范围分片\">#</a> 3.3.1 分库分表 - 分片规则 - 范围分片</h6>\n<p><strong>范围分片</strong>：根据指定的字段及其配置的范围与数据节点的对应情况，来决定该数据属于哪一个分片。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/sdd8bvs.png\" alt=\"25.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/R3ecZ4k.png\" alt=\"26.png\" /></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/autopartition-long.txt</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># range start-end ,data node index</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># K=1000,M=10000.</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">0</span>-500M<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>500M-1000M<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>1000M-1500M<span class=\"token operator\">=</span><span class=\"token number\">2</span></pre></td></tr></table></figure><h6 id=\"332-分库分表-分片规则-取模分片\"><a class=\"anchor\" href=\"#332-分库分表-分片规则-取模分片\">#</a> 3.3.2 分库分表 - 分片规则 - 取模分片</h6>\n<p><strong>取模分片</strong>：根据指定的字段值与节点数量进行求模运算，根据运算结果，来决定该数据属于哪一个分片。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/Xvn6sHi.png\" alt=\"1.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/aaey4H2.png\" alt=\"2.png\" /></p>\n<h6 id=\"333-分库分表-分片规则-一致性hash算法\"><a class=\"anchor\" href=\"#333-分库分表-分片规则-一致性hash算法\">#</a> 3.3.3 分库分表 - 分片规则 - 一致性 hash 算法</h6>\n<p><strong>一致性 hash 算法</strong>：所谓一致性哈希，相同的哈希因子计算值总是被划分到相同的分区表中，不会因为分区节点的增加而改变原来数据的分区位置。</p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/6ANYtsD.png\" alt=\"3.png\" /></p>\n<p><img loading=\"lazy\" data-src=\"https://wp-cdn.4ce.cn/v2/8i8c5Le.png\" alt=\"4.png\" /></p>\n<p><strong>一致性 hash 测试</strong></p>\n<p>schema.xml 配置</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/schema.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token operator\">&lt;</span>?xml <span class=\"token assign-left variable\">version</span><span class=\"token operator\">=</span><span class=\"token string\">\"1.0\"</span>?<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE mycat:schema SYSTEM <span class=\"token string\">\"schema.dtd\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">&lt;</span>mycat:schema xmlns:mycat<span class=\"token operator\">=</span><span class=\"token string\">\"http://io.mycat/\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"SHOPPING\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_base\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_brand\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_cat\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_desc\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_goods_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"goods_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_item\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_master\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"order_id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order_pay_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"out_trade_no\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_user_address\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>                <span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_provinces\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_city\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_areas_region\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1,dn2,dn3\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">type</span><span class=\"token operator\">=</span><span class=\"token string\">\"global\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        <span class=\"token operator\">&lt;</span>schema <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"ITCAST\"</span> <span class=\"token assign-left variable\">checkSQLschema</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">sqlMaxLimit</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        \t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_log\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn4,dn5,dn6\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">rule</span><span class=\"token operator\">=</span><span class=\"token string\">\"mod-long\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        \t<span class=\"token operator\">&lt;</span>table <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"tb_order\"</span> <span class=\"token assign-left variable\">dataNode</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn4,dn5,dn6\"</span> <span class=\"token assign-left variable\">primaryKey</span><span class=\"token operator\">=</span><span class=\"token string\">\"id\"</span> <span class=\"token assign-left variable\">rule</span><span class=\"token operator\">=</span><span class=\"token string\">\"sharding-by-murmur\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>        <span class=\"token operator\">&lt;</span>/schema<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn1\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn2\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn3\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"shopping\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn4\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn5\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataNode <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dn6\"</span> <span class=\"token assign-left variable\">dataHost</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">database</span><span class=\"token operator\">=</span><span class=\"token string\">\"itcast\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost1\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.210:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost2\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"48\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.211:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>\t</pre></td></tr><tr><td data-num=\"51\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>dataHost <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"dhost3\"</span> <span class=\"token assign-left variable\">maxCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"1000\"</span> <span class=\"token assign-left variable\">minCon</span><span class=\"token operator\">=</span><span class=\"token string\">\"10\"</span> <span class=\"token assign-left variable\">balance</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>\t\t\t  <span class=\"token assign-left variable\">writeType</span><span class=\"token operator\">=</span><span class=\"token string\">\"0\"</span> <span class=\"token assign-left variable\">dbType</span><span class=\"token operator\">=</span><span class=\"token string\">\"mysql\"</span> <span class=\"token assign-left variable\">dbDriver</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc\"</span> <span class=\"token assign-left variable\">switchType</span><span class=\"token operator\">=</span><span class=\"token string\">\"1\"</span>  <span class=\"token assign-left variable\">slaveThreshold</span><span class=\"token operator\">=</span><span class=\"token string\">\"100\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>heartbeat<span class=\"token operator\">></span>select user<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">&lt;</span>/heartbeat<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>\t\t</pre></td></tr><tr><td data-num=\"55\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>writeHost <span class=\"token assign-left variable\">host</span><span class=\"token operator\">=</span><span class=\"token string\">\"master\"</span> <span class=\"token assign-left variable\">url</span><span class=\"token operator\">=</span><span class=\"token string\">\"jdbc:mysql://192.168.40.212:3306?useSSL=false&amp;amp;serverTimezone=Asia/Shanghai&amp;amp;characterEncoding=utf8\"</span> <span class=\"token assign-left variable\">user</span><span class=\"token operator\">=</span><span class=\"token string\">\"root\"</span> <span class=\"token assign-left variable\">password</span><span class=\"token operator\">=</span><span class=\"token string\">\"Superman*2023\"</span> /<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/dataHost<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre><span class=\"token operator\">&lt;</span>/mycat:schema<span class=\"token operator\">></span></pre></td></tr></table></figure><p><strong>rule.xml 配置</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /usr/local/mycat/conf/rule.xml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>function <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"murmur\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>\t\t<span class=\"token assign-left variable\">class</span><span class=\"token operator\">=</span><span class=\"token string\">\"io.mycat.route.function.PartitionByMurmurHash\"</span><span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"seed\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 默认是0 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"count\"</span><span class=\"token operator\">></span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>/property<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 要分片的数据库节点数量，必须指定，否则没法分片 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"virtualBucketTimes\"</span><span class=\"token operator\">></span><span class=\"token number\">16</span><span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>/property<span class=\"token operator\">></span><span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- 一个实际的数据库节点被映射为这么多虚拟节点，默认是160倍，也就是虚拟节点数是物理节点数的160倍 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"weightMapFile\"</span><span class=\"token operator\">></span>weightMapFile<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span> 节点的权重，没有指定权重的节点默认是1。以properties文件的格式填写，以从0开始到count-1的整数值也就是节点索引为key，以节点权重值为值。所有权重值必须是正整数，否则以1代替 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>-- <span class=\"token operator\">&lt;</span>property <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"bucketMapPath\"</span><span class=\"token operator\">></span>/etc/mycat/bucketMapPath<span class=\"token operator\">&lt;</span>/property<span class=\"token operator\">></span> </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t\t\t用于测试时观察各物理节点与虚拟节点的分布情况，如果指定了这个属性，会把虚拟节点的murmur hash值与物理节点的映射按行输出到这个文件，没有默认值，如果不指定，就不会输出任何东西 --<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t<span class=\"token operator\">&lt;</span>/function<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><p><strong>重启 mycat 并插入数据测试</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># /usr/local/mycat/bin/mycat restart</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Stopping Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>Stopped Mycat-server.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>Starting Mycat-server<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@mycat ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f  /usr/local/mycat/logs/wrapper.log</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>INFO   <span class=\"token operator\">|</span> jvm <span class=\"token number\">1</span>    <span class=\"token operator\">|</span> <span class=\"token number\">2023</span>/12/03 <span class=\"token number\">22</span>:17:47 <span class=\"token operator\">|</span> MyCAT Server startup successfully. see logs <span class=\"token keyword\">in</span> logs/mycat.log</pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@db3 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mysql -h 192.168.40.213 -P 8066 -uroot -p'Superman*2023'</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Server version: <span class=\"token number\">5.6</span>.29-mycat-1.6-RELEASE-20161028204710 MyCat Server <span class=\"token punctuation\">(</span>OpenCloundDB<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>mysql<span class=\"token operator\">></span> show databases<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token operator\">|</span> DATABASE <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token operator\">|</span> ITCAST   <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token operator\">|</span> SHOPPING <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>+----------+</pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>mysql<span class=\"token operator\">></span> use ITCAST<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>Reading table information <span class=\"token keyword\">for</span> completion of table and <span class=\"token function\">column</span> names</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>You can turn off this feature to get a quicker startup with <span class=\"token parameter variable\">-A</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre>Database changed</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>mysql<span class=\"token operator\">></span> show tables<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token operator\">|</span> Tables <span class=\"token keyword\">in</span> ITCAST <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token operator\">|</span> tb_log           <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token operator\">|</span> tb_order         <span class=\"token operator\">|</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>+------------------+</pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token number\">2</span> rows <span class=\"token keyword\">in</span> <span class=\"token builtin class-name\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.00</span> sec<span class=\"token punctuation\">)</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#创建表结构</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>create table tb_order<span class=\"token punctuation\">(</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre>    <span class=\"token function\">id</span>  varchar<span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> not null primary key,</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>    money   int null,</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>    content varchar<span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span> null</pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">#插入数据</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b92fdaaf-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">10</span>, <span class=\"token string\">'b92fdaf8-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b93482b6-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">20</span>, <span class=\"token string\">'b93482d5-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b937e246-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">50</span>, <span class=\"token string\">'b937e25d-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"47\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b93be2dd-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">100</span>, <span class=\"token string\">'b93be2f9-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"48\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b93f2d68-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">130</span>, <span class=\"token string\">'b93f2d7d-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b9451b98-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">30</span>, <span class=\"token string\">'b9451bcc-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b9488ec1-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">560</span>, <span class=\"token string\">'b9488edb-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b94be6e6-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">10</span>, <span class=\"token string\">'b94be6ff-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b94ee10d-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">123</span>, <span class=\"token string\">'b94ee12c-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b952492a-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">145</span>, <span class=\"token string\">'b9524945-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b95553ac-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">543</span>, <span class=\"token string\">'b95553c8-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b9581cdd-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">17</span>, <span class=\"token string\">'b9581cfa-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"56\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b95afc0f-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">18</span>, <span class=\"token string\">'b95afc2a-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"57\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b95daa99-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">134</span>, <span class=\"token string\">'b95daab2-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"58\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b9667e3c-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">156</span>, <span class=\"token string\">'b9667e60-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"59\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b96ab489-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">175</span>, <span class=\"token string\">'b96ab4a5-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"60\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b96e2942-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">180</span>, <span class=\"token string\">'b96e295b-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"61\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b97092ec-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">123</span>, <span class=\"token string\">'b9709306-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"62\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b973727a-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">230</span>, <span class=\"token string\">'b9737293-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"63\"></td><td><pre>INSERT INTO tb_order <span class=\"token punctuation\">(</span>id, money, content<span class=\"token punctuation\">)</span> VALUES <span class=\"token punctuation\">(</span><span class=\"token string\">'b978840f-6fc4-11ec-b831-482ae33c4a2d'</span>, <span class=\"token number\">560</span>, <span class=\"token string\">'b978843c-6fc4-11ec-b831-482ae33c4a2d'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></pre></td></tr></table></figure><p>PS：数据按一致性 hash 分布在不同节点</p>\n",
            "tags": [
                "MySQL"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/2771271649.html",
            "url": "http://ixuyong.cn/posts/2771271649.html",
            "title": "云原生K8s安全专家CKS认证考题详解",
            "date_published": "2025-04-09T13:38:39.000Z",
            "content_html": "<div class=\"hbe hbe-container\" id=\"hexo-blog-encrypt\" data-wpm=\"抱歉, 这个密码看着不太对, 请再试试。\" data-whm=\"抱歉, 这个文章不能被校验, 不过您还是能看看解密后的内容。\">\n  <script id=\"hbeData\" type=\"hbeData\" data-hmacdigest=\"f6c6f540e92e3b390a77c769307c510092cb1ec8e12477ea3b65b3321261139e\">d025f0d3bd12bef569594886c37488b3f72b0f85e79b466e52addc3fcd9d370499a86d765d96345502bfa68ca2b47343ba8a9b7797cc81d808e3efa72cafb7786ffd6a6fba1e799837c87d976607d26dc00198cecb9f66b043012982d55bf84bbd5c067a5f2f3a2cd5154efa6f2b5dbfec8e5d6a0adf5e972b51aa888c31d7baf58724c7890803a78330259f6e9b6efb52fdee5062732dbefeb4aa9e0d5f11233b483ef0c7cfb025e107cac2cfb8bfff06f74900913c747bf515c4a7f1ddbe8f4da9f7862f34caf954f17be53a83e7a3ecfe69edd176651c1b0e6f114ffa6d455c680d5fd1e7e80f18ca5aa880200686f5893b87d01e92c5f8b5e5b71f14eb850fc408ea171096fdbdb1ae1c4dd235429154cf45d708947d9f899f8f36b5874471f1ad130c57f7d2e4782cf66cd175d0d1880f17bdebe4be47fa13eef7a7d03c35f156b8fd3502bafb6fb43a7fabf2cf06df8142b186f726e07aadbfd35205c88f29e3a5a287dd884d4e07af0eb4fc56e2fc9db6b2d45ae23257b222a5f7964e24602ad0f63a062d881644e5a6cddf9f556c3111e445442815b50b73b870d1205d66e24e5a0553bbe56c0d1db30513259b094602cef96bfe6f7f75d4c9733816cc853a830eb43326c1c375e4696d7c8e78499f1c1deb60a1f351db456820edb39861cb5444650c343c396c3ff577b2c333140df9784559d101cfa0068498af30bb9f600c73a06520d55f61ef30410bc4a3e23ddb23aac7e6a8d31c26f3caf9e0bf848d0ae42557f3da86718426caf528f7544ad469cdfcb47e6285eef4a714c642adbcfc012c5d076c77045d8da8f476d78b623ad0b0ca1f13d10f0fdeb4cffd052910300cd9c79555c59ac4ec5ff42c9454d83507ea0dfcdb32ab833fb0eb19c00bee197f908fc6161e48420065bee236a69fbc57a1dd2957da942de6f8adc8d4e5be81f0cc0376ea330662dea297cbe5293997e9f5f0e086cb47855fdd8a033af2905a6c1bd35bdf41e275289717ed12afb295e1e0c1641e77e430efb0a508d4071f762fb90cc6fa88b056aaed200f641972f23711f67913ece5bde4037eebe05f0c3cbdde62e9b93681a5162eeaaaddb03f2966437ac2f5a46bb15c68dff64957a3aa78c74a51c8ab8e5d3a0a99d3d5be3a190903aa33e16302af2af1a43a37b983c35924c2c21cb1194598b2f2b5d5c3e16146cffb0361b1caf8719c52c89731bab4f282f1f1b48990e7fbea1f862a9dd09869adfdb4ebbd925f86024ffbeb41c88a63b42ff9bc94e58640f851c23f766377d38ab8b810c1397c095ae2495207ae4e6251e29d14466bc32baba3aae672f4c1fba2752d53772569e0ecfbc896cee2afe19d7e66e26db0076d81104edfc33db97899361b715aa8741fa89508e86f9d1a057273fa056ddaa2b6a8ae43bcfdeead3aca001097a5376f16d4cf506cd71ec1206b601a7414169e1274f64b9a562a1431c42d13865b4c156f53ba077c9467684967312db9df7c03bc77d26e40df5ae9e556f42bbbf5105f838b6ecff281e5d1c0789f44023f9a6a680d236d8031118811148b65dcad4072d15f70fac0aa073eda86ecba9806abd853dea4931da6a16b0eab99d01b63adb071d8eb0281964e959e1c31095b43c07130f0654fdb5c6ef36f82f91529ac615c3841e493eca944aeead7348c2168cafcd32e26c6398a7c738b409188368b42dcb8c458e9e3808af55668cdf3b1f00769a90b802d23892e165c61908b862e7cd629a3e593a6f33098b09485ca16234cadf02878000493e6938458bc9668395afacc251a65c0e05de084dfc2cd6d13cc1f598470aa847abb6134365160c824d51bee85c2683c55ce00e1b79dcc02ef563d7358ac7b07b3ba4db6b648f9a3ef663adeabf3c4e129031d0dbe4c91ed43725178591948839015d8c725a794dda65af72aad651ae22eb02d9246ac4d553ad2d04780d2510648ade042bc211211ea2db8c0e9135aa021bed2d72076d704d6fc1730ea9fe00252f6f883c36c752f9ed80483cc0135ff89462040e7d40a3e6df8ce43965db838ad8d3604d3306245a208a9c6dc1facb1423ec0735c9f1a9b455d3b639d2b8d0e58dfd1b2e1eb54646998604848a829cd2fdc406277f75eafefb13d40113abbaae1e364a1b19cb7aaa24656ed5f07bb4dde26e347df724739c55517b81ba94148508a77eb4969f85d97c65045314bd75854b77f3c3e46b5052986c73733ef22a305dfe6d7c28a914bfc35a30ed09e6594ce2742c42d8a91636ae569b4743bae5b0d66aae09cd8fb5aa2943b8ece7d3cfb84b9e2d77f77599952c3dc7af09fdf290d9a0027148496e214b184013ca556fc5b00a8cb44f174b1d011a696ace65574f38ac4a9adf56ba11ea46312906caecee561d776b738a0e87a2fa4de02b1d774d19b1f3e25f5932eab26e8a8d9da934b7ec2ba1fe60cafb922aa01de28631218526abfdbc94606d04e2872f4b337aa5596e941f9afc3fa063cfdc47126218568fee7be22790e01e7a06274d4e837b5c7b0e7b6bdba6d57ec5198ebee571ccecb736bd552dab2c73f9ebfd4199bbcdfc9d675ece878cb07b853ecb6bc4452fcda39b9039718eeac97bb3636f593d22659edd8d1889ca511151bdb350dec33c6c80e8c4b0a97bf6dfdb200af47d8397fdb6f0502644995e6d5b20799f340b75d66acb3f4cbd9b0caa2df4804c1483f61de3a6b09aca7cc8ae8bc423cc79646ed438d3f178a0ae72ed1741147797d58896f5e53f98e5f5b1dafe0f65489e27716ea2f5177a85a78868d2967e4114f6922889e1db12a51f7e02dd404b2ae51b4e4ade148f00f04c51bbe03d1d8bf9d450dc0c5af196c94629463a54f6d5e8d95c382cfd8f1e149ee9c7dd2463dc67e093a518059e81ec1d61453ccfa54d6c826fe937848678bfec425486be80aaa4eaa657f1f551a5508318328c89a57c309ce2ec0fcd4c4f407589293a76e8a62507b483e8f88d0d6a574e3a91bb79e44801659bbac1117411d76ca1c67ffbfb2397c8d119764f68db242e12cc0642d392c27c169edc4be2b1d8d646b78bb375a71e80e800d965707939bdd70bb84d30fa5b24fb6854885f0b46177e070dab069c74be24109b30b0a2487ff719b05af27619191b32c8baf68ee2e1033d43cce77909fd9e0a3f9d5b7930ca6b71403124696bcc45ce68674a952d2c5e39327e7e7f8ea62bbf13d02611dfb37dcfc999ea88bda71869d6c7be1a97436f9eb1e9a1e9df4598603a6b666759015575529633cd13c1d59e59dbb1c3356b1e42975e5e133ba2bb4c1f68adc8441bd7def9a46f5191b928e1b116306a4a7f88f1e59a4fb175e483db352804c80c28392bc158cbb1b84b58f9ee7d3a9b54109323608f72872d058f48c5d893d7fd4f13a11dd0b37e2cc2be66e680e127fc749d9e021d8642f00aaa326663b7aff82fdddb4767892e1ed2c7b83815278a36acfa8bb8b619de90c92dc626d8ff05edc01c4f6bf4ca8f7a70abadd01cdefaeafbba691c083b273589ea9dd24c256b1e2ba19693bd97804decc5d730e51fd275854079539bf1e2b54842774ae3377070c331d024333656cbe454715907c73a7fb7c98aad31922203863d06fae53f8d64432b29995c1bfb376df55305bab3bfbcd0c326fab952248bef05d562d0dcbeeca2d3af9e2c6bbfba87e2f0e641986387069be4ca394fdfbf37a029d66ea9986dee82be50a4781fa6c6d03de78506e4a04958bb009190d5e453f7d4d85a2ad8aa457a6e96f38d5458e3d4599b855b44debd1a11f8ad84666d012ec39679b32b39494504ae926fe25d9049d3577fa00af284611c80179ba71d9fa863e49f606a3f9f641051122f6a5c7aef0bbb57993c1b61861e2fc1604591eb881ca35e454013e5d5f1d28bfd74197d5e1f88d56b6deb8869cdc4812d84fc91eca39299b602f7423d003373055f8d2a02446c46003b97395b0af25ebd592765cbe74041f260970b75e15a199a39d6edb21f95fc5fab8987a335f936ee72b2b99a46cc54790c623df65bbb51ac9609c3d457cde270238bc9852388736b6b35b612a4f0e336356e3ea5770a1a2efae5dc49c9a3a15121cb2735cce885dc0b648ad423de64c397ec5ab73ca5fdaaa0e03d6d89514cf951d00ff0477579e9dd7615199c921544408c50ed053397982d01803da596ce7e8dd6fdd65936375662042c393799ce5263335248d903051b3b0bee59d2abccfbe2057712f2ed3070000f1acf6a87552c9059ecd11a4c909b7c36d2bff4274eff23c0efeaca68f698ef761aa2b389f8b45a0bf572912793e7bcb523f6c05d01c369c94d15f3fbfcf37f66779414365cf62bc4135c319511d34eff142180aee87761061151db9ac1410bd671bb6705642793a35df3553a341f323accbced62239bf0eb43c62603231d4095b2775b1894836b35a5eb93532d2563fea3a93a717c0d402a7573400dba10abbd3b314bf7f6c666805a15c48f45ac945a84b346fdaa05ec08e6ab1cfd69b4ca88a4a0e1cd95a69f87231e4eac4f7fdb231f340fa88de0b42e44d3fde81aa25f85470138ac4769f487dbca0f2ae5c9cd10d0b687df646d80965dfb06ab474f1994858e9ea92ed871ed7f8227f5ad58e750aba1db8f5f73ae791b99b6aafa3a5565d6316929c4e3f300f65005d6fee6fdf74af861105c07ee60cb20ec23bf0e302c06f7f6a912bedf49cacf71af0286cd89a912f56898d1dbea7886e464928a8515f01aa59af1e71c2d53a9fe9db13e6288164c5b9149bdbdbd4c4bf5e00a31c81bae034e0c2869529cc7d505ec11eed9bdf56b4adec8f041c301a5b1c2e5a9533ee3cee9a334d45010193e0c2639ff7091e1edcd0c3cefd15fbf79b9e7cb55fc456b72f9416f030eff95aee8f56285e699dd45d7cecc91ab6ab1e4b01c83e51ffd69a3356087df6645f217984f0117813028ac1147edad0a824e3465033046ee8b92d9d17fbc1f4addd4966becc0ee9275352db0886696a7d62366466a7457d5073e05bc862be79e7f5dcd09b6d3e5ddabf81d3fd4c5d6af658975cab452bc8c4d64a557242fec9caab84f721a0b358809ed43fd9ce30df91aec60b67b80a8628837ed7bdaff58117d37343b50e449b42b2d1d2ebf475ecc4cf6c3ea83ecfce0d9ea03ee4bb68152f9b8c38bcb541e6c101fc94a94d4a2bed8c997aaff7274dea765c971e4de32e7fbe74ea58ae7ec6ab5473d76e4c505ea0036e3740fb8d46ed0d2340198d28b3acf37e7a8e38c2329e33e194645556d430cd31f01a1b00c7d2e6622538cf6281f460284073f7110af7ce23607c072f3fa0c33fcb4a13e56823a1d6e186ba49376ade883567efcccd78d430d0f7feb1b0969dae2dbb50c510f2c5cd0c12b3dc388a3b5a964ab8b6276342d57fa21a862767c1bcdebdb41c72cedf3554c890a57bc00d4bb8499a0af4bd778de1cfe650f63368a02073374a713b9d7a6e5291505b0e2e78c9bb3c36a583abe62f72db1a51b8e437120fa793787c4d410840ca6e245bfdbb0c651b84c91808fe2c71b3b90a1164424573bdaa160879df8e0278514bb93f4fe27be6fc782f4de9ef2744bf8d1dac3c2fb0cbc49713d84ba1a0448e8de9b2d22128100769b25f16641276e2c48f1e0538dacef2affcf2d99902446217812e7b126071afd3161bf54192fb8d793fb4338fc67566ac04bc11870c61d6c2c99e3b6839ed90f98b8d982c8bf01142380f7705b6342fa98bd672c753d7eae9e2e770b71d81cd276f49dcc9f83c18f615c401acf644ce79aa5aabcc75d2523530b0743dfc2db59a52792fc10dc6ec1fd33857e6dfd46125c3d161e720b80cbd5ee71749cb6244553f5079ef42de683a2a88dcfe2d03555c35bf176ca431255f0fe93bbe381a352b22726a20169252d1a8b227f692b5ddab992000c96a95cefc75234e12deefb11b661c6710626874b2a787b64f622f3fa3f0f72ce9c032b0ed385ca0df35ce5a43d2c52222d0b10ef4d80e1f9216a10edb476a054d3c2a63046d83b1c1339af107e5797ec413d12fcfee2ca4423aeba27600924ad197f259ddce27a90dbdf0fa2b1ebe1317d5d93c333147b9897e80259b33ce3fb51ec684b7702bcd5a10a425a54401241feb005c0b2f7c72272e430b0a4646cb1dc4b148972a2b5504bc07a3170e139642b263a360baf65e722102bd02f419392bf1db62d793086c8710bbb7bccd5aa16970ffd5cd99e35d06fec6c2c22251f2bcd43efc0d394e628e385045df44f248b37ebf0d20b27ea851fa8b05ea2a10073233433b006c238f016607ab4ff3e06d8e0d75f2bead6be3737e86fc182c69a2ba29a2924397858c32bf054bc1482e81afe7b243b037db5fb0c9ab875a3d4fa703176b2f5a668437fafb22034af20be7d0d026711f76bbd58ebf35356cc03ae77efab5140e94e90207e89cfa2cbb7a3a80dec5d9ef9eedf9af3c986990e9e6bb0197ec5324a3145893c0caad88a1c06033cdeb702a669da5f014bef8f302ec172be0c191afd81aaf66e624498225e570a8d227507fe3df4c51612d22db8d6b9cd735863c21a187480fd2c2dececb39706c1f1d4fc69e753d7e16fa28e8f8a6ad03cbb682cef66f732f0e7a004817721ed89b3c28c15571201c3d8e2601e9af5064ce5d35ad41aec2b486a2fd601cc2140a122740f8cef74754a5199e7b72ddcfdfaaa4300ae9434d74cd34b2d7adbdfb93fc5deee72f7e4ee798a431a7d120806dc2f963354f9c35d651b9e99c9ae383f2597bfdd35eda53efe6866a54fffc70aab7de6ed3e872ef41f7a047db36499ca0d6cc309c03385966c613d474d52dac4d67b3268cbed71d307250e80a05b6fd85e0711927200ad3c3d1f6b1e2f270d3f8a98a28cacba0660b29f7861584eb03a0ada11e0bc412c15f4042eca0ff9223dff3f9e77213bf4e6ebe3b149b448fdb7dd8fbff725c784e35363bb467dcbb50a506b25d0899aee30a5f2c3ffb08c856672eec8ad06996beda75d6fc82ba45141f3ae6e7fb6ac6f263f3ab0ea2e3fa770caf57162505446beff1f59a7386507fb05394c57333b3d301b4e38490de47644bb99df0a4a330dd4fd74f5c9c6b934bcb6acdd788afe46fe587cc36b6836b551c97f7c231c4e2b06297fd6543363ba24b172e838fb51a812cdb5a1f5cabbc5c107764f6fd8de0c2930e05a53ff9c804ea80e1510eb67ebe63039e99300c5e589bd767acbb7e9bf5bca75b4887e137389b91c51efc1fafc57abcfe710d6e2fa1870a94af53682d4f89728ceb5d6cb4036f54ac8e387ec1f7d8f65bc8d931fe75381edcbc297c72b4e6fdc19a9592d34a178f440e903542d4d2fc6e948ed8d9e6af0f3bd417fb5bf9a02843243a9509d2a1a4070f8d27ef004f57f2b3cde147cc9289daee578fdae1d8af0caa50c1f34a7c74da1645766e23de60085c37ce46a2c691c496a456bf4c041b492ffd22cc007dc9b072bb09ea3ab5888f909e1c5c25f94d81a9c31a0f847d18f5d34512bf3df73835fe364728914cf2990c654e9728f63f770488b649905145e1675ed2b02346a40596ec00137ddcd5cda9ec3ad0b0868efb734d1d254ca337e198f3f4b48a52d2d551fb88db783eb411c2bc579f1800e96b27292866c2c6f0f1eab5247b54ad091df1debab464d7dfa1a5455a4c5df6e1da0155b13a59e8607e66a5f31505400d93bcdb3f00c90e8d17bf2051971a15e5d0da556e495239116a89e78dc76338a60cbccab58d5899d1fa0458f564ae47396b8725f60be75107bec3590cc07ab05853c2ab20f66a965bb0015372b9a5720dc2675830c92eab6c60e48f62b409578634cb497107f8cfe695ed73d7c04e3a287856b8c62982a2ab5a214c5013a21a71c6a1965408e6eae6323b5f8a05fd54eac075eb611c87d8f2b9ac962749906d55057e395ea47d79db07d09e7376a341a3cf4dabe2f35fcd4673fe5036a6c415a5055c380074e278d36e321b4a078717483b1c6f1711c8d2eda8ed745ab2c86acb15f1cac2d8854dfddd3ad1170a239e23e527fce71f1a0987946f3fb7b028739aba009739d2b513553e4c4e6c2a8d77366007586348e89cb8bf4df92e258ed1020d60023952ba5806afe5c0ebbbfcff98c563370562e37a7ecc263bed11976a60f23fa533394f647258d975d7a8664f29312121a1238fd5f44e3eb149b83ea64c6fed4c5e71469905b5f50d3179e913b99fe9d337cbbbbb167639d9eb5112e305e681e180c61f208e4c7f5455a199e0afb6eda4745cc0347bf810b72adadb50a1c91f15da0208962a9553aeda308c669e80e23faf5d728697a6090ee6c236c7e23d29c7108c8950198a8b9a8b57c18c1f8f2a21a7df26fa099ab4f151a76b0189bed0770d2ad5ba27ef9683b941dfef977e722ef147f511f4c23dab90e283be701a2e376a7435d78f84e8f1970ec6dc68ca45076b67c99e19506fb3adcdfd5c18a755122aaa7ab9613878e476ea6e37801674288c0fc9e44b45e3450cf62f3828a8d2fc2d57c917e0f60b0967b08afc312b7dcf74aaa85364fb51cd91b584e9c4f6e7b350ae8a617f178c36cda0047fea8eb02a40b5821e899da869779470a7ee074df2b6d89bbff130448f0d5157c0648a223bbee60d05bde51f020955c1538aa91a29c3bb945040c7989a2fa0cedab718e632a0fbfadc0b2e3e6930a3e43f572d2f408a7629ac250a16a5bfa7df15d824a4df08e36d44b2a8c823c17e4eeba88ff591926e5ccdddb97547275f2a92ff5bb94d2be399cf86e49b91b6109eda0918ae109b3c1b2eb94a35f134d0500673cf132413af4a0516f754b2762556b9fff75de2bcc69c97a31fc1d1ca97b5ea3540393e24b394b7d0395ba3c8e738d104e52e14ee92cce12f1995eba57624112dcd986aba4bfdcb17b4d7c56a0fb3edd9b1fb2f2c32db50288b6761aa240ee41917abe517a12c04826de41c21891377a26d43226fe1cda66e3d359e0fdb47a9ed082fb1ac0034f7be633ff86d9d5a46333b13ece466825fcedeb47d8ead91360ca5a88c0efde38203dda29efffb9cecf17b11eff9991e51c224c472db19d69c96caf36b3d823211d632f09be4508ddefc18aae9b8507875d700097dc1a6659744df5d993621d4eac3750a278fa316a71591d56d45fa10643ddab5e37dcf4babe53fa09136e5e16e0bc218f937e825e3d3a894b76f2d83100ac32203e87394f07141713ffc6041650c3d796ee4053edeea08c256e2f2912a2533095047d1d2a8d63310a4874085ad285d1fbf2cc6275215949f120ca627a9cc3061f22de39d4426d8ec9fab1b008a7ff338a262c68ccf5c101b2b1f02f578ab500088cf561402cbbec0c0072c23c12bbaaf09fc74c537df5a3ae8155ed9147c756274e2ae43d6f3cbeab216542994c520f2c9d17d8fec59a522178aed717eeb9713fdd510027c9babfecb7588f7d91a56a859f2a70c033d4538459110f216bf49d6f5d2a23b1785936802ec6738bd979c3b091517903e27a08bdaa11df42f22619b4a81b0715305367947cd8f91661b583602b3fd56b58c9fc8aa05cb8dc1e345656676a4b96248a4ab5d5d62b6416d7bdb17fa9df393e38707c5586bfb57b7b23e4a90a4522cca9cdf960d8065dfdcc144005089801a0a206d89fb37b6395f47c207806a5c917c3211003188458c3f259674d8f1c21410cc9592d2c86c5f03f0c0b6aa01aabd6c11109974b97e8265075818dc19c2286d2500b133adc546f3e96dd2ed9ccc3599d0e091153902cc6de330300d9cb6e3ca0b8d7f87d106a68ec08a49a909e9b6aa45cdaf4f2af4335915a55a1cb91652f92464f32fef8985d3a9fc3ad18312d3e94f1710a2bf830f3737987bdedd3cd17ea8bf2cc4b81788ca63c37ed90904decb1b77ef1a01231eb986074dee5ae94b6d533139498ecfc8995d3480e0014fc370cd47a87183ce9c31f155bdcd31e8accd30aff8ccfac06def6ec7e9fddcc06afb85e7c3f1d1c02828aabd2ac6a72742a5a3845e6a346f7cfa049e2d3fe58561aea4658ee1860e5a5a20fa525040cc125801442f6ed23066b63736a381245a9a30d21e1d5c3e1b5419df65945efd3e7f9dd5e3603cc584b2db4b814fc06011e2b763204687529df150f6e8020d5ead968112152b66098b6753204a25b55921fc871179c56eae1e8e7b47ba500561f62f4f41c54b57a7e209cd5ebb68b390e368f55fc85628b00c1f9c7eb06e2f6a2235f0b9c5811e015858abf7974cca61b2a9b38047a954d414145d41652613172356514b61ad4ca4d96791211bf605274b7897a4774e8aa2ded14dd908dfe8fb26d546267f04c44d0d86d91644da989d85675b7416a4e81bac3164cbd34303beed4f6a4564febeda88d0cce279ea8201ef17276ade6b87c05bc9b914b5479eaa68d0be141508fcdb51e18c4b234fa9b3aabf45aad590d9d0676396f9745566106cb043215c32f63de121e070f78ee238073ee5d5593ddaff22af0af5d1c96b7745cb1ed5fedbd5fa9ecf59d0c95cd805cfbf7e20556aa6f61dae1152bd037977f42fd54d2eeab0fcf12c1de24854126c875d760f2350ac6c81c3df2933fb774e91390f0803ba9af6cb04a10a4efcd069ab17b3bbd35393ad891d7d3a29b4e9dcbdcef57ae3b9173bf5afdc4e710886615d5b5bf046d7cf7277f2a37460a344f72c9a8501378cc7715e754982f387b1eba7147a8923febe20b9e0e92e2265145851dafe1c4f649f540814268c476f1a4afb7e5287d37d3e5d09e8f452e79862bd293f9ca0af0c7a1eae1579e318eb16b0d4d6e789bee798411a03690707c1640b9035ef883a8cac11cd0a5554cf5709b96365fdac5364ce25b3360c667bae6c349ddcb5d93059df3208ed605057182af63c429edb0a9f1985afc6eebc5420de4ee0b010b0e391312274f90dd8afb3edbecbf63c771108bfd03b882f940dbf1f78cb08539129b85459c15f2f72a645027ac4e11855ba04a792099f6b814ffeb6e904bd2a8de56734f46f71135645f840f2a4e1e617e697873e0f086ce849a8436f1b766d4f6000ea2c38e4e99f2eabfcbe2590b8baebc70faeeff5a4c526d70c441895c318aa2387c1a202f81ed06908700f454e4748b3bec68a4ba315e4370586e2a4ca11f99467797f8f641903847e77d87cbffbf7734146cb63691379ddc7e1036a29c7579548d49d888433dc5d7707c27655a13fc82b0f29ff74c36c898526b9ee8916fddbb588047cf79bb3ea7068ffd36d638d5540d784c06f3cb737b9f5f6a61c3280d3644e76992b49de2044df44582e5ffccc4375962856541ac9b2b609097b51dfa1a40d2939ea9cbcf60008c76b80b5c24c9e28eebee9aa23e53922b8a821ce0d55393b9d1d25165feb27c54dea51d4351b2fdb8c635547e14c71b62d26196210b408c407e56568547f67bef0a059acf83e4af8e776324d4eee20e6991d0bd5b28792adb6b78e9fba3d889874ad7bc1e6eac7293fd4dc10db07a6fc3beef724d42978192421917e23807f0642824b1d2fc1d77fbdfceb7907eb6fa66207a44b455fc7c307437c4420e97b47dd18abd7b6290f8eb22884e7de1d16f2395f7f78e901ccdd532f717003a90e54797d36b1a628eeabc33bf133e22adaac5f2f4dde22c9941f45da16a283bd293b9bdf55b9c39cda2cb25659559c1c6006d2b28d0c442675fd97b3a25dcb11b4b1d40592ed1417b1a0ac64d154f2f2e945ceccdc1411bea04feda6af4944cf6e3ca579a90d2efb1483469ee00b4c17b0ec302186f38e5ac45dc2eac9dd16f38cd858f6b0f86f2d1fa3cb48d9953f143a57f8e14cf12fbbf6f8c60fb77ef792a607f424e93889234f9d6d99abdd180feddfb2d5f515b8227c37668d032ba92abe10e761f12134039a63070f85be13f1bb5b34aaf617c0f83a37e17401190d3b325954d66a605107294db8d76cf8a716fb79985e91733c5e21665a703a61fca6b2c06a664aa646244751b76bed15cb4b0092b9548ab8d3c46acfab63c7586118dcfabf07610af920b62622b758aa69ab9e622cf84bf8e1687fa01146307d321ad53a49ee910dae7a9653cb9b3c30e544b365c431a903ee88d6432965847ebe632a7e12921af8c3092ac329a59b357f868454aa7aae27e22648e12681a82c1084e4ab1370bb78ce696c280ba146f4a3718cb311e6f7d67e068074705bfc3e16f1b99765d95fbce8671fda9c0dd3689e1b5407239cf50b5798f56f4ecf45ef90671bc7ea9cb75291f5500e714e4090d41bbe9836180e91b61287e58ca0081080c0c4c6b7e3c40421308941cd15e55d329c35d6fb44e7dedf499764733720e958797e8f726c51a00364425d361e2a1637329d1c30b07cc199ea1007ad10b176f7db24d267508fdfe29f0a5ba845aa0cd64f7637d3bb45533ac7ca9b78053a30a4083878d08879d6b788dd0acae31dc38659aa2085fb71ed1ecd60baa0a28c1afff8b6e3d90ffdd90964303682934922fcab4310b2a961ee945c24278df40d4e3637cf30fe1c60710f701c4caa5faa48e6459daf6a3c2f0f7aec2f31f3500fe5ccecb831689e70fc1a270a0740c63b16703e41098488bf6ffb9b85481eb050442242bd27ba7cd3abebd9f0ee740331791df3f35b48bb499454c0e6c5425562787db692112c2d62b740fa62a1639c3a7cbaf6c2e7d98a47ff3fa2990c15a3fcb2498a30ea23edac68e9cc2c003b9f437caf46c28be0633627eaec2d70b1bbe36424ad832d47b8b1957c6b49e4732b4d0a4e9279e6a95dfd6b2a97daee37b75e691979e6d1eee8df16a0c27354c4b1ad919e664b4796a9057298ccdefdb56e2b46424951b412724ead3829d0328412a83d06d540270707b6ff724821474268bd83d7fd38ae54d3d8f62b8d9fe49fd094bb6898c74a0265b39767df017e854e4c9acd64e211d8e22f350868ba2731dc9e329224cd7f8eeab4b5eefc202044072f33157403d9fd53eff091db32d938a8f4bd010e5dabc17ed8fd1d1d34120c3cee531af0d0b0da9b2932adc85128438198c5c7996b41369b380f0a5894d41e4d57bed21d1a26e1cb710b8b2d4dab56eb1a819e6e14de66ca9ac9894b61dd1a2f11e691b8dddeccbb4f58ed126dddcd5dfde223cec64e64a4dc7d48034528c63225901988485ca57d38b56963b35f1ec5534a714c983c5520264999724cd22ac7447e47c50746d8e33d9d13214ac659252a72b09b99b1a2519636900c7d0cf671f9dc10c1b3b6b0f23042f7016317c21710e385c540ecd94785bc4d51e0c7bee58d9da092507c696557b701ac1e602c437be97b6c959bf9b873da3facac4f8d7e275b5bc4846cda8f07eaa7f2bb3854aea328d252ebe7e392ed30d28655bef7cacc53957fcf129ee69698d6626a31422ac29b20fb13bac40594c9619b7bdbc694a64c845174cffb463c5500aef2e4210858fe62adb025f54013dfd4cdfcc0798c64c04016f87d8022e0db9096c1cf09b457503e0092b95dc34dde106aa35218bb1a93cc699c03eb16cd1ae1e12ec20c6e4ab23c99a153379a3a1d0781a3c537fc63bb76d082e1550238eb4e0e525255799197ef0f21c980ea3c33f8321ddaab7bf26e6bc8f2faa7eeab246e184a663d3f4fff5e787b67cd1854ea61e9245c80f869a93b681472d4b1fcaf50ea0a6809c718d9fc8da560367ab8a25f0bccc6cc98d031405066181deaec7531924f57db1f27403c89c8026a9d61731bc3e4dbc5fc5e6fcec2e228642e410dbed2a181ba6c99de2172c2f57695e42cfab7a44b661809c42fc4666607dc3cbd52cbd4062ec513bbd6dfd02fb3f80136a90906f56bfc640fd66c91a11acb038a36fd477f449ab068d933bb1c584cbf78c51a09c08d8810a62a4e471c6e15bf62b6d16de488bbce92583fc7fb50113a8ded630e1439ef552ca3ca2c07f9d983e88677829d923c714dfa7766bef574ef0fe0976c41d74fb7a12153d12a23095ad8136d4198561d4673342c5034c2e1e29107e53b2f3cedce150612562093b7b987513bf3cc541dd2fe59001d1c8ecc882e5a9a9e266bf61242de1f986e44f20f6443278836f901061dd363937a13a9d30f91c3b0279a791e054412f655ad92fb5b1e1b90dc1ea4f2a9d559093752f63c9322e89c77a18c276bbc1407b3b745a6f83d14c2dbc973596d047908d4c2ea5cee2ea3dc075c5b623ed22f18b42bdc7d37774c8cfb81594cd152bf5e04d39b86921551fd2b09ef68c3cce06b87d89edf92ae02c85530ba901c521cf9b93b7deea2e6fc9a2806503a99af1565edcf72a2c15c1d92069e0b8b3c3f1baaa42c63e797e830b55fd5787b2b2a6b68c5bc03388f578f8eb8d87c161deb9eb6e97c4bbe6fda7ec727e0154d9d5843c37f1cd89f4bee0b05a935e09b74ba65b844f5162a566c2ca4d507cb3d74f8030c63c18752e9d5f0b15791babe6e2a7949261a62cf728b065075d89a208a2ec20cc2271106cc06854958bfb51401ca278cd31714f981fc3cbd267a1a24952d04d2f531ee285c31dc87d37708163401ba85d358762683fd846a77aaac6d7153638a0e83a8a23f885268d139c87cf9056f15b6bd3b51395c88d2ed6e0d93b2ed9f1508436ee5728711a08635b548d8aee9464b8d6647368e238b1a7fb4dfb3a2f27f9828f878cbd610787c412c3a5ddb9193b0a01d25fccc3d8e02566da154ae1a9840c7ef6a8c749b10f3ecb524b963c728e509c24226a49d9e389f5b2122de961ba6ab941dc8a7d0717276fa303858e81be0911192f9e5bec3828d77d5c533407f344a355893dcdd6812b44e5a9416ac7c25c6b7b5b0f8c81c471b75e88c0246fef54aa284ca329e6c2e330d2eaec4d19970a84e6546ef5b02da727194be157394dabcf2093407907f627ae397a13fd67fc64c0aedc0f49c56ba4d7d1eba63991c1680e808e4ebacb7a735ad479821bdd48285801d2d9a9d35db446286e117e494556aa915489fece9a7fbb959b67f47338eafaf0116fc704e851aac70b592f09f1a6bab9bf8dd90df2ad559f24642c436c0e2f56ffbd60765527fe7c971f27f8137304014d91886432ed2919ad2e32152992ee5c5c3d5243d04627b1f647d79d5907856585186be1c26324036145afcae69586f6f1ef4b74b03a813fbae12fca2959691718754ae79e0dfbbb6572e06bb35a5a8a80c7e6c2c77c0982f0dac9ccc58eb82a3d9f50ee5591be8094c9af70cb0c13415daba9c182e3c2f6c9c83de58346cb7e0ae85b1019670a1b3708e503e7cabffa409724885721ffe4de5b72dab9a19d29b1e5a47ec12343636b755b6c5bfc2e370a4bbf80edf6aad72863972bcfbda47f5447ed498b8561aa701c2654aa9f5ec1a6e2a2c451dfd2e36cf647e0199dbd3a624f9713895b060badd9e9dd7cfa2e4165588402cf39b2a14f1f6efd76e819f75c45eff82c13bb3da97ebb464901b9173407c0acdba5d61df66049e99f54fe7703a8edff1d2a6a1d5a60cebf4e54862e915b49cdf4ddbba7a2561fe5b41684ddf2a2c63347dff322648c621e61536ae2e584292bd761b91e812e588a3692e74dae21348478afecfbdea27d011fecdcc30b5eff2743c23e510e34d402586903fddefb6da9f2172413d911cf9749db5ce4d70862a131940795b35a8421659a240aa0b99b1893fa1bfd3c377f6831a7aac1febd5820a081b470442b676b27a9f58cf442a9414f1acd41c50268a6f26d84ac03825c1e7b90be41705c0deeb6a2f6b926b4429e63d9c6345c18b99ee427bb5ef857585db0a45f061ecd5a51c9e31e9ee0dd4d053b83efb0dd28584929ab62589761e03f3e0390eba03af8286b397603e02ced67ccf7c39ef1e97b239bbddabf9fe0bc36a9f2f191a1a88b90cddeee50b5b210c29923da1888c3725335ff5b095f219baca3131e7b25def57cce8e418786e1ac2f42cacaa60b491e34633116c7d3c275aebcec67ddadfca21d22396ac858bb027dcb172ccf4aa12f2979780e1e509178d889e98aaa6dd18778df397408ecc58bc2af081ab8a5bf4bc8245ea6517d22286876aec423979e251364cc1401e32168837d48f4f5563415e92a135e2ab36cc15da1af1f620780b369e647d0bc0fb868a44f7b54f89b80c581df55bacbf0b670c8037e552cb80ae299ba4ac503a8ffeb0f06285b2fe0e1f9b45c09c203f25c841ed523cb144da479ddb998f8889bb461092d951d47d427facf8f58a12ee9839c3c9ffb316e589058a8dee69aa84db91f095afda824cf02479ef906bcac5aeec4dac7083db95c566d2b27b1dad77e26deba00b0b359fcc85cb982e3e82ae0fe465cd3756fec8917cd0064af2905fbe661ce8321c8ca5c99040ed89424aa42f69aebc3acf61b60144f071cd4c27a6278a9f4e20e5c45ccd0175e35353d5af728f5276ea453dcdaf45a8f420177a16c4d358101dd751bcefaa0f9c3250e72405f600ceac1a3185feb5aaf1a3fda25c6c10c061fa62cfa80ac60578a44949a98a26b60c5ad409a0874af4124dd6d2a251788869b06bb64a1a17e62f027f3f73ccb9f98850b98a7b6429a2902bdda5e8ac0bdf374c2db372405483a284bbadf1a28606bb4046f369b9ca449c86820f2449d9f91f827f79d6c55f5eae5f3f22aee9a0a0cf2c52030691b917184b9fe1c94c383cec7ffe1b9a63e914b27a986ebf7b3d927186298a84fb390359e0a8d0cf92f621087051c6508758c5858c3a7de7e6f8679f7d14419eafd30223e3c21ef6a34676a5ee8710bf3e87adcb3737657b6bf8766a741f2bb2299ea11ce3c6d509da60f615d6be5c30f6b81676cfafadb3f3a91878d0857974dd7d1680305554d0ef04e17e8164969627b7313c38c3e72d0d2ca6e7f7e0d29878fb6e5e49821567aeb7c4afb1007d1ef83994e59238bb23bd57c1527fed1ff573c800319d83be826db6e54588610b33db0982c05ab3f8bd490d5ea239dee345154540f3f3374b1f6d84b5c9508fdb97f1ba143217d39e0ab873c76efe9d979eb7f9a37f5ebd6b8e57eef8bf7bdcb5867265b6f9c96d247e3312381c9daa61170483a2f36c196b37d4ec52fc6d9417fa4fc0314282bdc102986c4ca87a01154c85bc4a0b44241b96cdf2c06f0fdc5ecd30c0f9ab6dc34ba808295c52ab054b2a3fb791fc8f9a4dae6b6dba5af123ea1fda496bf1a351a551bf3fff3a5f240723cefccf0d011b3f9ae86aef506a6644b1d43b058e9e46cf63fa8642ff2499f46a9faa60a885c90e5fa700bb9d444563bc714cce1a6031a5743a2704f08ac79824a5ddaba50bdbe89211f6321053b9b550e9d80ba684765b51402b922dad45ee2d0a5d9cdc9e84cea587e2a2f34e67e8f610c11ab0db03f94369cda9c3beaec1065aefbcc511efda5138ab7067689fa086d77cb737416d41212ac8322e146f5ec427b36a44c43a3735994902f94efde09962664f3d30822e7eefb20daff9f82b8ea34ebf501c556580b27c59d7befaf2f70ffad63fef717d58a7cd411c358d5b86978eb88cfc5b761e43de480b53b9fc9016ab75e2c39bd71284e66986ef36fa68bbd1f85a32302b9f5042228d05cbd67413567a4e868b03583762b94af97f6862da8c45e42a7609b79bf865a840796b2164131e2c28518a7d45a4190d82bfbc99a85128bedfd48b3b82ed1db8322c4a98359a707e12259328563f378a6c329ddb0b1cfd48445d575ce5c1b95d7c02ed67b6dcf463622afd5cc8d6cd00a9f39e227ee894f8dd12ea00f1f00e8f52c1f8c949770ed67846139035a801266baf267365b2a4bcea962c6c4a09690e1620c7237f2b1ae1e22ab4734ae917d3bf4ca969ba90e939ae881efcc224b7b48cc7147537db89011ea41dc941eb2284c15dea6c1e6acb78615d0e2f8973dcf76f7e9cb2f4bb1b90076692bd1172837fcadcf3fc65e8573735bad95ff7fdef87687ef51334ec76b8a59e8573e26d547a940e55ceb9ea7696756514b7005b00b5da4ec4395d6b8198c5f834011e1fe28844bccbaa8d4c44b16a3899040ffacab93651cb69aef37b9a44e9e3581cfd5fd1cf5f6592936affaa90ab5ab864b9f674557328efb29dfc6d1c83949ea03264ac59fdf27c8b50af470522b1608e98aece9735c09c1c6466c8dc7ec276fc9e44704a3c5a2d4bbdc5e62293b85f4e27509fbcbf37711dcb15f49ac0d416e4fe5d162335e948b7de3b1634471039160237ff3c6837c689d120d0f471f0f94c35265049798d1c878c7334c3ef5b000d7c9e7fea988ecaebdd675c6927ee601e1acde65cc3b9567f2968f50d55ed45d00aeb731414c349ade37e4b07eaf36e5352d2dc9d2112fa9f212009c3d36b04eda0ffba2b01cf5860b41eacdcf87a60d07f8730192c92fca4deee4e059255ca9fc5a365d7238968a49dff5e584dd4448f57881408c2877bd9100683fe8e69ccdf1f19dcc26cd5dae18b4b9953026bd4d10a03302eb91db1a9f183c8f9bae5140e68a99b608be5412ce24cdf8e1add71d027c16ac0a07b443c3eb65868aa3320da619eccac96c3f69b2127d91736a24bde263127046184d5805967aea274ead643e52663751907fdc44148b3eba674eb7dacfb249ffd88c11f704fd6f1607617f94dccf5a4c44088b3d9ed0103f7450040a0b11c48eaef2e74949d8b1e5a7f1b92e642f2c9620ec475feb7d88a5ab1aa833a7f23653ad3502b6e74fa39c17d2521c31eddc47345d009164d116929e8eac3cb34e2c7ce588ea3d2e8373148cad2aa72ae964c1850603cd44a40891ae2118076f80d8e5a650a44ba060bafcbc8796a41cdcaeb9b37c44fdd03118e00a48728768107d5da1def67745d5a241628afe571a499f4592eb1fc6ba8f4fdb0f4a082218bf986c608befe5793008701c3c2aa7c7502a3f90029ad046cf066ffb3ce8fb54984ba8eae1c2dcdea1c0446c1dc2e95800b5f98d7afc5da0bef1862cea792cb751a3eb1b3d5c8810573163a8f881796f33073b7795931b0d21326317b54641d8287a6e4365aad88044d02f81a9f2b9a2a51a7ce6b84fa514dd818019ee1e10035aafb6b1b09b2b428d2b12afbc4bbc8d529ce62860a7d586df9f2cb095351d7b7ac3c4fd919b215071e6d9c1d85fae7fdb2c45737c1eda78c289532e2b6ad160994f5efd51c43684276c0c25b6e1432007ce75719f23b5805aec45da3b33de5233db2f1be8ca8dbeb8dbea5a56cc104231f943e2cf83a9256f797146396e2b27737eaf1fd89c2b14f6099685dcfd8837643dd740afad35b4aaf2d599714a14ac6cda4a6b2daa334c52f6e381e6c894cbca0d078ea0d2b528a25d7f3788b727f11c17b0f4bc30e3e21a4044baba0085b734af61cb9622e11e6b6403c52b94b089ad8d2347757a01c301d592b66e3cf70af340df6a25296ba155605032d58049d84a2b84c6eb917b153080a3951d56da809927e3a13ebb2f8353bb483ce7a27abaff8bba8f604b26b6808b13f72313eea1b2430d54d7e37120eb56c16f288cb0e2fb5f5799b0a744d4f414536ea3eb0a9541f8321af8979315e8bf62be4ecc70850bdd2514105c674a0e0b8758ee6bc35d34509d5e5ba53c7eee7d9d7e27bb052a2513031bc5e66013eb29c256755270f9652ab2123cf312bdd48ccbc75d6b11465d0d85821055690b0edaee6a3a234b3f1456eb0ca485948311a8a1de7729119c756bebdad0e6253a4e7a4ecb875beefc1a218326a21bf09cb3e089682db83e316a6b0d51b660a1456cd8b6a2c69148b2b5c34ec8aa6cfcde2e7b69a69f56302b346c4381fab8ba34f1830e8051f551c270482389d1c000ef2c8617f735129df5557446b3d90805db3f7732d21290b76030fd27c68b9f9f4d58fb939647af1ca2afa26514c5b8eb11413c39f40af5de99ca4d7e11a9470b730a113da37b1d7479a0d63890a9a026ce17fe13753aad5dbba8d09bf0f85058421cbc5e50205a8b7ad7712fff23e96f1b5ba6be4425894ae0461001619dc16397a44b12b765cea5ca8a38663e5e6f6c6777d5697266e1cc671b2b0407273c0d9556959e728a41b0f6ee62b62d686c0e80fcd2a6a1719b824b42e871e73a3988481a679419f43ba927e92dd6970ebe7123bc0009ca4e0529c63fe3ecef50d4b5a1009be45071e2a274eae20f852db76c26fc7efcab48037a3bf743d5431bf54c5e2941503de3376ce52ca43230bf7f9bab9984480a27565b1d3053a21aad43c4be6b4e73fe6b9e872843880aa78ff25dde76c852e1b881a61ce67f9ff1b36d862fa2bcbc4ddc3cffaabff0b64e10175896f16be8c9997a3bcb078ca2e4406f371eed809715f0be16b83719585afaf3a1a7daf5e59827c8c874340bbe6898c1118a68ba176955692572063f880dc4a6a90b157595ff9de352a2bec157e16aba579ea74cbeedc3a7586220160a0f126d27e4be9e38c58f627a26f4dd23d63f7e7b538285921c8e18fc6385721093428daac1e7b88bbbddaf11b66e722d2353309274be065c870b09f01806b5a05b706b575866721636116e5b600aaacb6ce31cf608d9ab691dc758bf97b687920c1b3ed82a73cfbb8dc41a0b2665aee21e0116fd1dcf3c8affa26388694c379a51611638b4812d06bd122caf0ffae31a3187a26aa1cfab7c3880cbc5d1a37a3ecd64745616b76b2433a093a4c920ff956072031d0845020b299a8b092478a888033a624107b4d3a19bce361fe902000330b2d73de7d590e4f5633769e424c7a3fa940e26ce7cfe18a517404919d6d63a14679ab1eb8d0b01ec994e64cdebab2dfd8980bc3d0a0d7994fbcf10001b3d44eaaa3f1fdb0233a06dbe09f6f2453812936f2fb5fc190c14e0b42cac83e26336e3544ed8aa9082c862a8f6fc956762fecd2a4d3c3a55f74df742eb6c1a184cfafc3a63b8ac1971fd652435f782f3010d54b5bbcdb37527734881031f38a6cf444356ea0513bb152e7f9fdc35955001525092144510bdf568c710acee28f335e2704ee35899de05079ad29b9f3bf6648b18397b60915cf340e3805efb86a77130efbaa04de6109db539c7a822d74a14ec55be3aec4b11f2b369a5a407955ea8f4bb4538538bf39c8f0509eaf675e90ad0dbd1cab87f13f08943c7ab4faf09cfa89f34788b3bd55ab1dcfaf5349162cc53e9bb6cc12394465dc27d1710e903d49d39aa0c9011a635afe412d4f463dbaaaa7d503913f7ae7942a2c1971607c305707a1569fe4f28e6415370a09fd21984eeb0f585896f7faa798076b613e23831bfa2879884e43b11037b45195f5d56bf70f2c4c04c581fb90c6f81812866b60f46f555bd0b66e353a6f488f199652db45d5efbf276ab4a71d2215fd43f82a04b35f665b4887ee0218df903d6176c845b34f13b170f4c4f9bb3ae68bee097e6ff3494be5d66193ac2e31cf7bf324c7bd356179ca110e8fe1f0a9b353969c505d5e09cbc286a2c248c69b61b2728f46757b9f1118b6d39fd1fb04a545dd08dd322ddea368fe1678004b0aead66bd2ded75a32a4d0ae30869a587d08d084ec0ff775f240c7cc3faf4ed7d9696b2dcede29533f07663d5d710d876af9e23c5d7780774bc875939f28e5d59d31342dc90d311c6c60c33f8998bfd35f6613bc1d88537010a6ddc2ceb4adb028832e534ce8aed389c246ae40b1fb3c159918f86a79f13e174e46762850132c5df9c03f4c4e75871397af701ba6c988603730f88c1c0d14dedcd095843ba8eb02546abd76d1678f2bbb79dc33f33f1e5f49712b57728d458a7d65f73ad8d6d2c54d4fbfadfac1cf85f6bb7ec17d7217926f94966be93103a5fd332aacab240a051ec39f74de808bd851d87787cc841658b185fceed3bc8f1e1df017614b54ce9261fd09739b14a68d613f8eb07e00cd69705f2d00ac5ed533c6dedad69d5c7c63926f464a02dd78b8a40b7c2ed8a914b2da139fe52ebe4dc840a2a1ce021698ad0a9cf6206cf1dacd39e782c056d7efa6ff58fa4a567550858ccd8758c358d3ad5a3319ed1d5f4617aeb176ff40cf304fc34d61a1021262daee26b3e1040429c3e454cf58f777c7c9a40310cbf935d6e1cc8625bc8201d2f280553c410891be234c4627245d7796ec709870cce8adf78427f694a06b63b58da7ba170cbe36964464f0b62523053a44627783c0416b7e2ea0c07fe137e4556a26d93d2badc30c6928087e4c16cf207f3ef772e5258f00551d94ecb910515e84338244907e4afdfd1d8a2f715a1b3f7882cb2f7be2371dce1641bfc122b248304fc61e2154d4b9a25d5d2b28b16960d7671facbe94a275745092faf8019653e4de4e74e7b7cb93ab3f1163099bfb7ce4ac1cc08c87b3a0feaa64e5683ac823c3fc607fece25196ae9c8c83d7cfff9e90a9cc25a2abaecf91e21687702fe43641eae3fd4095daa806139c04f34983a6a2c60ef7b87f388dfd2f0b6315c928cd51c07f1c7cb7f1bb1531d046f4eb11547caf63909faf6fb7cd8dac291cc5544dc8fb5929ec357550b010163ae5e42ded516cb1dfe0e5e3df85d83bf31fa104123ad1295146c792377abb7115ab7a91dcddef2e845d9b63f240c01a2a8b9478136774c2a79cc2bbd718adaa4c9d59c7fb3dd5d189330e59fa59a193b98e54209248ea8bbefd1bb5b62fbeed81488ce5e80c73b4d78b86b3e4ce1652f74fc9930e4043c3eee27a3df63657731d329c65b1b676dd39abefb38ba104d19a425f9b44ef23bb319b1a51272ef5d1c53a296d86e679b8eda49abcde0cf44208089df2d7b9a3ae3215920854475545b953d16525a82ead960604ee50c5fdaceba0267e0031d5518af82b6c8c98d4182b616d3fed3a7b37fd2eb860e43d8b234408b37fe40a8944fd9f1a0ae4386b5c24addf5e3ec0ba4350a85b9126e727fe8d6688fc43242adec5e415b2f66ee454740ddd00237385c95f1ceb8e4e78bcd6d676d371e7a3103db7f1a9aa896e5ad4c16024aaa6d1c16ba21f51db7faea895f18883c7f8431657d59f70abd3d97695bfd2553ee2e22169a94c91ca0993117b7ecfad357fc78a88e05973fdd83238a6880ae94336374dd4e9f6662c5f1b9806e931941c1d09ef5dd4af9f911c9a086735390efa398682e84d3c9fdfb287dc71cc05f8665bb33f96eb87a522e41bf5133d6d54110eff96db8442db86745564fed51495698dad34b96f3302cc018e55a03ddac8f1aaa12e55089e3270cba5e7dbd00c6be8ea55bb2d3e5e74b4ad2414571c75e8167478682f342bea312f1929021005c189e9d2318478ece76e586e3080ee219247d4d413497a6bc2488a3127b7d0957775395388194ecf2809250c51417fa3197d96c800d0d2974f095803609c4d1f477f0d35485236c632b5e4aaa36eb714d30ca28f72184ddd34a93c31491aa5ae006212f227607551ee65b0cdb7c66ed8014c8b9cee1ae2e795d207d6ab96934a4b1a0bccebf042e8002b0d3cb43689f92cfba6bb62b611182db58dc38951afdb836387c6a66e9f54cad9f15f4c4f5360e81ef3ea0350c9ebc7f682be9453bec66478dd320ac12a198d5a666e429946f3fd8d4c5049a8488e212410a41f4ca3f025cd8f245cfab8cc2b33984ad96ff6bc9e336b72923ca5c90a77fe4bc3ef84036f3fd3631266e45310e53e4601b0964f46371d93f74cc119e98a04261431521176930fccb8783fd09758f485159a52f825f8f2cbe1b84d67b92232da001c641d4b39680ce9da0ebad89941d9261a0fe4419264fe14aa1e3eb0a585d783c03e6d159aac91786cae359c7e59beed7f62c7efb2aeb2b8570ff120ed43eb809deec983761bd32cdfcf10f9406764beac506092297bbd46a83531f3dac5eb5a309d710b5d8fd10b9a0dd5c0dd36ac8dbe6540240297c2bf2a344fa7c35d44cdefed031b25fa504f7653954a7e5749ff15a5c7caec49ac5594a50f22ff4dea21f5a9d2be625f7c622265a0388f93526f9556ef143e1f6d7777cfcdecfc62ad3cc6beb592d16f3680f9a7f7f4415414601eb866d3ec50cf9743007da2eeabe909eec9d34e2b522e85806f78d874eb15e71256ea4c0c27876b9533418a5a549d545d2d647140bbad914d047f10d4d9779040a312ee64055a9c9e2407950153a5b225c4ef74f996217c092c8dde132f19fcd530a77f84cfcbbc8bec9669f34bae4abdc97f2086ec0a7ca5446ac75233ae2e3b2fcb4657211256509c634614fa1cb3c796f97248baba1580631579010b4cdc53c1f33ad9a502d39af4972318ae1fadb40fe8d6779576ad86aef610efd3d2ef4dfc923fa8d0e429a16f3b2d0c4a406b770e5a8ce1c0ed6bab1e48b41e83d017d18037c66ce7e5f91ac51110a30396c4012a1e755b3acd39e2dd1b01c74e17855fbb8eb593fa1034ce87fb74dad4c3f03d49a01c85113c706fa2cd0c977e0e5a68f7038c5a469050ff99fc7d778023fca2a9ec6ad853b9183b411ed8b0b1be0b55cf5b7523ede1a169343f10ba28422331fbe147933b3d1502dd8fba45977603fdb484c56b31a4fc0a49767861701f42d98e88a5058a873af60e64d201cd2ec3b0e24eef787794eb4e5b13aaf3e5420e44f18342083016b96ee9033fa0bf3e409b26150a18ae75e8f6e253770ffc895e05270c1b0903231d3d0a0c9a0518451621305471c79b49259aa94399a766202d32456f0a77aa277763d2d16b31e4e6addc77d1c0279af7e109e85c41efee4b6cad3443512f56e4ea3e935ee6bc8b9f800fcdcdea73112f3b8738f991d11877fd7ff1d6e12fe8c447478b78b5f5372c3ab8dba769157543fc514eac7b28bf51c0db9042065f852c6005c3c2732c24add04691c3069c5ffedc05642f8da9a5d9f3bdbe352eb295d6bdab75b43878b8b046bf0b4d4268eeb740be6d7fc5b3241f6b13db24d3d0689e15eb5a61584daaf8798ab23574333610b2f842653c4cc18cc4f0637d85e5c9c5c6ac53f699ddf5ebf9961c59f58ea7a48edaa96d8c776d4e2921a5ccbce23f25d2bbbfa7ef8823d81aa266d527706f219fda3886651b8dce92cfeb9ffb8831bda27f578ebbd7d8ab04313e2df5f5d3da2ea6103789c9aa4093e78eff84be507821906eb3f4db5cb9435b1e5b216092cf8328bca2a0100fa576a8d7487a6d625fbdc487ed145646cc2770e9e5bc21ba6c581192719431fef9137d49f5f7092f8eba53f96125575bb15acc54d8a6487ce10d91122d515a8213abc601195e4b1f92fc9e5997c3797abc9e9c427d2bbe13b2ef34c9af89fbcfe4d814070ced41f46ddece749fdf397dcbe0b74ae5f13fc949a4b537001002aa061e52b435b1d232c620ce6236e4c9a3202d4134a3285727c08e3e6fc149c05ad9582d10462b34d7a667f35e1ff5b09dbd01f719a6328446ffcd8a29be13f5cc7fef5e51f3d3e2405e61dac8206f80a035d60bccd98174524acd8d3cbdafe5749fc17e14e8d9654e200adb06d7cbda9b4f2402833ede702859d6ed56429b56b39c98fbf0bf8730fdb65fc1d6a81456ba47ede592de58bf1cde1468824a488593abc856852b2a951a1683376c865c3138d3a538bede1a994dd3ba4af2b7d04c2361780473fdedbab7ac5c2b2677e951f1b15285705b89b5878a5ad022777423dbdd432b0a59e15a70d955db4943cfada24fe5f523b9310857397f815fa052c11bc0b5951807b728779509b2f9b639b85ffaee6a559654ff871204607db742c75ea0494eecf51d20d5187e860eee27cd0d51cbf80f01c8df9ea69fbd7b1db2d9b1bfb8d94e405569fc3c59b936f47c199f8b5a60a473a3666084bbe4b5e0345b995870ea60f66fb7fc411c2737cb84252eef9a58a185c648b5fd5f88cdc0e64b2cdce11fec9c37e7130179fdf16c085a07068c5d968349b82a2fb44e44429a8f6eb25cd1cdd38ddbb78c2107eae96f8fb8e81711d5b5168c3bc2a22f82ac676bccc9f657917da719e649fd0fe4e1054857017be134e82dbc5660ff44e27fa2fd54e1d8160552155e4e1bbd437a9065e0336c4ecf7cdb3598dc2a02a9f2c368a7b184b4267a8e55f1af452161421859311ed2a89dbaee585bb0a7044cbdeed866261299f78d315620cea538c397553f6f5ee09e98c31f96f768dad5235f8daa0f8efdb9966e68941bf7dc87ee746427cb02d8afccbe531fc4ecedcd810c6d244728125d4ad6d31d532a2322c0973dc6fd953bd2c03b83a4d8d7a23be6551de648fb86ea6ddb1d2eef096390fbc1152ed9b537eb6b24e79635d15c87cd309f4d2c87474532b45d3958a23f50e93b145d8fe3a0bc8b4dc6abd8218975684745a7072af0cb4edb884561fb3b770b7f768dc229f042387eb75a2891ebddac65e9ff1e2308df7326aad11499c6378fc5e243580aa33d94139ea91ede810264c8fd8abdaf37bc4907ea17d009e7d3202bbb7d54d90b82fdfbac979c23f1742f792d9cfb90dab115b67af192429afbcc8ec787a87b73904a658f9b34a3778220c039bed1e7356177182da8fda66341450cc3b8867ce13e2c358844b628ba19458ed78b446f5649aa18565745c45a63d3853d79907a4811f5860be589061eccc0de969c6ea7706d411d60d748df3a34c6d75d2237eb875252426a6aa98e70db4adf38ee646906d33f55f81597511673a12e8391f0193ba03408b69a8abf846a6f83343b340ce68def926c82d5f3c20b1cb054bdb982c97aa6f0846ef5f7cc3bca999570c4ac0ed7f27a5a52e2791bf78da0662f913a7bb5d0f57acebde171cf0ccafb21f65131864cd44a0ac660f7f20fb1b63c858fe5fb24d3a08a79bbae57592b52795138cede2d1879eb2c96c1b4b5319b6fb30be7bbacebf42e41f66a468ada227646ce5f74674d60490f1d21a2242faf65db7c6762f8d2969d42fed0de25b4194dcc30d1212d2cc7605f4f1eae85786c81d823cba550eed2975f306207be2e29aad6c2b80845b9f1f7558c92fabd17dae5e89bfa614bb3760c7043734894b3aa4d99e1644471abbe5ac276ada6caa85f4de9cb0b67a2f52e0e0eb57f9bb4b7404159831e76aedf2759b8ac490673e2f40613cccfa99a8d5e38acfbb2d1495f91e92078cc2cebc33df15ca4243c93dc919e617a05a72a56183c5febb89008e39442d5857b833f81b4d2e376c725b95e8fde71acfc36a12da0c882748a9b653795818f97b416149ccbdbe38ca2753d2c36a6f741f6df61295f781f58573a5ed1f8015e5a0ff6b293675947ad8ad7492d810620dcb29ac84a7ea56ab56d5f04406fe942f89e0060ab51dcd94abed3054a0692b07fd94232428f4d5f463d79c74241b583a113d2ca0805a793380b297f2acfc7c57fee28e4ad69690adbb46f739eaef8f63f40aacdef565882e9b31b3d41dd518ad0c66ff8c273a69a99c12e0b011cda47fb88f33d00892af79bb1d3a345a40e2d87485d80d412afd5126c13e83c43fb1f618eea6e4aadb65e38cf52d0797774b983726fc38a267e6d2ee00445b8ba4ca68fc8aa57b90c93da0a2781219423ed5fd95d13e9406f77144473b8f95ed62cc67557788429492a25c3cae89cf767675c5bf3665fb12766b27eafaaf3663af90e424bd1253a899fbaa04461f8b3d3fb3b790570547a4de02bf5afd6e1fee6c9c7e3f49ce309ee228d5856062494b3080ab052d6986ac413e099d2120783eba3cab3cd8277815a9cc27abe36c9205bfaad9b75e16aa3394744c22398bee2c930b5b93dad7aaee91779e6ea873396370ed33d81f80527a90909e15f34f3f1bf40ab6a554342d5d899ad76da3f295ce8f76ef6fc3caaa0520b480abdf8a5b95ee545ce71942d7597a59450f863591e297e8f1877d0648dc504b4389d0c7c8a6765a3fdd75e75969b73f1b3d19125baadaeb77af52cdf54157bd7923cd9727f7b605bf1b9c2dfe58f54d931a95abf2cc0c76359e364aaec26190bf27973d3fd639923174b2221f6eae2e3301f886ba940d80645ea95f674a9ec37b9b9adacb89f2fc7cd39187520a952a6bd77dcb78317499cf039e6d0a655584a59925a352f56bffc8e94ec5782f212911753afccfaee52d17b06441092897355b91a558ed64218055bcdc26f89983610896a068380f1364dd0ede42f6c083e6d9c977c38373a9cd3b98a8b13249d4767afd05456a7710dfcc847bc2af3d006dda6e4039ab2040f5f692afa9b2a51f6a1484397a1e2b59fdd310f14e3a5f81717c4d2f00e0d07b8bf8b8e260095ed1921e3d1a086c974fe2fcd8862f5dfc9d779c89269a436962c06e2b35955578c9b21c2f19c822ea59768f86801e30f360cac09d540293a5aa5a23edd4310e2c8dc4d85f7d113958c32ab5515c7dcc5cba0756dda990838ff0f84663da9183c3b263562343fff6401f35193833ac4ead6f42564b285ad21799880c149d8d85207f4e7e74f4815fdd49c45ecd5167605453abaf33ba63f8938ba25060bf3e573e60051958cac41f479b466bb42da5efc53ce2fe0b3775db8e67d4d079eeff865b59916e30cdbf5375315ef59e53325f181e84c1bd1b0381de6fc6d35022d3a959104501468bf1f76693ee9b79803d62a4bbf7003c4a660e780439dc4e5639d8882c29d186653077e2ebde29ecdc7161d294caa4abcab63d43cb5c3cfdac4991e4397a291bea3c49e3f1db4ad87c56311d1acea04e6aa4af39f57cf43adc022d796f6e5e28c61b3414361b993f5077b119094d47214611ff343cbfcaf7d7b76e9e81b930ebf9ddcf455f04d086a575ce61a76dabc06400957475a87cf6b5b3da0668a703f545de51cf8b2be9a2fc32947d73e27efa5c9d0b1c58428479be9de602393589a9524ac5bf105fdb8865758f0182c98e6a88b6a4a9373667bf7cc2592b45c476b024437cf12e7794903be82ea488470cc756fad0ba1e19be11dc3f33bf7ffbf4dad5a1b28ba6f37b3359715076a8b4a30e56d83b839214ee945ae10b1359bfead562f2d7232f9f41f91180e833a9b882ba57b9cc294fd9ed0ef0cb779ac62ba0735a4050f25d11f25eadc2f7e0cace0143eb08cb4fc7a265cb6b5a909394cd38a8b418df3406cf868484935552f65f567d8ce1618b2c8daaa90413b02e7ea633a7476d127cd78e864090d35582b44c5b08c15810df52276e0ddabf380ee500d58d9bf21fefad26c03b6eb791816e85bbeeda94f99936a069b4d3c3de2325c9c923d34e21bc84a921d8b66f549814e4a8a35edb6609c8899072e53ab85b39965d69d10c1acf53b3a69a068f85c2b3936d0e2edcb33df4e4cb16755ff9f34575b89be122ce124f3352d08a7fe887bca8f99e2bd3b3ec44cfabbbc28b706bb6ba53892417868b51aab509682cb5e7af3ec8861d1b3336b76ae8f1fd24ad640fc4945feba2fc40b7187084a31eaedd358a57ead4d8ae5a890fa9a6f430d8b07446bfdded51af063f2301a61c5286a1c26a03251815db6ad00109a608dd14540188323f8d3018417bc4035dbbe95a7bbcb348fb93b11305c1b051a68839f8934a911fc5ef4ec326d180f153dd8ca635435786829649b8f88591f600110f390571a946230aa229b88e8bad4c76bae3eea585dd7bdc550bac203482cd6cbcbbd84f39b178595b2e3c4534a7f79db1ad29948a7e0e03691988f9e2f97262ad76364c8d79d632b8468af7c10d3a454072abbd7e4d1212f5af32e140fcb17908c561ed387450c0ae6960326207295e89699cc7dafde555d6b516229165b3fba8a24aa64ff45f6361ad46ac71757ff293a7b49b1310d4810498b37ca5684e1cb0b520719ac250be730d18dc8cdd96d27c7581dc2ac0e6187e491a1fab64ebebef385a8d94057706320fffb00f8f148eee465d12b20e9748cbf3980d448713753ded1e14c3f29fddf17b18d181fa9b3f5df58ea5100a687a77875c8c0fe8d64ea56781da5815d6e3ad0ef5cabc9269ae1a6b2060e16ba1a5872db4da1b1da85c1ecd1f93d53c3d6e13151b392882dda061e8cd1fa0a3b238b96b57540187bf0cb35896c037e19b2ee521932bda976f3b43558db555b7ccc4faf9c876673f44aa12021983ee2b260b7188d1480925b9901ac34c648efc2519b6a65263ac3f6e26f50efe8a568814fc8e0b41c28559d5c4d48fa0e07a22e061f30b923961486dfd13d9565f86fff636b2394a4fd1db38fb89f496e2df72976e4e5019945bcac1a159f5644cb61bc523a0d7eef6b64e6b17d79bf4f09bf4bb6bd2887ff2fcc90d465dadd63dca37adad18b4ac930c4df73d66efbaa2143bf30c703f3bd37cfee03a5e6e7d22deea0641b3b1bece1af04631b478213a03c82314e5d14ce8223bf91e70115b5f7e6b96b934dd05973514c102d22c2669b3d1f6804f3f341f130d05fb6fddf28928afd04f6c3bbdec169f7cf1cad3653c51d2a2c9457f1145ca2500b8368e36ea03d2a01b80e682048eec74dd55acb1e2bd16249fd273fa6d4fac41068d6a1054e27333b93fa5e59ddc498cb93528fe3a0ba086e3af63aa6a095f2c57601319b8e84aa9ea9d2d1db35cb81882db1e52812e94cd76caa7c0f4a44fe079b1af3671d2e9ee94a05b091b0a6c6229b01cd6d72fb4fedec07fec095597b361a4d7528b0902815f8b7dc66755490756c272d186e45f058c3faf1bb750f765a4f15aa8bdcaca86fcee8e020b292c7396e877d0bff6eb7b4b1e2fe1277d91f13237b99a0696c6e4d7f6954f409a707bc97ec5074a213b885138bd58c0ad07eddd954f77e96f589f3160443ec0d769ab7011c5b42c793312950fe5c18e097f957b5d6e583489ef132885f4719f01a160bfdcce0a3f3c9ac2595a2b8de4df917a2b122b265e646f0a8729c99a06bb807edaa1dd09ee7d81134997df1231453abf29d8d1705f2251015107852dda09ea4a8429f21c4216030617195b9d1054ab21aedc9a7d6d35a4ae1b1a9841e5e04c439b612404b758cca8d3667058a944a7d512b82ffa966fde6f4d7ac7da9c7c535fc456a5163aab33bc5e2372cff20bd51f0d6cceb83dbec673fca99bcf7db43b3b7135c8ef3e5a88ffaa13938b40d6ee736df1f7dc6284ac093d990ce79dee22b44853e54889260636129368a80c91c7f2b1d8ae2291f1199aede95797a47fce017f724ac7ebe7efa64baf3fdddd6e15c4a7a4f9584801633d447a79f8175212b7be311c925e1378a41d5a2fe45279dcaee08d9c49fc64b7a6df0dedea3ea9716edc6057aa82c64f3adcc723f7fe6ae826b37eab4045746e32a09c4beb580a1e21696bd03946c18e0992e1726e9451247849cea2c3d367e60a4f8426f63f48ca0c008dc715db34e1dc11000fd3a842bab3b6efa69fe3210bdcb46d36366f57a050f474dde857ad2c5393bc901a428f82091f22ac0d183c0b98479594518babba00bddc3a4ddf55b1eda5223240c1a3614e9b27c33a5fd920da65baa93253de6575bb72cd19b548cfece6776f048efc15ee621ac9dee40cc8916914ea3ed750c215bd28754bcbd35b202a4894e05720f42cb32bafc6287101eb1cfeb6b885a0969a98287bc3119643a404450fb582c59effd232ee8dc3121f8823127bff29b9884c95ddf449fab2549f96a1d8f9ee1d43a3b79057fc05d8b5a92b120f832e34859b14e19ce8913c6c48d3a3ccf079243f0b9763d216d66436cca2278154ad89d4ded9f81b80d79625d2ea56625bb4bce9cb3dc7b8874d00024d6b45f79e4c0f41a252bb41a8631baa7329762c58e17da87a55839426abe8ca244041fb1673b7957d9a976290b653522da2caa794af14cec2a824a7b8bc6b7398f3cfaaead905976bbb5c33ec855c8cb5bdefe13ccc8c4ecb9e6d2836100134289a6c0efae2b78c9675f83bf9b8d6831a6709cf5179e6a81ea438a30f457fc602107aa31ae699e6397a755e14ad8806de3a1fd128ccd3cccef3ef375db72932eb7a32bb2d0b35bc355c6d9c37420961e74c3080489011fead243888c5ebe1c4e056b815e65bb289e102e0d3b023047de2e37ee20e51945731dd95bd790f0e188bac67b16a3d6632d6b50344b47f84bcc5afdabe88499c1f386fe4017eab6995021e2ac525d111a5ad64a7d1f24b424207d93c4535a997a3f419345ad679605b8721c2d9f941b487f65b865541178c00980e5c96a0df86ace8076ff3dfa138405e587143a3e0ebfd2fa91e208e5711c3d151da52df0e0f1f09567a68d36ec376c0307b841f834c893adbd38a979e8a3a84da223cefd7649bc065c2983fb63ce96cfea8f1c93524a6211410ee472f9dd78feb2693a82328e3318ba19ed4fddcbc0ddac5d9e9288f32cf3a7a058bb96dde1943f8b2e214b988a961cf124cbb5fd82c9f6750205dab3846d2e66d51a05bfca38185a97f6a3e9808ea8b1de5f7aa947dde68baef79963dd8f5d632c1c39eed75a88f8d27cbb6b842a9e16404fdcdffff898ae730d1fa5a61662899f29b1b5a26931e2c0ded09967ef8663e0a2d8d51ad68c1324d28788b685c1daba169aed4f4670be0be88608ab9d48ee7635697668b72ded27fc5365b4a350dc1b652d5a469c21dcf523f6e413d8bd15084ff352d4e1a8d8af132a91ec33979b0601894a4fc69f085d2aa5716c7f9e224a1ca64fc93da9fa291b77b71bbc9b7b5e50761839b81f2456965eb9cf1f86fa0ab27a51d500e722b864ce743ef52ac91fa5b4d0002f540140978675abd3a56d0b77c7690c59ad08b876d08556f45b2830987bb3a2fc15b0960aa64347efebd1e50c551ab84330f57d3618c06c24878d600c5846ce0ccbd29ec425e24449c4e0f59952c85f479b2145a7f516219b3c222698c2b9f99afaa537ba125f3870d2850edfa4b1c050608999bdb4a92e93258bebe9ca482f0684483976347e7fcee5e61d5724e82fbd4bab64fd8d8be9f3707ebe6f53efddbbbbf68cfc9a65469979187b564554b4eb8ee72dfd9bfcd0095d484c2e1fc203afdbff3b199f03a10c466b6d08f7df2d0e8fb1d3d50e9c1dbcb7afb4a0fd4d6ae815c57cbea30344ab0ccfe4b0f93f0ae49e7bb29a9d963e7db006a450b177ecb3e0532b02c8b78a7bd5c958016fbe29d0b399e096738b5de9d2d61b8e3974ddfe6e30cb557fc579c25761ec1cb7d591a8e29dd824bd690e6043eb85ab9b605c68c60aad16bff25e2c961a84c929773cfcd092a020235608eecc5566c7435a42e6d96b2bb51a5a2ad3f62bec9827b1b2f1da08a8c2f296cf39c9e5a3b2a4c3a2ed3e200863eb75fe153ae6399163eb44742e529d4dd025591aa60d6c2e71f82b969863750eb755e1a231d8216b46f39f64e519cffa68523168273cd21ea0adb4fb75144984af9bcfbe2cbf0c18d93284dd46fb7a40e05592ef8a5fd1a3240388f3ea84816588646f77f7d3bca1d054272d00816838fb8538e6dbf00fd623aacee7aa384eac7a82b77db9099e9fe47710ea31c48bbe15e9062e039dfbb54f96272b6c517a43ac4c2496aa66a9fda8dd5852c01e4804f4d4d2d30608c7fe2099c94803cae54ff3c1aeba491d1e71e204869e05fa366f6680dcbdaef317b0d855429fb926f75a1c5d70fb3c2bbc29f85f9a9d3c05c0d17ed926b0ac12402d5ef7e2ec7d739a290998baec4fff9214a9eae5351d6331d8dab01fbab35e4efd970e76abbd557da9cf050825a50c963089536dec973fee817d2645ac4b0ace7a2e026c1d033779914eee0e9e63627e4bae3743810ca4f6e77d79a1579077abc61966d95b379d963ef773513b845bfb8a9015b389c5abe7dc21300e0f57d6705941b515b599f976c71e96d23b97567bbd078a725a97da074c84a5103d37e66e4e6b362c181b88f78eb4826c8f2a4f39b2009413821066ee9edc6a327c97115c46dce5c9ff407dc88c35c41541fb1695e23c6d827a56ff211b2f86d60e8a7c858fad8d848ec6642b1b0f30c7af7ccad4ea21501a901cc155da1d09a70389c087de090c527f1a44df975d00e5e49dad7961e7d8fa169e2f4f8d270088b3dc74f78779a91dbe3e550a39985945e88370fe54fdb6672166922b0a52e4914066289b620983d331b52be53dcd40a6a0611a9770070d2f326361344e848adce36e38bce7626acb4fb6db845650b7c4d6539aab14ab3f0c513c340ab25dacbede9b970c634cd527ced54deb1e961ee2d4435218d0cd6fc5320845daf2385ce5bf037ca4a3cee43e1da5f1b077936a648160643086bdb39eb3fd464795e8f1fbe1de9825bae7585d48b00a798dc24d91397f947a9308cf91c26f87c91d4b77d2bbf161294d65526feed9c568cc2fe6c1473fcfb27d8c030089c33ee704285dedc0a219edb301160a1f9827314164be40b255a362dda656bbee4a4f9f2022f53cccde50ce9d0312220ae57effab9c1ebff2fde8aaa9ef5e106ac49d385b3fc59622b520a4dcd317f3cb9b912b6c2a062de470545b1764c3ffb624ea9aa728d0b58062defd474ce582d14e9b523c82db01c91a724d6d781d4086deee8b1799b4f964ec558bf5961ee9ff12d526c03e76c72d671b4f81e8710e7fd58170e4e094501164e76fcb422d15782c20497f89f00d2194120a763b663d58a319022bb2f5d89acd24c8a5acad8d42262fc16e33aab17ad616d6ac15d6e1c614c5da4e62f5162e69ba0586b8c66991d528108c96065362f8bc70f97b6342b46138d03936cd54a02156bb505ae6220dfbe5bcf742b3498c8a60f0b8fe79cb4310aa19f66fd600f3408bd2b5f05593f502bacfe45c32e9b7a69aa939ebd43a71dfca0675917c128a0ddcec60fff771908523857b4e62ce25adce27220e1fa1083127a01d5749c31cddb07616264441fa29174cedfd458df6a8109958b7d4c52e78056348780ddd9f889dbbf5f41af9fc05fff93d2dda6852101139b5f75b103a7494d66d71ad7424678c928ec8403092f66fab7ba70e7afc9389d12ef235b8a9e745948aa72d335d35ccca37c1120d4386cb70aed0a3adaa9a1337b1d855523ecace64ae9dfbabb15fcdb59b80d5f26a1ac91015a6c815dd2bb1dcac06301b4b43a18bd29e08cdabe92aafb2564adbd060a9e95ab20dad7f64a5c5518e9a3ad514936cf0177c38e09499d8715b75e5ca25a27da053e5da1087ebecbf6f22f452fafd78f6b9be292aaec1ce425ee7655f3a75e7b1b101cd2cbb8f2c637cf6d871d309b391ba511d46e4114e679587a62b0ff3df022ab3242fa6c38996c10acbac88af11e046e6eec903b0f3c8838345a9c33a433f123325da29e0e026a3d3f86d6c4a25ad5c6783b96ae4c1e5dd627e4a632dd9a5824a93db2c97e11dbedcc286b49adc061864b8cf633a697baa943f420d614ec1d441a07263728dda9aa5004c351a4b90e5f940f7c00c63cb3d3828ea29133e6504dbf8c03d037d5262939b3a3ce4addf2dace31c75db5e37f2bd6847af37a944fe213a26df17bc34939d9f7c8dbaa3ada8b1ed7fbcbd2fcb6a20259b7b76c312aaef7241f9bcc8f750204584e9f15972dcb968cade5129505d4dadbf2da534f182fea4a1912842510a973fbb1bad80f4f66c3e4837a78d70c95989d863d639f889c0267af533b26a6f68cda4eef1d1a2626311a3e53b1bf62da499c001998cdd5765e5f7531b962baf29e81118892a8c491c4e7abf4a87202afae8b884dd6ca08c2f83aa7f83f97b321b0ec221d2a9093431ceeb8e897998d1886432d239503fd8e28203270f22a9ae8a3d27b6e2a6cc31468be87c097b9298d5654f08f5757dacd98737f9b888d171318fab31d8d99353da35056203d4bee9763c5410bb06606ef916bc0485d159acd282c915ccd2e4c214513361c499b1bd9e5e3b4dd75df1d411419aa2fc16813a48c6cc6f13b81d07ad5fd8186dbbac9de3294949606e1f3c2fa7eaf03486bf3af4428bbb571bf82b7aba9125f24f8c824dd747d8159d5e61b66ce94f28913f7ef4f0e4ee9770f2ea322543c7f8bf8f05a7b6720f20486c097b691c9d8c0c784e1bc8c3d0233e07cf19ee749a35d846fcc31237d36f235f45bf0286e027bc21fd72ec464204185879507af0774a476c726818c6423586c83049be87b95ef155380cab9504f92dfb86b20febea25c869fd7670ce62c78cefa75742362a1ad8be6ba60e1665784916c4f7bd1a8dd8786aa758f6ab7ee13515f9510e2621f71aaf7f9c37f8dc8119967b36c1af13cf4dc47a0e89cbc33d9187cbfe13686f7da3eac00c3ee0e19c9b2a7e439963bd4f4b3212bbb01b1786950e55c7e70efe6816cc7712ba21e0fb553175b1e4d04e79a6fa6c3fc1dea2a873183d9b1795853f50abaee460baea73b0b0ec1f8b0ca41dc93123ef58c11a4382ce2dbc2cb6d204292bd7b020babe69eaffaeabfc3a324d4e6d27049145657bc8b5bdc901a6c025096991a347cff4ae55a7237324fb623ef4b698d1e890dc1eac9dd5fe918f4b3f55a96f79995d611437ee804c07f07d8ff9d59abce3aa034f6f85a6b88df10a30cf58b295c3c4e2ee0ea433ef4d297cde1441d2bc9ac3e58d981826f11571bcc987ed9a74189fb1245bb3d5a1f44631e65947bdfd2b09424b4556408239ccc952af99f375c80742bc96ce5bd399e1624a29cacb89810d92c9ecb88393ed775636fec7f0bbd36260f88706a796c95efde79318b1b9523af4a8394d3570c939cfe9e6645a61ce23e1f0b47ba08587a0345dd3b42b8476815e2c88ddec572d7f04658d1139288101cecd19e6fab1a17a80436c1a92d19604a3468d5b4e2846aadfbf7d8d5cc26f58df931f21fd8da0530cb55872640dc77d5e6d493043ac3183f2d72686f3b2763b838a5cfe39c7c681c76def0a3862fe3fb5a9146b8495a4646c87cd9173ae7a52ef989eecf3fa42697f4fddc9e3f0abc99c3a123bd7262aed7200f6915e1b18a79d585f4d02927454a535f335d2f973724198e1665a8afb45be5b48a39d9035cdd277710d08236a1ae63825a897bda312742f50c93e44d1d2a07004061b595acbbd07813e624300ff15ba8598cf1f5e2f930a56e6c45cc0f7fd79171b6968f18a1e809cb4390ff96433da929f545f512f26f407e89af5a8e9f1b48eb72f725981f72ce66e43c209e45b2a9b54f1a983f76d923ae779878553969cb3718559ccf9421a06bf29107795c39b0db604911efc3ed2fc4f86a890ddfc225c1279bc0c1a6ed7a0a4a3db4ed39b4de8db682c10ce69c5f785383c90c63f4bd090a8b9a1910e1816369f039bd8af5f532873cbd34e6ad2f56901e05589e97fc5560c43b4ab0d11d9f34cab801181e9d1e8aeec756d48daae939b39cff65c2d28d09d6eeac9f2765403eedf5bab051f4d172633dd245e30ee2fd6de568a5e8dff34582cb327f98129fc0c82738c97ff9a48d25deb279384ddbc95047e71845dfd8d95964f8ccb70418285cb16dc4b3708a4cd91735f022d8f2906961e5c6c22ceb3405853574f6c7f06b541da8bff9857850b57d1c7e9fe1503726ba08f9c5d4b99a9f346e040fe7a4e6093d64f1ff0fd1e2d9c313231ed6896db69f48ec7955e037393aba2bd8c0257e385b3880d80cf01f133eb9345e7c189f9cf8b5c96aaea9150b569c162980cc1154575f0d8a556c7888783866141dccc624656708b5f57b5dd4203a9eea449ad66b57e12ed3c68a666e018a04f64372830f072e2cb207af45dd9f79d2cc913e8db5dfa20ee06795c761f24779e85135bec5bd32e9ff3990a6f8b93856d613ce8a9999c82e070fae2acd27baefbcf9bd4bd9c7ab0e5d85cc37b6b432411cc0d1a17374cdd233f781a85fc60c81f33625cd8a42b20ed2ad3bb37e91d15460fd1cf05f9ecd9547508b71359b81de0d0da4bea388f0f1275a6ecc1257beb0ff2d10e2d46d4a247aba2a4b10db3e6cb801f1d96e38d0b5bcf3ac7c0d9dd66efbed56f34792c8747140e3700f3af15b4efb37fac07d5ddf829d8e01b02709be842a0c8b3c96ac7d1f3a32941fd7dd67ff409fbb3f80fffe3811827cdfea21db9bca6094d45c7191a1096683780f4881dc372f0c5b63790bfe98456f5a951c1e53c4a311adf6847ddd1512918c0812fc52ae186e112a402c1064fc39a0ba60020060087a980a0bb73193ec488697b75a8b4ad04e2296ddd19e677817db96d4e8d3cbe7e0d5ee7ff0a9d210dba780759a23aa9c27180205e5b01532af97f511ec07d4070bd2e950e1f72eb9b8b76f93d66ee38aa306f834ba7153d2d637d93f8eeffe2b81601d16762c941c1fe3fd8eb013de9e11274265f7cee571079e63b88404a3b63f1a8604f7343e9fb49e37238e4363c7e8e6dfa6f61b55c9f09762a2c024f743136629a26366a1dd02301bae79bf468ec3b4fefbacb7c5188c22b21cfab8a8fc7e452472b999df409147fd24dea85a29e890de4a125f8c87d789f1cf143c10f8df92e8a3169fa9c06d2dae834c089be2adae72c3f16db42de339e60214d7de600d3d8aa9cf212e4437c30770254272492b3ee427114777c752cfcf9a5165486d6ca2594401dd4129eac74246ffeb5ecbdcdefdee33b6f2c5d673c4150cd80faed75d8afff98bae244eb812d054d6a34e550dcdc7065fe5c847e44b3eafc2197842becdd18419d6f58c9452369057745c583886ec874db474086e544748acb8e7ec1e7f17d8c4c39db223597c46fa05d4acfba79bb0dc07dacd54a44b738b7a3662d0174cde44c910f89c3550e43b96e097a6147f0bf9e738ca3effb4fee1df219703628bdcac888220b16b44e46f83f003fa91246d5618ee2e03fa0f21f189127815ba2bf68d57b577555ac50248a294b02ee310ea48f4769b633b1b644fbf3095bc81d223efcfb0060c0fcc7548afe933e2992d40497c5e1b351ea0c4152c83207b356a1f2b96ab294beffff2eb57ceb184c9792d31af4c7e8a493251bd8e427b34abacf4cab24098701693fb4180f0fa9f4d808f49b6b8c1af12e6f7e15228469054fe2489aee957070d17a408f0205e670c91eeb3f8f6e63275240934a6ad47aa459083566291bbd88b9dd5b72636232345fd386cfa87f589a91185d76492f4d0716156ab25e77590b299d42bb6c003a7f773d6b17124cd9288559b6062c63d59eefe35bfc53003171fac093fb1e7149f0a0e2887820eb17f670c933146bf007882ac2ee60837f8c283356b36086d96cead72a282c7c7dec02682b8f732d521bfe8aa2293720e49b8987f7c060f62521eb32246f1cab407b987ee1bc5d25c12354b5ed389569d230db5f47a4ad22f3acde4ecf006c7605dc8763bb1a85125f10a459488f6b4b35942b34cf527ad29cc9ef040cb6acb3576ab50c395c864143aa0c2a4682b8f02995e9e89a3973c2fe7a34744d5ac9061ca8163cda1837fbc8248880a772745b9a8e6ffe1965ba963efb76b46524e5ba9f29f97d55f08208be05ba394d840c24f0a016469d308a9a6cb8c53c8867750dfa7959fd10070dae24a27055d9b43f4e1034863cd12bf2b789fcde3627435fca1e11d93ace1d9f6484cd2ff76c252f8495def8e7f86eeb2bc5e3f6ecbc44fdffabebd599cc2f0a1639994a93dde1200bc30c31b191e7938d4a088178e377bd525e98923cb99712a64c02f99425b9be2c27e90aa30e08f20be2576ce7ae05ad98c306e5f4f925ef55f1334daca3bd3606954a7f85e4e6e1f02e6079861a0039f22bf67ccb1dad67b3d40cf87998aad9c2ca957df9686c7cd5498deb00bec27974c5345fe48fad5a184dcb615aa1572472f79f82eafa474a62862c1028424e3d18a22d1398b660b902cecf3a355bd68bd2d2c0cb1c26936e016ad0f0414ca1c5e0de1ba318e9852005b933228c1f4ff810b3308ea27923588d86c04e651d923f59fc3893d0515713104a1a16d9505587d4dd16478eec51d78b570a99d8200daa7e01fd5cb68593d4859d42a6d1ed12edf77c30baf1eacc04e0dd9c52dff92102c388aa68f4a4bd7332116fabe704fec403a4bb0fa0db0843ae464dcbd153b781a5d9057dc8da8a4cefa5a68db6493570532254eff65bd33a6af07137ed4e78499464bf1e8976393c2c358f9a05428a47f26477d809e2e951c1c27631ffa2ab6578b6af7dcefe867bbc4ec60cfaa5a0d44b801de353866afece66a78a61ca4478a9f99e8ded029e39126a6172a78922d7679cbfb212593a22692a6b375c440909364a90016d80db73f0bde4c23e06af8e1ab1c006f002bfd75cdeb859b99481d86a493fc813c552699c54c694307fdf0016350b8ccf8848bc2d558278797704a585b3c9807a11d970ffcb87e7ebcc37e7a3297d9f13d36a2a9d6ab5d3fa6768ba0759f303c01567c132cb9d9a4aedc89f14bde4863bfa48d1b5844a35d05578b9275f47c1b4deb5a31bc185517a382609e4084cc476cf1137bcd0b27e5e1d7baf1185981ccffb63da20554342e604a9c41d44c37fd40ca885a00aa292e2fcd8076cf7eda1838da166d566d3ba1eeeb92b861ea26bf045fab202c454eb1b5a48cf4f5f484cdcc9cfca5fada18e77adf417107f130c47c2c88104684424d443cb78079493648afeeea2a9635aad5028cf8c29c958433f86493c345bc4f5bb94105f2f45ac4c432d7b24274b619ccb5f7361b76ec3151bec1a66f5f6170db7101c85ae826f69b60734ff4c6c2b4696448b0186236fbd81713290e34d09f371975cfa3b0f55ad7c974fed3faab336292ac5b17ff296652b59ebdb3c729fbfc8ff5697764299c919c0f7743113a5ceb7cf6b54034ce9b439592bb29704a7bcb7a6132b0946c38722c2f44251e402a28879c234f83966b7ac5db571988c15296bd235f8823e3398f3944ebe4b3529c20717d9b1f0352068ea33884408e0c44bc3cbfba5f30f7caf2a44f1bcc78ea176a8c9a8ac42f89f4e7d1df1908c746078d9e301cd1d7c5733287b37feee32f2279952aed1b7718089401f4fb2c2d30062256f0133269abea0253980b2a87e436edb553d612406ce3ff8ca3986b343ff06cf6312a0cec7425490dacd287f92449c02355cf0096030e6cad2257dee560aa40ecbca6e0ff8be1200a5bb851f29913f3cbf87663f874d8eea38383d4f4ae8f88962350e05b0bf27011cfe293df346173ba3bdb2d9bc65a844922c840392b4079593dbc179be93d9c1e20a01334afd813724e1b5beb809757c9cb02bf81f60ae49022acfb333eaf7d259d0c0c2dc23849db1c907480e189696c8038886367fcb1ac5e070c1191c1804123132b5b9761b74db4818d521eb67f642db478ea53946e5936e7b5861641997e1c712ca92653fa586ef9dd727af0b4bc0adc0051d79f221768a7eb5420e2159ae0e7f38d0fbedbaafd9451947f0bdc18a4f3d8ee288f0c0ad1a84f6506a29e5e2d7e8c4166b5a8c7ac6b87e2d90d49e5d092e8b1bb90e2a858b7419a0c7c30b5188399096a4045fe201e3722a8ff5c4dcabe6c4d986e35bb19bfe3bcd590a0e963e26469361bd0c0a4800796b3fc03f07ce17d38f5c0e6051dd37d89dea50f47f1e98ec336664fd9db1bd5fbd082fe488b6f166b8ecb4eab4cc72063f82a6ed7318d71dc2b7d3854f8bbe2db95ba039779a1e4ff707bdfe5eedaa75ca59ae7b9eea3cd4ddb851de8e4fc17b52149ea0295225566da568aa35897a7a4b12559e2e87c68d09a2c1fdc4c9b62e60c28ce441895d5124b41a8b77a8bfeed16452bd5b6b777a3ef1cda3e728cda33b0c95a497d5cba33536bb5a2a0c8e2200d9659ab8338d025c3636dbfb7ae842780421abf75fe95945a1691dea05d4fc7b08f9657e80a4305e48fad2a53d3dbea788613a37e83a7996e005c323b4c46627e1f5a70d44f02f9ec6db0c86bdc11908b6a4022f69f0ea150151f53e475e33b18afd1f9e0f8d339656a86ebf8be6d533f29e051f5c1bfce59231ef7b9f7529fd2b7940446288f76849b8db1384b7d2533c8a128329147ebacb8544c901fbb991348cc03cdc23860930622aa9d1bd78846391f27f6a6453d1e27607089af59e274fae4f5dcb4b488319269c0b991addd118704ca0f519cd19607ea1b35f840032a55202a837c0b15d6aec8d34d8a8aa1d8908324b892c3550b2eb9a09a021dbc9eb616ffcf887bd832e83d58fbb35435ab57bd241992a2bb5fd8c20e2c9bafeec3aa0f955ec131138c6374a06368b9d8cc8287d94c998128943ff5512958fd388fcfd8ff3aa63a49314092ab856c1eae6db7baa211e90db8e0484c43d9f5a6da47921b66fc95d0d97abd14c61125e989e97a8c0eb231d720ed709770dada1efe42919fd057f01a18a16079fdc3813286b9dc3c3d1c18fbf95776633021a151fe3036798192678d95b6062f0e45954dc98b6db36c643ddb38f28fab86787ff3fc6a7c9db0734081fadfe1d7dbe8e9d0e7dd2e0c551da814711735c7f864c5c4b887c7706bef793a96a573c33f91ed71c69998a268268fb6c402679b3441d02ab05956ba31751c446ec8d003fc1d109fa68160742f695526a5e5e921ddb0a160af8362217c6a58c93cc657a0fc03c65162b965d02c2cc63f11b40476987237284f2a4bd30841893eb3ec334dec0712970f2d4f800001a505ddfc913db766eaa5a9d30be53b2e03b90d24cbd28325d49542bdabfec0c36bc40e151b4735ecf271621217af325b206cc3aa88f342bbe25f8ad7bef40df1ae5c9d94410e0b30fee5b7ecf6507cb86d397795a6fece8c88cc8811da4fd71a005a5175ce0e0c786c6d3907d4caed7c32836cd9fe8d398b42205ef451d29d032a52a105b7c4427c5b3d9656546c5f72c57c26d7156160755dc7767a4976c604836c63a8145a1fc9c017347136982f973c4beea418c8cf79ed83e80bb153d6e4012c17c7765cc92e772cb70059beae38649359e529b7e18651186fb75338a128155ef3cc65c2420cecbe27536f6483685f658203389ca1fb21bb535686a5fc6b476dc594e0a05455aa1bf0758a559f0edb27851adc5eb6821355b6e49d7733f568e0c1fc06aef80daa161f46cb3619daf0989f6e44e2499c6ce7619984aaf225e09d6bb6de76093db1c48d0d4d83c502a30325861e4ce8406ceb6e1384dbba756c18cc38a0ddf2ad31bb7310e126eadb972fbca314e43730f49667ad8a7631c3a1b67d7af01814ff8609c2a906eb9dd0c56dc180ddb72315c49d7d66798dfefc5abba717f2c28a0ea50cc90d883beb409188e0743d614d0eddc6758343492ecaffa15406abb896b9e7793dd54c9566935041985333008d8d4be83aa71f0bdbd3f8cdeade809d53996825ceaf2e3125bdbf310a8f7e608f92e6f16f44c5cf2811b54cd2e9d8e5ad036e0da1eea85f79202f237f9c8a6fae7144fa5c5507553e23d91e095a57bafe799c0437ac9c8df8c6954ecf52e2bd7de4284c785cc39f8c730dd96211aeaf55507d635c0890955a79abe10874aa6f86bc054d9be75b3d03abe58a3901cdf58a2a01d258deff5266762a22f43ac50404c18881d1491b96e55de96e5abc18496dbaee79ab6eeb18717b4b08c5e728a5900eb4a99dc0ac90d84637e83020b747412d3287ed4df3549276fae2da7d87523082cdcc34bfde21954517b47e5e0443a4989ecde66fc3e549b59126396a9f07b6d845a4de1de61a14d8e07e3adaf7809de080616c7a174ada86d45c1419606cfa6f420e93cfedccb6871f0e7fc316452004a4a26963b653088fd2c34aff1669bedfafb763b4fb8c3c62231deb56d966918d5dd995d22695df48133badf81f161b44a98d58b39b73bdc22c933b9292b96fe88d4ec92cf83aec1a056942c4c0521feb4905acd9903c07674b18ea931691126bf21b560b348e8933c4bf769864471df1e34adce2c77614b1a1fef9025e48e9d7aa167db118da078cc4a6f2f6605ae4090cf8d3cbc7b36cf9b2c0faa8ef5145e6b6806388ac6c220ea7802541e53eb73aa003db13ebfb937ee8d544a00f3fb7daaa841f666297f57ada0afd958be46f9b27d05629a6c8febeb431de560a0e636a8a29608db623b1dfe67068b38d5405b5a008fe958dfe5b3541c7842f1adbeaaa0497255c31276877010a76fa8fb83e270c14ec41e24d03bf3ddd82c2d4b9a73fc1968d6b9cce4ac2b84b7d2c713c0e3a3000664db67b18c3157373cfa6438196e1e210cb9bf1c2308e88beb2f90578790fec29ed4fd3d66135bb8ba34f7fbcae66e4fd03f823fa1b63777e5567d53576ea718d3fe48a6f4c2836bd58aba33d1ecdf664f17dadb0edcd705a2070a86a6ee6a5a47ba6b7da9e0f2e482e5b33e8cf65664ae18fa5d74ed541ee1f81aa84a378c0bd0097144e58df815061d8e6dc985760d063b1b8e2458dd149c2c321e45db26518c67fef906a49904b3919cc9d7e03b0990f621cfd6d19770761a94982a37d2029c8d1151b75dbb3d43e466d9d7ba91275efaf9aee2593c3687efc61295a9fc68cbe8a223ee4e079cd7b3c0a817db16a7dc38ddcf6502c647057413eab97da18d81acb32d44e82c5a87a7edea78c3c4181668e8371d33a92af4daf1e0137d4af9c9d6a2d184dd03d0603c9d43e6927cfd528f372c276a4c675497e0d92710ac64f2af073ee83bcf9496e8ce9c7f4c49f328ba3f6162195adb0f2fe594934c86744101a21d93ce75e559286a7ccf77a006cc9fcfd65bd10de23b362e45fbd179a0cb2dffe8e0c10ac2e730f5398181d39813a5147e63236767755743155d25d31a8f4c23b1aa316567de9a7728d43b3bc1e3310762b0cd1870171597018e1de687d5447c583ca8ae142bfdd0a9d6ef5cb3f2481b83fadd2b578075f1dfce5b183fb5ba5cf75f8205f6dadb36409f1087d3a24c12146989c8fe5b397c8ce166fcc0e173e9a6cad8701db3cff17045bd044b477fcfc04f98527c2e23a8772b94212085a4244f82d8f0b9d0411220205cfd2f12606d9711d6fd4e378c87a6575c2f6f793e3406fff9b5d755499bf974ab4fc834767965ea9e563df9bc246f512cc77ff60a6ab0ab19b0b673249413013aa84cb2fb0dd7a1bc4726a24e7bd27c8f542a4cac4cd14de1586b373dac788313bb2e2048dc40e790967bfd908821f6c024feb6ac525a970546ee4aa36befa070d4d14ab5983ea303dac29268c1c641ab57f593d38f935af23f81ab6e19bd09ba831b9b79560d63c840387eef81baf3c38ca89dd52cd05489374a5c0ea67d08d139ceb800609fdf410703bd825301bf2c22cd0e819ccc368cc2a5baa2ffb494cc97e7dbc77b9f189c582beb9f723460b01e083a2f5e9662480fe7f26ca233616c6483991d98bbf50ed0411fbccc0680d7e8ce1d109a6df7a870b60c92350abc6736ffc2663fb1b055a87ef8650a8e44ebc35ff00a2f630b3fc33422f4a064a0c41549eeb5ccde69f8af92ccf14a5b78c8f1840e38e8ff8e98b58df493df58ddb6f0af454df437d55e0ffaa0b2035e4b1d80232c5aec261c50fcf8127c4c593a67364d445f1701ea0582c500eb03a3a0d6f81bdec3dec35110821c53f81323a3dd796ebdcb21f44ea6f584ac432d550801921ae5185f0317708bdae7ca65c3edd2ad593d18398c0d450fbf875035d832d8eded5231d28790fe30ee1020696f97ae1941cefa7c97740bcf0de7f409617ed9a35dbd8154a91e830b222bcf2927670b81a272afe2296089d788bdcdd43d0b7316517061f5927501b5f35afb207307a33ff7940120359b72aa3e887983d268d12579c9064f70b7edc8c8ec05278cae950e26499c10b3261ce5dca49a60eb2596007f6b8afc0c607c0d689fe5e956f29c25e2ee7bf6a9bb3910e0b90d30bc0b7b94487a7b14ee0e23aa164552aac9a61ec3a572651699dc368c17d453252dfde1288c3adff7d04aa71d6d19a55e3bb58d7e03b92763490aa516cdc2cbc2962b3fd4ecb450fff512dc19a2a0f6250fd04fdb26c19a8332531ce38f3b0d798301a8631f8f2034b97af50ad04fd732a1cf3f3dd314610b571e03f538e62ff1f0709f259793b0cf5bcf8b71e1a6da5dcf5dcdc13070925a5217655f63b768e242603dd144373cc56e16148da89a8a1bc7673c326d2f1ce1969eca1f83a138935b48cd51a28d7359f9ce2b9c53544ea2001335438da934561b0c8c49373d1aa0cc954d2eee2a456cccb79cba11896f23345c584f850ada66c96dc074a64d8c6ee16b267e4d5da9b8b1c93b99953026cc7a33b19a8f8b78a44343f53aed76984559af688d67e724ccc410e700daf751914ec4247d3dbacca2c6a4f88eb03a24053e86010a82ef82accb6b6a70eacdb6d45ad9e917b5a462f724cc6556e2929f5b02c1a9dbf037ae63fed38ac7b5574a6f3a490058e5e68be2ced1d58d4d78877094c5336bb3fd965c0708d057e00dc72e3f93bbd7827f984641099dc3694fb0e04769c539a3df746ba83de194a8f167d31a99202f45cf18e2bbeba7bea50b8a8b1336c7d0adb584dcf059c5951bbecea033a8f900da42019f160ded7b85f0e6ed5fccfb42973d8edd3eee1e65c65bb95a7418496a1fb18287dcae82cc34757918863d60ca72a882b3a1c610359b4980e5e9c464ff7dfd915e798b9d41cf1f3b189523124cbbe0870d5988116673f2453147c00c355beb08437723e33da31d685fe6456da17c8d8f0cea3cf4c8dbfacc4d171c9120f9f15bbb62a7c925ff1bac8e24246f8a43bd91ffe64ea72374361099174febdf0e54e13524342534d2114e686ed4266b8249b43d8cd846745412c6e00a5cab6c1270e1fa40c5a47354ae1b92ccb9fe14647ac370d006d21a104dcdf50a4b5edb71d1be7516cbac8798ae4813c9f712ec4ee436ebcbda67dca8007cc0ee9c1af9a22984ea5aa0c8be6ca10a90e42cd75e6034c7abeeb03f625ae07270287b035f63098ea270adc1ed3016969489156b6525cb3b63d1a49623c94c429e427c2689ec2ddce5a29d9a8e1037979c6f5d94d1803b586d056264f703af44b979c0a954e8b38fe3c5622e6d8e563450ba9c7b5c95aa1c7a0479f16313f854043349abef44cf2f082716b6c726f256410adf62547ac900f8b22f10fce8f489e2fe3e1d4d682a6dce697e6ba3d1b8132e7ede00ef8810e9c0e385817437fa2ef79304bf016fcd31ad33d05db1529a2c4fdccae613a3f97be4c2a97b2a041bfc26fe8d78538f0b6e3eafcd5f454bd93b7e80ebf5f1a420fe0e1e8e517e393fd69722b999f3c7c177823ffc3f8231318c546f8db8a4bee244fb686206a3ef69cdd37437603000455529efc7f3862a5add1b72ea973f30b039641f903db56635006eaea7674e51cf69d79d95d603b21ac229e899e6ee0d57532c6f91e7abf57aa3e1d5b8efe41f4e05206b122ae216b4817eb90a8ab462d9b5631dc41bbaf365fa51859af7fb385235e9c4d5a68171c3b54010dcf6abe1cd8953025fb17be126349428555d4082e497a42a2bb8aa3917b602340203bb14b73411b8eae2a7688a274d89001527a126f00a49a67ed56abd6637448ee84382324876fb7930059c59303fd8c12c0546af468af0256ba91b8c41844a1be6118a02721123471f28ae8e316b9cab830dc86daed4010ed78240edaba594046ebe448847441895e866f1484c2c8c9f5c2867e8bb3ce37de5505cf4f6551dbc411a940323c2494143a2daef5bb35feab4003fddcab249ab97791dd44235e4e6de096f51c06a6c3a7d11190f45e9caf7e136cec5fb1e3a505e3f7478cd12d022ab21cfbe4321172202ad8a53a132dd5248c699663cd1ba1b895489681a755069524affabb2451d85f048fe668b7f46a48115226551d334fa83bea8c5592bb21e24d4d0222a15b0e93a5931a1fab12b1cb58667fd2798a4b1e20d33b6ff438cb407d61e47c548f57e1790ce4abe3921deb509d19ffe4ae49d0ef6b1b623809a7b1ddd6a5b54ec5f0befc9961000b39a77e83d074b365ef63a03a12f2b4de23716806e6133ba213035db863ce1ea31c7ed22bf562a19a77ded645e1b3994ff34190cdbcaebe2cf47542a72894d8bfd42e1b4e5b565265c98b2675952901394740373802e535170b5039d2299680e4b857548b03f1c3a7306dc60116890a9b23d33f4679cc8472cfe051083559de481d49ba53e414226cb5f1a00e5e463e7fc22c5fb51fa6dfbfed84ac432851bb90321b05de883184236a9ca9f07c8a77aa1584c3616ad0d86758c1f182699b2d52c4d4837f6ad291727e4eba41b07f23c098c6bfd1a252a74d189f748f3f7672c191568a0543688774b098e16a462dc69466e3941b26db257d2218cb6547df5b7e03df2819932550e19a7628647810a9636369f406890a556f84f21e5cc9d89c70147c36a281340f3879be7b3255f4af06b00b8890fb6cf100a87b6358bf0385bc4bcade33203e270d8294d4a8152cee958e202c5f19692690100696e7cf17b38f500700bff11120c8f3fba88e678b56f12c6fe587371718c1abab86bffb5c89d3a5acbf56ccee446f8e9e9be01d8bd4493ebafb9a33d7177cdc188834f1bb1679b11a7bfb0a89b03fbd7a7947088e438a3ef0e01348e7ff3f80d184be38b41cec47b37f6c16480577dc4e65ad33fbdfab6ef02e4a8bff7225701ed6aa1f6192f2ccb672772529b64c4ab1055b362837d97f315b6e5efa94d05f52dcbcaa432d5806451876adc3b516ca77b2acb5cbb39fa840b57a9e53e658aa10056905f138f90cd71eb9c2755df978dbc6203d9eab7e0f9f58e1c764a0286b33e72678dd82aa6a2241bf801ae04d228700a3529bc0154a0c144148360c2c043eef2793c49305dcd0808475cbb883fc41991229f58edf1fd0e8381df2e1a8dd3f0b8886edec91b88d81168ad5ee86a66750dc8dc3292286a8126fbafb28e48b977ef722d38b2b87f991854f66ef6a769eebd01922e67af0bd283fb84e12c6d564bf4844eb457c72371e5894312aebf06ab672927768a293f96e5cfc4420055f23b2eb3758681a1fbb2f3eba369c7a5b17c56638d38030d1521493c1faee3a10489ff9d1a4b725e0fdd5f254276685d853755fe36d65da885457fb7023b0623fa6a979855eb80fd980d2270fad7ab16399db70b009831c6c239eb54dbdccd3f380f1d2d8caef709f4a0b65191b1525a8aecd53f7a08740583477f18c6a76bfa84346ec40930bbdd232877d8b721c7344ff17c69564177e62db738336dd4071b21b45f2ed2827e19123af83e4cfb720b65f91a1e849826d42ab1a26648a95eb6ccfbad4de9f997a7098975fefbbee295bb32e99dcb8e5134c56a8e50c58bb34ade9c369390f85e2f730aa9bc0c249978a43818e7e16f6f6c2e093653577875828512aba45a31d767321bd655f48a614fbb136e040f65e9304d19441ad08cae4a79817e787dae1c2ef39b7e40d0c48f073ada9cf3b9a989523ec47f86f20335cf1d33de1551457ff6f303804d248f2f66774544cd41267b8c1934a1c523113106d9d307538e2ddbc9336416a5e0e87e95891e6e9ef8f02f5ddf171be07ca3818b42f4ec3735b3b25ab7450fe9836a495e2db9c93f8224c1332cf4c44c15f5ce1f0063a4de340b14fe5d3a0db8514930571be9569ccca5926ac1d6ba9ee900049acc0cccb9c9df529a8444b967a83228fad4362a5028a9deafd4e38eb952746d1fac5cc9044c7589e61bcd26027a9ebb4d102d12da2ae41b26a6695ff7f5ad5fb0c2d883e62c60e652f0ddbc3c2dd641a268f8831026438fdc989e4d938ceed0f7cc3e27788c40f2e925371c0dbd6923a0b48a9b02613a1ebe883b090a731e9981b1a8788e9b7b2f9574c3568481b67529b1e77cfe2f0acc10a7f62c0e6f2a32b0f19a7a8c3dd5c0c13b7dee3892bd0e72bccbc2f634dab1ea24ed845cbd723ea096fd164d3a67f7f698f92a3cf0cf0d3673d1358add541f8127ace08d635d73ef146b47c9ee1efc594bcce9ad6ca23379b57de9ae2456d6d806847fdd34d795c14eba38807191fe663a2963222d258220420685aa5f03d0ceca44b76444359ca2d7c9a192c2b73f80ac64306af942df02d5fb68a3fd41cd6e1f035e2417a1ade5599113fab45dd686779ed9e20a5e13fcdad3380f171ed38bdab96db5f8541fa1848c927815c1618cbbc45756eaacf26d6a3a66c5c1f287d4f46eb8fb6d14becaf6714f115c1a44ae5236072046d3826708dd93fb4c0e25350e6c86d7b24c32b325eca574adb026a15e1854abeca6b961b9de63c2371634fe30282d9187851f7c5212c93dd12c1ffda150114ebd0c4c7a2de8f26647e6ea4672311c62808e36d2e958dbdb2369f244cf49b1c595d0263b2ab0c48e58aa179c1082e2a1ddc36840b4a57e1cd426cdc64afecc521d840ecdb2db779e7da67526220ad696e6ef1d309cd7d78f44602e2ccbe39cff09c9ebe1258be665d510065ad2ce9c2c21eefca6b1f0c3bdcd67e838316b5c130ca40d71578b708d9880ac8bb342f3a7c7109d733f96ced95aa38037c32b69789970ec4b7cf6f95ed93d6485d43db58751b296b4f11a0e83d98b5567c9cd32f7229fd432792a3f176ca38f1e342b8afec03cc7059936b33a4bebf120f82669e4d434fe990ceed52ab09501740bdb45977b1e6ea2d10d3358e71185c54318e234c985e5585c97c61b75e38ca295f14801d56f22aa5b5a966089b12ec00afaa5d832e6005a6047dde21d6c3223f2fb547237386c02fb42c04c8eb887fb35d2bbbf474f293c19fd6f4e30d9351f47e5032d5a0f759952c7cd5ccf6edc7fc78904386e4bdc8707c68d8e40d2dc3cb5e6c71a1671aed77a45b753ac982157b66512514c4dbbad0607ad754fc55981a47589f2eaa9ff9dbc1a1fb78d129b98073f121e35fa8370fe94a9ff639fe90aedab03428f76b533d56144037d6cc2040112963cf2e2d9b9e9fa95e1ce814f46367ad4aef2307162f6f4d346cca4ffa8b2b4ef7e8b5c204e0b45ec1708eb6bd439c4ea2eaabd81b55d13d802b511c3f78ca474cc6af69eea9082c47c942ad17002e4be87a9f5303ced00fd17c3f394cab33e6104e073382e0eb0ecf72bcd759bd53eb1fbfce8b23399ead4002398f5372511da26b3f06be0ea9f19d636f3e3cd328dfe74bba2649e40ab3447dedd2204ee3dd0024846cbe3849ebe682a79b2b205b38e72bfb5ba5b5a764072c71524ee0fa70944f7faae3aaa139da21c1eb072d13527b17264fb48bc587477e9fda8b3fa80c72f2f8670fff55d9f1109379882d9ee647a46c78b381f68a9759346dabced5cedfa0b6a3e265905d23c49d0edf667548f401f8cb88937c2443baf9871c87791de0f044f190658f49edf14feeed17a9cf0109adaf2d38bea3bd0ea86a795f40830da6b32fe85526bc82d9b9a89719c477d6fd55c275fc6273ccaf72c7b040d0eef2ec8311c89f8a831234eb81217f6b33a71f2463eb3f3bfc45f38f21ebd6918af33478abb69b9829a73ada45570872c83bb66658810ff2f78b34b4c30f407d08d2c30310a2b939b4b9efebb29b1f77d58f31fe66020b508052e796e5c4af89b6a500c6d86ceec88ec06b8a4370715a7b9ae95c2dae8ec6f4176e5f397b41c4fede5d628d68f5a02df1ce492a505add4c6b3eb255843e95ea99d8f850f36f60505c3b4b99193f2bdef760e81ce63506313be206bc66c8c25b3a7632d13f554e336f4e2480f1909d71a5587d863e6a044cf8d2f4e8425706e130b603bea32a48858cc6c666f40850eae882887caf42d2c3ee64b42a8ddb20d987dca0c862f8fa9674865e36850d3009e7ee5a47a2703985aa1e11952118dcda079c3b6fa0cb021439662c06e6acb334074ef6b27b70e172a77172c5adeb1abfabb30aa127663d421d7c7997a41b52e350682fee1ef21c6ef0a127ab27c78d7fd4fd2c96692fc7ca421f6cf7fadd3b1dec2e59ad75a6e4dd5004f559d79703c7cf5fa1b1826e5bac916d38483ba777670d2cf58e68f9649a2ca54b9dc2ac9f868d31093f4efe8e9cce6d0b1641ed1784b551bfb2f597c1b080635133e375af25c16fcda5d5568968cef1e749aee95483e666299dea3483dfd547b44d278a88a0f7747b32e8d7312763961f33413c1291719132a8f2db20e4cb8b91e1349b56f4e061aff6fbffae80ecabacc3eeb6a055d8caaea5d39cd39c9f1bf154925b18e422fdb41b2f8a2039381deb0635eda5baa8f3399fe0f6c2895da87b6681d812f43c8796c0013bae76ca30113aac979b44ad394f6c0101037761fc68e6ddc8d9916b713120f35e613cfb85f15365fbff7a9ed553fa3b0084a9f4151b7c4f50621aec595272217850de51de48c20d105ec2a070eb04f8081b77dd72db9beae5982d82954bfa31dcada588054c2c31b77c031bcab551f4e4a5e8e459aff77daf4d798ed4a53f48fb0cd420343b1be5e607d190b8188edce452e4f7e728ddc929b9b572db7c5638dae3497e61bdf7ec77094617b8ac2cc099f65fcbc0120d503e835910d575311a7c1dbbad1b7003e21f07201a398b4bc62f05b8ce06ba4eae1038e18b615fc477e114576f05868ea9b2e63b6c0ae5d31fd73c81f823adaccfba5497b6b479437cdd786ae92a515675bfc7a89e64751c8e916aa51132a8c5dbb3798b4ee24b071280e80947278f8383a71e43666e6424a97b45623456ff6f34c27a5e6b6ba1586af0ae98c769fd3b90c7adc5ab17ca5ee85565413cc2b40f57bb97ae573a338df2f7bcde6bd4e81142c6e18c5022e393b8b2972a7cfe166a63ba27cd9eb7de1a4dee5518880be11521c44bbad9948fc0258492c57efcb115edd9fcccde7c5198952956ef121dea4cc838ecbef247dd3f7cf65105bc40f869f7e83cd18e3b0e2c4c4479d05b6e71fd44ea3bb46db3bda41a77016f6960ae2c4cb7e6b9f01dac80b90c47d08e60f44d481ec3f97d67e3104b78afa6f1e09421c38f8ebe116566bdcdfaed84bbf3695e9aca9f22b569067d5c6765eaeb0242a822d167f06852d309a1071c4a21b20819d14861a48b883bcef2515cb71abb9049015a1eaf9998ffdaad92bfb21eec3d5a8fdc8aad673c2a90a46af4e2445a0b2706852ffd7b8aea26da41e4a4d00baedd830bfe7c22f8428749ef2a5048e9cfdf97a9cb460da68632e55ef3b39fe63d4dd64d316c932a6280b40de7697c09b9785598ccbf1871db0d6450c787b72bd4ab96d9c86bec692d79d3e1e5bcf6a03b2749af8efd1b2c06c76e4626c02799e57da05bc690e03661dd333652b37d65acf18924a8acd5dfa3336202ecf282eb2b68f77b2d280174b2d9a72f07cd9cd6ec3f38fa23281d0065c7f9487f59f69dcd41daddac169141c13fd729eb7864ab6e71cdc86153c71d0e5c11ee4cc466ff65f492af3cd1c020e95e58021af66f53e036059aa33e1cb2c7a8163e63ba6091812b6a7ca4a09b3aa58b9532c514514875358ef712ee8c7ff8c6dedf0bb6c3cb5a7bad7847e20151b72be11ecdcbddd50f9e55f473e377884e948ed4088b41cb9643eaa4838677698cb1fa06d9a06bff728e96bab238f9b260bdcbd8ac02ece804e8babc72e167065851dab76ded3832b9d806093f3b5b82a1d607a9a48eeaf0cf220b6992393bc70ebd02ba51fd1eb8231bad6dfade453df35953ca83e6a9aae70b9fa24402ff5e602b5015934d1f4f3ecc10fbe9b2ca94e98713b337c213453747b95acb5306b224e08c68a6e98e721bafe0765d9f6984f77c8aef80aa8ec40cc201171c42adfb5d33f27769cfb7d7db7afcaeaa831500fa22b900cbe95af52f1ba1c62d4fc7ff0b7225f3e2aef69a0bec5e6dd492586d809276ecfa0b2935353a035394f56e4412c358d3639ab00d2790bf51710d956e1e316027748a74933e99ca80acc1882979b794233234436b113c908cf644b4d50753f9bef5c0a0675eab7634226152c5807b7b37a5f2e57d6f56b980bbcf9e5367760efe294b059bccb181f9fb37ef3a16145c5048f3b1f7ffc093630cef4067473b39cd4b6d762db1c982e52e354fe0257b544fd14dfe54c3f4db50f42d8ca1eff5be959af6b9daf38579eeff906d50cddfbaa21f989d48e9c2bdbd7a121aae407a157dfce33d2ec6fb7a1b9d51bebd5d23174120079ec10948b1397f5ca1622e7d452d3f5aa25bf75709ff48d7636b96223f6f7c4410e5b3c3da6fac8aa32902888ed08800aa76db059e466c1fada713aa08a82b4a8142331636c50933c1d8a08a698eac6b7955c0cc4199794f204b5ea737102b0b8e439a46f4f765738187df5629a6241e3233d617a74907b8e9d256d474d40d5e3f75b3b6cf8b81c98c13c6388d1f201184697ff2198250be9211f534b7846ba6a7273126ccc31af88606995dfe2f5f19e0e26978ab27394a6f197a2412eb0034e1cbed2fdf84be81d0373614fe367e3e750f14abcf2ed41b4a8a8dbaf122fbd5aacfd8758ac8adee3398b3149df2079fba21d484cd9d6cab148362128a8d2632abc135462bd38ae18eacf06b6a9b4d0c879e1bfbdb5a73890088ce00a2dc7af95ecf1af893d9cbdd267f7e9d1ce645cd25da9eb90946d70c245d2794a707afeac0f705389792cba546d07b853abfb5f18caed9e4c26a423f40afca2e37ec590376ab2b439e41d8e2043a1a9097fdb71c203b2734442facdc47249ae8fa1142a472dc18e149d5028b65bad4489cf4b7c79f72c8a0498af9d69261273699dfb2e17a1ee6b68bc894d6cbe71c593a6d6862a5af74db4800131b0e8f6811dbd8bb309602f8d05d58e3d9b4df1b33261120d5dfac75b40a2aa082965ce6ec946a694dd4f80c22a0851e1cf856b3075950d711bb572ee41ffb3d7b44a5f09ea01cbd35e0c51bfb2424792d02e75fc7c42d551680ced271d4b4cacceb100e234f3c379402f7dc5c2cc38892ee34b32d96a95d63500005da13f85255b5c8082577c6f254482ad2c4f9c3803944423ad5b866398e81f9993cf34c6dee8317286e376c0bb30a5b363ad640d1c309be9e4579f5a58e08863efdaac54d171d5215660885157bcba50a0644512bf432e9b6706611410c3678dc44a685644f75f4d5c14d5be8fe4dffa752cfc700d82f0e51b8164f6f5776ef72d4a56f0ece11ab8626000dee1f796348f2227b7f20e8cd4e2582368e08cfea999cf27c6ff6175fef8badb8235cbe5c1531e32a2d40e1a6aa82e8e1696d4201ca1196dd34dbb9aa68046fffb58d0b8529d8563538402d5841ca203445ae3f0348e5bb486f3235d4af01ef9cc13bb70a94458d42c1a347dc34dad5e97e22f152156ce6df90bda15af6496667ca2b93471b6914ec8ddf837008dd9f4b8aefe4ed9b6f6323f426540f04e2460f9da984afc58462d5bb952631e6b6fa266e9ad4357542f660c10db1935b8d6160ef74043344cb15d65e466fca5a90c0b3dc98684a22b42281a0fccb3187f9ddc8a2d7968ed2492ad6a9f8ccef771d2b822390ee426e92a7d65b0b6c25123a4c49d3c52c451270445d44ae1c17a342c8281e955bc7182e40f4a65381653a6d8a4c371ad02381356948a506e99c46c66d3f28ecd7781c7162ae210a80c2efb969d4d4c6038757706b1cd208754eb1feb5ea66838cd879c0fd3c605572bd8710018b35ab3400f54c3f355d2de2d3089221cc2d8c3516d7608858960ae7fdcdb36f8eddb1eb7c86fbd3fe18d09d5689a1ec0a1d45ede940e2c829a15bcbe64c991bc03b19e89be37f8bd36fd8fc26fb9eb2e56357a9a84bd4579acdf776849e148732c061934f9dc84b27a2893ccc79ca95a64940690a6de2f80fa27573e2196154d46f202991781cb6881bbf6acd471bd584a702943463ee5625557db752e16d0d03e9f6c776f3b6f05ef9e7f578ff872137fd2f5fa020267ecc265c6b7cf95e8b9e36c31c9b776fa5ab1d6b809c02a03f02a63100b569d2e5142a1e919bd91678bc2b64eaca6c86dd8160355e308a3bedfaddc555ee9d4326afe8170ecb0c36504c8aef011c9ec0d5c14535ff61237180524bd1b785bc813558890eebfb2335374a419fc247bd555ff32f601ce255c8d7f280cbb4efa8abfa58054269414c95d5ee8251a0be24f168412d4ef4e326a51e8040904a07e6659a8fb2c6b3e90e510f6ba3a7d4cebfd335a53089d8f1fe5271baa6c68fa825417c9bb29efc626f7ccff7166d9b819d15dc681c6835562eb02c5090cf77e39f86400d2ec13e98b4d10353673e8442b2b057648e622724c61a8b70adc8833fd72c9eea6bdd9ef01846ffa64af62ab72576c287639819f6de924d6611b8f625cc112ca51cca194fb8227926fb8538a040771e7add778d04316593506c8b0a2bc089b374cecc9fffeb6888b539844403024c7005baffe98cd59a0157fcb500ad6c97dec9ec038970eb34b6d8580b8e5687b82c50c5d5ddab8a1071a3ec6a6b5fdcec3acfb2517dd0173f52c1e8cd7b7a834fade0559a93a9889900557e686bce493eaecf2c90e5148cbe6f45a1aa529b85ec299e7e47b467755e6f0a034e03af2b2675060c0c329910f8368736cd41454b5249e1e8710fc0cf6eadacf10fbe9cce2fa85a72b14f6bea8648fde86c6d439233bec12e6a5aab2ed160b7530735a4c293714f36076dc943bc8955382ebc810864fc9afcbed521144f6fdd5a398d61bc05e701666d6b9cce74c9e4524e489fcc43622e56bdbff9888e0a6df23f0700f7f1a6df1000d4cb0b3943b1cd0ca6a1322300f648fd3a7667b4672506586280707d98d185c38384bdef1123eff396f95d3a7d1c5de7ce646d9036bfe6f898f0e6e0a69c611ea67f9cf164efa1de4fafe4bf082a023e10db39d430dfaf81bd52ce68853559fd345d462865c9184baec53816c593bb3f5b68a7b9b120c73bf1ca8a42f53e480ec5ab0aeb562a3726a5c8e877bdd8f7c1bb968ab722229664b7d707c4196eac2ed8b9c20139e5fa80eab6d95234e438ad201d7a8126cff7273484b58770c6b46dc0586b31c32d6ae7dd440524d39452b050193815df0976fabe5026f859db373944ca82b58fe1dcfb967ffcb40a055c7a9cd53e90628716e4173eb755430e59aea7abf7589b57fd533836cb94b06577a83cfd35bda4d8a2b561ce986a81d6c8c3155dcaff7bb3800dc9ad3ffbf672844fb7fb6a378a343460620756d1e58e3e8cc657728d6a5aa7199c0a89237c621181ba29c7662701f49a959059b36606dc64b0a9dfd4325123efd6b1a2070e23e19b6403b0014bd94ea66e9f26578985636a1da51256121887d18179b892cfdbf3a6563c80455579baf407a729e85d864c3d5899aad3c847935e417ada05ac25b8ace8769fba979d49b619740157f31a189c3f8dd7737fc54d6c10b8a70c29fc25c1daefdfb9a4125e040bb58e033285478d25aceb2d51333a37228f9750bdb022ed25efb5d8fb4b3f50f73c797caa771b47785525eb7574e5c597e02fcf7caedafa3ca443c23d5c3a21d944349770c9da6275e59995bb93409368aa55884f741b2f5d630dfae782a618952608b7b6cc1442a8c5ddd499ed89fcb5ef68ae2a1db08690edbdb0f84e97eae2d2b195f48eebd0e30d2c0d4c61f3b20a53cf08693af6041ff5530efeeff4d271177bd0ec32647eea1b6188c55fd3f814dd385b157b604ad5db79525f4582a1595236c2645bd8ad56b191d35141328a6744f911f5df0a08d6b77824dce59952abf42b98f265419c124b1c5b898e031752c9e8c6286be195d4ee83332cd796be135db4baa71a1964430702ac90fbfa366c77235aed73b5063e363061ac71cd275642f2c2b2247f7082d72e6cdb8e38c29083aea6f5fd9ae9a28b8e66289880da42ea5cb6ffd3cdf11baad7c9b3fd2db48c23fc4124d3be73e2a4ce35c6d219ca107bd948e7fa2ed0b76a6cb8d2257b41e2a6240cb8d59b927d17173bba78a3513f027a1648a17c5b4bd540ece9396e95eceda9de07e0b894352e478034247395e51fce6e5706dab5fdb50e2f16228cd127746a18fc46a8aaace5c56867fc7284fc16adabe172962945ea1709a6e044f61acdba836aae54c4f2ce11a3ef325169f1d2c6d959f9ae2cabcfa8ac05d3222fff59540e5047d505fc02105f127774f7b021e64e07a6210072224d92e4407d8349c25b5017c97b5b105995aeb179e567dfcb082667747ed5ddc6657bdbbed72c951a819e3e6095fccfefe2cc57b28e4fed18d45ec8a9cbf68b20e88de49b5a9ef89228d391e37d6587a3ba5e102c24d0795018e4802c5ca208c7ba04602c5e949e6bbb0c5e8b0354d77aa1bbbeabe12f337bdeb20d12932d97fd487700fa6ba5a63362dbc7a53c201d9aa5e0b6e99a90f610a181f52a6cec671c2886188184d04e12ac4c1ffdaaecd24d5dde9497e6d2c04ace2817149c8b53ab75ee1e634b72a9bbd37c76d273d1ecf123be7b470a3206b62a77e957d8008e6faff2487853919b195072c8c1546bb80dc24c55e837cfad912126eb2e35c957cb6550843c0d43cc1fbd80dc958299311a24ed2a9d4eafd0a053fe85c4b01d657f600255be5c8ed95eb11019a505130666d998457b93390c84138e6168ea17b8ffa2f0a7e95320650ed24ddf7090afa262cd997344a39a87c9201aaf475880c1ae1c1adc7a9ffaa8c312f0b3af762d85a1f1cba8f627af3b67876f61bf2baa86d0d0e4dddcc784a61424172886c9b75a304cccff3966273189b86ac027cc2f99004d755ce688918840826e49943d5c382a1f3d849c0a7a80a26a5e21ef14a2103de43ac2ce0c97fb98cedb426465122eaeca3c69087706fbfae90bb94f524a4f00755b230897407e27f5ef53932c389baef6e58887562579446d1fe9a5116687530ee611c53c0f64b0f970bc735c4c39a1e50e52c6beb73b28cb5a8cf6f79df44581e9618a5dc043ba0067e8f4e983844e7edf393f456f2cd9bbf5a239c17387976f30ea989f06d36b193a4d22841309fb02b356e27314fb741ccaf9c11456becd2a5e7d1dc3a6175f50fdd53d24843e161e0ea35d33c1b1af979c87810d29bc93950f1507bc6ddd884da434228ecf414dd6baa0f2e2988e2b5f71be9a79b72f5faf27b61062cdd78ce9bdcc2962cae8a5ff5d25b17622dae6873e2a60f5478f8c7afbf867acb492ebddba10bb205e100f28da67ba2a0e4f9cffc749e3a2af14a29fad99cfd2145ade4bca69538b7a3a5d6522a7288cb74525f9466570d1bf7e610910bb548bef4848a7b7340bf2ba1f8285c81f6a6991b5d53484e4c3f11cbee7b9a32589b12a61503775b96444ff73c2106dd6b6a56ec2b9151a1dbc2e7a46819f4edfeeea178a6ae8fcb9f570e78b7bf05197687695322e5563d915940bb674e0453af44e033c8590689845e37cd417cefbca4978f12f598d13a93806b94dec53c615b74c1aee26bd2cdc4603dd6027e1d637d82cbabc33763104b7ca32b35662ff218b3e45eb074ed3715e341643b8c5a30bbef5e747155d087e5e0eda3b41dc5090c07df4f8bec154a0de4683306b5d69d2fb5f25b759a35c7c0226bb88d9f6bed5ab87d9eff483990763e89d089a7f49027bc51259961421818fb1d8146d73e7c7b473a4e482d1538db38320aa12017d3e272423ecc286a74bf802fdad54e7f081499ec5d1558b695cb49b478f74c01d400a535314c51b2106abe5e78800b50a77f674ac97cd3550818c49a8e2f81887af83c1b231a2b0a2a7738ff31d06b7e0a2bf7bdeb25e0595563ee873a4ab7dcf6124fb45b6af3cea4b0c9526f755f17be2e51dda024e27c4f249c0ae203192ebd6fec4381c0cb13c27de81ae2edbd6c1fa164a8cb0f9bd55bbe96a93fac2cbc77033857929a996bbcd2e4d47e4ab1516fcf1326b15c35a90701d5a3efef60c10ac19355d76b913ef802d58e38b4d3fba61989b35d087630377944ec9a1f94e01f80588853cb1ba05f9c9311aa419325282f39c383c08429311f974aa692580b2afd71887958c5e3896f204d75ad6ba2facc59f2643026e7460ab3b33dde2f0203fc2336e8c7dedcb018a26f64214e54e7a50c82ef68c990c31af8eababaa45c5a877cd91e5d90aa0849cff1d5e0da34533c121ccdf19a45cc620d7e03db50f3272eccd59673f150a9b4f40b2711d31144c6631979f7cc0cd5fc784aff1158115db434873b2c564d2ee5339605c240598d7b9830d713bcfb700010b0d5471549e90a7c130825a8ad68cadb7b3fb5dd5a196d0ec33d8e19487aebd1dc953ad4787147c9e71b2a50025b2d73ec6f4fb8ab5274ecc6ae7d0e659a3318f556085ee6dcdd75f36f6d3d9b8a66ea240449bb36b3a804f2f539f9f07808ab4b1a16f16447600f9251c1d810705a38faefe5c95c92f8bdc847dcc640c79f2a5e14af4cda28e599f29c7d8999c72ac7320c96b224a1ff110e8b66ac22c1e8782642e8d5605b5be322f33d8a5f5775cffa75880f454adc9a98ce5e729499dcd189cabcbd29ca51908582f569021ee7cc7144a913a0ac9626927b0d3f46987184bfab4250a868f2c1131bdfcce996431591a9db11a8c9ef88eb485bb5763f06283824c8270773b900e5cfe6690341a2bbf1aa379b9217bd0e8b11283d69082029a34cb90e2e208a6afb9a2218d49a94021d0711f82d6993e275aad9881e4873327167e80505e975d98ef7434334def461c550ae61001594129f485eb5ab9cef392d60304d8aba95fe5f3db0e062313bfe349e0a02fb751fe88f8f6b73de8341a46d206bdfc5ec628ad2d7197ef846cba851e83a5cf5cbdefafc07b9869bad4c9164b41244ae8e246dd680d85cc454af8d44711b93c61f1ed0493f2e86c495a07f1ae66e65e3c07dd441775c9c82e6abfe60d1e637c771207eab851f1fd816c76035dd97cc1de3feba5c643bfeffc62b3031181b3e1f8074e889e320a9a8b2270a0f00b90547e28636e101fff7b2e3054480d5ce27c54a88a3d59900d756c19ca80186ec9eb0c5a1e4751ea78b07dd1dd65fa231c7ae1c449f005b1036e17f09cf9066e4e25786a8b693b9227ef15cc6570a4599a6c7c2f94e872ed9ac41b8fe6df8f40ffcce7c4c859bb3da714ca56b817da1ed739af0b8242d10e5be4d41ac7bcb37d7040a3e00acea787b73393f2cf4d195b7b7f938dc5fc6f1747d0d8935392ed8b851b08944f021f0931d0bc7ca559a9c19ecb9ad47fb5eeb3ae6cb0d48d3c9557e06b9eac9485ff3d90e58fbafb9aeef5cdbda0ce8a2e3dc05fc80a7f09c4dc742d0cf6a8d4dccb0fd5d5c67f44e9fbdc8297849d591c73549d17267cd9e388bdd7e1bcb26bbf064868fcc78236de0587b8cac4b6f05aa8100d6810eb84c42cc0bda503d4f73699fbdbc0ebcd47c969c2acf5db9eadb27e2cd597df9582000a1b22a7c7f73ea72bb2b4f2cae27f4b6f2866025663845ecc3449984e8d95ef780c00e88842874b07e01adb9d2002b810ad3bb893db24d0e7c9f1f91938ae0dcdd362c0bff2e460eebc98b715546078cb3269e6d0a0849b27b24955b7027d586ea89b4e5c51e1b32d787911a1a6494f36d64658640eec8c138288215ee09f686d3c45abbeadad66a6e1116717e0014979f766469cb7ff0da3ad0fc0ae0b6a0a7032f3b97183f05554718c9033b1b21173164316a726b3893e60fcd5d082f5530f6f58218f3e5cd6eb85065c2b6d2686498f829fb98d7ebca7a6a100e03833041e86015e0d3ab7bb654edca5762213262778fb4ed496e0fc3bcd7b4232dd66aaf12bce8a0cd03d32f798d8be3415e976fa30dbf20f3855c965e2d25106dd54f8232aa2e0e01409df0bffdc7ba3d1c28a407047b0858bd4b73a250b4cdf5b20197292ca244d404fbb0f2467bbea49903d47c7b003ea5ebe4aea6d42af0fe30f336b5bc462a6d09d21a84eea985af21e3cd1fefbc19e844c4292066947965a2ca3e13e9020104679d0ce00123ec8d9cef4b54d6acaa5428bdeca5d350739af95f80f6037c2ce56d604b5e437ab5c4efcf7806bb8e3dd8af1220331383a64688e506841f17a0c97e03617810d766274d094074caf785029de893c233786b5a4edb80b2c894a22d0b3f9a9ef0cd3e4a0cafefadb21c7758191804065e6ae311e4ac4be4f77cb982d79ae4c57bd9af34a131f37c510a48d3f7ab5f9061d538c16b301d2d24a1c1ec8824279eb00926009d6623c4a7fb32d31feda9656639188c2bb20e4030aaf141ced5ffdbd41431af72063089517f537a9a3f6ba55b1bb9a0e84e4ad01b039fa9b158373499b6e2cbae811dce4fe9ba43636b51701cf8b28c01d6c88f3adee4c7ee75a6e4dcb6b6899dad772a1f0657b5648b0c98d6c987e557de3cb5c6bd1c293d98758af0df43e46ed7d66a3d202d8d82d9ba9181a1b4052c687933729f65009ac331ce62d7ab98b38e0f05afb5df250a41310b37a985fbe1c903dec779fe5b08333f6800e00ef5749c800b65223360d37f84e0deda747e7108337f04b71546b19ebc3def0e62ae6792437277f25c791532235d4b264f36d97a11a7b9fddd05583604e574388b24319817e6af57d89540c4218dab32d21b2ef6f4fbc999d4a3ae65500e675d9bd336badfc20563fda53b78b95eec05df982dd1456918c40ae1b1768515b3228f96abdb2ddc077b32df47d2271a59344b48e4a10dcbf5f117c127111da58b5c75fc9ddf46650b7cdd79501c6159ddbd1acc6a90dd5176df18303b1c0a55beb66754dbe132f242a58f15fd863e084342fbbc8668f2e05762951ad05f5f61bc1eebf0c895b0bd5ed9cbf6b150928d0cfc33eb4250c0df7ed866c89b9ae03cffa8ce593240f48dac2ab91dea843205dde8a2c1bcdd8208b34f4892f73cf5ee3cf317fb0d195c77a4815d2d4c8e48cc48a174438ca553ab76ca7f5134608d60cfd073bdb9c4c3f4c54d10a4bbf5e4579da146a22d888cfb0be824bbcaf3fd33d6ccc9cf1656eab8d15482cab71e7ebc50755e5889319d03b564636782f9fba9dd800526682f55465c04f9f42abc68ce20c8153fe07043ac1ae52432b0042a56f8305ac0e56000e052b7d510e8327ea8c1df890167874b0aabbf3fd460797c84ba944624dc4f7ca6bbca1218149ddb741a14d972ca914ecf1ec518a91e4b531d2dd38d5a07a35a4ab4476b774f284fb5bd020d82626d11546f38111d1151b57467a386dd69a8c287c9df648ecf76149214e966d08f2b7a528861b91c2fa98a4ab0e8307a66ea6bffecbce9fd0e71c150e483183ec487c98494b2f64603a4ed04dde60fb0fcdb983c440634625b30a48eb289242bca2c93532aa2dba0bd179662283d0a2c894d2a866041a6bff1f0230875d796149373916f154baa1d87406b96e41ffde9199421bbfe6ce5c41a1319b145adc4d5f3c29c5450153a63803b5fabcc1af54c90ff066625dd539fcb5504d092ec503ab96c6a8b235338dd3bc2e4b64bdad0cc9ed2c253016ae9a286aba1dde4c4a3dc92c80efe63519ec73941c36081c1f7ae802ed3a51094ed5657e4832ef85901c36d566caa56206be9778d9219c35611a9c130007c8872dee76139a42cec41b9838c04a0b238b9bef6ffbca8f649b2406fd950457a0da1f97dfd41de913d59bddaccf65c83c4efc7e5e69fda60ad7cb1605adacce8a89e5f70f0e7b4b61063c9152b6aff4af481ae45cc0f3faf97975746f24c03aaffe1054c146cb8ef4760477e4f4fcdf265c533e6c8b2e6b67383ffa2a47ee84d95e11cdb2fb910d70fb6784a72c40fe6eaf9d319b5b4044e13e9a393a6490badd266b0663071e091a5b93f5304764bf65fbb07148d317f9659107ce79d9077c20d12513674ba097f480252df68874ca53bd886c83b6311753b3a36942d77e25c5a4e9aa0c510828d3b2515c7791d21eaa0df24991311b2c0d8b92a430402326a607dd7a2ff2f50ff3155cb1133a3b6c64e90475c75ee21688fed9cc276c3f0996f8afb5dc2ec1cdb969b6ded7b355f7de4f58512f2bbaecf1b3b26c9e1e5265d219f0948f13823f0c83c5682cfb4fdefe3d240de46efe0be7f1c68e4657bfd9f8666875f5cc2f308b8a23f374d12cf0e1420996aed0253d401cfb50f6c4d254a30938695f1ac2f1833d0f68d55c19ab62f8c0be0b3bafddc8315e8a9eae35922737470d550bd88a500f86d3cbb40977ab4197fb736366681e2941b680b455e2722412f2e5d8a98464f53945cf072e2afe724a67fd8366659a40dcb567ab2d0cb420da28d7af0c5d89063376438c6b7b5d73e6dc5cd48a71d5005179ebaa03db241685341aeb00e64f3d564b08d8e0bc999c3265bc30f04b4aa2a8f0a3727fbbb80ff94b13cd234c7f2ae3a11d69cdb6995a8de25fdb379754b8bbff20a0de203a7b9c85c4eb4b4375eb9ebfa29aa48f32c5d896048c9e19860e11acc169ceb0a35c5641739609b77b4ecbe01a24caa32d718ad8d29503ef6e4d860e924785be7e9d54209b104b673a99a87352036dcdf14451afeeb37ee72eddbeeb597b47c5c6434d73be42c01d06b10c27d20d3c26200be8641dc3dea5e358cd24bacd863be5e95792a9cafc342f9992c20edd3b92433b2815d3ed4f7997075deff2acd18bb8cfd86c6ea9bb1359ae9df22ab97f199c908d6d6218f53acc176bd10f788a3084951a557db8f37446ab3cfc38023f509a90e81762ecdab9235f4fd9d64208a69562ec0c426f1cd3a3bd3e057b4b2401ed09ca5ea0e831c9919c8d900fc27aa2cf953491cefd35323a562c40de699209984766a805fc7589246ab04f1ecc96e253765399999bd9f3571dc5a4a29de256edc8506afeede7216505d79f972c952cf24ac9cc84b7236eba1e3c233b9cab66b97f98ed07fb7463ce83eff8a98048a3f276330b0d9141fd08e95fc48ac50307f4700768d0ff6244e995a051b61fa8b655519168d76e153e400c3456ba420d33c27ace508959b703f5a5eef439befc0987bba0df36b6bb6439891fc6f9b97c39de22dd5d9847e04ed280bb4bbcbde98f96215882376592626648f92097d349df92d710702453c53cd0972ee4f9f4e05d05d9c8da0c260deb5d8c56c519a25dc411d310b51d96a9161889f28fb7285bf929fbf401c149f15d701bcc16e8449683d3317fad01880c95dd51acd391861e2be5ed4c8a976b32f4fb889c27263ac2e73ff31a95474d11f3383ecd6484654f4d76a00aac3a53c7d05dbd406b88c6dafdd41dc0609b8879dcd7637634e725c90670b8b7500a91e211f9e2716088f2b0251c23c86fa2665d1c5517355ee6bc34c0e3bec8f8f200a407d7d23be33641d3f3d252ca52be34d1532c3707fa945d69a35ef7835405b597fbc46e8ccd4a4528228b69e8379b41f5d2ca07be862126f89c9c77d4dcb86d5fa5bbe350ea3c8a40d2488c87e3f59b9c52f25ce9400e2b1b8cc8c93d54a2e48fc0f6b1e3b9fed1de288fc0c20e28c0f323659708c5a84e4318780f6db919683713e4f97f6f95c05443d018647970aeba8b50b89a44c126e0f6df78cc4a83954993f6890d4f95bf64b282b5785c7a8ad3b97ebd1e05cfd3b88e0e7e821ab565323ef574ade87b3ec5b0136c7c27e59946d3fdeff5b2332535b6026a5d875e22060c36f9c1d8580230e5926e339c45116596e3b664c0ae651142b25c301ff4af7222c3cdd44b958bc5dc9f1e0579ed85aac2226f557defb3cc4386c366ef26c779bd5caf24ca1064cc9aa79c449e6cdd44a7209ff7e8545e1fa539bcaf29cee693beab189febe2b73e7d9d68ef9d88c549b1fc02762cbe7a3d857d847ef5a39af343799049c1ca87413a1aa9cd402db39678f761ddb500514aac64a5bc6f1c9bc0051c104a2b838676806d1a771c57a7d3a4373d248fd895d085c36d70831a1c0d57d1841fd11dc65f462f205cb98a0b2f34916a1e9eeff7c2d28b4f49fecf4950cd754118a5f4b463c96adfbdf433215c9601f8f4528e144480039fd39455b6c4c18909aceb957b95d18196150e3e13124029d14fac85d2d83e80a0791d71cff47fe5b04f0398c1f4b78217659a7daeb10f4574d247cd9dfe082943a3e0933bf1a1ec4a7b9af0d8f23a4ae78cecd19f96c36339205f7b36a260399cf755af219fbd79ef98ff23a12362095d8695370fee41fb714cdfb83a2358c55ed1722e4fff558c060c270b710a4acbc2ef9f02e6ba560161433ff9cd1ee0ea1bb6b06184087ce6fb95aba1b8ef9eb3b62fb1117c730fb829e6f062408acfce179443498a7cd60d2f917dcb95d87a4f794f2894fb49dfbe290ee97842603075aa0ce045e0403b098bc0cede0994f4ccfab31cdda4a2a684d9c7fbdd2468c83b626deb54bb267c645f0e1a186ed8d249f7678474e23de8a33281d8a8d3d6645d2a8671f627488e7492e198d38c0b23a6725934ae21afc027756337a1440753dc73b85974411f2c861e0e8efc44a27b8bc99bcf35699b207f078b0aad3939b777e2e196ad865001cb9f88e270c7eabfa6565fbc6949ee84a0a76052a13d891cfc47d4040816fd5e4abe59274904cea6a005d5aabaafe0c504cc8b06beb4c83aacb301978a9c25e80f08f9a64f6cc288ce4fce81a8af646d4f1129a88e45e931c3e0964a12a3aa404607408c0d544ccbb48dcb9df6bf165f65eda199157d11d07fdbce040094eab0a812d1de36f809fa9e2d67e25aa6b80e7a31ca9fd8d86fc9ab768d0552139a8ebbe72138db7a0b1bd2ab600f5ad9747eca806e4b1ab7e1ff645c2dcd83a55d1587fc6885f1bdcc29c157373656dad10130e47a514ca45b2c8aff4b338e7188c043446bc27b3b62c8e845c3bf07474897054ac073cd5513d02e4eb7649d36696cd920a0dd3f79464c98efb16b5b27c5ad0ad2fce324e5952c560fd2c790570f81c347c2106b628854ec3af8134fc7630713e7dd8ce309aab01c28ef37a7aa01af194ee4474ad9d1c3c5e20f8561c1a6e1687d63743f44e82d0de856920a85714eeffd24aaf7eb9846f9f9a8d3b73dc35935754fbd025419cdc1302592154d76d01e97c52fb0a4b1040863a8754cda321fed378c67357e87296c529ca5654d06c82c1afef62d9ab54560fc10f65bfe320f3cdedfe62a132126e78dda6aae99d7985869261e2815ba4c3439a210927ca60e9322ebb6669f85ff4491d3e917e6f1fd9481d8c2dca684f3f03b370eb6b62f6cc67e33ac3589c0c45cf7374fe44f7d0bb82775a86d644998c86292de42c31df51905559cd69d45d613ee3e9c4d9f9285936f65bc766c8162b5df3de85cd1dd046faa99358d7f3b5daa9a90b9b1a281b1cdb9856af8f5f46572bba85f48889852f467646a0d37ea85c07c683769e819b73a3fd653941f99dcb603ae75d57badefa34d588028ee64e6505a8151a5a042cad9c520e508ce94ed0681f24422eb44d6a8f6899375f64101f7472bfb4d02c6de1b4f6123d8623891cfbd9c204ea69ae33d57e1da272e643e447088400da7c27c0ce51c26cd7510b68f7b94ec4b511dda0af0be3b9ee4b0b6c762b0b30a025291083532d26491b1147cc0071f281f33b1a04bdac56fa7bc568f9e8b2b280b4525d1cd29f6c743f330982274135d59d309f3e99f1e30b3f4a4b44b855f63fa1eed161159c1218d301751674b00f0640381b2d8a306474041b182174f71ff075e53081c7b5ac25685a7cab5fa73ff6b228f55520ecb0516a635c1fd1c0a3905c7b861c815c2a12098bc2ba1816d126557d71819002244ff75ba30b561771e81fc668d8265ac27589971ea9ba9f89a3c0dce50dd40de99da0ac50a59ed9c955bb8c74c819937957ca05eb7e278fb5d4549c9dfa73e861d310c1812fc919e60e7b415769a49bc20bb9be1096c1c404d2550d36044997f388df71fd8ec1b5a4a4d4d4be9c7e1a18a3901788376589d7d1294e8378e6a88ece0afb4a5fa81deb374d2057a9f398247c08532ce1c31f35691420a6191ff726a10f0f4defdfdbfae3e0cd8b6b228b5b235a14e32347e437e44b997e550ec56b82e7b1bd9ef826148c5eea13ac5f44789741ae45a2d82e47feab709845f4dbc1f0f9f26e95b07fd6951b1be119b5d7c7d670ea736c5d33af2fbeb3a9e0c7f4eb610d4409d8d3c60741271f946a98caa756cfb0697f7a4c93ae1c8389144ac321e2e1d2d3ff9f2583c80efa34f770f5ce7c7705d977b8b75d7504ce18aeac5a04caa7b8eeb7a8db0f61d091ec713295de562a2baaa36e2fefbe379f55f9d24cded6cbe924e0b5400d49c114b8ecacbf1f1ddafb60fd889ad0658832936730b101e4340dd1f0b85158e200870b262f655a5a6752fde4a38a2752c72f8d454f7c4d46330d680ec600bdeaa3291b55a3fbf339af94270a4cd57aa113cc83993eb490d6f4971f1c3d1813b994e605c390369d52e6a96a3ee293c65f33bfc3bca05c4edac548128b9b5f7d353ef232de4c859f4ff0540768619f9b67378405d71991428d5c7f25b90b2203abd44012d442341c61395130dd4bcf0061d1f1e0d289aa54edd058d6f91941b79fbb1372f016c2019ced081d4b3d235ba41939a3aa99cef282704e630b7aa7e3dcb4a96310e17979d6ab9baa6cd2e40dcf4b071cb563e29f71c0121e0915d800e27572f7fdde379ff42115cc42c0fa679beff4d424795230f16aa824362f390882f6b4755b20a538d419164431bd4b65c5ff11969a08dd2dea24e0c0a34a1fc97eb109eb1c0c39997eab76ad5a3d7c847de86a7a56e7b07a951b49b4b417e9d4d4a95a8ff14a8709034f2371607fbd7d26896ef3bf23fabfd0e3c2e57829a9137b8f9e3aabfd5e6cd062dc308babf772f059f38cc24ae2f6fedca66b6d326fd3f1b2aef6b7b2cacee12ab97ddac36cb9856ef672b471bd7266e6409e54a89cb8e5acae9eb6ecc92dbbc07b0a74cc1662936c6d31bb1ba17b61a88c3f5dc0cb2cead03bc789d3a049d9245b9a2dbe9a53f376bf9cc888c894fc5c7d899107672fe5c1536e77c83e3372047740a2c398a9a1be7405a6c5220ddd5065fffa423e697ecad5772409a2d309a65fae96cafec6024e8b20a30f33e3b053edb8271ef2837a06ab26d3ff3fd88e77bc5f70a8dcb499fcacae3740996aeb5d4e99309fed3246732134ac5b22189f3066f6400901a3293d1a873b7ed879fc43182c8810e21a383d1097bde7dc6faad7457dbca99b69333537f53a3351b9bfbb903719db5181d27392ccb9b9f64cfa657cdaa4047595b68b263758a67c5912ee2a31c8d3eff22de593171671257b7a6e6b7678456d5ff86867d63a54984b43c638cbd00c55ca14cb3369efae92efb14e54729c31f5dccfffe3cfaf615dbf91eee390e7d099a6745f3a47298c742ed244aa9682227e21abe14707729c2d17510f83e0775d3996c208ed09155f7621cb8aed1c3e8d6804bd011b588291aca15c934e82354cb01d0ba428b824ac788cc448b7cbe154c007d342bf82db19f3368af3359e6db4bbc5d4027e46da87ffe49c6ea74a716a60cfc9301ff0b2859c9117e75188d2ab09bc2f0df3236306211bf2d3197de5d2015d917d741fc81edf183dd8148034c61832eb3343e4e129a90934f3d75bd60997f5218f0677fdadff065dc9b26a03a4faa004312726d4594dfcb97fb33c96a24d176a720446917bd060f3772834993c9326c548925be3f803431a03663bc1ad5b2f5e147cf7acf8031e3c5483e82c7ed1485a82ce67ba11aea449b1c6908a7fc01631ff4740032fa3ec49cf831476fc9eaf350681de114422e68b04fcabf6505085f53ad2d43a56f1337037fee72ca4ace45e751b87e3b34c9dfd5b78471322030e3802860622829e1e55bf292b236e6f073a0b578b86caf55e48ababda50d717c1767322618bd202bb77e7d75922233970f86c212208592d058e359e321d2bbed2ed32aa4061e1293a16cf03e0dc0d69aed1db3135788f9eb0bd9aa3148de1d1f982c60a93170b93a410dee3bcd9c80e245ea6b20d00c0c3541e7c9bff6af2537538fa71c361ab30d05fe74af72cb85fe10939b8424debd8475cfb6f4b15150f1326b11502e2e331aad4cb63ee1ef17a48c924e44a070b8bbd8191f731a1355039cba0f46fc9ed683d398c68cc7fbbc5f4a86798454ffbe5ed68f9f89c32a3cd60234581aecd0666cf687d01df5bfd36192332efc21ab60b1e5e498d20b0c7e33f552715fb10814be1aab6535b7c72630176cd31420b3ccfcea919cce85ede3cb9ce6ed929f2b24cfc1c09bb0118dd132cc26e5557ac70083bc01b4102c6a0ffea93e1c265ca120b286b83c23a4f7f9e4a518348d694c17f2b7c50904c3c476245cc3ca4fe0d4a4ae791f3d95a8b5f34346c080570f7b13519b16f0c71299e3f0a36b18c86e3148fcc9706f867838b68346d35976caadb0694a7672add27dbf1c377fb4b3a5c037c6ccdc3f9c54c942e0843ad22e51d8f062b89e917958ed2cd46f5451a740ef2d4c0de959909933d0c24f7da1ee3361743a4898fb02ff7bf850030bf9821eceb220548be6f7829299cd54626cd4e0921bf6c6fea694d5dc4c9e553b052fdfa0c87adccd670a9d01af7a62f19bedee689100d6c9281e00f41b1762df4f60c4e8e6cea3a2aa4384f9eeb3ef31a6084c4fb89a3e002e4c54bd650794ad2f29be6beb21df925ae173aa82639329163bf5db30568aca2ac9487cd01355c346e533716e0ce7ef824d431c7fed33ad4ac69686d52f511c4961785c346869c54409d2d96d6677fc1b92a1cdf0d9ac07c6727d2d274caa4f1efaabefe6314836a661c1d7ad8c37179513f12d48db9fa21997468156720c962867abfc491fe1a29843c14d967559e22e4d4675dab38a95e4d9f31a1cc86c2b156c4cc6b299845271b423f03fae2b465dc4a414aa7acab85bc29c1ccebbd8b3f6813ecbd8f742aaaf312b5f4c787fab27e14c8d04604aff56c4e11619f6f31277e2e34f4325d95a608575afb82f0ca925c34110b5f8007c4862fc865088d27f865464b592633690318bec67b6025ab726a55b3e8445f3e0d7cb1df7dd5e747665ad9fcd5edda762ad3b89b09f9c0e069737b2c660ce7482b7f31ae43422638d648d477e04a553bf4aa23c6907c647c00cd292904e8c159896bf46daa5d7c6003923b14909da46384739d4fcd19fd2458203ea8c72273e9f3f907c1d69131fd43c0ae1210e826442d8c10d5b2e667882307e77eb842fb1c944c1c05dd23ec2a943ac374022f90ed6c523a947c2dc897dfaaf2bfbb2ac932174ee838b7bf5f8729da55a0f2199436eb585884c269cb979d4a9fd7e7f586bc8a025a7be81fa7bc8de5dc932ae40bc148eeaaa07c192e6d8e01ca0e0c8a5f32231e6ba0c9bfaf3199162bb794ac753359dccb3de5bca5e46dd7ab8deae048a31c0c42c3c52624e11e3c754dafc9146e8a7d119b4ae53c99df9e34bdcffd9d9c987c2086c8dc3be2c0298f25603ad3c67b6310df02dfe842e4b882dc47ca3036aa959381cabe89be61f9644e1b317d4c2245a37737048e657cd3e4a6f1f3644a322c53cb6f8599c8af21287b9626b5b224fb72f5118cbcc30461e06ded11d0063ad065cd5879daac5fb92e52360a8d8c964b0fecd989922a3ad6be58c28188e34804e772cd9273c9308aa96875f508cda150ca2bc1aa78ef080c4e2bdf24ea9bcceef02055f4f5a44954897ae25d87ea74dd4ba0c6a3f8c2dfb49e450aeed82faa734f99910c351679706e08536192743fc565fa5400ee41c4bcf89afe90bc817934990b5f7eb91ea8e4585223fd1db3309f15a55006025a0c0d3865f41a70b81f0cf3f677b2633ac3f0bff03d0e5872f0daccab8462171537a402f66900ee69a36158acbdfa9c3c4166a8f4aeb20b9d7a79e5570845e6a3b4742890ac3cd35cf7205a40cac46f55af511da751dee6530b265c41cae3e810098d75fbb2dbed743f792a9232a88bb75b028a172252ba4b51e1f5fd7bcae7648356505c0917b7c77e7651c8e0df04f07f9d717ebee2953db417d87f99a033655cb752164ebf68c3e860a244c00b0391ae4f08f1e65627eacac062b3cde8a0739068b0b9f0aaaf3762d1925af7d601b27ffcf814bc1ca0d313fd97bdd8c9fa7be9252008364e2882cf8e9dff7b5d3c74324346950e8ccf5d94f24357679f25a1a645d9c3f60e7e566ecbbc75fe01f636468484661d6ad7cb50f53abbc0ff0d3a9626d1cc31cbf643d5de8421d4fac3869e2caadb34e2bd413530002a9bb017e33c9540f68c0b28e42d7b1e36a133c0e1f0b6c14085f9e807b3408de989efed20db821ee3cbac7b7e068fd26aeb7c58cb0b28b6a73cc8fd39b03a6643bc17b7befb643c3aa72c0940d6eddc4dcd720ab648ed3a1325fcb537e1ea36a8af1d29e69e9cd5cd6bec683478181e1d02c20b53e56eea9a7f71013eafc43118d54c1f1073003f6ed77a0b00a30124491a67813bfbc1d1a28946c7088f20aa9cc2414fa44974fb3c665523e3ad9fa77a9d2f390c820c6dbba37e23e3339f884c3110ef6a629da5d70beadc56070619c926c5ad2df6020b4711fdd77785fb220b7b148c1b8694671b27d342fec7cdf9675ce27c9e9c249b4e9b6c28ebc7e5c2621fc9b477f48ea5f335615e554d01f0a3c726b96b7a7696b613e9f0d48e65fd9a4ef765932a504162eecb6fa0e4fae483aa13e818816c6826b7a1d43d2246b4165572a4cbdb4b107ce2f0c12957806a9d288e46313c67b711a2cb4d38a5eb575a25912199ff90fde169ec2b3be0c150e0d49ba3a941f921a3416e141d9219be44ae935fe1efc876d1f5cc27d13811381d87a56065b018494535a8ced3b3520bf9261e680288559115cdbfe185a84f335404dfc8ea7eb0980ea68bf5a444179a1a4eb441de2e04f471f1f979c9e2e29178369b76260f8dedf0832ebb46da88dac8ae25b7a08fe401c31c76d898697c0a8062fccebde402d7596cc17b3c688d3fdeb43562ce7abb7b6e9494b17a686e2380f014be2ef9eeb108583daaf0788690c91c726f5b37acfbedef4192a212ac4879449ce7c22bbf23d51459312930d59f10ea33146a8cdb53d2358f5fc05631e569c6688b57ee023980f5eb6ba299b3ff12ef6f70de94f93373d0da144b7b87b3fd1c96251e30857c2d1db863a1791dd1b5f9b97a2b80f7a1b14f05f574049b6e529b662e323b2fbae72f95b0da2106f89e5998827033103dba050442c15bc777aef240ee4cdbf8c79f154a740284e96ce37dbc33c9883eac2b80a15a89d37ea07dd3485f103443f3b6bcb01f729ec9b5ab7256444c7bbf008b6b92298ab0a310e1b4b6b7f7f5e2c58f3ef3754cc4cb1546c46df0179b2963d4040771c008a292507b9554652f9b07f986efb6f039594e10925f478a8c1483cdb2721f32f78fe9775a040a31c870694c7171610d896bcd5fe7afc49e8c00019d5422383a6a19c7e1843a0f86f3e03572258168084a9d295ebeb3e3c765c4da6c496dc91da38bcc25c0a0aeb7651d6ce5fbed256b56f76570f1812994023a6fdfdc7501197a79989e26e836281e12b4acfa81ac1b298cbf497a520eaeea433d7ae14ab47888cb12f0e09bec5d44d10617b5f2e914a79aeca89df24297b7a7f8fbd5e837744794779f14d44b5892ecc6a8cdc2835224d9f3a18301e4cbc4045b150c2fb3610c90c3a3ccf5fe5ea39374343d939c58f19a58c721cc51abc74fbcdabc6d3721dd4ee612f16781dae4e81231b02a1397ecff9bba4c3b15af817dda40b66a0d7147c5fac3e19bb543179601cb5002de84e8cebce41cc1d7292c43688ff9977e8dd89b44015cb8cc3a7e439df7a4f09b95390f3243672b2ddd817bebff497794b3e6edc4653bb32f0a2023a91a1ba91e68e7bbfc595721039242dea5687af0a07d646d41b342f0aa31eafb46d137c4d3e47707e956ccff1e77ee7595c34794fd5f65d0d619476c4a60fffa1b9eaa0d05454a587b18b767fd66f5746697f973d7bc48305657fb92a0e8eef6200b2c49e9efbc9368a90dbaa6dc3b02f7f9911d5236b9a5322b878797915be166c6d88351c1366c28b66371107e6c1e2014da2028d6c0b56e1ef9522804349811e93264f71992b6fc9949182fa5916d419f55f202a59ab7f97af8ac63375f09c1e2131dba39facec2f2a40f5a01967880b2770ec88a4a589855af90efe6eb56d70d628cbfdc5ab419ae4ae82bd8525d891c4b988ae2816fd172e70ba6f7849935cb37f11cd271d62f5c5a383e698d6160f858fc5dc536f4647e91c1cdb723cd914da2d40d580d5d4ee6ff208241479b82fb079c85d81e7ed3fd67b52cecbefff63c2f50e30c2536564a4daf659d768cd256a15918f680a009d0f147a9aef2fc844c1f9820f8ed8ea2aa33adf350755073ba261529eb704ad1c11ecd40487b10e49c8cb5c94aa9eeb83a7205674574a9133515a5b8233fd8f361b70e669d7333571b0cb46105405005ad6e02fc5f29bf15a364fb2c33c067fc2337cf426ef578f9e2632e7aa74b06b4c402ccf1383913101638bff9d8db53aeaf4fcf0a2897f3070aaa9b26f38a38684c39490ff828862bb5c46df4f22cf11e95f1cf67f6752d7d8a982401f80e183746ed3bec866736c1e048b42e5f2054472cf1a5b90c53db585a118fa3422e8c288008058454002d84f0b9b35a9e1d1c1805c8a9b47522e3d291b7d21c1a65ccc88f9a0e319d5fc4195e83950dd0410f34e6b5d42e914a6a6a5b4119e55062bb62f710993ede4e66abfc6020d9d19df9d20ebed3260d5dbe78466201ad7c1976c28a294938c30c26b91ea304a345e2fc0ef4576a2e88eebaa52541a037f01509f37d33fd806407fbdbf2d5df5e40ab5df210b43c13abd67b43c3460603adef659fd9e664819151b02dfc4ec0b3589df74f1c9778230e80f37209791d3254a5f2f8880ad78977f48aa8a3675a71098071f598d497bcabd33ac4c4e335517c96aa1655548b045dab4294c9d8527be8ff76b670668f9c0d7e2a3391c4c2b4fb0b1c387db9fd35cb811ace774472fc0c1be60a338716a40544485b8ea0335d0312efae0cbbddd4c1a4e5aca281f19aada39a9f0daa74f940aa7374c18e192b32df39825388496ea3f263eb5933dad13c30f742b746900f4e8a734df146e7740fecb141e8266e986c2bcf674b32a4987d52888ecb81da09ddfa4df0c11123ef7e94dd7dcf835ee5491e4743b9678012629a590dae8d91f73954092a2700757207afaa16e4f52ab3e334228fe76cc82839d9c5888fd79a78a21e29af803bce11443f9667ca4060d071e08a57d315ed1d7100cda0d4d48d826dcee3d84f8c9a07c6904a43441d37cad4be718733d4dadd98bc246d9c389737966ae551c98330e39c8dc6001a9326821e826a50cd0f2f3e3377decc300984ae265bd11dfc05bd5f38de905808fd6611e3d79d3e6946d36b9502ed9e3782ee638eae2824aa95f048d358c93663b7290524b5e02073acc331e003ce6105afbace5be36f3a9cecf84e436b114ed4fbc5af3dffc2015dd9fcf02ea82bf63c97afaa5acb3bbce86e9ead9dc7cd70f76c29909df2d913d1051075f271e734060605bad349cceb9c934505f59d4687bbed9fa0ebda0458d3ec5101f3bf86da0e44da9aeef3827426e790a5c9b33dfdcb7ff76a8fa3ed53a531a55822080e0674d8c38ac5afcbfb74bed10ad1a29385dc297ac43c1db2c81ed57110bb8df440d2e59d4c55f0c6e9620f1909697d355c1ed396da733c6d6482d68af49306d354d9b483e3c873a0d8640d30208e40ca630118959c5f8009d72933df2886c5841e7778492e580d20cf95e6da21aa581fa9227c2feb7c8844813b910de928ee9bbe0ab9fae440510acc779743de827198397ead8167dc1461f8b4de97602b54b7eca342f023d20457c317aae31247503cb03648c9da37bf282f4fc12cff0fde04285ca2a99cf013740a0bdb91405af9e6f0152cce0f3f87475dfc9ecef3bfae77de56791a2a0b7d6906a2724b002af71aa1df644a561b6c2d5480cc314bb262fdb47683a9b99c41fd831964d02707d7d7c133ec739232b2d495fd6499b91d8ed8698174fb168b1cac540cbd00a17481f16c09a6edcdf8c21adb9724da9790a9a27b357f75d15a8b81cefc7221d5f84a96c2a196bda81d6b23a9719487b01cd030f76959bf62c4686dc1d59c8491f123aca41ed869a0d8375d0dc0aa35c7bdc8d9bb9e08c0dd34fca96bf1cc5230660e0be5f78b2bce1299abb49f3ba6890d72cec4893ab5a8227a20c6912893558910d7df19e2c39f34c6dd0f444f917b7954176843f2e8cdcd604384994eac6e703d2bfcbd114a0b659ee2618e125126ab483f0a398276fd0a25d9f7b1209450e7d1c9428ab1a70d62c97e7abb9a1555d464577e43bf1f46e7ab30dab33f7fab4723d49ac8f454a0a2e1d2f92ada15c3f831990a9f2d251954252f4a076c558e1a433d58396908df81c5b1f2b6a1e9f76b61a5cb4cfb0ed73b2bae67398bd6ab909aa8f79542f380c358fcddc630d6042c45701453c08c8562bb30a2c4c614d95cc38fa1c695ea1a30dfc0a71190bbec25d84c8555e065dcd52ccf7d9896b6fdbca7711d7caa0e714fbb948b0d6b0bff972dbc717c723e41f026b056c01efe0375540a3ea93ea6b1b14cf0fe300faba2727d118ed4d7f74f974c334aa558f2371481e12207b5f15c87ad19a7bce74602de0d4e1be4ff04c909d0371d86854aac3d83ed515a995f2445ea5555a59e2f26f40e70cfdaabd571826290884b42e08bdaf9ffc9ce3a770ea743f4d5fbc7b6c685e8b6cd6662aa75c8c63380695c2bdddf85755454d757bdf70595503a84bd1386a69919a7b8c8a6a46ab41b0330748900cc7517071783b74a844c886d4a9f8e48fc72384c161b6a83677f35bc515980a729b3bf5dfa4017991a42317ae5ca30eb7740fef325f4884be44d1787b5ba3cf0f092dc123739f3aa2f839a202854ee17738eb59571cdb4b39baa77328c66ce1cb9250dc4c376dd757d80b160667e47b1dce3b784297806c922475244ed48067d990b7c7fbdc843efedb835483621ccd4a16ab951ec1154d466a7d5e7dc1cc3ba84b82c9b3e25f7ad4a4d2ad75f29c77cf8baa763f4b20b6dcdd08bb9c75534986d6304843d7a41c2b5d48a7a9bee2c8b118e920c0dbee0d57d46d8730816848d0df6ec8c21493924fcf544b42f1f0ee97f2996ab1487badc070624064b91ccc2546b140a18875c151c25afd3e9748329e49da71c6c754bc081db280954940e26603d4bd3193d2f97ad68b83bb18cc03447285b4f1851d4888e26468240921093ac2bc105fc73aaa49cf65de7ed014a72d4c1cfd399dc403ba00c9b2151ebf017d75fedb8c5171268b72024f26eb3fdc699401b9b4ee3750c97ffdd0073a642d9b4ca6110f23236b90d89c150668247062ba53ac8d3efe05d6de8dde22aae0a9b8b68eee083a9b658ad8ba889db509ea8fad28c99c57bc2a690f20e1e5aaaeececd420036accb042a65952a9fb70613156e79becea482bcaf6d5dd241f608b62cf57d6612877e2077e2f80bd4d23449779f76ed10f0db88b840df968155e555fe3e4668193fcec5c98d52ebd25d603dce1013c95ba9cb62758e466ced4557c7d630be0ec9f9073801fe4108c0a9d02eb94c89d5f58c2fdfda1df4708dba6a1f36bf09bf4aabd3d11e0e3f86b279c1aa65085c5107b905093ee89902f1ae013fd89819f6737e674841caeaa5b762c43a386a346ab8cac92d313007343cdac2cbda031a75a6962ae9c8473465c1c107cca664f2e90486283cdcdb89f059712a825fc983346d99ae97bcb9e1bc27a1ff626c7ac04f57cb300967bca4b9b44545f230b3247cc37901e8f29bdefb78dd7a3b1ba396abc7e6b904e596d6e8470c40bbfe91c687b5f76e9eeececcabc9fcbf4827d138d6475023e6014f457fca44e34c7d5330f5b33523f04d25cf68e2744cedac8fd51f6ffb184e674b637e52111553f83d57f6ca0978c2e58cba41881b781aefc04624f4e585ed33d2313aef71e3d335efe7b4273570c5afd9b1fd725d6b07dd55af592a034b2658b3b8d868eca96e8302fc7cc86115cd8f4f8a54e9bce793e959b2fa2e9a47422038adb103ec22b2f49e4c43de88949a00fb3a6aa15c119a313c61549b65f0f6d869495b058ff2118020385c74397a7fc676a3285a837eeb990cbee4fdefdda932cc1628bee1ff64755f4a59f7cc28ea4414bba1ec9a4e65fd057fe927119f18055cc8fb3e3240c9059adac624788daebcf009a1bb22bac2ac8d61aa818a56b0bf16495cb70aa5d0d538abfaa2b6e52b0667ecf98d44542c842ee78074ecff953ba1eec427adc63296c2c203425b7eda3fca12fc73033e02583f08642d3fb971a911cb150fcd76bd10e8dcb0f2633463701eb7cd0874d0a9d46cc6b7af57bb10d8fcf3cd53249166feeeb01b29805e9e8628879e66e9497515ba9525e4986d08794deac52d0b93c78f110b5f4c8dd00a6b8631220ef94ab90ef8503b9be057c5b8d3fb2acceb8f5d5007425524cc8b644bd6785b7c03683bde5f0d17b4e88f2e68f9594e1fd32f50b9e419beef6bfda59cf1346fefa1f3e1d42d0d5fdc2fc63dc7463dceb43808cde34c85be593afb19732a21ad5c6b19875383e456d8e4bd304ac8b59bd55fbc4f1bd9d7aebac50597c8df746a29f741067ab1d8b895aeecd2e1b58e625ef1e4714b4599e0d55521deae9a993e669a9f501d3e2d85fc5b5af90beec68c6a3c116529761febfd8e3ceda86d16ba722889164b8b27b214b6618fc58ee893236fcdc5e077b1b16074e66f2ba0433bb5d7fcf0937bab1e54151edf9ab466e634de1458fa87e21037944c021fd324b3333826dc8aceefe03652436af47c55556268ed8a7b43d70197855184542f5b1267d8318ff2da4b4f972f34102f3e127c859918060ba035051057f98362108609fef88f90b018157d7cc70aa538e19f94cbb0a26ff697bf5ff71e9a5a108c02e103bdd1f94eeb967d1fc9a4ff7d9447d97cb0ca5630d5a5c2de96fa6b92c7277a3702ae5c6af1dfa236e419fa677a2d9e8852d7164757562521037d26ef3bd3547a423b3e12018e48c55c01ce5ca64d848a624d905946d939ec2c96536c098bb3ac70edc303c3861219ca5d8c983bc47e29e65818f79b6274186913645092c9fdac82aeeea70a4732ff8b01ce14efd65d80405b32fbe5c045e89248b32a80e2874c7ab4c58dd5280c620dfe025235157fdab6f0684a4e4626c7540bd8bb5c3ef9a106526ed95d4ca8030543f023e6d6e6d4a722e72ff414f8292a7a1c677cf4a821ed124c1435f0af727d41867fd8ca0910cdd8644e2d5a576e965c4aed59d57770dd1917e1a1abafbb688e96937478827d7f0a478dba0a8424a4e2f32aca866e6d4390751f86da1da0af89110afa11fe654866203a5ff1f5cdbb05fd222839e4cc87d59a737f3a6aab1ab573278c614419d6dc67b3c9d71a5c4e317e4bfa3ff3240ecd889947a3c06359c0ddf703b47d115be75679e6e4889af07ee48a187aa55b1843830466c37088ebd9554d4fc918de7e37a70f7abecb8043f4e1e5c7c93963d91afc19f9d7d457416def23da900a5625dbdb61f5c2929600325c7a1df72b421be9b88a0680ec1309d8092079be8cfa82ef907e6e5a4de05d9482ebe30d233f1fc6ee7b6f84bac51ee87efe6a7c96b54c17e76f25de99e7d4469e1c7c0badcc98d6565c1d10ff826a2f6f009a5a954d7ccac3633ac0c378128aaffdfd33dfe43a0013c7cdcc9c4a1c43855f7386ad9d03f03eedf81696f780ce6dd9d2ad29981a9e1dedd1b0caa05b674840e51bbc110392c9a4a19916df0910e5abd2d73d258e6bb6fe3b3be1d458e7d56fdd86b22972ae7e0db09dfd0036e25513cbe032ece26c722121791d4a93f8ff326cafea99b133e269ef264d87aa78c0b08cdcec1a630b382e2833e5cc1712ad11943d418e5f568f09abd71ffdcc8810f82c2b4ad655165674d78bc697de37eb6a1b7d8d623552ec66150aa248d12b59c3bc594794a846752579fc45160a7567d3427ca7d02abb18ecc3e4965b28611c8caf5a102a7b0640dd4e23c0ab04c77ce5566e11d5a76d961284e41f012e3833b5da01c6520fb48a385ac29a65f4b136cfb8852734614c75cc1686c41f0c9f8e58131d3cabf70b118fab0cfcf04c258a0d023847135672ee666f3e5d0dbb62e122dd9a8fa9a61b21b45f302009549b80118d1f89158ff5bc9a724e3eac144f9368aa2bc975131dbae808b8e62a5c58e411e12474ab157666364536b445ba4cf7f5b076a513496f3944c657be0c938b06b48857154a8d36924d4bc1d4593596abe8c6c9c5d8f438c1fc5141498e8a5f99f2d0203599692883e698aafadb7e005d35fe9c7f3170c32de416583b10ed8f8233629d73a8e9e7abd47959fed995e79f72d06f64a41c19965fe7050593b8932276bbc3e962658b1cb81e11447e5ff0dd10bcc4f13829eba2c187d122d6ed65b0e56745f029844290c41a0076c562237b6a385fbe063bb8a84f8a34e1a3dd2ba8007c30d3eabcd5931ff81a4182653a9ea1d0646fac295eb54a824f8263b2faf2e345db995776b8f8db0ed6ff41d5238d095b9e31bb920e9702a7d46e6a33f89cb93e435a7a5e7958817c0b6dcb04b2716bc30fd239031e3a83ada47564095dc1bc9d23329cd0a0490c4b361a9696120a70a9d8585f1736a9265dbe320fc34b94c27627e95992b79f643aa13ee916e8661e5cc889ebdfd4fcda05109bebc14a7a4c49ff7b6abec4169eb0e24bf7c6da0fe0530f976b6e5f26d4e195782882c8522831e68860bf2fe782f442b299abb6c75adbcd5d92fcaa30bbed597f70381218c1c50bac95a7d197632504cada6fb67aa2b56097d69741d081c340206329841807ee15ec1d5cabb31e3dfb50656d80fa2735da1050651596c8fecbcd60ea5bb7a51bcd61aa39da18be2cc3155dd03acacbe2d7f62d573ea2dc83a7ed58af96153b348864d198431a9f0b38fbf0179d6a9706e23b449b3c1352ab8cfe7d2183ed291af0f606454a20f1831e223ab983fcc0865750b645c37afff3fcd32eb215d935a5dd5292608473769a5f11cf81f23bdf5c95dbac0549906326d1513482b1a51c45962c88723cdfc6d50b564d38b266e7cea211fa2f992b282e613b43e6bc2c7b877470e162627f2e8162f398d189de0918ee04c84b5bb59b1e52c9f0e5ae68b430518369bcf3fb7e93e3911ce4d8b663579a15eed8db695d767c44a218c15257775e57904eae96241c1bf1418e2d094e8db51d881028c167aa5f6dfe4ad4e423c16acd387224a26e36ee923766b9599d174dcaa1e78ad753bf17fef685b0addf08df5606de16a49fcb715e2b0386013b1efeb669494e48de5dd184db118aa77b22efae64d44b1bb89df6c4b0e6502e95d7bdb75b5b4d48b6c4f745f75592b309e137845673b7f2ea3c4eef62f2ee2dd38411122bfd727f522696231c3d761d42cb409cb864fa62f396b8a17e73d5e5803c29117ff921e9188151bd27d9e3e0f9b5eaf5ad732645619ea6ad5dbfcc888053f8f5b294a6b1f954f14cc937d6a12c2f17087bc1616752d67e9bc28f3456585a3ce292fef6adf3fee68031e45df1df51e26de114913d5cdc22c940314da92aa4ef1b5b58d8417879242e35c0348fc2b3278855829c1b1dc0738a55fb49b65a37d33589374dcec06c9834587c85097a6c3c58028c3abdb8cb2eccbcc5b918aa5fdbc5911ec704105922a6d0454cbaa7af9a8f0771331a48e8809abce42663cd864a54f01f63e24b82b0d3e88b9b9bad1c4af891c25aeafeecf93980727fc5e45aca797f2281dcc3559e37d8dccbbf63951aa8214df9941fb6068ec601cbe9a8cdf5b4f1e2f0aa0e7b31912339d72ba7005c2de8529d70a8bc917b15aea202abdd208f48165dab59c8099377d1bb39747d6bd95eb8bd9db5d4c28ff038c80605f1438b174c3a603edbbf8e9adb008f3093d5b44f957bac2f01bb52dd0162e7cd8e9a14a11da9fa26617cd787e3f5c29881dddabf599bfd202186bb37629311d163d567516412c973c37909344c113ba76ddac5b578df59ab95e27d424294bd2e18b4c40d3f2a2e873700844acede33b5a91d19738726ad6870ca9158b1fd09faa513b3788a29a2eb3636fe3fcaba61685dd2f396bc980fc14d46569b9a06f9fc10ce3531a69560a0a17a5b9fe4eb6e1df16bf24f0519d3703b9c4f3390111732c3fc66e1355d09c1407e517c0b952cc683a1ec600d7716ce79c7676d4a36b1502a476f02f34c25a92d2b73191ea4bd7e7307b85cf4fa09d9aa7e28f3848702424e28e08fc37f8c7644a57a8fcea1b38423a1bf49eb8efa763ebc0f1a343b4838e8c0a853f88eea3464e2dbb561b1d83ee2b4d9bfa2d09564b68086e3195ca51133a4aa6827d06378e047fb0a494d26a0719db13bd5b447a4529726854ecca1225ad7ba1e3cf21412ff531e1ed00d146336bdd53b42ed89ade86b447d4cf550a48098482dcd56e4625e5d7e7b1e9b8d1835e086e78cfa4d828891f9aeaf11bfbccae084d59aab440077539d78f9f6b99e662fea39c42284e17698861508d94ebfdef24eb9d2cfa24d1c1f32c209de18f21c93782b85a13269438123f3082acf80ce4bf0688fb6109326f395c6d2c4f08345b1d4037bd3f5c16ba020ebbb1028f9afdd8e3bd8ea05d252d4d95d784b03dbd0eb856f944c3e6ecc6311b9e61a3fb2ca068b8290b08c9a52d5335117f37c3b5b1d6640841de14f44498da006d4c758efe84f6b97b7bd5b4974093c3e3222af913cf87ebe86d1c74ce435fd2e45b393b55dd47ef58be088ace694a37a618ffc4fd952f6f1e9fc44bdcb58380959c30c11f3d586a5f2296013e3066cfe392e0689e786c78351fd0b87abbefdf23a4149c84dddb6c8fb6191fd1ff8f2cd19283ac6eaac9e278df784628b4bcd496238774daaf34f2c2f03c76bdaee62d338e7c72f5b5516401ff9659ec185dcbf9290063c21ab074a3786e5e62aa0b1af71b579f9c080006058924647174e069082328133cd7977b9bca744b935cc0100eb859172f7c1e18b8a4a354ecd0613954eb65c3bdbd2995aa636bb9ea621026ab05e961f3d203cb0fc5cdcf09947c12af8c6423687d67d0ade347cf2cf1b6ff859eb4863f15e00eed6ecf6d7f542d214b09f4a108b3199b348e0f8f2c0f2d6cbe8478e77fead06c4d5c38c2384e781b644dc3e974f75598cc18bc258c6a89b3535d1062740e9d120f38cdc5dbc7e7f312595c1b6ca567baadced025c32cdaed4af40e0cbe665a6a388d9ed5a27c94bcc347a418dd574491bfa0338857abadb6d83b64ed48ca1a40b05065ebd91a10b962a6c096c59ab551a60ea4ed816bcf57104943f6b08df4ed22fda76ed698919260e36a03c55796cb99fe29059a4f2caddc62b86136d71da570a0abd9d46d752ae90eb0e57ae73ea8a2a4b3b194ab4f4451e6417b01f1f1c5d1ae4ce1baaff2889bab75f9c16b9a214f5cd6b1a5e3e5daa8069e7a42965a53eb1b67d3f4f49c9aa1939ade7c6c4c3707448d83562323f8b7b366b785200b928f7834c9342296a886ed3cc38cf6fee09e084a268a56001e3b13cfb75826f0bc25a4af59dc420244eea41e82953fa5c609092d21d90e65ff20bc526584b133ae644233abf2e1c8d26dad80656aa36be8116206491adfb4a7c05030c03d5ad7815c0d0a37e3eeb6efc3a9d3b58f97717276428dfe371092ac209f293e5e5dbae26ff2c5399cc9143f3db55a461fdc75379db04a97bbcf27c582f32fcad6e65bdadfd44bb77be8cd1a48327533d690af187c301b4c9d7385808fc627c3237e9c8bb72cfbea9ca1cf1c8d9d529c0fce6ee65372107ad18c6d217b328c14d708f6d2af007f33711ca82d77c6bf68348aacfb4767a0bf953f86033f1d4aab9801529b8be8045a1e41ce62d78afabae5565a2f73c61a00fef7e9370662b0466a0fb64dc084f88615da8eba769abc1b9de3dafd727a54a21ed02f78b230fdfe1860b1df4e91fdad88c5ba53b929c08855b2825b5221cdda2988ad3b5411c3fe770bf8bbf60f67a2c6b27b02d32b4744c5424dddf6297240cac5527e6189a0c851a8508acb3c7e315a68f7e62b74178cf3a4dd2e7882b8e9361082770d002acfc4d25263e2aa96a15ae93ddea2d8d190a23de19911b6aa638f1ea6ad41c13051c42c370a82dc73e82670013d4db143ef6a3ec5bbdfe82ea1fa74dceffe1055c17b66d681a626879f425910aaa4b0352e129b40127cccb2042d279f8e80315886c819e1d3b8396da4aa9e9bbc8822636e29b70f00b2ab1ddda6857440e6162a660a526832e58bc2c77759c12e477156324ec0309482f7a6809b75e158135349bf2d780901f4e30a3cf7c43e01c34ed92cdc91ea477953bee680d44cfed3ca416a4432d8d3d6cdd147ad0551a5e02f2e4b2433ae276de602e85240ca12a83142c1997ad85b8cd9ba68f280c805a96ed4d157178cecb31bbf8a38625fc794f47a311c09c2179f4b289415e9908bf65308d552e2e28674436c621806db09433f83498d6125071792658b011f2260097abca9ca0395eefa81758d482705c930cf6048f70a9a3ad206b018b245bbf0bcb2016cd3ba4eb95905db22eaba2dae7733a1b3587b7b92b9b1d7d19d1a753adfa56f249df35c842e893edb0fad43e8e130be8064afb79ea93dc00bcc763ac52c58ffb956ac770f2ecf60b1cc65736bafb4d611961c7c2f3460e989083af11ca1590e41b934b569366db7677974f70c45f6c40363a8c76891f8303ad17cb0f70439befce75a5a9305133613ad69a39e3549f4fc3e84c03e3f6e593b04c68c43a5fa75068a306cbca5574c713985aa29287b6cbd97ac1a5da0cc1fe09b1f69d9560dca0098a9f4424988b566333ae3a4ef9f5dc92cc89ecf8625bb1f7ad9093e86d2619c066ebe8b9ed7124b5ae90fc648ca64bad0ad27d6722dcc92bc6d42bd0989f305cbd38ca1d653f3d31fe9d402573371f76e3b1b5fd397e234efa8366a7a56809b9acbc86fb379cd98b2a3791c9e1582b83aaecb84d94651afdfcaa990bfb02d436ce83310e1d3b905b7b1915f8f815f0819f54f39b840a575ac494d51e7d22324563706d281ab70d02358b9cc5b14e4a8161b86b3279694cc390a48931f941943b971a6cee3def8fa12cdcf3cb71546837058d0c34f7253a7803fcc924c93c06bf3b15e6d050995e72f2f9adffcdcc992ac45c5c320532005ec925302cbc530bc35ed4b9055ab055177ead51df45622a85ed5319f1fab656141d0bf078fad6d5599fa577343288e63ac484a59d65a870d7c9425545a1646223e26beef6ce1957527290330fd0cf117d163c24c81afdcba451841a892544a8369d5d25df377a969d59340a4b53bb39a1fb4a47aef9bf3f0e1e50e37523700d512abb2ce01229d726bdfb98352c49737b55bfcbb027ebd0a8ff2ff13ff7709cf2c39c7f29a935f5c2c0787a792732b30007d42c1aa0728bf810226083fb3edf85534613e0a393da41dadbcdd733f80ee3323d49523d8fbb1a435d5591cb90a218bcb662713524255304e004f00073392bcf77c056e93b7514a0c01ba3f640a9e22d9054fbf03b5c55bc31c3fdf53d5e254a906bf849389113f52837a35f97a878bb34c12703bda1b57b3a99a1240a6dceb874354e9640d75445d84cc4022368d27b5bf08c1d8613e96458657fe58e4fde837511abda871d51d4068504e21996c67093309bd23353287a464a4b700d2d7cc12875af8f3d4ad50b98172031e518cdd3390d20b0d4f9ed6cf9938769c7524e4010e09503d10a78fcd7736169198e4974343a40a87cbfa68da9a6384385e45d7345fde1fba89e60882728159cf0558f77aa0f3ef04c019aea99baf1a8290ab521d786421768a10bc8c663fedc31333bea07f382a1e99545c2e421109904b3d7a25fb51c5166de163c8b62762d452241f4870e965ce79d6b35cadfc4703f9900d9e3125fd2dcb641ee77f18cde924dc8fe691a30ce1d1308014126ceb358451dde4b9567969b6eed395633ed125403d4d2503a370b354343137161b72b42352ee5ebefa5dd17b101fd71f95998a11b59f588caed0d3afdb76756987ca80a1ec7e61f7d6855f675e8f93bae1554e80e7976a4cdefd5313fa8426de2da663bd60c057693f96298f6112c81380d51d164de6a65f7bdb25fe0e8a8edb309d4c8c829b136c26226695cc1ed374c11a3f012ee882e26fd83c6f0c93e97c48916bceaae4bb9b2d6cf19124dcee7110be37c45ac94d192cf057288d94c639f3b329f749e7e9888adce4beed123c683b42ffb304a8f5b86a5463a4c7757b52b4706cd58fef96def4452b25d998ca0df23872ada8e056ba3c200c79046c53b919d1d0da68da96a1736e5662b2882ca15db81edca3649d5bb4ae93d24b233c4a1d40d04a6ac8129723c3f1818e2fa9d22d96688971e75bd87ff6980dc2104acf72500883db546d9090d7d0341012389b4dfaaf81adda6dbf47b0f925096eaff40b4e8aae18ae0f17ccadfc39cc69648a45f7ed3f80a730bf03c68121f1bce46c9eca3ed04c3e08e7c7324ccfde4e6e561d6623fda14f2e71bdf9d52e771a133eb93830c2a88c4c27913c7b21716c96275861bcf25a1740c1914b2240a63b425e4a5eb7378e41207816a54d1ac58872569f9d1209d2c9c151730a2ab26cf7b5a0c741500b96086de732fe6c34b3916128a927025c12b51faf23ead569703c809d399f668017a0aa1677da2856a8c90815b4e4dd70cc7804bda351ae18841c6a23188307f49e11f7948ff47c9356d1a3dcc4264f5b519e6e0bc179ba00ecd014b0846f87cbd41e0f64ee33624beacae32538eb7ace35e50c275740fb65a390769962ca75a53ca4c2cbba837aad5a4c07c004bf5d0a5eaed2920525fcdaa898ecd375f86d224dc7d6a70c9f1849995e384de9ed6822ac2a755d20512b4871ef376aa4695f92e77a086839d2732fc202d30cea67b355ff47290eefeff797d31b3e7fa0d50c57cda2fb757cfa2113f2e86b034f5d86682e24f463184a8deeb66f234c433bea625d9e049d7fb7cf187848d56d855f8ad3b99dd08d5491b399b07d25ecbcbe6c6549f416e958a5c97094119273bf87d147c8add5a05644da44d5ed7fc65c6e9bbc4d046bfbdca329318674176f61a6b2eac60803f8dc2ecdbe1a74737394409a4a68e0a95d5433fa804aed7133e847bfee0d2f09a3f1f5bf91c8763f56f44d22932a95ff05b7ee96277a4ea5a85d5a159d81d4c9591b5bb18ecdd680d9150f36f743151d34e6f8c4a114f89cd28b1d340f1587a894e72ea990721d567665215dd1948f0677a13f1f912a0fec6f0cbb0f9319054ee444c281293cf860dcd652f66f4d174f966a34ff9e657dc031a472f5f39d25e5e855455cba5cd054b3fda3d509800f3c88e74852ae3472dc7369eda21b1c46156a31f62d6fa0c76a84b6de857cd8e149212f2fc782c897a9b68fd7cf7753f47456615052ed0f0177109047c808fc2b43ba4b2cea12990d5d449ce06818054c2db601205b84ee165e651b5580edbb6de2ca5bf4653789f79b7885fae80585e8eaae1ea3eaf702f939c7554c22e375b6e5db4e24c5735c5cf9eae98443862670b085525ac28a80013f7e52eb24552313aeea6b2b2cac3a0625f1056e831b711cbc052d43e5d47829b5c39eee2e5b1640252bc0d6a0f7271432057dee95aebd4de64ba920de76c4dcaa02d692d445b866f6a9629afcb9a5ff2e9f789be830917ba66074e0eb369f364aa430ea6f2fb7cb0d81762f865c16da17539e6af21b12ab6170d53cb84703a1bec042ceb86d3d7c99bfc331a59c6b1f2a3775528b62521f02a1086482108999b4c181103137ca2051c186202cfdc33409402ca62f3381cb9053325f0b53bba98d7792b51c91d9af38185f3d4b03fb7c8c064f2ccba72cea7ea576562c3b6a3790b01efb2de7451dd0125b52a8f0ea53f6405fd2691325b3f070e5ff8b5ac1ffc54a22d030000beda60eb877cd9977e36eb38dbff9220cb43cffe27f30d08e5299dc6ae31c56f04797b9122fba7a0690acc169f6e86c43e59cbe93ec088ad83ac706823328bfb3177f9f42d926f168995f08102a9fa0f12c518abc313518f1afcf9a4a89e390c30e9d18ddc11b181390c5f31838e1c446d86a5c3ea2ffc03ec06a5911388d2ce8b79fe79dfb4ba275d77555631fbd7db9b8c466a5c2687c9262481c40810b1105a3792a85e5671ebb2709f785714eea0ea519cfabd4ec34374e9678e4edddca2ec2f0cdc0817a7ae93b58733862e2f2e27b4a524c3aa0b1b5fd65f7f3e7d08f5f90ac7eba43d305b5b601aebf0e4a4c1685af1e6e639861efc990eabff1d5b6cec9df399e066336b8c5910dcbfef062b401fba92a06c687db11d4a78b6dbe7d60f8980ad438ead2af20e7692cb20969bdb7811388e35cd047fe1a303f26a53c1d4ae4dfc371cb5ffc35821290324e833346635a516c2b8e89f5c4fad472bce50a1a5bb879902b9d9f96a2289697663dde9e199bea08dc85521a21251a99daec82de496c308a639c73c953b27b321bb6ab1d3e0e526627dd1e30b5d6af10c25d913f2499000306827b762381a80179ca887a1ba3d31c566c27fd7a9dcf0bfef0f9d747d2db8c2fe21079700f5ef8654ffc9578ec7a21a7d2e25cd7aa93047405a48bf94a385594ad7f9d341bedee056beab71ecfbe8985b813f58a2feca703fc0d496371330a30a5d0e45e892185d39e6434b70fee24c0097324249d185a264df00c711c49f0abd760b95d65b4a943d202e0a7825a862ad1c419e99c67d3b0f70e1ed84be594805fcb49b373f6e9c3eb1e16265518fae032683288806814704b831b5a48010612d323ad4e2c4c7d8e644c4d39980135a2a8d4ea2f869bc8d56e4a1fff6454e57b5e2dc5020dff086ff782d8201692d727861fc7af77cab4a95136926f6975a4f2a69044b4d3dabb76d8eca053e92c35fa2979cf54bcc60adc9110cd1ebfeac7ee20587553992750e3d9571d6587f99d7af2bfb1c1833b9a07d8e47e6ad622cc5fc3a80a652d0a8f04482ef50d2cabc0a20f2fe32600fbff17c6aab7ab055be45cd122c21ad35c12d07fc0993422ddb7c262ef62338772852d1e419b4707a3d46f798b6da1795d228f558a761a4ecb6e6fc9511a42ff7033db98f8358a95b6395999b0cd328e913819a4ec226e8cc314d6ecd2f4e096a0f6e8f29ec4ccf72941130666d911995f31a9206bc1bb8e516f0ba69bf46caf366104609e4b0c3f409c186dd2f32aded05bb12546243c58392600066b1ed64a0ce3a5071b80cbc1bc73e8ed40840b9f7177804f27e38b0f908f59027cc40e59f5b61c79c527bcde457211b508ae0e2e642496886e8e5d04d5d484da9e3e7a83f66db9abff39f29bcde5c0a66e4ddfdf17a890fbad54e5bdf91617f5ff45b5c4519d63b60a58c1735b622bf40ff0aed8d3c4d280506372233c00dd945b610ad747864dff5395382dd8756e61411b030523a7c224323290a6985a8f69c633be467bb402a3248ffe43d6faac6043d3f5afca2da0d40fa24acabdc410ea59094b27fac1b8e6a0dd2ca84ebda2a6d1ea962c4f9824357d7696fd7a66e43e48c776bec0bae97dc5241faf7dbb91dea2c4e8ba67dc468b025cc2a23e6181c890c99f0f8b855c9437d8aeb0f4b881bb934e9b82c7c3a2d4f8ee318e3eaa19668378732162416601bc702ed6ceda88ead93ab06b4ecf9d216f114896ede298e3255bab8868498c222809810d737ca286e7dd02a807de6c432599631d21174106cac8a5d2b1352692b4f9a34de3f6a752c09b2381308959dabf69532a9d646dcd87f4e669767c9cbe90b3401605cad382fc57ba7209556630e1495c44c6975aeea7964aa7c450cc247af8ffb5deab09b7a44e1138aea80a785a61f201baea3301665f6c7e23ca5b1f11ee311fdeef61b0683f46477293bd653f5c6eaa76b8f8826dd46c3c503f5b494713ab69d3a572f196ee861bc700b21d9215dba9b953c60e78a83063e9250a34f58e11f14ef8d1f59255e8f89444b090ea1db3c22fee83aed51cac79cf0f9b3e14d3b494793ef3d78500726bcaebe5435061082365dbcdcde3bb0aea0ca60525b5c8283140436c01c25256a1dbd4ecdd8ee1080970abf138a626c7cd509a0cd6323085ff4b523c4017625f1cb5e9af9e66e87d29d92c336c9d226f0d9d328b2538f5343cb1e113b339113b9fad6b63783b237a7da3eb4511f49a01702bdfeb362f738a78ec3d20bfc3833e7805dbcbb9398bab4f1d7c2c77db8a248169800b2dd1eda881581c625f8f14a8d293f80dd7a2b0f13a9cb4257fbcb9292638be10716a68882ea18e555f21c095f077a254c0d3a3acb4ef88f1d117bbc9298dc1c7948e6309e635a00c9201d715ef873d435d9ac58cea95f907af99dd925352097da06158b5f2b4ef25bf633a8f87f561b2e6dc5ddc22431f0477223853b0d6232beedd9c552d9530573ab23f134d43c57676c74f32edbc34d2988ebf312fb150f88a89d4a249f86b350bec10902233cab15757bc36efc727fe5c116bf05ad8ae11af276ab01a3d3b659dd835f1bfb5b68a90b53fe31f819bb9d766dd736a04cc93a39acd40722e080be9c6bd9630fd647c2069ec23294ae98fb2591662f51d702e50c61621be39e2c410455e72d4c8355fd90992c3a09be5d80fb8fa7c03c9127ac9f0c1fd2a15447460127e210ba1fc72b7c8ee1ff37f2c2c349e3eed85ece7adf2a2153b949866abf2df6f7140372f7cc96e00c492f6eca9cd4379f83ef690c14a206fb6f47e69b214b342efd2b46aadf119647c2c83d07803140aed2a3b66e257ede6dd59fae1ec674a2853ed13b4015d0f1ee448ec495cab2cb05ed7d1462dc8656fbd47a5af7197f77e98f66da8bbf620fc48ba536e53578cac580bd2d69f201f61fa0b83df9e3bd296cab38d20324ee3194b2c446b29e9f45801ed0aa0200f0d194a925330ef316d3fbd1bdd04d711e84d8475a50fa18464e9bc842a02376ff96caa93a2fcdef5c4d77eadd83ce8340bf2488778024dd4468c6b68515cb1c926e2e0acedd990f4ace757ef7a20faa6b34168d5a7462a3c8115b757cfe9cacb4aefbe16744c4b870d68f238e10be63ff004df1302e7dc1807688e8a89f9764d08d7fa71af5e7da2269320f2dc19ecf6caa4de2a31666f2f8ad443e137dfe8d9fa941c3a3a2608066dc489cbb9a948871b10633962832901d8753f282f8335febc1600a0dc73075a910277e05a1cb3a7f067492fc6d3b0cedc79e3604a8f88247ff44cc55a8ae1c6f1feb2cdb1f9a94005a95a9a82b7b62dedb42dc25b583d79933938b5137dfb590edc33c98d7d0d15382a536b083e623f9b777caf46c6929ee726bda87822efc44e97de5db89157b989293c49cb9d89c439778640765e6ad3527f54abea6eb84f3defa974a8c228b006b41970fc7b9fcb4607f73a90f3c0914092eb0f92d288e11e5e859c29b23f131d1eca192db279d38dde4030ae758a77ec71768c17e6bc11ca4af6fa9f5e3d8113bab08fb18b3498f62fe48c6d9f2e8b28bce9b923b9bc1475d45075559d3efee8c31eff326673c310c5c0d56f01fb8e512d6df39b0c009c2a4d1f09f7889a1d48f2fed5ec0524549a39bf4fccef67547604e38a5b7521b0d0cc04d64273a3dad5cd0e1d557ff2d16af7855788fbc8b59785cdeb9e63f5de1a6f3490767c22679cdf36d612923898b776704e03f7882571677e0343aeb9ff3c672f784f18203ed53fe11bee3db368d3775ff32df08636a62de0c76d6c39a3ba3758af7de0dba1d99df8ff9d5c3136aff46f2ab66fbdf424eb5b82a533629b6159e8d878aa8adab2f29935910ac39c952ad8bd1f2802be21006f7d62a2724c15fa0cb35c55e980d9ffdcff34738b1d5319d8752658548703df62c1e95de76ffb1f66ee5c0d4e8ee8713d9a3877668a8a92261c3ec5e2f7783f4e3b9dc28c09a275380b177a2d6e5fbec5e4ffc290ddcd8317d63a1d0eab0fc0bd6c5b899aa535b63780a7c7e6c1b6e43d43d006bae51d0b310317270790f37172c430a5560a869e6b383374214b4f6992a64ffd7ae637239f5f6e028d44bdcdcf7a5b6389fcdc020c6e83954fe3ccd619dc0a055833e18245e966ed8e14c44e6e55fd956bd4801aa19b797524b279651e9b27894ca683a83ff3aac565b7483569694d6bc283d8b04370b0825020661d468a7240be4334c0ac067be0d27210fb7b935a5b40148b360fcc4aa142bdfb4b73f1a96141fcb4604ca20072ab063082a8616a7369a7f2416e4249b3e1fa2bd8afa94382f8b88cd31ea3739d8f0fbf67ebb95134a88349cc4e7eea07ab46993c562bc94552e69e739978587c8d79c44f52c987e770eaf8b48261d7ea98884adbd7a992e01a322de5423b31f7f8a3a7b30e553eabcb3188e9f6c965951588af3bac422ac4a1724e69017d28e59a1b1f4cc0410163d529ec2b3148e4d099fe63978ad7ea30fc108bf4ab5ba015cc5c22e01fae158f9a0623463c5c85d338ced7baf2dc4241265cb35e5770186742f00970a48fc220a23aed04ae251952f04e1270f9339e38083e57e8ab3954cc5ea9d364efb3bf49aabd867eec47df0de96293368d1fd9750a37939314789fa0e39765e1b3611744e5f853a25b6d2e9943a3d81f09a4070d20aeeee7e75f0c36b9134c469935be453cc792dfb5df99e96c15d1f4271321702a79f7bcddffc883c7d27ad787caad6d8f142dddd3ab741b65f8fa49e250ea833d4ab45ecb7e0323ce7a5bc4fcb773af7e3599668711e39f841ade47bbabd2c30ac25428ff617047bada0591c9a343fe21b3555c1dd0d58311d62e01a809f72f394cd693aa6beca7c949f18ec9da35cd88f2075178e82ae1bf88535b3afb09b9f8c14e1439b78f059cabf0583a13a5782ddab3df213b1f84076b7e45866c902bbcfc82e7aab8bc5e45fadc60bddb8cd56df88ce6d7454d80faa62a651e49ba3b8fe22807dc57ebae559113875f3ef28fbe89ceef7bb53b609f3df7a3912dd6771de80fcfb50c145b246602e59bff89f494136f6dc6d8d1b5bd0e33185da2ae3bfb21c3c8a92f25eca78d3919579db2790a8853bd3cc48b125a6dea87f2eb47f6e87a15e4f4d7fe8e39bb578795ff5250a8eec7f04729e963f403969a68a5d0d965737923121a1dc96a625e5632a908c2b2d243cd7a9767f03fcc0a3b568860433df5cf242dc2f360d9d8fc873b449ee2c06d70aa14b6de7eb033c432601e18804c4c82319fe7d3eb1b96be5572ff5194816a29af6a9716bc169492c862f5d7c0d88e8ef05bededc7191dd92f9393752139fafb4c6ab07b57f2bfa10635340446d28eec24ca3cfa83146094103bee2857c9e9f9fede78c7c6faf858aa7f155c72a6172358245d1786c6666a4834b76b90851d5e781659d15f32d18cd68b756fb0e522db0bf271b11a430ba37d9cd54cd952b4e3260b18d979af242dafe7d1db3a5c141925c54930befc0e0639e3d480b13ae70f52299a6b9f60e9203525a5098baca18e72b58962486ea39d2dbbaa02b62f05e39ca7db99c2033dabc7656d277093bcc097ba6156f9af2379969e4d0e5ed483e3dfc4c405b0a4c37be10272d66fa0b4cecc531db96c12932f572aa6208b2e9c184ccd6a5323f9f62b72697a4a62fd2eac8d91d8bce04f73a963ca4e62fb4aec2b8e46093d73c1183e4deb45fad449146a295c9559813d65743bde89e5fd07152990f1309146166ccd7372f4ef3da459847c848e8405d6ca61435b58a472253078387449b6819f64c45220feb012855211268060c747b0947894e2268377f639541a9a65f33f9744e100f5ff99745fc004ef81160baadd015a9a2e21643bcc84252b5c472b4d3b8aa422df9ed9d1ab9d16b3ae2656cbf1be032d8e60f19d12f5e72b76830d74399b6ef5c4cd17c125a705bf5b2b711ec80b9cbe3b5c0f5011f1cb0993fda01cfc3e55bedd65c72f07b259bcfae17fdeb7be026acba1943fa49d2167b60c42271266e17b8697328781476189d737743388eeded3fea14b9bf7de0c91856812db6491371f730c165e30a83d7a9cac675564e61400282b23edde5a8e21868a72db126f793c800323de0ef62232dcfe3fd95f85a0aca7255baefe602dde8c8425c3f118639031fa677f5c4819a872a97dbd681f4caba4f16585a7f2fe9753564a24dfca8f827f27a0e1f782416601ed97bb9edb73da31fedcec0792dc725f54685c392fc27e6ad73896cb1de1e2761545d9d36fa8aacec58100c3107c304dda6cab9d9f0e92a5a06c683f0c3e9b63f9c55c9ec4c31c6d3c4f27eb456ca73f6526a0514c38572d9d40aee5f6b95267a89d91f00e0045bc943a0551eca59effa589a07cadc983003455697f415baa3de4dfd0870764dd5b5cb3239d03acb8bbaccea24be08b562a595e0700a96d895b8c1280aa4ad523e5785d8c98fd17bf646298ec5bde99eb241d867f1e33d706143341b39ee24535aa7f889b43f9c6cda57b02b4126c4b9dfe067e73ad1f0150b235406ab4bba44a7b634831b6230495ef0d4cc6ae70a29aa4c5df2e553518d2377877ddb580eb7a223dedb4f4d11751247795ba017ad6511c547257a6869d16d9319653b35b23e39</script>\n  <div class=\"hbe hbe-content\">\n    <div class=\"hbe hbe-input hbe-input-xray\">\n      <input class=\"hbe hbe-input-field hbe-input-field-xray\" type=\"password\" id=\"hbePass\">\n      <label class=\"hbe hbe-input-label hbe-input-label-xray\" for=\"hbePass\">\n        <span class=\"hbe hbe-input-label-content hbe-input-label-content-xray\">您好, 这里需要输入密码。</span>\n      </label>\n      <svg class=\"hbe hbe-graphic hbe-graphic-xray\" width=\"300%\" height=\"100%\" viewBox=\"0 0 1200 60\" preserveAspectRatio=\"none\">\n        <path d=\"M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0\"></path>\n        <path d=\"M0,2.5c0,0,298.666,0,399.333,0C448.336,2.5,513.994,13,597,13c77.327,0,135-10.5,200.999-10.5c95.996,0,402.001,0,402.001,0\"></path>\n      </svg>\n    </div>\n  </div>\n</div>\n<script data-pjax src=\"/lib/hbe.js\"></script><link href=\"/css/hbe.style.css\" rel=\"stylesheet\" type=\"text/css\">",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1414180692.html",
            "url": "http://ixuyong.cn/posts/1414180692.html",
            "title": "Redis集群（主从+哨兵）模式",
            "date_published": "2025-04-09T11:50:06.000Z",
            "content_html": "<h3 id=\"redis集群主从哨兵模式\"><a class=\"anchor\" href=\"#redis集群主从哨兵模式\">#</a> Redis 集群（主从 + 哨兵）模式</h3>\n<h3 id=\"一-什么是redis主从复制\"><a class=\"anchor\" href=\"#一-什么是redis主从复制\">#</a> 一、什么是 redis 主从复制？</h3>\n<p>主从复制，是指将一台 Redis 服务器的数据，复制到其他的 Redis 服务器。前者称为主节点 (master)，后者称为从节点 (slave), 数据的复制是单向的，只能由主节点到从节点。master 以写为主，slave 以读为主。</p>\n<p><a href=\"https://imgse.com/i/pEgTlKx\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgTlKx.png\" alt=\"pEgTlKx.png\" /></a></p>\n<h3 id=\"二-主从复制的作用\"><a class=\"anchor\" href=\"#二-主从复制的作用\">#</a> 二、主从复制的作用</h3>\n<p>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。<br />\n故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。<br />\n负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写 Redis 数据时应用连接主节点，读 Redis 数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量。<br />\n读写分离：用于实现读写分离，主库写、从库读，读写分离不仅可以提高服务器的负载能力，同时可根据需求的变化，改变从库的数量；<br />\n高可用基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础。</p>\n<h3 id=\"三-实现主从复制\"><a class=\"anchor\" href=\"#三-实现主从复制\">#</a> 三、实现主从复制</h3>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP</th>\n<th>角色</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>redis01</td>\n<td>192.168.40.101</td>\n<td>master</td>\n</tr>\n<tr>\n<td>redis02</td>\n<td>192.168.40.102</td>\n<td>slave</td>\n</tr>\n<tr>\n<td>redis03</td>\n<td>192.168.40.103</td>\n<td>slave</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"31-关闭防火墙-selinux\"><a class=\"anchor\" href=\"#31-关闭防火墙-selinux\">#</a> 3.1 关闭防火墙、selinux</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname redis01</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h4 id=\"32-安装redis\"><a class=\"anchor\" href=\"#32-安装redis\">#</a> 3.2 安装 redis</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install gcc-c++ -y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://download.redis.io/releases/redis-6.2.11.tar.gz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf redis-6.2.11.tar.gz </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /soft/redis-6.2.11 /soft/redis</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/redis</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># make            #执行 make 编译</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># make install    #将 src 下的许多可执行文件复制到 /usr/local/bin 目录下</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server /soft/redis/redis.conf &amp;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">127.0</span>.0.1:6379          <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">69686</span>/redis-server  </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> ::1:6379                :::*                    LISTEN      <span class=\"token number\">69686</span>/redis-server     </pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli shutdown      #关闭 Redis 服务</span></pre></td></tr></table></figure><h4 id=\"33-redis配置文件说明\"><a class=\"anchor\" href=\"#33-redis配置文件说明\">#</a> 3.3 redis 配置文件说明</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim redis.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1      \t\t<span class=\"token comment\"># 绑定的 ip</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>protected-mode <span class=\"token function\">yes</span>  \t\t<span class=\"token comment\"># 保护模式</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>port <span class=\"token number\">6379</span>           \t\t<span class=\"token comment\"># 端口设置</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>daemonize <span class=\"token function\">yes</span>               <span class=\"token comment\"># 后台启动</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1      \t\t<span class=\"token comment\"># 绑定的 ip</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>protected-mode <span class=\"token function\">yes</span>  \t\t<span class=\"token comment\"># 保护模式</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>port <span class=\"token number\">6379</span>           \t\t<span class=\"token comment\"># 端口设置</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>loglevel notice     \t\t<span class=\"token comment\"># 记录日志级别</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>logfile <span class=\"token string\">\"redis.log\"</span>         <span class=\"token comment\"># 日志的文件位置名</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token function\">dir</span> ./               \t\t<span class=\"token comment\"># 日志存储目录</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>databases <span class=\"token number\">16</span>        \t\t<span class=\"token comment\"># 数据库的数量，默认是 16 个数据库</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>always-show-logo <span class=\"token function\">yes</span> \t\t<span class=\"token comment\"># 是否总是显示 LOGO</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 如果 900s 内，如果至少有一个 1 key 进行了修改，我们及进行持久化操作</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>save <span class=\"token number\">900</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token comment\"># 如果 300s 内，如果至少 10 key 进行了修改，我们及进行持久化操作</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>save <span class=\"token number\">300</span> <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 如果 60s 内，如果至少 10000 key 进行了修改，我们及进行持久化操作</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>save <span class=\"token number\">60</span> <span class=\"token number\">10000</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token comment\"># 我们之后学习持久化，会自己定义这个测试！</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>stop-writes-on-bgsave-error <span class=\"token function\">yes</span>   <span class=\"token comment\"># 持久化如果出错，是否还需要继续工作！</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>rdbcompression <span class=\"token function\">yes</span>                <span class=\"token comment\"># 是否压缩 rdb 文件，需要消耗一些 cpu 资源！</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>rdbchecksum <span class=\"token function\">yes</span>                   <span class=\"token comment\"># 保存 rdb 文件的时候，进行错误的检查校验！</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>dbfilename dump.rdb               <span class=\"token comment\"># rdb 文件保存的名称！</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token function\">dir</span> ./                            <span class=\"token comment\"># rdb 文件保存的目录！</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>slaveof <span class=\"token number\">192.168</span>.1.154 <span class=\"token number\">6379</span>        <span class=\"token comment\"># 配置主从复制</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>requirepass foobared              <span class=\"token comment\"># 配置 redis 登录密码</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>appendonly no    <span class=\"token comment\"># 默认是不开启 aof 模式的，默认是使用 rdb 方式持久化的，在大部分所有的情况下，rdb 完全够用！</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>appendfilename <span class=\"token string\">\"appendonly.aof\"</span>   <span class=\"token comment\"># 持久化的文件的名字</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token comment\"># appendfsync always        # 每次修改都会 sync。消耗性能</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre>appendfsync everysec        <span class=\"token comment\"># 每秒执行一次 sync，可能会丢失这 1s 的数据！</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># appendfsync no            # 不执行 sync，这个时候操作系统自己同步数据，速度最快！</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre>no-appendfsync-on-rewrite   <span class=\"token comment\">#重写时是否可以运用 appendsync，默认 no，可以保证数据的安全性</span></pre></td></tr></table></figure><h4 id=\"34-redis环境配置\"><a class=\"anchor\" href=\"#34-redis环境配置\">#</a> 3.4 redis 环境配置</h4>\n<p>#修改 maser 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> redis.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">192.168</span>.40.101 <span class=\"token comment\">#绑定本机 ip 地址</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port <span class=\"token number\">6739</span>          <span class=\"token comment\">#绑定端口号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>daemonize <span class=\"token function\">yes</span>      <span class=\"token comment\">#用来指定 redis 是否要用守护进程的方式启动，默认为 no</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pidfile /var/run/redis_6379.pid</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>logfile <span class=\"token string\">\"redis.log\"</span>   <span class=\"token comment\">#redis 日志文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>requirepass Superman*2023  <span class=\"token comment\">#本地 redis 密码</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>masterauth Superman*2023   <span class=\"token comment\">#主节点 redis 密码 注意：从节点也要配置，后边哨兵容灾切换用到</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>protected-mode <span class=\"token function\">yes</span>    <span class=\"token comment\">#保护模式</span></pre></td></tr></table></figure><p>#修改 slave01 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> redis.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">192.168</span>.40.102 <span class=\"token comment\">#绑定本机 ip 地址</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port <span class=\"token number\">6739</span>          <span class=\"token comment\">#绑定端口号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>daemonize <span class=\"token function\">yes</span>      <span class=\"token comment\">#用来指定 redis 是否要用守护进程的方式启动，默认为 no</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pidfile /var/run/redis_6379.pid</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>logfile <span class=\"token string\">\"redis.log\"</span>   <span class=\"token comment\">#redis 日志文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>replicaof  <span class=\"token number\">192.168</span>.40.101 <span class=\"token number\">6379</span> <span class=\"token comment\">#配置文件中设置主节点，redis 主从复制这个地方只配置从库，注意：主库不需要这个配置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>requirepass Superman*2023  <span class=\"token comment\">#本地 redis 密码</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>masterauth Superman*2023   <span class=\"token comment\">#主节点 redis 密码 注意：从节点也要配置，后边哨兵容灾切换用到</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>protected-mode <span class=\"token function\">yes</span>    <span class=\"token comment\">#保护模式</span></pre></td></tr></table></figure><p>#修改 slave02 配置文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> redis.conf</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">bind</span> <span class=\"token number\">192.168</span>.40.103 <span class=\"token comment\">#绑定本机 ip 地址</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port <span class=\"token number\">6739</span>          <span class=\"token comment\">#绑定端口号</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>daemonize <span class=\"token function\">yes</span>      <span class=\"token comment\">#用来指定 redis 是否要用守护进程的方式启动，默认为 no</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>pidfile /var/run/redis_6379.pid</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>logfile <span class=\"token string\">\"redis.log\"</span>   <span class=\"token comment\">#redis 日志文件</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>replicaof  <span class=\"token number\">192.168</span>.40.101 <span class=\"token number\">6379</span> <span class=\"token comment\">#配置文件中设置主节点，redis 主从复制这个地方只配置从库，注意：主库不需要这个配置</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>requirepass Superman*2023  <span class=\"token comment\">#本地 redis 密码</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>masterauth Superman*2023   <span class=\"token comment\">#主节点 redis 密码 注意：从节点也要配置，后边哨兵容灾切换用到</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>protected-mode <span class=\"token function\">yes</span>    <span class=\"token comment\">#保护模式</span></pre></td></tr></table></figure><h4 id=\"35-启动3台redis服务\"><a class=\"anchor\" href=\"#35-启动3台redis服务\">#</a> 3.5 启动 3 台 redis 服务</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#启动 redis01</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server /soft/redis/redis.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis0<span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server /soft/redis/redis.conf redis]# netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.101:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">117358</span>/redis-server </pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#启动 redis02</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis02 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server /soft/redis/redis.conf</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis02 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.102:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">18210</span>/redis-server</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>启动redis03</pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server /soft/redis/redis.conf</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.103:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">19186</span>/redis-server</pre></td></tr></table></figure><h4 id=\"36-查看主从状态\"><a class=\"anchor\" href=\"#36-查看主从状态\">#</a> 3.6 查看主从状态</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#主节点</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.101 -a Superman*2023</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> info replication</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># Replication</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>role:master</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>connected_slaves:2</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>slave0:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.102,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">616</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>slave1:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.103,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">616</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>master_replid:93df7cd5095dcccdbf8266787031b17cf638a2ad</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>master_replid2:0000000000000000000000000000000000000000</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>master_repl_offset:616</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>second_repl_offset:-1</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>repl_backlog_active:1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>repl_backlog_first_byte_offset:1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>repl_backlog_histlen:616</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\">#从节点</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.103 -a Superman*2023</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>Warning: Using a password with <span class=\"token string\">'-a'</span> or <span class=\"token string\">'-u'</span> option on the <span class=\"token builtin class-name\">command</span> line interface may not be safe.</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> info replication</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># Replication</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>role:slave</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>master_host:192.168.40.101</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>master_port:6379</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>master_link_status:up</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>master_last_io_seconds_ago:1</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>master_sync_in_progress:0</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>slave_read_repl_offset:812</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>slave_repl_offset:812</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>slave_priority:100</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>slave_read_only:1</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>replica_announced:1</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>connected_slaves:0</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>master_replid:93df7cd5095dcccdbf8266787031b17cf638a2ad</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>master_replid2:0000000000000000000000000000000000000000</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>master_repl_offset:812</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>second_repl_offset:-1</pre></td></tr><tr><td data-num=\"41\"></td><td><pre>repl_backlog_active:1</pre></td></tr><tr><td data-num=\"42\"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>repl_backlog_first_byte_offset:295</pre></td></tr><tr><td data-num=\"44\"></td><td><pre>repl_backlog_histlen:518</pre></td></tr></table></figure><h4 id=\"37-测试主从\"><a class=\"anchor\" href=\"#37-测试主从\">#</a> 3.7 测试主从</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.101 -a Superman*2023</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>Warning: Using a password with <span class=\"token string\">'-a'</span> or <span class=\"token string\">'-u'</span> option on the <span class=\"token builtin class-name\">command</span> line interface may not be safe.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> <span class=\"token builtin class-name\">set</span> k1 v1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>OK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> <span class=\"token builtin class-name\">set</span> k2 v2</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>OK</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.103 -a Superman*2023</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Warning: Using a password with <span class=\"token string\">'-a'</span> or <span class=\"token string\">'-u'</span> option on the <span class=\"token builtin class-name\">command</span> line interface may not be safe.</pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> get k1</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token string\">\"v1\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> get k2</pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token string\">\"v2\"</span></pre></td></tr></table></figure><p><strong>注意:</strong><br />\n1、主机可以写，从机不能写，只能读。主机中的所有数据都会保存到从机中去。<br />\n2、主机断开连接，从机依旧连接到主机的，但是没有写操作，这个时候，主机如果回来了，从机依旧可以直接获取到主机写的信息！<br />\n3、如果是使用命令行，来配置的主从，这个时候如果重启了，就会变回主机！只要变为从机，立马就会从主机中获取值！<br />\n4、主从复制原理<br />\n Slave 启动成功连接到 master 后会发送一个 sync 同步命令<br />\n Master 接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master 将传送整个数据文件到 slave，并完成一次完全同步。<br />\n全量复制：slave 服务在接收到数据库文件数据后，将其存盘并加载到内存中。<br />\n增量复制：Master 继续将新的所有收集到的修改命令依次传给 slave，完成同步，但是只要是重新连接 master，一次完全同步（全量复制）将被自动执行！ 主机的数据一定可以在从机中看到。</p>\n<h3 id=\"四-哨兵模式搭建\"><a class=\"anchor\" href=\"#四-哨兵模式搭建\">#</a> 四、哨兵模式搭建</h3>\n<p>1、什么是 redis 哨兵？<br />\nRedisSentinel 是 Redis 的高可用性解决方案，由一个或多个 Sentinel（哨兵）实例组成。它可以监视任意多个主服务器，以及这些主服务器属下的所有从服务器，并在被监视的主服务器进入下线状态时，自动将下线主服务器属下的某个从服务器升级为新的主服务器，它的主要功能如下：<br />\n监控 (Monitoring)：Sentinel 会不断地检查你的主服务器和从服务器是否运作正常。<br />\n通知 (Notification)：当被监控的某个 Redis 服务器出现问题时，Sentinel 可以通过 API 向管理员或者其他应用程序发送通知。<br />\n故障迁移：当主服务器不能正常工作时，Sentinel 会自动进行故障迁移，也就是主从切换。<br />\n统一的配置：管理连接者询问 sentinel 取得主从的地址。</p>\n<p>2、哨兵原理是什么？<br />\nSentinel 使用的算法核心是 Raft 算法，主要用途就是用于分布式系统，系统容错，以及 Leader 选举，每个 Sentinel 都需要定期的执行以下任务：<br />\n每个 Sentinel 会自动发现其他 Sentinel 和从服务器，它以每秒钟一次的频率向它所知的主服务器、从服务器以及其他 Sentinel 实例发送一个 PING 命令。<br />\n如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值， 那么这个实例会被 Sentinel 标记为主观下线。 有效回复可以是： +PONG 、 -LOADING 或者 -MASTERDOWN 。<br />\n如果一个主服务器被标记为主观下线， 那么正在监视这个主服务器的所有 Sentinel 要以每秒一次的频率确认主服务器的确进入了主观下线状态。<br />\n如果一个主服务器被标记为主观下线， 并且有足够数量的 Sentinel（至少要达到配置文件指定的数量）在指定的时间范围内同意这一判断，那么这个主服务器被标记为客观下线。<br />\n在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有主服务器和从服务器发送 INFO 命令。当一个主服务器 Sentinel 标记为客观下线时，Sentinel 向下线主服务器的所有从服务器发送 INFO 命令的频率会从 10 秒一次改为每秒一次。<br />\n当没有足够数量的 Sentinel 同意主服务器已经下线， 主服务器的客观下线状态就会被移除。 当主服务器重新向 Sentinel 的 PING 命令返回有效回复时， 主服务器的主管下线状态就会被移除。</p>\n<p><a href=\"https://imgse.com/i/pEgT1r6\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgT1r6.png\" alt=\"pEgT1r6.png\" /></a></p>\n<h4 id=\"41-搭建哨兵\"><a class=\"anchor\" href=\"#41-搭建哨兵\">#</a> 4.1 搭建哨兵</h4>\n<p><em>在每台服务器上部署一个哨兵，配置方式如下:</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim sentinel.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#端口默认为 26379。</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port <span class=\"token number\">26379</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\">#关闭保护模式，可以外部访问。</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>protected-mode no</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#设置为后台启动。</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>daemonize <span class=\"token function\">yes</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#日志文件。</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>logfile <span class=\"token string\">\"/soft/redis/sentinel.log\"</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#指定服务器 IP 地址和端口，并且指定当有 2 台哨兵认为主机挂了，则对主机进行容灾切换。注意：三台哨兵这里的 ip 配置均为主节点 ip 和端口</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>sentinel monitor mymaster <span class=\"token number\">192.168</span>.40.101 <span class=\"token number\">6379</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#当在 Redis 实例中开启了 requirepass，这里就需要提供密码。</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>sentinel auth-pass mymaster psw66</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\">#这里设置了主机多少秒无响应，则认为挂了。</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>sentinel down-after-milliseconds mymaster <span class=\"token number\">3000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\">#主备切换时，最多有多少个 slave 同时对新的 master 进行同步，这里设置为默认的</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>snetinel parallel-syncs mymaster <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token comment\">#故障转移的超时时间，这里设置为三分钟。</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>sentinel failover-timeout mymaster <span class=\"token number\">180000</span></pre></td></tr></table></figure><h4 id=\"42-启动三台服务器上的哨兵\"><a class=\"anchor\" href=\"#42-启动三台服务器上的哨兵\">#</a> 4.2 启动三台服务器上的哨兵</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#启动 redis01 的 sentine</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-sentinel /soft/redis/sentinel.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\">#  netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:26379           <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">33536</span>/redis-sentine </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.101:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">117358</span>/redis-server </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::26379                :::*                    LISTEN      <span class=\"token number\">33536</span>/redis-sentine</pre></td></tr><tr><td data-num=\"7\"></td><td><pre></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#启动 redis02 的 sentine</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis02 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-sentinel /soft/redis/sentinel.conf</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis02 redis<span class=\"token punctuation\">]</span><span class=\"token comment\">#  netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:26379           <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">18757</span>/redis-sentine </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.102:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">18210</span>/redis-server  </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::26379                :::*                    LISTEN      <span class=\"token number\">18757</span>/redis-sentine</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#启动 redis03 的 sentine</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-sentinel /soft/redis/sentinel.conf                     </span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp|grep redis</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:26379           <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">19745</span>/redis-sentine </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">192.168</span>.40.103:6379     <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">19186</span>/redis-server  </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::26379                :::*                    LISTEN      <span class=\"token number\">19745</span>/redis-sentine</pre></td></tr></table></figure><h4 id=\"43-连接客户端\"><a class=\"anchor\" href=\"#43-连接客户端\">#</a> 4.3 连接客户端</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 26379</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1:2637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span>  info sentinel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># Sentinel</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sentinel_masters:1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>sentinel_tilt:0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sentinel_running_scripts:0</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sentinel_scripts_queue_length:0</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>sentinel_simulate_failure_flags:0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>master0:name<span class=\"token operator\">=</span>mymaster,status<span class=\"token operator\">=</span>ok,address<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.101:6379,slaves<span class=\"token operator\">=</span><span class=\"token number\">2</span>,sentinels<span class=\"token operator\">=</span><span class=\"token number\">3</span></pre></td></tr></table></figure><h4 id=\"44-redis容灾切换\"><a class=\"anchor\" href=\"#44-redis容灾切换\">#</a> 4.4 redis 容灾切换</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#连接 redis 客户端</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.101 </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#验证密码</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> auth Superman*2023</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>OK</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#关闭 redis 服务</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> <span class=\"token function\">shutdown</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>not connected<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#退出客户端</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>not connected<span class=\"token operator\">></span> <span class=\"token builtin class-name\">exit</span></pre></td></tr></table></figure><p>关闭主节点之后，我们去查看哨兵日志:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># tail -f /soft/redis/sentinel.log </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.838 <span class=\"token comment\"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.838 <span class=\"token comment\"># Redis version=6.2.11, bits=64, commit=00000000, modified=0, pid=91936, just started</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.838 <span class=\"token comment\"># Configuration loaded</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.838 * monotonic clock: POSIX clock_gettime</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.839 * Running <span class=\"token assign-left variable\">mode</span><span class=\"token operator\">=</span>sentinel, <span class=\"token assign-left variable\">port</span><span class=\"token operator\">=</span><span class=\"token number\">26379</span>.</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.839 <span class=\"token comment\"># Sentinel ID is 835b4c8544fb250af5fd479f834ee369cc4f388e</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:26:23.839 <span class=\"token comment\"># +monitor master mymaster 192.168.40.101 6379 quorum 2</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre></pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:25.329 <span class=\"token comment\"># +sdown master mymaster 192.168.40.101 6379   #这里应该是发现主节点宕机</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:25.359 <span class=\"token comment\"># +new-epoch 5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:25.360 <span class=\"token comment\"># +vote-for-leader ab43979285cb47b1b459aeb0ab91b63fa9d1a989 5</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:25.401 <span class=\"token comment\"># +odown master mymaster 192.168.40.101 6379 #quorum 3/2 两个哨兵都觉得主节点宕机了</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:25.401 <span class=\"token comment\"># Next failover delay: I will not start a failover before Fri Apr 14 23:37:25 2023</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:26.468 <span class=\"token comment\"># +config-update-from sentinel ab43979285cb47b1b459aeb0ab91b63fa9d1a989 192.168.40.102 26379 @ mymaster 192.168.40.101 6379</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:26.468 <span class=\"token comment\"># +switch-master mymaster 192.168.40.101 6379 192.168.40.103 6379 #通过投票选举 40.103 为新的主节点</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:26.468 * +slave slave <span class=\"token number\">192.168</span>.40.102:6379 <span class=\"token number\">192.168</span>.40.102 <span class=\"token number\">6379</span> @ mymaster <span class=\"token number\">192.168</span>.40.103 <span class=\"token number\">6379</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token number\">91936</span>:X <span class=\"token number\">14</span> Apr <span class=\"token number\">2023</span> <span class=\"token number\">23</span>:31:26.469 * +slave slave <span class=\"token number\">192.168</span>.40.101:6379 <span class=\"token number\">192.168</span>.40.101 <span class=\"token number\">6379</span> @ mymaster <span class=\"token number\">192.168</span>.40.103 <span class=\"token number\">6379</span></pre></td></tr></table></figure><p>下面我们去 40.103 下查看哨兵主从切换是否成功</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis03 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-cli -p 6379 -h 192.168.40.103</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> auth Superman*2023</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>OK</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> info replication</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># Replication</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>role:master   <span class=\"token comment\"># 40.103 变成主节点了</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>connected_slaves:1   <span class=\"token comment\"># 下面的从机个数为 1</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>slave0:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.102,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">108708</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>master_replid:cf36f762dcae0c07b54f7287dc19d7ecc0d50dd3</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>master_replid2:a7de32d10b2d31f8886c84ca91dc7f055439c935</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>master_repl_offset:108851</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>second_repl_offset:59887</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>repl_backlog_active:1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>repl_backlog_first_byte_offset:1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>repl_backlog_histlen:108851</pre></td></tr></table></figure><p>重新连接挂掉的主节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\"># redis-server redis.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@redis01 redis<span class=\"token punctuation\">]</span><span class=\"token comment\">#  redis-cli -p 6379 -h 192.168.40.101</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> auth Superman*2023</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>OK</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.40.101:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> info replication</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\"># Replication</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>role:slave          <span class=\"token comment\">#主节点连接回来之后自动变成了从节点，并且成功连上了主机</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>master_host:192.168.40.103</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>master_port:6379</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>master_link_status:up</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>master_last_io_seconds_ago:1</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>master_sync_in_progress:0</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>slave_read_repl_offset:130607</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>slave_repl_offset:130607</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>slave_priority:100</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>slave_read_only:1</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>replica_announced:1</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>connected_slaves:0</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>master_replid:cf36f762dcae0c07b54f7287dc19d7ecc0d50dd3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>master_replid2:0000000000000000000000000000000000000000</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>master_repl_offset:130607</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>second_repl_offset:-1</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>repl_backlog_active:1</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>repl_backlog_first_byte_offset:126982</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>repl_backlog_histlen:3626</pre></td></tr></table></figure><p>再去主节点确认一下</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token number\">192.168</span>.40.103:637<span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>></span> info replication</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># Replication</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>role:master</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>connected_slaves:2   <span class=\"token comment\">#两个从节点</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>slave0:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.102,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">147879</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>slave1:ip<span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.40.101,port<span class=\"token operator\">=</span><span class=\"token number\">6379</span>,state<span class=\"token operator\">=</span>online,offset<span class=\"token operator\">=</span><span class=\"token number\">147879</span>,lag<span class=\"token operator\">=</span><span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>master_failover_state:no-failover</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>master_replid:cf36f762dcae0c07b54f7287dc19d7ecc0d50dd3</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>master_replid2:a7de32d10b2d31f8886c84ca91dc7f055439c935</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>master_repl_offset:148165</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>second_repl_offset:59887</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>repl_backlog_active:1</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>repl_backlog_size:1048576</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>repl_backlog_first_byte_offset:1</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>repl_backlog_histlen:148165</pre></td></tr></table></figure><p>五、哨兵模式的优缺点<br />\n 1. 优点</p>\n<p>哨兵集群，基于主从复制模式，所有的主从配置优点，它全有</p>\n<p>主从可以切换，故障可以转移，系统的可用性就会更好</p>\n<p>哨兵模式就是主从模式的升级，手动到自动，更加健壮！</p>\n<p>2. 缺点</p>\n<p>Redis 不好在线扩容，集群容量一旦到达上限，在线扩容就十分麻烦</p>\n<p>哨兵模式的配置繁琐</p>\n<p>3. 哨兵模式的配置文件详解</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># Example sentinel.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 哨兵 sentinel 实例运行的端口 默认 26379</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>port <span class=\"token number\">26379</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre> </pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\"># 哨兵 sentinel 的工作目录</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token function\">dir</span> /tmp</pre></td></tr><tr><td data-num=\"7\"></td><td><pre> </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\"># 哨兵 sentinel 监控的 redis 主节点的 ip port</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\"># master-name 可以自己命名的主节点名字 只能由字母 A-z、数字 0-9 、这三个字符 \".-_\" 组成。</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\"># quorum 配置多少个 sentinel 哨兵统一认为 master 主节点失联 那么这时客观上认为主节点失联了</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\"># sentinel monitor &lt;master-name> &lt;ip> &lt;redis-port> &lt;quorum></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>sentinel monitor mymaster <span class=\"token number\">127.0</span>.0.1 <span class=\"token number\">6379</span> <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token comment\"># 当在 Redis 实例中开启了 requirepass foobared 授权密码这样所有连接 Redis 实例的客户端都要提供 密码</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\"># 设置哨兵 sentinel 连接主从的密码 注意必须为主从设置一样的验证密码</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token comment\"># sentinel auth-pass &lt;master-name> &lt;password></span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>sentinel auth-pass mymaster MySUPER--secret-0123passw0rd</pre></td></tr><tr><td data-num=\"18\"></td><td><pre> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 指定多少毫秒之后 主节点没有应答哨兵 sentinel 此时哨兵主观上认为主节点下线 默认 30 秒</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\"># sentinel down-after-milliseconds &lt;master-name> &lt;milliseconds></span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>sentinel down-after-milliseconds mymaster <span class=\"token number\">30000</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre> </pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\"># 这个配置项指定了在发生 failover 主备切换时最多可以有多少个 slave 同时对新的 master 进行同步，这个数字越小，完成 failover 所需的时间就越长， 但是如果这个数字越大，就意味着越 多的 slave 因为 replication 而不可用。 可以通过将这个值设为 1 来保证每次只有一个 slave 处于不能处理命令请求的状态。</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token comment\"># sentinel parallel-syncs &lt;master-name> &lt;numslaves></span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>sentinel parallel-syncs mymaster <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre> </pre></td></tr><tr><td data-num=\"27\"></td><td><pre><span class=\"token comment\"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面：</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre><span class=\"token comment\">#1. 同一个 sentinel 对同一个 master 两次 failover 之间的间隔时间。</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#2. 当一个 slave 从一个错误的 master 那里同步数据开始计算时间。直到 slave 被纠正为向正确的 master 那 里同步数据时。</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token comment\">#3. 当想要取消一个正在进行的 failover 所需要的时间。</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token comment\">#4. 当进行 failover 时，配置所有 slaves 指向新的 master 所需的最大时间。不过，即使过了这个超时， slaves 依然会被正确配置为指向 master，但是就不按 parallel-syncs 所配置的规则来了 # 默认三分钟</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token comment\"># sentinel failover-timeout &lt;master-name> &lt;milliseconds> bilibili：</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>sentinel failover-timeout mymaster <span class=\"token number\">180000</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre> </pre></td></tr><tr><td data-num=\"35\"></td><td><pre><span class=\"token comment\"># SCRIPTS EXECUTION</span></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知 相关人员。</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token comment\">#对于脚本的运行结果有以下规则：</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token comment\">#若脚本执行后返回 1，那么该脚本稍后将会被再次执行，重复次数目前默认为 10</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre><span class=\"token comment\">#若脚本执行后返回 2，或者比 2 更高的一个返回值，脚本将不会重复执行。</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token comment\">#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为 1 时的行为相同。</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token comment\">#一个脚本的最大执行时间为 60s，如果超过这个时间，脚本将会被一个 SIGKILL 信号终止，之后重新执行。</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre><span class=\"token comment\">#通知型脚本：当 sentinel 有任何警告级别的事件发生时（比如说 redis 实例的主观失效和客观失效等等）， 将会去调用这个脚本，这时这个脚本应该通过邮件，SMS 等方式去通知系统管理员关于系统不正常运行的信 息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果 sentinel.conf 配 置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则 sentinel 无 法正常启动成功。</span></pre></td></tr><tr><td data-num=\"43\"></td><td><pre><span class=\"token comment\">#通知脚本</span></pre></td></tr><tr><td data-num=\"44\"></td><td><pre><span class=\"token comment\"># shell 编程</span></pre></td></tr><tr><td data-num=\"45\"></td><td><pre><span class=\"token comment\"># sentinel notification-script &lt;master-name> &lt;script-path> sentinel</span></pre></td></tr><tr><td data-num=\"46\"></td><td><pre>notification-script mymaster /var/redis/notify.sh</pre></td></tr><tr><td data-num=\"47\"></td><td><pre> </pre></td></tr><tr><td data-num=\"48\"></td><td><pre><span class=\"token comment\"># 客户端重新配置主节点参数脚本</span></pre></td></tr><tr><td data-num=\"49\"></td><td><pre><span class=\"token comment\"># 当一个 master 由于 failover 而发生改变时，这个脚本将会被调用，通知相关的客户端关于 master 地址已 经发生改变的信息。</span></pre></td></tr><tr><td data-num=\"50\"></td><td><pre><span class=\"token comment\"># 以下参数将会在调用脚本时传给脚本:</span></pre></td></tr><tr><td data-num=\"51\"></td><td><pre><span class=\"token comment\"># &lt;master-name> &lt;role> &lt;state> &lt;from-ip> &lt;from-port> &lt;to-ip> &lt;to-port> # 目前 & lt;state > 总是 “failover”,</span></pre></td></tr><tr><td data-num=\"52\"></td><td><pre><span class=\"token comment\"># &lt;role > 是 “leader” 或者 “observer” 中的一个。</span></pre></td></tr><tr><td data-num=\"53\"></td><td><pre><span class=\"token comment\"># 参数 from-ip, from-port, to-ip, to-port 是用来和旧的 master 和新的 master (即旧的 slave) 通 信的# 这个脚本应该是通用的，能被多次调用，不是针对性的。</span></pre></td></tr><tr><td data-num=\"54\"></td><td><pre><span class=\"token comment\"># sentinel client-reconfig-script &lt;master-name> &lt;script-path> sentinel client-reconfig-</span></pre></td></tr><tr><td data-num=\"55\"></td><td><pre>script mymaster /var/redis/reconfig.shb</pre></td></tr></table></figure><p><em>再去看一下 redis 的配置文件和哨兵的配置文件，你会惊讶的发现，里边的配置文件已经被改过来了。</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> redis.con</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>replicaof <span class=\"token number\">192.168</span>.40.103 <span class=\"token number\">6379</span></pre></td></tr></table></figure>",
            "tags": [
                "Redis"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3166738000.html",
            "url": "http://ixuyong.cn/posts/3166738000.html",
            "title": "Kubeadm高可用安装K8s集群",
            "date_published": "2025-04-09T10:28:34.000Z",
            "content_html": "<h2 id=\"kubeadm高可用安装k8s集群\"><a class=\"anchor\" href=\"#kubeadm高可用安装k8s集群\">#</a> Kubeadm 高可用安装 K8s 集群</h2>\n<h4 id=\"1-基本配置\"><a class=\"anchor\" href=\"#1-基本配置\">#</a> 1. 基本配置</h4>\n<h5 id=\"11-基本环境配置\"><a class=\"anchor\" href=\"#11-基本环境配置\">#</a> 1.1 基本环境配置</h5>\n<table>\n<thead>\n<tr>\n<th>主机名</th>\n<th>IP 地址</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>k8s-master01 ~ 03</td>\n<td>192.168.1.71 ~ 73</td>\n<td>master 节点 * 3</td>\n</tr>\n<tr>\n<td>/</td>\n<td>192.168.1.70</td>\n<td>keepalived 虚拟 IP（不占用机器）</td>\n</tr>\n<tr>\n<td>k8s-node01 ~ 02</td>\n<td>192.168.1.74/75</td>\n<td>worker 节点 * 2</td>\n</tr>\n</tbody>\n</table>\n<p><em>请统一替换这些网段，Pod 网段和 service 和宿主机网段不要重复！！！</em></p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 配置信息 *</strong></em></th>\n<th>备注</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>系统版本</td>\n<td>Rocky Linux 8/9</td>\n</tr>\n<tr>\n<td>Containerd</td>\n<td>latest</td>\n</tr>\n<tr>\n<td>Pod 网段</td>\n<td>172.16.0.0/16</td>\n</tr>\n<tr>\n<td>Service 网段</td>\n<td>10.96.0.0/16</td>\n</tr>\n</tbody>\n</table>\n<p><mark>所有节点</mark>更改主机名（其它节点按需修改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>hostnamectl set-hostname k8s-master01</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 hosts，修改 /etc/hosts 如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/hosts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token number\">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">192.168</span>.1.71 k8s-master01</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">192.168</span>.1.72 k8s-master02</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">192.168</span>.1.73 k8s-master03</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">192.168</span>.1.74 k8s-node01</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">192.168</span>.1.75 k8s-node02</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 yum 源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># 配置基础源</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^mirrorlist=|#mirrorlist=|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g'</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    <span class=\"token parameter variable\">-i.bak</span> <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    /etc/yum.repos.d/*.repo</pre></td></tr><tr><td data-num=\"6\"></td><td><pre></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>yum makecache</pre></td></tr></table></figure><p><mark>所有节点</mark>必备工具安装：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> rsyslog <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>关闭防火墙、selinux、dnsmasq、swap、开启 rsyslog。服务器配置如下：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> firewalld </pre></td></tr><tr><td data-num=\"2\"></td><td><pre>systemctl disable <span class=\"token parameter variable\">--now</span> dnsmasq</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>setenforce <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/sysconfig/selinux</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SELINUX=enforcing#SELINUX=disabled#g'</span> /etc/selinux/config</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> rsyslog</pre></td></tr></table></figure><p><mark>所有节点</mark>关闭 swap 分区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>swapoff <span class=\"token parameter variable\">-a</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">-w</span> <span class=\"token assign-left variable\">vm.swappiness</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-ri</span> <span class=\"token string\">'/^[^#]*swap/s@^@#@'</span> /etc/fstab</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 ntpdate：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> epel-release <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sudo</span> dnf config-manager --set-enabled epel</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sudo</span> dnf <span class=\"token function\">install</span> ntpsec</pre></td></tr></table></figure><p><mark>所有节点</mark>同步时间并配置上海时区：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">ln</span> <span class=\"token parameter variable\">-sf</span> /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">'Asia/Shanghai'</span> <span class=\"token operator\">></span>/etc/timezone</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ntpdate time2.aliyun.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token comment\"># 加入到 crontab</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token function\">crontab</span> <span class=\"token parameter variable\">-e</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com</pre></td></tr></table></figure><p><mark>所有节点</mark>配置 limit：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">ulimit</span> <span class=\"token parameter variable\">-SHn</span> <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">vim</span> /etc/security/limits.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># 末尾添加如下内容</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>* soft nofile <span class=\"token number\">65536</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>* hard nofile <span class=\"token number\">131072</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>* soft nproc <span class=\"token number\">65535</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>* hard nproc <span class=\"token number\">655350</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>* soft memlock unlimited</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>* hard memlock unlimited</pre></td></tr></table></figure><p><mark>所有节点</mark>升级系统：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum update <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>Master01 节点</mark>免密钥登录其他节点，安装过程中生成配置文件和证书均在 Master01 上操作，集群管理也在 Master01 上操作：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>ssh-keygen <span class=\"token parameter variable\">-t</span> rsa</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02<span class=\"token punctuation\">;</span><span class=\"token keyword\">do</span> ssh-copy-id <span class=\"token parameter variable\">-i</span> .ssh/id_rsa.pub <span class=\"token variable\">$i</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">done</span></pre></td></tr></table></figure><p><em>注意：公有云环境，可能需要把 kubectl 放在一个非 Master 节点上</em></p>\n<p><mark>Master01 节点</mark>下载安装所有的源码文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/ <span class=\"token punctuation\">;</span> <span class=\"token function\">git</span> clone https://gitee.com/chinagei/k8s-ha-install</pre></td></tr></table></figure><h5 id=\"12-内核配置\"><a class=\"anchor\" href=\"#12-内核配置\">#</a> 1.2 内核配置</h5>\n<p><mark>所有节点</mark>安装 ipvsadm：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> ipvsadm ipset sysstat conntrack libseccomp <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 ipvs 模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>modprobe -- ip_vs</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>modprobe -- ip_vs_rr</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>modprobe -- ip_vs_wrr</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>modprobe -- ip_vs_sh</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>modprobe -- nf_conntrack</pre></td></tr></table></figure><p><mark>所有节点</mark>创建 ipvs.conf，并配置开机自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> /etc/modules-load.d/ipvs.conf </pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># 加入以下内容</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>ip_vs</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>ip_vs_lc</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>ip_vs_wlc</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>ip_vs_rr</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>ip_vs_wrr</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>ip_vs_lblc</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>ip_vs_lblcr</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ip_vs_dh</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>ip_vs_fo</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>ip_vs_nq</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>ip_vs_sed</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>ip_vs_ftp</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>ip_vs_sh</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>nf_conntrack</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>ip_tables</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>ip_set</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>xt_set</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>ipt_set</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>ipt_rpfilter</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>ipt_REJECT</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>ipip</pre></td></tr></table></figure><p><mark>所有节点</mark>然后执行 systemctl enable --now systemd-modules-load.service 即可（报错不用管）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>systemctl <span class=\"token builtin class-name\">enable</span> <span class=\"token parameter variable\">--now</span> systemd-modules-load.service</pre></td></tr></table></figure><p><mark>所有节点</mark>内核优化配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">></span> /etc/sysctl.d/k8s.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.ipv4.ip_forward = 1</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.bridge.bridge-nf-call-iptables = 1</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables = 1</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>fs.may_detach_mounts = 1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>net.ipv4.conf.all.route_localnet = 1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>vm.overcommit_memory=1</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>vm.panic_on_oom=0</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>fs.inotify.max_user_watches=89100</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>fs.file-max=52706963</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>fs.nr_open=52706963</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>net.netfilter.nf_conntrack_max=2310720</pre></td></tr><tr><td data-num=\"13\"></td><td><pre></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>net.ipv4.tcp_keepalive_time = 600</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>net.ipv4.tcp_keepalive_probes = 3</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>net.ipv4.tcp_keepalive_intvl =15</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>net.ipv4.tcp_max_tw_buckets = 36000</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>net.ipv4.tcp_tw_reuse = 1</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>net.ipv4.tcp_max_orphans = 327680</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>net.ipv4.tcp_orphan_retries = 3</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>net.ipv4.tcp_syncookies = 1</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>net.ipv4.ip_conntrack_max = 65536</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>net.ipv4.tcp_max_syn_backlog = 16384</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>net.ipv4.tcp_timestamps = 0</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>net.core.somaxconn = 16384</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p><mark>所有节点</mark>应用配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sysctl</span> <span class=\"token parameter variable\">--system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置完内核后，重启机器，之后查看内核模块是否已自动加载：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">reboot</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>lsmod <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">--color</span><span class=\"token operator\">=</span>auto <span class=\"token parameter variable\">-e</span> ip_vs <span class=\"token parameter variable\">-e</span> nf_conntrack</pre></td></tr></table></figure><h4 id=\"2-高可用组件安装\"><a class=\"anchor\" href=\"#2-高可用组件安装\">#</a> 2. 高可用组件安装</h4>\n<p><em>注意：如果安装的不是高可用集群，haproxy 和 keepalived 无需安装</em></p>\n<p><em>注意：公有云要用公有云自带的负载均衡，比如阿里云的 SLB、NLB，腾讯云的 ELB，用来替代 haproxy 和 keepalived，因为公有云大部分都是不支持 keepalived 的。</em></p>\n<p><mark>所有 Master 节点</mark>通过 yum 安装 HAProxy 和 KeepAlived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> keepalived haproxy <span class=\"token parameter variable\">-y</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 HAProxy，需要注意黄色部分的 IP：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/haproxy</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/haproxy/haproxy.cfg </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>global</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  maxconn  <span class=\"token number\">2000</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  ulimit-n  <span class=\"token number\">16384</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  log  <span class=\"token number\">127.0</span>.0.1 local0 err</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  stats <span class=\"token function\">timeout</span> 30s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>defaults</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  log global</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  mode  http</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>  option  httplog</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  <span class=\"token function\">timeout</span> connect <span class=\"token number\">5000</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  <span class=\"token function\">timeout</span> client  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  <span class=\"token function\">timeout</span> server  <span class=\"token number\">50000</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  <span class=\"token function\">timeout</span> http-request 15s</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">timeout</span> http-keep-alive 15s</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>frontend monitor-in</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> *:33305</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>  mode http</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>  option httplog</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  monitor-uri /monitor</pre></td></tr><tr><td data-num=\"24\"></td><td><pre></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>frontend k8s-master</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">0.0</span>.0.0:16443       <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>  <span class=\"token builtin class-name\">bind</span> <span class=\"token number\">127.0</span>.0.1:16443     <span class=\"token comment\">#HAProxy 监听端口</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"30\"></td><td><pre>  tcp-request inspect-delay 5s</pre></td></tr><tr><td data-num=\"31\"></td><td><pre>  default_backend k8s-master</pre></td></tr><tr><td data-num=\"32\"></td><td><pre></pre></td></tr><tr><td data-num=\"33\"></td><td><pre>backend k8s-master</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>  mode tcp</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>  option tcplog</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>  option tcp-check</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>  balance roundrobin</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  default-server inter 10s downinter 5s rise <span class=\"token number\">2</span> fall <span class=\"token number\">2</span> slowstart 60s maxconn <span class=\"token number\">250</span> maxqueue <span class=\"token number\">256</span> weight <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  server k8s-master01\t<span class=\"token number\">192.168</span>.1.71:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  server k8s-master02\t<span class=\"token number\">192.168</span>.1.72:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>  server k8s-master03\t<span class=\"token number\">192.168</span>.1.73:6443  check       <span class=\"token comment\">#API Server IP 地址</span></pre></td></tr></table></figure><p><mark>所有 Master 节点</mark>配置 KeepAlived，需要注意黄色部分的配置。</p>\n<p><mark>Master01 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 etc<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /etc/keepalived</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    state MASTER</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    interface ens160               <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.71      <span class=\"token comment\">#K8s-master01 IP 地址</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    priority <span class=\"token number\">101</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70        <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master02 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>   interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.72       <span class=\"token comment\">#K8s-master02 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70              <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>Master03 节点</mark>的配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/keepalived/keepalived.conf </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token operator\">!</span> Configuration File <span class=\"token keyword\">for</span> keepalived</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>global_defs <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    router_id LVS_DEVEL</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>script_user root</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    enable_script_security</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>vrrp_script chk_apiserver <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>    script <span class=\"token string\">\"/etc/keepalived/check_apiserver.sh\"</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre> interval <span class=\"token number\">5</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    weight <span class=\"token parameter variable\">-5</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>    fall <span class=\"token number\">2</span>  </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>rise <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre>vrrp_instance VI_1 <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>    state BACKUP</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>    interface ens160                 <span class=\"token comment\">#网卡名称</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    mcast_src_ip <span class=\"token number\">192.168</span>.1.73        <span class=\"token comment\">#K8s-master03 IP 地址</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    virtual_router_id <span class=\"token number\">51</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    priority <span class=\"token number\">100</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>    advert_int <span class=\"token number\">2</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    authentication <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        auth_type PASS</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>        auth_pass K8SHA_KA_AUTH</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>    virtual_ipaddress <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>        <span class=\"token number\">192.168</span>.1.70          <span class=\"token comment\">#VIP 地址</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    track_script <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>       chk_apiserver</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置 KeepAlived 健康检查文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/keepalived/check_apiserver.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">k</span> <span class=\"token keyword\">in</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">seq</span> <span class=\"token number\">1</span> <span class=\"token number\">3</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">do</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    <span class=\"token assign-left variable\">check_code</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span>pgrep haproxy<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$check_code</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">expr</span> $err + <span class=\"token number\">1</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        <span class=\"token function\">sleep</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>        <span class=\"token builtin class-name\">continue</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>    <span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        <span class=\"token assign-left variable\">err</span><span class=\"token operator\">=</span><span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        <span class=\"token builtin class-name\">break</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>    <span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">done</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">[</span> <span class=\"token variable\">$err</span> <span class=\"token operator\">!=</span> <span class=\"token string\">\"0\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"systemctl stop keepalived\"</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    /usr/bin/systemctl stop keepalived</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr></table></figure><p><mark>所有 master 节点</mark>配置健康检查文件添加执行权限：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">chmod</span> +x /etc/keepalived/check_apiserver.sh</pre></td></tr></table></figure><p><mark>所有 master 节点</mark>启动 haproxy 和 keepalived：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now haproxy</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 keepalived<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable --now keepalived</span></pre></td></tr></table></figure><p>重要：如果安装了 keepalived 和 haproxy，需要测试 keepalived 是否是正常的</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>所有节点测试VIP</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ping 192.168.1.70 -c 4</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>PING <span class=\"token number\">192.168</span>.1.70 <span class=\"token punctuation\">(</span><span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.464</span> ms</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.062</span> ms</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">64</span> bytes from <span class=\"token number\">192.168</span>.1.70: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">4</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.063</span> ms</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># telnet 192.168.1.70 16443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>Trying <span class=\"token number\">192.168</span>.1.70<span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>Connected to <span class=\"token number\">192.168</span>.1.70.</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>Escape character is <span class=\"token string\">'^]'</span><span class=\"token builtin class-name\">.</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>Connection closed by foreign host.</pre></td></tr></table></figure><p>如果 ping 不通且 telnet 没有出现 ] ，则认为 VIP 不可以，不可在继续往下执行，需要排查 keepalived 的问题，比如防火墙和 selinux，haproxy 和 keepalived 的状态，监听端口等</p>\n<ul>\n<li>所有节点查看防火墙状态必须为 disable 和 inactive：systemctl status firewalld</li>\n<li>所有节点查看 selinux 状态，必须为 disable：getenforce</li>\n<li>master 节点查看 haproxy 和 keepalived 状态：systemctl status keepalived haproxy</li>\n<li>master 节点查看监听端口：netstat -lntp</li>\n</ul>\n<p>如果以上都没有问题，需要确认：</p>\n<ol>\n<li>\n<p>是否是公有云机器</p>\n</li>\n<li>\n<p>是否是私有云机器（类似 OpenStack）</p>\n</li>\n</ol>\n<p>上述公有云一般都是不支持 keepalived，私有云可能也有限制，需要和自己的私有云管理员咨询</p>\n<h4 id=\"3-runtime安装\"><a class=\"anchor\" href=\"#3-runtime安装\">#</a> 3. Runtime 安装</h4>\n<p>如果安装的版本低于 1.24，选择 Docker 和 Containerd 均可，高于 1.24 建议选择 Containerd 作为 Runtime，不再推荐使用 Docker 作为 Runtime。</p>\n<h5 id=\"31-安装containerd\"><a class=\"anchor\" href=\"#31-安装containerd\">#</a> 3.1 安装 Containerd</h5>\n<p><mark>所有节点</mark>配置安装源：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>yum <span class=\"token function\">install</span> <span class=\"token function\">wget</span> jq psmisc <span class=\"token function\">vim</span> net-tools telnet yum-utils device-mapper-persistent-data lvm2 <span class=\"token function\">git</span> <span class=\"token parameter variable\">-y</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</pre></td></tr></table></figure><p><mark>所有节点</mark>安装 docker-ce（如果在以前已经安装过，需要重新安装更新一下）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install docker-ce containerd -y</span></pre></td></tr></table></figure><p><em>可以无需启动 Docker，只需要配置和启动 Containerd 即可。</em></p>\n<p>首先配置 Containerd 所需的模块（<mark>所有节点</mark>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>overlay</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>br_netfilter</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载模块：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># modprobe -- overlay</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># modprobe -- br_netfilter</span></pre></td></tr></table></figure><p><mark>所有节点</mark>，配置 Containerd 所需的内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>net.bridge.bridge-nf-call-iptables  <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>net.ipv4.ip_forward                 <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>net.bridge.bridge-nf-call-ip6tables <span class=\"token operator\">=</span> <span class=\"token number\">1</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>EOF</pre></td></tr></table></figure><p><mark>所有节点</mark>加载内核：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sysctl --system</span></pre></td></tr></table></figure><p><mark>所有节点</mark>生成 Containerd 的配置文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># mkdir -p /etc/containerd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># containerd config default | tee /etc/containerd/config.toml</span></pre></td></tr></table></figure><p><mark>所有节点</mark>更改 Containerd 的 Cgroup 和 Pause 镜像配置：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#SystemdCgroup = false#SystemdCgroup = true#g'</span> /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#k8s.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.gcr.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">'s#registry.k8s.io/pause#registry.cn-hangzhou.aliyuncs.com/google_containers/pause#g'</span>  /etc/containerd/config.toml</pre></td></tr></table></figure><p><mark>所有节点</mark>启动 Containerd，并配置开机自启动：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now containerd</span></pre></td></tr></table></figure><p><mark>所有节点</mark>配置 crictl 客户端连接的运行时位置（可选）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># cat > /etc/crictl.yaml &lt;&lt;EOF</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>runtime-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>image-endpoint: unix:///run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>timeout: <span class=\"token number\">10</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>debug: <span class=\"token boolean\">false</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>EOF</pre></td></tr></table></figure><h4 id=\"4-安装kubernetes组件\"><a class=\"anchor\" href=\"#4-安装kubernetes组件\">#</a> 4 . 安装 Kubernetes 组件</h4>\n<p><mark>所有节点</mark>配置源（注意更改版本号）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">|</span> <span class=\"token function\">tee</span> /etc/yum.repos.d/kubernetes.repo</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[kubernetes]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>name=Kubernetes</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>enabled=1</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>gpgcheck=1</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.32/rpm/repodata/repomd.xml.key</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>EOF</span></pre></td></tr></table></figure><p>首先在<mark> Master01 节点</mark>查看最新的 Kubernetes 版本是多少：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum list kubeadm.x86_64 --showduplicates | sort -r</span></pre></td></tr></table></figure><p><mark>所有节点</mark>安装 1.32 最新版本 kubeadm、kubelet 和 kubectl：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># yum install kubeadm-1.32* kubelet-1.32* kubectl-1.32* -y</span></pre></td></tr></table></figure><p><mark>所有节点</mark>设置 Kubelet 开机自启动（由于还未初始化，没有 kubelet 的配置文件，此时 kubelet 无法启动，无需关心）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now kubelet</span></pre></td></tr></table></figure><p><em>此时 kubelet 是起不来的，日志会有报错不影响！</em></p>\n<h4 id=\"5-集群初始化\"><a class=\"anchor\" href=\"#5-集群初始化\">#</a> 5 . 集群初始化</h4>\n<p>以下操作在<mark> master01</mark>（注意黄色部分）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">vim</span> kubeadm-config.yaml</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>apiVersion: kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>bootstrapTokens:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>- groups:</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  - system:bootstrappers:kubeadm:default-node-token</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  token: 7t2weq.bjbawausm0jaxury</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  ttl: 24h0m0s</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>  usages:</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>  - signing</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>  - authentication</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>kind: InitConfiguration</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>localAPIEndpoint:</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>  advertiseAddress: <span class=\"token number\">192.168</span>.1.71</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>  bindPort: <span class=\"token number\">6443</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>nodeRegistration:</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>  criSocket: unix:///var/run/containerd/containerd.sock</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  name: k8s-master01</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  taints:</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>  - effect: NoSchedule</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>    key: node-role.kubernetes.io/control-plane</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>---</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>apiServer:</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>  certSANs:</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>  - <span class=\"token number\">192.168</span>.1.70               <span class=\"token comment\"># 如果搭建的不是高可用集群，把此处改为 master 的 IP</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>  timeoutForControlPlane: 4m0s</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>apiVersion: kubeadm.k8s.io/v1beta3</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>certificatesDir: /etc/kubernetes/pki</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>clusterName: kubernetes</pre></td></tr><tr><td data-num=\"29\"></td><td><pre>controlPlaneEndpoint: <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token comment\"># 如果搭建的不是高可用集群，把此处 IP 改为 master 的 IP，端口改成 6443</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>controllerManager: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>etcd:</pre></td></tr><tr><td data-num=\"32\"></td><td><pre>  local:</pre></td></tr><tr><td data-num=\"33\"></td><td><pre>    dataDir: /var/lib/etcd</pre></td></tr><tr><td data-num=\"34\"></td><td><pre>imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</pre></td></tr><tr><td data-num=\"35\"></td><td><pre>kind: ClusterConfiguration</pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kubernetesVersion: v1.32.3    <span class=\"token comment\"># 更改此处的版本号和 kubeadm version 一致</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre>networking:</pre></td></tr><tr><td data-num=\"38\"></td><td><pre>  dnsDomain: cluster.local</pre></td></tr><tr><td data-num=\"39\"></td><td><pre>  podSubnet: <span class=\"token number\">172.16</span>.0.0/16    <span class=\"token comment\"># 注意此处的网段，不要与 service 和节点网段冲突</span></pre></td></tr><tr><td data-num=\"40\"></td><td><pre>  serviceSubnet: <span class=\"token number\">10.96</span>.0.0/16 <span class=\"token comment\"># 注意此处的网段，不要与 pod 和节点网段冲突</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre>scheduler: <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><p><mark>master01 节点</mark>更新 kubeadm 文件：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm config migrate --old-config kubeadm-config.yaml --new-config new.yaml</pre></td></tr></table></figure><p>将 new.yaml 文件复制到<mark>其他 master 节点</mark>:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> k8s-master02 k8s-master03<span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span> <span class=\"token function\">scp</span> new.yaml <span class=\"token variable\">$i</span>:/root/<span class=\"token punctuation\">;</span> <span class=\"token keyword\">done</span></pre></td></tr></table></figure><p>之后<mark>所有 Master 节点</mark>提前下载镜像，可以节省初始化时间（其他节点不需要更改任何配置，包括 IP 地址也不需要更改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm config images pull <span class=\"token parameter variable\">--config</span> /root/new.yaml</pre></td></tr></table></figure><p>正确的反馈信息如下（<em><strong>* 版本可能不一样 *</strong></em>）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master02 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubeadm config images pull --config /root/new.yaml </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.32.0</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.32.0</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.32.0</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.32.0</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.11.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.10</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>config/images<span class=\"token punctuation\">]</span> Pulled registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.16-0</pre></td></tr></table></figure><p><mark>Master01 节点</mark>初始化，初始化以后会在 /etc/kubernetes 目录下生成对应的证书和配置文件，之后其他 Master 节点加入 Master01 即可：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm init <span class=\"token parameter variable\">--config</span> /root/new.yaml  --upload-certs</pre></td></tr></table></figure><p>初始化成功以后，会产生 Token 值，用于其他节点加入时使用，因此要记录下初始化成功生成的 token 值（令牌值）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>Your Kubernetes control-plane has initialized successfully<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>To start using your cluster, you need to run the following as a regular user:</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>  <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token environment constant\">$HOME</span>/.kube</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>  <span class=\"token function\">sudo</span> <span class=\"token function\">cp</span> <span class=\"token parameter variable\">-i</span> /etc/kubernetes/admin.conf <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>  <span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> <span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-u</span><span class=\"token variable\">)</span></span><span class=\"token builtin class-name\">:</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">id</span> <span class=\"token parameter variable\">-g</span><span class=\"token variable\">)</span></span> <span class=\"token environment constant\">$HOME</span>/.kube/config</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>Alternatively, <span class=\"token keyword\">if</span> you are the root user, you can run:</pre></td></tr><tr><td data-num=\"10\"></td><td><pre></pre></td></tr><tr><td data-num=\"11\"></td><td><pre>  <span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">KUBECONFIG</span><span class=\"token operator\">=</span>/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>You should now deploy a pod network to the cluster.</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>Run <span class=\"token string\">\"kubectl apply -f [podnetwork].yaml\"</span> with one of the options listed at:</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>  https://kubernetes.io/docs/concepts/cluster-administration/addons/</pre></td></tr><tr><td data-num=\"16\"></td><td><pre></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>You can now <span class=\"token function\">join</span> any number of the control-plane <span class=\"token function\">node</span> running the following <span class=\"token builtin class-name\">command</span> on each as root:</pre></td></tr><tr><td data-num=\"18\"></td><td><pre></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token comment\"># 不要复制文档当中的，要去使用节点生成的</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>  kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>\t--control-plane --certificate-key c595f7f4a7a3beb0d5bdb75d9e4eff0a60b977447e76c1d6885e82c3aa43c94c</pre></td></tr><tr><td data-num=\"23\"></td><td><pre></pre></td></tr><tr><td data-num=\"24\"></td><td><pre>Please note that the certificate-key gives access to cluster sensitive data, keep it secret<span class=\"token operator\">!</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>As a safeguard, uploaded-certs will be deleted <span class=\"token keyword\">in</span> two hours<span class=\"token punctuation\">;</span> If necessary, you can use</pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token string\">\"kubeadm init phase upload-certs --upload-certs\"</span> to reload certs afterward.</pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>Then you can <span class=\"token function\">join</span> any number of worker nodes by running the following on each as root:</pre></td></tr><tr><td data-num=\"29\"></td><td><pre></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94</pre></td></tr></table></figure><p><mark>Master01 节点</mark>配置环境变量，用于访问 Kubernetes 集群：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF<span class=\"token bash punctuation\"> <span class=\"token operator\">>></span> /root/.bashrc</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>export KUBECONFIG=/etc/kubernetes/admin.conf</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">source</span> /root/.bashrc</pre></td></tr></table></figure><p><mark>Master01 节点</mark>查看节点状态：（显示 NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   24s   v1.32.3</pre></td></tr></table></figure><p>采用初始化安装方式，所有的系统组件均以容器的方式运行并且在 kube-system 命名空间内，此时可以查看 Pod 状态（显示 pending 不影响）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get pods -n kube-system</span></pre></td></tr></table></figure><h5 id=\"51-初始化失败排查\"><a class=\"anchor\" href=\"#51-初始化失败排查\">#</a> 5.1 初始化失败排查</h5>\n<p>如果初始化失败，重置后再次初始化，命令如下（没有失败不要执行）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm reset <span class=\"token parameter variable\">-f</span> <span class=\"token punctuation\">;</span> ipvsadm <span class=\"token parameter variable\">--clear</span>  <span class=\"token punctuation\">;</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> ~/.kube</pre></td></tr></table></figure><p>如果多次尝试都是初始化失败，需要看系统日志，CentOS/RockyLinux 日志路径:/var/log/messages，Ubuntu 系列日志路径:/var/log/syslog：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">tail</span> <span class=\"token parameter variable\">-f</span> /var/log/messages <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"not found\"</span></pre></td></tr></table></figure><p>经常出错的原因：</p>\n<ol>\n<li>Containerd 的配置文件修改的不对，自行参考《安装 containerd》小节核对</li>\n<li>new.yaml 配置问题，比如非高可用集群忘记修改 16443 端口为 6443</li>\n<li>new.yaml 配置问题，三个网段有交叉，出现 IP 地址冲突</li>\n<li>VIP 不通导致无法初始化成功，此时 messages 日志会有 VIP 超时的报错</li>\n</ol>\n<h5 id=\"52-高可用master\"><a class=\"anchor\" href=\"#52-高可用master\">#</a> 5.2 高可用 Master</h5>\n<p><strong>其他 master</strong> 加入集群，master02 和 master03 分别执行 (千万不要在 master01 再次执行，不能直接复制文档当中的命令，而是你自己刚才 master01 初始化之后产生的命令)</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:df72788de04bbc2e8fca70becb8a9e8503a962b5d7cd9b1842a0c39930d08c94 <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>\t--control-plane --certificate-key c595f7f4a7a3beb0d5bdb75d9e4eff0a60b977447e76c1d6885e82c3aa43c94c</pre></td></tr></table></figure><p>查看当前状态：（如果显示 NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE     VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   4m23s   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   NotReady   control-plane   66s     v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   NotReady   control-plane   14s     v1.32.3</pre></td></tr></table></figure><h5 id=\"53-token过期处理\"><a class=\"anchor\" href=\"#53-token过期处理\">#</a> 5.3 Token 过期处理</h5>\n<p>注意：以下步骤是上述 init 命令产生的 Token 过期了才需要执行以下步骤，如果没有过期不需要执行，直接 join 即可。</p>\n<p>Token 过期后生成新的 token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm token create --print-join-command</pre></td></tr></table></figure><p>Master 需要生成 --certificate-key：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm init phase upload-certs  --upload-certs</pre></td></tr></table></figure><h4 id=\"6-node节点的配置\"><a class=\"anchor\" href=\"#6-node节点的配置\">#</a> 6. Node 节点的配置</h4>\n<p>Node 节点上主要部署公司的一些业务应用，生产环境中不建议 Master 节点部署系统组件之外的其他 Pod，测试环境可以允许 Master 节点部署 Pod 以节省系统资源。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubeadm <span class=\"token function\">join</span> <span class=\"token number\">192.168</span>.1.70:16443 <span class=\"token parameter variable\">--token</span> 7t2weq.bjbawausm0jaxury <span class=\"token punctuation\">\\</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>\t--discovery-token-ca-cert-hash sha256:377702f508fe70b9d8ab68beccaa9af1b4609b754e4cc2fcc6185974e1d620b5</pre></td></tr></table></figure><p>所有节点初始化完成后，查看集群状态（NotReady 不影响）</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># kubectl get node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS     ROLES           AGE     VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   NotReady   control-plane   4m23s   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   NotReady   control-plane   66s     v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   NotReady   control-plane   14s     v1.32.3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     NotReady   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          13s     v1.32.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     NotReady   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          10s     v1.32.3</pre></td></tr></table></figure><h4 id=\"7-calico组件的安装\"><a class=\"anchor\" href=\"#7-calico组件的安装\">#</a> 7. Calico 组件的安装</h4>\n<p><mark>所有节点</mark>禁止 NetworkManager 管理 Calico 的网络接口，防止有冲突或干扰：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">cat</span> <span class=\"token operator\">>></span>/etc/NetworkManager/conf.d/calico.conf<span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOF</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>[keyfile]</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>unmanaged-devices=interface-name:cali*;interface-name:tunl*;interface-name:vxlan.calico;interface-name:vxlan-v6.calico;interface-name:wireguard.cali;interface-name:wg-v6.cali</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>EOF</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>systemctl daemon-reload</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>systemctl restart NetworkManager</pre></td></tr></table></figure><p>以下步骤只在<mark> master01</mark> 执行（.x 不需要更改）：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install <span class=\"token operator\">&amp;&amp;</span> <span class=\"token function\">git</span> checkout manual-installation-v1.32.x <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> calico/</pre></td></tr></table></figure><p>修改 Pod 网段：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token assign-left variable\">POD_SUBNET</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">cat</span> /etc/kubernetes/manifests/kube-controller-manager.yaml <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> cluster-cidr<span class=\"token operator\">=</span> <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token parameter variable\">-F</span><span class=\"token operator\">=</span> <span class=\"token string\">'&#123;print $NF&#125;'</span><span class=\"token variable\">`</span></span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">sed</span> <span class=\"token parameter variable\">-i</span> <span class=\"token string\">\"s#POD_CIDR#<span class=\"token variable\">$&#123;POD_SUBNET&#125;</span>#g\"</span> calico.yaml</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>kubectl apply <span class=\"token parameter variable\">-f</span> calico.yaml</pre></td></tr></table></figure><p>查看容器和节点状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get pods -n kube-system</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                                       READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>calico-kube-controllers-6f497d8478-v2q8c   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>calico-node-7mzmb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>calico-node-ljqnl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>calico-node-njqlb                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>calico-node-ph4m4                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>calico-node-rx8rl                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>coredns-76fccbbb6b-76559                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>coredns-76fccbbb6b-hkvn7                   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>etcd-k8s-master01                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>etcd-k8s-master02                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>etcd-k8s-master03                          <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>kube-apiserver-k8s-master01                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kube-apiserver-k8s-master02                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kube-apiserver-k8s-master03                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kube-controller-manager-k8s-master01       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kube-controller-manager-k8s-master02       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kube-controller-manager-k8s-master03       <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kube-proxy-9dtz4                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>kube-proxy-jh7rl                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kube-proxy-jvvwt                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kube-proxy-sh89l                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kube-proxy-t2j49                           <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kube-scheduler-k8s-master01                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kube-scheduler-k8s-master02                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kube-scheduler-k8s-master03                <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr><tr><td data-num=\"28\"></td><td><pre>metrics-server-7d9d8df576-jgnp2            <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr></table></figure><p>此时节点全部变为 Ready 状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get nodes</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           STATUS   ROLES           AGE   VERSION</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   Ready    control-plane   24h   v1.32.3</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          24h   v1.32.3</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     Ready    <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>          24h   v1.32.3</pre></td></tr></table></figure><h4 id=\"8-metrics部署\"><a class=\"anchor\" href=\"#8-metrics部署\">#</a> 8. Metrics 部署</h4>\n<p>在新版的 Kubernetes 中系统资源的采集均使用 Metrics-server，可以通过 Metrics 采集节点和 Pod 的内存、磁盘、CPU 和网络的使用率。</p>\n<p>将<mark> Master01 节点</mark>的 front-proxy-ca.crt 复制到所有 Node 节点</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token function\">scp</span> /etc/kubernetes/pki/front-proxy-ca.crt k8s-node01:/etc/kubernetes/pki/front-proxy-ca.crt</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token function\">scp</span> /etc/kubernetes/pki/front-proxy-ca.crt k8s-node<span class=\"token punctuation\">(</span>其他节点自行拷贝<span class=\"token punctuation\">)</span>:/etc/kubernetes/pki/front-proxy-ca.crt</pre></td></tr></table></figure><p>以下操作均在<mark> master01 节点</mark>执行:</p>\n<p>安装 metrics server</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/kubeadm-metrics-server</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\"># kubectl  create -f comp.yaml </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/metrics-server created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>service/metrics-server created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>deployment.apps/metrics-server created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created</pre></td></tr></table></figure><p>查看状态：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get po -n kube-system -l k8s-app=metrics-server</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                              READY   STATUS    RESTARTS   AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>metrics-server-7d9d8df576-jgnp2   <span class=\"token number\">1</span>/1     Running   <span class=\"token number\">0</span>          24h</pre></td></tr></table></figure><p>等 Pod 变成 1/1   Running 后，查看节点和 Pod 资源使用率：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl top node</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME           CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   CPU<span class=\"token punctuation\">(</span>%<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>%<span class=\"token punctuation\">)</span>   </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>k8s-master01   132m         <span class=\"token number\">3</span>%       932Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"4\"></td><td><pre>k8s-master02   131m         <span class=\"token number\">3</span>%       845Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"5\"></td><td><pre>k8s-master03   148m         <span class=\"token number\">3</span>%       912Mi           <span class=\"token number\">5</span>%          </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>k8s-node01     54m          <span class=\"token number\">1</span>%       600Mi           <span class=\"token number\">3</span>%          </pre></td></tr><tr><td data-num=\"7\"></td><td><pre>k8s-node02     49m          <span class=\"token number\">1</span>%       602Mi           <span class=\"token number\">3</span>%          </pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  kubectl top po -A</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>NAMESPACE              NAME                                         CPU<span class=\"token punctuation\">(</span>cores<span class=\"token punctuation\">)</span>   MEMORY<span class=\"token punctuation\">(</span>bytes<span class=\"token punctuation\">)</span>   </pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ingress-nginx          ingress-nginx-controller-5v9gl               2m           98Mi            </pre></td></tr><tr><td data-num=\"11\"></td><td><pre>ingress-nginx          ingress-nginx-controller-r978m               1m           104Mi           </pre></td></tr><tr><td data-num=\"12\"></td><td><pre>krm                    krm-backend-d7ff675d8-vmt9z                  1m           21Mi            </pre></td></tr><tr><td data-num=\"13\"></td><td><pre>krm                    krm-frontend-588ffd677b-c2pgj                1m           4Mi             </pre></td></tr><tr><td data-num=\"14\"></td><td><pre>krm                    nginx-574cf48959-vcfjs                       0m           2Mi             </pre></td></tr><tr><td data-num=\"15\"></td><td><pre>kube-system            calico-kube-controllers-6f497d8478-v2q8c     6m           17Mi            </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>kube-system            calico-node-7mzmb                            16m          176Mi           </pre></td></tr><tr><td data-num=\"17\"></td><td><pre>kube-system            calico-node-ljqnl                            15m          182Mi           </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>kube-system            calico-node-njqlb                            19m          180Mi           </pre></td></tr><tr><td data-num=\"19\"></td><td><pre>kube-system            calico-node-ph4m4                            15m          178Mi           </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>kube-system            calico-node-rx8rl                            17m          180Mi           </pre></td></tr><tr><td data-num=\"21\"></td><td><pre>kube-system            coredns-76fccbbb6b-76559                     2m           16Mi            </pre></td></tr><tr><td data-num=\"22\"></td><td><pre>kube-system            coredns-76fccbbb6b-hkvn7                     2m           16Mi            </pre></td></tr><tr><td data-num=\"23\"></td><td><pre>kube-system            etcd-k8s-master01                            22m          86Mi            </pre></td></tr><tr><td data-num=\"24\"></td><td><pre>kube-system            etcd-k8s-master02                            27m          84Mi            </pre></td></tr><tr><td data-num=\"25\"></td><td><pre>kube-system            etcd-k8s-master03                            22m          84Mi            </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>kube-system            kube-apiserver-k8s-master01                  22m          267Mi           </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>kube-system            kube-apiserver-k8s-master02                  20m          242Mi           </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>kube-system            kube-apiserver-k8s-master03                  18m          241Mi           </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>kube-system            kube-controller-manager-k8s-master01         6m           69Mi            </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>kube-system            kube-controller-manager-k8s-master02         2m           21Mi            </pre></td></tr><tr><td data-num=\"31\"></td><td><pre>kube-system            kube-controller-manager-k8s-master03         1m           19Mi            </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>kube-system            kube-proxy-9dtz4                             11m          30Mi            </pre></td></tr><tr><td data-num=\"33\"></td><td><pre>kube-system            kube-proxy-jh7rl                             1m           27Mi            </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>kube-system            kube-proxy-jvvwt                             17m          29Mi            </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>kube-system            kube-proxy-sh89l                             1m           29Mi            </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>kube-system            kube-proxy-t2j49                             16m          29Mi            </pre></td></tr><tr><td data-num=\"37\"></td><td><pre>kube-system            kube-scheduler-k8s-master01                  6m           25Mi            </pre></td></tr><tr><td data-num=\"38\"></td><td><pre>kube-system            kube-scheduler-k8s-master02                  6m           25Mi            </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>kube-system            kube-scheduler-k8s-master03                  6m           25Mi            </pre></td></tr><tr><td data-num=\"40\"></td><td><pre>kube-system            metrics-server-7d9d8df576-jgnp2              2m           26Mi            </pre></td></tr><tr><td data-num=\"41\"></td><td><pre>kubernetes-dashboard   dashboard-metrics-scraper-69b4796d9b-klnwr   1m           19Mi            </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>kubernetes-dashboard   kubernetes-dashboard-778584b9dd-pd5ln        1m           31Mi</pre></td></tr></table></figure><h4 id=\"9-dashboard部署\"><a class=\"anchor\" href=\"#9-dashboard部署\">#</a> 9. Dashboard 部署</h4>\n<h5 id=\"91-安装dashboard\"><a class=\"anchor\" href=\"#91-安装dashboard\">#</a> 9.1 安装 Dashboard</h5>\n<p>Dashboard 用于展示集群中的各类资源，同时也可以通过 Dashboard 实时查看 Pod 的日志和在容器中执行一些命令等。</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token builtin class-name\">cd</span> /root/k8s-ha-install/dashboard/</pre></td></tr><tr><td data-num=\"2\"></td><td><pre></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 dashboard<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  create -f .</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>serviceaccount/admin-user created</pre></td></tr><tr><td data-num=\"5\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/admin-user created</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>namespace/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>serviceaccount/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>service/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>secret/kubernetes-dashboard-certs created</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>secret/kubernetes-dashboard-csrf created</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>secret/kubernetes-dashboard-key-holder created</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>configmap/kubernetes-dashboard-settings created</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>role.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"17\"></td><td><pre>deployment.apps/kubernetes-dashboard created</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>service/dashboard-metrics-scraper created</pre></td></tr><tr><td data-num=\"19\"></td><td><pre>deployment.apps/dashboard-metrics-scraper created</pre></td></tr></table></figure><h5 id=\"92-登录dashboard\"><a class=\"anchor\" href=\"#92-登录dashboard\">#</a> 9.2 登录 dashboard</h5>\n<p>在谷歌浏览器（Chrome）启动文件中加入启动参数，用于解决无法访问 Dashboard 的问题，参考下图：</p>\n<pre><code>--test-type --ignore-certificate-errors\n</code></pre>\n<p><a href=\"https://imgse.com/i/pEgWfHJ\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgWfHJ.png\" alt=\"pEgWfHJ.png\" /></a></p>\n<p>更改 dashboard 的 svc 为 NodePort:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit svc kubernetes-dashboard <span class=\"token parameter variable\">-n</span> kubernetes-dashboard</pre></td></tr></table></figure><p><a href=\"https://imgse.com/i/pEgW5NR\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW5NR.png\" alt=\"pEgW5NR.png\" /></a></p>\n<p><em>将 ClusterIP 更改为 NodePort（如果已经为 NodePort 忽略此步骤）</em></p>\n<p>查看端口号：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl get svc kubernetes-dashboard -n kubernetes-dashboard</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>NAME                   TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span class=\"token punctuation\">(</span>S<span class=\"token punctuation\">)</span>         AGE</pre></td></tr><tr><td data-num=\"3\"></td><td><pre>kubernetes-dashboard   NodePort   <span class=\"token number\">10.96</span>.139.11   <span class=\"token operator\">&lt;</span>none<span class=\"token operator\">></span>        <span class=\"token number\">443</span>:32409/TCP   24h</pre></td></tr></table></figure><p>根据自己的实例端口号，通过任意安装了 kube-proxy 的宿主机的 IP + 端口即可访问到 dashboard：</p>\n<p>访问 Dashboard：<a href=\"https://192.168.181.129:31106\">https://192.168.1.71:32409</a> （把 IP 地址和端口改成你自己的）选择登录方式为令牌（即 token 方式），参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgW736\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgW736.png\" alt=\"pEgW736.png\" /></a></p>\n<p>创建登录 Token：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl create token admin-user <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>将 token 值输入到令牌后，单击登录即可访问 Dashboard，参考下图：</p>\n<p><a href=\"https://imgse.com/i/pEgfPv8\"><img loading=\"lazy\" data-src=\"https://s21.ax1x.com/2025/04/09/pEgfPv8.png\" alt=\"pEgfPv8.png\" /></a></p>\n<h4 id=\"10必看一些必须的配置更改\"><a class=\"anchor\" href=\"#10必看一些必须的配置更改\">#</a> 10.【必看】一些必须的配置更改</h4>\n<p>将 Kube-proxy 改为 ipvs 模式，因为在初始化集群的时候注释了 ipvs 配置，所以需要自行修改一下：</p>\n<p>在 master01 节点执行：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit cm kube-proxy <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr><tr><td data-num=\"2\"></td><td><pre>mode: ipvs</pre></td></tr></table></figure><p>更新 Kube-Proxy 的 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl patch daemonset kube-proxy <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>spec<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>template<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>metadata<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>annotations<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>date<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +<span class=\"token string\">'%s'</span><span class=\"token variable\">`</span></span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>&#125;&#125;&#125;&#125;&#125;\"</span> <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>验证 Kube-Proxy 模式:</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl 127.0.0.1:10249/proxyMode</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>ipvs</pre></td></tr></table></figure><h4 id=\"11必看注意事项\"><a class=\"anchor\" href=\"#11必看注意事项\">#</a> 11.【必看】注意事项</h4>\n<p>注意：kubeadm 安装的集群，证书有效期默认是一年。master 节点的 kube-apiserver、kube-scheduler、kube-controller-manager、etcd 都是以容器运行的。可以通过 kubectl get po -n kube-system 查看。</p>\n<p>启动和二进制不同的是，kubelet 的配置文件在 /etc/sysconfig/kubelet 和 /var/lib/kubelet/config.yaml，修改后需要重启 kubelet 进程。</p>\n<p>其他组件的配置文件在 /etc/kubernetes/manifests 目录下，比如 kube-apiserver.yaml，该 yaml 文件更改后，kubelet 会自动刷新配置，也就是会重启 pod。不能再次创建该文件。</p>\n<p>kube-proxy 的配置在 kube-system 命名空间下的 configmap 中，可以通过</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl edit cm kube-proxy <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>进行更改，更改完成后，可以通过 patch 重启 kube-proxy</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre>kubectl patch daemonset kube-proxy <span class=\"token parameter variable\">-p</span> <span class=\"token string\">\"&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>spec<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>template<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>metadata<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>annotations<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:&#123;<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>date<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>:<span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +<span class=\"token string\">'%s'</span><span class=\"token variable\">`</span></span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>&#125;&#125;&#125;&#125;&#125;\"</span> <span class=\"token parameter variable\">-n</span> kube-system</pre></td></tr></table></figure><p>Kubeadm 安装后，master 节点默认不允许部署 pod，可以通过以下方式删除 Taint，即可部署 Pod：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@k8s-master01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># kubectl  taint node  -l node-role.kubernetes.io/control-plane node-role.kubernetes.io/control-plane:NoSchedule-</span></pre></td></tr></table></figure><h4 id=\"12-containerd配置镜像加速\"><a class=\"anchor\" href=\"#12-containerd配置镜像加速\">#</a> 12. Containerd 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># vim /etc/containerd/config.toml</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#添加以下配置镜像加速服务</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"docker.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://registry-1.docker.io\"</span>, <span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>       <span class=\"token punctuation\">[</span>plugins.<span class=\"token string\">\"io.containerd.grpc.v1.cri\"</span>.registry.mirrors.<span class=\"token string\">\"registry.k8s.io\"</span><span class=\"token punctuation\">]</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>        <span class=\"token assign-left variable\">endpoint</span><span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">\"https://dockerproxy.com\"</span>, <span class=\"token string\">\"https://mirror.baidubce.com\"</span>,<span class=\"token string\">\"https://ccr.ccs.tencentyun.com\"</span>,<span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,<span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,<span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hbv0b596.mirror.aliyuncs.com\"</span>, <span class=\"token string\">\"https://k8s.m.daocloud.io\"</span>, <span class=\"token string\">\"https://docker.mirrors.ustc.edu.cn\"</span>,<span class=\"token string\">\"https://hub-mirror.c.163.com\"</span><span class=\"token punctuation\">]</span></pre></td></tr></table></figure><p>所有节点重新启动 Containerd：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl restart containerd</span></pre></td></tr></table></figure><h4 id=\"13-docker配置镜像加速\"><a class=\"anchor\" href=\"#13-docker配置镜像加速\">#</a> 13. Docker 配置镜像加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr></table></figure><p>所有节点重新启动 Docker：</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\"># systemctl daemon-reload</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\"># systemctl enable --now docker</span></pre></td></tr></table></figure><p><em>本文出自于：<a href=\"https://edu.51cto.com/course/23845.html\">https://edu.51cto.com/course/23845.html</a></em></p>\n",
            "tags": [
                "Kubernetes"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/1922841233.html",
            "url": "http://ixuyong.cn/posts/1922841233.html",
            "title": "Rsync服务实践",
            "date_published": "2025-03-30T12:45:48.000Z",
            "content_html": "<h3 id=\"ursync服务实践u\"><a class=\"anchor\" href=\"#ursync服务实践u\">#</a> <u>Rsync 服务实践</u></h3>\n<p><strong>环境准备</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">主机名</th>\n<th style=\"text-align:center\"><strong>IP</strong></th>\n<th><strong>角色</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">server</td>\n<td style=\"text-align:center\">192.168.40.101</td>\n<td>rsync 服务端</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">client</td>\n<td style=\"text-align:center\">192.168.40.102</td>\n<td>rsync 客户</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"1rsync服务端\"><a class=\"anchor\" href=\"#1rsync服务端\">#</a> 1.rsync 服务端</h4>\n<h5 id=\"11-关闭防火墙-selinux\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux\">#</a> 1.1 关闭防火墙、selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname backup</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_lb01</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h5 id=\"12-安装rsync\"><a class=\"anchor\" href=\"#12-安装rsync\">#</a> 1.2 安装 rsync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y rsync</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start rsyncd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable rsyncd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -M -s /sbin/nologin rsync</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /backup/mysql  /backup/file</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R rsync.rsync /backup/mysql /backup/file</span></pre></td></tr></table></figure><h5 id=\"13-修改配置文件\"><a class=\"anchor\" href=\"#13-修改配置文件\">#</a> 1.3 修改配置文件</h5>\n<p><em><mark>#生产环境中取消注释，导致备份数据报错</mark></em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#带注释配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的用户</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的组</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>              <span class=\"token comment\">#服务监听端口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>        <span class=\"token comment\">#服务无需使用 root 用户身份，即可接收文件的完整属性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no         <span class=\"token comment\">#禁锢目录，不允许获取 root 权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>   <span class=\"token comment\">#最大连接数，最多能有多少个客户端跟服务端的 873 端口建立连接</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>           <span class=\"token comment\">#超时时间</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ignore errors          <span class=\"token comment\">#忽略错误</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>      <span class=\"token comment\">#客户是否只读</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>           <span class=\"token comment\">#不允许查看模块信息</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup         <span class=\"token comment\">#定义虚拟用户，用户数据传输</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd  <span class=\"token comment\">#定义虚拟用户密码认证文件</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    <span class=\"token comment\">#日志文件存放的位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>         <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql   <span class=\"token comment\">#数据存放目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>          <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file    <span class=\"token comment\">#数据存放目录 </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#不带注释配置文件</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>        </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>     </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no        </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>         </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>ignore errors       </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>    </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>          </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup        </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>       </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>         </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file</pre></td></tr></table></figure><h5 id=\"4-创建虚拟用户密码文件并设置权限\"><a class=\"anchor\" href=\"#4-创建虚拟用户密码文件并设置权限\">#</a> 4. 创建虚拟用户密码文件并设置权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rsync_backup:your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart rsyncd &amp;&amp; systemctl status rsyncd</span></pre></td></tr></table></figure><h5 id=\"5-检查服务端口是否开启\"><a class=\"anchor\" href=\"#5-检查服务端口是否开启\">#</a> 5. 检查服务端口是否开启</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp | grep \"rsync\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:873             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">20357</span>/rsync         </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::873                  :::*                    LISTEN      <span class=\"token number\">20357</span>/rsync</pre></td></tr></table></figure><h4 id=\"2-rsync客户端\"><a class=\"anchor\" href=\"#2-rsync客户端\">#</a> 2. rsync 客户端</h4>\n<h5 id=\"21-安装rsync\"><a class=\"anchor\" href=\"#21-安装rsync\">#</a> 2.1 安装 rsync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr></table></figure><h5 id=\"22-配置传输密码\"><a class=\"anchor\" href=\"#22-配置传输密码\">#</a> 2.2 配置传输密码</h5>\n<p>方法 1：将密码写入文件</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  echo 'your passwd' > /etc/rsync.pass</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsync.pass </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 /etc/rsync.pass</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>--测试收发数据：</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rsync -avz --password-file=/etc/rsync.pass /root/test rsync_backup@192.168.40.101::backup_file</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>sending incremental <span class=\"token function\">file</span> list</pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>sent <span class=\"token number\">47</span> bytes  received <span class=\"token number\">20</span> bytes  <span class=\"token number\">134.00</span> bytes/sec</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>total size is <span class=\"token number\">0</span>  speedup is <span class=\"token number\">0.00</span></pre></td></tr></table></figure><p>方法 2：使用密码环境变量 RSYNC_PASSWORD</p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># export RSYNC_PASSWORD='your passwd'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>--测试收发数据：</pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rsync -avz /root/test rsync_backup@192.168.40.101::backup_file</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>sending incremental <span class=\"token function\">file</span> list</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>sent <span class=\"token number\">47</span> bytes  received <span class=\"token number\">20</span> bytes  <span class=\"token number\">134.00</span> bytes/sec</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>total size is <span class=\"token number\">0</span>  speedup is <span class=\"token number\">0.00</span></pre></td></tr></table></figure><h3 id=\"ursync企业级备份案例u\"><a class=\"anchor\" href=\"#ursync企业级备份案例u\">#</a> <u>Rsync 企业级备份案例</u></h3>\n<p><strong>环境准备</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">主机名</th>\n<th style=\"text-align:center\"><strong>IP</strong></th>\n<th><strong>角色</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">server</td>\n<td style=\"text-align:center\">192.168.40.101</td>\n<td>rsync 服务端</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">client</td>\n<td style=\"text-align:center\">192.168.40.102</td>\n<td>rsync 客户</td>\n</tr>\n</tbody>\n</table>\n<p><strong>客户端需求</strong></p>\n<ul>\n<li>客户端每天凌晨 3 点备份 MySQL 至 /backup 下以 &quot;主机名_IP 地址_当前时间命名&quot; 的目录中</li>\n<li>客户端推送 /backup 目录下数据备份目录至 Rsync 备份服务器</li>\n<li>客户端只保留最近七天的备份数据，避免浪费磁盘空间</li>\n</ul>\n<p><strong>服务端需求</strong></p>\n<ul>\n<li>服务端部署 rsync 服务，用于接收用户的备份数据</li>\n<li>服务端每天校验客户端推送过来的数据是否完整，并将结果以邮件的方式发送给管理员</li>\n<li>服务端仅保留 6 个月的备份数据</li>\n</ul>\n<p><strong>注意</strong>：所有服务器的备份目录均为 /backup，所有脚本存放目录均为 /scripts。</p>\n<h4 id=\"1-服务端部署rsync服务\"><a class=\"anchor\" href=\"#1-服务端部署rsync服务\">#</a> <strong>1. 服务端部署 rsync 服务</strong></h4>\n<h5 id=\"11-关闭防火墙-selinux-2\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux-2\">#</a> 1.1 关闭防火墙、selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname backup</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_lb01</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h5 id=\"12-安装rsync-2\"><a class=\"anchor\" href=\"#12-安装rsync-2\">#</a> 1.2 安装 rsync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y rsync</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start rsyncd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable rsyncd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -M -s /sbin/nologin rsync</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /backup/mysql  /backup/file</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R rsync.rsync /backup/mysql /backup/file</span></pre></td></tr></table></figure><h5 id=\"13-修改配置文件-2\"><a class=\"anchor\" href=\"#13-修改配置文件-2\">#</a> 1.3 修改配置文件</h5>\n<p><em><mark>#生产环境中取消注释，导致备份数据报错</mark></em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#带注释配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的用户</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的组</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>              <span class=\"token comment\">#服务监听端口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>        <span class=\"token comment\">#服务无需使用 root 用户身份，即可接收文件的完整属性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no         <span class=\"token comment\">#禁锢目录，不允许获取 root 权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>   <span class=\"token comment\">#最大连接数，最多能有多少个客户端跟服务端的 873 端口建立连接</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>           <span class=\"token comment\">#超时时间</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ignore errors          <span class=\"token comment\">#忽略错误</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>      <span class=\"token comment\">#客户是否只读</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>           <span class=\"token comment\">#不允许查看模块信息</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup         <span class=\"token comment\">#定义虚拟用户，用户数据传输</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd  <span class=\"token comment\">#定义虚拟用户密码认证文件</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    <span class=\"token comment\">#日志文件存放的位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>         <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql   <span class=\"token comment\">#数据存放目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>          <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file    <span class=\"token comment\">#数据存放目录 </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#不带注释配置文件</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>        </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>     </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no        </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>         </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>ignore errors       </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>    </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>          </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup        </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>       </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>         </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file</pre></td></tr></table></figure><h5 id=\"4-创建虚拟用户密码文件并设置权限-2\"><a class=\"anchor\" href=\"#4-创建虚拟用户密码文件并设置权限-2\">#</a> 4. 创建虚拟用户密码文件并设置权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rsync_backup:your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart rsyncd &amp;&amp; systemctl status rsyncd</span></pre></td></tr></table></figure><h5 id=\"5-检查服务端口是否开启-2\"><a class=\"anchor\" href=\"#5-检查服务端口是否开启-2\">#</a> 5. 检查服务端口是否开启</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp | grep \"rsync\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:873             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">20357</span>/rsync         </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::873                  :::*                    LISTEN      <span class=\"token number\">20357</span>/rsync</pre></td></tr></table></figure><h4 id=\"2-rsync客户端-2\"><a class=\"anchor\" href=\"#2-rsync客户端-2\">#</a> 2. rsync 客户端</h4>\n<h5 id=\"21-安装rsync-2\"><a class=\"anchor\" href=\"#21-安装rsync-2\">#</a> 2.1 安装 rsync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install nfs-utils -y</span></pre></td></tr></table></figure><h5 id=\"22-测试客户端备份数据并推送至rsync服务器\"><a class=\"anchor\" href=\"#22-测试客户端备份数据并推送至rsync服务器\">#</a> 2.2 测试客户端备份数据并推送至 rsync 服务器</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># export RSYNC_PASSWORD='your passwd'</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># rsync -avz /root/test rsync_backup@192.168.40.101::backup_file</span></pre></td></tr></table></figure><h5 id=\"23-客户端备份数据并推送至rsync服务器\"><a class=\"anchor\" href=\"#23-客户端备份数据并推送至rsync服务器\">#</a> <strong>2.3 客户端备份数据并推送至 rsync 服务器</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /scripts</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /scripts/mysql_backup.sh </span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</pre></td></tr><tr><td data-num=\"5\"></td><td><pre></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token comment\">#1、定义变量</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Host</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">hostname</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token assign-left variable\">Ip</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ifconfig</span> ens192 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'NR==2&#123;print $2&#125;'</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token assign-left variable\">Date</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%F<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token assign-left variable\">BackupDir</span><span class=\"token operator\">=</span>/backup/mysql</pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token assign-left variable\">Dest</span><span class=\"token operator\">=</span><span class=\"token variable\">$&#123;BackupDir&#125;</span>/<span class=\"token variable\">$&#123;Host&#125;</span>_<span class=\"token variable\">$&#123;Ip&#125;</span>_<span class=\"token variable\">$&#123;Date&#125;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token assign-left variable\">FILE_NAME</span><span class=\"token operator\">=</span>mysql_backup_<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> <span class=\"token string\">'+%Y%m%d%H%M%S'</span><span class=\"token variable\">`</span></span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token assign-left variable\">OLDBINLOG</span><span class=\"token operator\">=</span>/var/lib/mysql/oldbinlog</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#2、创建备份目录</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-d</span> <span class=\"token variable\">$Dest</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token function\">mkdir</span> <span class=\"token parameter variable\">-p</span> <span class=\"token variable\">$Dest</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre></pre></td></tr><tr><td data-num=\"20\"></td><td><pre><span class=\"token comment\">#3、备份目录</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>/usr/bin/mysqldump -u<span class=\"token string\">'root'</span> -p<span class=\"token string\">'your passwd'</span> nf_flms <span class=\"token operator\">></span> <span class=\"token variable\">$Dest</span>/nf-flms_<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"22\"></td><td><pre><span class=\"token function\">tar</span> <span class=\"token parameter variable\">-czvf</span> <span class=\"token variable\">$Dest</span>/<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.tar.gz <span class=\"token variable\">$Dest</span>/nf-flms_<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span> <span class=\"token variable\">$Dest</span>/*<span class=\"token variable\">$&#123;FILE_NAME&#125;</span>.sql</pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Your database backup successfully\"</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token comment\">#4、校验</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre>md5sum <span class=\"token variable\">$Dest</span>/* <span class=\"token operator\">></span><span class=\"token variable\">$Dest</span>/backup_check_<span class=\"token variable\">$Date</span></pre></td></tr><tr><td data-num=\"28\"></td><td><pre></pre></td></tr><tr><td data-num=\"29\"></td><td><pre><span class=\"token comment\">#5、将备份目录推动到 rsync 服务端</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre><span class=\"token assign-left variable\">Rsync_Ip</span><span class=\"token operator\">=</span><span class=\"token number\">192.168</span>.1.145</pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token assign-left variable\">Rsync_user</span><span class=\"token operator\">=</span>rsync_backup</pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token assign-left variable\">Rsync_Module</span><span class=\"token operator\">=</span>backup_mysql</pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">RSYNC_PASSWORD</span><span class=\"token operator\">=</span>your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"34\"></td><td><pre><span class=\"token function\">rsync</span> <span class=\"token parameter variable\">-avz</span> <span class=\"token variable\">$Dest</span> <span class=\"token variable\">$Rsync_user</span>@<span class=\"token variable\">$Rsync_Ip</span>::<span class=\"token variable\">$Rsync_Module</span></pre></td></tr><tr><td data-num=\"35\"></td><td><pre></pre></td></tr><tr><td data-num=\"36\"></td><td><pre><span class=\"token comment\">#6、删除 15 天备份目录</span></pre></td></tr><tr><td data-num=\"37\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token variable\">$Dest</span> <span class=\"token parameter variable\">-type</span> d <span class=\"token parameter variable\">-mtime</span> +15 <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span></pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"remove file  successfully\"</span></pre></td></tr><tr><td data-num=\"39\"></td><td><pre></pre></td></tr><tr><td data-num=\"40\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/etc_backup.sh</span></pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"42\"></td><td><pre>00 03 * * * /bin/bash /scripts/mysql_backup.sh <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr></table></figure><h5 id=\"24-服务端校验数据并将结果以邮件发送给管理员\"><a class=\"anchor\" href=\"#24-服务端校验数据并将结果以邮件发送给管理员\">#</a> <strong>2.4 服务端校验数据并将结果以邮件发送给管理员</strong></h5>\n<h6 id=\"241-配置邮件服务\"><a class=\"anchor\" href=\"#241-配置邮件服务\">#</a> 2.4.1 配置邮件服务</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum -y install mailx</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/mail.rc      #最后一行插入</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">from</span><span class=\"token operator\">=</span><span class=\"token number\">373370405</span>@qq.com</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token builtin class-name\">set</span> <span class=\"token assign-left variable\">smtp</span><span class=\"token operator\">=</span>smtps://smtp.qq.com:465</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth-user<span class=\"token operator\">=</span><span class=\"token number\">373370405</span>@qq.com</pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth-password<span class=\"token operator\">=</span>**********   <span class=\"token comment\"># 发件邮箱的授权码</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token builtin class-name\">set</span> smtp-auth<span class=\"token operator\">=</span>login</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token builtin class-name\">set</span> ssl-verify<span class=\"token operator\">=</span>ignore</pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token builtin class-name\">set</span> nss-config-dir<span class=\"token operator\">=</span>/etc/pki/nssdb</pre></td></tr></table></figure><h6 id=\"242-发送邮件测试\"><a class=\"anchor\" href=\"#242-发送邮件测试\">#</a> 2.4.2 发送邮件测试</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\">#  echo Hello World | mail -s test 373370405@qq.com &amp;> /dev/null</span></pre></td></tr></table></figure><h6 id=\"243-配置脚本校验数据并将结果发送给管理员\"><a class=\"anchor\" href=\"#243-配置脚本校验数据并将结果发送给管理员\">#</a> 2.4.3 配置脚本校验数据并将结果发送给管理员</h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup mysql<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /scripts/check_backup.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">PATH</span></span><span class=\"token operator\">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</pre></td></tr><tr><td data-num=\"4\"></td><td><pre></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token comment\">#1、定义变量</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token assign-left variable\">Path</span><span class=\"token operator\">=</span>/backup/mysql</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token assign-left variable\">Date</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> +%F<span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#2、查看 flag 文件，并对对文件进行校验，然后将校验的结果保存至 result_时间</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token variable\">$Path</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"backup_check_<span class=\"token variable\">$&#123;Date&#125;</span>*\"</span><span class=\"token operator\">|</span><span class=\"token function\">xargs</span> md5sum <span class=\"token parameter variable\">-c</span> <span class=\"token operator\">></span><span class=\"token variable\">$Path</span>/result_<span class=\"token variable\">$&#123;Date&#125;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#3、将校验结果发送邮件给管理员</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>mail <span class=\"token parameter variable\">-s</span> <span class=\"token string\">\"Mysql Backup\"</span> <span class=\"token number\">373370405</span>@qq.com <span class=\"token operator\">&lt;</span><span class=\"token variable\">$Path</span>/result_<span class=\"token variable\">$&#123;Date&#125;</span> <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr><tr><td data-num=\"14\"></td><td><pre></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token comment\">#4、删除超过 7 天的校验结果文件，删除超过 180 天的备份数据文件</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token variable\">$Path</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"result*\"</span> <span class=\"token parameter variable\">-mtime</span> +7 <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token function\">find</span> <span class=\"token variable\">$Path</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-mtime</span> +180 <span class=\"token operator\">|</span> <span class=\"token function\">xargs</span> <span class=\"token function\">rm</span> <span class=\"token parameter variable\">-rf</span></pre></td></tr></table></figure><h6 id=\"244-写计划任务\"><a class=\"anchor\" href=\"#244-写计划任务\">#</a> <strong>2.4.4 写计划任务</strong></h6>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/check_backup.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@db01 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>00 06 * * * /bin/bash /scripts/mysql_backup.sh <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr></table></figure><h3 id=\"rsyncsersync实现数据实时同步\"><a class=\"anchor\" href=\"#rsyncsersync实现数据实时同步\">#</a> Rsync+sersync 实现数据实时同步</h3>\n<p><strong>环境准备</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">主机名</th>\n<th style=\"text-align:center\"><strong>IP</strong></th>\n<th><strong>角色</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">server</td>\n<td style=\"text-align:center\">192.168.40.101</td>\n<td>rsync 服务端</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">client</td>\n<td style=\"text-align:center\">192.168.40.102</td>\n<td>rsync 客户</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"1rsync服务端-2\"><a class=\"anchor\" href=\"#1rsync服务端-2\">#</a> 1.rsync 服务端</h4>\n<h5 id=\"11-关闭防火墙-selinux-3\"><a class=\"anchor\" href=\"#11-关闭防火墙-selinux-3\">#</a> 1.1 关闭防火墙、selinux</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname backup</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@localhost ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># bash</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname aizj_lb01</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate git -y</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y --exclude=kernel* &amp;&amp; reboot</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'Asia/Shanghai' >/etc/timezone</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ntpdate time2.aliyun.com</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -e</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>*/5 * * * * /usr/sbin/ntpdate time2.aliyun.com <span class=\"token operator\">&amp;></span> /dev/nul</pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h5 id=\"12-安装rsync-3\"><a class=\"anchor\" href=\"#12-安装rsync-3\">#</a> 1.2 安装 rsync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y rsync</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl start rsyncd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@server ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable rsyncd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># useradd -M -s /sbin/nologin rsync</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /backup/mysql  /backup/file</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chown -R rsync.rsync /backup/mysql /backup/file</span></pre></td></tr></table></figure><h5 id=\"13-修改配置文件-3\"><a class=\"anchor\" href=\"#13-修改配置文件-3\">#</a> 1.3 修改配置文件</h5>\n<p><em><mark>#生产环境中取消注释，导致备份数据报错</mark></em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#带注释配置文件</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的用户</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>             <span class=\"token comment\">#运行服务的组</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>              <span class=\"token comment\">#服务监听端口</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>        <span class=\"token comment\">#服务无需使用 root 用户身份，即可接收文件的完整属性</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no         <span class=\"token comment\">#禁锢目录，不允许获取 root 权限</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>   <span class=\"token comment\">#最大连接数，最多能有多少个客户端跟服务端的 873 端口建立连接</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>           <span class=\"token comment\">#超时时间</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>ignore errors          <span class=\"token comment\">#忽略错误</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>      <span class=\"token comment\">#客户是否只读</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>           <span class=\"token comment\">#不允许查看模块信息</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup         <span class=\"token comment\">#定义虚拟用户，用户数据传输</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd  <span class=\"token comment\">#定义虚拟用户密码认证文件</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    <span class=\"token comment\">#日志文件存放的位置</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>         <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"18\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql   <span class=\"token comment\">#数据存放目录</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>          <span class=\"token comment\">#模块名</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"21\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file    <span class=\"token comment\">#数据存放目录 </span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre></pre></td></tr><tr><td data-num=\"23\"></td><td><pre><span class=\"token comment\">#不带注释配置文件</span></pre></td></tr><tr><td data-num=\"24\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsyncd.conf</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>uid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>        </pre></td></tr><tr><td data-num=\"26\"></td><td><pre>gid <span class=\"token operator\">=</span> <span class=\"token function\">rsync</span>         </pre></td></tr><tr><td data-num=\"27\"></td><td><pre>port <span class=\"token operator\">=</span> <span class=\"token number\">873</span>     </pre></td></tr><tr><td data-num=\"28\"></td><td><pre>fake super <span class=\"token operator\">=</span> <span class=\"token function\">yes</span>     </pre></td></tr><tr><td data-num=\"29\"></td><td><pre>use <span class=\"token function\">chroot</span> <span class=\"token operator\">=</span> no        </pre></td></tr><tr><td data-num=\"30\"></td><td><pre>max connections <span class=\"token operator\">=</span> <span class=\"token number\">200</span>  </pre></td></tr><tr><td data-num=\"31\"></td><td><pre><span class=\"token function\">timeout</span> <span class=\"token operator\">=</span> <span class=\"token number\">600</span>         </pre></td></tr><tr><td data-num=\"32\"></td><td><pre>ignore errors       </pre></td></tr><tr><td data-num=\"33\"></td><td><pre><span class=\"token builtin class-name\">read</span> only <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>    </pre></td></tr><tr><td data-num=\"34\"></td><td><pre>list <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>          </pre></td></tr><tr><td data-num=\"35\"></td><td><pre>auth <span class=\"token function\">users</span> <span class=\"token operator\">=</span> rsync_backup        </pre></td></tr><tr><td data-num=\"36\"></td><td><pre>secrets <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /etc/rsync.passwd</pre></td></tr><tr><td data-num=\"37\"></td><td><pre>log <span class=\"token function\">file</span> <span class=\"token operator\">=</span> /var/log/rsyncd.log    </pre></td></tr><tr><td data-num=\"38\"></td><td><pre><span class=\"token punctuation\">[</span>backup_mysql<span class=\"token punctuation\">]</span>       </pre></td></tr><tr><td data-num=\"39\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"40\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/mysql  </pre></td></tr><tr><td data-num=\"41\"></td><td><pre><span class=\"token punctuation\">[</span>backup_file<span class=\"token punctuation\">]</span>         </pre></td></tr><tr><td data-num=\"42\"></td><td><pre>comment <span class=\"token operator\">=</span> welcome to rsync_backup</pre></td></tr><tr><td data-num=\"43\"></td><td><pre>path <span class=\"token operator\">=</span> /backup/file</pre></td></tr></table></figure><h5 id=\"4-创建虚拟用户密码文件并设置权限-3\"><a class=\"anchor\" href=\"#4-创建虚拟用户密码文件并设置权限-3\">#</a> 4. 创建虚拟用户密码文件并设置权限</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>rsync_backup:your <span class=\"token function\">passwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl restart rsyncd &amp;&amp; systemctl status rsyncd</span></pre></td></tr></table></figure><h5 id=\"5-检查服务端口是否开启-3\"><a class=\"anchor\" href=\"#5-检查服务端口是否开启-3\">#</a> 5. 检查服务端口是否开启</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># netstat -lntp | grep \"rsync\"</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>tcp        <span class=\"token number\">0</span>      <span class=\"token number\">0</span> <span class=\"token number\">0.0</span>.0.0:873             <span class=\"token number\">0.0</span>.0.0:*               LISTEN      <span class=\"token number\">20357</span>/rsync         </pre></td></tr><tr><td data-num=\"3\"></td><td><pre>tcp6       <span class=\"token number\">0</span>      <span class=\"token number\">0</span> :::873                  :::*                    LISTEN      <span class=\"token number\">20357</span>/rsync</pre></td></tr></table></figure><h4 id=\"2-客户端安装sersync\"><a class=\"anchor\" href=\"#2-客户端安装sersync\">#</a> 2. 客户端安装 sersync</h4>\n<p><strong>2.1 安装 sercync 依赖</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y inotify-tools rsync</span></pre></td></tr></table></figure><p><strong>2.2 安装 sercync</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir -p /soft</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://down.whsir.com/downloads/sersync2.5.4_64bit_binary_stable_final.tar.gz</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar -xf sersync2.5.4_64bit_binary_stable_final.tar.gz</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># mv GNU-Linux-x86 /usr/local/sersync</span></pre></td></tr></table></figure><h5 id=\"23-修改配置文件\"><a class=\"anchor\" href=\"#23-修改配置文件\">#</a> 2.3 <strong>修改配置文件</strong></h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /usr/local/sersync/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># cp confxml.xml confxml.xml.bak</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim confxml.xml</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token number\">5</span>    <span class=\"token operator\">&lt;</span>fileSystem <span class=\"token assign-left variable\">xfs</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span>    <span class=\"token comment\">#第 5 行 false 改为 true</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token number\">13</span>          <span class=\"token operator\">&lt;</span>delete <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span> <span class=\"token comment\">#第 13-20 行 false 改为 true,# 说明：监控以上变化推送</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token number\">14</span>        <span class=\"token operator\">&lt;</span>createFolder <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token number\">15</span>        <span class=\"token operator\">&lt;</span>createFile <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"false\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token number\">16</span>        <span class=\"token operator\">&lt;</span>closeWrite <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token number\">17</span>        <span class=\"token operator\">&lt;</span>moveFrom <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token number\">18</span>        <span class=\"token operator\">&lt;</span>moveTo <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token number\">19</span>        <span class=\"token operator\">&lt;</span>attrib <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token number\">20</span>        <span class=\"token operator\">&lt;</span>modify <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span>/<span class=\"token operator\">></span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token number\">24</span>        <span class=\"token operator\">&lt;</span>localpath <span class=\"token assign-left variable\">watch</span><span class=\"token operator\">=</span><span class=\"token string\">\"/data\"</span><span class=\"token operator\">></span>      <span class=\"token comment\">#监控的本地目录</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre><span class=\"token number\">25</span>             <span class=\"token operator\">&lt;</span>remote <span class=\"token assign-left variable\">ip</span><span class=\"token operator\">=</span><span class=\"token string\">\"192.168.1.145\"</span> <span class=\"token assign-left variable\">name</span><span class=\"token operator\">=</span><span class=\"token string\">\"backup_file\"</span>/<span class=\"token operator\">></span>  <span class=\"token comment\">#rsync 服务端 IP 和模块名 backup_file</span></pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token number\">30</span>      <span class=\"token operator\">&lt;</span>commonParams <span class=\"token assign-left variable\">params</span><span class=\"token operator\">=</span><span class=\"token string\">\"-avz\"</span>/<span class=\"token operator\">></span>  <span class=\"token comment\">#rsync 命令选项</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre><span class=\"token number\">31</span>      <span class=\"token operator\">&lt;</span>auth <span class=\"token assign-left variable\">start</span><span class=\"token operator\">=</span><span class=\"token string\">\"true\"</span> <span class=\"token assign-left variable\">users</span><span class=\"token operator\">=</span><span class=\"token string\">\"rsync_backup\"</span> <span class=\"token assign-left variable\">passwordfile</span><span class=\"token operator\">=</span><span class=\"token string\">\"/etc/rsync.passwd\"</span>/<span class=\"token operator\">></span> <span class=\"token comment\">#rsync 认证信息</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr></table></figure><h5 id=\"24-生成密码文件\"><a class=\"anchor\" href=\"#24-生成密码文件\">#</a> 2.4 生成密码文件</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># echo 'your passwd' > /etc/rsync.passwd</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod 600 /etc/rsync.passwd</span></pre></td></tr></table></figure><h5 id=\"25-启动sersync\"><a class=\"anchor\" href=\"#25-启动sersync\">#</a> 2.5 启动 sersync</h5>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># ln -s /usr/local/sersync/sersync2 /usr/bin/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># sersync2 -dro /usr/local/sersync/confxml.xml     #针对配置文件 confxml.xml 启动 sersync</span></pre></td></tr></table></figure><p><strong>2.5 设置 sersync 开机自启</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@qzj_nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim /etc/rc.d/rc.local   </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>/usr/local/sersync/sersync2 <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-o</span>  /usr/local/sersync/confxml.xml  <span class=\"token comment\">#在最后添加一行</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@qzj_nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /etc/rc.d/rc.local</span></pre></td></tr></table></figure><p><strong>2.6 测试</strong></p>\n<p><em>在客户端 /data 目录增删改目录文件，rsync 服务端数据存放目录变化</em></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@backup backup<span class=\"token punctuation\">]</span><span class=\"token comment\"># watch ls</span></pre></td></tr></table></figure><p><strong>2.7 添加脚本监控 sersync 是否正常运行</strong></p>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># cat /scripts/check_sersync.sh </span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token comment\">#!/bin/sh</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token assign-left variable\">sersync</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/sersync/sersync2\"</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token assign-left variable\">confxml</span><span class=\"token operator\">=</span><span class=\"token string\">\"/usr/local/sersync/confxml.xml\"</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token assign-left variable\">status</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">ps</span> aux <span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token string\">'sersync2'</span><span class=\"token operator\">|</span><span class=\"token function\">grep</span> <span class=\"token parameter variable\">-v</span> <span class=\"token string\">'grep'</span><span class=\"token operator\">|</span><span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token variable\">$status</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token keyword\">then</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token variable\">$sersync</span> <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-o</span> <span class=\"token variable\">$confxml</span> <span class=\"token operator\">&amp;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token keyword\">else</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token builtin class-name\">exit</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token keyword\">fi</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># chmod +x /scripts/check_sersync.sh</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">[</span>root@nfs sersync<span class=\"token punctuation\">]</span><span class=\"token comment\"># crontab -l</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>*/5 * * * * /usr/bin/sh /scripts/check_sersync.sh <span class=\"token operator\">&amp;></span> /dev/null</pre></td></tr></table></figure><p><em><strong>补充： 多实例情况</strong></em><br />\n 1、配置多个 confxml.xml 文件（比如：www、bbs、blog.... 等等）<br />\n2、修改端口、同步路径、模块名称<br />\n 3、根据不同的需求同步对应的实例文件<br />\n /usr/local/sersync/sersync2 -dro /usr/local/sersync/www_confxml.xml<br />\n/usr/local/sersync/sersync2 -dro /usr/local/sersync/bbs_confxml.xml</p>\n",
            "tags": [
                "rsync"
            ]
        },
        {
            "id": "http://ixuyong.cn/posts/3071070978.html",
            "url": "http://ixuyong.cn/posts/3071070978.html",
            "title": "企业级私有仓库Harbor搭建",
            "date_published": "2025-03-30T08:17:00.000Z",
            "content_html": "<h3 id=\"企业级私有仓库harbor\"><a class=\"anchor\" href=\"#企业级私有仓库harbor\">#</a> 企业级私有仓库 Harbor</h3>\n<p>企业部署 Kuberetes 集群环境之后，我们就可以将原来在传统虚拟机上运行的业务，迁移到 kubernetes 上，让 Kubernetes 通过容器的方式来管理。而一旦我们需要将传统业务使用容器的方式运行起来，就需要构建很多镜像，那么这些镜像就需要有一个专门的位置存储起来，为我们提供镜像上传和镜像下载等功能。但我们不能使用阿里云或者 Dockerhub 等仓库，首先拉取速度比较慢，其次镜像的安全性无法保证，所以就需要部署一个私有的镜像仓库来管理这些容器镜像。同时该仓库还需要提供高可用功能，确保随时都能上传和下载可用的容器镜像。</p>\n<h4 id=\"1-关闭防火墙-selinux-环境配置\"><a class=\"anchor\" href=\"#1-关闭防火墙-selinux-环境配置\">#</a> 1、关闭防火墙、Selinux、环境配置</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># hostnamectl set-hostname harbor</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl stop firewalld</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl disable firewalld</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/sysconfig/selinux</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install net-tools vim tree lrzsz wget unzip dos2unix bash-completion  lsof ntp ntpdate -y</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum update -y</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># mkdir /soft /data /scripts /backup</span></pre></td></tr></table></figure><h4 id=\"2-docker安装\"><a class=\"anchor\" href=\"#2-docker安装\">#</a> 2、Docker 安装</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># curl -o /etc/yum.repos.d/docker-ce.repo  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum list docker-ce --showduplicates |sort -r </span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># yum install docker-ce docker-compose -y</span></pre></td></tr></table></figure><h4 id=\"3-配置docker加速\"><a class=\"anchor\" href=\"#3-配置docker加速\">#</a> 3、配置 Docker 加速</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo mkdir -p /etc/docker</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># sudo tee /etc/docker/daemon.json &lt;&lt;-'EOF'</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>  <span class=\"token string\">\"registry-mirrors\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"6\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"7\"></td><td><pre>\t  <span class=\"token string\">\"https://quay.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"8\"></td><td><pre>\t  <span class=\"token string\">\"https://gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"9\"></td><td><pre>\t  <span class=\"token string\">\"https://k8s-gcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"10\"></td><td><pre>\t  <span class=\"token string\">\"https://ghcr.credclouds.com\"</span>,</pre></td></tr><tr><td data-num=\"11\"></td><td><pre>\t  <span class=\"token string\">\"https://do.nark.eu.org\"</span>,</pre></td></tr><tr><td data-num=\"12\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.m.daocloud.io\"</span>,</pre></td></tr><tr><td data-num=\"13\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.nju.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"14\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.mirrors.sjtug.sjtu.edu.cn\"</span>,</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.1panel.live\"</span>,</pre></td></tr><tr><td data-num=\"16\"></td><td><pre>\t  <span class=\"token string\">\"https://docker.rainbond.cc\"</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>  <span class=\"token punctuation\">]</span>, </pre></td></tr><tr><td data-num=\"18\"></td><td><pre>  <span class=\"token string\">\"exec-opts\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"native.cgroupdriver=systemd\"</span><span class=\"token punctuation\">]</span> </pre></td></tr><tr><td data-num=\"19\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"20\"></td><td><pre>EOF</pre></td></tr><tr><td data-num=\"21\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># systemctl enable docker --now</span></pre></td></tr></table></figure><h4 id=\"4-安装harbor\"><a class=\"anchor\" href=\"#4-安装harbor\">#</a> 4、安装 Harbor</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd /soft/</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># wget https://github.com/goharbor/harbor/releases/download/v2.6.1/harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># tar xf harbor-offline-installer-v2.6.1.tgz</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor soft<span class=\"token punctuation\">]</span><span class=\"token comment\"># cd harbor</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim harbor.yml</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre>hostname: <span class=\"token number\">192.168</span>.1.134</pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"8\"></td><td><pre><span class=\"token comment\">#https:</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre><span class=\"token comment\">#  # https port for harbor, default is 443</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre><span class=\"token comment\">#  port: 443</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#  # The path of cert and key files for nginx</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#  certificate: /your/certificate/path</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre><span class=\"token comment\">#  private_key: /your/private/key/path</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre><span class=\"token punctuation\">..</span>.</pre></td></tr><tr><td data-num=\"15\"></td><td><pre>harbor_admin_password: Harbor12345</pre></td></tr><tr><td data-num=\"16\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\">#  ./install.sh</span></pre></td></tr></table></figure><h4 id=\"5-配置nginx负载均衡调度\"><a class=\"anchor\" href=\"#5-配置nginx负载均衡调度\">#</a> 5、配置 Nginx 负载均衡调度</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@lb ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># vim s.hmallleasing.com.conf</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>    listen <span class=\"token number\">443</span> ssl<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre>    server_name harbor.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre>    client_max_body_size 1G<span class=\"token punctuation\">;</span> </pre></td></tr><tr><td data-num=\"6\"></td><td><pre>    ssl_prefer_server_ciphers on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre>    ssl_certificate  /etc/nginx/sslkey/_.hmallleasing.com_chain.crt<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"8\"></td><td><pre>    ssl_certificate_key  /etc/nginx/sslkey/_.hmallleasing.com_key.key<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"9\"></td><td><pre>    location / <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"10\"></td><td><pre>        proxy_pass http://192.168.1.134<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"11\"></td><td><pre><span class=\"token comment\">#       include proxy_params;</span></pre></td></tr><tr><td data-num=\"12\"></td><td><pre><span class=\"token comment\">#       proxy_set_header Host $http_host;</span></pre></td></tr><tr><td data-num=\"13\"></td><td><pre>        proxy_set_header X-Real-IP <span class=\"token variable\">$remote_addr</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"14\"></td><td><pre>        proxy_set_header X-Forwarded-For <span class=\"token variable\">$proxy_add_x_forwarded_for</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"15\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"16\"></td><td><pre>        proxy_connect_timeout <span class=\"token number\">30</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"17\"></td><td><pre>        proxy_send_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"18\"></td><td><pre>        proxy_read_timeout <span class=\"token number\">60</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"19\"></td><td><pre>        </pre></td></tr><tr><td data-num=\"20\"></td><td><pre>        proxy_buffering on<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"21\"></td><td><pre>        proxy_buffer_size 32k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"22\"></td><td><pre>        proxy_buffers <span class=\"token number\">4</span> 128k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"23\"></td><td><pre>        proxy_temp_file_write_size 10240k<span class=\"token punctuation\">;</span>\t\t</pre></td></tr><tr><td data-num=\"24\"></td><td><pre>        proxy_max_temp_file_size 10240k<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"25\"></td><td><pre>    <span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"26\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr><tr><td data-num=\"27\"></td><td><pre></pre></td></tr><tr><td data-num=\"28\"></td><td><pre>server <span class=\"token punctuation\">&#123;</span></pre></td></tr><tr><td data-num=\"29\"></td><td><pre>    listen <span class=\"token number\">80</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"30\"></td><td><pre>    server_name s.hmallleasing.com<span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"31\"></td><td><pre>    <span class=\"token builtin class-name\">return</span> <span class=\"token number\">302</span> https://<span class=\"token variable\">$server_name</span><span class=\"token variable\">$request_uri</span><span class=\"token punctuation\">;</span></pre></td></tr><tr><td data-num=\"32\"></td><td><pre><span class=\"token punctuation\">&#125;</span></pre></td></tr></table></figure><h4 id=\"6-推送镜像至harbor\"><a class=\"anchor\" href=\"#6-推送镜像至harbor\">#</a> 6、推送镜像至 Harbor</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker tag beae173ccac6 harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker login harbor.hmallleasing.com</span></pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker push harbor.hmallleasing.com/ops/busybox.v1</span></pre></td></tr></table></figure><h4 id=\"7-harbor停止与启动\"><a class=\"anchor\" href=\"#7-harbor停止与启动\">#</a> 7、Harbor 停止与启动</h4>\n<figure class=\"highlight bash\"><figcaption data-lang=\"bash\"></figcaption><table><tr><td data-num=\"1\"></td><td><pre><span class=\"token comment\">#停用 Harbor</span></pre></td></tr><tr><td data-num=\"2\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># pwd</span></pre></td></tr><tr><td data-num=\"3\"></td><td><pre>/soft/harbor</pre></td></tr><tr><td data-num=\"4\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose stop</span></pre></td></tr><tr><td data-num=\"5\"></td><td><pre> <span class=\"token comment\">#启动 Harbor</span></pre></td></tr><tr><td data-num=\"6\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose up -d</span></pre></td></tr><tr><td data-num=\"7\"></td><td><pre><span class=\"token punctuation\">[</span>root@harbor harbor<span class=\"token punctuation\">]</span><span class=\"token comment\"># docker-compose start</span></pre></td></tr></table></figure>",
            "tags": [
                "Harbor"
            ]
        }
    ]
}